/*
jQWidgets v3.0.4 (2013-Nov-01)
Copyright (c) 2011-2013 jQWidgets.
License: http://jqwidgets.com/license/
*/

(function ($) {
    $.jqx = $.jqx || {}

    $.jqx.define = function (namespace, classname, baseclass) {
        namespace[classname] = function () {
            if (this.baseType) {
                this.base = new namespace[this.baseType]();
                this.base.defineInstance();
            }
            this.defineInstance();
        }

        namespace[classname].prototype.defineInstance = function () { };
        namespace[classname].prototype.base = null;
        namespace[classname].prototype.baseType = undefined;

        if (baseclass && namespace[baseclass])
            namespace[classname].prototype.baseType = baseclass;
    }

    // method call
    $.jqx.invoke = function (object, args) {
        if (args.length == 0)
            return;

        var method = typeof (args) == Array || args.length > 0 ? args[0] : args;
        var methodArg = typeof (args) == Array || args.length > 1 ? Array.prototype.slice.call(args, 1) : $({}).toArray();

        while (object[method] == undefined && object.base != null) {
            if (object[method] != undefined && $.isFunction(object[method]))
                return object[method].apply(object, methodArg);

            if (typeof method == 'string') {
                var methodLowerCase = method.toLowerCase();
                if (object[methodLowerCase] != undefined && $.isFunction(object[methodLowerCase])) {
                    return object[methodLowerCase].apply(object, methodArg);
                }
            }
            object = object.base;
        }

        if (object[method] != undefined && $.isFunction(object[method]))
            return object[method].apply(object, methodArg);

        if (typeof method == 'string') {
            var methodLowerCase = method.toLowerCase();
            if (object[methodLowerCase] != undefined && $.isFunction(object[methodLowerCase])) {
                return object[methodLowerCase].apply(object, methodArg);
            }
        }

        return;
    }
    $.jqx.hasProperty = function (obj, property) {
        if (typeof (property) == 'object') {
            for (var prop in property) {
                var o = obj;
                while (o) {
                    if (o.hasOwnProperty(prop))
                        return true;
                    if (o.hasOwnProperty(prop.toLowerCase()))
                        return true;
                    o = o.base;
                }
                return false;
            }
        }
        else {
            while (obj) {
                if (obj.hasOwnProperty(property))
                    return true;
                if (obj.hasOwnProperty(property.toLowerCase()))
                    return true;
                obj = obj.base;
            }
        }

        return false;
    }

    $.jqx.hasFunction = function (object, args) {
        if (args.length == 0)
            return false;

        if (object == undefined)
            return false;

        var method = typeof (args) == Array || args.length > 0 ? args[0] : args;
        var methodArg = typeof (args) == Array || args.length > 1 ? Array.prototype.slice.call(args, 1) : {};

        while (object[method] == undefined && object.base != null) {
            if (object[method] && $.isFunction(object[method]))
                return true;

            if (typeof method == 'string') {
                var methodLowerCase = method.toLowerCase();
                if (object[methodLowerCase] && $.isFunction(object[methodLowerCase]))
                    return true;
            }
            object = object.base;
        }

        if (object[method] && $.isFunction(object[method]))
            return true;

        if (typeof method == 'string') {
            var methodLowerCase = method.toLowerCase();
            if (object[methodLowerCase] && $.isFunction(object[methodLowerCase]))
                return true;
        }

        return false;
    }

    $.jqx.isPropertySetter = function (obj, args) {
        if (args.length == 1 && typeof (args[0]) == 'object')
            return true;

        if (args.length == 2 &&
            typeof (args[0]) == 'string' &&
            !$.jqx.hasFunction(obj, args)) {
            return true;
        }

        return false;
    }

    $.jqx.validatePropertySetter = function (obj, args, suppressException) {
        if (!$.jqx.propertySetterValidation)
            return true;

        if (args.length == 1 && typeof (args[0]) == 'object') {
            for (var i in args[0]) {
                var o = obj;
                while (!o.hasOwnProperty(i) && o.base)
                    o = o.base;

                if (!o || !o.hasOwnProperty(i)) {
                    if (!suppressException) {
                        var hasLowerCase = o.hasOwnProperty(i.toString().toLowerCase());
                        if (!hasLowerCase) {
                            throw 'Invalid property: ' + i;
                        }
                        else return true;
                    }
                    return false;
                }
            }

            return true;
        }

        if (args.length != 2) {
            if (!suppressException)
                throw 'Invalid property: ' + args.length >= 0 ? args[0] : '';

            return false;
        }

        while (!obj.hasOwnProperty(args[0]) && obj.base)
            obj = obj.base;

        if (!obj || !obj.hasOwnProperty(args[0])) {
            if (!suppressException)
                throw 'Invalid property: ' + args[0];

            return false;
        }

        return true;
    }

    $.jqx.set = function (object, args) {
        if (args.length == 1 && typeof (args[0]) == 'object') {
            $.each(args[0], function (key, value) {
                var obj = object;
                while (!obj.hasOwnProperty(key) && obj.base != null)
                    obj = obj.base;

                if (obj.hasOwnProperty(key)) {
                    $.jqx.setvalueraiseevent(obj, key, value);
                }
                else if (obj.hasOwnProperty(key.toLowerCase())) {
                    $.jqx.setvalueraiseevent(obj, key.toLowerCase(), value);
                }
                else if ($.jqx.propertySetterValidation)
                    throw "jqxCore: invalid property '" + key + "'";
            });
        }
        else if (args.length == 2) {
            while (!object.hasOwnProperty(args[0]) && object.base)
                object = object.base;

            if (object.hasOwnProperty(args[0])) {
                $.jqx.setvalueraiseevent(object, args[0], args[1]);
            }
            else if (object.hasOwnProperty(args[0].toLowerCase())) {
                $.jqx.setvalueraiseevent(object, args[0].toLowerCase(), args[1]);
            }
            else if ($.jqx.propertySetterValidation)
                throw "jqxCore: invalid property '" + args[0] + "'";
        }
    }

    $.jqx.setvalueraiseevent = function (object, key, value) {
        var oldVal = object[key];

        object[key] = value;

        if (!object.isInitialized)
            return;

        if (object.propertyChangedHandler != undefined)
            object.propertyChangedHandler(object, key, oldVal, value);

        if (object.propertyChangeMap != undefined && object.propertyChangeMap[key] != undefined)
            object.propertyChangeMap[key](object, key, oldVal, value);
    };

    $.jqx.get = function (object, args) {
        if (args == undefined || args == null)
            return undefined;

        if (object.propertyMap) {
            var newVal = object.propertyMap(args);
            if (newVal != null)
                return newVal;
        }

        if (object.hasOwnProperty(args))
            return object[args];

        if (object.hasOwnProperty(args.toLowerCase()))
            return object[args.toLowerCase()];

        var arg = undefined;
        if (typeof (args) == Array) {
            if (args.length != 1)
                return undefined;
            arg = args[0];
        }
        else if (typeof (args) == 'string')
            arg = args;

        while (!object.hasOwnProperty(arg) && object.base)
            object = object.base;

        if (object)
            return object[arg];

        return undefined;
    }

    $.jqx.serialize = function (obj) {
        var txt = '';
        if ($.isArray(obj)) {
            txt = '['
            for (var i = 0; i < obj.length; i++) {
                if (i > 0)
                    txt += ', ';
                txt += $.jqx.serialize(obj[i]);
            }
            txt += ']';
        }
        else if (typeof (obj) == 'object') {
            txt = '{';
            var j = 0;
            for (var i in obj) {
                if (j++ > 0)
                    txt += ', ';
                txt += i + ': ' + $.jqx.serialize(obj[i]);
            }
            txt += '}';
        }
        else
            txt = obj.toString();

        return txt;
    }

    $.jqx.propertySetterValidation = true;

    $.jqx.jqxWidgetProxy = function (controlName, element, args) {
        var host = $(element);
        var vars = $.data(element, controlName);
        if (vars == undefined) {
            return undefined;
        }

        var obj = vars.instance;

        if ($.jqx.hasFunction(obj, args))
            return $.jqx.invoke(obj, args);

        if ($.jqx.isPropertySetter(obj, args)) {
            if ($.jqx.validatePropertySetter(obj, args)) {
                $.jqx.set(obj, args);
                return undefined;
            }
        } else {
            if (typeof (args) == 'object' && args.length == 0)
                return;
            else if (typeof (args) == 'object' && args.length == 1 && $.jqx.hasProperty(obj, args[0]))
                return $.jqx.get(obj, args[0]);
            else if (typeof (args) == 'string' && $.jqx.hasProperty(obj, args[0]))
                return $.jqx.get(obj, args);
        }

        throw "jqxCore: Invalid parameter '" + $.jqx.serialize(args) + "' does not exist.";
        return undefined;
    }

    $.jqx.applyWidget = function (element, controlName, args, instance) {
        var WinJS = false;
        try {
            WinJS = window.MSApp != undefined;
        }
        catch (e) {
        }

        var host = $(element);
        if (!instance) {
            instance = new $.jqx['_' + controlName]();
        }
        else {
            instance.host = host;
            instance.element = element;
        }
        if (element.id == "") {
            element.id = $.jqx.utilities.createId();
        }

        var vars = { host: host, element: element, instance: instance };

        instance.widgetName = controlName;

        $.data(element, controlName, vars);
        $.data(element, 'jqxWidget', vars.instance);

        var inits = new Array();
        var instance = vars.instance;
        while (instance) {
            instance.isInitialized = false;
            inits.push(instance);
            instance = instance.base;
        }
        inits.reverse();
        inits[0].theme = $.jqx.theme || '';

        $.jqx.jqxWidgetProxy(controlName, element, args);

        for (var i in inits) {
            instance = inits[i];
            if (i == 0) {
                instance.host = host;
                instance.element = element;
                instance.WinJS = WinJS;
            }
            if (instance != undefined) {
                if (instance.createInstance != null) {
                    if (WinJS) {
                        MSApp.execUnsafeLocalFunction(function () {
                            instance.createInstance(args);
                        });
                    }
                    else {
                        instance.createInstance(args);
                    }
                }
            }
        }

        for (var i in inits) {
            if (inits[i] != undefined) {
                inits[i].isInitialized = true;
            }
        }

        if (WinJS) {
            MSApp.execUnsafeLocalFunction(function () {
                vars.instance.refresh(true);
            });
        }
        else {
            vars.instance.refresh(true);
        }

    }

    $.jqx.jqxWidget = function (name, base, params) {
        var WinJS = false;
        try {
            jqxArgs = Array.prototype.slice.call(params, 0);
        }
        catch (e) {
            jqxArgs = '';
        }

        try {
            WinJS = window.MSApp != undefined;
        }
        catch (e) {
        }

        var controlName = name;

        var baseControl = '';
        if (base)
            baseControl = '_' + base;
        $.jqx.define($.jqx, '_' + controlName, baseControl);

        $.fn[controlName] = function () {
            var args = Array.prototype.slice.call(arguments, 0);

            if (args.length == 0 || (args.length == 1 && typeof (args[0]) == 'object')) {
                if (this.length == 0) {
                    if (this.selector) {
                        throw new Error('Invalid jQuery Selector - ' + this.selector + '! Please, check whether the used ID or CSS Class name is correct.');
                    }
                    else {
                        throw new Error('Invalid jQuery Selector! Please, check whether the used ID or CSS Class name is correct.');
                    }
                }

                return this.each(function () {
                    var host = $(this);
                    var element = this; // element == this == host[0]
                    var vars = $.data(element, controlName);

                    if (vars == null) {
                        $.jqx.applyWidget(element, controlName, args, undefined);
                    }
                    else {
                        $.jqx.jqxWidgetProxy(controlName, this, args);
                    }
                }); // each
            }
            else {
                if (this.length == 0) {
                    if (this.selector) {
                        throw new Error('Invalid jQuery Selector - ' + this.selector + '! Please, check whether the used ID or CSS Class name is correct.');
                    }
                    else {
                        throw new Error('Invalid jQuery Selector! Please, check whether the used ID or CSS Class name is correct.');
                    }
                }

                var returnVal = null;

                var cnt = 0;
                this.each(function () {
                    var result = $.jqx.jqxWidgetProxy(controlName, this, args);

                    if (cnt == 0) {
                        returnVal = result;
                        cnt++;
                    }
                    else {
                        if (cnt == 1) {
                            var tmp = [];
                            tmp.push(returnVal);
                            returnVal = tmp;
                        }
                        returnVal.push(result);
                    }
                }); // each
            }

            return returnVal;
        }

        try {
            $.extend($.jqx['_' + controlName].prototype, Array.prototype.slice.call(params, 0)[0]);
        }
        catch (e) {
        }

        $.extend($.jqx['_' + controlName].prototype, {
            toThemeProperty: function (propertyName, override) {
                if (this.theme == '')
                    return propertyName;

                if (override != null && override) {
                    return propertyName + '-' + this.theme;
                }

                return propertyName + ' ' + propertyName + '-' + this.theme;
            }
        });

        $.jqx['_' + controlName].prototype.refresh = function () {
            if (this.base)
                this.base.refresh(true);
        }
        $.jqx['_' + controlName].prototype.createInstance = function () {
        }
        $.jqx['_' + controlName].prototype.applyTo = function (element, args) {
            if (!(args instanceof Array)) {
                var a = [];
                a.push(args);
                args = a;
            }

            $.jqx.applyWidget(element, controlName, args, this);
        }

        $.jqx['_' + controlName].prototype.getInstance = function () {
            return this;
        }
        $.jqx['_' + controlName].prototype.propertyChangeMap = {};

        $.jqx['_' + controlName].prototype.addHandler = function (source, event, func, data) {
            switch (event) {
                case 'mousewheel':
                    if (window.addEventListener) {
                        if ($.jqx.browser.mozilla) {
                            source[0].addEventListener('DOMMouseScroll', func, false);
                        }
                        else {
                            source[0].addEventListener('mousewheel', func, false);
                        }
                        return false;
                    }
                    break;
                case 'mousemove':
                    if (window.addEventListener && !data) {
                        source[0].addEventListener('mousemove', func, false);
                        return false;
                    }
                    break;
            }

            if (data == undefined || data == null) {
                if (source.on) {
                    source.on(event, func);
                }
                else {
                    source.bind(event, func);
                }
            }
            else {
                if (source.on) {
                    source.on(event, data, func);
                }
                else {
                    source.bind(event, data, func);
                }
            }
        };

        $.jqx['_' + controlName].prototype.removeHandler = function (source, event, func) {
            switch (event) {
                case 'mousewheel':
                    if (window.removeEventListener) {
                        if ($.jqx.browser.mozilla) {
                            source[0].removeEventListener('DOMMouseScroll', func, false);
                        }
                        else {
                            source[0].removeEventListener('mousewheel', func, false);
                        }
                        return false;
                    }
                    break;
                case 'mousemove':
                    if (func) {
                        if (window.removeEventListener) {
                            source[0].removeEventListener('mousemove', func, false);
                        }
                    }
                    break;
            }

            if (event == undefined) {
                if (source.off) {
                    source.off();
                }
                else source.unbind();
                return;
            }

            if (func == undefined) {
                if (source.off) {
                    source.off(event);
                }
                else {
                    source.unbind(event);
                }
            }
            else {
                if (source.off) {
                    source.off(event, func);
                }
                else {
                    source.unbind(event, func);
                }
            }
        };
    } // jqxWidget

    $.jqx.theme = "";

    // Utilities
    $.jqx.utilities = $.jqx.utilities || {};
    $.extend($.jqx.utilities,
    {
        scrollBarSize: 15,
        touchScrollBarSize: 10,

        createId: function () {
            var S4 = function () {
                return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
            };
            return "jqxWidget" + S4() + S4();
        },

        setTheme: function (oldTheme, theme, element) {
            if (typeof element === 'undefined') {
                return;
            }
            var classNames = element[0].className.split(' '),
                oldClasses = [], newClasses = [],
                children = element.children();
            for (var i = 0; i < classNames.length; i += 1) {
                if (classNames[i].indexOf(oldTheme) >= 0) {
                    if (oldTheme.length > 0) {
                        oldClasses.push(classNames[i]);
                        newClasses.push(classNames[i].replace(oldTheme, theme));
                    }
                    else {
                        newClasses.push(classNames[i] + '-' + theme);
                    }
                }
            }
            this._removeOldClasses(oldClasses, element);
            this._addNewClasses(newClasses, element);
            for (var i = 0; i < children.length; i += 1) {
                this.setTheme(oldTheme, theme, $(children[i]));
            }
        },

        _removeOldClasses: function (classes, element) {
            for (var i = 0; i < classes.length; i += 1) {
                element.removeClass(classes[i]);
            }
        },

        _addNewClasses: function (classes, element) {
            for (var i = 0; i < classes.length; i += 1) {
                element.addClass(classes[i]);
            }
        },

        getOffset: function (el) {
            var left = $.jqx.mobile.getLeftPos(el[0]);
            var top = $.jqx.mobile.getTopPos(el[0]);
            return { top: top, left: left };
        },

        resize: function(element, callback, destroy, checkForHidden)
        {
            if (checkForHidden === undefined) {
                checkForHidden = true;
            }

            var index = -1;
            var that = this;
            var getHiddenIndex = function (element) {
                if (!that.hiddenWidgets) {
                    return -1;
                }

                var hiddenIndex = -1;
                for (var i = 0; i < that.hiddenWidgets.length; i++) {
                    if (element.id) {
                        if (that.hiddenWidgets[i].id == element.id) {
                            hiddenIndex = i;
                            break;
                        }
                    }
                    else {
                        if (that.hiddenWidgets[i].id == element[0].id) {
                            hiddenIndex = i;
                            break;
                        }
                    }
                }
                return hiddenIndex;
            }


            if (this.resizeHandlers) {
                for (var i = 0; i < this.resizeHandlers.length; i++) {
                    if (element.id) {
                        if (this.resizeHandlers[i].id == element.id) {
                            index = i;
                            break;
                        }
                    }
                    else {
                        if (this.resizeHandlers[i].id == element[0].id) {
                            index = i;
                            break;
                        }
                    }
                }

                if (destroy === true) {
                    if (index != -1) {
                        this.resizeHandlers.splice(index, 1);
                    }

                    if (this.resizeHandlers.length == 0) {
                        var w = $(window);
                        if (w.off) {
                            w.off('resize.jqx');
                            w.off('orientationchange.jqx');
                            w.off('orientationchanged.jqx');
                        }
                        else {
                            w.unbind('resize.jqx');
                            w.unbind('orientationchange.jqx');
                            w.unbind('orientationchanged.jqx');
                        }
                        this.resizeHandlers = null;
                    }
                    var hiddenIndex = getHiddenIndex(element);
                    if (hiddenIndex != -1 && this.hiddenWidgets) {
                        this.hiddenWidgets.splice(hiddenIndex, 1);
                    }
                    return;
                }
            }
            else if (destroy === true) {
                var hiddenIndex = getHiddenIndex(element);
                if (hiddenIndex != -1 && this.hiddenWidgets) {
                    this.hiddenWidgets.splice(hiddenIndex, 1);
                }
                return;
            }
            var that = this;
            var doResize = function (isHidden, type) {
                if (!that.resizeHandlers)
                    return;

                var compare = function (value1, value2) {
                    var parents1 = value1.widget.parents().length;
                    var parents2 = value2.widget.parents().length;

                    try {
                        if (parents1 < parents2) { return -1; }
                        if (parents1 > parents2) { return 1; }
                    }
                    catch (error) {
                        var er = error;
                    }

                    return 0;
                };

                that.hiddenWidgets = new Array();
                that.resizeHandlers.sort(compare);
                $.each(that.resizeHandlers, function (index, value) {
                    var data = this.widget.data();
                    if (!data) return true;
                    if (!data.jqxWidget) return true;

                    var width = data.jqxWidget.width;
                    var height = data.jqxWidget.height;

                    var percentageSize = false;
                    if (width != null && width.toString().indexOf("%") != -1) {
                        percentageSize = true;
                    }

                    if (height != null && height.toString().indexOf("%") != -1) {
                        percentageSize = true;
                    }

                    if ($.jqx.isHidden(this.widget)) {
                        if (getHiddenIndex(this.widget) === -1) {
                            that.hiddenWidgets.push(this);
                        }
                    }
                    else if (isHidden === undefined || isHidden !== true) {
                        if (percentageSize) {
                            this.callback(type);
                            if (that.hiddenWidgets.indexOf(this) >= 0) {
                                that.hiddenWidgets.splice(that.hiddenWidgets.indexOf(this), 1);
                            }
                        }
                    }
                });
                if (that.hiddenWidgets.length > 0) {
                    that.hiddenWidgets.sort(compare);
                    if (that.__resizeInterval) clearInterval(that.__resizeInterval);
                    that.__resizeInterval = setInterval(function () {
                        var hasHiddenWidget = false;
                        var currentHiddenWidgets = new Array();
                        $.each(that.hiddenWidgets, function (index, value) {
                            if ($.jqx.isHidden(this.widget)) {
                                hasHiddenWidget = true;
                                currentHiddenWidgets.push(this);
                            }
                            else {
                                this.callback(type);
                            }
                        });
                        that.hiddenWidgets = currentHiddenWidgets;
                        if (!hasHiddenWidget) {
                            clearInterval(that.__resizeInterval);
                        }
                    }, 100);
                }
            }

            if (!this.resizeHandlers) {
                this.resizeHandlers = new Array();
             
                var w = $(window);
                if (w.on) {
                    w.on('resize.jqx', function (event) {
                        doResize(null, 'resize');
                    });
                    w.on('orientationchange.jqx', function (event) {
                        doResize(null, 'orientationchange');
                    });
                    w.on('orientationchanged.jqx', function (event) {
                        doResize(null, 'orientationchange');
                    });
                }
                else {
                    w.bind('resize.jqx', function (event) {
                        doResize(null, 'orientationchange');
                    });
                    w.bind('orientationchange.jqx', function (event) {
                        doResize(null, 'orientationchange');
                    });
                    w.bind('orientationchanged.jqx', function (event) {
                        doResize(null, 'orientationchange');
                    });
                }
            }
            if (checkForHidden) {
                if (index === -1) {
                    this.resizeHandlers.push({ id: element[0].id, widget: element, callback: callback });
                }
            }
            if ($.jqx.isHidden(element) && checkForHidden === true) {
                doResize(true);
            }
        },

        html: function (element, value) {
            if (!$(element).on) {
                return $(element).html(value);
            }
            try
            {
                return jQuery.access(element, function (value) {
                    var elem = element[0] || {},
                        i = 0,
                        l = element.length;

                    if (value === undefined) {
                        return elem.nodeType === 1 ?
                            elem.innerHTML.replace(rinlinejQuery, "") :
                            undefined;
                    }

                    var rnoInnerhtml = /<(?:script|style|link)/i,
                        nodeNames = "abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|" +
            "header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",
                        rxhtmlTag = /<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,
                        rtagName = /<([\w:]+)/,
                        rnocache = /<(?:script|object|embed|option|style)/i,
                        rnoshimcache = new RegExp("<(?:" + nodeNames + ")[\\s/>]", "i"),
                        rleadingWhitespace = /^\s+/,
                        wrapMap = {
                            option: [1, "<select multiple='multiple'>", "</select>"],
                            legend: [1, "<fieldset>", "</fieldset>"],
                            thead: [1, "<table>", "</table>"],
                            tr: [2, "<table><tbody>", "</tbody></table>"],
                            td: [3, "<table><tbody><tr>", "</tr></tbody></table>"],
                            col: [2, "<table><tbody></tbody><colgroup>", "</colgroup></table>"],
                            area: [1, "<map>", "</map>"],
                            _default: [0, "", ""]
                        };

                    if (typeof value === "string" && !rnoInnerhtml.test(value) &&
                        (jQuery.support.htmlSerialize || !rnoshimcache.test(value)) &&
                        (jQuery.support.leadingWhitespace || !rleadingWhitespace.test(value)) &&
                        !wrapMap[(rtagName.exec(value) || ["", ""])[1].toLowerCase()]) {

                        value = value.replace(rxhtmlTag, "<$1></$2>");

                        try {
                            for (; i < l; i++) {
                                elem = this[i] || {};
                                if (elem.nodeType === 1) {
                                    jQuery.cleanData(elem.getElementsByTagName("*"));
                                    elem.innerHTML = value;
                                }
                            }

                            elem = 0;
                        } catch (e) { }
                    }

                    if (elem) {
                        element.empty().append(value);
                    }
                }, null, value, arguments.length);
            }
            catch (error) {
                return $(element).html(value);
            }
        },

        hasTransform: function (el) {
            var transform = "";
            transform = el.css('transform');

            if (transform == "" || transform == 'none') {
                transform = el.parents().css('transform');
                if (transform == "" || transform == 'none') {
                    var browserInfo = $.jqx.utilities.getBrowser();
                    if (browserInfo.browser == 'msie') {
                        transform = el.css('-ms-transform');
                        if (transform == "" || transform == 'none') {
                            transform = el.parents().css('-ms-transform');
                        }
                    }
                    else if (browserInfo.browser == 'chrome') {
                        transform = el.css('-webkit-transform');
                        if (transform == "" || transform == 'none') {
                            transform = el.parents().css('-webkit-transform');
                        }
                    }
                    else if (browserInfo.browser == 'opera') {
                        transform = el.css('-o-transform');
                        if (transform == "" || transform == 'none') {
                            transform = el.parents().css('-o-transform');
                        }
                    }
                    else if (browserInfo.browser == 'mozilla') {
                        transform = el.css('-moz-transform');
                        if (transform == "" || transform == 'none') {
                            transform = el.parents().css('-moz-transform');
                        }
                    }
                } else {
                    return transform != "" && transform != 'none';
                }
            }
            if (transform == "" || transform == 'none') {
                transform = $(document.body).css('transform');
            }
            return transform != "" && transform != 'none' && transform != null;
        },

        getBrowser: function () {
            var ua = navigator.userAgent.toLowerCase();

            var match = /(chrome)[ \/]([\w.]+)/.exec(ua) ||
		        /(webkit)[ \/]([\w.]+)/.exec(ua) ||
		        /(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua) ||
		        /(msie) ([\w.]+)/.exec(ua) ||
		        ua.indexOf("compatible") < 0 && /(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua) ||
		        [];

            var obj = {
                browser: match[1] || "",
                version: match[2] || "0"
            };
            obj[match[1]] = match[1];
            return obj;
        }
    });
    $.jqx.browser = $.jqx.utilities.getBrowser();
    $.jqx.isHidden = function (element) {
        try
        {
            var w = element[0].offsetWidth, h = element[0].offsetHeight;
            if (w === 0 || h === 0)
                return true;
            else {
                return false;
            }
        }
        catch (error) {
            return false;
        }
    };

    $.jqx.ariaEnabled = true;
    $.jqx.aria = function (that, property, value) {
        if (!$.jqx.ariaEnabled)
            return;

        if (property == undefined) {
            $.each(that.aria, function (index, value) {
                var attrValue = !that.base ? that.host.attr(index) : that.base.host.attr(index);
                if (attrValue != undefined && !$.isFunction(attrValue)) {
                    var newValue = attrValue;
                    switch (value.type) {
                        case "number":
                            newValue = new Number(attrValue);
                            if (isNaN(newValue)) newValue = attrValue;
                            break;
                        case "boolean":
                            newValue = attrValue == "true" ? true : false;
                            break;
                        case "date":
                            newValue = new Date(attrValue);
                            if (newValue == "Invalid Date" || isNaN(newValue)) newValue = attrValue;
                            break;
                    }

                    that[value.name] = newValue;
                }
                else {
                    var attrValue = that[value.name];
                    if ($.isFunction(attrValue)) attrValue = that[value.name]();
                    if (attrValue == undefined) attrValue = "";
                    try
                    {
                        !that.base ? that.host.attr(index, attrValue.toString()) : that.base.host.attr(index, attrValue.toString());
                    }
                    catch (error) {
                    }
                }
            });
        }
        else {
            try {
                if (that.host) {
                    if (!that.base) {
                        if (that.host) {
                            if (that.element.setAttribute) {
                                that.element.setAttribute(property, value.toString());
                            }
                            else {
                                that.host.attr(property, value.toString());
                            }
                        }
                        else {
                            that.attr(property, value.toString());
                        }
                    }
                    else {
                        if (that.base.host) {
                            that.base.host.attr(property, value.toString());
                        }
                        else {
                            that.attr(property, value.toString());
                        }
                    }
                }
                else if (that.setAttribute) {
                    that.setAttribute(property, value.toString());
                }
            }
            catch (error) {
            }
        }
    };

    if (!Array.prototype.indexOf) {
        Array.prototype.indexOf = function (elt /*, from*/) {
            var len = this.length;

            var from = Number(arguments[1]) || 0;
            from = (from < 0)
                ? Math.ceil(from)
                : Math.floor(from);
            if (from < 0)
                from += len;

            for (; from < len; from++) {
                if (from in this &&
                this[from] === elt)
                    return from;
            }
            return -1;
        };
    }

    $.jqx.mobile = $.jqx.mobile || {};
    $.jqx.position = function (event) {
        var left = parseInt(event.pageX);
        var top = parseInt(event.pageY);

        if ($.jqx.mobile.isTouchDevice()) {
            var touches = $.jqx.mobile.getTouches(event);
            var touch = touches[0];
            left = parseInt(touch.pageX);
            top = parseInt(touch.pageY);
        }
        return { left: left, top: top }
    }

    $.extend($.jqx.mobile,
    {
        _touchListener: function (e, me) {
            var createTouchEvent = function (name, e) {
                var event = document.createEvent('MouseEvents');

                event.initMouseEvent(
                    name,
                    e.bubbles,
                    e.cancelable,
                    e.view,
                    e.detail,
                    e.screenX,
                    e.screenY,
                    e.clientX,
                    e.clientY,
                    e.ctrlKey,
                    e.altKey,
                    e.shiftKey,
                    e.metaKey,
                    e.button,
                    e.relatedTarget
                );
                event._pageX = e.pageX;
                event._pageY = e.pageY;

                return event;
            }

            var eventMap = { 'mousedown': 'touchstart', 'mouseup': 'touchend', 'mousemove': 'touchmove' };
            var event = createTouchEvent(eventMap[e.type], e);
            e.target.dispatchEvent(event);

            var fn = e.target['on' + eventMap[e.type]];
            if (typeof fn === 'function') fn(e);
        },

        setMobileSimulator: function (element, value) {
            if (this.isTouchDevice()) {
                return;
            }

            this.simulatetouches = true;
            if (value == false) {
                this.simulatetouches = false;
            }

            var eventMap = { 'mousedown': 'touchstart', 'mouseup': 'touchend', 'mousemove': 'touchmove' };

            var self = this;
            if (window.addEventListener) {
                var subscribeToEvents = function () {
                    for (var key in eventMap) {
                        if (element.addEventListener) {
                            element.removeEventListener(key, self._touchListener);
                            element.addEventListener(key, self._touchListener, false);
                        }

                        //  document.removeEventListener(key, self._touchListener);
                        //  document.addEventListener(key, self._touchListener, false);
                    }
                }

                if ($.jqx.browser.msie) {
                    subscribeToEvents();
                }
                else {
                    subscribeToEvents();
                }
            }
        },

        isTouchDevice: function () {
            if (this.touchDevice != undefined)
                return this.touchDevice;

            var txt = "Browser CodeName: " + navigator.appCodeName + "";
            txt += "Browser Name: " + navigator.appName + "";
            txt += "Browser Version: " + navigator.appVersion + "";
            txt += "Platform: " + navigator.platform + "";
            txt += "User-agent header: " + navigator.userAgent + "";

            if (txt.indexOf('Android') != -1)
                return true;

            if (txt.indexOf('IEMobile') != -1)
                return true;

            if (txt.indexOf('Windows Phone') != -1)
                return true;

            if (txt.indexOf('WPDesktop') != -1)
                return true;
         
            if (txt.indexOf('ZuneWP7') != -1)
                return true;

            if (txt.indexOf('BlackBerry') != -1 && txt.indexOf('Mobile Safari') != -1)
                return true;

            if (txt.indexOf('ipod') != -1)
                return true;

            if (txt.indexOf('nokia') != -1 || txt.indexOf('Nokia') != -1)
                return true;

            if (txt.indexOf('Chrome/17') != -1)
                return false;

            if (txt.indexOf('CrOS') != -1)
                return false;

            if (txt.indexOf('Opera') != -1 && txt.indexOf('Mobi') == -1 && txt.indexOf('Mini') == -1 && txt.indexOf('Platform: Win') != -1) {
                return false;
            }

            if (txt.indexOf('Opera') != -1 && txt.indexOf('Mobi') != -1 && txt.indexOf('Opera Mobi') != -1) {
                return true;
            }

            var deviceTypes = {
                    ios: 'i(?:Pad|Phone|Pod)(?:.*)CPU(?: iPhone)? OS ',
                    android: '(Android |HTC_|Silk/)',
                    blackberry: 'BlackBerry(?:.*)Version\/',
                    rimTablet: 'RIM Tablet OS ',
                    webos: '(?:webOS|hpwOS)\/',
                    bada: 'Bada\/'
            }

            // check for IPad, IPhone, IE and Chrome
            try {
                if (this.touchDevice != undefined)
                    return this.touchDevice;

                this.touchDevice = false;
                for (i in deviceTypes) {
                    if (deviceTypes.hasOwnProperty(i)) {
                        prefix = deviceTypes[i];                  
                        match = txt.match(new RegExp('(?:' + prefix + ')([^\\s;]+)'));
                        if (match) {
                            if (i.toString() == "blackberry") {
                                // handle touches through mouse pointer.
                                this.touchDevice = false;
                                return false;
                            }

                            this.touchDevice = true;
                            return true;
                        }
                    }
                }
                if (navigator.platform.toLowerCase().indexOf('win') != -1) {
                    this.touchDevice = false;
                    return false;
                }
                document.createEvent("TouchEvent");
                this.touchDevice = true;
                return this.touchDevice;
            } catch (e) {
                this.touchDevice = false;
                return false;
            }
        },

        getLeftPos: function (inputObj) {
            var returnValue = inputObj.offsetLeft;
            while ((inputObj = inputObj.offsetParent) != null) {
                if (inputObj.tagName != 'HTML') {
                    returnValue += inputObj.offsetLeft;
                    if (document.all) returnValue += inputObj.clientLeft;
                }
            }
            return returnValue;
        },

        getTopPos: function (inputObj) {
            var returnValue = inputObj.offsetTop;
            var initialOffset = $(inputObj).coord();
            while ((inputObj = inputObj.offsetParent) != null) {
                if (inputObj.tagName != 'HTML') {
                    returnValue += (inputObj.offsetTop - inputObj.scrollTop);
                    if (document.all) returnValue += inputObj.clientTop;
                }
            }
            var agent = navigator.userAgent.toLowerCase();
            var wp8 = (agent.indexOf('windows phone') != -1 || agent.indexOf('WPDesktop') != -1 || agent.indexOf('ZuneWP7') != -1 || agent.indexOf('msie 9') != -1 || agent.indexOf('msie 11') != -1 || agent.indexOf('msie 10') != -1) && agent.indexOf('touch') != -1;
            if (wp8) {
                return initialOffset.top;
            }

            if (this.isSafariMobileBrowser()) {
                if (this.isSafari4MobileBrowser() && this.isIPadSafariMobileBrowser()) {
                    return returnValue;
                }
                if (agent.indexOf('version/7') != -1) {
                    return initialOffset.top;
                }

                returnValue = returnValue + $(window).scrollTop();
            }

            return returnValue;
        },

        isChromeMobileBrowser: function () {
            var agent = navigator.userAgent.toLowerCase();
            var result = agent.indexOf('android') != -1;
            return result;
        },

        isOperaMiniMobileBrowser: function () {
            var agent = navigator.userAgent.toLowerCase();
            var result = agent.indexOf('opera mini') != -1 || agent.indexOf('opera mobi') != -1;
            return result;
        },

        isOperaMiniBrowser: function () {
            var agent = navigator.userAgent.toLowerCase();
            var result = agent.indexOf('opera mini') != -1;
            return result;
        },

        isNewSafariMobileBrowser: function () {
            var agent = navigator.userAgent.toLowerCase();
            var result = agent.indexOf('ipad') != -1 || agent.indexOf('iphone') != -1 || agent.indexOf('ipod') != -1;
            result = result && (agent.indexOf('version/5') != -1);
            return result;
        },

        isSafari4MobileBrowser: function () {
            var agent = navigator.userAgent.toLowerCase();
            var result = agent.indexOf('ipad') != -1 || agent.indexOf('iphone') != -1 || agent.indexOf('ipod') != -1;
            result = result && (agent.indexOf('version/4') != -1);
            return result;
        },

        isWindowsPhone: function () {
            var agent = navigator.userAgent.toLowerCase();
            var result = (agent.indexOf('windows phone') != -1 || agent.indexOf('WPDesktop') != -1 || agent.indexOf('ZuneWP7') != -1 || agent.indexOf('msie 9') != -1 || agent.indexOf('msie 11') != -1 || agent.indexOf('msie 10') != -1) && agent.indexOf('touch') != -1;
            return result;
        },

        isSafariMobileBrowser: function () {
            var agent = navigator.userAgent.toLowerCase();
            var result = agent.indexOf('ipad') != -1 || agent.indexOf('iphone') != -1 || agent.indexOf('ipod') != -1;
            return result;
        },

        isIPadSafariMobileBrowser: function () {
            var agent = navigator.userAgent.toLowerCase();
            var result = agent.indexOf('ipad') != -1;
            return result;
        },

        isMobileBrowser: function () {
            var agent = navigator.userAgent.toLowerCase();
            var result = agent.indexOf('ipad') != -1 || agent.indexOf('iphone') != -1 || agent.indexOf('android') != -1;
            return result;
        },

        // Get the touch points from this event
        getTouches: function (e) {
            if (e.originalEvent) {
                if (e.originalEvent.touches && e.originalEvent.touches.length) {
                    return e.originalEvent.touches;
                } else if (e.originalEvent.changedTouches && e.originalEvent.changedTouches.length) {
                    return e.originalEvent.changedTouches;
                }
            }

            if (!e.touches) {
                e.touches = new Array();
                e.touches[0] = e.originalEvent != undefined ? e.originalEvent : e;

                if (e.originalEvent != undefined && e.pageX)
                    e.touches[0] = e;
                if (e.type == 'mousemove') e.touches[0] = e;
            }

            return e.touches;
        },

        getTouchEventName: function (name) {
            if (this.isWindowsPhone()) {
                if (name.toLowerCase().indexOf('start') != -1) return 'MSPointerDown';
                if (name.toLowerCase().indexOf('move') != -1) return 'MSPointerMove';
                if (name.toLowerCase().indexOf('end') != -1) return 'MSPointerUp';
            }
            else {
                return name;
            }
        },

        // Dispatches a fake mouse event from a touch event
        dispatchMouseEvent: function (name, touch, target) {
            if (this.simulatetouches)
                return;

            var e = document.createEvent('MouseEvent');
            e.initMouseEvent(name, true, true, touch.view, 1, touch.screenX, touch.screenY, touch.clientX, touch.clientY, false, false, false, false, 0, null);
            if (target != null) {
                target.dispatchEvent(e);
            }
        },

        // Find the root node of this target
        getRootNode: function (target) {
            while (target.nodeType !== 1) {
                target = target.parentNode;
            }
            return target;
        },

        setTouchScroll: function (enable, key) {
            if (!this.enableScrolling) this.enableScrolling = [];
            this.enableScrolling[key] = enable;
        },

        touchScroll: function (element, scrollHeight, callback, key, horizontalScroll, verticalScroll) {
            if (element == null)
                return;

            var me = this;
            var scrollY = 0;
            var touchY = 0;
            var movedY = 0;
            var scrollX = 0;
            var touchX = 0;
            var movedX = 0;
            if (!this.scrolling) this.scrolling = [];
            this.scrolling[key] = false;
            var moved = false;
            var $element = $(element);
            var touchTags = ['select', 'input', 'textarea'];
            var touchStart = 0;
            var touchEnd = 0;
            if (!this.enableScrolling) this.enableScrolling = [];
            this.enableScrolling[key] = true;
            var key = key;
            var touchStartName = this.getTouchEventName('touchstart') + ".touchScroll";
            var touchEndName = this.getTouchEventName('touchend') + ".touchScroll";
            var touchMoveName = this.getTouchEventName('touchmove') + ".touchScroll";

            var touchStart = function (event) {
                if (!me.enableScrolling[key])
                    return true;

                // Allow certain HTML tags to receive touch events
                if ($.inArray(event.target.tagName.toLowerCase(), touchTags) !== -1) {
                    return;
                }

                var touches = me.getTouches(event);
                var touch = touches[0];
                if (touches.length == 1) {
                    me.dispatchMouseEvent('mousedown', touch, me.getRootNode(touch.target));
                }

                moved = false;
                touchY = touch.pageY;
                touchX = touch.pageX;
                if (me.simulatetouches) {
                    touchY = touch._pageY;
                    touchX = touch._pageX;
                }
                me.scrolling[key] = true;

                scrollY = 0;
                scrollX = 0;
                return true;
            }

            if ($element.on) {
                $element.on(touchStartName, touchStart);
            }
            else {
                $element.bind(touchStartName, touchStart);
            }

            var touchMove = function (event) {
                if (!me.enableScrolling[key])
                    return true;

                if (!me.scrolling[key]) {
                    return true;
                }
                var touches = me.getTouches(event);
                if (touches.length > 1) {
                    return true;
                }

                var pageY = touches[0].pageY;
                var pageX = touches[0].pageX;

                if (me.simulatetouches) {
                    pageY = touches[0]._pageY;
                    pageX = touches[0]._pageX;
                }

                var dy = pageY - touchY;
                var dx = pageX - touchX;
                touchEnd = pageY;
                touchHorizontalEnd = pageX;
                movedY = dy - scrollY;
                movedX = dx - scrollX;
                moved = true;
                scrollY = dy;
                scrollX = dx;
                callback(-movedX * 1, -movedY * 1, dx, dy, event);

                var hScrollVisible = horizontalScroll != null ? horizontalScroll[0].style.display != 'none' : true;
                var vScrollVisible = verticalScroll != null ? verticalScroll[0].style.display != 'none' : true;

                if (hScrollVisible || vScrollVisible) {
                    if ((movedX !== 0 && hScrollVisible) || (movedY !== 0 && vScrollVisible)) {
                        event.preventDefault();
                        event.stopPropagation();
                        if (event.preventManipulation) {
                            event.preventManipulation();
                        }
                        return false;
                    }
                }
            }

            if ($element.on) {
                $element.on(touchMoveName, touchMove);
            }
            else $element.bind(touchMoveName, touchMove);

            if (this.simulatetouches) {
                var windowBindFunc = $(window).on != undefined || $(window).bind;
                var windowMouseUp = function (event) {
                    me.scrolling[key] = false;
                };
                $(window).on != undefined ? $(document).on('mouseup.touchScroll', windowMouseUp) : $(document).bind('mouseup.touchScroll', windowMouseUp);

                if (window.frameElement) {
                    if (window.top != null) {
                        var eventHandle = function (event) {
                            me.scrolling[key] = false;
                        };

                        if (window.top.document) {
                            $(window.top.document).on ? $(window.top.document).on('mouseup', eventHandle) : $(window.top.document).bind('mouseup', eventHandle);
                        }
                    }
                }

                var docBindFunc = $(document).on != undefined || $(document).bind;
                var touchEndFunc = function (event) {
                    if (!me.scrolling[key]) {
                        return true;
                    }
                    me.scrolling[key] = false;
                    var touch = me.getTouches(event)[0],
						target = me.getRootNode(touch.target);

                    // Dispatch fake mouse up and click events if this touch event did not move
                    me.dispatchMouseEvent('mouseup', touch, target);
                    me.dispatchMouseEvent('click', touch, target);
                };

                $(document).on != undefined ? $(document).on('touchend', touchEndFunc) : $(document).bind('touchend', touchEndFunc);
            }

            var touchCancel = function (event) {
                if (!me.enableScrolling[key])
                    return true;

                var touch = me.getTouches(event)[0];
                if (!me.scrolling[key]) {
                    return true;
                }
                me.scrolling[key] = false;
                if (moved) {
                    me.dispatchMouseEvent('mouseup', touch, target);
                } else {
                    var touch = me.getTouches(event)[0],
						target = me.getRootNode(touch.target);

                    //        event.preventDefault();
                    //         event.stopPropagation();
                    // Dispatch fake mouse up and click events if this touch event did not move
                    me.dispatchMouseEvent('mouseup', touch, target);
                    me.dispatchMouseEvent('click', touch, target);
                    return true;
                }
            }

            $element.on ? $element.on(touchEndName + ' touchcancel.touchScroll', touchCancel) : $element.bind(touchEndName + ' touchcancel.touchScroll', touchCancel);
        }
    });

    $.jqx.cookie = $.jqx.cookie || {};
    $.extend($.jqx.cookie,
    {
        cookie: function (key, value, options) {
            // set cookie.
            if (arguments.length > 1 && String(value) !== "[object Object]") {
                options = jQuery.extend({}, options);

                if (value === null || value === undefined) {
                    options.expires = -1;
                }

                if (typeof options.expires === 'number') {
                    var days = options.expires, t = options.expires = new Date();
                    t.setDate(t.getDate() + days);
                }

                value = String(value);

                return (document.cookie = [
                encodeURIComponent(key), '=',
                options.raw ? value : encodeURIComponent(value),
                options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
                options.path ? '; path=' + options.path : '',
                options.domain ? '; domain=' + options.domain : '',
                options.secure ? '; secure' : ''
        ].join(''));
            }
            // get cookie...
            options = value || {};
            var result, decode = options.raw ? function (s) { return s; } : decodeURIComponent;
            return (result = new RegExp('(?:^|; )' + encodeURIComponent(key) + '=([^;]*)').exec(document.cookie)) ? decode(result[1]) : null;
        }
    });

    // stringutilities
    $.jqx.string = $.jqx.string || {};
    $.extend($.jqx.string,
    {
        replace: function (text, stringToFind, stringToReplace) {
            if (stringToFind === stringToReplace) return this;
            var temp = text;
            var index = temp.indexOf(stringToFind);
            while (index != -1) {
                temp = temp.replace(stringToFind, stringToReplace);
                index = temp.indexOf(stringToFind);
            }
            return temp;
        },

        contains: function (fullString, value) {
            if (fullString == null || value == null)
                return false;

            return fullString.indexOf(value) != -1;
        },

        containsIgnoreCase: function (fullString, value) {
            if (fullString == null || value == null)
                return false;

            return fullString.toUpperCase().indexOf(value.toUpperCase()) != -1;
        },

        equals: function (fullString, value) {
            if (fullString == null || value == null)
                return false;

            fullString = this.normalize(fullString);

            if (value.length == fullString.length) {
                return fullString.slice(0, value.length) == value;
            }

            return false;
        },

        equalsIgnoreCase: function (fullString, value) {
            if (fullString == null || value == null)
                return false;

            fullString = this.normalize(fullString);

            if (value.length == fullString.length) {
                return fullString.toUpperCase().slice(0, value.length) == value.toUpperCase();
            }

            return false;
        },

        startsWith: function (fullString, value) {
            if (fullString == null || value == null)
                return false;

            return fullString.slice(0, value.length) == value;
        },

        startsWithIgnoreCase: function (fullString, value) {
            if (fullString == null || value == null)
                return false;

            return fullString.toUpperCase().slice(0, value.length) == value.toUpperCase();
        },

        normalize: function (fullString) {
            if (fullString.charCodeAt(fullString.length - 1) == 65279) {
                fullString = fullString.substring(0, fullString.length - 1);
            }

            return fullString;
        },

        endsWith: function (fullString, value) {
            if (fullString == null || value == null)
                return false;

            fullString = this.normalize(fullString);
            return fullString.slice(-value.length) == value;
        },

        endsWithIgnoreCase: function (fullString, value) {
            if (fullString == null || value == null)
                return false;

            fullString = this.normalize(fullString);

            return fullString.toUpperCase().slice(-value.length) == value.toUpperCase();
        }
    });

    $.extend(jQuery.easing, {
        easeOutBack: function (x, t, b, c, d, s) {
            if (s == undefined) s = 1.70158;
            return c * ((t = t / d - 1) * t * ((s + 1) * t + s) + 1) + b;
        },
        easeInQuad: function (x, t, b, c, d) {
            return c * (t /= d) * t + b;
        },
        easeInOutCirc: function (x, t, b, c, d) {
            if ((t /= d / 2) < 1) return -c / 2 * (Math.sqrt(1 - t * t) - 1) + b;
            return c / 2 * (Math.sqrt(1 - (t -= 2) * t) + 1) + b;
        },
        easeInOutSine: function (x, t, b, c, d) {
            return -c / 2 * (Math.cos(Math.PI * t / d) - 1) + b;
        },
        easeInCubic: function (x, t, b, c, d) {
            return c * (t /= d) * t * t + b;
        },
        easeOutCubic: function (x, t, b, c, d) {
            return c * ((t = t / d - 1) * t * t + 1) + b;
        },
        easeInOutCubic: function (x, t, b, c, d) {
            if ((t /= d / 2) < 1) return c / 2 * t * t * t + b;
            return c / 2 * ((t -= 2) * t * t + 2) + b;
        },
        easeInSine: function (x, t, b, c, d) {
            return -c * Math.cos(t / d * (Math.PI / 2)) + c + b;
        },
        easeOutSine: function (x, t, b, c, d) {
            return c * Math.sin(t / d * (Math.PI / 2)) + b;
        },
        easeInOutSine: function (x, t, b, c, d) {
            return -c / 2 * (Math.cos(Math.PI * t / d) - 1) + b;
        }
    });
})(jQuery);
(function ($) {
    $.extend(jQuery.event.special,
    {
        "close": { noBubble: true },
        "open": { noBubble: true },
        "cellclick": { noBubble: true },
        "rowclick": { noBubble: true },
        "tabclick": { noBubble: true },
        "selected": { noBubble: true },
        "expanded": { noBubble: true },
        "collapsed": { noBubble: true },
        "valuechanged": { noBubble: true },
        "expandedItem": { noBubble: true },
        "collapsedItem": { noBubble: true },
        "expandingItem": { noBubble: true },
        "collapsingItem": { noBubble: true }
    });

    $.fn.extend({
        ischildof: function (filter_string) {
            var parents = $(this).parents().get();

            for (var j = 0; j < parents.length; j++) {
                if (typeof filter_string != "string") {
                    var parent = parents[j];
                    if (filter_string !== undefined) {
                        if (parent == filter_string[0])
                            return true;
                    }
                }
                else {
                    if (filter_string !== undefined) {
                        if ($(parents[j]).is(filter_string)) {
                            return true;
                        }
                    }
                }
            }

            return false;
        }
    });

    $.fn.jqxProxy = function () {
        var widget = $(this).data().jqxWidget;

        var args = Array.prototype.slice.call(arguments, 0);
        return $.jqx.jqxWidgetProxy(widget.widgetName, widget.element, args);
    }

    var originalVal = this.originalVal = $.fn.val;
    $.fn.val = function (value) {
        if (typeof value == 'undefined') {
            if ($(this).hasClass('jqx-widget')) {
                var widget = $(this).data().jqxWidget;
                if (widget && widget.val) {
                    return widget.val();
                }
            }
            return originalVal.call(this);
        }
        else {
            if ($(this).hasClass('jqx-widget')) {
                var widget = $(this).data().jqxWidget;
                if (widget && widget.val) {
                    if (arguments.length != 2) {
                        return widget.val(value);
                    }
                    else {
                        return widget.val(value, arguments[1]);
                    }
                }
            }

            return originalVal.call(this, value);
        }
    };

    $.fn.coord = function (options) {
        var docElem, win,
            box = { top: 0, left: 0 },
            elem = this[0],
            doc = elem && elem.ownerDocument;
        if (!doc) {
            return;
        }
        docElem = doc.documentElement;
        if (!jQuery.contains(docElem, elem)) {
            return box;
        }
        if (typeof elem.getBoundingClientRect !== undefined) {
            box = elem.getBoundingClientRect();
        }
        var getWindow = function(elem) {
            return jQuery.isWindow(elem) ?
                elem :
                elem.nodeType === 9 ?
                    elem.defaultView || elem.parentWindow :
                    false;
        };

        win = getWindow(doc);
        var additionalLeftOffset = 0;
        var additionalTopOffset = 0;
        var agent = navigator.userAgent.toLowerCase();
        var result = agent.indexOf('ipad') != -1 || agent.indexOf('iphone') != -1;
        if (result) {
            // fix for iphone/ipad left offsets.
            additionalLeftOffset = 2;
        }
        if (true == options) {
            if ($(document.body).css('position') != 'static') {
                var coords = $(document.body).coord();
                additionalLeftOffset = -coords.left;
                additionalTopOffset = -coords.top;
            }
        }

        return {
            top: additionalTopOffset + box.top + (win.pageYOffset || docElem.scrollTop) - (docElem.clientTop || 0),
            left: additionalLeftOffset + box.left + (win.pageXOffset || docElem.scrollLeft) - (docElem.clientLeft || 0)
        };
    };
})(jQuery);
﻿(function ($) {
    $.jqx.dataAdapter = function (source, options) {
        if (source != undefined) {
            if (source.dataFields !== undefined) {
                source.datafields = source.dataFields;
            }
            if (source.dataType !== undefined) {
                source.datatype = source.dataType;
            }
            if (source.localData !== undefined) {
                source.localdata = source.localData;
            }
            if (source.sortColumn !== undefined) {
                source.sortcolumn = source.sortColumn;
            }
            if (source.sortDirection !== undefined) {
                source.sortdirection = source.sortDirection;
            }
            if (source.sortOrder !== undefined) {
                source.sortdirection = source.sortOrder;
            }
            if (source.formatData !== undefined) {
                source.formatdata = source.formatData;
            }
            if (source.processData !== undefined) {
                source.processdata = source.processData;
            }
            if (source.pageSize !== undefined) {
                source.pagesize = source.pageSize;
            }
            if (source.pageNum !== undefined) {
                source.pagenum = source.pageNum;
            }
            if (source.updateRow !== undefined) {
                source.updaterow = source.updateRow;
            }
            if (source.addRow !== undefined) {
                source.addrow = source.addRow;
            }
            if (source.deleteRow !== undefined) {
                source.deleterow = source.deleteRow;
            }
            if (source.contentType !== undefined) {
                source.contenttype = source.contentType;
            }
            if (source.totalRecords != undefined) {
                source.totalrecords = source.totalRecords;
            }
            if (source.loadError != undefined) {
                source.loadError = source.loadError;
            }
            if (source.sortComparer != undefined) {
                source.sortcomparer = source.sortComparer;
            }
        }

        this._source = source;
        this._options = options || {};
        this.records = new Array();
        this._downloadComplete = new Array();
        this._bindingUpdate = new Array();

        if (source != undefined && source.localdata != null && typeof source.localdata == "function") {
            var localData = source.localdata();
            if (localData != null) {
                source._localdata = source.localdata;
                var me = this;
                if (source._localdata.subscribe) {
                    me._oldlocaldata = [];
                    source._localdata.subscribe(function (value) {
                        var deepClone = function (objThing) {
                            if (jQuery.isArray(objThing)) {
                                return jQuery.makeArray(deepClone($(objThing)));
                            }
                            return jQuery.extend(true, {}, objThing);
                        };
                        if (me.suspendKO == false || me.suspendKO == undefined || me._oldlocaldata.length == 0) {
                            me._oldlocaldata = deepClone(value);
                        }
                    }, source._localdata, 'beforeChange');

                    source._localdata.subscribe(function (value) {
                        if (me.suspendKO == false || me.suspendKO == undefined) {
                            var changeType = "";
                            me._oldrecords = me.records;
                            if (me._oldlocaldata.length == 0) {
                                source.localdata = source._localdata();
                            }

                            if (me._oldlocaldata.length == 0) {
                                changeType = 'change';
                            }
                            else {
                                if (me._oldlocaldata.length == value.length) {
                                    changeType = 'update';
                                }
                                if (me._oldlocaldata.length > value.length) {
                                    changeType = 'remove';
                                }
                                if (me._oldlocaldata.length < value.length) {
                                    changeType = 'add';
                                }
                            }
                            me.dataBind(null, changeType);
                        }
                    }, source._localdata, 'change');

                    me._knockoutdatasource = true;
                }

                source.localdata = localData;
            }
        }
        if (this._options.autoBind == true) {
            this.dataBind();
        }
    }

    $.jqx.dataAdapter.prototype = {
        getrecords: function () {
            return this.records;
        },

        beginUpdate: function () {
            this.isUpdating = true;
        },

        endUpdate: function (refresh) {
            this.isUpdating = false;
            if (refresh != false) {
                if (this._changedrecords && this._changedrecords.length > 0) {
                    this.callBindingUpdate("update");
                    this._changedrecords = [];
                }
                else {
                    this.dataBind(null, "");
                }
            }
        },

        formatDate: function(value, format, calendar)
        {
            var result = $.jqx.dataFormat.formatdate(value, format, calendar);
            return result;
        },

        formatNumber: function (value, format, calendar) {
            var result = $.jqx.dataFormat.formatnumber(value, format, calendar);
            return result;
        },

        dataBind: function (objectuniqueId, collectionChanged) {
            if (this.isUpdating == true)
                return;

            var source = this._source;
            if (!source)
                return;

            $.jqx.dataFormat.datescache = new Array();
            if (source.dataFields != null) {
                source.datafields = source.dataFields;
            }

            if (source.recordstartindex == undefined) {
                source.recordstartindex = 0;
            }
            if (source.recordendindex == undefined) {
                source.recordendindex = 0;
            }
            if (source.loadallrecords == undefined) {
                source.loadallrecords = true;
            }

            if (source.sort != undefined) {
                this.sort = source.sort;
            }

            if (source.filter != undefined) {
                this.filter = source.filter;
            }
            else this.filter = null;

            if (source.sortcolumn != undefined) {
                this.sortcolumn = source.sortcolumn;
            }

            if (source.sortdirection != undefined) {
                this.sortdirection = source.sortdirection;
            }

            if (source.sortcomparer != undefined) {
                this.sortcomparer = source.sortcomparer;
            }

            this.records = new Array();
            var options = this._options || {};
            this.virtualmode = options.virtualmode != undefined ? options.virtualmode : false;
            this.totalrecords = options.totalrecords != undefined ? options.totalrecords : 0;
            this.pageable = options.pageable != undefined ? options.pageable : false;
            this.pagesize = options.pagesize != undefined ? options.pagesize : 0;
            this.pagenum = options.pagenum != undefined ? options.pagenum : 0;
            this.cachedrecords = options.cachedrecords != undefined ? options.cachedrecords : new Array();
            this.originaldata = new Array();
            this.recordids = new Array();
            this.updaterow = options.updaterow != undefined ? options.updaterow : null;
            this.addrow = options.addrow != undefined ? options.addrow : null;
            this.deleterow = options.deleterow != undefined ? options.deleterow : null;
            this.cache = options.cache != undefined ? options.cache : false;
            this.unboundmode = false;
            if (source.formatdata != undefined) {
                options.formatData = source.formatdata;
            }
            if (source.data != undefined) {
                if (options.data == undefined) {
                    options.data = {};
                }
                $.extend(options.data, source.data);
            }

            if (source.mapchar != undefined) {
                this.mapChar = source.mapchar ? source.mapchar : '>';
            }
            else {
                this.mapChar = options.mapChar ? options.mapChar : '>';
            }

            if (options.unboundmode || source.unboundmode) {
                this.unboundmode = options.unboundmode || source.unboundmode;
            }

            if (source.cache != undefined) {
                this.cache = source.cache;
            }

            if (this.koSubscriptions) {
                for (var subscription = 0; subscription < this.koSubscriptions.length; subscription++) {
                    this.koSubscriptions[subscription].dispose();
                }
            }
            this.koSubscriptions = new Array();

            if (this.pagenum < 0) {
                this.pagenum = 0;
            }

            var me = this;

            var datatype = source.datatype;

            if (source.datatype === 'csv' || source.datatype === 'tab' || source.datatype == 'text')
                datatype = 'text';

            var async = options.async != undefined ? options.async : true;

            if (source.async != undefined) {
                async = source.async;
            }

            switch (datatype) {
                case "local":
                case "array":
                case "observablearray":
                default:
                    if (source.localdata == undefined && source.length) {
                        source.localdata = new Array();
                        for (var i = 0; i < source.length; i++) {
                            source.localdata[source.localdata.length] = source[i];
                            source[i].uid = i;
                        }
                    }

                    var length = source.localdata.length;
                    this.totalrecords = this.virtualmode ? (source.totalrecords || length) : length;

                    if (this.unboundmode) {
                        this.totalrecords = this.unboundmode ? (source.totalrecords || length) : length;
                        var datafieldslength = source.datafields ? source.datafields.length : 0;
                        if (datafieldslength > 0) {
                            for (var i = 0; i < this.totalrecords; i++) {
                                var record = {};
                                for (var j = 0; j < datafieldslength; j++) {
                                    record[source.datafields[j].name] = "";
                                }
                                record.uid = i;
                                source.localdata[source.localdata.length] = record;
                            }
                        }
                    }

                    if (this.totalrecords == undefined) {
                        this.totalrecords = 0;
                    }

                    var datafieldslength = source.datafields ? source.datafields.length : 0;
                    var getrecord = function (record, datafieldslength) {
                        var datarow = {};
                        for (var j = 0; j < datafieldslength; j++) {
                            var datafield = source.datafields[j];
                            var value = '';
                            if (undefined == datafield || datafield == null) {
                                continue;
                            }

                            if (datafield.map) {
                                if ($.isFunction(datafield.map)) {
                                    value = datafield.map(record);
                                }
                                else {
                                    var splitMap = datafield.map.split(me.mapChar);
                                    if (splitMap.length > 0) {
                                        var datarecord = record;
                                        for (var p = 0; p < splitMap.length; p++) {
                                            datarecord = datarecord[splitMap[p]];
                                        }
                                        value = datarecord;
                                    }
                                    else {
                                        value = record[datafield.map];
                                    }
                                }

                                if (value != undefined && value != null) {
                                    value = value.toString();
                                }
                                else {
                                    if (value == undefined && value != null) {
                                        value = '';
                                    }
                                }
                            }
                            // searches by both selectors when necessary.
                            if (value == '') {
                                value = record[datafield.name];
                                if (value != undefined && value != null) {
                                    if (source._localdata && value.subscribe) {
                                        value = value();
                                    }
                                    else {
                                        value = value.toString();
                                    }
                                }
                            }

                            value = me.getvaluebytype(value, datafield);
                            if (datafield.displayname != undefined) {
                                datarow[datafield.displayname] = value;
                            }
                            else {
                                datarow[datafield.name] = value;
                            }
                        }
                        return datarow;
                    }

                    if (source._localdata) {
                        this._changedrecords = [];
                        this.records = new Array();
                        var localdata = source._localdata();

                        $.each(localdata, function (i, value) {
                            if (typeof value === 'string') {
                                me.records.push(value);
                            }
                            else {
                                var record = {};
                                var _koindex = 0;
                                var dataObject = this;
                                $.each(this, function(obj, objvalue) {
                                    var map = null;
                                    var type = 'string';
                                    if (datafieldslength > 0) {
                                        var hasField = false;
                                        for (var j = 0; j < datafieldslength; j++) {
                                            var datafield = source.datafields[j];
                                            if (datafield != undefined && datafield.name == obj) {
                                                hasField = true;
                                                map = datafield.map;
                                                type = datafield.type;
                                                break;
                                            }
                                        }
                                        if (!hasField) return true;
                                    }

                                    var isFunction = $.isFunction(dataObject[obj]);
                                    if (isFunction) {
                                        var value = dataObject[obj]();
                                        if (type != 'string') {
                                            value = me.getvaluebytype(value, { type: type });
                                        }
                                        record[obj] = value;
                                        if (dataObject[obj].subscribe) {
                                            var recordindex = i;
                                            me.koSubscriptions[me.koSubscriptions.length] = dataObject[obj].subscribe(function (value) {
                                                var _changeindex = recordindex;
                                                record[obj] = value;
                                                var changedRecord = { index: _changeindex, oldrecord: record, record: record };
                                                me._changedrecords.push(changedRecord);
                                                if (me.isUpdating)
                                                    return;

                                                me.callBindingUpdate("update");
                                                me._changedrecords = [];
                                                return false;
                                            });
                                        }
                                    }
                                    else {
                                        var value = dataObject[obj];
                                        if (map != null) {
                                            var splitMap = map.split(me.mapChar);
                                            if (splitMap.length > 0) {
                                                var datarecord = dataObject;
                                                for (var p = 0; p < splitMap.length; p++) {
                                                    datarecord = datarecord[splitMap[p]];
                                                }
                                                value = datarecord;
                                            }
                                            else {
                                                value = dataObject[map];
                                            }
                                        }

                                        if (type != 'string') {
                                            value = me.getvaluebytype(value, { type: type });
                                        }
                                        record[obj] = value;
                                        if (record[obj] != undefined) {
                                            _koindex += record[obj].toString().length + record[obj].toString().substr(0, 1);
                                        }
                                    }
                                });

                                var recordid = me.getid(source.id, dataObject, i);
                                record.uid = recordid;
                                me.records.push(record);
                    
                                record._koindex = _koindex;
                                if (me._oldrecords) {
                                    var _changeindex = me.records.length - 1;
                                    if (collectionChanged == 'update') {
                                        if (me._oldrecords[_changeindex]._koindex != _koindex) {
                                            var changedRecord = { index: _changeindex, oldrecord: me._oldrecords[_changeindex], record: record };
                                            me._changedrecords.push(changedRecord);
                                        }
                                    }
                                }
                            }
                        });
                        if (collectionChanged == 'add') {
                            var length = me.records.length;
                            for (var i = 0; i < length; i++) {
                                var record = me.records[i];
                                var hasOldRecord = false;
                                for (var p = 0; p < me._oldrecords.length; p++) {
                                    if (me._oldrecords[p]._koindex === record._koindex) {
                                        hasOldRecord = true;
                                        break;
                                    }
                                }
                                if (!hasOldRecord) {
                                    me._changedrecords.push({ index: i, oldrecord: null, record: record, position: (i != 0 ? "last" : "first") });
                                }
                            }
                        }
                        else if (collectionChanged == 'remove') {
                            var length = me._oldrecords.length;
                            for (var i = 0; i < length; i++) {
                                var oldrecord = me._oldrecords[i];
                                if (!me.records[i]) {
                                    me._changedrecords.push({ index: i, oldrecord: oldrecord, record: null });
                                }
                                else {
                                    if (me.records[i]._koindex != oldrecord._koindex) {
                                        me._changedrecords.push({ index: i, oldrecord: oldrecord, record: null });
                                    }
                                }
                            }
                        }
                    }
                    else {
                        if (!$.isArray(source.localdata)) {
                            this.records = new Array();
                            $.each(source.localdata, function (i) {
                                var recordid = me.getid(source.id, this, i);

                                if (datafieldslength > 0) {
                                    var record = this;
                                    var datarow = getrecord(record, datafieldslength);
                                    datarow.uid = recordid;
                                    me.records[me.records.length] = datarow;                                  
                                }
                                else {
                                    this.uid = recordid;
                                    me.records[me.records.length] = this;
                                }
                            });
                        }
                        else {
                            if (datafieldslength == 0) {
                                $.each(source.localdata, function (i, value) {
                                    var record = $.extend({}, this);
                                    if (typeof value === "string") {
                                        me.records = source.localdata;
                                        return false;
                                    }
                                    else {
                                        var recordid = me.getid(source.id, record, i);
                                        if (typeof (recordid) === "object") {
                                            recordid = i;
                                        }
                                        record.uid = recordid;
                                        me.records[me.records.length] = record;
                                    }
                                });
                            }
                            else {
                                $.each(source.localdata, function (i) {
                                    var record = this;
                                    var datarow = getrecord(record, datafieldslength);
                                    var recordid = me.getid(source.id, datarow, i);
                                    if (typeof (recordid) === "object") {
                                        recordid = i;
                                    }
                                    var record = $.extend({}, datarow);
                                    record.uid = recordid;
                                    me.records[me.records.length] = record;
                                });
                            }
                        }
                    }

                    this.originaldata = source.localdata;
                    this.cachedrecords = this.records;
                    this.addForeignValues(source);
                    if (options.uniqueDataFields) {
                        var uniquerecords = this.getUniqueRecords(this.records, options.uniqueDataFields);
                        this.records = uniquerecords;
                        this.cachedrecords = uniquerecords;
                    }

                    if (options.beforeLoadComplete) {
                        var newRecords = options.beforeLoadComplete(me.records, this.originaldata);
                        if (newRecords != undefined) {
                            me.records = newRecords;
                            me.cachedrecords = newRecords;
                        }
                    }

                    if (options.autoSort && options.autoSortField) {
                        var tmpToString = Object.prototype.toString;
                        Object.prototype.toString = (typeof field == "function") ? field : function () { return this[options.autoSortField] };
                        me.records.sort(function (value1, value2) {
                            if (value1 === undefined) { value1 = null; }
                            if (value2 === undefined) { value2 = null; }
                            if (value1 === null && value2 === null) {
                                return 0;
                            }
                            if (value1 === null && value2 !== null) {
                                return 1;
                            }
                            if (value1 !== null && value2 === null) {
                                return -1;
                            }

                            value1 = value1.toString();
                            value2 = value2.toString();

                            if ($.jqx.dataFormat.isNumber(value1) && $.jqx.dataFormat.isNumber(value2)) {
                                if (value1 < value2) { return -1; }
                                if (value1 > value2) { return 1; }
                                return 0;
                            }
                            else if ($.jqx.dataFormat.isDate(value1) && $.jqx.dataFormat.isDate(value2)) {
                                if (value1 < value2) { return -1; }
                                if (value1 > value2) { return 1; }
                                return 0;
                            }
                            else if (!$.jqx.dataFormat.isNumber(value1) && !$.jqx.dataFormat.isNumber(value2)) {
                                value1 = String(value1).toLowerCase();
                                value2 = String(value2).toLowerCase();
                            }

                            try {
                                if (value1 < value2) { return -1; }
                                if (value1 > value2) { return 1; }
                            }
                            catch (error) {
                                var er = error;
                            }

                            return 0;
                        });
                        Object.prototype.toString = tmpToString;
                    }

                    me.loadedData = source.localdata;
                    me.buildHierarchy();

                    if ($.isFunction(options.loadComplete)) {
                        options.loadComplete(source.localdata);
                    }
                    break;
                case "json":
                case "jsonp":
                case "xml":
                case "xhtml":
                case "script":
                case "text":
                    {
                        if (source.localdata != null) {
                            if ($.isFunction(source.beforeprocessing)) {
                                source.beforeprocessing(source.localdata);
                            }
                            if (source.datatype === "xml") {
                                me.loadxml(source.localdata, source.localdata, source);
                            }
                            else if (datatype === "text") {
                                me.loadtext(source.localdata, source);
                            }
                            else {
                                me.loadjson(source.localdata, source.localdata, source);
                            }
                            me.addForeignValues(source);
                            if (options.uniqueDataFields) {
                                var uniquerecords = me.getUniqueRecords(me.records, options.uniqueDataFields);
                                me.records = uniquerecords;
                                me.cachedrecords = uniquerecords;
                            }

                            if (options.beforeLoadComplete) {
                                var newRecords = options.beforeLoadComplete(me.records, this.originaldata);
                                if (newRecords != undefined) {
                                    me.records = newRecords;
                                    me.cachedrecords = newRecords;
                                }
                            }

                            me.loadedData = source.localdata;
                            me.buildHierarchy.call(me);
                            if ($.isFunction(options.loadComplete)) {
                                options.loadComplete(source.localdata);
                            }
                           return;
                        }

                        var postdata = options.data != undefined ? options.data : {};
                        // call the source object's processdata function.
                        if (source.processdata) {
                            source.processdata(postdata);
                        }
                        // call the adapter's process data function.
                        if ($.isFunction(options.processData)) {
                            options.processData(postdata);
                        }

                        // call the adapter's format data function.
                        if ($.isFunction(options.formatData)) {
                            var newpostdata = options.formatData(postdata);
                            if (newpostdata != undefined) {
                                postdata = newpostdata;
                            }
                        }

                        var contentType = 'application/x-www-form-urlencoded';
                        if (options.contentType) {
                            contentType = options.contentType;
                        }

                        var type = "GET";
                        if (source.type) {
                            type = source.type;
                        }

                        if (options.type) {
                            type = options.type;
                        }

                        if (source.url && source.url.length > 0) {
                            if ($.isFunction(options.loadServerData)) {
                                me._requestData(postdata, source, options);
                            }
                            else {
                                this.xhr = $.jqx.data.ajax({
                                    dataType: datatype,
                                    cache: this.cache,
                                    type: type,
                                    url: source.url,
                                    async: async,
                                    contentType: contentType,
                                    data: postdata,
                                    success: function (data, status, xhr) {
                                        if ($.isFunction(source.beforeprocessing)) {
                                            var tmpdata = source.beforeprocessing(data, status, xhr);
                                            if (tmpdata != undefined) {
                                                data = tmpdata;
                                            }
                                        }
                                        if ($.isFunction(options.downloadComplete)) {
                                            var tmpdata = options.downloadComplete(data, status, xhr);
                                            if (tmpdata != undefined) {
                                                data = tmpdata;
                                            }
                                        }

                                        if (data == null) {
                                            me.records = new Array();
                                            me.cachedrecords = new Array();
                                            me.originaldata = new Array();

                                            me.callDownloadComplete();
                                            if ($.isFunction(options.loadComplete)) {
                                                options.loadComplete(new Array());
                                            }
                                            return;
                                        }

                                        var records = data;
                                        if (data.records) {
                                            records = data.records;
                                        }

                                        if (data.totalrecords != undefined) {
                                            source.totalrecords = data.totalrecords;
                                        }

                                        if (source.datatype === "xml") {
                                            me.loadxml(null, records, source);
                                        }
                                        else if (datatype === "text") {
                                            me.loadtext(records, source);
                                        }
                                        else {
                                            me.loadjson(null, records, source);
                                        }

                                        // add foreign values.
                                        me.addForeignValues(source);

                                        if (options.uniqueDataFields) {
                                            var uniquerecords = me.getUniqueRecords(me.records, options.uniqueDataFields);
                                            me.records = uniquerecords;
                                            me.cachedrecords = uniquerecords;
                                        }

                                        if (options.beforeLoadComplete) {
                                            var newRecords = options.beforeLoadComplete(me.records, data);
                                            if (newRecords != undefined) {
                                                me.records = newRecords;
                                                me.cachedrecords = newRecords;
                                            }
                                        }

                                        me.loadedData = data;
                                        me.buildHierarchy.call(me);

                                        me.callDownloadComplete();
                                        if ($.isFunction(options.loadComplete)) {
                                            options.loadComplete(data, status, xhr, me.records);
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                        if ($.isFunction(source.loaderror)) { source.loaderror(xhr, status, error); }
                                        if ($.isFunction(options.loadError)) { options.loadError(xhr, status, error); }
                                        xhr = null;
                                        me.callDownloadComplete();
                                    },
                                    beforeSend: function (xhr, settings) {
                                        if ($.isFunction(options.beforeSend)) { options.beforeSend(xhr, settings); }
                                        if ($.isFunction(source.beforesend)) { source.beforesend(xhr, settings); }
                                    }
                                });
                            }
                        }
                        else {
                            me.callDownloadComplete();
                            if ($.isFunction(options.loadComplete)) {
                                options.loadComplete(data);
                            }
                        }
                    }
                    break;
            }
            this.callBindingUpdate(collectionChanged);
        },

        buildHierarchy: function()
        {
            var source = this._source;
            var hierarchy = new Array();
            if (!source.datafields) {
                return;
            }

            if (!source.hierarchy) {
                return;
            }

            var that = this;

            if (source.hierarchy.root) {
                var hierarchy = this.getRecordsHierarchy('uid', 'parentuid', 'records');
                this.hierarchy = hierarchy;
                return hierarchy;
                return;
            }

            if (source.hierarchy.keyDataField && source.hierarchy.parentDataField) {
                var hierarchy = this.getRecordsHierarchy(source.hierarchy.keyDataField.name, source.hierarchy.parentDataField.name, 'records');
                this.hierarchy = hierarchy;
                return hierarchy;
            }
            if (source.hierarchy.groupingDataFields) {
                var groups = new Array();
                for (var i = 0; i < source.hierarchy.groupingDataFields.length; i++) {
                    groups.push(source.hierarchy.groupingDataFields[i].name);
                }

                var hierarchy = this.getGroupedRecords(groups, 'records', 'label', null, 'data', null, 'parent');
                this.hierarchy = hierarchy;
                return hierarchy;
            }

            var hasArray = false;
            var arrayDataField = "";
            for (var i = 0; i < source.datafields.length; i++) {
                var datafield = source.datafields[i];
                if (datafield && datafield.type == "array") {
                    arrayDataField = datafield;
                    hasArray = true;
                }
            }

            if (hasArray) {
                if (!source.hierarchicalDataFields || source.hierarchicalDataFields.length == 0) {
                    throw new Error("jqxDataAdapter: hierarchicalDataFields Array is not initialized!");
                }

                this.hierarchy = this.records;
                for (var i = 0; i < this.records.length; i++) {
                    var record = this.records[i];
                    record.records = record[arrayDataField.name];
                    record.level = 0;
                    var recordid = this.getid(source.id, record, i);
                    record.uid = recordid;
                    record.parent = null;
                    record.label = record[source.hierarchicalDataFields[0].name];
                    record.data = record;
                    if (record.expanded === undefined) {
                        record.expanded = false;
                    }
                    var drillThrough = function (parent, records) {
                        if (!records) {
                            parent.records = new Array();
                            return;
                        }

                        for (var i = 0; i < records.length; i++) {
                            var record = records[i];
                            record.records = record[arrayDataField.name];
                            record.level = parent.level+1;
                            record.parent = parent;
                            record.label = record[source.hierarchicalDataFields[0].name];
                            record.data = record;
                            var recordid = that.getid(source.id, record, i);
                            if (recordid == i) {
                                record.uid = parent.uid + "." + recordid;
                            }

                            if (record.expanded === undefined) {
                                record.expanded = false;
                            }
                            drillThrough(record, record.records);
                        }
                    }
                    drillThrough(record, record.records);
                }
                return;
            }
            if (source.hierarchicalDataFields) {
            }

            this.hierarchy = hierarchy;
            return hierarchy;
        },

        addRecord: function (record, position, parentID) {
            if (record != undefined) {
                if (parentID != undefined) {
                    if (this.hierarchy.length > 0) {
                        var traverse = function (records) {
                            if (records) {
                                for (var i = 0; i < records.length; i++) {
                                    var r = records[i];
                                    if (r.uid == parendID) {
                                        if (position == 'last') {
                                            records.push(record);
                                        }
                                        else if (typeof position === 'number' && isFinite(position)) {
                                            records.splice(position, 0, record);
                                        }
                                        else {
                                            records.splice(0, 0, record);
                                        }
                                        return true;
                                    }
                                    if (r.records) {
                                        traverse(r.records);
                                    }
                                }
                            }
                        }
                        traverse(this.hierarchy);
                    }
                }
                else {
                    if (position == 'last') {
                        this.records.push(record);
                    }
                    else if (typeof position === 'number' && isFinite(position)) {
                        this.records.splice(position, 0, record);
                    }
                    else {
                        this.records.splice(0, 0, record);
                    }
                    return true;
                }
            }
            return false;
        },

        deleteRecord: function(uid)
        {
            if (this.hierarchy.length > 0) {
                var traverse = function (records) {
                    if (records) {
                        for (var i = 0; i < records.length; i++) {
                            var r = records[i];
                            if (r.uid == uid) {
                                records.splice(i, 1);
                                return true;
                            }
                            if (r.records) {
                                traverse(r.records);
                            }
                        }
                    }
                }
                traverse(this.hierarchy);
            }
            else {
                for (var i = 0; i < this.records.length; i++) {
                    var r = this.records[i];
                    if (r.uid == uid) {
                        this.records.splice(i, 1);
                        return true;
                    }
                }
            }
            return false;
        },

        addForeignValues: function(source)
        {
            var me = this;
            var datafieldslength = source.datafields ? source.datafields.length : 0;
            for (var j = 0; j < datafieldslength; j++) {
                var datafield = source.datafields[j];
                if (datafield != undefined) {
                    if (datafield.values != undefined) {
                        if (datafield.value == undefined) datafield.value = datafield.name;
                        if (datafield.values['value'] == undefined) {
                            datafield.values['value'] = datafield.value;
                        }

                        var matchedIDs = new Array();
                        var start, end;
                        if (me.pageable && me.virtualmode) {
                            start = me.pagenum * me.pagesize;
                            end = start + me.pagesize;
                            if (end > me.totalrecords) {
                                end = me.totalrecords;
                            }
                        } else {
                            start = 0;
                            end = me.records.length;
                        }

                        for (var i = start; i < end; i++) {
                            var record = me.records[i];
                            var name = datafield.name;
                            var value = record[datafield.value];

                            if (matchedIDs[value] != undefined) {
                                record[name] = matchedIDs[value];
                            }
                            else {
                                for (var p = 0; p < datafield['values'].source.length; p++) {
                                    var sourcerecord = datafield.values.source[p];
                                    var sourcevalue = sourcerecord[datafield.values['value']];
                                    if (sourcevalue == undefined) {
                                        sourcevalue = sourcerecord.uid;
                                    }
                                    if (sourcevalue == value) {
                                        var label = sourcerecord[datafield.values['name']];
                                        record[name] = label;
                                        matchedIDs[value] = label;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                    else if (datafield.value != undefined) {
                        for (var i = 0; i < me.records.length; i++) {
                            var record = me.records[i];
                            record[datafield.name] = record[datafield.value];
                        }
                    }
                }
            }
        },

        abort: function () {
            if (this.xhr && this.xhr.readyState != 4) {
                this.xhr.abort();
                me.callDownloadComplete();
            }
        },

        _requestData: function (postdata, source, options) {
            var me = this;
            var success = function (requestedData) {
                if (requestedData.totalrecords) {
                    source.totalrecords = requestedData.totalrecords;
                    me.totalrecords = requestedData.totalrecords;
                }
                if (requestedData.records) {
                    me.records = requestedData.records;
                    me.cachedrecords = requestedData.records;
                }
                if ($.isFunction(options.loadComplete)) {
                    options.loadComplete(data);
                }
                me.callDownloadComplete();
            }
            options.loadServerData(postdata, source, success);
        },

        getUniqueRecords: function (records, dataFields) {
            if (records && dataFields) {
                var length = records.length;
                var datafieldslength = dataFields.length;

                var uniqueRecords = new Array();
                var lookupkeys = new Array();
                // loop through all records.
                for (var urec = 0; urec < length; urec++) {
                    var datarow = records[urec];
                    var lookupkey = "";
                    if (datarow == undefined)
                        continue;
                    // build lookup key from the datafield values.
                    for (var datafieldindex = 0; datafieldindex < datafieldslength; datafieldindex++) {
                        var datafield = dataFields[datafieldindex];
                        lookupkey += datarow[datafield] + "_";
                    }
                    // add the unique record.
                    if (!lookupkeys[lookupkey]) {
                        uniqueRecords[uniqueRecords.length] = datarow;
                    }
                    // add the lookup key.
                    lookupkeys[lookupkey] = true;
                }
            }

            return uniqueRecords;
        },

        getAggregatedData: function (aggregates, calendar, records) {
            var dataRecords = records;
            if (!dataRecords) {
                dataRecords = this.records;
            }
            var data = {};
            var dataValuesByAggregate = new Array();
            var length = dataRecords.length;
            if (length == 0) return;
            if (length == undefined) return;
            for (var i = 0; i < length; i++) {
                var record = dataRecords[i];
                for (var j = 0; j < aggregates.length; j++) {
                    var aggregate = aggregates[j];
                    var value = record[aggregate.name];
                    if (value === null) continue;
                    if (aggregate.aggregates) {
                        data[aggregate.name] = data[aggregate.name] || {};
                        dataValuesByAggregate[aggregate.name] = dataValuesByAggregate[aggregate.name] || 0;
                        dataValuesByAggregate[aggregate.name]++;
                        var _customCalcFunc = function (aggObject) {
                            for (obj in aggObject) {
                                var oldValue = data[aggregate.name][obj];
                                if (oldValue == null) {
                                    data[aggregate.name][obj] = 0;
                                    oldValue = 0;
                                }
                                if ($.isFunction(aggObject[obj])) {
                                    oldValue = aggObject[obj](oldValue, value, aggregate.name, record);
                                }
                                data[aggregate.name][obj] = oldValue;
                            }
                        }

                        var canParse = parseFloat(value);
                        if (isNaN(canParse)) canParse = false; else canParse = true;
                        if (canParse)
                            value = parseFloat(value);

                        if (typeof value === 'number' && isFinite(value)) {
                            $.each(aggregate.aggregates, function () {
                                var oldValue = data[aggregate.name][this];
                                if (oldValue == null) {
                                    oldValue = 0;
                                    if (this == 'min') oldValue = 9999999999999;
                                    if (this == 'max') oldValue = -9999999999999;
                                }
                                if (this == 'sum' || this == 'avg' || this == 'stdev'
                                || this == 'stdevp' || this == 'var' || this == 'varp') {
                                    oldValue += parseFloat(value);
                                }
                                else if (this == 'product') {
                                    if (i == 0)
                                        oldValue = parseFloat(value);
                                    else
                                        oldValue *= parseFloat(value);
                                }
                                else if (this == 'min') {
                                    oldValue = Math.min(oldValue, parseFloat(value));
                                }
                                else if (this == 'max') {
                                    oldValue = Math.max(oldValue, parseFloat(value));
                                }
                                else if (this == 'count') {
                                    oldValue++;
                                }
                                else if (typeof (this) == 'object') {
                                    _customCalcFunc(this);
                                    return;
                                }
                                data[aggregate.name][this] = oldValue;
                            });
                        }
                        else {
                            $.each(aggregate.aggregates, function () {
                                if (this == 'min' || this == 'max' || this == 'count' || this == 'product' || this == 'sum'
                                 || this == 'avg' || this == 'stdev'
                                || this == 'stdevp' || this == 'var' || this == 'varp') {
                                    var oldValue = data[aggregate.name][this];
                                    if (oldValue == null) {
                                        oldValue = 0;
                                    }
                                    data[aggregate.name][this] = oldValue;
                                    return true;
                                }

                                if (typeof (this) == 'object') {
                                    _customCalcFunc(this);
                                }
                            });
                        }
                    }
                }
            }

            for (var j = 0; j < aggregates.length; j++) {
                var aggregate = aggregates[j];
                if (data[aggregate.name]['avg'] != undefined) {
                    var value = data[aggregate.name]['avg'];
                    var dataValues = dataValuesByAggregate[aggregate.name];
                    if (dataValues === 0) {
                        data[aggregate.name]['avg'] = 0;
                    }
                    else {
                        data[aggregate.name]['avg'] = value / dataValues;
                    }
                }
                else if (data[aggregate.name]['count'] != undefined) {
                    data[aggregate.name]['count'] = length;
                }

                // stdev, stdevp, var, varp.
                // stdev - Standard deviation on a sample.
                // varp - Variance on an entire population.
                // var - Variance on a sample.
                if (data[aggregate.name]['stdev'] || data[aggregate.name]['stdevp']
                || data[aggregate.name]['var'] || data[aggregate.name]['varp']) {
                    $.each(aggregate.aggregates, function (index) {
                        if (this == 'stdev' || this == 'var' || this == 'varp' || this == 'stdevp') {
                            var value = data[aggregate.name][this];
                            var count = length;
                            var average = (value / length);
                            var sumSq = 0.0;
                            for (var i = 0; i < length; i++) {
                                var record = dataRecords[i];
                                var recordvalue = record[aggregate.name];
                                sumSq += (recordvalue - average) * (recordvalue - average);
                            }

                            var denominator = (this == 'stdevp' || this == 'varp') ? count : count - 1;
                            if (denominator == 0)
                                denominator = 1;

                            if (this == 'var' || this == 'varp') {
                                data[aggregate.name][this] = sumSq / denominator;
                            }
                            else if (this == 'stdevp' || this == 'stdev') {
                                data[aggregate.name][this] = Math.sqrt(sumSq / denominator);
                            }
                        }
                    });
                }

                if (aggregate.formatStrings) {
                    $.each(aggregate.aggregates, function (index) {
                        var formatString = aggregate.formatStrings[index];
                        if (formatString) {
                            if (this == 'min' || this == 'max' || this == 'count' || this == 'product' || this == 'sum'
                                 || this == 'avg' || this == 'stdev'
                                || this == 'stdevp' || this == 'var' || this == 'varp') {
                                var value = data[aggregate.name][this];
                                data[aggregate.name][this] = $.jqx.dataFormat.formatnumber(value, formatString, calendar);
                            }
                            else if (typeof this == 'object') {
                                for (obj in this) {
                                    var value = data[aggregate.name][obj];
                                    data[aggregate.name][obj] = $.jqx.dataFormat.formatnumber(value, formatString, calendar);
                                }
                            }
                        }
                    });
                }
            }
            return data;
        },

        bindDownloadComplete: function (id, func) {
            this._downloadComplete[this._downloadComplete.length] = { id: id, func: func };

        },

        unbindDownloadComplete: function (id) {
            for (var i = 0; i < this._downloadComplete.length; i++) {
                if (this._downloadComplete[i].id == id) {
                    this._downloadComplete[i].func = null;
                    this._downloadComplete.splice(i, 1);
                    break;
                }
            }
        },

        callDownloadComplete: function () {
            for (var complete = 0; complete < this._downloadComplete.length; complete++) {
                var downloadComplete = this._downloadComplete[complete];
                if (downloadComplete.func != null) {
                    downloadComplete.func();
                }
            }
        },

        setSource: function (source) {
            this._source = source;
        },

        generatekey: function () {
            var S4 = function () {
                return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
            };
            return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
        },

        getGroupedRecords: function (groups, collectionName, groupName, mappingFields, recordName, valueName, parentName, data) {
            var visualRows = 0;
            var self = this;
            var groupHashCodes = new Array();
            for (var iGroupColumn = 0; iGroupColumn < groups.length; iGroupColumn++) {
                groupHashCodes[iGroupColumn] = self.generatekey();
            }

            if (!collectionName) {
                collectionName = 'items';
            }

            if (!groupName) {
                groupName = 'group';
            }

            if (!recordName) {
                recordName = 'record';
            }

            if (!parentName) {
                parentName = 'parentItem';
            }

            if (undefined === valueName) {
                valueName = 'value';
            }

            var grouprecords = new Array();
            var grouprecordsindex = 0;
            var hashRowGroups = new Array();
            var groupslength = groups.length;
            var groupsHierarchy = new Array();
            if (!data) {
                var data = this.records;
            }

            var dataLength = data.length;

            var itemByRecord = function (record) {
                var itemObj = record;
                if (mappingFields) {
                    $.each(mappingFields, function () {
                        if (this.name && this.map) {
                            itemObj[this.map] = itemObj[this.name];
                        }
                    });
                }

                return itemObj;
            }

            for (var obj = 0; obj < dataLength; obj++) {
                var item = itemByRecord(data[obj]);
                id = item[self.uniqueId];
                var itemKeysHierarchy = new Array();
                var keys = 0;
                for (iGroupColumn = 0; iGroupColumn < groupslength; iGroupColumn++) {
                    var group = groups[iGroupColumn];
                    var value = item[group];

                    if (null == value)
                        continue;

                    itemKeysHierarchy[keys++] = { value: value, hash: groupHashCodes[iGroupColumn] };
                }

                if (itemKeysHierarchy.length != groupslength)
                    break;

                var parentItem = null;

                var lookupKey = "";
                var iLevel = -1;
                for (var q = 0; q < itemKeysHierarchy.length; q++) {
                    iLevel++;
                    var itemKey = itemKeysHierarchy[q].value;
                    var columnHash = itemKeysHierarchy[q].hash;
                    lookupKey = lookupKey + "_" + columnHash + "_" + itemKey;
                    if (hashRowGroups[lookupKey] != undefined && hashRowGroups[lookupKey] != null) {
                        parentItem = hashRowGroups[lookupKey];
                        continue;
                    }
                    if (parentItem == null) {
                        parentItem = { level: 0 };
                        parentItem[parentName] = null;
                        parentItem[groupName] = itemKey;
                        parentItem[recordName] = item;
                        if (item.expanded !== undefined) {
                            parentItem.expanded = item.expanded;
                        }
                        else
                        {
                            parentItem.expanded = false;
                        }

                        if (valueName) {
                            parentItem[valueName] = item[valueName];
                        }
                        parentItem[collectionName] = new Array();
                        parentItem.uid = this.generatekey();
                        grouprecords[grouprecordsindex++] = parentItem;
                    }
                    else {
                        var subItem = { level: parentItem.level + 1 };
                        subItem[parentName] = parentItem;
                        subItem[groupName] = itemKey;
                        subItem[collectionName] = new Array();
                        subItem[recordName] = item;
                        if (item.expanded !== undefined) {
                            subItem.expanded = item.expanded;
                        }
                        else {
                            subItem.expanded = false;
                        }

                        if (valueName) {
                            subItem[valueName] = item[valueName];
                        }
                        subItem.uid = this.generatekey();
                        parentItem[collectionName][parentItem[collectionName].length] = subItem;
                        parentItem = subItem;
                    }

                    hashRowGroups[lookupKey] = parentItem;
                }

                if (parentItem != null) {
                    if (!item.uid) {
                        item.uid = this.generatekey();
                    }
                    item.parentItem = parentItem;
                    item.level = parentItem.level + 1;
                    parentItem[collectionName][parentItem[collectionName].length] = item;
                }
                else {
                    if (!item.uid) {
                        item.uid = this.generatekey();
                    }
                }
            }
            return grouprecords;
        },

        getRecordsHierarchy: function (fieldName, parentFieldName, collectionName, mappingFields) {
            var recordsHierarchy = new Array();
            var flatData = this.records;
            if (this.records.length == 0)
                return null;

            var subItemsName = collectionName != null ? collectionName : "items";
            var items = [];
            var data = flatData;
            var dataLength = data.length;

            var itemByRecord = function (record) {
                var itemObj = record;
                if (mappingFields) {
                    $.each(mappingFields, function () {
                        if (this.name && this.map) {
                            itemObj[this.map] = itemObj[this.name];
                        }
                    });
                }

                return itemObj;
            }

            // build hierarchical source.
            for (var i = 0; i < dataLength; i++) {
                var item = $.extend({}, data[i]);
                var parentid = item[parentFieldName];
                var id = item[fieldName];
                items[id] = { parentid: parentid, item: item };
            }

            for (var i = 0; i < dataLength; i++) {
                var item = $.extend({}, data[i]);
                var parentid = item[parentFieldName];
                var id = item[fieldName];

                if (items[parentid] != undefined) {
                    var item = { parentid: parentid, item: items[id].item };
                    var parentItem = items[parentid].item;
                    if (!parentItem[subItemsName]) {
                        parentItem[subItemsName] = [];
                    }
                    var length = parentItem[subItemsName].length;
                    var record = item.item;
                    var itemObj = itemByRecord(record);
                    parentItem[subItemsName][length] = itemObj;
                    items[parentid].item = parentItem;
                    items[id] = item;
                }
                else {
                    var record = items[id].item;
                    var itemObj = itemByRecord(record);
                    itemObj.level = 0;
                    recordsHierarchy[recordsHierarchy.length] = itemObj;
                }
            }
            if (recordsHierarchy.length != 0) {
                var updateLevels = function (level, records) {
                    for (var i = 0; i < records.length; i++) {
                        records[i].level = level;
                        var subRecords = records[i][subItemsName];
                        if (subRecords) {
                            if (subRecords.length > 0) {
                                updateLevels(level + 1, subRecords);
                            }
                            else {
                                records[i].leaf = true;
                            }
                        }
                        else {
                            records[i].leaf = true;
                        }
                    }
                };
                updateLevels(0, recordsHierarchy);
            }
            return recordsHierarchy;
        },

        bindBindingUpdate: function (id, func) {
            this._bindingUpdate[this._bindingUpdate.length] = { id: id, func: func };

        },

        unbindBindingUpdate: function (id) {
            for (var i = 0; i < this._bindingUpdate.length; i++) {
                if (this._bindingUpdate[i].id == id) {
                    this._bindingUpdate[i].func = null;
                    this._bindingUpdate.splice(i, 1);
                    break;
                }
            }
        },

        callBindingUpdate: function (collectionChanged) {
            for (var update = 0; update < this._bindingUpdate.length; update++) {
                var bindingUpdate = this._bindingUpdate[update];
                if (bindingUpdate.func != null) {
                    bindingUpdate.func(collectionChanged);
                }
            }
        },

        getid: function (id, record, index) {
            if ($(id, record).length > 0) {
                return $(id, record).text();
            }

            if (id) {
                if (id.toString().length > 0) {
                    var result = $(record).attr(id);
                    if (result != null && result.toString().length > 0) {
                        return result;
                    }
                }
            }

            return index;
        },

        loadjson: function (jsondata, data, source) {
            if (typeof (jsondata) == 'string') {
                jsondata = $.parseJSON(jsondata);
            }

            if (source.root == undefined) source.root = '';
            if (source.record == undefined) source.record = '';

            var jsondata = jsondata || data;
            if (!jsondata) {
                jsondata = [];
            }

            var me = this;
            if (source.root != '') {
                var splitMap = source.root.split(me.mapChar);
                if (splitMap.length > 1) {
                    var d = jsondata;
                    for (var p = 0; p < splitMap.length; p++) {
                        if (d != undefined) {
                            d = d[splitMap[p]];
                        }
                    }
                    jsondata = d;
                }
                else {
                    if (jsondata[source.root] != undefined) {
                        jsondata = jsondata[source.root];
                    }
                    else {
                        $.each(jsondata, function (i) {
                            var root = this;
                            if (this == source.root) {
                                jsondata = this;
                                return false;
                            }
                            else if (this[source.root] != undefined) {
                                jsondata = this[source.root];
                            }
                        });
                    }

                    if (!jsondata) {
                        var splitMap = source.root.split(me.mapChar);
                        if (splitMap.length > 0) {
                            var d = jsondata;
                            for (var p = 0; p < splitMap.length; p++) {
                                if (d != undefined) {
                                    d = d[splitMap[p]];
                                }
                            }
                            jsondata = d;
                        }
                    }
                }
            }
            else {
                if (!jsondata.length) {
                    for (obj in jsondata) {
                        if ($.isArray(jsondata[obj])) {
                            jsondata = jsondata[obj];
                            break;
                        }
                    }
                }
            }

            if (jsondata != null && jsondata.length == undefined) {
                jsondata = $.makeArray(jsondata);
            }

            if (jsondata == null || jsondata.length == undefined) {
                alert('JSON Parse error.');
                return;
            }

            if (jsondata.length == 0) {
                this.totalrecords = 0;
                return;
            }

            var length = jsondata.length;
            this.totalrecords = this.virtualmode ? (source.totalrecords || length) : length;
            this.records = new Array();
            this.originaldata = new Array();

            var records = this.records;
            var recordsstartindex = !this.pageable ? source.recordstartindex : this.pagesize * this.pagenum;

            this.recordids = new Array();

            if (source.loadallrecords) {
                recordsstartindex = 0;
                length = this.totalrecords;
            }

            var dataoffset = 0;
            if (this.virtualmode) {
                recordsstartindex = !this.pageable ? source.recordstartindex : this.pagesize * this.pagenum;
                dataoffset = recordsstartindex;
                recordsstartindex = 0;
                length = this.totalrecords;
            }

            var datafieldslength = source.datafields ? source.datafields.length : 0;
            // auto-generate data columns
            if (datafieldslength == 0) {
                var firstrecord = jsondata[0];
                var datafields = new Array();
                for (obj in firstrecord) {
                    var field = obj;
                    datafields[datafields.length] = { name: field };
                }
                source.datafields = datafields;
                datafieldslength = datafields.length;
            }

            var index = recordsstartindex;
            for (var i = recordsstartindex; i < length; i++) {
                var record = jsondata[i];

                if (record == undefined)
                    break;

                if (source.record && source.record != '') {
                    record = record[source.record];
                    if (record == undefined)
                        continue;
                }

                var recordid = this.getid(source.id, record, i);
                if (typeof (recordid) === "object") {
                    recordid = i;
                }

                if (!this.recordids[recordid]) {
                    this.recordids[recordid] = record;
                    var datarow = {};

                    for (var j = 0; j < datafieldslength; j++) {
                        var datafield = source.datafields[j];
                        var value = '';
                        if (undefined == datafield || datafield == null) {
                            continue;
                        }

                        if (datafield.map) {
                            if ($.isFunction(datafield.map)) {
                                value = datafield.map(record);
                            }
                            else {
                                var splitMap = datafield.map.split(me.mapChar);
                                if (splitMap.length > 0) {
                                    var datarecord = record;
                                    for (var p = 0; p < splitMap.length; p++) {
                                        if (datarecord != undefined) {
                                            datarecord = datarecord[splitMap[p]];
                                        }
                                    }
                                    value = datarecord;
                                }
                                else {
                                    value = record[datafield.map];
                                }
                            }

                            if (value != undefined && value != null) {
                                value = value.toString();
                            }
                            else if (value == undefined && value != null) {
                                value = '';
                            }
                        }

                        // searches by both selectors when necessary.
                        if (value == '' && !datafield.map) {
                            value = record[datafield.name];
                            if (value == undefined && value != null) {
                                value = '';
                            }
                            // the datafield.value allows you to load values like: "Nombre":{"#text":"FASE 1"}, where the datafield is Nombre, the value is object. 
                            // If the datafield.value is "#text", the value that will be loaded will be "FASE 1".
                            if (datafield.value != undefined) {
                                if (value != undefined) {
                                    var tmpvalue = value[datafield.value];
                                    if (tmpvalue != undefined) {
                                        value = tmpvalue;
                                    }
                                }
                            }
                        }

                        value = this.getvaluebytype(value, datafield);
                        if (datafield.displayname != undefined) {
                            datarow[datafield.displayname] = value;
                        }
                        else {
                            datarow[datafield.name] = value;
                        }

                        if (datafield.type === "array") {
                            var updateValues = function (records) {
                                if (!records) return;
                                for (var t = 0; t < records.length; t++) {
                                    var record = records[t];

                                    for (var c = 0; c < datafieldslength; c++) {
                                        var datafield = source.datafields[c];
                                        var value = '';
                                        if (undefined == datafield || datafield == null) {
                                            continue;
                                        }

                                        if (datafield.map) {
                                            if ($.isFunction(datafield.map)) {
                                                value = datafield.map(record);
                                            }
                                            else {
                                                var splitMap = datafield.map.split(me.mapChar);
                                                if (splitMap.length > 0) {
                                                    var datarecord = record;
                                                    for (var p = 0; p < splitMap.length; p++) {
                                                        if (datarecord != undefined) {
                                                            datarecord = datarecord[splitMap[p]];
                                                        }
                                                    }
                                                    value = datarecord;
                                                }
                                                else {
                                                    value = record[datafield.map];
                                                }
                                            }

                                            if (value != undefined && value != null) {
                                                value = value.toString();
                                            }
                                            else if (value == undefined && value != null) {
                                                value = '';
                                            }
                                        }

                                        // searches by both selectors when necessary.
                                        if (value == '' && !datafield.map) {
                                            value = record[datafield.name];
                                            if (value == undefined && value != null) {
                                                value = '';
                                            }
                                            // the datafield.value allows you to load values like: "Nombre":{"#text":"FASE 1"}, where the datafield is Nombre, the value is object. 
                                            // If the datafield.value is "#text", the value that will be loaded will be "FASE 1".
                                            if (datafield.value != undefined) {
                                                if (value != undefined) {
                                                    var tmpvalue = value[datafield.value];
                                                    if (tmpvalue != undefined) {
                                                        value = tmpvalue;
                                                    }
                                                }
                                            }
                                        }

                                        value = this.getvaluebytype(value, datafield);
                                        if (datafield.displayname != undefined) {
                                            record[datafield.displayname] = value;
                                        }
                                        else {
                                            record[datafield.name] = value;
                                        }
                                        if (datafield.type === "array") {
                                            updateValues.call(this, value);
                                        }
                                    }
                                }
                            }
                            updateValues.call(this, value);
                        }
                    }

                    if (source.recordendindex <= 0 || recordsstartindex < source.recordendindex) {
                        records[dataoffset + index] = $.extend({}, datarow);
                        records[dataoffset + index].uid = recordid;

                        this.originaldata[dataoffset + index] = $.extend({}, records[i]);
                        index++;
                    }
                }
            }
            this.records = records;
            this.cachedrecords = this.records;
        },

        loadxml: function (xmldata, data, source) {
            if (typeof (xmldata) == 'string') {
                xmldata = data = $($.parseXML(xmldata));
                xmldata = null;
            }

            if (source.root == undefined) source.root = '';
            if (source.record == undefined) source.record = '';


            var xmldata;

            if ($.jqx.browser.msie && data) {
                if (data.xml != undefined) {
                    xmldata = $(source.root + " " + source.record, $.parseXML(data.xml));
                }
                else {
                    xmldata = xmldata || $(source.root + " " + source.record, data);
                }
            }
            else xmldata = xmldata || $(source.root + " " + source.record, data);

            if (!xmldata) {
                xmldata = [];
            }

            var length = xmldata.length;
            if (xmldata.length == 0) {
                return;
            }

            this.totalrecords = this.virtualmode ? (source.totalrecords || length) : length;
            this.records = new Array();
            this.originaldata = new Array();

            var records = this.records;
            var recordsstartindex = !this.pageable ? source.recordstartindex : this.pagesize * this.pagenum;

            this.recordids = new Array();

            if (source.loadallrecords) {
                recordsstartindex = 0;
                length = this.totalrecords;
            }

            var dataoffset = 0;
            if (this.virtualmode) {
                recordsstartindex = !this.pageable ? source.recordstartindex : this.pagesize * this.pagenum;
                dataoffset = recordsstartindex;
                recordsstartindex = 0;
                length = this.totalrecords;
            }

            var datafieldslength = source.datafields ? source.datafields.length : 0;
            // auto-generate data columns
            if (datafieldslength == 0) {
                var firstrecord = xmldata[0];
                var datafields = new Array();
                for (obj in firstrecord) {
                    var field = obj;
                    datafields[datafields.length] = { name: field };
                }
                source.datafields = datafields;
                datafieldslength = datafields.length;
            }

            var p = recordsstartindex;
            var hasArray = false;
            for (var i = recordsstartindex; i < length; i++) {
                var record = xmldata[i];
                if (record == undefined)
                    break;
       
                var recordid = this.getid(source.id, record, i);
                if (!this.recordids[recordid]) {
                    this.recordids[recordid] = record;
                    var datarow = {};

                    var multiLevel = false;
                    if (source.hierarchy && source.hierarchy.root) {           
                        multiLevel = true;
                    }

                    for (var j = 0; j < datafieldslength; j++) {
                        var datafield = source.datafields[j];
                        var value = '';
                        if (undefined == datafield || datafield == null) {
                            continue;
                        }

                        if (datafield.map) {
                            if ($.isFunction(datafield.map)) {
                                value = datafield.map(record);
                            }
                            else {
                                var attributeStartIndex = datafield.map.indexOf('[');
                                if (attributeStartIndex < 0) {
                                    value = $(datafield.map, record);
                                    if (value.length == 1) value = value.text();
                                    else {
                                        hasArray = true;
                                        var subArray = new Array();
                                        for (var f = 0; f < value.length; f++) {
                                            subArray.push($(value[f]).text());
                                        }
                                        value = subArray;
                                        if (multiLevel && subArray.length > 0) {
                                            value = subArray[0];
                                        }
                                    }
                                }
                                else {
                                    var submap = datafield.map.substring(0, attributeStartIndex - 1);
                                    var attributeEndIndex = datafield.map.indexOf(']');
                                    var attribute = datafield.map.substring(attributeStartIndex + 1, attributeEndIndex);
                                    value = $(submap, record).attr(attribute);
                                    if (value == undefined) {
                                        value = $(record).attr(attribute);
                                    }

                                    if (value == undefined) value = '';
                                }
                                if (value == '') {
                                    value = $(record).attr(datafield.map);
                                    if (value == undefined) value = '';
                                }
                            }
                        }
                        // searches by both selectors when necessary.
                        if (value == '') {
                            value = $(datafield.name, record);
                            if (value.length == 1) value = value.text();
                            else {
                                var subArray = new Array();
                                for (var f = 0; f < value.length; f++) {
                                    subArray.push($(value[f]).text());
                                }
                                value = subArray;
                                if (multiLevel && subArray.length > 0) {
                                    value = subArray[0];
                                }
                            }

                            if (value == '') {
                                value = $(record).attr(datafield.name);
                                if (value == undefined) value = '';
                            }
                            if (value == '') {
                                if (record.nodeName && record.nodeName == datafield.name && record.firstChild) {
                                    value = $(record.firstChild).text();
                                }
                            }
                        }

                        var originalvalue = value;
                        value = this.getvaluebytype(value, datafield);
                        if (datafield.displayname != undefined) {
                            datarow[datafield.displayname] = value;
                        }
                        else {
                            datarow[datafield.name] = value;
                        }
                    }
                    if (source.recordendindex <= 0 || recordsstartindex < source.recordendindex) {
                        records[dataoffset + p] = $.extend({}, datarow);
                        records[dataoffset + p].uid = recordid;

                        this.originaldata[dataoffset + p] = $.extend({}, records[i]);
                        p++;
                    }
                }
            }

            if (source.hierarchy && source.hierarchy.root) {
                for (var i = recordsstartindex; i < length; i++) {
                    var record = xmldata[i];
                    var dataRecord = records[i];

                    if ($(record).parent().length > 0) {
                        var recordid = this.getid(source.id, $(record).parents(source.hierarchy.record + ":first" ));
                        dataRecord.parentuid = recordid;
                    }
                    else {
                        dataRecord.parentuid = null;
                    }
                }
            }

            this.records = records;
            this.cachedrecords = this.records;
        },

        loadtext: function (data, source) {
            if (data == null) {
                return;
            }

            var rowDelimiter = source.rowDelimiter || this.rowDelimiter || '\n';
            var rows = data.split(rowDelimiter);
            var length = rows.length;

            this.totalrecords = this.virtualmode ? (source.totalrecords || length) : length;
            this.records = new Array();
            this.originaldata = new Array();

            var records = this.records;
            var recordsstartindex = !this.pageable ? source.recordstartindex : this.pagesize * this.pagenum;

            this.recordids = new Array();

            if (source.loadallrecords) {
                recordsstartindex = 0;
                length = this.totalrecords;
            }

            var dataoffset = 0;
            if (this.virtualmode) {
                recordsstartindex = !this.pageable ? source.recordstartindex : this.pagesize * this.pagenum;
                dataoffset = recordsstartindex;
                recordsstartindex = 0;
                length = this.totalrecords;
            }

            var datafieldslength = source.datafields.length;
            var columnDelimiter = source.columnDelimiter || this.columnDelimiter;
            if (!columnDelimiter)
                columnDelimiter = (source.datatype === 'tab') ? '\t' : ',';

            for (var i = recordsstartindex; i < length; i++) {
                var record = rows[i];
                var recordid = null;//this.getid(source.id, record, i);
                if (!this.recordids[recordid]) {
                    if (source.id === null) {
                        recordid = i;
                        this.recordids[recordid] = record;
                    }

                    var datarow = {};
                    var columns = rows[i].split(columnDelimiter);

                    for (var j = 0; j < datafieldslength; j++) {
                        if (j >= columns.length)
                            continue;
                        var datafield = source.datafields[j];

                        var value = columns[j];
                        if (datafield.map && $.isFunction(datafield.map)) {
                            value = datafield.map(record);
                        }

                        if (datafield.type) {
                            value = this.getvaluebytype(value, datafield);
                        }

                        var key = datafield.map || datafield.name || j.toString();
                        datarow[key] = value;
                        if (source.id != null) {
                            if (source.id === datafield.name) {
                                recordid = value;
                                this.recordids[recordid] = record;
                            }
                        }
                    }

                    records[dataoffset + i] = $.extend({}, datarow);
                    records[dataoffset + i].uid = recordid;

                    this.originaldata[dataoffset + i] = $.extend({}, records[i]);
                }
            }
            this.records = records;
            this.cachedrecords = this.records;
        },

        getvaluebytype: function (value, datafield) {
            var originalvalue = value;
            if (value == null) return value;
            if ($.isArray(value) && datafield.type != "array") {
                for (var t = 0; t < value.length; t++) {
                    value[t] = this.getvaluebytype(value[t], datafield);
                }
                return value;
            }

            if (datafield.type == 'date') {
                if (value == "NaN") {
                    value = "";
                }
                else {
                    var tmpvalue = new Date(value);

                    if (typeof value == 'string') {
                        if (datafield.format) {
                            var newtmpvalue = $.jqx.dataFormat.parsedate(value, datafield.format);
                            if (newtmpvalue != null) {
                                tmpvalue = newtmpvalue;
                            }
                        }
                    }

                    if (tmpvalue.toString() == 'NaN' || tmpvalue.toString() == "Invalid Date") {
                        if ($.jqx.dataFormat) {
                            value = $.jqx.dataFormat.tryparsedate(value);
                        }
                        else value = tmpvalue;
                    }
                    else {
                        value = tmpvalue;
                    }

                    if (value == null) {
                        value = originalvalue;
                    }
                }
            }
            else if (datafield.type == 'float' || datafield.type == 'number' || datafield.type == 'decimal') {
                if (value == "NaN") value = "";
                else {
                    var value = parseFloat(value);
                    if (isNaN(value)) {
                        value = originalvalue;
                    }
                }
            }
            else if (datafield.type == 'int' || datafield.type == 'integer') {
                var value = parseInt(value);
                if (isNaN(value)) {
                    value = originalvalue;
                }
            }
            else if (datafield.type == 'bool' || datafield.type == 'boolean') {
                if (value != null) {
                    if (value.toLowerCase != undefined) {
                        if (value.toLowerCase() == 'false') {
                            value = false;
                        }
                        else if (value.toLowerCase() == 'true') {
                            value = true;
                        }
                    }
                }

                if (value == 1) {
                    value = true;
                }
                else if (value == 0 && value !== "") {
                    value = false;
                }
                else value = '';
            }

            return value;
        }
    }

    $.jqx.dataFormat = {};

    $.extend($.jqx.dataFormat, {
        regexTrim: /^\s+|\s+$/g,
        regexInfinity: /^[+-]?infinity$/i,
        regexHex: /^0x[a-f0-9]+$/i,
        regexParseFloat: /^[+-]?\d*\.?\d*(e[+-]?\d+)?$/,
        toString: Object.prototype.toString,

        isBoolean: function (value) {
            return typeof value === 'boolean';
        },

        isObject: function (value) {
            return (value && (typeof value === 'object' || $.isFunction(value))) || false;
        },

        isDate: function (value) {
            return value instanceof Date;
        },

        arrayIndexOf: function (array, item) {
            if (array.indexOf) {
                return array.indexOf(item);
            }
            for (var i = 0, length = array.length; i < length; i++) {
                if (array[i] === item) {
                    return i;
                }
            }
            return -1;
        },

        isString: function (value) {
            return typeof value === 'string';
        },

        isNumber: function (value) {
            return typeof value === 'number' && isFinite(value);
        },

        isNull: function (value) {
            return value === null;
        },

        isUndefined: function (value) {
            return typeof value === 'undefined';
        },

        isValue: function (value) {
            return (this.isObject(value) || this.isString(value) || this.isNumber(value) || this.isBoolean(value));
        },

        isEmpty: function (value) {
            if (!this.isString(value) && this.isValue(value)) {
                return false;
            } else if (!this.isValue(value)) {
                return true;
            }
            value = $.trim(value).replace(/\&nbsp\;/ig, '').replace(/\&#160\;/ig, '');
            return value === "";
        },

        startsWith: function (value, pattern) {
            return value.indexOf(pattern) === 0;
        },

        endsWith: function (value, pattern) {
            return value.substr(value.length - pattern.length) === pattern;
        },

        trim: function (value) {
            return (value + "").replace(this.regexTrim, "");
        },

        isArray: function (obj) {
            return this.toString.call(obj) === "[object Array]";
        },

        defaultcalendar: function () {
            var calendar = {
                // separator of parts of a date (e.g. '/' in 11/05/1955)
                '/': "/",
                // separator of parts of a time (e.g. ':' in 05:44 PM)
                ':': ":",
                // the first day of the week (0 = Sunday, 1 = Monday, etc)
                firstDay: 0,
                days: {
                    // full day names
                    names: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
                    // abbreviated day names
                    namesAbbr: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
                    // shortest day names
                    namesShort: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"]
                },
                months: {
                    // full month names (13 months for lunar calendards -- 13th month should be "" if not lunar)
                    names: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December", ""],
                    // abbreviated month names
                    namesAbbr: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", ""]
                },
                // AM and PM designators in one of these forms:
                // The usual view, and the upper and lower case versions
                //      [standard,lowercase,uppercase]
                // The culture does not use AM or PM (likely all standard date formats use 24 hour time)
                //      null
                AM: ["AM", "am", "AM"],
                PM: ["PM", "pm", "PM"],
                eras: [
                // eras in reverse chronological order.
                // name: the name of the era in this culture (e.g. A.D., C.E.)
                // start: when the era starts in ticks (gregorian, gmt), null if it is the earliest supported era.
                // offset: offset in years from gregorian calendar
                    {"name": "A.D.", "start": null, "offset": 0 }
                ],
                twoDigitYearMax: 2029,
                patterns: {
                    // short date pattern
                    d: "M/d/yyyy",
                    // long date pattern
                    D: "dddd, MMMM dd, yyyy",
                    // short time pattern
                    t: "h:mm tt",
                    // long time pattern
                    T: "h:mm:ss tt",
                    // long date, short time pattern
                    f: "dddd, MMMM dd, yyyy h:mm tt",
                    // long date, long time pattern
                    F: "dddd, MMMM dd, yyyy h:mm:ss tt",
                    // month/day pattern
                    M: "MMMM dd",
                    // month/year pattern
                    Y: "yyyy MMMM",
                    // S is a sortable format that does not vary by culture
                    S: "yyyy\u0027-\u0027MM\u0027-\u0027dd\u0027T\u0027HH\u0027:\u0027mm\u0027:\u0027ss",
                    // formatting of dates in MySQL DataBases
                    ISO: "yyyy-MM-dd hh:mm:ss",
                    ISO2: "yyyy-MM-dd HH:mm:ss",
                    d1: "dd.MM.yyyy",
                    d2: "dd-MM-yyyy",
                    zone1: "yyyy-MM-ddTHH:mm:ss-HH:mm",
                    zone2: "yyyy-MM-ddTHH:mm:ss+HH:mm",
                    custom: "yyyy-MM-ddTHH:mm:ss.fff"
                },
                percentsymbol: "%",
                currencysymbol: "$",
                currencysymbolposition: "before",
                decimalseparator: '.',
                thousandsseparator: ','
            }
            return calendar;
        },

        expandFormat: function (calendar, format) {
            // expands unspecified or single character date formats into the full pattern.
            format = format || "F";
            var pattern,
                patterns = calendar.patterns,
                len = format.length;
            if (len === 1) {
                pattern = patterns[format];
                if (!pattern) {
                    throw "Invalid date format string '" + format + "'.";
                }
                format = pattern;
            }
            else if (len === 2 && format.charAt(0) === "%") {
                // %X escape format -- intended as a custom format string that is only one character, not a built-in format.
                format = format.charAt(1);
            }
            return format;
        },

        getEra: function (date, eras) {
            if (!eras) return 0;
            if (typeof date === 'string') {
                return 0;
            }

            var start, ticks = date.getTime();
            for (var i = 0, l = eras.length; i < l; i++) {
                start = eras[i].start;
                if (start === null || ticks >= start) {
                    return i;
                }
            }
            return 0;
        },

        toUpper: function (value) {
            // 'he-IL' has non-breaking space in weekday names.
            return value.split("\u00A0").join(' ').toUpperCase();
        },

        toUpperArray: function (arr) {
            var results = [];
            for (var i = 0, l = arr.length; i < l; i++) {
                results[i] = this.toUpper(arr[i]);
            }
            return results;
        },

        getEraYear: function (date, cal, era, sortable) {
            var year = date.getFullYear();
            if (!sortable && cal.eras) {
                // convert normal gregorian year to era-shifted gregorian
                // year by subtracting the era offset
                year -= cal.eras[era].offset;
            }
            return year;
        },

        toUpper: function(value)
        {
            if (value) {
                return value.toUpperCase();
            }
            return "";
        },

        getDayIndex: function (cal, value, abbr) {
            var ret,
                days = cal.days,
                upperDays = cal._upperDays;
            if (!upperDays) {
                cal._upperDays = upperDays = [
                    this.toUpperArray(days.names),
                    this.toUpperArray(days.namesAbbr),
                    this.toUpperArray(days.namesShort)
                ];
            }
            value = value.toUpperCase();
            if (abbr) {
                ret = this.arrayIndexOf(upperDays[1], value);
                if (ret === -1) {
                    ret = this.arrayIndexOf(upperDays[2], value);
                }
            }
            else {
                ret = this.arrayIndexOf(upperDays[0], value);
            }
            return ret;
        },

        getMonthIndex: function (cal, value, abbr) {
            var months = cal.months,
                monthsGen = cal.monthsGenitive || cal.months,
                upperMonths = cal._upperMonths,
                upperMonthsGen = cal._upperMonthsGen;
            if (!upperMonths) {
                cal._upperMonths = upperMonths = [
                    this.toUpperArray(months.names),
                    this.toUpperArray(months.namesAbbr)
                ];
                cal._upperMonthsGen = upperMonthsGen = [
                    this.toUpperArray(monthsGen.names),
                    this.toUpperArray(monthsGen.namesAbbr)
                ];
            }
            value = this.toUpper(value);
            var i = this.arrayIndexOf(abbr ? upperMonths[1] : upperMonths[0], value);
            if (i < 0) {
                i = this.arrayIndexOf(abbr ? upperMonthsGen[1] : upperMonthsGen[0], value);
            }
            return i;
        },

        appendPreOrPostMatch: function (preMatch, strings) {
            // appends pre- and post- token match strings while removing escaped characters.
            // Returns a single quote count which is used to determine if the token occurs
            // in a string literal.
            var quoteCount = 0,
                escaped = false;
            for (var i = 0, il = preMatch.length; i < il; i++) {
                var c = preMatch.charAt(i);
                switch (c) {
                    case '\'':
                        if (escaped) {
                            strings.push("'");
                        }
                        else {
                            quoteCount++;
                        }
                        escaped = false;
                        break;
                    case '\\':
                        if (escaped) {
                            strings.push("\\");
                        }
                        escaped = !escaped;
                        break;
                    default:
                        strings.push(c);
                        escaped = false;
                        break;
                }
            }
            return quoteCount;
        },

        getTokenRegExp: function () {
            // regular expression for matching date and time tokens in format strings.
            return /\/|dddd|ddd|dd|d|MMMM|MMM|MM|M|yyyy|yy|y|hh|h|HH|H|mm|m|ss|s|tt|t|fff|ff|f|zzz|zz|z|gg|g/g;
        },

        formatlink: function (value, format) {
            var target = '';
            if (format && format.target) { target = 'target=' + format.target; }
            if (target != '') {
                return "<a " + target + " href=\"" + value + "\">" + value + "</a>";
            }
            return "<a href=\"" + value + "\">" + value + "</a>";
        },

        formatemail: function (value) {
            return "<a href=\"mailto:" + value + "\">" + value + "</a>";
        },

        formatnumber: function (value, format, calendar) {
            if (calendar == undefined || calendar == null || calendar == "") {
                calendar = this.defaultcalendar();
            }

            if (format === "" || format === null) {
                return value;
            }

            if (!this.isNumber(value)) {
                value *= 1;
            }
            var precision;
            if (format.length > 1) precision = parseInt(format.slice(1), 10);

            var options = {}
            var current = format.charAt(0).toUpperCase();

            options.thousandsSeparator = calendar.thousandsseparator;
            options.decimalSeparator = calendar.decimalseparator;
            switch (current) {
                case "D":
                case "d":
                case "F":
                case "f":
                    options.decimalPlaces = precision;
                    break;
                case "N":
                case "n":
                    options.decimalPlaces = 0;
                    break;
                case "C":
                case "c":
                    options.decimalPlaces = precision;
                    if (calendar.currencysymbolposition == "before") {
                        options.prefix = calendar.currencysymbol;
                    }
                    else {
                        options.suffix = calendar.currencysymbol;
                    }
                    break;
                case "P":
                case "p":
                    options.suffix = calendar.percentsymbol;
                    options.decimalPlaces = precision;
                    break;
                default:
                    throw "Bad number format specifier: " + current;
            }

            if (this.isNumber(value)) {
                var negative = (value < 0);
                var output = value + "";
                var decimalseparator = (options.decimalSeparator) ? options.decimalSeparator : ".";
                var decimalindex;
                if (this.isNumber(options.decimalPlaces)) {
                    // Round to the correct decimal place
                    var decimalplaces = options.decimalPlaces;
                    var decimal = Math.pow(10, decimalplaces);
                    output = (value * decimal).toFixed(0) / decimal + "";
                    decimalindex = output.lastIndexOf(".");
                    if (decimalplaces > 0) {
                        // Add the decimal separator
                        if (decimalindex < 0) {
                              output += decimalseparator;
                            decimalindex = output.length - 1;
                        }
                        // Replace the "."
                        else if (decimalseparator !== ".") {
                            output = output.replace(".", decimalseparator);
                        }
                        // Add missing zeros
                        while ((output.length - 1 - decimalindex) < decimalplaces) {
                            output += "0";
                        }
                    }
                }
                if (options.thousandsSeparator) {
                    var groupseparator = options.thousandsSeparator;
                    decimalindex = output.lastIndexOf(decimalseparator);
                    decimalindex = (decimalindex > -1) ? decimalindex : output.length;
                    var newoutput = output.substring(decimalindex);
                    var nCount = -1;
                    for (var i = decimalindex; i > 0; i--) {
                        nCount++;
                        if ((nCount % 3 === 0) && (i !== decimalindex) && (!negative || (i > 1))) {
                            newoutput = groupseparator + newoutput;
                        }
                        newoutput = output.charAt(i - 1) + newoutput;
                    }
                    output = newoutput;
                }
                // Prepend prefix
                output = (options.prefix) ? options.prefix + output : output;
                // Append suffix
                output = (options.suffix) ? output + options.suffix : output;
                return output;

            } else {
                return value;
            }
        },

        tryparsedate: function (value, calendar) {
            if (calendar == undefined || calendar == null) {
                calendar = this.defaultcalendar();
            }
            var me = this;
            if (value == "")
                return null;

            if (value != null && !value.substring) {
                value = value.toString();
            }

            if (value != null && value.substring(0, 6) == "/Date(") {
                var jsonDateRE = /^\/Date\((-?\d+)(\+|-)?(\d+)?\)\/$/;

                var date = new Date(+value.replace(/\/Date\((\d+)\)\//, '$1'));
                if (date == "Invalid Date") {
                    var m = value.match(/^\/Date\((\d+)([-+]\d\d)(\d\d)\)\/$/);
                    var date = null;
                    if (m)
                        date = new Date(1 * m[1] + 3600000 * m[2] + 60000 * m[3]);
                }
                if (date == null || date == "Invalid Date" || isNaN(date)) {
                    var arr = jsonDateRE.exec(value);
                    if (arr) {
                        // 0 - complete results; 1 - ticks; 2 - sign; 3 - minutes
                        var result = new Date(parseInt(arr[1]));
                        if (arr[2]) {
                            var mins = parseInt(arr[3]);
                            if (arr[2] === "-") {
                                mins = -mins;
                            }
                            var current = result.getUTCMinutes();
                            result.setUTCMinutes(current - mins);
                        }
                        if (!isNaN(result.valueOf())) {
                            return result;
                        }
                    }
                }

                return date;
            }

            patterns = calendar.patterns;
            for (prop in patterns) {
                date = me.parsedate(value, patterns[prop], calendar);
                if (date) {
                    if (prop == "ISO") {
                        var tmpDate = me.parsedate(value, patterns["ISO2"], calendar);
                        if (tmpDate) return tmpDate;
                    }
                    return date;
                }
            }

            if (value != null) {
                var tmpDate = null;
                var dateParts = [':', '/', '-'];
                var canParse = true;
                for (var part = 0; part < dateParts.length; part++) {
                    if (value.indexOf(dateParts[part]) != -1) {
                        canParse = false;
                    }
                }

                if (canParse) {
                    var number = new Number(value);
                    if (!isNaN(number)) {
                        return new Date(number);
                    }
                }
            }

            return null;
        },

        getparseregexp: function (cal, format) {
            // converts a format string into a regular expression with groups that
            // can be used to extract date fields from a date string.
            // check for a cached parse regex.
            var re = cal._parseRegExp;
            if (!re) {
                cal._parseRegExp = re = {};
            }
            else {
                var reFormat = re[format];
                if (reFormat) {
                    return reFormat;
                }
            }

            // expand single digit formats, then escape regular expression characters.
            var expFormat = this.expandFormat(cal, format).replace(/([\^\$\.\*\+\?\|\[\]\(\)\{\}])/g, "\\\\$1"),
                regexp = ["^"],
                groups = [],
                index = 0,
                quoteCount = 0,
                tokenRegExp = this.getTokenRegExp(),
                match;

            // iterate through each date token found.
            while ((match = tokenRegExp.exec(expFormat)) !== null) {
                var preMatch = expFormat.slice(index, match.index);
                index = tokenRegExp.lastIndex;

                // don't replace any matches that occur inside a string literal.
                quoteCount += this.appendPreOrPostMatch(preMatch, regexp);
                if (quoteCount % 2) {
                    regexp.push(match[0]);
                    continue;
                }

                // add a regex group for the token.
                var m = match[0],
                    len = m.length,
                    add;
                switch (m) {
                    case 'dddd': case 'ddd':
                    case 'MMMM': case 'MMM':
                    case 'gg': case 'g':
                        add = "(\\D+)";
                        break;
                    case 'tt': case 't':
                        add = "(\\D*)";
                        break;
                    case 'yyyy':
                    case 'fff':
                    case 'ff':
                    case 'f':
                        add = "(\\d{" + len + "})";
                        break;
                    case 'dd': case 'd':
                    case 'MM': case 'M':
                    case 'yy': case 'y':
                    case 'HH': case 'H':
                    case 'hh': case 'h':
                    case 'mm': case 'm':
                    case 'ss': case 's':
                        add = "(\\d\\d?)";
                        break;
                    case 'zzz':
                        add = "([+-]?\\d\\d?:\\d{2})";
                        break;
                    case 'zz': case 'z':
                        add = "([+-]?\\d\\d?)";
                        break;
                    case '/':
                        add = "(\\" + cal["/"] + ")";
                        break;
                    default:
                        throw "Invalid date format pattern '" + m + "'.";
                        break;
                }
                if (add) {
                    regexp.push(add);
                }
                groups.push(match[0]);
            }
            this.appendPreOrPostMatch(expFormat.slice(index), regexp);
            regexp.push("$");

            // allow whitespace to differ when matching formats.
            var regexpStr = regexp.join('').replace(/\s+/g, "\\s+"),
                parseRegExp = { 'regExp': regexpStr, 'groups': groups };

            // cache the regex for this format.
            return re[format] = parseRegExp;
        },

        outOfRange: function (value, low, high) {
            return value < low || value > high;
        },

        expandYear: function (cal, year) {
            // expands 2-digit year into 4 digits.
            var now = new Date(),
        era = getEra(now);
            if (year < 100) {
                var twoDigitYearMax = cal.twoDigitYearMax;
                twoDigitYearMax = typeof twoDigitYearMax === 'string' ? new Date().getFullYear() % 100 + parseInt(twoDigitYearMax, 10) : twoDigitYearMax;
                var curr = this.getEraYear(now, cal, era);
                year += curr - (curr % 100);
                if (year > twoDigitYearMax) {
                    year -= 100;
                }
            }
            return year;
        },

        parsedate: function (value, format, calendar) {
            if (calendar == undefined || calendar == null) {
                calendar = this.defaultcalendar();
            }
            // try to parse the date string by matching against the format string
            // while using the specified culture for date field names.
            value = this.trim(value);
            var cal = calendar,
            // convert date formats into regular expressions with groupings.
            // use the regexp to determine the input format and extract the date fields.
                parseInfo = this.getparseregexp(cal, format),
                match = new RegExp(parseInfo.regExp).exec(value);
            if (match === null) {
                return null;
            }
            // found a date format that matches the input.
            var groups = parseInfo.groups,
                era = null, year = null, month = null, date = null, weekDay = null,
                hour = 0, hourOffset, min = 0, sec = 0, msec = 0, tzMinOffset = null,
                pmHour = false;
            // iterate the format groups to extract and set the date fields.
            for (var j = 0, jl = groups.length; j < jl; j++) {
                var matchGroup = match[j + 1];
                if (matchGroup) {
                    var current = groups[j],
                        clength = current.length,
                        matchInt = parseInt(matchGroup, 10);
                    switch (current) {
                        case 'dd': case 'd':
                            // Day of month.
                            date = matchInt;
                            // check that date is generally in valid range, also checking overflow below.
                            if (this.outOfRange(date, 1, 31)) return null;
                            break;
                        case 'MMM':
                        case 'MMMM':
                            month = this.getMonthIndex(cal, matchGroup, clength === 3);
                            if (this.outOfRange(month, 0, 11)) return null;
                            break;
                        case 'M': case 'MM':
                            // Month.
                            month = matchInt - 1;
                            if (this.outOfRange(month, 0, 11)) return null;
                            break;
                        case 'y': case 'yy':
                        case 'yyyy':
                            year = clength < 4 ? this.expandYear(cal, matchInt) : matchInt;
                            if (this.outOfRange(year, 0, 9999)) return null;
                            break;
                        case 'h': case 'hh':
                            // Hours (12-hour clock).
                            hour = matchInt;
                            if (hour === 12) hour = 0;
                            if (this.outOfRange(hour, 0, 11)) return null;
                            break;
                        case 'H': case 'HH':
                            // Hours (24-hour clock).
                            hour = matchInt;
                            if (this.outOfRange(hour, 0, 23)) return null;
                            break;
                        case 'm': case 'mm':
                            // Minutes.
                            min = matchInt;
                            if (this.outOfRange(min, 0, 59)) return null;
                            break;
                        case 's': case 'ss':
                            // Seconds.
                            sec = matchInt;
                            if (this.outOfRange(sec, 0, 59)) return null;
                            break;
                        case 'tt': case 't':
                            // AM/PM designator.
                            // see if it is standard, upper, or lower case PM. If not, ensure it is at least one of
                            // the AM tokens. If not, fail the parse for this format.
                            pmHour = cal.PM && (matchGroup === cal.PM[0] || matchGroup === cal.PM[1] || matchGroup === cal.PM[2]);
                            if (!pmHour && (!cal.AM || (matchGroup !== cal.AM[0] && matchGroup !== cal.AM[1] && matchGroup !== cal.AM[2]))) return null;
                            break;
                        case 'f':
                            // Deciseconds.
                        case 'ff':
                            // Centiseconds.
                        case 'fff':
                            // Milliseconds.
                            msec = matchInt * Math.pow(10, 3 - clength);
                            if (this.outOfRange(msec, 0, 999)) return null;
                            break;
                        case 'ddd':
                            // Day of week.
                        case 'dddd':
                            // Day of week.
                            weekDay = this.getDayIndex(cal, matchGroup, clength === 3);
                            if (this.outOfRange(weekDay, 0, 6)) return null;
                            break;
                        case 'zzz':
                            // Time zone offset in +/- hours:min.
                            var offsets = matchGroup.split(/:/);
                            if (offsets.length !== 2) return null;
                            hourOffset = parseInt(offsets[0], 10);
                            if (this.outOfRange(hourOffset, -12, 13)) return null;
                            var minOffset = parseInt(offsets[1], 10);
                            if (this.outOfRange(minOffset, 0, 59)) return null;
                            tzMinOffset = (hourOffset * 60) + (startsWith(matchGroup, '-') ? -minOffset : minOffset);
                            break;
                        case 'z': case 'zz':
                            // Time zone offset in +/- hours.
                            hourOffset = matchInt;
                            if (this.outOfRange(hourOffset, -12, 13)) return null;
                            tzMinOffset = hourOffset * 60;
                            break;
                        case 'g': case 'gg':
                            var eraName = matchGroup;
                            if (!eraName || !cal.eras) return null;
                            eraName = trim(eraName.toLowerCase());
                            for (var i = 0, l = cal.eras.length; i < l; i++) {
                                if (eraName === cal.eras[i].name.toLowerCase()) {
                                    era = i;
                                    break;
                                }
                            }
                            // could not find an era with that name
                            if (era === null) return null;
                            break;
                    }
                }
            }
            var result = new Date(), defaultYear, convert = cal.convert;
            defaultYear = result.getFullYear();
            if (year === null) {
                year = defaultYear;
            }
            else if (cal.eras) {
                // year must be shifted to normal gregorian year
                // but not if year was not specified, its already normal gregorian
                // per the main if clause above.
                year += cal.eras[(era || 0)].offset;
            }
            // set default day and month to 1 and January, so if unspecified, these are the defaults
            // instead of the current day/month.
            if (month === null) {
                month = 0;
            }
            if (date === null) {
                date = 1;
            }
            // now have year, month, and date, but in the culture's calendar.
            // convert to gregorian if necessary
            if (convert) {
                result = convert.toGregorian(year, month, date);
                // conversion failed, must be an invalid match
                if (result === null) return null;
            }
            else {
                // have to set year, month and date together to avoid overflow based on current date.
                result.setFullYear(year, month, date);
                // check to see if date overflowed for specified month (only checked 1-31 above).
                if (result.getDate() !== date) return null;
                // invalid day of week.
                if (weekDay !== null && result.getDay() !== weekDay) {
                    return null;
                }
            }
            // if pm designator token was found make sure the hours fit the 24-hour clock.
            if (pmHour && hour < 12) {
                hour += 12;
            }
            result.setHours(hour, min, sec, msec);
            if (tzMinOffset !== null) {
                // adjust timezone to utc before applying local offset.
                var adjustedMin = result.getMinutes() - (tzMinOffset + result.getTimezoneOffset());
                // Safari limits hours and minutes to the range of -127 to 127.  We need to use setHours
                // to ensure both these fields will not exceed this range.  adjustedMin will range
                // somewhere between -1440 and 1500, so we only need to split this into hours.
                result.setHours(result.getHours() + parseInt(adjustedMin / 60, 10), adjustedMin % 60);
            }
            return result;
        },

        cleardatescache: function () {
            this.datescache = new Array();
        },

        formatdate: function (value, format, calendar) {
            if (calendar == undefined || calendar == null) {
                calendar = this.defaultcalendar();
            }

            if (typeof value === 'string') {
                return value;
            }

            var lookupkey = value.toString() + "_" + format;
            if (this.datescache && this.datescache[lookupkey]) {
                return this.datescache[lookupkey];
            }

            if (!format || !format.length || format === 'i') {
                var ret;
                ret = this.formatDate(value, calendar.patterns.F, culture);
                return ret;
            }

            var eras = calendar.eras,
            sortable = format === "s";
            format = this.expandFormat(calendar, format);

            // Start with an empty string
            ret = [];
            var hour,
            zeros = ['0', '00', '000'],
            foundDay,
            checkedDay,
            dayPartRegExp = /([^d]|^)(d|dd)([^d]|$)/g,
            quoteCount = 0,
            tokenRegExp = this.getTokenRegExp(),
            converted;

            function padZeros(num, c) {
                var r, s = num + '';
                if (c > 1 && s.length < c) {
                    r = (zeros[c - 2] + s);
                    return r.substr(r.length - c, c);
                }
                else {
                    r = s;
                }
                return r;
            }

            function hasDay() {
                if (foundDay || checkedDay) {
                    return foundDay;
                }
                foundDay = dayPartRegExp.test(format);
                checkedDay = true;
                return foundDay;
            }

            function getPart(date, part) {
                if (converted) {
                    return converted[part];
                }
                if (date.getMonth != undefined) {
                    switch (part) {
                        case 0: return date.getFullYear();
                        case 1: return date.getMonth();
                        case 2: return date.getDate();
                    }
                }
            }

            for (; ; ) {
                // Save the current index
                var index = tokenRegExp.lastIndex,
                // Look for the next pattern
                ar = tokenRegExp.exec(format);

                // Append the text before the pattern (or the end of the string if not found)
                var preMatch = format.slice(index, ar ? ar.index : format.length);
                quoteCount += this.appendPreOrPostMatch(preMatch, ret);

                if (!ar) {
                    break;
                }

                // do not replace any matches that occur inside a string literal.
                if (quoteCount % 2) {
                    ret.push(ar[0]);
                    continue;
                }

                var current = ar[0],
                clength = current.length;

                switch (current) {
                    case "ddd":
                        //Day of the week, as a three-letter abbreviation
                    case "dddd":
                        // Day of the week, using the full name
                        var names = (clength === 3) ? calendar.days.namesAbbr : calendar.days.names;
                        ret.push(names[value.getDay()]);
                        break;
                    case "d":
                        // Day of month, without leading zero for single-digit days
                    case "dd":
                        // Day of month, with leading zero for single-digit days
                        foundDay = true;
                        ret.push(padZeros(getPart(value, 2), clength));
                        break;
                    case "MMM":
                        // Month, as a three-letter abbreviation
                    case "MMMM":
                        // Month, using the full name
                        var part = getPart(value, 1);
                        ret.push(calendar.months[clength === 3 ? "namesAbbr" : "names"][part]);
                        break;
                    case "M":
                        // Month, as digits, with no leading zero for single-digit months
                    case "MM":
                        // Month, as digits, with leading zero for single-digit months
                        ret.push(padZeros(getPart(value, 1) + 1, clength));
                        break;
                    case "y":
                        // Year, as two digits, but with no leading zero for years less than 10
                    case "yy":
                        // Year, as two digits, with leading zero for years less than 10
                    case "yyyy":
                        // Year represented by four full digits
                        part = this.getEraYear(value, calendar, this.getEra(value, eras), sortable);
                        if (clength < 4) {
                            part = part % 100;
                        }
                        ret.push(padZeros(part, clength));
                        break;
                    case "h":
                        // Hours with no leading zero for single-digit hours, using 12-hour clock
                    case "hh":
                        // Hours with leading zero for single-digit hours, using 12-hour clock
                        hour = value.getHours() % 12;
                        if (hour === 0) hour = 12;
                        ret.push(padZeros(hour, clength));
                        break;
                    case "H":
                        // Hours with no leading zero for single-digit hours, using 24-hour clock
                    case "HH":
                        // Hours with leading zero for single-digit hours, using 24-hour clock
                        ret.push(padZeros(value.getHours(), clength));
                        break;
                    case "m":
                        // Minutes with no leading zero  for single-digit minutes
                    case "mm":
                        // Minutes with leading zero  for single-digit minutes
                        ret.push(padZeros(value.getMinutes(), clength));
                        break;
                    case "s":
                        // Seconds with no leading zero for single-digit seconds
                    case "ss":
                        // Seconds with leading zero for single-digit seconds
                        ret.push(padZeros(value.getSeconds(), clength));
                        break;
                    case "t":
                        // One character am/pm indicator ("a" or "p")
                    case "tt":
                        // Multicharacter am/pm indicator
                        part = value.getHours() < 12 ? (calendar.AM ? calendar.AM[0] : " ") : (calendar.PM ? calendar.PM[0] : " ");
                        ret.push(clength === 1 ? part.charAt(0) : part);
                        break;
                    case "f":
                        // Deciseconds
                    case "ff":
                        // Centiseconds
                    case "fff":
                        // Milliseconds
                        ret.push(padZeros(value.getMilliseconds(), 3).substr(0, clength));
                        break;
                    case "z":
                        // Time zone offset, no leading zero
                    case "zz":
                        // Time zone offset with leading zero
                        hour = value.getTimezoneOffset() / 60;
                        ret.push((hour <= 0 ? '+' : '-') + padZeros(Math.floor(Math.abs(hour)), clength));
                        break;
                    case "zzz":
                        // Time zone offset with leading zero
                        hour = value.getTimezoneOffset() / 60;
                        ret.push((hour <= 0 ? '+' : '-') + padZeros(Math.floor(Math.abs(hour)), 2) +
                        // Hard coded ":" separator, rather than using calendar.TimeSeparator
                        // Repeated here for consistency, plus ":" was already assumed in date parsing.
                    ":" + padZeros(Math.abs(value.getTimezoneOffset() % 60), 2));
                        break;
                    case "g":
                    case "gg":
                        if (calendar.eras) {
                            ret.push(calendar.eras[getEra(value, eras)].name);
                        }
                        break;
                    case "/":
                        ret.push(calendar["/"]);
                        break;
                    default:
                        throw "Invalid date format pattern '" + current + "'.";
                        break;
                }
            }

            var result = ret.join('');

            if (!this.datescache) {
                this.datescache = new Array();
            }

            this.datescache[lookupkey] = result;
            return result;
        }
    });

    // AJAX
    $.jqx.data = {};
    var
        ajaxLocParts,
        ajaxLocation,

        rhash = /#.*$/,
        rheaders = /^(.*?):[ \t]*([^\r\n]*)\r?$/mg,
        rlocalProtocol = /^(?:about|app|app\-storage|.+\-extension|file|res|widget):$/,
        rnoContent = /^(?:GET|HEAD)$/,
        rprotocol = /^\/\//,
        rquery = /\?/,
        rscript = /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
        rts = /([?&])_=[^&]*/,
        rurl = /^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,
        core_rspace = /\s+/,
        _load = jQuery.fn.load,
        prefilters = {},
        transports = {},
        allTypes = ["*/"] + ["*"];

    try {
        ajaxLocation = location.href;
    } catch (e) {
        ajaxLocation = document.createElement("a");
        ajaxLocation.href = "";
        ajaxLocation = ajaxLocation.href;
    }

    ajaxLocParts = rurl.exec(ajaxLocation.toLowerCase()) || [];

    function addToPrefiltersOrTransports(structure) {

        return function (dataTypeExpression, func) {

            if (typeof dataTypeExpression !== "string") {
                func = dataTypeExpression;
                dataTypeExpression = "*";
            }

            var dataType, list, placeBefore,
                dataTypes = dataTypeExpression.toLowerCase().split(core_rspace),
                i = 0,
                length = dataTypes.length;

            if (jQuery.isFunction(func)) {
                for (; i < length; i++) {
                    dataType = dataTypes[i];
                    placeBefore = /^\+/.test(dataType);
                    if (placeBefore) {
                        dataType = dataType.substr(1) || "*";
                    }
                    list = structure[dataType] = structure[dataType] || [];
                    list[placeBefore ? "unshift" : "push"](func);
                }
            }
        };
    }

    function inspectPrefiltersOrTransports(structure, options, originalOptions, jqXHR,
            dataType /* internal */, inspected /* internal */) {

        dataType = dataType || options.dataTypes[0];
        inspected = inspected || {};

        inspected[dataType] = true;

        var selection,
            list = structure[dataType],
            i = 0,
            length = list ? list.length : 0,
            executeOnly = (structure === prefilters);

        for (; i < length && (executeOnly || !selection) ; i++) {
            selection = list[i](options, originalOptions, jqXHR);
            if (typeof selection === "string") {
                if (!executeOnly || inspected[selection]) {
                    selection = undefined;
                } else {
                    options.dataTypes.unshift(selection);
                    selection = inspectPrefiltersOrTransports(
                            structure, options, originalOptions, jqXHR, selection, inspected);
                }
            }
        }
        if ((executeOnly || !selection) && !inspected["*"]) {
            selection = inspectPrefiltersOrTransports(
                    structure, options, originalOptions, jqXHR, "*", inspected);
        }
        return selection;
    }

    function ajaxExtend(target, src) {
        var key, deep,
            flatOptions = $.jqx.data.ajaxSettings.flatOptions || {};
        for (key in src) {
            if (src[key] !== undefined) {
                (flatOptions[key] ? target : (deep || (deep = {})))[key] = src[key];
            }
        }
        if (deep) {
            jQuery.extend(true, target, deep);
        }
    }

    $.extend($.jqx.data, {
        ajaxSetup: function (target, settings) {
            if (settings) {
                ajaxExtend(target, $.jqx.data.ajaxSettings);
            } else {
                settings = target;
                target = $.jqx.data.ajaxSettings;
            }
            ajaxExtend(target, settings);
            return target;
        },

        ajaxSettings: {
            url: ajaxLocation,
            isLocal: rlocalProtocol.test(ajaxLocParts[1]),
            global: true,
            type: "GET",
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            processData: true,
            async: true,
          
            accepts: {
                xml: "application/xml, text/xml",
                html: "text/html",
                text: "text/plain",
                json: "application/json, text/javascript",
                "*": allTypes
            },

            contents: {
                xml: /xml/,
                html: /html/,
                json: /json/
            },

            responseFields: {
                xml: "responseXML",
                text: "responseText"
            },

            converters: {
                "* text": window.String,
                "text html": true,
                "text json": jQuery.parseJSON,
                "text xml": jQuery.parseXML
            },

            flatOptions: {
                context: true,
                url: true
            }
        },

        ajaxPrefilter: addToPrefiltersOrTransports(prefilters),
        ajaxTransport: addToPrefiltersOrTransports(transports),

        ajax: function (url, options) {

            if (typeof url === "object") {
                options = url;
                url = undefined;
            }

            options = options || {};

            var ifModifiedKey,
                responseHeadersString,
                responseHeaders,
                transport,
                timeoutTimer,
                parts,
                fireGlobals,
                i,
                s = $.jqx.data.ajaxSetup({}, options),
                callbackContext = s.context || s,
                globalEventContext = callbackContext !== s &&
                    (callbackContext.nodeType || callbackContext instanceof jQuery) ?
                            jQuery(callbackContext) : jQuery.event,
                deferred = jQuery.Deferred(),
                completeDeferred = jQuery.Callbacks("once memory"),
                statusCode = s.statusCode || {},
                requestHeaders = {},
                requestHeadersNames = {},
                state = 0,
                strAbort = "canceled",
                jqXHR = {
                    readyState: 0,
                    setRequestHeader: function (name, value) {
                        if (!state) {
                            var lname = name.toLowerCase();
                            name = requestHeadersNames[lname] = requestHeadersNames[lname] || name;
                            requestHeaders[name] = value;
                        }
                        return this;
                    },
                    getAllResponseHeaders: function () {
                        return state === 2 ? responseHeadersString : null;
                    },
                    getResponseHeader: function (key) {
                        var match;
                        if (state === 2) {
                            if (!responseHeaders) {
                                responseHeaders = {};
                                while ((match = rheaders.exec(responseHeadersString))) {
                                    responseHeaders[match[1].toLowerCase()] = match[2];
                                }
                            }
                            match = responseHeaders[key.toLowerCase()];
                        }
                        return match === undefined ? null : match;
                    },

                    overrideMimeType: function (type) {
                        if (!state) {
                            s.mimeType = type;
                        }
                        return this;
                    },

                    abort: function (statusText) {
                        statusText = statusText || strAbort;
                        if (transport) {
                            transport.abort(statusText);
                        }
                        done(0, statusText);
                        return this;
                    }
                };

            function done(status, nativeStatusText, responses, headers) {
                var isSuccess, success, error, response, modified,
                    statusText = nativeStatusText;

                if (state === 2) {
                    return;
                }

                state = 2;
                if (timeoutTimer) {
                    clearTimeout(timeoutTimer);
                }

                transport = undefined;
                responseHeadersString = headers || "";
                jqXHR.readyState = status > 0 ? 4 : 0;

                if (responses) {
                    response = ajaxHandleResponses(s, jqXHR, responses);
                }

                if (status >= 200 && status < 300 || status === 304) {

                    if (s.ifModified) {

                        modified = jqXHR.getResponseHeader("Last-Modified");
                        if (modified) {
                            jQuery.lastModified[ifModifiedKey] = modified;
                        }
                        modified = jqXHR.getResponseHeader("Etag");
                        if (modified) {
                            jQuery.etag[ifModifiedKey] = modified;
                        }
                    }

                    if (status === 304) {
                        statusText = "notmodified";
                        isSuccess = true;
                    } else {

                        isSuccess = ajaxConvert(s, response);
                        statusText = isSuccess.state;
                        success = isSuccess.data;
                        error = isSuccess.error;
                        isSuccess = !error;
                    }
                } else {
                    error = statusText;
                    if (!statusText || status) {
                        statusText = "error";
                        if (status < 0) {
                            status = 0;
                        }
                    }
                }

                jqXHR.status = status;
                jqXHR.statusText = (nativeStatusText || statusText) + "";

                if (isSuccess) {
                    deferred.resolveWith(callbackContext, [success, statusText, jqXHR]);
                } else {
                    deferred.rejectWith(callbackContext, [jqXHR, statusText, error]);
                }

                jqXHR.statusCode(statusCode);
                statusCode = undefined;

                if (fireGlobals) {
                    globalEventContext.trigger("ajax" + (isSuccess ? "Success" : "Error"),
                            [jqXHR, s, isSuccess ? success : error]);
                }

                completeDeferred.fireWith(callbackContext, [jqXHR, statusText]);

                if (fireGlobals) {
                    globalEventContext.trigger("ajaxComplete", [jqXHR, s]);
                    if (!(--jQuery.active)) {
                        jQuery.event.trigger("ajaxStop");
                    }
                }
            }

            deferred.promise(jqXHR);
            jqXHR.success = jqXHR.done;
            jqXHR.error = jqXHR.fail;
            jqXHR.complete = completeDeferred.add;

            jqXHR.statusCode = function (map) {
                if (map) {
                    var tmp;
                    if (state < 2) {
                        for (tmp in map) {
                            statusCode[tmp] = [statusCode[tmp], map[tmp]];
                        }
                    } else {
                        tmp = map[jqXHR.status];
                        jqXHR.always(tmp);
                    }
                }
                return this;
            };

            s.url = ((url || s.url) + "").replace(rhash, "").replace(rprotocol, ajaxLocParts[1] + "//");
            s.dataTypes = jQuery.trim(s.dataType || "*").toLowerCase().split(core_rspace);

            if (s.crossDomain == null) {
                parts = rurl.exec(s.url.toLowerCase());
                s.crossDomain = !!(parts &&
                    (parts[1] !== ajaxLocParts[1] || parts[2] !== ajaxLocParts[2] ||
                        (parts[3] || (parts[1] === "http:" ? 80 : 443)) !=
                            (ajaxLocParts[3] || (ajaxLocParts[1] === "http:" ? 80 : 443)))
                );
            }

            if (s.data && s.processData && typeof s.data !== "string") {
                s.data = jQuery.param(s.data, s.traditional);
            }

            inspectPrefiltersOrTransports(prefilters, s, options, jqXHR);

            if (state === 2) {
                return jqXHR;
            }

            fireGlobals = s.global;
            s.type = s.type.toUpperCase();
            s.hasContent = !rnoContent.test(s.type);

            if (fireGlobals && jQuery.active++ === 0) {
                jQuery.event.trigger("ajaxStart");
            }

            if (!s.hasContent) {
                if (s.data) {
                    s.url += (rquery.test(s.url) ? "&" : "?") + s.data;
                    delete s.data;
                }

                ifModifiedKey = s.url;

                if (s.cache === false) {

                    var ts = jQuery.now(),
                        ret = s.url.replace(rts, "$1_=" + ts);

                    s.url = ret + ((ret === s.url) ? (rquery.test(s.url) ? "&" : "?") + "_=" + ts : "");
                }
            }

            if (s.data && s.hasContent && s.contentType !== false || options.contentType) {
                jqXHR.setRequestHeader("Content-Type", s.contentType);
            }

            if (s.ifModified) {
                ifModifiedKey = ifModifiedKey || s.url;
                if (jQuery.lastModified[ifModifiedKey]) {
                    jqXHR.setRequestHeader("If-Modified-Since", jQuery.lastModified[ifModifiedKey]);
                }
                if (jQuery.etag[ifModifiedKey]) {
                    jqXHR.setRequestHeader("If-None-Match", jQuery.etag[ifModifiedKey]);
                }
            }

            jqXHR.setRequestHeader(
                "Accept",
                s.dataTypes[0] && s.accepts[s.dataTypes[0]] ?
                    s.accepts[s.dataTypes[0]] + (s.dataTypes[0] !== "*" ? ", " + allTypes + "; q=0.01" : "") :
                    s.accepts["*"]
            );

            for (i in s.headers) {
                jqXHR.setRequestHeader(i, s.headers[i]);
            }

            if (s.beforeSend && (s.beforeSend.call(callbackContext, jqXHR, s) === false || state === 2)) {
                return jqXHR.abort();

            }

            strAbort = "abort";

            for (i in { success: 1, error: 1, complete: 1 }) {
                jqXHR[i](s[i]);
            }

            transport = inspectPrefiltersOrTransports(transports, s, options, jqXHR);

            if (!transport) {
                done(-1, "No Transport");
            } else {
                jqXHR.readyState = 1;
                if (fireGlobals) {
                    globalEventContext.trigger("ajaxSend", [jqXHR, s]);
                }
                if (s.async && s.timeout > 0) {
                    timeoutTimer = setTimeout(function () {
                        jqXHR.abort("timeout");
                    }, s.timeout);
                }

                try {
                    state = 1;
                    transport.send(requestHeaders, done);
                } catch (e) {
                    if (state < 2) {
                        done(-1, e);
                    } else {
                        throw e;
                    }
                }
            }

            return jqXHR;
        },

        active: 0,

        lastModified: {},
        etag: {}

    });

    function ajaxHandleResponses(s, jqXHR, responses) {

        var ct, type, finalDataType, firstDataType,
            contents = s.contents,
            dataTypes = s.dataTypes,
            responseFields = s.responseFields;

        for (type in responseFields) {
            if (type in responses) {
                jqXHR[responseFields[type]] = responses[type];
            }
        }

        while (dataTypes[0] === "*") {
            dataTypes.shift();
            if (ct === undefined) {
                ct = s.mimeType || jqXHR.getResponseHeader("content-type");
            }
        }

        if (ct) {
            for (type in contents) {
                if (contents[type] && contents[type].test(ct)) {
                    dataTypes.unshift(type);
                    break;
                }
            }
        }

        if (dataTypes[0] in responses) {
            finalDataType = dataTypes[0];
        } else {
            for (type in responses) {
                if (!dataTypes[0] || s.converters[type + " " + dataTypes[0]]) {
                    finalDataType = type;
                    break;
                }
                if (!firstDataType) {
                    firstDataType = type;
                }
            }
            finalDataType = finalDataType || firstDataType;
        }

        if (finalDataType) {
            if (finalDataType !== dataTypes[0]) {
                dataTypes.unshift(finalDataType);
            }
            return responses[finalDataType];
        }
    }

    function ajaxConvert(s, response) {
        var conv, conv2, current, tmp,
            dataTypes = s.dataTypes.slice(),
            prev = dataTypes[0],
            converters = {},
            i = 0;

        if (s.dataFilter) {
            response = s.dataFilter(response, s.dataType);
        }

        if (dataTypes[1]) {
            for (conv in s.converters) {
                converters[conv.toLowerCase()] = s.converters[conv];
            }
        }

        for (; (current = dataTypes[++i]) ;) {
            if (current !== "*") {
                if (prev !== "*" && prev !== current) {
                    conv = converters[prev + " " + current] || converters["* " + current];

                    if (!conv) {
                        for (conv2 in converters) {
                            tmp = conv2.split(" ");
                            if (tmp[1] === current) {
                                conv = converters[prev + " " + tmp[0]] ||
                                    converters["* " + tmp[0]];
                                if (conv) {
                                    if (conv === true) {
                                        conv = converters[conv2];

                                    } else if (converters[conv2] !== true) {
                                        current = tmp[0];
                                        dataTypes.splice(i--, 0, current);
                                    }

                                    break;
                                }
                            }
                        }
                    }

                    if (conv !== true) {
                        if (conv && s["throws"]) {
                            response = conv(response);
                        } else {
                            try {
                                response = conv(response);
                            } catch (e) {
                                return { state: "parsererror", error: conv ? e : "No conversion from " + prev + " to " + current };
                            }
                        }
                    }
                }

                prev = current;
            }
        }

        return { state: "success", data: response };
    }
    var oldCallbacks = [],
        rquestion = /\?/,
        rjsonp = /(=)\?(?=&|$)|\?\?/,
        nonce = jQuery.now();

    $.jqx.data.ajaxSetup({
        jsonp: "callback",
        jsonpCallback: function () {
            var callback = oldCallbacks.pop() || (jQuery.expando + "_" + (nonce++));
            this[callback] = true;
            return callback;
        }
    });

    $.jqx.data.ajaxPrefilter("json jsonp", function (s, originalSettings, jqXHR) {

        var callbackName, overwritten, responseContainer,
            data = s.data,
            url = s.url,
            hasCallback = s.jsonp !== false,
            replaceInUrl = hasCallback && rjsonp.test(url),
            replaceInData = hasCallback && !replaceInUrl && typeof data === "string" &&
                !(s.contentType || "").indexOf("application/x-www-form-urlencoded") &&
                rjsonp.test(data);

        if (s.dataTypes[0] === "jsonp" || replaceInUrl || replaceInData) {

            callbackName = s.jsonpCallback = jQuery.isFunction(s.jsonpCallback) ?
                s.jsonpCallback() :
                s.jsonpCallback;
            overwritten = window[callbackName];

            if (replaceInUrl) {
                s.url = url.replace(rjsonp, "$1" + callbackName);
            } else if (replaceInData) {
                s.data = data.replace(rjsonp, "$1" + callbackName);
            } else if (hasCallback) {
                s.url += (rquestion.test(url) ? "&" : "?") + s.jsonp + "=" + callbackName;
            }

            s.converters["script json"] = function () {
                if (!responseContainer) {
                    jQuery.error(callbackName + " was not called");
                }
                return responseContainer[0];
            };

            s.dataTypes[0] = "json";

            window[callbackName] = function () {
                responseContainer = arguments;
            };

            jqXHR.always(function () {
                window[callbackName] = overwritten;
                if (s[callbackName]) {
                    s.jsonpCallback = originalSettings.jsonpCallback;

                    oldCallbacks.push(callbackName);
                }

                if (responseContainer && jQuery.isFunction(overwritten)) {
                    overwritten(responseContainer[0]);
                }

                responseContainer = overwritten = undefined;
            });

            return "script";
        }
    });

    $.jqx.data.ajaxSetup({
        accepts: {
            script: "text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"
        },
        contents: {
            script: /javascript|ecmascript/
        },
        converters: {
            "text script": function (text) {
                jQuery.globalEval(text);
                return text;
            }
        }
    });

    $.jqx.data.ajaxPrefilter("script", function (s) {
        if (s.cache === undefined) {
            s.cache = false;
        }
        if (s.crossDomain) {
            s.type = "GET";
            s.global = false;
        }
    });

    $.jqx.data.ajaxTransport("script", function (s) {
        if (s.crossDomain) {
            var script,
                head = document.head || document.getElementsByTagName("head")[0] || document.documentElement;

            return {

                send: function (_, callback) {

                    script = document.createElement("script");

                    script.async = "async";

                    if (s.scriptCharset) {
                        script.charset = s.scriptCharset;
                    }

                    script.src = s.url;

                    script.onload = script.onreadystatechange = function (_, isAbort) {

                        if (isAbort || !script.readyState || /loaded|complete/.test(script.readyState)) {

                            script.onload = script.onreadystatechange = null;

                            if (head && script.parentNode) {
                                head.removeChild(script);
                            }

                            script = undefined;

                            if (!isAbort) {
                                callback(200, "success");
                            }
                        }
                    };
                    head.insertBefore(script, head.firstChild);
                },

                abort: function () {
                    if (script) {
                        script.onload(0, 1);
                    }
                }
            };
        }
    });
    var xhrCallbacks,
        xhrOnUnloadAbort = window.ActiveXObject ? function () {
            for (var key in xhrCallbacks) {
                xhrCallbacks[key](0, 1);
            }
        } : false,
        xhrId = 0;

    function createStandardXHR() {
        try {
            return new window.XMLHttpRequest();
        } catch (e) { }
    }

    function createActiveXHR() {
        try {
            return new window.ActiveXObject("Microsoft.XMLHTTP");
        } catch (e) { }
    }

    $.jqx.data.ajaxSettings.xhr = window.ActiveXObject ?
        function () {
            return !this.isLocal && createStandardXHR() || createActiveXHR();
        } :
        createStandardXHR;

    (function (xhr) {
        jQuery.extend(jQuery.support, {
            ajax: !!xhr,
            cors: !!xhr && ("withCredentials" in xhr)
        });
    })($.jqx.data.ajaxSettings.xhr());

    if (jQuery.support.ajax) {

        $.jqx.data.ajaxTransport(function (s) {
            if (!s.crossDomain || jQuery.support.cors) {

                var callback;

                return {
                    send: function (headers, complete) {

                        var handle, i,
                            xhr = s.xhr();

                        if (s.username) {
                            xhr.open(s.type, s.url, s.async, s.username, s.password);
                        } else {
                            xhr.open(s.type, s.url, s.async);
                        }

                        if (s.xhrFields) {
                            for (i in s.xhrFields) {
                                xhr[i] = s.xhrFields[i];
                            }
                        }

                        if (s.mimeType && xhr.overrideMimeType) {
                            xhr.overrideMimeType(s.mimeType);
                        }


                        if (!s.crossDomain && !headers["X-Requested-With"]) {
                            headers["X-Requested-With"] = "XMLHttpRequest";
                        }

                        try {
                            for (i in headers) {
                                xhr.setRequestHeader(i, headers[i]);
                            }
                        } catch (_) { }

                        xhr.send((s.hasContent && s.data) || null);

                        callback = function (_, isAbort) {

                            var status,
                                statusText,
                                responseHeaders,
                                responses,
                                xml;
                            try {

                                if (callback && (isAbort || xhr.readyState === 4)) {
                                    callback = undefined;
                                    if (handle) {
                                        xhr.onreadystatechange = jQuery.noop;
                                        if (xhrOnUnloadAbort) {
                                            delete xhrCallbacks[handle];
                                        }
                                    }

                                    if (isAbort) {
                                        if (xhr.readyState !== 4) {
                                            xhr.abort();
                                        }
                                    } else {
                                        status = xhr.status;
                                        responseHeaders = xhr.getAllResponseHeaders();
                                        responses = {};
                                        xml = xhr.responseXML;

                                        if (xml && xml.documentElement /* #4958 */) {
                                            responses.xml = xml;
                                        }

                                        try {
                                            responses.text = xhr.responseText;
                                        } catch (e) {
                                        }

                                        try {
                                            statusText = xhr.statusText;
                                        } catch (e) {
                                            statusText = "";
                                        }

                                        if (!status && s.isLocal && !s.crossDomain) {
                                            status = responses.text ? 200 : 404;
                                        } else if (status === 1223) {
                                            status = 204;
                                        }
                                    }
                                }
                            } catch (firefoxAccessException) {
                                if (!isAbort) {
                                    complete(-1, firefoxAccessException);
                                }
                            }

                            if (responses) {
                                complete(status, statusText, responses, responseHeaders);
                            }
                        };

                        if (!s.async) {
                            callback();
                        } else if (xhr.readyState === 4) {
                            setTimeout(callback, 0);
                        } else {
                            handle = ++xhrId;
                            if (xhrOnUnloadAbort) {
                                if (!xhrCallbacks) {
                                    xhrCallbacks = {};
                                    jQuery(window).unload(xhrOnUnloadAbort);
                                }
                                xhrCallbacks[handle] = callback;
                            }
                            xhr.onreadystatechange = callback;
                        }
                    },

                    abort: function () {
                        if (callback) {
                            callback(0, 1);
                        }
                    }
                };
            }
        });
    }
    $.jqx.filter = function () {
        this.operator = 'and';
        var and_operator = 0;
        var or_operator = 1;
        var stringcomparisonoperators = ['EMPTY', 'NOT_EMPTY', 'CONTAINS', 'CONTAINS_CASE_SENSITIVE',
        'DOES_NOT_CONTAIN', 'DOES_NOT_CONTAIN_CASE_SENSITIVE', 'STARTS_WITH', 'STARTS_WITH_CASE_SENSITIVE',
        'ENDS_WITH', 'ENDS_WITH_CASE_SENSITIVE', 'EQUAL', 'EQUAL_CASE_SENSITIVE', 'NULL', 'NOT_NULL'];
        var numericcomparisonoperators = ['EQUAL', 'NOT_EQUAL', 'LESS_THAN', 'LESS_THAN_OR_EQUAL', 'GREATER_THAN', 'GREATER_THAN_OR_EQUAL', 'NULL', 'NOT_NULL'];
        var datecomparisonoperators = ['EQUAL', 'NOT_EQUAL', 'LESS_THAN', 'LESS_THAN_OR_EQUAL', 'GREATER_THAN', 'GREATER_THAN_OR_EQUAL', 'NULL', 'NOT_NULL'];
        var booleancomparisonoperators = ['EQUAL', 'NOT_EQUAL'];

        var filters = new Array();
        var comparisonoperators = new Array();

        this.evaluate = function (value) {
            var result = true;
            for (var i = 0; i < filters.length; i++) {
                var currentResult = filters[i].evaluate(value);
                if (i == 0) {
                    result = currentResult;
                }
                else {
                    if (comparisonoperators[i] == or_operator || comparisonoperators[i] == "or")
                        result = result || currentResult;
                    else
                        result = result && currentResult;
                }
            }

            return result;
        }

        this.getfilterscount = function () {
            return filters.length;
        }

        this.setoperatorsbyfiltertype = function (type, array) {
            switch (type) {
                case "numericfilter":
                    numericcomparisonoperators = array;
                    break;
                case "stringfilter":
                    stringcomparisonoperators = array;
                    break;
                case "datefilter":
                    datecomparisonoperators = array;
                    break;
                case "booleanfilter":
                    booleancomparisonoperators = array;
                    break;
            }
        }

        this.getoperatorsbyfiltertype = function (type) {
            var array = new Array();
            switch (type) {
                case "numericfilter":
                    array = numericcomparisonoperators.slice(0);
                    break;
                case "stringfilter":
                    array = stringcomparisonoperators.slice(0);
                    break;
                case "datefilter":
                    array = datecomparisonoperators.slice(0);
                    break;
                case "booleanfilter":
                    array = booleancomparisonoperators.slice(0);
                    break;
            }
            return array;
        }

        var generatefilterkey = function () {
            var S4 = function () {
                return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
            };
            return (S4() + "-" + S4() + "-" + S4());
        }

        this.createfilter = function (filtertype, filtervalue, filtercomparisonoperator, customfilter, formatstring, localization) {
            if (filtertype == null || filtertype == undefined)
                return null;

            switch (filtertype) {
                case 'numericfilter':
                    return new numericfilter(filtervalue, filtercomparisonoperator.toUpperCase());
                case 'stringfilter':
                    return new stringfilter(filtervalue, filtercomparisonoperator.toUpperCase());
                case 'datefilter':
                    return new datefilter(filtervalue, filtercomparisonoperator.toUpperCase(), formatstring, localization);
                case 'booleanfilter':
                    return new booleanfilter(filtervalue, filtercomparisonoperator.toUpperCase());
                case 'custom':
                    return new filter(filtervalue, filtercomparisonoperator.toUpperCase(), customfilter);
            }

            throw new Error("jqxGrid: There is no such filter type. The available filter types are: 'numericfilter', 'stringfilter', 'datefilter' and 'booleanfilter'");
            return null;
        }

        this.getfilters = function () {
            var filtersarray = new Array();
            for (var i = 0; i < filters.length; i++) {
                var filter = { value: filters[i].filtervalue, condition: filters[i].comparisonoperator, operator: comparisonoperators[i], type: filters[i].type };
                filtersarray[i] = filter;
            }
            return filtersarray;
        }

        this.addfilter = function (comparisonoperator, filter) {
            filters[filters.length] = filter;
            filter.key = generatefilterkey();
            comparisonoperators[comparisonoperators.length] = comparisonoperator;
        }

        this.removefilter = function (filter) {
            for (var i = 0; i < filters.length; i++) {
                if (filters[i].key == filter.key) {
                    filters.splice(i, 1);
                    comparisonoperators.splice(i, 1);
                    break;
                }
            }
        }

        this.getoperatorat = function (index) {
            if (index == undefined || index == null)
                return null;

            if (index < 0 || index > filters.length)
                return null;

            return comparisonoperators[index];
        }

        this.setoperatorat = function (index, comparisonoperator) {
            if (index == undefined || index == null)
                return null;

            if (index < 0 || index > filters.length)
                return null;

            comparisonoperators[comparisonoperator] = comparisonoperator;
        }

        this.getfilterat = function (index) {
            if (index == undefined || index == null)
                return null;

            if (index < 0 || index > filters.length)
                return null;

            return filters[index];
        }

        this.setfilterat = function (index, filter) {
            if (index == undefined || index == null)
                return null;

            if (index < 0 || index > filters.length)
                return null;

            filter.key = generatefilterkey();
            filters[index] = filter;
        }

        this.clear = function () {
            filters = new Array();
            comparisonoperators = new Array();
        }

        var stringfilter = function (filtervalue, comparisonoperator) {
            this.filtervalue = filtervalue;
            this.comparisonoperator = comparisonoperator;
            this.type = 'stringfilter';
            this.evaluate = function (value) {
                var filtervalue = this.filtervalue;
                var comparisonoperator = this.comparisonoperator;
                if (value == null || value == undefined || value == "") {
                    if (comparisonoperator == 'NULL')
                        return true;

                    return false;
                }

                var val = "";
                try {
                    val = value.toString();
                }
                catch (error) {
                    return true;
                }

                switch (comparisonoperator) {
                    case 'EQUAL':
                        return $.jqx.string.equalsIgnoreCase(val, filtervalue);
                    case 'EQUAL_CASE_SENSITIVE':
                        return $.jqx.string.equals(val, filtervalue);
                    case 'NOT_EQUAL':
                        return !$.jqx.string.equalsIgnoreCase(val, filtervalue);
                    case 'NOT_EQUAL_CASE_SENSITIVE':
                        return !$.jqx.string.equals(val, filtervalue);
                    case 'CONTAINS':
                        return $.jqx.string.containsIgnoreCase(val, filtervalue);
                    case 'CONTAINS_CASE_SENSITIVE':
                        return $.jqx.string.contains(val, filtervalue);
                    case 'DOES_NOT_CONTAIN':
                        return !$.jqx.string.containsIgnoreCase(val, filtervalue);
                    case 'DOES_NOT_CONTAIN_CASE_SENSITIVE':
                        return !$.jqx.string.contains(val, filtervalue);
                    case 'EMPTY':
                        return val == '';
                    case 'NOT_EMPTY':
                        return val != '';
                    case 'NOT_NULL':
                        return val != null;
                    case 'STARTS_WITH':
                        return $.jqx.string.startsWithIgnoreCase(val, filtervalue);
                    case 'ENDS_WITH':
                        return $.jqx.string.endsWithIgnoreCase(val, filtervalue);
                    case 'ENDS_WITH_CASE_SENSITIVE':
                        return $.jqx.string.endsWith(val, filtervalue);
                    case 'STARTS_WITH_CASE_SENSITIVE':
                        return $.jqx.string.startsWith(val, filtervalue);
                    default:
                        return false;
                }
            }
        }

        var booleanfilter = function (filtervalue, comparisonoperator) {
            this.filtervalue = filtervalue;
            this.comparisonoperator = comparisonoperator;
            this.type = 'booleanfilter';
            this.evaluate = function (value) {
                var filtervalue = this.filtervalue;
                var comparisonoperator = this.comparisonoperator;
                if (value == null || value == undefined) {
                    if (comparisonoperator == 'NULL')
                        return true;

                    return false;
                }

                var val = value;

                switch (comparisonoperator) {
                    case 'EQUAL':
                        return val == filtervalue || val.toString() == filtervalue.toString();
                    case 'NOT_EQUAL':
                        return val != filtervalue && val.toString() != filtervalue.toString();
                    default:
                        return false;
                }
            }
        }

        var numericfilter = function (filtervalue, comparisonoperator) {
            this.filtervalue = filtervalue;
            this.comparisonoperator = comparisonoperator;
            this.type = 'numericfilter';
            this.evaluate = function (value) {
                var filtervalue = this.filtervalue;
                var comparisonoperator = this.comparisonoperator;
                if (value === null || value === undefined || value === "") {
                    if (comparisonoperator == 'NOT_NULL')
                        return false;

                    if (comparisonoperator == 'NULL')
                        return true;
                    else
                        return false;
                }
                else {
                    if (comparisonoperator == 'NULL')
                        return false;

                    if (comparisonoperator == 'NOT_NULL')
                        return true;
                }

                var val = value;

                try {
                    val = parseFloat(val);
                }
                catch (error) {
                    if (value.toString() != "")
                        return false;
                }

                switch (comparisonoperator) {
                    case 'EQUAL':
                        return val == filtervalue;
                    case 'NOT_EQUAL':
                        return val != filtervalue;
                    case 'GREATER_THAN':
                        return val > filtervalue;
                    case 'GREATER_THAN_OR_EQUAL':
                        return val >= filtervalue;
                    case 'LESS_THAN':
                        return val < filtervalue;
                    case 'LESS_THAN_OR_EQUAL':
                        return val <= filtervalue;
                    case 'STARTS_WITH':
                        return $.jqx.string.startsWithIgnoreCase(val.toString(), filtervalue.toString());
                    case 'ENDS_WITH':
                        return $.jqx.string.endsWithIgnoreCase(val.toString(), filtervalue.toString());
                    case 'ENDS_WITH_CASE_SENSITIVE':
                        return $.jqx.string.endsWith(val.toString(), filtervalue.toString());
                    case 'STARTS_WITH_CASE_SENSITIVE':
                        return $.jqx.string.startsWith(val.toString(), filtervalue.toString());
                    case 'CONTAINS':
                        return $.jqx.string.containsIgnoreCase(val.toString(), filtervalue.toString());
                    case 'CONTAINS_CASE_SENSITIVE':
                        return $.jqx.string.contains(val.toString(), filtervalue.toString());
                    case 'DOES_NOT_CONTAIN':
                        return !$.jqx.string.containsIgnoreCase(val.toString(), filtervalue.toString());
                    case 'DOES_NOT_CONTAIN_CASE_SENSITIVE':
                        return !$.jqx.string.contains(val.toString(), filtervalue.toString());
                    default:
                        return true;
                }
            }
        }

        var datefilter = function (filtervalue, comparisonoperator, formatstring, localization) {
            this.filtervalue = filtervalue;
            this.type = 'datefilter';

            if (formatstring != undefined && localization != undefined) {
                var parsedDate = $.jqx.dataFormat.parsedate(filtervalue, formatstring, localization);
                if (parsedDate != null) {
                    this.filterdate = parsedDate;
                }
                else {
                    var result = $.jqx.dataFormat.tryparsedate(filtervalue, localization);
                    if (result != null) this.filterdate = result;
                }

            }
            else {
                var tmpvalue = new Date(filtervalue);
                if (tmpvalue.toString() == 'NaN' || tmpvalue.toString() == "Invalid Date") {
                    this.filterdate = $.jqx.dataFormat.tryparsedate(filtervalue);
                }
                else {
                    this.filterdate = tmpvalue;
                }
            }
            if (!this.filterdate) {
                var tmpvalue = new Date(filtervalue);
                if (tmpvalue.toString() == 'NaN' || tmpvalue.toString() == "Invalid Date") {
                    this.filterdate = $.jqx.dataFormat.tryparsedate(filtervalue);
                }
                else {
                    this.filterdate = tmpvalue;
                }
            }

            this.comparisonoperator = comparisonoperator;
            this.evaluate = function (value) {
                var filtervalue = this.filtervalue;
                var comparisonoperator = this.comparisonoperator;
                if (value == null || value == undefined || value == "") {
                    if (comparisonoperator == 'NOT_NULL')
                        return false;

                    if (comparisonoperator == 'NULL')
                        return true;
                    else
                        return false;
                }
                else {
                    if (comparisonoperator == 'NULL')
                        return false;

                    if (comparisonoperator == 'NOT_NULL')
                        return true;
                }

                var val = new Date();
                val.setFullYear(1900, 0, 1);
                val.setHours(12, 0, 0, 0);
                try {
                    var tmpvalue = new Date(value);

                    if (tmpvalue.toString() == 'NaN' || tmpvalue.toString() == "Invalid Date") {
                        value = $.jqx.dataFormat.tryparsedate(value);
                    }
                    else {
                        value = tmpvalue;
                    }
                    val = value;
                }
                catch (error) {
                    if (value.toString() != "")
                        return false;
                }

                if (this.filterdate != null) {
                    filtervalue = this.filterdate;
                }
                else {
                    if (filtervalue.indexOf) {
                        if (filtervalue.indexOf(':') != -1 || !isNaN(parseInt(filtervalue))) {
                            var tmpFilter = new Date(val);
                            tmpFilter.setHours(12, 0, 0, 0);
                            var timeStrings = filtervalue.split(':');
                            for (var i = 0; i < timeStrings.length; i++) {
                                if (i == 0) {
                                    tmpFilter.setHours(timeStrings[i]);
                                }
                                if (i == 1) {
                                    tmpFilter.setMinutes(timeStrings[i]);
                                }
                                if (i == 2) {
                                    tmpFilter.setSeconds(timeStrings[i]);
                                }
                            }
                            filtervalue = tmpFilter;
                        }
                    }
                }

                if (val == null) val = "";
                switch (comparisonoperator) {
                    case 'EQUAL':
                        return val.toString() == filtervalue.toString();
                    case 'NOT_EQUAL':
                        return val.toString() != filtervalue.toString();
                    case 'GREATER_THAN':
                        return val > filtervalue;
                    case 'GREATER_THAN_OR_EQUAL':
                        return val >= filtervalue;
                    case 'LESS_THAN':
                        return val < filtervalue;
                    case 'LESS_THAN_OR_EQUAL':
                        return val <= filtervalue;
                    case 'STARTS_WITH':
                        return $.jqx.string.startsWithIgnoreCase(val.toString(), filtervalue.toString());
                    case 'ENDS_WITH':
                        return $.jqx.string.endsWithIgnoreCase(val.toString(), filtervalue.toString());
                    case 'ENDS_WITH_CASE_SENSITIVE':
                        return $.jqx.string.endsWith(val.toString(), filtervalue.toString());
                    case 'STARTS_WITH_CASE_SENSITIVE':
                        return $.jqx.string.startsWith(val.toString(), filtervalue.toString());
                    case 'CONTAINS':
                        return $.jqx.string.containsIgnoreCase(val.toString(), filtervalue.toString());
                    case 'CONTAINS_CASE_SENSITIVE':
                        return $.jqx.string.contains(val.toString(), filtervalue.toString());
                    case 'DOES_NOT_CONTAIN':
                        return !$.jqx.string.containsIgnoreCase(val.toString(), filtervalue.toString());
                    case 'DOES_NOT_CONTAIN_CASE_SENSITIVE':
                        return !$.jqx.string.contains(val.toString(), filtervalue.toString());
                    default:
                        return true;
                }
            }
        }

        var filter = function (filtervalue, comparisonoperator, customfilter) {
            this.filtervalue = filtervalue;
            this.comparisonoperator = comparisonoperator;
            this.evaluate = function (value, comparisonoperator) {
                return customfilter(this.filtervalue, value, this.comparisonoperator);
            }
        }
    };
})(jQuery);(function ($) {

    $.jqx.jqxWidget('jqxValidator', '', {});

    $.extend($.jqx._jqxValidator.prototype, {

        defineInstance: function () {
            this.rules = null;
            this.scroll = true;
            this.focus = true;
            this.scrollDuration = 300;
            this.scrollCallback = null;
            this.position = 'right';
            this.arrow = true;
            this.animation = 'fade';
            this.animationDuration = 150;
            this.closeOnClick = true;
            this.onError = null;
            this.onSuccess = null;
            this.ownerElement = null;
            this._events = ['validationError', 'validationSuccess'];
            this.hintPositionOffset = 5;
            this._inputHint = [];
            this.rtl = false;
            this.hintType = "tooltip";
        },

        createInstance: function () {
            if (this.hintType == "label" && this.animationDuration == 150) {
                this.animationDuration = 0;
            }
            this._configureInputs();
            this._removeEventListeners();
            this._addEventListeners();
        },

        destroy: function () {
            this._removeEventListeners();
            this.hide();
        },

        validate: function (result) {
            var valid = true,
                temp,
                minTop = Infinity,
                currentTop,
                topElement,
                tempElement,
                invalid = [],
                minTopElement;
            this.updatePosition();
            var me = this;
            var ruleFuncsCount = 0;
      
            for (var i = 0; i < this.rules.length; i += 1) {
                if (typeof this.rules[i].rule === 'function') {
                    ruleFuncsCount++;
                }
            }
            this.positions = new Array();
            for (var i = 0; i < this.rules.length; i += 1) {
               var input = $(this.rules[i].input);
               if (typeof this.rules[i].rule === 'function') {
                   var validate = function (isValid, rule) {
                       temp = isValid;
                       if (false == temp) {
                           valid = false;
                           var input = $(rule.input);
                           tempElement = $(rule.input);
                           invalid.push(tempElement);
                           currentTop = tempElement.offset().top;
                           if (minTop > currentTop) {
                               minTop = currentTop;
                               topElement = tempElement;
                           }
                       }
                       ruleFuncsCount--;
                       if (ruleFuncsCount == 0) {
                           if (typeof result === 'function') {
                               me._handleValidation(valid, minTop, topElement, invalid);
                               if (result) result(valid);
                           }
                       }
                   }
                   this._validateRule(this.rules[i], validate);
               }
               else {
                   temp = this._validateRule(this.rules[i]);
               }
                if (false == temp) {
                    valid = false;
                    tempElement = $(this.rules[i].input);
                    invalid.push(tempElement);
                    currentTop = tempElement.offset().top;
                    if (minTop > currentTop) {
                        minTop = currentTop;
                        topElement = tempElement;
                    }
                }
           }

            if (ruleFuncsCount == 0) {
                this._handleValidation(valid, minTop, topElement, invalid);
                return valid;
            }
            else {
                return undefined;
            }
        },

        validateInput: function (input) {
            var rules = this._getRulesForInput(input),
                valid = true;

            for (var i = 0; i < rules.length; i += 1) {
                if (!this._validateRule(rules[i])) {
                    valid = false;
                }
            }
            return valid;
        },

        hideHint: function (input) {
            var rules = this._getRulesForInput(input);
            for (var i = 0; i < rules.length; i += 1) {
                this._hideHintByRule(rules[i]);
            }
        },

        hide: function () {
            var rule;
            for (var i = 0; i < this.rules.length; i += 1) {
                rule = this.rules[i];
                this._hideHintByRule(this.rules[i]);
            }
        },

        updatePosition: function () {
            var rule;
            this.positions = new Array();
            for (var i = 0; i < this.rules.length; i += 1) {
                rule = this.rules[i];
                if (rule.hint) {
                    this._hintLayout(rule.hint, $(rule.input), rule.position,rule);
                }
            }
        },

        _getRulesForInput: function (input) {
            var rules = [];
            for (var i = 0; i < this.rules.length; i += 1) {
                if (this.rules[i].input === input) {
                    rules.push(this.rules[i]);
                }
            }
            return rules;
        },

        _validateRule: function (rule, validate) {
            var input = $(rule.input),
                hint,
                valid = true;
            var me = this;
            var commit = function (isValid) {
                if (!isValid) {
                    var temp = me.animation;
                    me.animation = null;
                    if (rule.hint) {
                        me._hideHintByRule(rule);
                    }

                    hint = rule.hintRender.apply(me, [rule.message, input]);
                    me._hintLayout(hint, input, rule.position, rule);
                    me._showHint(hint);
                    rule.hint = hint;
                    me._removeLowPriorityHints(rule);
                    if (validate) validate(false, rule);
                    me.animation = temp;
                }
                else {
                    me._hideHintByRule(rule);
                    if (validate) validate(true, rule);
                }
            }

            var ruleResult = false;
            if (typeof rule.rule === 'function') {
                ruleResult = rule.rule.call(this, input, commit);
                if (ruleResult == true && validate) validate(true, rule);
            }

            if (typeof rule.rule === 'function' && ruleResult == false) {
                if (typeof rule.hintRender === 'function' && !rule.hint && !this._higherPriorityActive(rule) && input.is(':visible')) {
                    hint = rule.hintRender.apply(this, [rule.message, input]);
                    this._hintLayout(hint, input, rule.position, rule);
                    this._showHint(hint);
                    rule.hint = hint;
                    this._removeLowPriorityHints(rule);
                }
                valid = false;
                if (validate) validate(false, rule);
            } else {
                this._hideHintByRule(rule);
            }
            return valid;
        },

        _hideHintByRule: function (rule) {
            var input = $(rule.input);
        
            var self = this,
                hint;
            var removeErrorClass = function () {
                if (self.hintType != "label") {
                    return;
                }

                var that = self;
                if (that.position == "top" || that.position == "left") {
                    if (input.prev().hasClass('.jqx-validator-error-label'))
                        return;
                }
                else {
                    if (input.next().hasClass('.jqx-validator-error-label'))
                        return;
                }

                if (input[0].nodeName.toLowerCase() != "input") {
                    if (input.find('input').length > 0) {
                        if (input.find('.jqx-input').length > 0) {
                            input.find('.jqx-input').removeClass(that.toThemeProperty('jqx-validator-error-element'));
                        }
                        else if (input.is('.jqx-checkbox')) {
                            input.find('.jqx-checkbox-default').removeClass(that.toThemeProperty('jqx-validator-error-element'));
                        }
                        if (input.is('.jqx-radiobutton')) {
                            input.find('.jqx-radiobutton-default').removeClass(that.toThemeProperty('jqx-validator-error-element'));
                        }
                        else {
                            input.removeClass(that.toThemeProperty('jqx-validator-error-element'));
                        }
                    }
                }
                else {
                    input.removeClass(that.toThemeProperty('jqx-validator-error-element'));
                }
            }

            if (rule) {
                hint = rule.hint;
                if (hint) {
                    if (this.positions) {
                        if (this.positions[Math.round(hint.offset().top) + "_" + Math.round(hint.offset().left)]) {
                            this.positions[Math.round(hint.offset().top) + "_" + Math.round(hint.offset().left)] = null;
                        }
                    }

                    if (this.animation === 'fade') {
                        hint.fadeOut(this.animationDuration, function () {
                            hint.remove();
                            removeErrorClass();
                        });
                    } else {
                        hint.remove();
                        removeErrorClass();
                    }
                }
                rule.hint = null;
            }
        },

        _handleValidation: function (valid, minTop, topElement, invalid) {
            if (!valid) {
                this._scrollHandler(minTop);
                if (this.focus) {
                    topElement.focus()
                }
                this._raiseEvent(0, { invalidInputs: invalid });
                if (typeof this.onError === 'function') {
                    this.onError(invalid);
                }
            } else {
                this._raiseEvent(1);
                if (typeof this.onSuccess === 'function') {
                    this.onSuccess();
                }
            }
        },

        _scrollHandler: function (minTop) {
            if (this.scroll) {
                var self = this;
                $('html,body').animate({ scrollTop: minTop }, this.scrollDuration, function () {
                    if (typeof self.scrollCallback === 'function') {
                        self.scrollCallback.call(self);
                    }
                });
            }
        },

        _higherPriorityActive: function (rule) {
            var reach = false,
                current;
            for (var i = this.rules.length - 1; i >= 0; i -= 1) {
                current = this.rules[i];
                if (reach && current.input === rule.input && current.hint) {
                    return true;
                }
                if (current === rule) {
                    reach = true;
                }
            }
            return false;
        },

        _removeLowPriorityHints: function (rule) {
            var reach = false,
                current;
            for (var i = 0; i < this.rules.length; i += 1) {
                current = this.rules[i];
                if (reach && current.input === rule.input) {
                    this._hideHintByRule(current);
                }
                if (current === rule) {
                    reach = true;
                }
            }
        },

        _getHintRuleByInput: function (input) {
            var current;
            for (var i = 0; i < this.rules.length; i += 1) {
                current = this.rules[i];
                if ($(current.input)[0] === input[0] && current.hint) {
                    return current;
                }
            }
            return null;
        },

        _removeEventListeners: function () {
            var rule,
                input,
                listeners;
            for (var i = 0; i < this.rules.length; i += 1) {
                rule = this.rules[i];
                listeners = rule.action.split(',');
                input = $(rule.input);
                for (var j = 0; j < listeners.length; j += 1) {
                    this.removeHandler(input, $.trim(listeners[j]) + '.jqx-validator');
                }
            }
        },

        _addEventListeners: function () {
            var rule, input;
            if (this.host.parents('.jqx-window').length > 0) {
                var self = this;
                var update = function () {
                    self.updatePosition();
                }

                var window = this.host.parents('.jqx-window');
                this.addHandler(window, 'closed',
                function () {
                    self.hide()
                 });
                this.addHandler(window, 'moved', update);
                this.addHandler(window, 'moving', update);
                this.addHandler(window, 'resized', update);
                this.addHandler(window, 'resizing', update);
                this.addHandler($(document.parentWindow), 'scroll', function () {
                    update();
                });
            }

            for (var i = 0; i < this.rules.length; i += 1) {
                rule = this.rules[i];
                input = $(rule.input);
                this._addListenerTo(input, rule);
            }
        },

        _addListenerTo: function (input, rule) {
            var self = this,
                listeners = rule.action.split(',');

            var isJQWidget = false;
            if (this._isjQWidget(input)) {
                isJQWidget = true;
            }

            for (var i = 0; i < listeners.length; i += 1) {
                var event = $.trim(listeners[i]);

                if (isJQWidget && (event == 'blur' || event == 'focus')) {
                    input = input.find('input');
                }

                this.addHandler(input, event + '.jqx-validator', function (event) {
                    self._validateRule(rule);
                });
            }
        },

        _configureInputs: function () {
            var input,
                count;
            this.rules = this.rules || [];
            for (var i = 0; i < this.rules.length; i += 1) {
                this._handleInput(i);
            }
        },

        _handleInput: function (ruleId) {
            var rule = this.rules[ruleId];
            if (!rule['position']) {
                rule['position'] = this.position;
            }
            if (!rule['message']) {
                rule['message'] = 'Validation Failed!';
            }
            if (!rule['action']) {
                rule['action'] = 'blur';
            }
            if (!rule['hintRender']) {
                rule['hintRender'] = this._hintRender;
            }
            if (!rule['rule']) {
                rule['rule'] = null;
            } else {
                this._handleRule(rule);
            }
        },

        _handleRule: function (rule) {
            var validation = rule.rule,
                func,
                parameters,
                wrongParameter = false;
            if (typeof validation === 'string') {
                if (validation.indexOf('=') >= 0) {
                    validation = validation.split('=');
                    parameters = validation[1].split(',');
                    validation = validation[0];
                }
                func = this['_' + validation];
                if (func) {
                    rule.rule = function (input, commit) {
                        return func.apply(this, [input].concat(parameters));
                    };
                } else {
                    wrongParameter = true;
                }
            } else {
                if (typeof validation !== 'function') {
                    wrongParameter = true;
                } else {
                    rule.rule = validation;
                }
            }
            if (wrongParameter) {
                throw new Error('Wrong parameter!');
            }
        },

        _required: function (input) {
            switch (this._getType(input)) {
                case 'textarea':
                case 'password':
                case 'jqx-input':
                case 'text':
                    var data = $.data(input[0]);
                    if (data.jqxMaskedInput) {
                        var promptChar = input.jqxMaskedInput('promptChar'),
                            value = input.jqxMaskedInput('value');
                        return value && value.indexOf(promptChar) < 0;
                    } else if (data.jqxNumberInput) {
                        return input.jqxNumberInput('inputValue') !== '';
                    } else if (data.jqxDateTimeInput) {
                        return true;
                    } else {
                        return $.trim(input.val()) !== '';
                    }
                case 'checkbox':
                    return input.is(':checked');
                case 'radio':
                    return input.is(':checked');
                case 'div':
                    if (input.is('.jqx-checkbox')) {
                        return input.jqxCheckBox('checked');
                    }
                    if (input.is('.jqx-radiobutton')) {
                        return input.jqxRadioButton('checked');
                    }
                    return false;
            }
            return false;
        },

        _notNumber: function (input) {
            return this._validateText(input, function (text) {
                if (text == "")
                    return true;

                var re = /\d/;
                return !re.test(text);
            });
        },

        _startWithLetter: function (input) {
            return this._validateText(input, function (text) {
                if (text == "")
                    return true;

                var re = /\d/;
                return !re.test(text.substring(0, 1));
            });
        },

        _number: function (input) {
            return this._validateText(input, function (text) {
                if (text == "")
                    return true;
                var value = new Number(text);
                return !isNaN(value) && isFinite(value)
            });
        },

        _phone: function (input) {
            return this._validateText(input, function (text) {
                if (text == "")
                    return true;

                var phone = /^\(\d{3}\)(\d){3}-(\d){4}$/;
                return phone.test(text);
            });
        },

        _length: function (input, min, max) {
            return this._minLength(input, min) && this._maxLength(input, max);
        },

        _maxLength: function (input, len) {
            len = parseInt(len, 10);
            return this._validateText(input, function (text) {
                return text.length <= len;
            });
        },

        _minLength: function (input, len) {
            len = parseInt(len, 10);
            return this._validateText(input, function (text) {
                return text.length >= len;
            });
        },

        _email: function (input) {
            return this._validateText(input, function (text) {
                if (text == "")
                    return true;

                var email = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                return email.test(text);
            });
        },

        _zipCode: function (input) {
            return this._validateText(input, function (text) {
                if (text == "")
                    return true;

                var zip = /^(^\d{5}$)|(^\d{5}-\d{4}$)|(\d{3}-\d{2}-\d{4})$/;
                return zip.test(text);
            });
        },

        _ssn: function (input) {
            return this._validateText(input, function (text) {
                if (text == "")
                    return true;

                var ssn = /\d{3}-\d{2}-\d{4}/;
                return ssn.test(text);
            });
        },

        _validateText: function (input, condition) {
            var value;
            if (this._isTextInput(input)) {
                if (this._isjQWidget(input)) {
                    value = input.find('input').val()
                } else {
                    value = input.val();
                }
                return condition(value);
            }
            return false;
        },

        _isjQWidget: function (input) {
            var data = $.data(input[0]);
            if (data.jqxMaskedInput || data.jqxNumberInput || data.jqxDateTimeInput) {
                return true;
            }
            return false;
        },

        _isTextInput: function (input) {
            var type = this._getType(input);
            return type === 'text' || type === 'textarea' || type === 'password' || input.is('.jqx-input');
        },

        _getType: function (input) {
            var tag = input[0].tagName.toLowerCase(),
                type;
            if (tag === 'textarea') {
                return 'textarea';
            } else if (input.is('.jqx-input')) {
                return 'jqx-input';
            } else if (tag === 'input') {
                type = $(input).attr('type') ? $(input).attr('type').toLowerCase() : 'text';
                return type;
            }
            return tag;
        },

        _hintRender: function (message, input) {
            if (this.hintType == "label") {
                var hint = $('<label class="' + this.toThemeProperty('jqx-validator-error-label') + '"></label>');
                hint.html(message);
                var that = this;
                if (this.closeOnClick) {
                    hint.click(function () {
                        that.hideHint(input.selector);
                    });
                }
                if (this.position == "left" || this.position == "top") {
                    hint.insertBefore($(input));
                }
                else {
                    hint.insertAfter($(input));
                }

                return hint;
            }

            var hint = $('<div class="' + this.toThemeProperty('jqx-validator-hint') + ' jqx-rc-all"></div>'),
                self = this;
            hint.html(message);
            if (this.closeOnClick) {
                hint.click(function () {
                    self.hideHint(input.selector);
                });
            }
            if (this.ownerElement == null) {
                hint.appendTo(document.body);
            }
            else {
                if (this.ownerElement.innerHTML) {
                    hint.appendTo($(this.ownerElement));
                }
                else hint.appendTo(this.ownerElement);
            }

            return hint;
        },

        _hintLayout: function (hint, input, position, rule) {
            if (this._hintRender === rule.hintRender) {
                var pos;
                pos = this._getPosition(input, position, hint, rule);
                if (this.hintType == 'label') {
                    var top = "2px";
                    if (this.position == "left" || this.position == "top") top = "-2px";
                    if (input[0].nodeName.toLowerCase() != "input") {
                        if (input.find('input').length > 0) {
                            if (input.find('.jqx-input').length > 0) {
                                input.find('.jqx-input').addClass(this.toThemeProperty('jqx-validator-error-element'));
                            }
                            else if (input.is('.jqx-checkbox')) {
                                input.find('.jqx-checkbox-default').addClass(this.toThemeProperty('jqx-validator-error-element'));
                            }
                            if (input.is('.jqx-radiobutton')) {
                                input.find('.jqx-radiobutton-default').addClass(this.toThemeProperty('jqx-validator-error-element'));
                            }
                            else {
                                input.addClass(this.toThemeProperty('jqx-validator-error-element'));
                            }
                        }
                    }
                    else {
                        input.addClass(this.toThemeProperty('jqx-validator-error-element'));
                    }

                    var hintMeasure = $("<span></span>");
                    hintMeasure.addClass(this.toThemeProperty('jqx-validator-hint'));
                    hintMeasure.html(hint.text());
                    hintMeasure.appendTo($(document.body));
                    var hintWidth = hintMeasure.outerWidth();
                    hintMeasure.remove();
                    hint.css({
                        position: 'relative',
                        left: $(input).css('margin-left'),
                        width: $(input).width(),
                        top: top
                    });
                    if (position == "center") {
                 //       var left = parseInt($(input).css('margin-left')) + $(input).position().left + ($(input).width() - hintWidth) / 2;
                        //     hint.css('left', left);
                        hint.css('width', hintWidth);
                        hint.css('left', '0px');
                        hint.css('margin-left', 'auto');
                        hint.css('margin-right', 'auto');
                    }
                    return;
                }

                hint.css({
                    position: 'absolute',
                    left: pos.left,
                    top: pos.top
                });
                if (this.arrow) {
                    this._addArrow(input, hint, position, pos);
                }
            }
        },

        _showHint: function (hint) {
            if (hint) {
                if (this.animation === 'fade') {
                    hint.fadeOut(0);
                    hint.fadeIn(this.animationDuration);
                }
            }
        },

        _getPosition: function (input, position, hint, rule) {
            var offset = input.offset(),
                top, left;
            var width = input.outerWidth();
            var height = input.outerHeight();

            if (this.rtl && position.indexOf('left') >= 0) position = 'right';
            if (this.rtl && position.indexOf('right') >= 0) position = 'left';

            if (this.ownerElement != null) {
                offset = { left: 0, top: 0 };
                offset.top = parseInt(offset.top) + input.position().top;
                offset.left = parseInt(offset.left) + input.position().left;
            }

            if (rule && rule.hintPositionRelativeElement) {
                var $hintPositionRelativeElement = $(rule.hintPositionRelativeElement);
                offset =  $hintPositionRelativeElement.offset();
                width = $hintPositionRelativeElement.width();
                height = $hintPositionRelativeElement.height();
            }

            if (position.indexOf('top') >= 0) {
                top = offset.top - height;
            } else if (position.indexOf('bottom') >= 0) {
                top = offset.top + hint.outerHeight() + this.hintPositionOffset + 5;
            } else {
                top = offset.top;
            }
            if (position.indexOf('center') >= 0) {
                left = offset.left + this.hintPositionOffset + (width - hint.outerWidth()) / 2;
            } else if (position.indexOf('left') >= 0) {
                left = offset.left - hint.outerWidth() - this.hintPositionOffset;
            } else if (position.indexOf('right') >= 0) {
                left = offset.left + width + this.hintPositionOffset;
            } else {
                left = offset.left + this.hintPositionOffset;
            }
            if (position.indexOf(':') >= 0) {
                position = position.split(':')[1].split(',');
                left += parseInt(position[0], 10);
                top += parseInt(position[1], 10);
            }
            if (!this.positions) this.positions = new Array();
            if (this.positions[Math.round(top) + "_" + Math.round(left)]) {
                if (this.positions[Math.round(top) + "_" + Math.round(left)].top == top) top += input.outerHeight();
            }

            this.positions[Math.round(top) + "_" + Math.round(left)] = {
                left: left,
                top: top
            };

            return {
                left: left,
                top: top
            };
        },

        _addArrow: function (input, hint, position, coordinates) {
            var arrow = $('<div class="' + this.toThemeProperty('jqx-validator-hint-arrow') + '"></div>'),
                left,
                top;
            if (this.rtl && position.indexOf('left') >= 0) position = 'right';
            if (this.rtl && position.indexOf('right') >= 0) position = 'left';

            hint.children('.jqx-validator-hint-arrow').remove();
            hint.append(arrow);
            var aH = arrow.outerHeight(),
                aW = arrow.outerWidth(),
                hH = hint.outerHeight(),
                hW = hint.outerWidth();
            this._addImage(arrow);
            if (position.indexOf('top') >= 0) {
                top = hH - aH;
            } else if (position.indexOf('bottom') >= 0) {
                top = -aH;
            } else {
                top = (hH - aH) / 2 - aH / 2;
            }
            if (position.indexOf('center') >= 0) {
                left = (hW - aW) / 2;
            } else if (position.indexOf('left') >= 0) {
                left = hW - aW / 2 - 1;
            } else if (position.indexOf('right') >= 0) {
                left = -aW / 2;
            }
            if (position.indexOf('topright') >= 0 || position.indexOf('bottomright') >= 0) {
                left = 0;
            }
            if (position.indexOf('topleft') >= 0 || position.indexOf('bottomleft') >= 0) {
                left = hW - aW;
            }
            arrow.css({
                position: 'absolute',
                left: left,
                top: top
            });
        },

        _addImage: function (arrow) {
            var imgUrl = arrow.css('background-image');
            imgUrl = imgUrl.replace('url("', '');
            imgUrl = imgUrl.replace('")', '');
            imgUrl = imgUrl.replace('url(', '');
            imgUrl = imgUrl.replace(')', '');
            arrow.css('background-image', 'none');
            arrow.append('<img src="' + imgUrl + '" alt="Arrow" style="position: relative; ' +
            'top: 0px; left: 0px; width: ' + arrow.width() + 'px; height: ' + arrow.height() + 'px;" />');
        },

        _raiseEvent: function (eventId, data) {
            var event = $.Event(this._events[eventId]);
            event.args = data;
            return this.host.trigger(event);
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (key === 'rules') {
                this._configureInputs();
                this._removeEventListeners();
                this._addEventListeners();
            }
        }
    });
})(jQuery);
(function ($) {
    $.jqx.cssroundedcorners = function (value) {
        var cssMap = {
            'all': 'jqx-rc-all',
            'top': 'jqx-rc-t',
            'bottom': 'jqx-rc-b',
            'left': 'jqx-rc-l',
            'right': 'jqx-rc-r',
            'top-right': 'jqx-rc-tr',
            'top-left': 'jqx-rc-tl',
            'bottom-right': 'jqx-rc-br',
            'bottom-left': 'jqx-rc-bl'
        };

        for (prop in cssMap) {
            if (!cssMap.hasOwnProperty(prop))
                continue;

            if (value == prop)
                return cssMap[prop];
        }
    }

    $.jqx.jqxWidget("jqxButton", "", {});

    $.extend($.jqx._jqxButton.prototype, {
        defineInstance: function () {
            this.cursor = 'arrow';
            // rounds the button corners.
            this.roundedCorners = 'all';
            // enables / disables the button
            this.disabled = false;
            // sets height to the button.
            this.height = null;
            // sets width to the button.
            this.width = null;
            this.overrideTheme = false;
            this.enableHover = true;
            this.enableDefault = true;
            this.enablePressed = true;
            this.rtl = false;
            this._ariaDisabled = false;
            this.aria =
            {
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
        },

        createInstance: function (args) {
            var self = this;
            this._setSize();

            if (!this._ariaDisabled) {
                this.host.attr('role', 'button');
            }
            if (!this.overrideTheme) {
                this.host.addClass(this.toThemeProperty($.jqx.cssroundedcorners(this.roundedCorners)));
                if (this.enableDefault) {
                    this.host.addClass(this.toThemeProperty('jqx-button'));
                }
                this.host.addClass(this.toThemeProperty('jqx-widget'));
            }

            this.isTouchDevice = $.jqx.mobile.isTouchDevice();
            if (!this._ariaDisabled) {
                $.jqx.aria(this);
            }

            if (this.cursor != 'arrow') {
                if (!this.disabled) {
                    this.host.css({ cursor: this.cursor });
                }
                else {
                    this.host.css({ cursor: 'arrow' });
                }
            }

            this.addHandler(this.host, 'mouseenter mouseleave mousedown focus blur', function (event) {
                switch (event.type) {
                    case 'mouseenter':
                        if (!this.isTouchDevice) {
                            if (!self.disabled && self.enableHover) {
                                self.isMouseOver = true;
                                self.refresh();
                            }
                        }
                        break;
                    case 'mouseleave':
                        if (!this.isTouchDevice) {
                            if (!self.disabled && self.enableHover) {
                                self.isMouseOver = false;
                                self.refresh();
                            }
                        }
                        break;
                    case 'mousedown':
                        if (!self.disabled) {
                            self.isPressed = true;
                            self.refresh();
                        }
                        break;
                    case 'focus':
                        if (!self.disabled) {
                            self.isFocused = true;
                            self.refresh();
                        }
                        break;
                    case 'blur':
                        if (!self.disabled) {
                            self.isFocused = false;
                            self.refresh();
                        }
                        break;
                }
            });

            this.mouseupfunc = function (event) {
                if (!self.disabled) {
                    self.isPressed = false;
                    self.refresh();
                }
            }

            this.addHandler($(document), 'mouseup.button' + this.element.id, this.mouseupfunc);

            try {
                if (document.referrer != "" || window.frameElement) {
                    if (window.top != null && window.top != window.self) {
                        var parentLocation = '';
                        if (window.parent && document.referrer) {
                            parentLocation = document.referrer;
                        }

                        if (parentLocation.indexOf(document.location.host) != -1) {
                            var eventHandle = function (event) {
                                self.isPressed = false;
                                self.refresh();
                            };

                            if (window.top.document) {
                                this.addHandler($(window.top.document), 'mouseup', eventHandle);
                            }
                        }
                    }
                }
            }
            catch (error) {
            }
            
            this.propertyChangeMap['roundedCorners'] = function (instance, key, oldVal, value) {
                instance.refresh();
            };
            this.propertyChangeMap['width'] = function (instance, key, oldVal, value) {
                instance._setSize();
                instance.refresh();
            };
            this.propertyChangeMap['height'] = function (instance, key, oldVal, value) {
                instance._setSize();
                instance.refresh();
            };
            this.propertyChangeMap['disabled'] = function (instance, key, oldVal, value) {
                if (oldVal != value) {
                    instance.host[0].disabled = value;
                    instance.host.attr('disabled', value);
                    instance.refresh();
                    if (!value) {
                        instance.host.css({ cursor: instance.cursor });
                    }
                    else {
                        instance.host.css({ cursor: 'default' });
                    }

                    $.jqx.aria(instance, "aria-disabled", instance.disabled);
                }
            };
            this.propertyChangeMap['rtl'] = function (instance, key, oldVal, value) {
                if (oldVal != value) {
                    instance.refresh();
                }
            };
            this.propertyChangeMap['theme'] = function (instance, key, oldVal, value) {
                instance.host.removeClass();

                instance.host.addClass(instance.toThemeProperty('jqx-button'));
                instance.host.addClass(instance.toThemeProperty('jqx-widget'));
                if (!instance.overrideTheme) {
                    instance.host.addClass(instance.toThemeProperty($.jqx.cssroundedcorners(instance.roundedCorners)));
                }
                instance._oldCSSCurrent = null;
                instance.refresh();
            };
            if (this.disabled) {
                this.element.disabled = true;
                this.host.attr('disabled', true);
            }
        }, // createInstance

        val: function () {
            var input = this.host.find('input');
            if (input.length > 0) {
                if (arguments.length == 0 || typeof (value) == "object") {
                    return input.val();
                }
                input.val(value);
                this.refresh();
                return input.val();
            }

            if (arguments.length == 0 || typeof (value) == "object") {
                if (this.element.nodeName.toLowerCase() == "button") {
                    return $(this.element).text();
                }
                return this.element.value;
            }
            this.element.value = arguments[0];
            if (this.element.nodeName.toLowerCase() == "button") {
                $(this.element).text(arguments[0]);
            }

            this.refresh();
        },

        _setSize: function () {
            if (this.width != null && (this.width.toString().indexOf("px") != -1 || this.width.toString().indexOf("%") != -1)) {
                this.host.css('width', this.width);
            }
            else {
                if (this.width != undefined && !isNaN(this.width)) {
                    this.host.css('width', this.width);
                }
            }
            if (this.height != null && (this.height.toString().indexOf("px") != -1 || this.height.toString().indexOf("%") != -1)) {
                this.host.css('height', this.height);
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                this.host.css('height', parseInt(this.height));
            }
        },

        _removeHandlers: function () {
            this.removeHandler(this.host, 'selectstart');
            this.removeHandler(this.host, 'click');
            this.removeHandler(this.host, 'focus');
            this.removeHandler(this.host, 'blur');
            this.removeHandler(this.host, 'mouseenter');
            this.removeHandler(this.host, 'mouseleave');
            this.removeHandler(this.host, 'mousedown');
            this.removeHandler($(document), 'mouseup.button' + this.element.id, this.mouseupfunc);
            this.mouseupfunc = null;
            delete this.mouseupfunc;
        },

        focus: function()
        {
            this.host.focus();
        },

        destroy: function () {
            this._removeHandlers();
            var vars = $.data(this.element, "jqxButton");
            if (vars) {
                delete vars.instance;
            }
            this.host.removeClass();
            this.host.removeData();
            this.host.remove();
            delete this.set;
            delete this.get;
            delete this.call;
            delete this.propertyChangeMap['roundedCorners'];
            delete this.propertyChangeMap['width'];
            delete this.propertyChangeMap['height'];
            delete this.propertyChangeMap['disabled'];
            delete this.propertyChangeMap['rtl'];
            delete this.propertyChangeMap['theme'];
            delete this.propertyChangeMap;
            delete this.element;
            delete this.host;
        },

        render: function()
        {
            this.refresh();
        },

        refresh: function () {
            if (this.overrideTheme)
                return;

            var cssFocused = this.toThemeProperty('jqx-fill-state-focus');
            var cssDisabled = this.toThemeProperty('jqx-fill-state-disabled');
            var cssNormal = this.toThemeProperty('jqx-fill-state-normal');
            if (!this.enableDefault) {
                cssNormal = "";
            }

            var cssHover = this.toThemeProperty('jqx-fill-state-hover');
            var cssPressed = this.toThemeProperty('jqx-fill-state-pressed');
            var cssPressedHover = this.toThemeProperty('jqx-fill-state-pressed');
            if (!this.enablePressed) {
                cssPressed = "";
            }
            var cssCurrent = '';
            if (!this.host) {
                return;
            }

            this.host[0].disabled = this.disabled;

            if (this.disabled) {
                cssCurrent = cssDisabled;
            }
            else {
                if (this.isMouseOver && !this.isTouchDevice) {
                    if (this.isPressed)
                        cssCurrent = cssPressedHover;
                    else
                        cssCurrent = cssHover;
                }
                else {
                    if (this.isPressed)
                        cssCurrent = cssPressed;
                    else
                        cssCurrent = cssNormal;
                }
            }

            if (this.isFocused) {
                cssCurrent += " " + cssFocused;
            }

            if (cssCurrent != this._oldCSSCurrent) {
                if (this._oldCSSCurrent) {
                    this.host.removeClass(this._oldCSSCurrent);
                }
                this.host.addClass(cssCurrent);
                this._oldCSSCurrent = cssCurrent;
            }
            if (this.rtl) {
                this.host.addClass(this.toThemeProperty('jqx-rtl'));
                this.host.css('direction', 'rtl');
            }
        }
    });

    //// LinkButton
    $.jqx.jqxWidget("jqxLinkButton", "", {});

    $.extend($.jqx._jqxLinkButton.prototype, {
        defineInstance: function () {
            // enables / disables the button
            this.disabled = false;
            // sets height to the button.
            this.height = null;
            // sets width to the button.
            this.width = null;
            this.rtl = false;
            this.href = null;
        },

        createInstance: function (args) {
            var self = this;
            this.host.onselectstart = function () { return false; };
            this.host.attr('role', 'button');

            var height = this.height || this.host.height();
            var width = this.width || this.host.width();
            this.href = this.host.attr('href');
            this.target = this.host.attr('target');
            this.content = this.host.text();
            this.element.innerHTML = "";
            this.host.append("<input type='button' class='jqx-wrapper'/>");
            var wrapElement = this.host.find('input');
            wrapElement.addClass(this.toThemeProperty('jqx-reset'));
            wrapElement.width(width);
            wrapElement.height(height);
            wrapElement.val(this.content);
            this.host.find('tr').addClass(this.toThemeProperty('jqx-reset'));
            this.host.find('td').addClass(this.toThemeProperty('jqx-reset'));
            this.host.find('tbody').addClass(this.toThemeProperty('jqx-reset'));
            this.host.css('color', 'inherit');
            this.host.addClass(this.toThemeProperty('jqx-link'));

            wrapElement.css({ width: width });
            wrapElement.css({ height: height });
            var param = args == undefined ? {} : args[0] || {};
            wrapElement.jqxButton(param);

            if (this.disabled) {
                this.host[0].disabled = true;
            }

            this.propertyChangeMap['disabled'] = function (instance, key, oldVal, value) {
                instance.host[0].disabled = value;
                instance.host.find('input').jqxButton({ disabled: value });
            }

            this.addHandler(wrapElement, 'click', function (event) {
                if (!this.disabled) {
                    self.onclick(event);
                }
                return false;
            });
        },

        onclick: function (event) {
            if (this.target != null) {
                window.open(this.href, this.target);
            }
            else {
                window.location = this.href;
            }
        }
    });
    //// End of LinkButton

    //// RepeatButton
    $.jqx.jqxWidget("jqxRepeatButton", "jqxButton", {});

    $.extend($.jqx._jqxRepeatButton.prototype, {
        defineInstance: function () {
            this.delay = 50;
        },

        createInstance: function (args) {
            var self = this;

            var isTouchDevice = $.jqx.mobile.isTouchDevice();

            var up = !isTouchDevice ? 'mouseup.' + this.base.element.id : 'touchend.' + this.base.element.id;
            var down = !isTouchDevice ? 'mousedown.' + this.base.element.id : 'touchstart.' + this.base.element.id;

            this.addHandler($(document), up, function (event) {
                if (self.timeout != null) {
                    clearTimeout(self.timeout);
                    self.timeout = null;
                    self.refresh();
                }
                if (self.timer != undefined) {
                    clearInterval(self.timer);
                    self.timer = null;
                    self.refresh();
                }
            });

            this.addHandler(this.base.host, down, function (event) {
                if (self.timer != null) {
                    clearInterval(self.timer);
                }
 
                self.timeout = setTimeout(function () {
                    clearInterval(self.timer);
                    self.timer = setInterval(function (event) { self.ontimer(event); }, self.delay);
                }, 150);
            });

            this.mousemovefunc = function (event) {
                if (!isTouchDevice) {
                    if (event.which == 0) {
                        if (self.timer != null) {
                            clearInterval(self.timer);
                            self.timer = null;
                        }
                    }
                }
            }

            this.addHandler(this.base.host, 'mousemove', this.mousemovefunc);
        },

        destroy: function()
        {
            var isTouchDevice = $.jqx.mobile.isTouchDevice();
            var up = !isTouchDevice ? 'mouseup.' + this.base.element.id : 'touchend.' + this.base.element.id;
            var down = !isTouchDevice ? 'mousedown.' + this.base.element.id : 'touchstart.' + this.base.element.id;
            this.removeHandler(this.base.host, 'mousemove', this.mousemovefunc);
            this.removeHandler(this.base.host, down);
            this.removeHandler($(document), up);
            this.timer = null;
            delete this.mousemovefunc;
            delete this.timer;
            var vars = $.data(this.base.element, "jqxRepeatButton");
            if (vars) {
                delete vars.instance;
            }
            $(this.base.element).removeData();
            this.base.destroy();
            delete this.base;

        },

        stop: function () {
            clearInterval(this.timer);
            this.timer = null;
        },

        ontimer: function (event) {
            var event = new jQuery.Event('click');
            if (this.base != null && this.base.host != null) {
                this.base.host.trigger(event);
            }
        }
    });
    //// End of RepeatButton
    //// ToggleButton
    $.jqx.jqxWidget("jqxToggleButton", "jqxButton", {});

    $.extend($.jqx._jqxToggleButton.prototype, {
        defineInstance: function () {
            this.toggled = false;
            this.aria =
            {
                "aria-checked": { name: "toggled", type: "boolean" },
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
        },

        createInstance: function (args) {
            var self = this;
            this.base.overrideTheme = true;
            this.isTouchDevice = $.jqx.mobile.isTouchDevice();
            $.jqx.aria(this);

            this.propertyChangeMap['toggled'] = function (instance, key, oldVal, value) {
                instance.refresh();
            };
            this.propertyChangeMap['disabled'] = function (instance, key, oldVal, value) {
                self.base.disabled = value;
                instance.refresh();
            };

            this.addHandler(this.base.host, 'click', function (event) {
                if (!self.base.disabled) {
                    self.toggle();
                }
            });

            if (!this.isTouchDevice) {
                this.addHandler(this.base.host, 'mouseenter', function (event) {
                    if (!self.base.disabled) {
                        self.refresh();
                    }
                });

                this.addHandler(this.base.host, 'mouseleave', function (event) {
                    if (!self.base.disabled) {
                        self.refresh();
                    }
                });
            }

            this.addHandler(this.base.host, 'mousedown', function (event) {
                if (!self.base.disabled) {
                    self.refresh();
                }
            });

            this.addHandler($(document), 'mouseup', function (event) {
                if (!self.base.disabled) {
                    self.refresh();
                }
            });
        },

        _removeHandlers: function () {
            this.removeHandler(this.base.host, 'click');
            this.removeHandler(this.base.host, 'mouseenter');
            this.removeHandler(this.base.host, 'mouseleave');
            this.removeHandler(this.base.host, 'mousedown');
            this.removeHandler($(document), 'mouseup');
        },

        toggle: function () {
            this.toggled = !this.toggled;
            this.refresh();
            $.jqx.aria(this, "aria-checked", this.toggled);
        },

        unCheck: function () {
            this.toggled = false;
            this.refresh();
        },

        check: function () {
            this.toggled = true;
            this.refresh();
        },

        refresh: function () {
            var cssDisabled = this.base.toThemeProperty('jqx-fill-state-disabled');
            var cssNormal = this.base.toThemeProperty('jqx-fill-state-normal');
            var cssHover = this.base.toThemeProperty('jqx-fill-state-hover');
            var cssPressed = this.base.toThemeProperty('jqx-fill-state-pressed');
            var cssPressedHover = this.base.toThemeProperty('jqx-fill-state-pressed');
            var cssCurrent = '';
            this.base.host[0].disabled = this.base.disabled;

            if (this.base.disabled) {
                cssCurrent = cssDisabled;
            }
            else {
                if (this.base.isMouseOver && !this.isTouchDevice) {
                    if (this.base.isPressed || this.toggled)
                        cssCurrent = cssPressedHover;
                    else
                        cssCurrent = cssHover;
                }
                else {
                    if (this.base.isPressed || this.toggled)
                        cssCurrent = cssPressed;
                    else
                        cssCurrent = cssNormal;
                }
            }

            if (this.base.host.hasClass(cssDisabled) && cssDisabled != cssCurrent)
                this.base.host.removeClass(cssDisabled);

            if (this.base.host.hasClass(cssNormal) && cssNormal != cssCurrent)
                this.base.host.removeClass(cssNormal);

            if (this.base.host.hasClass(cssHover) && cssHover != cssCurrent)
                this.base.host.removeClass(cssHover);

            if (this.base.host.hasClass(cssPressed) && cssPressed != cssCurrent)
                this.base.host.removeClass(cssPressed);

            if (this.base.host.hasClass(cssPressedHover) && cssPressedHover != cssCurrent)
                this.base.host.removeClass(cssPressedHover);

            if (!this.base.host.hasClass(cssCurrent))
                this.base.host.addClass(cssCurrent);
        }
    });
    //// End of ToggleButton

})(jQuery);
(function ($) {

    $.jqx.jqxWidget("jqxDropDownButton", "", {});

    $.extend($.jqx._jqxDropDownButton.prototype, {
        defineInstance: function () {
            // enables/disables the dropdownlist.
            this.disabled = false;
            // gets or sets the popup width.
            this.width = null;
            // gets or sets the popup height.
            this.height = null;
            // gets or sets the scrollbars size.
            this.arrowSize = 19;
            // enables/disables the hover state.
            this.enableHover = true;
            // Type: Number
            // Default: 100
            // Showing Popup Animation's delay.
            if (this.openDelay == undefined) {
                this.openDelay = 250;
            }
            // Type: Number
            // Default: 200
            // Hiding Popup Animation's delay.
            if (this.closeDelay == undefined) {
                this.closeDelay = 300;
            }
            // default, none
            // Type: String.
            // enables or disables the animation.
            this.animationType = 'default';
            // Type: Boolean
            // Default: false
            // Enables or disables the browser detection.
            this.enableBrowserBoundsDetection = false;
            this.dropDownHorizontalAlignment = 'left';
            this.popupZIndex = 20000;
            this.autoOpen = false;
            this.rtl = false;
            this.initContent = null;
            this.dropDownWidth = null;
            this.dropDownHeight = null;
            this.aria =
            {
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
            this.events =
	   	    [
            // occurs when the dropdownbutton is opened.
		      'open',
            // occurs when the dropdownbutton is closed.
              'close',
            // occurs when the dropdownbutton is opening.
              'opening',
            // occurs when the dropdownbutton is closing.
              'closing'
            ];
        },

        createInstance: function (args) {
            this.isanimating = false;

            var dropDownButtonStructure = $("<div tabIndex=0 style='background-color: transparent; -webkit-appearance: none; outline: none; width:100%; height: 100%; padding: 0px; margin: 0px; border: 0px; position: relative;'>" +
                "<div id='dropDownButtonWrapper' style='outline: none; background-color: transparent; border: none; float: left; width:100%; height: 100%; position: relative;'>" +
                "<div id='dropDownButtonContent' style='outline: none; background-color: transparent; border: none; float: left; position: relative;'/>" +
                "<div id='dropDownButtonArrow' style='background-color: transparent; border: none; float: right; position: relative;'><div></div></div>" +
                "</div>" +
                "</div>");

            $.jqx.aria(this);
            this.popupContent = this.host.children();
            this.host.attr('role', 'button');
            if (this.popupContent.length == 0) {
                this.popupContent = $('<div>' + this.host.text() + '</div>');
                this.popupContent.css('display', 'block');
                this.element.innerHTML = "";
            }
            else {
                this.popupContent.detach();
            }

            var me = this;
            this.addHandler(this.host, 'loadContent', function (event) {
                me._arrange();
            });

            try {
                var popupID = 'dropDownButtonPopup' + this.element.id;
                var oldContainer = $($.find('#' + popupID));
                if (oldContainer.length > 0) {
                    oldContainer.remove();
                }
                $.jqx.aria(this, "aria-haspopup", true);
                $.jqx.aria(this, "aria-owns", popupID);

                var container = $("<div class='dropDownButton' style='overflow: hidden; left: 0px; top: 0px; position: absolute;' id='dropDownButtonPopup" + this.element.id + "'></div>");
                container.addClass(this.toThemeProperty('jqx-widget-content'));                
                container.addClass(this.toThemeProperty('jqx-dropdownbutton-popup'));
                container.addClass(this.toThemeProperty('jqx-popup'));
                container.addClass(this.toThemeProperty('jqx-rc-all'));
                container.css('z-index', this.popupZIndex);
                if ($.jqx.browser.msie) {
                    container.addClass(this.toThemeProperty('jqx-noshadow'));
                }
                this.popupContent.appendTo(container);
                container.appendTo(document.body);
                this.container = container;
                if (this.animationType == 'none') {
                    this.container.css('visibility', 'hidden');
                }
                else {
                    this.container.css('visibility', 'hidden');
                }
            }
            catch (e) {

            }

            this.touch = $.jqx.mobile.isTouchDevice();
            this.dropDownButtonStructure = dropDownButtonStructure;
            this.host.append(dropDownButtonStructure);

            this.dropDownButtonWrapper = this.host.find('#dropDownButtonWrapper');
            this.dropDownButtonArrow = this.host.find('#dropDownButtonArrow');
            this.arrow = $(this.dropDownButtonArrow.children()[0]);
            this.dropDownButtonContent = this.host.find('#dropDownButtonContent');
            this.dropDownButtonContent.addClass(this.toThemeProperty('jqx-dropdownlist-content'));
            this.dropDownButtonWrapper.addClass(this.toThemeProperty('jqx-disableselect'));
            if (this.rtl) {
                this.dropDownButtonContent.addClass(this.toThemeProperty('jqx-rtl'));
            }

            var self = this;
            if (this.host.parents()) {
                this.addHandler(this.host.parents(), 'scroll.dropdownbutton' + this.element.id, function (event) {
                    var opened = self.isOpened();
                    if (opened) {
                        self.close();
                    }
                });
            }
            this.addHandler(this.dropDownButtonWrapper, 'selectstart', function () { return false; });
            this.dropDownButtonWrapper[0].id = "dropDownButtonWrapper" + this.element.id;
            this.dropDownButtonArrow[0].id = "dropDownButtonArrow" + this.element.id;
            this.dropDownButtonContent[0].id = "dropDownButtonContent" + this.element.id;

            var self = this;
            this.propertyChangeMap['disabled'] = function (instance, key, oldVal, value) {
                if (value) {
                    instance.host.addClass(self.toThemeProperty('jqx-dropdownlist-state-disabled'));
                    instance.host.addClass(self.toThemeProperty('jqx-fill-state-disabled'));
                    instance.dropDownButtonContent.addClass(self.toThemeProperty('jqx-dropdownlist-content-disabled'));
                }
                else {
                    instance.host.removeClass(self.toThemeProperty('jqx-dropdownlist-state-disabled'));
                    instance.host.removeClass(self.toThemeProperty('jqx-fill-state-disabled'));
                    instance.dropDownButtonContent.removeClass(self.toThemeProperty('jqx-dropdownlist-content-disabled'));
                }
                $.jqx.aria(instance, 'aria-disabled', instance.disabled);
            }

            if (this.disabled) {
                this.host.addClass(this.toThemeProperty('jqx-dropdownlist-state-disabled'));
                this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
                this.dropDownButtonContent.addClass(this.toThemeProperty('jqx-dropdownlist-content-disabled'));
            }

            this.host.addClass(this.toThemeProperty('jqx-widget'));
            this.host.addClass(this.toThemeProperty('jqx-widget-content'));
            this.host.addClass(this.toThemeProperty('jqx-dropdownlist-state-normal'));
            this.host.addClass(this.toThemeProperty('jqx-rc-all'));
            this.host.addClass(this.toThemeProperty('jqx-fill-state-normal'));

            this.arrow.addClass(this.toThemeProperty('jqx-icon-arrow-down'));
            this.arrow.addClass(this.toThemeProperty('jqx-icon'));
            this._setSize();
            this.render();
            // fix for IE7
            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                this.container.css('display', 'none');
                if (this.host.parents('.jqx-window').length > 0) {
                    var zIndex = this.host.parents('.jqx-window').css('z-index');
                    container.css('z-index', zIndex + 10);
                    this.container.css('z-index', zIndex + 10);
                }
            }
        },

        // sets the button's content.
        setContent: function (element) {
            this.dropDownButtonContent.children().remove();
            this.dropDownButtonContent[0].innerHTML = "";
            this.dropDownButtonContent.append(element);
        },

        val: function (value) {
            if (arguments.length == 0 || typeof (value) == "object") {
                return this.dropDownButtonContent.text(value);
            }
            else {
                this.dropDownButtonContent.html(value);
            }
        },

        // get the button's content.
        getContent: function () {
            if (this.dropDownButtonContent.children().length > 0) {
                return this.dropDownButtonContent.children();
            }

            return this.dropDownButtonContent.text();
        },

        _setSize: function () {
            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                this.host.width(this.width);
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    this.host.width(this.width);
                };

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                this.host.height(this.height);
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                this.host.height(this.height);
            };

            var isPercentage = false;
            if (this.width != null && this.width.toString().indexOf("%") != -1) {
                isPercentage = true;
                this.host.width(this.width);
            }

            if (this.height != null && this.height.toString().indexOf("%") != -1) {
                isPercentage = true;
                this.host.height(this.height);
            }

            var me = this;
            if (isPercentage) {
                this.refresh(false);      
            }
            $.jqx.utilities.resize(this.host, function () {
                me._arrange();
            });
        },

        // returns true when the popup is opened, otherwise returns false.
        isOpened: function () {
            var me = this;
            var openedpopup = $.data(document.body, "openedJQXButton" + this.element.id);
            if (openedpopup != null && openedpopup == me.popupContent) {
                return true;
            }

            return false;
        },

        focus: function()
        {
            try
            {
                this.host.focus();
            }
            catch (error) {
            }
        },

        render: function () {
            this.removeHandlers();
            var self = this;
            var hovered = false;

            if (!this.touch) {
                this.host.hover(function () {
                    if (!self.disabled && self.enableHover) {
                        hovered = true;
                        self.host.addClass(self.toThemeProperty('jqx-dropdownlist-state-hover'));
                        self.arrow.addClass(self.toThemeProperty('jqx-icon-arrow-down-hover'));
                        self.host.addClass(self.toThemeProperty('jqx-fill-state-hover'));
                    }
                }, function () {
                    if (!self.disabled && self.enableHover) {
                        self.host.removeClass(self.toThemeProperty('jqx-dropdownlist-state-hover'));
                        self.host.removeClass(self.toThemeProperty('jqx-fill-state-hover'));
                        self.arrow.removeClass(self.toThemeProperty('jqx-icon-arrow-down-hover'));
                        hovered = false;
                    }
                });
            }

            if (self.autoOpen) {
                this.addHandler(this.host, 'mouseenter', function () {
                    var isOpened = self.isOpened();
                    if (!isOpened && self.autoOpen) {
                        self.open();
                        self.host.focus();
                    }
                });

                this.addHandler($(document), 'mousemove.' + self.element.id, function (event) {
                    var isOpened = self.isOpened();
                    if (isOpened && self.autoOpen) {
                        var offset = self.host.coord();
                        var top = offset.top;
                        var left = offset.left;
                        var popupOffset = self.container.coord();
                        var popupLeft = popupOffset.left;
                        var popupTop = popupOffset.top;

                        canClose = true;

                        if (event.pageY >= top && event.pageY <= top + self.host.height()) {
                            if (event.pageX >= left && event.pageX < left + self.host.width())
                                canClose = false;
                        }
                        if (event.pageY >= popupTop && event.pageY <= popupTop + self.container.height()) {
                            if (event.pageX >= popupLeft && event.pageX < popupLeft + self.container.width())
                                canClose = false;
                        }

                        if (canClose) {
                            self.close();
                        }
                    }
                });
            }

            this.addHandler(this.dropDownButtonWrapper, 'mousedown',
            function (event) {
                if (!self.disabled) {
                    var isOpen = self.container.css('visibility') == 'visible';
                    if (!self.isanimating) {
                        if (isOpen) {
                            self.close();
                            return false;
                        }
                        else {
                            self.open();
                        }
                    }
                }
            });

            if (this.touch) {
                this.addHandler($(document), $.jqx.mobile.getTouchEventName('touchstart') + '.' + this.element.id, self.closeOpenedDropDown, { me: this, popup: this.container, id: this.element.id });
            }

            this.addHandler($(document), 'mousedown.' + this.element.id, self.closeOpenedDropDown, { me: this, popup: this.container, id: this.element.id });
 
            this.addHandler(this.host, 'keydown', function (event) {
                var isOpen = self.container.css('visibility') == 'visible';

                if (self.host.css('display') == 'none') {
                    return true;
                }

                if (event.keyCode == '13') {
                    if (!self.isanimating) {
                        if (isOpen) {
                            self.close();
                        }
                    }
                }

                if (event.keyCode == 115) {
                    if (!self.isanimating) {
                        if (!self.isOpened()) {
                            self.open();
                        }
                        else if (self.isOpened()) {
                            self.close();
                        }
                    }
                    return false;
                }

                if (event.altKey) {
                    if (self.host.css('display') == 'block') {
                        if (event.keyCode == 38) {
                            if (self.isOpened()) {
                                self.close();
                            }
                        }
                        else if (event.keyCode == 40) {
                            if (!self.isOpened()) {
                                self.open();
                            }
                        }
                    }
                }

                if (event.keyCode == '27') {
                    if (!self.ishiding) {
                        self.close();
                        if (self.tempSelectedIndex != undefined) {
                            self.selectIndex(self.tempSelectedIndex);
                        }
                    }
                }
            });

            this.addHandler(this.host.find('div:first'), 'focus', function () {
                self.host.addClass(self.toThemeProperty('jqx-dropdownlist-state-focus'));
                self.host.addClass(self.toThemeProperty('jqx-fill-state-focus'));
            });
            this.addHandler(this.host.find('div:first'), 'blur', function () {
                self.host.removeClass(self.toThemeProperty('jqx-dropdownlist-state-focus'));
                self.host.removeClass(self.toThemeProperty('jqx-fill-state-focus'));
            });
        },

        removeHandlers: function () {
            var self = this;
            this.removeHandler(this.dropDownButtonWrapper, 'mousedown');
            this.removeHandler(this.host, 'keydown');
            this.removeHandler(this.host.find('div:first'), 'focus');
            this.removeHandler(this.host.find('div:first'), 'blur');
            this.removeHandler(this.host, 'mouseenter');
            this.removeHandler($(document), 'mousemove.' + self.element.id);
        },

        _findPos: function (obj) {
            while (obj && (obj.type == 'hidden' || obj.nodeType != 1 || $.expr.filters.hidden(obj))) {
                obj = obj['nextSibling'];
            }
            var position = $(obj).coord(true);
            return [position.left, position.top];
        },

        testOffset: function (element, offset, inputHeight) {
            var dpWidth = element.outerWidth();
            var dpHeight = element.outerHeight();
            var viewWidth = $(window).width() + $(window).scrollLeft();
            var viewHeight = $(window).height() + $(window).scrollTop();

            // now check if dropdownbutton is showing outside window viewport - move to a better place if so.
            if (offset.left + dpWidth > viewWidth) {
                if (dpWidth > this.host.width()) {
                    var hostLeft = this.host.coord().left;
                    var hOffset = dpWidth - this.host.width();
                    offset.left = hostLeft - hOffset + 2;
                }
            }
            if (offset.left < 0) {
                offset.left = parseInt(this.host.coord().left) + 'px'
            }

            if (offset.top + dpHeight > viewHeight) {
                offset.top -= Math.abs(dpHeight + inputHeight);
            }

            return offset;
        },

        _getBodyOffset: function () {
            var top = 0;
            var left = 0;
            if ($('body').css('border-top-width') != '0px') {
                top = parseInt($('body').css('border-top-width'));
                if (isNaN(top)) top = 0;
            }
            if ($('body').css('border-left-width') != '0px') {
                left = parseInt($('body').css('border-left-width'));
                if (isNaN(left)) left = 0;
            }
            return { left: left, top: top };
        },

        // shows the popup.
        open: function () {
           $.jqx.aria(this, 'aria-expanded', true);

           var self = this;
           if ((this.dropDownWidth == null || this.dropDownWidth == 'auto') && this.width != null && this.width.indexOf && this.width.indexOf('%') != -1) {
                var width = this.host.width();
                this.container.width(parseInt(width));
            }   

            self._raiseEvent('2');
            var popup = this.popupContent;
            var scrollPosition = $(window).scrollTop();
            var scrollLeftPosition = $(window).scrollLeft();
            var top = parseInt(this._findPos(this.host[0])[1]) + parseInt(this.host.outerHeight()) - 1 + 'px';
            var left, leftPos = parseInt(Math.round(this.host.coord(true).left));
            left = leftPos + 'px';

            var isMobileBrowser = $.jqx.mobile.isSafariMobileBrowser() || $.jqx.mobile.isWindowsPhone();
            var hasTransform = $.jqx.utilities.hasTransform(this.host);

            this.ishiding = false;

            this.tempSelectedIndex = this.selectedIndex;

            if (hasTransform || (isMobileBrowser != null && isMobileBrowser)) {
                left = $.jqx.mobile.getLeftPos(this.element);
                top = $.jqx.mobile.getTopPos(this.element) + parseInt(this.host.outerHeight());
                if ($('body').css('border-top-width') != '0px') {
                    top = parseInt(top) - this._getBodyOffset().top + 'px';
                }
                if ($('body').css('border-left-width') != '0px') {
                    left = parseInt(left) - this._getBodyOffset().left + 'px';
                }
            }

            popup.stop();
            this.host.addClass(this.toThemeProperty('jqx-dropdownlist-state-selected'));
            this.host.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
            this.arrow.addClass(this.toThemeProperty('jqx-icon-arrow-down-selected'));

            var ie7 = false;
            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                ie7 = true;
            }

            if (ie7) {
                this.container.css('display', 'block');
            }

            this.container.css('left', left);
            this.container.css('top', top);

            var closeAfterSelection = true;

            var positionChanged = false;

            var align = function () {
                if (this.dropDownHorizontalAlignment == 'right' || this.rtl) {
                    var containerWidth = this.container.width();
                    var containerLeftOffset = Math.abs(containerWidth - this.host.width());

                    if (containerWidth > this.host.width()) {
                        this.container.css('left', parseInt(Math.round(leftPos)) - containerLeftOffset + "px");
                    }
                    else this.container.css('left', parseInt(Math.round(leftPos)) + containerLeftOffset + "px");
                }
            }
  
            align.call(this);

            if (this.enableBrowserBoundsDetection) {
                var newOffset = this.testOffset(popup, { left: parseInt(this.container.css('left')), top: parseInt(top) }, parseInt(this.host.outerHeight()));
                if (parseInt(this.container.css('top')) != newOffset.top) {
                    positionChanged = true;
                    this.container.height(popup.outerHeight());
                    popup.css('top', 23);

                    if (this.interval)
                        clearInterval(this.interval);

                    this.interval = setInterval(function () {
                        if (popup.outerHeight() != self.container.height()) {
                            var newOffset = self.testOffset(popup, { left: parseInt(self.container.css('left')), top: parseInt(top) }, parseInt(self.host.outerHeight()));
                            self.container.css('top', newOffset.top);
                            self.container.height(popup.outerHeight());
                        }
                    }, 50);
                }
                else popup.css('top', 0);
                this.container.css('top', newOffset.top);
                if (parseInt(this.container.css('left')) != newOffset.left) {
                    this.container.css('left', newOffset.left);
                }
            }

            if (this.animationType == 'none') {
                this.container.css('visibility', 'visible');
                $.data(document.body, "openedJQXButtonParent", self);
                $.data(document.body, "openedJQXButton" + this.element.id, popup);
                popup.css('margin-top', 0);
                popup.css('opacity', 1);
                this._raiseEvent('0');
                align.call(self);
            }
            else {
                this.container.css('visibility', 'visible');
                var height = popup.outerHeight();
                self.isanimating = true;
                if (this.animationType == 'fade') {
                    popup.css('margin-top', 0);
                    popup.css('opacity', 0);
                    popup.animate({ 'opacity': 1 }, this.openDelay, function () {
                        $.data(document.body, "openedJQXButtonParent", self);
                        $.data(document.body, "openedJQXButton" + self.element.id, popup);
                        self.ishiding = false;
                        self.isanimating = false;
                        self._raiseEvent('0');
                    });
                    align.call(self);
                }
                else {
                    popup.css('opacity', 1);
                    if (positionChanged) {
                        popup.css('margin-top', height);
                    }
                    else {
                        popup.css('margin-top', -height);
                    }

                    align.call(self);
                    popup.animate({ 'margin-top': 0 }, this.openDelay, function () {
                        $.data(document.body, "openedJQXButtonParent", self);
                        $.data(document.body, "openedJQXButton" + self.element.id, popup);
                        self.ishiding = false;
                        self.isanimating = false;
                        self._raiseEvent('0');
                    });
                }
            }
            if (!positionChanged) {
                this.host.addClass(this.toThemeProperty('jqx-rc-b-expanded'));
                this.container.addClass(this.toThemeProperty('jqx-rc-t-expanded'));
            }
            else {
                this.host.addClass(this.toThemeProperty('jqx-rc-t-expanded'));
                this.container.addClass(this.toThemeProperty('jqx-rc-b-expanded'));
            }
            this.host.find('div:first').focus();
            setTimeout(function () {
                self.host.find('div:first').focus();
            }, 10);
            this.container.addClass(this.toThemeProperty('jqx-fill-state-focus'));
        },

        // hides the popup.
        close: function () {
            $.jqx.aria(this, 'aria-expanded', false);

            var popup = this.popupContent;
            var container = this.container;
            var me = this;
            me._raiseEvent('3');
            var ie7 = false;
            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                ie7 = true;
            }

            if (!this.isOpened()) {
                return;
            }

            $.data(document.body, "openedJQXButton" + this.element.id, null);
            if (this.animationType == 'none') {
                this.container.css('visibility', 'hidden');
                if (ie7) {
                    this.container.css('display', 'none');
                }
            }
            else {
                if (!me.ishiding) {
                    me.isanimating = true;
                    popup.stop();
                    var height = popup.outerHeight();
                    popup.css('margin-top', 0);
                    var animationValue = -height;
                    if (parseInt(this.container.coord().top) < parseInt(this.host.coord().top)) {
                        animationValue = height;
                    }
                    if (this.animationType == 'fade') {
                        popup.css({ 'opacity': 1 });
                        popup.animate({ 'opacity': 0 }, this.closeDelay, function () {
                            container.css('visibility', 'hidden');
                            me.isanimating = false;
                            me.ishiding = false;
                            if (ie7) {
                                container.css('display', 'none');
                            }
                        });
                    }
                    else {
                        popup.animate({ 'margin-top': animationValue }, this.closeDelay, function () {
                            container.css('visibility', 'hidden');
                            me.isanimating = false;
                            me.ishiding = false;
                            if (ie7) {
                                container.css('display', 'none');
                            }
                        });
                    }
                }
            }

            this.ishiding = true;
            this.host.removeClass(this.toThemeProperty('jqx-dropdownlist-state-selected'));
            this.host.removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
            this.arrow.removeClass(this.toThemeProperty('jqx-icon-arrow-down-selected'));
            this.host.removeClass(this.toThemeProperty('jqx-rc-b-expanded'));
            this.container.removeClass(this.toThemeProperty('jqx-rc-t-expanded'));
            this.host.removeClass(this.toThemeProperty('jqx-rc-t-expanded'));
            this.container.removeClass(this.toThemeProperty('jqx-rc-b-expanded'));
            this.container.removeClass(this.toThemeProperty('jqx-fill-state-focus'));

            this._raiseEvent('1');
        },

        /* Close popup if clicked elsewhere. */
        closeOpenedDropDown: function (event) {
            var self = event.data.me;
            var $target = $(event.target);

            if ($(event.target).ischildof(event.data.me.host)) {
                return true;
            }

            if ($(event.target).ischildof(event.data.me.popupContent)) {
                return true;
            }

            var dropdownlistInstance = self;

            var isPopup = false;
            $.each($target.parents(), function () {
                if (this.className != 'undefined') {
                    if (this.className.indexOf && this.className.indexOf('dropDownButton') != -1) {
                        isPopup = true;
                        return false;
                    }
                }
            });

            if (!isPopup) {
                self.close();
            }

            return true;
        },

        refresh: function () {
            this._arrange();
        },

        _arrange: function () {
            var width = parseInt(this.host.width());
            var height = parseInt(this.host.height());
            var arrowHeight = this.arrowSize;
            var arrowWidth = this.arrowSize;
            var rightOffset = 3;
            var contentWidth = width - arrowWidth - 2 * rightOffset;
            if (contentWidth > 0) {
                this.dropDownButtonContent.width(contentWidth + 'px');
            }

            this.dropDownButtonContent.height(height);
            this.dropDownButtonContent.css('left', 0);
            this.dropDownButtonContent.css('top', 0);

            this.dropDownButtonArrow.width(arrowWidth);
            this.dropDownButtonArrow.height(height);
            if (this.rtl) {
                this.dropDownButtonArrow.css('float', 'left');
                this.dropDownButtonContent.css('float', 'right');
                this.dropDownButtonContent.css('left', -rightOffset);
            }
            if (this.dropDownWidth != null) {
                if (this.dropDownWidth.toString().indexOf('%') >= 0) {
                    var width = (parseInt(this.dropDownWidth) * this.host.width()) / 100;
                    this.container.width(width);
                }
                else {
                    this.container.width(this.dropDownWidth);
                }
            }
            if (this.dropDownHeight != null) {
                this.container.height(this.dropDownHeight);
            }
        },

        destroy: function () {
            this.removeHandler(this.dropDownButtonWrapper, 'selectstart');
            this.removeHandler(this.dropDownButtonWrapper, 'mousedown');
            this.removeHandler(this.host, 'keydown');
            this.host.removeClass();
            this.removeHandler($(document), 'mousedown.' + this.element.id, self.closeOpenedDropDown);
            this.host.remove();
            this.container.remove();
        },

        _raiseEvent: function (id, arg) {
            if (arg == undefined)
                arg = { owner: null };

            if (id == 2 && !this.contentInitialized) {
                if (this.initContent) {
                    this.initContent();
                    this.contentInitialized = true;
                }
            }

            var evt = this.events[id];
            args = arg;
            args.owner = this;

            var event = new jQuery.Event(evt);
            event.owner = this;
            if (id == 2 || id == 3 || id == 4) {
                event.args = arg;
            }

            var result = this.host.trigger(event);
            return result;
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (this.isInitialized == undefined || this.isInitialized == false)
                return;

            if (key == "rtl") {
                if (value) {
                    object.dropDownButtonArrow.css('float', 'left');
                    object.dropDownButtonContent.css('float', 'right');
                }
                else {
                    object.dropDownButtonArrow.css('float', 'right');
                    object.dropDownButtonContent.css('float', 'left');
                }
            }

            if (key == 'autoOpen') {
                object.render();
            }

            if (key == 'theme' && value != null) {
                $.jqx.utilities.setTheme(oldvalue, value, object.host);
            }

            if (key == 'width' || key == 'height') {
                object._setSize();
                object._arrange();
            }
        }
    });
})(jQuery);﻿(function ($) {

    $.jqx.jqxWidget("jqxColorPicker", "", {});

    $.extend($.jqx._jqxColorPicker.prototype, {
        defineInstance: function () {
            // enables / disables the button
            this.disabled = false;
            // sets height to the button.
            this.height = null;
            // sets width to the button.
            this.width = null;
            // sets the color.
            this.color = new $.jqx.color({ hex: 'ff0000' });
            this.redString = "R:";
            this.greenString = "G:";
            this.blueString = "B:";
            this.showTransparent = false;
            this.colorMode = "saturation";
            this._delayLoading = false;
            this.events =
			[
               'colorchange',
            ];
        },

        createInstance: function (args) {
            var self = this;

            if (typeof this.color == "string") {
                this.color = new $.jqx.color({ hex: this.color });
            }

            this._setSize();
            this.host.addClass(this.toThemeProperty('jqx-widget'));
            this.host.addClass(this.toThemeProperty('jqx-reset'));
            this.host.addClass(this.toThemeProperty('jqx-color-picker'));

            this.container = $("<div style='width: 100%; height: 100%; position: relative;'></div>");
            this.container.appendTo(this.host);

            this.colorMap = $("<div style='left: 0; top: 0; position: absolute;'></div>");
            this.colorMap.appendTo(this.container);

            this.colorBar = $("<div style='left: 0; top: 0; position: absolute;'></div>");
            this.colorBar.appendTo(this.container);

            this.colorPanel = $("<div style='left: 0; top: 0; position: absolute;'></div>");
            this.colorPanel.appendTo(this.container);

            this.hexPanel = $("<div style='float: left;'></div>");
            this.hexPanel.appendTo(this.colorPanel);
            this.hexPanel.append('<span>#</span>');
            this.hex = $("<input maxlength='6' style='height: 18px;'/>");
            this.hex.addClass(this.toThemeProperty('jqx-input'));
            this.hex.addClass(this.toThemeProperty('jqx-widget-content'));

            this.hex.appendTo(this.hexPanel);
            this.colorPanel.append('<div style="font-size: 1px; clear: both;"></div>');
            this.rgb = $("<div style='margin-top: 2px;'></div>");
            this.rgb.appendTo(this.colorPanel);

            this.red = $("<input style='width: 25px; height: 18px;' maxlength='3'/>");
            this.red.addClass(this.toThemeProperty('jqx-input'));
            this.red.addClass(this.toThemeProperty('jqx-widget-content'));
            this.rgb.append('<span>' + this.redString + '</span>');
            this.red.appendTo(this.rgb);

            this.green = $("<input style='margin-right: 2px; height: 18px; width: 25px;' maxlength='3'/>");
            this.green.addClass(this.toThemeProperty('jqx-input'));
            this.green.addClass(this.toThemeProperty('jqx-widget-content'));
            this.rgb.append('<span>' + this.greenString + '</span>');
            this.green.appendTo(this.rgb);

            this.colorPanel.addClass(this.toThemeProperty('jqx-color-picker-map-overlay'));
            this._mapImageOverlayURL = this._getImageUrl(this.colorPanel);
            this.colorPanel.removeClass(this.toThemeProperty('jqx-color-picker-map-overlay'));

            this.blue = $("<input style='height: 18px; width: 25px;' maxlength='3'/>");
            this.blue.addClass(this.toThemeProperty('jqx-input'));
            this.blue.addClass(this.toThemeProperty('jqx-widget-content'));
            this.rgb.append('<span>' + this.blueString + '</span>');
            this.blue.appendTo(this.rgb);

            this.preview = $("<div style='background: red; position: absolute;'></div>");
            this.preview.addClass(this.toThemeProperty('jqx-widget-content'));
            this.preview.appendTo(this.colorPanel);

            this.colorBarPointer = $("<div style='top: 0; left: 0; position: absolute; width: 100%;'></div>");
            this.colorBarPointer.addClass(this.toThemeProperty('jqx-color-picker-bar-pointer'));

            this.colorMapPointer = $("<div style='top: 0; left: 0; position: absolute; width: 100%;'></div>");
            this.colorMapPointer.addClass(this.toThemeProperty('jqx-color-picker-pointer'));

            this.transparent = $("<div style='clear: both;'><a style='text-align: center;' href='#'>transparent</a></div>");

            if (this.disabled) {
                this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
                this.element.disabled = true;
            }
            this._addHandlers();
            $.jqx.utilities.resize(this.host, function () {
                self._setSize();
                self.refresh();
            });
        }, // createInstance

        _setPositionFromValue: function () {
            var self = this;
            var x = self.color.h;
            var y = 100 - self.color.v;

            var height = self.colorMap.height();
            var width = self.colorMap.width();

            var left = x * width / 360;
            var top = y * height / 100;

            if (this.colorMode == 'saturation') {
                var sliderValue = 100 - self.color.s;
                sliderValue = sliderValue * height / 100;

                self._saturation = 100 - self.color.s;
                self.colorMapPointer.css('margin-left', left - 8);
                self.colorMapPointer.css('margin-top', top - 8);
                self.colorBarPointer.css('margin-top', sliderValue - 8);
                self.colorMapImageOverlay.css('opacity', (100 - self.color.s) / 100);
            }
            else {
                var x = self.color.s;
                var left = x * width / 100;
                var top = y * height / 100;
                var sliderValue = 360 - self.color.h;
                sliderValue = sliderValue * height / 360;

                self._hue = self.color.h;
                self.colorMapPointer.css('margin-left', left - 8);
                self.colorMapPointer.css('margin-top', top - 8);
                self.colorBarPointer.css('margin-top', sliderValue - 8);
            }
        },

        updateRGB: function () {
            var self = this;
            self.color.setRgb(self.red.val(), self.green.val(), self.blue.val());
            self._updateUI();
            self._raiseEvent('0', { color: self.color });
            self.color.transparent = false;
        },

        _setPosition: function (event, element, pointer) {
            var pageX = parseInt(event.pageX);
            var offsetLeft = parseInt(element.offset().left);

            var pageY = parseInt(event.pageY);
            var offsetTop = parseInt(element.offset().top);

            if (pointer[0].className.indexOf('jqx-color-picker-bar') == -1) {
                pointer.css('margin-left', pageX - 8 - offsetLeft);
            }
            if (pageY >= offsetTop && pageY <= offsetTop + element.height()) {
                pointer.css('margin-top', pageY - 8 - offsetTop);
            }
        },

        _handleKeyInput: function (self, event, input) {
            if (self.disabled)
                return;

            if (!self._validateKey(event))
                return event;

            input.val(self._setValueInRange(input.val(), 0, 255));
            this.updateRGB();
            this._setPositionFromValue();
        },

        _addHandlers: function () {
            var self = this;

            this.addHandler(this.colorMapPointer, 'dragStart', function (event) {
                event.preventDefault();
                return false;
            });

            this.addHandler(this.colorBarPointer, 'dragStart', function (event) {
                event.preventDefault();
                return false;
            });

            this.addHandler(this.transparent, 'click', function (event) {
                self._raiseEvent('0', { color: 'transparent' });
                event.preventDefault();
                self.color.transparent = true;
            });

            this.addHandler(this.host, 'selectionstart', function (event) {
                event.preventDefault();
                return false;
            });

            this.addHandler(this.blue, 'keyup blur', function (event) {
                self._handleKeyInput(self, event, self.blue);
            });
            this.addHandler(this.green, 'keyup blur', function (event) {
                self._handleKeyInput(self, event, self.green);
            });
            this.addHandler(this.red, 'keyup blur', function (event) {
                self._handleKeyInput(self, event, self.red);
            });
            this.addHandler(this.hex, 'keyup blur', function (event) {
                if (self.disabled)
                    return;

                if (!self._validateKey(event))
                    return event;

                if (self.hex.val().toString().length == 6) {
                    self.hex.val(self.color.validateHex(self.hex.val()));
                    self.color.setHex(self.hex.val());

                    self._updateUI();
                    self._setPositionFromValue();
                    self._raiseEvent('0', { color: self.color });
                }
            });

            this.addHandler(this.colorMap, 'dragstart', function (event) {
                event.preventDefault();
                return false;
            });

            var _setPositionInColorMap = function (event) {
                self._setPosition(event, self.colorMap, self.colorMapPointer);

                if (self.colorMode == 'saturation') {
                    var point = self._valuesFromMouse(event, self.colorMap, 360, 100);
                    if (point.x > 360) point.x = 360;
                    self.color.setHsv(point.x, self._saturation != null ? 100 - self._saturation : 100, 100 - point.y);
                }
                else {
                    var point = self._valuesFromMouse(event, self.colorMap, 100, 100);
                    if (point.x > 100) point.x = 100;
                    self.color.setHsv(self._hue != null ? self._hue : 360, point.x, 100 - point.y);
                }

                self._updateUI();
                self._raiseEvent('0', { color: self.color });
                self.color.transparent = false;
            }

            this.addHandler(this.colorMap, 'mousedown', function (event) {
                if (self.disabled)
                    return;

                self.beginDrag = true;
                _setPositionInColorMap(event);
            });

            this.addHandler($(document), 'mousemove.picker' + this.element.id, function (event) {
                if (self.disabled)
                    return;

                if (self.beginDrag == true) {
                    _setPositionInColorMap(event);
                }
            });

            this.addHandler(this.colorBar, 'dragstart', function (event) {
                event.preventDefault();
                return false;
            });

            var _setPositionInColorBar = function (event) {
                self._setPosition(event, self.colorBar, self.colorBarPointer);
                if (self.colorMode == 'saturation') {
                    var point = self._valuesFromMouse(event, self.colorBar, 100, 100);
                    self.color.s = point.y;
                    self._saturation = point.y;

                    self.colorMapImageOverlay.css('opacity', (self.color.s) / 100);
                    self.color.setHsv(self.color.h, 100 - self.color.s, self.color.v);
                }
                else {
                    var point = self._valuesFromMouse(event, self.colorBar, 100, 360);
                    self.color.h = 360 - point.y;
                    self._hue = self.color.h;
                    self.color.setHsv(self.color.h, self.color.s, self.color.v);
                }

                self._updateUI();
                self._raiseEvent('0', { color: self.color });
                self.color.transparent = false;
            }

            this.addHandler(this.colorBar, 'mousedown', function (event) {
                if (self.disabled)
                    return;

                self.beginDragBar = true;
                _setPositionInColorBar(event);
            });

            this.addHandler($(document), 'mousemove.colorbar' + this.element.id, function (event) {
                if (self.disabled)
                    return;

                if (self.beginDragBar == true) {
                    _setPositionInColorBar(event);
                }
            });

            this.addHandler($(document), 'mouseup.colorMap' + this.element.id, function (event) {
                if (self.disabled)
                    return;

                self.beginDrag = false;
                self.beginDragBar = false;
            });
        },

        _removeHandlers: function () {
            this.removeHandler(this.colorMapPointer);
            this.removeHandler(this.colorBarPointer);
            this.removeHandler(this.transparent, 'click');
            this.removeHandler(this.host, 'selectionstart');
            this.removeHandler(this.blue, 'keyup blur');
            this.removeHandler(this.green, 'keyup blur');
            this.removeHandler(this.red, 'keyup blur');
            this.removeHandler(this.hex, 'keyup blur');
            this.removeHandler(this.colorMap, 'dragstart');
            this.removeHandler(this.colorMap, 'mousedown');
            this.removeHandler($(document), 'mousemove.colorbar' + this.element.id);
            this.removeHandler($(document), 'mousemove.colormap' + this.element.id);
            this.removeHandler(this.colorBar, 'dragstart');
            this.removeHandler(this.colorBar, 'mousedown');
            this.removeHandler(this.colorBar, 'mousemove');
            this.removeHandler($(document), 'mouseup.colorMap' + this.element.id);
        },

        _raiseEvent: function (id, arg) {
            if (arg == undefined)
                arg = { owner: null };

            var evt = this.events[id];
            var args = arg ? arg : {};

            args.owner = this;
            var event = new jQuery.Event(evt);
            event.owner = this;
            event.args = args;

            var result = this.host.trigger(event);

            return result;
        },

        setColor: function (color) {
            if (color == 'transparent') {
                this.color.transparent = true;
                this.color.hex = "000";
                this.color.r = 0;
                this.color.g = 0;
                this.color.b = 0;
            }
            else {
                if (color.r) {
                    this.color = new $.jqx.color({ rgb: color });
                }
                else {
                    if (color.substring(0, 1) == '#') {
                        this.color = new $.jqx.color({ hex: color.substring(1) });
                    }
                    else {
                        this.color = new $.jqx.color({ hex: color });
                    }
                }
            }
            this._updateUI();
            this._setPositionFromValue();
            this._raiseEvent('0', { color: color });
        },

        getColor: function () {
            return this.color;
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (object.isInitialized == undefined || object.isInitialized == false)
                return;

            if (key == 'colorMode') {
                object.refresh();
            }

            if (key == 'color') {
                object._updateUI();
                object._setPositionFromValue();
                object._raiseEvent('0', { color: value });
            }

            if (key == 'width' || key == 'height') {
                object._setSize();
                object.refresh();
            }

            if (key == 'showTransparent') {
                object.refresh();
            }

            if (key == 'disabled') {
                this.element.disabled = value;
                if (value) {
                    object.host.addClass(object.toThemeProperty('jqx-fill-state-disabled'));
                }
                else {
                    object.host.removeClass(object.toThemeProperty('jqx-fill-state-disabled'));
                }
            }
        },

        _valuesFromMouse: function (e, element, maxX, maxY) {
            var relativeX = 0;
            var relativeY = 0;
            var offset = element.offset();
            var height = element.height();
            var width = element.width();

            // mouse relative to object's top left
            if (e.pageX < offset.left)
                relativeX = 0;
            else if (e.pageX > offset.left + width)
                relativeX = width;
            else
                relativeX = e.pageX - offset.left + 1;

            if (e.pageY < offset.top)
                relativeY = 0;
            else if (e.pageY > offset.top + height)
                relativeY = height;
            else
                relativeY = e.pageY - offset.top + 1;


            var newXValue = parseInt(relativeX / width * maxX);
            var newYValue = parseInt(relativeY / height * maxY);
            return { x: newXValue, y: newYValue };
        },

        _validateKey: function (e) {
            if (e.keyCode == 9 || // TAB
			    e.keyCode == 16 || // Shift
			    e.keyCode == 38 || // Up arrow
			    e.keyCode == 29 || // Right arrow
			    e.keyCode == 40 || // Down arrow
			    e.keyCode == 17 || // Down arrow
			    e.keyCode == 37    // Left arrow
			    ||
			    (e.ctrlKey && (e.keyCode == 'c'.charCodeAt() || e.keyCode == 'v'.charCodeAt()))
			    ||
			    (e.ctrlKey && (e.keyCode == 'C'.charCodeAt() || e.keyCode == 'V'.charCodeAt()))
		    ) {
                return false;
            }

            if (e.ctrlKey || e.shiftKey)
                return false;

            return true;
        },

        _setValueInRange: function (value, min, max) {
            if (value == '' || isNaN(value))
                return min;

            value = parseInt(value);
            if (value > max)
                return max;
            if (value < min)
                return min;

            return value;
        },

        destroy: function () {
            this.host.removeClass();
            this._removeHandlers();
            this.host.remove();
        },

        setPointerStyle: function (color) {
            this.colorMapPointer.removeClass();
            if (color == 'transparent' || color.hex == "") {
                this.colorMapPointer.addClass(this.toThemeProperty('jqx-color-picker-pointer'));
            }

            var nThreshold = 105;
            var bgDelta = (color.r * 0.299) + (color.g * 0.587) + (color.b * 0.114);
            var foreColor = (255 - bgDelta < nThreshold) ? 'Black' : 'White';

            if (foreColor == 'Black') {
                this.colorMapPointer.addClass(this.toThemeProperty('jqx-color-picker-pointer'));
            }
            else this.colorMapPointer.addClass(this.toThemeProperty('jqx-color-picker-pointer-alt'));
        },

        _updateUI: function () {
            var self = this;
            self.red.val(self.color.r);
            self.green.val(self.color.g);
            self.blue.val(self.color.b);
            self.hex.val(self.color.hex);

            var color = new $.jqx.color({ hex: 'fff' });
            if (this.colorMode == 'saturation') {
                color.setHsv(this.color.h, 100, this.color.v);
                self.colorBar.css('background', '#' + color.hex);
            }
            else {
                color.setHsv(this.color.h, 100, 100);
                self.colorMap.css('background-color', '#' + color.hex);
            }
            self.preview.css('background', '#' + this.color.hex);
            self.setPointerStyle(this.color);
        },

        _setSize: function () {
            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                this.host.width(this.width);
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    this.host.width(this.width);
                };

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                this.host.height(this.height);
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                this.host.height(this.height);
            };

            if (this.host.width() < 130) {
                this.host.width(150);
            }
            if (this.host.height() < 70) {
                this.host.height(70);
            }

            if (this.width != null && this.width.toString().indexOf("%") != -1) {
                this.host.width(this.width);
            }

            if (this.height != null && this.height.toString().indexOf("%") != -1) {
                this.host.height(this.height);
            }
        },

        _arrange: function () {
            var hostHeight = this.host.height();
            var hostWidth = this.host.width();
            var height = hostHeight - 44;
            if (this.showTransparent) {
                height = hostHeight - 64;
            }

            if (height <= 0)
                return;

            this.colorMap.width(85 * hostWidth / 100);
            this.colorMap.height(height);
            this.colorBar.height(height);
            this.colorBar.css('left', this.colorMap.width() + 4);
            this.colorBar.width(8 * hostWidth / 100);
            this.colorBarPointer.width(this.colorBar.width());
            this.colorPanel.width(hostWidth);
            this.colorPanel.height(40);
            if (this.showTransparent) {
                this.colorPanel.height(60);
            }
            this.colorPanel.css('top', height + 4);
            this.hex.width(this.colorMap.width() - this.colorBar.width() - 4);
            var leftMargin = this.red.prev().outerWidth() - this.hex.prev().outerWidth();
            if (leftMargin < 4) leftMargin = 4;

            this.hex.css('margin-left', leftMargin + 'px');
            this.preview.width(this.colorBar.width() + 9);
            this.preview.height(25);
            this.preview.addClass(this.toThemeProperty('jqx-rc-all'));
            this.preview.addClass(this.toThemeProperty('jqx-color-picker-preview'));
            this.preview.css('left', this.colorMap.width() - 4);
            this.preview.css('top', '5px');
            var hexPosition = this.hex.width();

            var offset = hexPosition - this.blue.prev().outerWidth() - this.green.prev().outerWidth() - 6;
            if (offset > 0) {
                this.blue.width(offset / 3);
                this.green.width(offset / 3);
                this.red.width(offset / 3);
                return;
            }
        },

        _getColorPointer: function () {
            var element = $("<div></div>");
            element.addClass(this.toThemeProperty('jqx-color-picker-pointer'));
            return element;
        },

        _getImageUrl: function (element) {
            var imageUrl = element.css('backgroundImage');
            imageUrl = imageUrl.replace('url("', '');
            imageUrl = imageUrl.replace('")', '');
            imageUrl = imageUrl.replace('url(', '');
            imageUrl = imageUrl.replace(')', '');
            return imageUrl;
        },

        refresh: function () {
            if (this._delayLoading) return;

            this._saturation = null;
            this._hue = null;

            this.colorMap.removeClass();
            this.colorBar.removeClass();
            this.colorMap.addClass(this.toThemeProperty('jqx-disableselect'));
            this.colorBar.addClass(this.toThemeProperty('jqx-disableselect'));
            this.colorPanel.addClass(this.toThemeProperty('jqx-color-picker-panel'));
            this.colorBar.css('background-image', '');
            this.colorMap.css('background-image', '');

            if (this.colorMode == 'saturation') {
                this.colorMap.addClass(this.toThemeProperty('jqx-color-picker-map'));
                this.colorBar.addClass(this.toThemeProperty('jqx-color-picker-bar'));
            }
            else {
                this.colorMap.addClass(this.toThemeProperty('jqx-color-picker-map-hue'));
                this.colorBar.addClass(this.toThemeProperty('jqx-color-picker-bar-hue'));
            }

            this._barImageURL = this._getImageUrl(this.colorBar);
            this._mapImageURL = this._getImageUrl(this.colorMap);

            this._arrange();
            this.colorBar.children().remove();
            this.colorBarImageContainer = $("<div style='overflow: hidden;'></div>");
            this.colorBarImageContainer.width(this.colorBar.width());
            this.colorBarImageContainer.height(this.colorBar.height());
            this.colorBarImageContainer.appendTo(this.colorBar);
            this.colorBarImage = $("<img/>");
            this.colorBarImage.appendTo(this.colorBarImageContainer);
            this.colorBarImage.attr('src', this._barImageURL);
            this.colorBar.css('background-image', 'none');
            this.colorBarImage.attr('width', this.colorBar.width());
            this.colorBarImage.attr('height', this.colorBar.height());

            this.colorBarPointer.appendTo(this.colorBar);

            this.colorMap.children().remove();
            this.colorMapImage = $("<img/>");
            this.colorMapImage.appendTo(this.colorMap);
            this.colorMapImage.attr('src', this._mapImageURL);
            this.colorMap.css('background-image', 'none');
            this.colorMapImage.attr('width', this.colorMap.width());
            this.colorMapImage.attr('height', this.colorMap.height());
            this.colorMapImageOverlay = $("<img style='position: absolute; left: 0; top: 0;'/>");
            this.colorMapImageOverlay.prependTo(this.colorMap);
            this.colorMapImageOverlay.attr('src', this._mapImageOverlayURL);
            this.colorMapImageOverlay.attr('width', this.colorMap.width());
            this.colorMapImageOverlay.attr('height', this.colorMap.height());
            this.colorMapImageOverlay.css('opacity', 0);

            this.colorMapPointer.appendTo(this.colorMap);

            if (this.showTransparent) {
                this.transparent.appendTo(this.colorPanel);
            }
            this._updateUI();
            this._setPositionFromValue();
        }
    });

    $.jqx.color = function (init) {
        var color = {
            r: 0,
            g: 0,
            b: 0,

            h: 0,
            s: 0,
            v: 0,

            hex: '',

            hexToRgb: function (hex) {
                hex = this.validateHex(hex);

                var r = '00', g = '00', b = '00';

                if (hex.length == 6) {
                    r = hex.substring(0, 2);
                    g = hex.substring(2, 4);
                    b = hex.substring(4, 6);
                } else {
                    if (hex.length > 4) {
                        r = hex.substring(4, hex.length);
                        hex = hex.substring(0, 4);
                    }
                    if (hex.length > 2) {
                        g = hex.substring(2, hex.length);
                        hex = hex.substring(0, 2);
                    }
                    if (hex.length > 0) {
                        b = hex.substring(0, hex.length);
                    }
                }

                return { r: this.hexToInt(r), g: this.hexToInt(g), b: this.hexToInt(b) };
            },

            validateHex: function (hex) {
                hex = new String(hex).toUpperCase();
                hex = hex.replace(/[^A-F0-9]/g, '0');
                if (hex.length > 6) hex = hex.substring(0, 6);
                return hex;
            },

            webSafeDec: function (dec) {
                dec = Math.round(dec / 51);
                dec *= 51;
                return dec;
            },

            hexToWebSafe: function (hex) {
                var r, g, b;

                if (hex.length == 3) {
                    r = hex.substring(0, 1);
                    g = hex.substring(1, 1);
                    b = hex.substring(2, 1);
                } else {
                    r = hex.substring(0, 2);
                    g = hex.substring(2, 4);
                    b = hex.substring(4, 6);
                }
                return intToHex(this.webSafeDec(this.hexToInt(r))) + this.intToHex(this.webSafeDec(this.hexToInt(g))) + this.intToHex(this.webSafeDec(this.hexToInt(b)));
            },

            rgbToWebSafe: function (rgb) {
                return { r: this.webSafeDec(rgb.r), g: this.webSafeDec(rgb.g), b: this.webSafeDec(rgb.b) };
            },

            rgbToHex: function (rgb) {
                return this.intToHex(rgb.r) + this.intToHex(rgb.g) + this.intToHex(rgb.b);
            },

            intToHex: function (dec) {
                var result = (parseInt(dec).toString(16));
                if (result.length == 1)
                    result = ("0" + result);
                return result.toUpperCase();
            },

            hexToInt: function (hex) {
                return (parseInt(hex, 16));
            },

            hslToRgb: function (hsl) {
                var h = parseInt(hsl.h) / 360;
                var s = parseInt(hsl.s) / 100;
                var l = parseInt(hsl.l) / 100;

                if (l <= 0.5) var q = l * (1 + s);
                else var q = l + s - (l * s);

                var p = 2 * l - q;
                var tr = h + (1 / 3);
                var tg = h;
                var tb = h - (1 / 3);

                var r = Math.round(this.hueToRgb(p, q, tr) * 255);
                var g = Math.round(this.hueToRgb(p, q, tg) * 255);
                var b = Math.round(this.hueToRgb(p, q, tb) * 255);
                return { r: r, g: g, b: b };
            },

            hueToRgb: function (p, q, h) {
                if (h < 0) h += 1;
                else if (h > 1) h -= 1;

                if ((h * 6) < 1) return p + (q - p) * h * 6;
                else if ((h * 2) < 1) return q;
                else if ((h * 3) < 2) return p + (q - p) * ((2 / 3) - h) * 6;
                else return p;
            },

            rgbToHsl: function (rgb) {
                var r = rgb[0],
		            g = rgb[1],
		            b = rgb[2];

                r /= 255;
                g /= 255;
                b /= 255;

                var max = math.max(r, g, b),
		            min = math.min(r, g, b),
		        h, s, l = (max + min) / 2;

                if (max === min) {
                    h = s = 0; // achromatic
                } else {
                    var d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }

                return { h: h, s: s, l: l };
            },

            rgbToHsl: function (rgb) {
                var r = parseFloat(rgb.r) / 255;
                var g = parseFloat(rgb.g) / 255;
                var b = parseFloat(rgb.b) / 255;
                var max = Math.max(r, g, b);
                var min = Math.min(r, g, b);
                var diff = max - min;
                var add = max + min;

                if (min === max) var h = 0;
                else if (r === max) var h = ((60 * (g - b) / diff) + 360) % 360;
                else if (g === max) var h = (60 * (b - r) / diff) + 120;
                else var h = (60 * (r - g) / diff) + 240;

                var l = 0.5 * add;

                if (l === 0) var s = 0;
                else if (l === 1) var s = 1;
                else if (l <= 0.5) var s = diff / add;
                else var s = diff / (2 - add);

                h = h.round();
                s = (s * 100).round();
                l = (l * 100).round();

                return { h: h, s: s, l: l };
            },

            rgbToHsv: function (rgb) {

                var r = rgb.r / 255;
                var g = rgb.g / 255;
                var b = rgb.b / 255;

                hsv = { h: 0, s: 0, v: 0 };

                var min = 0
                var max = 0;

                if (r >= g && r >= b) {
                    max = r;
                    min = (g > b) ? b : g;
                } else if (g >= b && g >= r) {
                    max = g;
                    min = (r > b) ? b : r;
                } else {
                    max = b;
                    min = (g > r) ? r : g;
                }

                hsv.v = max;
                hsv.s = (max) ? ((max - min) / max) : 0;

                if (!hsv.s) {
                    hsv.h = 0;
                } else {
                    delta = max - min;
                    if (r == max) {
                        hsv.h = (g - b) / delta;
                    } else if (g == max) {
                        hsv.h = 2 + (b - r) / delta;
                    } else {
                        hsv.h = 4 + (r - g) / delta;
                    }

                    hsv.h = parseInt(hsv.h * 60);
                    if (hsv.h < 0) {
                        hsv.h += 360;
                    }
                }

                hsv.s = parseInt(hsv.s * 100);
                hsv.v = parseInt(hsv.v * 100);

                return hsv;
            },

            hsvToRgb: function (hsv) {

                rgb = { r: 0, g: 0, b: 0 };

                var h = hsv.h;
                var s = hsv.s;
                var v = hsv.v;

                if (s == 0) {
                    if (v == 0) {
                        rgb.r = rgb.g = rgb.b = 0;
                    } else {
                        rgb.r = rgb.g = rgb.b = parseInt(v * 255 / 100);
                    }
                } else {
                    if (h == 360) {
                        h = 0;
                    }
                    h /= 60;

                    // 100 scale
                    s = s / 100;
                    v = v / 100;

                    var i = parseInt(h);
                    var f = h - i;
                    var p = v * (1 - s);
                    var q = v * (1 - (s * f));
                    var t = v * (1 - (s * (1 - f)));
                    switch (i) {
                        case 0:
                            rgb.r = v;
                            rgb.g = t;
                            rgb.b = p;
                            break;
                        case 1:
                            rgb.r = q;
                            rgb.g = v;
                            rgb.b = p;
                            break;
                        case 2:
                            rgb.r = p;
                            rgb.g = v;
                            rgb.b = t;
                            break;
                        case 3:
                            rgb.r = p;
                            rgb.g = q;
                            rgb.b = v;
                            break;
                        case 4:
                            rgb.r = t;
                            rgb.g = p;
                            rgb.b = v;
                            break;
                        case 5:
                            rgb.r = v;
                            rgb.g = p;
                            rgb.b = q;
                            break;
                    }

                    rgb.r = parseInt(rgb.r * 255);
                    rgb.g = parseInt(rgb.g * 255);
                    rgb.b = parseInt(rgb.b * 255);
                }

                return rgb;
            },

            setRgb: function (r, g, b) {
                var validate = function (input) {
                    if (input < 0 || input > 255)
                        return 0;
                    if (isNaN(parseInt(input)))
                        return 0;

                    return input;
                }

                this.r = validate(r);
                this.g = validate(g);
                this.b = validate(b);

                var newHsv = this.rgbToHsv(this);
                this.h = newHsv.h;
                this.s = newHsv.s;
                this.v = newHsv.v;

                this.hex = this.rgbToHex(this);
            },

            setHsl: function (h, s, l) {
                this.h = h;
                this.s = s;
                this.l = l;

                var newRgb = this.hslToRgb(this);
                this.r = newRgb.r;
                this.g = newRgb.g;
                this.b = newRgb.b;

                this.hex = this.rgbToHex(newRgb);
            },

            setHsv: function (h, s, v) {
                this.h = h;
                this.s = s;
                this.v = v;

                var newRgb = this.hsvToRgb(this);
                this.r = newRgb.r;
                this.g = newRgb.g;
                this.b = newRgb.b;

                this.hex = this.rgbToHex(newRgb);
            },

            setHex: function (hex) {
                this.hex = hex;

                var newRgb = this.hexToRgb(this.hex);
                this.r = newRgb.r;
                this.g = newRgb.g;
                this.b = newRgb.b;

                var newHsv = this.rgbToHsv(newRgb);
                this.h = newHsv.h;
                this.s = newHsv.s;
                this.v = newHsv.v;
            }
        };

        if (init) {
            if (init.hex) {
                var hex = color.validateHex(init.hex);
                color.setHex(hex);
            }
            else if (init.r)
                color.setRgb(init.r, init.g, init.b);
            else if (init.h)
                color.setHsv(init.h, init.s, init.v);
            else if (init.rgb) {
                color.setRgb(init.rgb.r, init.rgb.g, init.rgb.b);

            }
        }

        return color;
    };
})(jQuery);

(function ($) {

    $.jqx.jqxWidget("jqxSwitchButton", "", {});

    $.extend($.jqx._jqxSwitchButton.prototype, {
        defineInstance: function () {

            this.disabled = false;
            this.checked = false;
            this.onLabel = 'On';
            this.offLabel = 'Off';
            this.toggleMode = 'default';    //default, slide, click
            this.animationDuration = 250;
            this.width = 90;
            this.height = 30;
            this.animationEnabled = true;
            this.thumbSize = '40%';
            this.orientation = 'horizontal';
            this.switchRatio = '50%';
            this.metroMode = false;
            this._isMouseDown = false;
            this.rtl = false;
            this._dimensions = {
                horizontal: {
                    size: 'width',
                    opSize: 'height',
                    oSize: 'outerWidth',
                    opOSize: 'outerHeight',
                    pos: 'left',
                    oPos: 'top',
                    opposite: 'vertical'
                },
                vertical: {
                    size: 'height',
                    opSize: 'width',
                    oSize: 'outerHeight',
                    opOSize: 'outerWidth',
                    pos: 'top',
                    oPos: 'left',
                    opposite: 'horizontal'
                }
            };
            this._touchEvents = {
                'mousedown': 'touchstart',
                'click': 'touchend',
                'mouseup': 'touchend',
                'mousemove': 'touchmove',
                'mouseenter': 'mouseenter',
                'mouseleave': 'mouseleave'
            };
            this._borders = {};
            this._isTouchDevice = false;
            this._distanceRequired = 3;
            this._isDistanceTraveled = false;
            this._thumb;
            this._onLabel;
            this._offLabel;
            this._wrapper;
            this._animationActive = false;
            this.aria =
            {
                "aria-checked": { name: "checked", type: "boolean" },
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
            this._events = ['checked', 'unchecked', 'change'];
        },

        createInstance: function (args) {
            if (this.element.nodeName) {
                if (this.element.nodeName == "INPUT" || this.element.nodeName == "BUTTON") {
                    throw "jqxSwitchButton can be rendered only from a DIV tag.";
                }
            }
            this.host.attr('role', 'checkbox');
            $.jqx.aria(this);
            this.render();
            var that = this;
            $.jqx.utilities.resize(this.host, function () {
                that.render();
            });
        },

        render: function()
        {
            this.innerHTML = "";
            if (this.theme && this.theme != "" && (this.theme.indexOf('metro') != -1 || this.theme.indexOf('windowsphone') != -1 || this.theme.indexOf('office') != -1)) {
                if (this.thumbSize == '40%') this.thumbSize = 12;
                this.metroMode = true;
            }

            var count = $.data(document.body, 'jqx-switchbutton') || 1;
            this._idHandler(count);
            $.data(document.body, 'jqx-draggables', ++count);
            this._isTouchDevice = $.jqx.mobile.isTouchDevice();
            this.switchRatio = parseInt(this.switchRatio, 10);
            this._render();
            this._addClasses();
            this._performLayout();
            this._removeEventHandles();
            this._addEventHandles();
            this._disableSelection();
            var self = this;
            if (!this.checked) {
                this._switchButton(false, 0, true);
            }
            if (this.disabled) {
                this.element.disabled = true;
            }
        },

        setOnLabel: function (text) {
            this._onLabel.html('<div style="display: inline-block;">' + text + '</div>');
            this._centerLabels();
        },

        setOffLabel: function (text) {
            this._offLabel.html('<div style="display: inline-block;">' + text + '</div>');
            this._centerLabels();
        },

        toggle: function () {
            if (this.checked) {
                this.uncheck();
            } else {
                this.check();
            }
        },

        val: function (value) {
            if (arguments.length == 0 || (value != null && typeof (value) == "object")) {
                return this.checked;
            }

            if (typeof value == "string") {
                if (value == "true") this.check();
                if (value == "false") this.uncheck();
                if (value == "") this.indeterminate();
            }
            else {
                if (value == true) this.check();
                if (value == false) this.uncheck();
                if (value == null) this.indeterminate();
            }
            return this.checked;
        },

        uncheck: function () {
            var self = this;
            this._switchButton(false);
            $.jqx.aria(this, "aria-checked", this.checked);
        },

        check: function () {
            var self = this;
            this._switchButton(true);
            $.jqx.aria(this, "aria-checked", this.checked);
        },

        _idHandler: function (count) {
            if (!this.element.id) {
                var id = 'jqx-switchbutton-' + count;
                this.element.id = id;
            }
        },

        _dir: function (prop) {
            return this._dimensions[this.orientation][prop];
        },

        _getEvent: function (event) {
            if (this._isTouchDevice) {
                var eventName = this._touchEvents[event];
                return $.jqx.mobile.getTouchEventName(eventName);
            } else {
                return event;
            }
        },

        _render: function () {
            this._thumb = $('<div/>');
            this._onLabel = $('<div/>');
            this._offLabel = $('<div/>');
            this._wrapper = $('<div/>');
            this._onLabel.appendTo(this.host);
            this._thumb.appendTo(this.host);
            this._offLabel.appendTo(this.host);
            this.host.wrapInner(this._wrapper);
            this._wrapper = this.host.children();
            this.setOnLabel(this.onLabel);
            this.setOffLabel(this.offLabel);
        },

        _addClasses: function () {
            var thumb = this._thumb,
                onLabel = this._onLabel,
                offLabel = this._offLabel;
            this.host.addClass(this.toThemeProperty('jqx-switchbutton'));
            this.host.addClass(this.toThemeProperty('jqx-widget'));
            this.host.addClass(this.toThemeProperty('jqx-widget-content'));
            this._wrapper.addClass(this.toThemeProperty('jqx-switchbutton-wrapper'));
            thumb.addClass(this.toThemeProperty('jqx-fill-state-normal'));
            thumb.addClass(this.toThemeProperty('jqx-switchbutton-thumb'));
            onLabel.addClass(this.toThemeProperty('jqx-switchbutton-label-on'));
            onLabel.addClass(this.toThemeProperty('jqx-switchbutton-label'));
            offLabel.addClass(this.toThemeProperty('jqx-switchbutton-label-off'));
            offLabel.addClass(this.toThemeProperty('jqx-switchbutton-label'));
            if (this.checked) {
                this.host.addClass(this.toThemeProperty('jqx-switchbutton-on'));
            }
            else {
                this.host.removeClass(this.toThemeProperty('jqx-switchbutton-on'));
            }
        },

        _performLayout: function () {
            var el = this.host,
                opSize = this._dir('opSize'),
                size = this._dir('size'),
                wrapper = this._wrapper,
                border;
            el.css({
                width: this.width,
                height: this.height
            });
            wrapper.css(opSize, el[opSize]());
            this._thumbLayout();
            this._labelsLayout();
            border = this._borders[this._dir('opposite')];
            wrapper.css(size, el[size]() + this._offLabel[this._dir('oSize')]() + border);
            wrapper.css(opSize, el[opSize]());

            if (this.metroMode || (this.theme && this.theme != "" && (this.theme.indexOf('metro') != -1 || this.theme.indexOf('office') != -1))) {
                var thumb = this._thumb,
                 onLabel = this._onLabel,
                 offLabel = this._offLabel;
                onLabel.css('position', 'relative');
                onLabel.css('top', '1px');
                onLabel.css('margin-left', '1px');
                offLabel.css('position', 'relative');
                offLabel.css('top', '1px');
                offLabel.css('left', '-2px');
                offLabel.css('margin-right', '1px');
                offLabel.height(onLabel.height() - 2);
                offLabel.width(onLabel.width() - 3);

                onLabel.height(onLabel.height() - 2);
                onLabel.width(onLabel.width() - 3);
                this._thumb[this._dir('size')](this.thumbSize + 3);
                this._thumb.css('top', '-1px');
                this._thumb[this._dir('opSize')](el[this._dir('opSize')]() + 2);
                this._thumb.css('position', 'relative');
                this.host.css('overflow', 'hidden');
                if (this.checked) {
                    this._onLabel.css('visibility', 'visible');
                    this._offLabel.css('visibility', 'hidden');
                    this._thumb.css('left', '0px');
                }
                else {
                    this._onLabel.css('visibility', 'hidden');
                    this._offLabel.css('visibility', 'visible');
                    this._thumb.css('left', '-2px');
                }
            }
        },

        _thumbLayout: function () {
            var size = this.thumbSize,
                el = this.host,
                verticalBorders = 0,
                borders = { horizontal: 0, vertical: 0 },
                self = this;
            if (size.toString().indexOf('%') >= 0) {
                size = el[this._dir('size')]() * parseInt(size, 10) / 100;
            }
            this._thumb[this._dir('size')](size);
            this._thumb[this._dir('opSize')](el[this._dir('opSize')]());
            this._handleThumbBorders();
        },

        //We guess that the left/right and bottom/top borders are with equal width because of easier computations
        _handleThumbBorders: function () {
            this._borders['horizontal'] = parseInt(this._thumb.css('border-left-width'), 10) || 0;
            this._borders['horizontal'] += parseInt(this._thumb.css('border-right-width'), 10) || 0;
            this._borders['vertical'] = parseInt(this._thumb.css('border-top-width'), 10) || 0;
            this._borders['vertical'] += parseInt(this._thumb.css('border-bottom-width'), 10) || 0;
            var border = this._borders[this._dir('opposite')];
            if (this.orientation === 'horizontal') {
                this._thumb.css('margin-top', -border / 2);
                this._thumb.css('margin-left', 0);
            } else {
                this._thumb.css('margin-left', -border / 2);
                this._thumb.css('margin-top', 0);
            }
        },

        _labelsLayout: function () {
            var el = this.host,
                thumb = this._thumb,
                opSize = this._dir('opSize'),
                dimension = this._dir('size'),
                outerDimension = this._dir('oSize'),
                size = el[dimension]() - thumb[outerDimension](),
                border = this._borders[this._dir('opposite')] / 2;
            this._onLabel[dimension](size + border);
            this._offLabel[dimension](size + border);
            if (this.rtl) {
                this._onLabel[dimension](size + 2*border);
            }

            this._onLabel[opSize](el[opSize]())
            this._offLabel[opSize](el[opSize]());
            this._orderLabels();
            this._centerLabels();
        },

        _orderLabels: function () {
            if (this.orientation === 'horizontal') {
                var fl = 'left';
                if (this.rtl) fl = 'right';
                this._onLabel.css('float', fl);
                this._thumb.css('float', fl);
                this._offLabel.css('float', fl);
            } else {
                this._onLabel.css('display', 'block');
                this._offLabel.css('display', 'block');
            }
        },

        _centerLabels: function () {
            var l1 = this._onLabel.children('div'),
                l2 = this._offLabel.children('div'),
                parent = l1.parent(),
                wrapperHeight = parent.height(),
                labelHeight = l1.outerHeight(),
                border = this._borders[this.orientation] / 2 || 0;
                if (labelHeight == 0) {
                    labelHeight = 14;
                }
                var distance = Math.floor((wrapperHeight - labelHeight) / 2) + border;
            l1.css('margin-top', distance);
            l2.css('margin-top', distance);
        },

        _removeEventHandles: function () {
            var namespace = '.' + this.element.id;
            this.removeHandler(this._wrapper, this._getEvent('click') + namespace + this.element.id, this._clickHandle);
            this.removeHandler(this._thumb, this._getEvent('mousedown') + namespace, this._mouseDown);
            this.removeHandler($(document), this._getEvent('mouseup') + namespace, this._mouseUp);
            this.removeHandler($(document), this._getEvent('mousemove') + namespace, this._mouseMove);
        },

        _addEventHandles: function () {
            var namespace = '.' + this.element.id,
                self = this;
            this.addHandler(this._thumb, 'mouseenter' + namespace, function () {
                self._thumb.addClass(self.toThemeProperty('jqx-fill-state-hover'));
            });
            this.addHandler(this._thumb, 'mouseleave' + namespace, function () {
                self._thumb.removeClass(self.toThemeProperty('jqx-fill-state-hover'));
            });
            this.addHandler(this._wrapper, this._getEvent('click') + namespace, this._clickHandle, { self: this });
            this.addHandler(this._thumb, this._getEvent('mousedown') + namespace, this._mouseDown, { self: this });
            this.addHandler($(document), this._getEvent('mouseup') + namespace, this._mouseUp, { self: this });
            this.addHandler($(document), this._getEvent('mousemove') + namespace, this._mouseMove, { self: this });
        },

        enable: function () {
            this.disabled = false;
            this.element.disabled = false;
            $.jqx.aria(this, "aria-disabled", this.disabled);
        },

        disable: function () {
            this.disabled = true;
            this.element.disabled = true;
            $.jqx.aria(this, "aria-disabled", this.disabled);
        },

        _clickHandle: function (event) {
            var self = event.data.self;
            if ((self.toggleMode === 'click' || self.toggleMode === 'default') && !self.disabled) {
                if (!self._isDistanceTraveled && !self._dragged) {
                    self._wrapper.stop();
                    self.toggle();
                }
            }
            self._thumb.removeClass(self.toThemeProperty('jqx-fill-state-pressed'));
        },

        _mouseDown: function (event) {
            var self = event.data.self,
                wrapper = self._wrapper;
            if (self.metroMode) {
                self.host.css('overflow', 'hidden');
                self._onLabel.css('visibility', 'visible');
                self._offLabel.css('visibility', 'visible');
            }
            self._mouseStartPosition = self._getMouseCoordinates(event);
            self._buttonStartPosition = {
                left: parseInt(wrapper.css('margin-left'), 10) || 0,
                top: parseInt(wrapper.css('margin-top'), 10) || 0
            };
            if (!self.disabled && (self.toggleMode === 'slide' || self.toggleMode === 'default')) {
                self._wrapper.stop();
                self._isMouseDown = true;
                self._isDistanceTraveled = false;
                self._dragged = false;
            }
            self._thumb.addClass(self.toThemeProperty('jqx-fill-state-pressed'));
        },

        _mouseUp: function (event) {
            var self = event.data.self;
            if (self.metroMode) {
           //     self.host.css('overflow', 'visible');
            }
            self._isMouseDown = false;
            self._thumb.removeClass(self.toThemeProperty('jqx-fill-state-pressed'));
            if (!self._isDistanceTraveled) {
                return;
            }
            var wrapper = self._wrapper,
                position = parseInt(wrapper.css('margin-' + self._dir('pos')), 10) || 0,
                distancePassed = self._dropHandler(position);
            if (distancePassed) {
                self._switchButton(!self.checked);
            } else {
                self._switchButton(self.checked, null, true);
            }
            self._isDistanceTraveled = false;
        },

        _mouseMove: function (event) {
            var self = event.data.self,
                mousePos = self._getMouseCoordinates(event);
            if (self._isMouseDown && self._distanceTraveled(mousePos)) {
                var dir = self._dir('pos'),
                    wrapper = self._wrapper,
                    btnPos = self._buttonStartPosition[dir],
                    pos = btnPos + mousePos[dir] - self._mouseStartPosition[dir],
                    pos = self._validatePosition(pos);
                self._dragged = true;
                wrapper.css('margin-' + self._dir('pos'), pos);
                self._onLabel.css('visibility', 'visible');
                self._offLabel.css('visibility', 'visible');

                return false;
            }
        },

        _distanceTraveled: function (mousePos) {
            if (this._isDistanceTraveled) {
                return true;
            } else if (!this._isMouseDown) {
                return false;
            } else {
                var start = this._mouseStartPosition,
                    distance = this._distanceRequired;
                this._isDistanceTraveled = Math.abs(mousePos.left - start.left) >= distance || Math.abs(mousePos.top - start.top) >= distance;
                return this._isDistanceTraveled;
            }
        },

        _validatePosition: function (position) {
            var border = this._borders[this._dir('opposite')],
                max = 0,
                min = -(this.host[this._dir('size')]() - this._thumb[this._dir('oSize')]()) - border;
            if (max < position) {
                return max;
            }
            if (min > position) {
                return min;
            }
            return position;
        },

        _dropHandler: function (position) {
            var max = 0,
                min = -(this.host[this._dir('size')]() - this._thumb[this._dir('oSize')]()),
                distance = Math.abs(min - max),
                distanceTraveled = Math.abs(position - this._buttonStartPosition[this._dir('pos')]),
                distanceRequired = distance * (this.switchRatio / 100);
            if (distanceTraveled >= distanceRequired) {
                return true;
            }
            return false;
        },

        _switchButton: function (check, duration, notTrigger) {
            if (this.metroMode) {
                this.host.css('overflow', 'hidden');
                this._onLabel.css('visibility', 'visible');
                this._offLabel.css('visibility', 'visible');
                if (check) {
                    this._thumb.css('left', '0px');
                }
                else {
                    this._thumb.css('left', '-2px');
                }
            }
            else {
                this._onLabel.css('visibility', 'visible');
                this._offLabel.css('visibility', 'visible');
            }

            var wrapper = this._wrapper,
                self = this,
                options = {},
                border = this._borders[this._dir('opposite')],
                position = 0;
            if (typeof duration === 'undefined') {
                duration = (this.animationEnabled ? this.animationDuration : 0);
            }

            if (!this.rtl) {
                if (!check) {
                    position = this.host[this._dir('size')]() - this._thumb[this._dir('oSize')]() + border;
                }
            }
            else {
                if (check) {
                    position = this.host[this._dir('size')]() - this._thumb[this._dir('oSize')]() + border;
                    if (this.metroMode) {
                        position += 5;
                    }
                }
                else
                    if (this.metroMode) {
                        position -= 3;;
                    }
            }


            options['margin-' + this._dir('pos')] = -position;
     
            if (check) {
                self.host.addClass(self.toThemeProperty('jqx-switchbutton-on'));
            }
            else {
                self.host.removeClass(self.toThemeProperty('jqx-switchbutton-on'));
            }
            wrapper.animate(options, duration, function () {
                if (!notTrigger) {
                    self._handleEvent(check);
                }
               // if (self.metroMode) self.host.css('overflow', 'visible');
                if (check) {
                    self._onLabel.css('visibility', 'visible');
                    self._offLabel.css('visibility', 'hidden');
                }
                else {
                    self._onLabel.css('visibility', 'hidden');
                    self._offLabel.css('visibility', 'visible');
                }

                self.checked = check;
            });
        },

        _handleEvent: function (checked) {
            if (checked !== this.checked) {
                this._raiseEvent(2, { check: checked });
            }
            if (checked) {
                this._raiseEvent(0);
            } else {
                this._raiseEvent(1);
            }
        },

        _disableSelection: function () {
            var el = this.host,
                children = el.find('*');
            $.each(children, function (i, el) {
                el.onselectstart = function () { return false };
                $(el).addClass('jqx-disableselect');
            });
        },

        _getMouseCoordinates: function (event) {
            if (this._isTouchDevice) {
                return {
                    left: event.originalEvent.touches[0].pageX,
                    top: event.originalEvent.touches[0].pageY
                };
            } else {
                return {
                    left: event.pageX,
                    top: event.pageY
                };
            }
        },

        destroy: function () {
            this._removeEventHandlers();
            this.host.removeClass(this.toThemeProperty('jqx-switchbutton'));
            this._wrapper.remove();
        },

        _raiseEvent: function (id, args) {
            var event = $.Event(this._events[id]);
            event.args = args;
            return this.host.trigger(event);
        },

        _themeChanger: function (oldTheme, theme, element) {
            if (!oldTheme) {
                return;
            }
            if (typeof element === 'undefined') {
                element = this.host;
            }
            var classNames = element[0].className.split(' '),
                oldClasses = [], newClasses = [],
                children = element.children();
            for (var i = 0; i < classNames.length; i += 1) {
                if (classNames[i].indexOf(oldTheme) >= 0) {
                    oldClasses.push(classNames[i]);
                    newClasses.push(classNames[i].replace(oldTheme, theme));
                }
            }
            this._removeOldClasses(oldClasses, element);
            this._addNewClasses(newClasses, element);
            for (var i = 0; i < children.length; i += 1) {
                this._themeChanger(oldTheme, theme, $(children[i]));
            }
        },

        _removeOldClasses: function (classes, element) {
            for (var i = 0; i < classes.length; i += 1) {
                element.removeClass(classes[i]);
            }
        },

        _addNewClasses: function (classes, element) {
            for (var i = 0; i < classes.length; i += 1) {
                element.addClass(classes[i]);
            }
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            switch (key) {
                case 'disabled':
                    if (value) {
                        this.disable();
                    }
                    else {
                        this.enable();
                    }
                    break;
                case 'switchRatio':
                    this.switchRatio = parseInt(this.switchRatio, 10);
                    break;
                case 'checked':
                    if (value) {
                        this.check();
                    } else {
                        this.uncheck();
                    }
                    break;
                case 'onLabel':
                    this.setOnLabel(value);
                    break;
                case 'offLabel':
                    this.setOffLabel(value);
                    break;
                case 'theme':
                    $.jqx.utilities.setTheme(oldvalue, value, object.host);          
                    break;
                case 'width':
                case 'height':
                case 'thumbSize':
                case 'orientation':
                    this._performLayout();
                    this._wrapper.css('left', 0);
                    this._wrapper.css('top', 0);
                    this._switchButton(this.checked, 0, true);
                    break;
            }
        }
    });
})(jQuery);(function ($) {
$.jqx.jqxWidget("jqxScrollBar", "", {});

$.extend($.jqx._jqxScrollBar.prototype, {

        defineInstance: function () {
            // Type: Number
            // Default: null
            // Sets the scrollbar height.
            this.height = null;
            // Type: Number
            // Default: null
            // Sets the scrollbar width.
            this.width = null;
            // Type: Number
            // Default: false. This means that the scrollbar is horizontally oriented by default.
            // Sets the scrollbar orientation.
            this.vertical = false;
            // Type: Number
            // Default: 0
            // Sets the minimum scroll value.
            this.min = 0;
            // Type: Number
            // Default: 0
            // Sets the maximum scroll value.
            this.max = 1000;
            // Type: Number
            // Default: 0
            // Sets the scroll value. The value can be between min and max.
            this.value = this.min;
            // Type: Number
            // Default: 0
            // Sets the scroll step when any arrow button is clicked.
            this.step = 10;
            // Type: Number
            // Default: 0
            // Sets the scroll step when the user clicks on the empty scroll space between arrow button and thumb.
            this.largestep = 50;
            // Type: Number
            // Default: 10
            // sets the thumb's minimum size.
            this.thumbMinSize = 10;
            // Type: Number
            // Default: 0
            // sets the thumb's size.
            this.thumbSize = 0;
            // Type: Number or 'auto'
            // Default: 'auto'
            // sets the thumb's drag step.
            this.thumbStep = 'auto';
            // Type: String
            // Default: 'all'
            // sets the rounded corners string.
            this.roundedCorners = 'all';
            // Type: Boolean
            // Default: true
            // Sets whether the scroll buttons are visible.
            this.showButtons = true;
            // Type: Boolean
            // Default: false
            // Sets whether the scrollbar is disabled or not.
            this.disabled = false;
            // Sets whether the scrollbar is on touch device.
            this.touchMode = 'auto';
            this.touchModeStyle = 'auto';
            this.thumbTouchSize = 0;
            // disable jquery trigger function. It is very slow if you call it on mouse move. This could improve performance.
            this._triggervaluechanged = true;
            this.rtl = false;
            this.areaDownCapture = false;
            this.areaUpCapture = false;
            this._initialLayout = false;
        },

        createInstance: function (args) {
            this.render();
        }, // createInstance

        render: function () {
            this._mouseup = new Date();
            var self = this;
            var html = "<div id='jqxScrollOuterWrap' style='width:100%; height: 100%; align:left; border: 0px; valign:top; position: relative;'>" +
                "<div id='jqxScrollWrap' style='width:100%; height: 100%; left: 0px; top: 0px; align:left; valign:top; position: absolute;'>" +
                "<div id='jqxScrollBtnUp' style='align:left; valign:top; left: 0px; top: 0px; position: absolute;'></div>" +
                "<div id='jqxScrollAreaUp' style='align:left; valign:top; left: 0px; top: 0px; position: absolute;'></div>" +
                "<div id='jqxScrollThumb' style='align:left; valign:top; left: 0px; top: 0px; position: absolute;'></div>" +
                "<div id='jqxScrollAreaDown' style='align:left; valign:top; left: 0px; top: 0px; position: absolute;'></div>" +
                "<div id='jqxScrollBtnDown' style='align:left; valign:top; left: 0px; top: 0px; position: absolute;'></div>" +
                "</div>" +
                "</div>";

            if (self.WinJS) {
                MSApp.execUnsafeLocalFunction(function () {
                    WinJS.Utilities.setInnerHTMLUnsafe(this.element, html);
                });
            }
            else {
                this.element.innerHTML = html;
            }

            if (this.width != undefined && parseInt(this.width) > 0) {
                this.host.width(parseInt(this.width));
            }

            if (this.height != undefined && parseInt(this.height) > 0) {
                this.host.height(parseInt(this.height));
            }
            this.isPercentage = false;
            if (this.width != null && this.width.toString().indexOf("%") != -1) {
                this.host.width(this.width);
                this.isPercentage = true;
            }

            if (this.height != null && this.height.toString().indexOf("%") != -1) {
                this.host.height(this.height);
                this.isPercentage = true;
            }
            if (this.isPercentage) {
                var that = this;
                $.jqx.utilities.resize(this.host, function () {
                    that._arrange();
                }, false);
            }
            this.thumbCapture = false;
            this.btnUp = this.host.find('#jqxScrollBtnUp');
            this.btnDown = this.host.find('#jqxScrollBtnDown');
            this.btnThumb = this.host.find('#jqxScrollThumb');
            this.areaUp = this.host.find('#jqxScrollAreaUp');
            this.arrowUp = $('<div></div>');
            this.arrowUp.appendTo(this.btnUp);
            this.arrowDown = $('<div></div>');
            this.arrowDown.appendTo(this.btnDown);
            this.areaDown = this.host.find('#jqxScrollAreaDown');
            this.scrollWrap = this.host.find('#jqxScrollWrap');
            this.scrollOuterWrap = this.host.find('#jqxScrollOuterWrap');

            this.btnUp[0].id = "jqxScrollBtnUp" + this.element.id;
            this.btnDown[0].id = "jqxScrollBtnDown" + this.element.id;
            this.btnThumb[0].id = "jqxScrollThumb" + this.element.id;
            this.areaUp[0].id = "jqxScrollAreaUp" + this.element.id;
            this.areaDown[0].id = "jqxScrollAreaDown" + this.element.id;
            this.scrollWrap[0].id = "jqxScrollWrap" + this.element.id;
            this.scrollOuterWrap[0].id = "jqxScrollOuterWrap" + this.element.id;

            if (!this.host.jqxRepeatButton) {
                throw new Error('jqxScrollBar: Missing reference to jqxbuttons.js.');
                return;
            }

            this.btnUp.jqxRepeatButton({_ariaDisabled: true, overrideTheme: true, disabled: this.disabled });
            this.btnDown.jqxRepeatButton({ _ariaDisabled: true, overrideTheme: true, disabled: this.disabled });
            this.btnDownInstance = $.data(this.btnDown[0], 'jqxRepeatButton').instance;
            this.btnUpInstance = $.data(this.btnUp[0], 'jqxRepeatButton').instance;

            this.areaUp.jqxRepeatButton({ _ariaDisabled: true, overrideTheme: true });
            this.areaDown.jqxRepeatButton({ _ariaDisabled: true, overrideTheme: true });
            this.btnThumb.jqxButton({ _ariaDisabled: true, overrideTheme: true, disabled: this.disabled });
            this.propertyChangeMap['value'] = function (instance, key, oldVal, value) {
                if (!(isNaN(value))) {
                    if (oldVal != value) {
                        instance.setPosition(parseFloat(value), true);
                    }
                }
            }

            this.propertyChangeMap['width'] = function (instance, key, oldVal, value) {
                if (instance.width != undefined && parseInt(instance.width) > 0) {
                    instance.host.width(parseInt(instance.width));
                    instance._arrange();
                }
            }

            this.propertyChangeMap['height'] = function (instance, key, oldVal, value) {
                if (instance.height != undefined && parseInt(instance.height) > 0) {
                    instance.host.height(parseInt(instance.height));
                    instance._arrange();
                }
            }

            this.propertyChangeMap['theme'] = function (instance, key, oldVal, value) {
                instance.setTheme();
            }

            this.propertyChangeMap['max'] = function (instance, key, oldVal, value) {
                if (!(isNaN(value))) {
                    if (oldVal != value) {
                        instance.max = parseInt(value);
                        if (instance.min > instance.max)
                            instance.max = instance.min + 1;

                        instance._arrange();
                        instance.setPosition(instance.value);
                    }
                }
            }

            this.propertyChangeMap['min'] = function (instance, key, oldVal, value) {
                if (!(isNaN(value))) {
                    if (oldVal != value) {
                        instance.min = parseInt(value);
                        if (instance.min > instance.max)
                            instance.max = instance.min + 1;

                        instance._arrange();
                        instance.setPosition(instance.value);
                    }
                }
            }

            this.propertyChangeMap['disabled'] = function (instance, key, oldVal, value) {
                if (oldVal != value) {
                    if (value) {
                        instance.host.addClass(instance.toThemeProperty('jqx-fill-state-disabled'));
                    }
                    else {
                        instance.host.removeClass(instance.toThemeProperty('jqx-fill-state-disabled'));
                    }
                    instance.btnUp.jqxRepeatButton('disabled', instance.disabled);
                    instance.btnDown.jqxRepeatButton('disabled', instance.disabled);
                    instance.btnThumb.jqxButton('disabled', instance.disabled);
                }
            }

            this.propertyChangeMap['touchMode'] = function (instance, key, oldVal, value) {
                if (oldVal != value) {
                    instance._updateTouchBehavior();
                    if (value === true) {
                        instance.showButtons = false;
                        instance.refresh();
                    }
                    else if (value === false) {
                        instance.showButtons = true;
                        instance.refresh();
                    }
                }
            }

            this.buttonUpCapture = false;
            this.buttonDownCapture = false;
            this._updateTouchBehavior();
            this.setPosition(this.value);
            this._addHandlers();
            this.setTheme();
        },

        _updateTouchBehavior: function () {
            this.isTouchDevice = $.jqx.mobile.isTouchDevice();
            if (this.touchMode == true) {
                if ($.jqx.browser.msie && $.jqx.browser.version < 9) {
                    this.setTheme();
                    return;
                }

                this.isTouchDevice = true;
                $.jqx.mobile.setMobileSimulator(this.btnThumb[0]);
                this._removeHandlers();
                this._addHandlers();
                this.setTheme();
            }
            else if (this.touchMode == false) {
                this.isTouchDevice = false;
            }
        },

        _addHandlers: function () {
            var self = this;
            if (self.isTouchDevice) {
                this.addHandler(this.btnThumb, $.jqx.mobile.getTouchEventName('touchend'), function (event) {
                    var btnThumbPressedClass = self.vertical ? self.toThemeProperty('jqx-scrollbar-thumb-state-pressed') : self.toThemeProperty('jqx-scrollbar-thumb-state-pressed-horizontal');
                    var btnThumbPressedFillClass = self.toThemeProperty('jqx-fill-state-pressed');
                    self.btnThumb.removeClass(btnThumbPressedClass);
                    self.btnThumb.removeClass(btnThumbPressedFillClass);
                    if (!self.disabled) self.handlemouseup(self, event);
                });

                this.addHandler(this.btnThumb, $.jqx.mobile.getTouchEventName('touchstart'), function (event) {
                    if (!self.disabled) {
                        if (self.touchMode == true) {
                            event.clientX = event.originalEvent.clientX;
                            event.clientY = event.originalEvent.clientY;
                        }
                        else {
                            var e = event;
                            if (e.originalEvent.touches && e.originalEvent.touches.length) {
                                event.clientX = e.originalEvent.touches[0].clientX;
                                event.clientY = e.originalEvent.touches[0].clientY;
                            }
                            else {
                                event.clientX = event.originalEvent.clientX;
                                event.clientY = event.originalEvent.clientY;
                            }
                        }

                        self.handlemousedown(event);
                    }
                });

                $.jqx.mobile.touchScroll(this.element, self.max, function (left, top, dx, dy, event) {
                    if (self.host.css('visibility') == 'visible') {
                        if (self.touchMode == true) {
                            event.clientX = event.originalEvent.clientX;
                            event.clientY = event.originalEvent.clientY;
                        }
                        else {
                            var e = event;
                            if (e.originalEvent.touches && e.originalEvent.touches.length) {
                                event.clientX = e.originalEvent.touches[0].clientX;
                                event.clientY = e.originalEvent.touches[0].clientY;
                            }
                            else {
                                event.clientX = event.originalEvent.clientX;
                                event.clientY = event.originalEvent.clientY;
                            }
                        }
                        var btnThumbPressedClass = self.vertical ? self.toThemeProperty('jqx-scrollbar-thumb-state-pressed') : self.toThemeProperty('jqx-scrollbar-thumb-state-pressed-horizontal');
                        self.btnThumb.addClass(btnThumbPressedClass);
                        self.btnThumb.addClass(self.toThemeProperty('jqx-fill-state-pressed'));

                        self.handlemousemove(event);
                    }
                }, self.element.id);
            }

            this.addHandler(this.btnUp, 'click', function (event) {
                var step = self.step;
                if (self.rtl && !self.vertical) {
                    step = -self.step;
                }

                if (self.buttonUpCapture && !self.isTouchDevice) {
                    if (!self.disabled) {
                        self.setPosition(self.value - step);
                    }
                }
                else if (!self.disabled && self.isTouchDevice) {
                    self.setPosition(self.value - step);
                }
            });
            this.addHandler(this.btnDown, 'click', function (event) {
                var step = self.step;
                if (self.rtl && !self.vertical) {
                    step = -self.step;
                }

                if (self.buttonDownCapture && !self.isTouchDevice) {
                    if (!self.disabled) self.setPosition(self.value + step)
                }
                else if (!self.disabled && self.isTouchDevice) self.setPosition(self.value + step);
            });

            if (!this.isTouchDevice) {
                try
                {
                    if (document.referrer != "" || window.frameElement) {
                        if (window.top != null && window.top != window.self) {
                            var parentLocation = null;
                            if (window.parent && document.referrer) {
                                parentLocation = document.referrer;
                            }

                            if (parentLocation && parentLocation.indexOf(document.location.host) != -1) {
                                var eventHandle = function (event) {
                                    if (!self.disabled) self.handlemouseup(self, event);
                                };

                                if (window.top.document.addEventListener) {
                                    window.top.document.addEventListener('mouseup', eventHandle, false);

                                } else if (window.top.document.attachEvent) {
                                    window.top.document.attachEvent("on" + 'mouseup', eventHandle);
                                }
                            }
                        }
                    }
                }
                catch (error) {
                }

                this.addHandler(this.btnDown, 'mouseup', function (event) {
                    if (!self.btnDownInstance.base.disabled && self.buttonDownCapture) {
                        self.buttonDownCapture = false;
                        self.btnDown.removeClass(self.toThemeProperty('jqx-scrollbar-button-state-pressed'));
                        self.btnDown.removeClass(self.toThemeProperty('jqx-fill-state-pressed'));
                        self._removeArrowClasses('pressed', 'down');
                        self.handlemouseup(self, event);
                        var step = self.step;
                        if (self.rtl && !self.vertical) {
                            step = -self.step;
                        }
                        self.setPosition(self.value + step)
                        return false;
                    }
                });
                this.addHandler(this.btnUp, 'mouseup', function (event) {
                    if (!self.btnUpInstance.base.disabled && self.buttonUpCapture) {
                        self.buttonUpCapture = false;
                        self.btnUp.removeClass(self.toThemeProperty('jqx-scrollbar-button-state-pressed'));
                        self.btnUp.removeClass(self.toThemeProperty('jqx-fill-state-pressed'));
                        self._removeArrowClasses('pressed', 'up');
                        self.handlemouseup(self, event);
                        var step = self.step;
                        if (self.rtl && !self.vertical) {
                            step = -self.step;
                        }
                        self.setPosition(self.value - step)
                        return false;
                    }
                });

                this.addHandler(this.btnDown, 'mousedown', function (event) {
                    if (!self.btnDownInstance.base.disabled) {
                        self.buttonDownCapture = true;
                        self.btnDown.addClass(self.toThemeProperty('jqx-fill-state-pressed'));
                        self.btnDown.addClass(self.toThemeProperty('jqx-scrollbar-button-state-pressed'));
                        self._addArrowClasses('pressed', 'down');
                        return false;
                    }
                });
                this.addHandler(this.btnUp, 'mousedown', function (event) {
                    if (!self.btnUpInstance.base.disabled) {
                        self.buttonUpCapture = true;
                        self.btnUp.addClass(self.toThemeProperty('jqx-fill-state-pressed'));
                        self.btnUp.addClass(self.toThemeProperty('jqx-scrollbar-button-state-pressed'));
                        self._addArrowClasses('pressed', 'up');
                        return false;
                    }
                });
            }

            var eventName = 'click';
            if (this.isTouchDevice) {
                eventName = $.jqx.mobile.getTouchEventName('touchend');
            }

            this.addHandler(this.areaUp, eventName, function (event) {
                if (!self.disabled) {
                    var step = self.largestep;
                    if (self.rtl && !self.vertical) {
                        step = -self.largestep;
                    }

                    self.setPosition(self.value - step); return false;
                }
            });
            this.addHandler(this.areaDown, eventName, function (event) {
                if (!self.disabled) {
                    var step = self.largestep;
                    if (self.rtl && !self.vertical) {
                        step = -self.largestep;
                    }
                    self.setPosition(self.value + step);
                    return false;
                }
            });
            this.addHandler(this.areaUp, 'mousedown', function (event) { if (!self.disabled) { self.areaUpCapture = true; return false; } });
            this.addHandler(this.areaDown, 'mousedown', function (event) { if (!self.disabled) { self.areaDownCapture = true; return false; } });

            this.addHandler(this.btnThumb, 'mousedown', function (event) {
                if (!self.disabled) {
                    self.handlemousedown(event);
                }
                return false;
            });
            this.addHandler(this.btnThumb, 'dragstart', function (event) {
                return false;
            });

            this.addHandler($(document), 'mouseup.' + this.element.id, function (event) { if (!self.disabled) self.handlemouseup(self, event); });

            if (!this.isTouchDevice) {
                this.mousemoveFunc = function (event) {
                    if (!self.disabled) {
                        self.handlemousemove(event);
                    }
                }

                this.addHandler($(document), 'mousemove.' + this.element.id, this.mousemoveFunc);
                this.addHandler($(document), 'mouseleave.' + this.element.id, function (event) { if (!self.disabled) self.handlemouseleave(event); });
                this.addHandler($(document), 'mouseenter.' + this.element.id, function (event) { if (!self.disabled) self.handlemouseenter(event); });

                if (!self.disabled) {
                    this.addHandler(this.btnUp, 'mouseenter', function () {
                        if (!self.disabled && !self.btnUpInstance.base.disabled && self.touchMode != true) {
                            self.btnUp.addClass(self.toThemeProperty('jqx-scrollbar-button-state-hover'));
                            self.btnUp.addClass(self.toThemeProperty('jqx-fill-state-hover'));
                            self._addArrowClasses('hover', 'up');
                        }});
                    this.addHandler(this.btnUp, 'mouseleave', function () {
                        if (!self.disabled && !self.btnUpInstance.base.disabled && self.touchMode != true) {
                            self.btnUp.removeClass(self.toThemeProperty('jqx-scrollbar-button-state-hover'));
                            self.btnUp.removeClass(self.toThemeProperty('jqx-fill-state-hover'));
                            self._removeArrowClasses('hover', 'up');                       
                        }});

                    var thumbHoverClass = self.toThemeProperty('jqx-scrollbar-thumb-state-hover');
                    if (!self.vertical) {
                        thumbHoverClass = self.toThemeProperty('jqx-scrollbar-thumb-state-hover-horizontal');
                    }

                    this.addHandler(this.btnThumb, 'mouseenter', function () {
                        if (!self.disabled && self.touchMode != true) {
                            self.btnThumb.addClass(thumbHoverClass);
                            self.btnThumb.addClass(self.toThemeProperty('jqx-fill-state-hover'));
                        }
                    });

                    this.addHandler(this.btnThumb, 'mouseleave', function () {
                        if (!self.disabled && self.touchMode != true) {
                            self.btnThumb.removeClass(thumbHoverClass);
                            self.btnThumb.removeClass(self.toThemeProperty('jqx-fill-state-hover'));
                        }
                    });

                    this.addHandler(this.btnDown, 'mouseenter', function () {
                        if (!self.disabled && !self.btnDownInstance.base.disabled && self.touchMode != true) {
                            self.btnDown.addClass(self.toThemeProperty('jqx-scrollbar-button-state-hover'));
                            self.btnDown.addClass(self.toThemeProperty('jqx-fill-state-hover'));
                            self._addArrowClasses('hover', 'down');
                        }
                    });

                    this.addHandler(this.btnDown, 'mouseleave', function () {
                        if (!self.disabled && !self.btnDownInstance.base.disabled && self.touchMode != true) {
                            self.btnDown.removeClass(self.toThemeProperty('jqx-scrollbar-button-state-hover'));
                            self.btnDown.removeClass(self.toThemeProperty('jqx-fill-state-hover'));
                            self._removeArrowClasses('hover', 'down');
                        }
                    });
                }
            }
        },

        destroy: function () {
            var btnUp = this.btnUp;
            var btnDown = this.btnDown;
            var btnThumb = this.btnThumb;
            var elWrap = this.scrollWrap;
            var areaUp = this.areaUp;
            var areaDown = this.areaDown;

            this.arrowUp.remove();
            delete this.arrowUp;
            this.arrowDown.remove();
            delete this.arrowDown;

            areaDown.removeClass();
            areaUp.removeClass();
            btnDown.removeClass();
            btnUp.removeClass();
            btnThumb.removeClass();

            btnUp.jqxRepeatButton('destroy');
            btnDown.jqxRepeatButton('destroy');
            areaUp.jqxRepeatButton('destroy');
            areaDown.jqxRepeatButton('destroy');
            btnThumb.jqxButton('destroy');
            var vars = $.data(this.element, "jqxScrollBar");

            this._removeHandlers();
            this.btnUp = null;
            this.btnDown = null;
            this.scrollWrap = null;
            this.areaUp = null;
            this.areaDown = null;
            this.scrollOuterWrap = null;
            delete this.mousemoveFunc;
            delete this.btnDownInstance;
            delete this.btnUpInstance;
            delete this.scrollOuterWrap;
            delete this.scrollWrap;          
            delete this.btnDown;
            delete this.areaDown;
            delete this.areaUp;
            delete this.btnDown;
            delete this.btnUp;
            delete this.btnThumb;
            delete this.propertyChangeMap['value'];
            delete this.propertyChangeMap['min'];
            delete this.propertyChangeMap['max'];
            delete this.propertyChangeMap['touchMode'];
            delete this.propertyChangeMap['disabled'];
            delete this.propertyChangeMap['theme'];
            delete this.propertyChangeMap;
            if (vars) {
                delete vars.instance;
            }
            this.host.removeData();
            this.host.remove();
            delete this.host;
            delete this.set;
            delete this.get;
            delete this.call;
            delete this.element;
        },

        _removeHandlers: function () {
            this.removeHandler(this.btnUp, 'mouseenter');
            this.removeHandler(this.btnDown, 'mouseenter');
            this.removeHandler(this.btnThumb, 'mouseenter');
            this.removeHandler(this.btnUp, 'mouseleave');
            this.removeHandler(this.btnDown, 'mouseleave');
            this.removeHandler(this.btnThumb, 'mouseleave');
            this.removeHandler(this.btnUp, 'click');
            this.removeHandler(this.btnDown, 'click');
            this.removeHandler(this.btnDown, 'mouseup');
            this.removeHandler(this.btnUp, 'mouseup');
            this.removeHandler(this.btnDown, 'mousedown');
            this.removeHandler(this.btnUp, 'mousedown');
            this.removeHandler(this.areaUp, 'mousedown');
            this.removeHandler(this.areaDown, 'mousedown');
            this.removeHandler(this.areaUp, 'click');
            this.removeHandler(this.areaDown, 'click');
            this.removeHandler(this.btnThumb, 'mousedown');
            this.removeHandler(this.btnThumb, 'dragstart');
            this.removeHandler($(document), 'mouseup.' + this.element.id);
            if (!this.mousemoveFunc) {
                this.removeHandler($(document), 'mousemove.' + this.element.id);
            }
            else {
                this.removeHandler($(document), 'mousemove.' + this.element.id, this.mousemoveFunc);
            }

            this.removeHandler($(document), 'mouseleave.' + this.element.id);
            this.removeHandler($(document), 'mouseenter.' + this.element.id);
            var self = this;
        },

        _addArrowClasses: function (state, button) {
            if (state == 'pressed') state = 'selected';
            if (state != '') {
                state = '-' + state;
            }

            if (this.vertical) {
                if (button == 'up' || button == undefined) {
                    this.arrowUp.addClass(this.toThemeProperty("jqx-icon-arrow-up" + state));
                }

                if (button == 'down' || button == undefined) {
                    this.arrowDown.addClass(this.toThemeProperty("jqx-icon-arrow-down" + state));
                }
            }
            else {
                if (button == 'up' || button == undefined) {
                    this.arrowUp.addClass(this.toThemeProperty("jqx-icon-arrow-left" + state));
                }

                if (button == 'down' || button == undefined) {
                    this.arrowDown.addClass(this.toThemeProperty("jqx-icon-arrow-right" + state));
                }
            }
        },

        _removeArrowClasses: function (state, button) {
            if (state == 'pressed') state = 'selected';
            if (state != '') {
                state = '-' + state;
            }

            if (this.vertical) {
                if (button == 'up' || button == undefined) {
                    this.arrowUp.removeClass(this.toThemeProperty("jqx-icon-arrow-up" + state));
                }

                if (button == 'down' || button == undefined) {
                    this.arrowDown.removeClass(this.toThemeProperty("jqx-icon-arrow-down" + state));
                }
            }
            else {
                if (button == 'up' || button == undefined) {
                    this.arrowUp.removeClass(this.toThemeProperty("jqx-icon-arrow-left" + state));
                }

                if (button == 'down' || button == undefined) {
                    this.arrowDown.removeClass(this.toThemeProperty("jqx-icon-arrow-right" + state));
                }
            }
        },

        setTheme: function () {
            var btnUp = this.btnUp;
            var btnDown = this.btnDown;
            var btnThumb = this.btnThumb;
            var elWrap = this.scrollWrap;
            var areaUp = this.areaUp;
            var areaDown = this.areaDown;
            var arrowUp = this.arrowUp;
            var arrowDown = this.arrowDown;

            this.scrollWrap[0].className = this.toThemeProperty('jqx-reset');
            this.scrollOuterWrap[0].className = this.toThemeProperty('jqx-reset');

            var areaClassName = this.toThemeProperty('jqx-reset');
            this.areaDown[0].className = areaClassName;
            this.areaUp[0].className = areaClassName;

            var hostClass = this.toThemeProperty('jqx-scrollbar') + " " + this.toThemeProperty('jqx-widget') + " " + this.toThemeProperty('jqx-widget-content');
            this.element.className = hostClass;

            btnDown[0].className = this.toThemeProperty('jqx-scrollbar-button-state-normal');
            btnUp[0].className = this.toThemeProperty('jqx-scrollbar-button-state-normal');

            var thumbClass = "";
            if (this.vertical) {
                arrowUp[0].className = areaClassName + " " + this.toThemeProperty("jqx-icon-arrow-up");
                arrowDown[0].className = areaClassName + " " + this.toThemeProperty("jqx-icon-arrow-down");
                thumbClass = this.toThemeProperty('jqx-scrollbar-thumb-state-normal');
            }
            else {
                arrowUp[0].className = areaClassName + " " + this.toThemeProperty("jqx-icon-arrow-left");
                arrowDown[0].className = areaClassName + " " + this.toThemeProperty("jqx-icon-arrow-right");
                thumbClass = this.toThemeProperty('jqx-scrollbar-thumb-state-normal-horizontal');
            }
            thumbClass += " " + this.toThemeProperty('jqx-fill-state-normal');

            btnThumb[0].className = thumbClass;

            if (this.disabled) {
                elWrap.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
                elWrap.removeClass(this.toThemeProperty('jqx-scrollbar-state-normal'));
            }
            else {
                elWrap.addClass(this.toThemeProperty('jqx-scrollbar-state-normal'));
                elWrap.removeClass(this.toThemeProperty('jqx-fill-state-disabled'));
            }

            if (this.roundedCorners == 'all') {
                this.host.addClass(this.toThemeProperty('jqx-rc-all'));
                if (this.vertical) {
                    var rct = $.jqx.cssroundedcorners('top');
                    rct = this.toThemeProperty(rct);
                    btnUp.addClass(rct);

                    var rcb = $.jqx.cssroundedcorners('bottom');
                    rcb = this.toThemeProperty(rcb);
                    btnDown.addClass(rcb);

                }
                else {
                    var rcl = $.jqx.cssroundedcorners('left');
                    rcl = this.toThemeProperty(rcl);
                    btnUp.addClass(rcl);

                    var rcr = $.jqx.cssroundedcorners('right');
                    rcr = this.toThemeProperty(rcr);
                    btnDown.addClass(rcr);
                }
            }
            else {
                var rc = $.jqx.cssroundedcorners(this.roundedCorners);
                rc = this.toThemeProperty(rc);
                elBtnUp.addClass(rc);
                elBtnDown.addClass(rc);
            }

            var rc = $.jqx.cssroundedcorners(this.roundedCorners);
            rc = this.toThemeProperty(rc);
            if (!btnThumb.hasClass(rc)) {
                btnThumb.addClass(rc);
            }

            if (this.isTouchDevice && this.touchModeStyle != false) {
                this.showButtons = false;
                btnThumb.addClass(this.toThemeProperty('jqx-scrollbar-thumb-state-normal-touch'));
            }
        },

        // returns true, if the user is dragging the thumb or the increase or decrease button is pressed.
        isScrolling: function () {
            if (this.thumbCapture == undefined || this.buttonDownCapture == undefined || this.buttonUpCapture == undefined || this.areaDownCapture == undefined || this.areaUpCapture == undefined)
                return false;

            return this.thumbCapture || this.buttonDownCapture || this.buttonUpCapture || this.areaDownCapture || this.areaUpCapture;
        },

        handlemousedown: function (event) {
            if (this.thumbCapture == undefined || this.thumbCapture == false) {
                this.thumbCapture = true;
                var btnThumb = this.btnThumb;
                if (btnThumb != null) {
                    btnThumb.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
                    if (this.vertical) {
                        btnThumb.addClass(this.toThemeProperty('jqx-scrollbar-thumb-state-pressed'));
                    }
                    else {
                        btnThumb.addClass(this.toThemeProperty('jqx-scrollbar-thumb-state-pressed-horizontal'));
                    }
                }
            }

            this.dragStartX = event.clientX;
            this.dragStartY = event.clientY;
            this.dragStartValue = this.value;
        },

        toggleHover: function (event, element) {
            //element.toggleClass('jqx-fill-state-hover');
        },

        refresh: function () {
            this._arrange();
        },

        _setElementPosition: function (element, x, y) {
            if (!isNaN(x)) {
                if (parseInt(element[0].style.left) != parseInt(x)) {
                    element[0].style.left = x + 'px';
                }
            }
            if (!isNaN(y)) {
                if (parseInt(element[0].style.top) != parseInt(y)) {
                    element[0].style.top = y + 'px';
                }
            }
        },

        _setElementTopPosition: function (element, y) {
            if (!isNaN(y)) {
                element[0].style.top = y + 'px';
            }
        },

        _setElementLeftPosition: function (element, x) {
            if (!isNaN(x)) {
                element[0].style.left = x + 'px';
            }
        },

        handlemouseleave: function (event) {
            var btnUp = this.btnUp;
            var btnDown = this.btnDown;
                   
            if (this.buttonDownCapture || this.buttonUpCapture) {
                btnUp.removeClass(this.toThemeProperty('jqx-scrollbar-button-state-pressed'));
                btnDown.removeClass(this.toThemeProperty('jqx-scrollbar-button-state-pressed'));
                this._removeArrowClasses('pressed');
            }
         
            if (this.thumbCapture != true)
                return;

            var btnThumb = this.btnThumb;
            var btnThumbPressedClass = this.vertical ? this.toThemeProperty('jqx-scrollbar-thumb-state-pressed') : this.toThemeProperty('jqx-scrollbar-thumb-state-pressed-horizontal');
            btnThumb.removeClass(btnThumbPressedClass);
            btnThumb.removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
        },

        handlemouseenter: function (event) {
            var btnUp = this.btnUp;
            var btnDown = this.btnDown;

            if (this.buttonUpCapture) {
                btnUp.addClass(this.toThemeProperty('jqx-scrollbar-button-state-pressed'));
                btnUp.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
                this._addArrowClasses('pressed', 'up');
            }

            if (this.buttonDownCapture) {
                btnDown.addClass(this.toThemeProperty('jqx-scrollbar-button-state-pressed'));
                btnDown.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
                this._addArrowClasses('pressed', 'down');
            }

            if (this.thumbCapture != true)
                return;

            var btnThumb = this.btnThumb;
            if (this.vertical) {
                btnThumb.addClass(this.toThemeProperty('jqx-scrollbar-thumb-state-pressed'));
            }
            else {
                btnThumb.addClass(this.toThemeProperty('jqx-scrollbar-thumb-state-pressed-horizontal'));
            }
            btnThumb.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
        },

        handlemousemove: function (event) {
            var btnUp = this.btnUp;
            var btnDown = this.btnDown;
            var which = 0;

            if (btnDown == null || btnUp == null)
                return;

            if (btnUp != null && btnDown != null && this.buttonDownCapture != undefined && this.buttonUpCapture != undefined) {
                if (this.buttonDownCapture && event.which == which) {
                    btnDown.removeClass(this.toThemeProperty('jqx-scrollbar-button-state-pressed'));
                    btnDown.removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
                    this._removeArrowClasses('pressed', 'down');

                    this.buttonDownCapture = false;
                }
                else if (this.buttonUpCapture && event.which == which) {
                    btnUp.removeClass(this.toThemeProperty('jqx-scrollbar-button-state-pressed'));
                    btnUp.removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
                    this._removeArrowClasses('pressed', 'up');
                    this.buttonUpCapture = false;
                }
            }

            if (this.thumbCapture != true)
                return false;

            var btnThumb = this.btnThumb;

            if (event.which == which && !this.isTouchDevice) {
                this.thumbCapture = false;
                this._arrange();
                var btnThumbPressedClass = this.vertical ? this.toThemeProperty('jqx-scrollbar-thumb-state-pressed') : this.toThemeProperty('jqx-scrollbar-thumb-state-pressed-horizontal');
                btnThumb.removeClass(btnThumbPressedClass);
                btnThumb.removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
                return true;
            }

            if (event.preventDefault != undefined) {
                event.preventDefault();
            }

            if (event.originalEvent != null) {
                event.originalEvent.mouseHandled = true;
            }

            if (event.stopPropagation != undefined) {
                event.stopPropagation();
            }

            var diff = 0;

            try {
                if (!this.vertical)
                    diff = event.clientX - this.dragStartX;
                else
                    diff = event.clientY - this.dragStartY;
                var btnAndThumbSize = this._btnAndThumbSize;
                if (!this._btnAndThumbSize) {
                    btnAndThumbSize = (this.vertical) ?
                    btnUp.height() + btnDown.height() + btnThumb.height() :
                    btnUp.width() + btnDown.width() + btnThumb.width();
                }

                var ratio = (this.max - this.min) / (this.scrollBarSize - btnAndThumbSize);
                if (this.thumbStep == 'auto') {
                    diff *= ratio;
                }
                else {
                    diff *= ratio;
                    if (Math.abs(this.dragStartValue + diff - this.value) >= parseInt(this.thumbStep)) {
                        var step = Math.round(parseInt(diff) / this.thumbStep) * this.thumbStep;
                        if (this.rtl && !this.vertical) {
                            this.setPosition(this.dragStartValue - step);
                        }
                        else {
                            this.setPosition(this.dragStartValue + step);
                        }
                        return false;
                    }
                    else {
                        return false;
                    }
                }

                var step = diff;
                if (this.rtl && !this.vertical) {
                    step = -diff;
                }

                this.setPosition(this.dragStartValue + step);
            }
            catch (error) {
                alert(error);
            }

            return false;
        },

        handlemouseup: function (self, event) {
            var prevent = false;
        
            if (this.thumbCapture) {
                this.thumbCapture = false;

                var btnThumb = this.btnThumb;
                var btnThumbPressedClass = this.vertical ? this.toThemeProperty('jqx-scrollbar-thumb-state-pressed') : this.toThemeProperty('jqx-scrollbar-thumb-state-pressed-horizontal');
                btnThumb.removeClass(btnThumbPressedClass);
                btnThumb.removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
                prevent = true;
                this._mouseup = new Date();
            }

            this.areaDownCapture = this.areaUpCapture = false;
            if (this.buttonUpCapture || this.buttonDownCapture) {
                var btnUp = this.btnUp;
                var btnDown = this.btnDown;

                this.buttonUpCapture = false;
                this.buttonDownCapture = false;
                btnUp.removeClass(this.toThemeProperty('jqx-scrollbar-button-state-pressed'));
                btnDown.removeClass(this.toThemeProperty('jqx-scrollbar-button-state-pressed'));
                btnUp.removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
                btnDown.removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
                this._removeArrowClasses('pressed');

                prevent = true;
                this._mouseup = new Date();
            }

            if (prevent) {
                if (event.preventDefault != undefined) {
                    event.preventDefault();
                }

                if (event.originalEvent != null) {
                    event.originalEvent.mouseHandled = true;
                }

                if (event.stopPropagation != undefined) {
                    event.stopPropagation();
                }
            }
        },

        // sets the value.
        // @param Number. Sets the ScrollBar's value.
        setPosition: function (position, update) {
            var element = this.element;

            if (position == undefined || position == NaN)
                position = this.min;

            if (position >= this.max) {
                position = this.max;
            }

            if (position < this.min) {
                position = this.min;
            }

            if (this.value !== position || update == true) {
                if (position == this.max) {
                    var completeEvent = new jQuery.Event('complete');
                    this.host.trigger(completeEvent);
                }
                var oldvalue = this.value;
                if (this._triggervaluechanged) {
                    var event = new jQuery.Event('valuechanged');
                    event.previousValue = this.value;
                    event.currentValue = position;
                }

                this.value = position;
                this._positionelements();
                //this._arrange();

                if (this._triggervaluechanged) {
                    this.host.trigger(event);
                }

                if (this.valuechanged) {
                    this.valuechanged({ currentValue: this.value, previousvalue: oldvalue });
                }
            }

            return position;
        },

        _getThumbSize: function (scrollLen) {
            var diff = this.max - this.min;

            var size = 0;
            if (diff > 1) {
                size = (scrollLen / (diff + scrollLen) * scrollLen);
            }
            else if (diff == 1) {
                size = scrollLen;
            }

            if (this.thumbSize > 0) {
                size = this.thumbSize;
            }

            if (size < this.thumbMinSize)
                size = this.thumbMinSize;

            return Math.min(size, scrollLen);
        },

        _positionelements: function () {
            var element = this.element;
            var elAreaUp = this.areaUp;
            var elAreaDown = this.areaDown;
            var elBtnUp = this.btnUp;
            var elBtnDown = this.btnDown;
            var elThumb = this.btnThumb;
            var elWrap = this.scrollWrap;

            var height = this._height ? this._height : this.host.height();
            var width = this._width ? this._width : this.host.width();

            var btnSize = (!this.vertical) ? height : width;
            if (!this.showButtons) {
                btnSize = 0;
            }

            var scrollBarSize = (!this.vertical) ? width : height;
            this.scrollBarSize = scrollBarSize;
            var thumbSize = this._getThumbSize(scrollBarSize - 2 * btnSize);
            thumbSize = Math.round(thumbSize);

            if (thumbSize < this.thumbMinSize)
                thumbSize = this.thumbMinSize;

            if (height == NaN || height < 10)
                height = 10;

            if (width == NaN || width < 10)
                width = 10;

            btnSize += 2;
            this.btnSize = btnSize;

            var btnAndThumbSize = this._btnAndThumbSize;

            if (!this._btnAndThumbSize) {
                var btnAndThumbSize = (this.vertical) ?
                2 * this.btnSize + elThumb.outerHeight() :
                2 * this.btnSize + elThumb.outerWidth();

                btnAndThumbSize = Math.round(btnAndThumbSize);
            }

            var upAreaSize = (scrollBarSize - btnAndThumbSize) / (this.max - this.min) * (this.value - this.min);
            if (this.rtl && !this.vertical) {
                upAreaSize = (scrollBarSize - btnAndThumbSize) / (this.max - this.min) * (this.max - this.value - this.min);
            }

            upAreaSize = Math.round(upAreaSize);
            if (upAreaSize < 0) {
                upAreaSize = 0;
            }
            if (this.vertical) {
                var newDownSize = scrollBarSize - upAreaSize - btnAndThumbSize;
                if (newDownSize < 0) newDownSize = 0;
                elAreaDown[0].style.height = newDownSize + 'px';
                elAreaUp[0].style.height = upAreaSize + 'px';

                this._setElementTopPosition(elAreaUp, btnSize);
                this._setElementTopPosition(elThumb, btnSize + upAreaSize);
                this._setElementTopPosition(elAreaDown, btnSize + upAreaSize + thumbSize);
            }
            else {
                elAreaUp[0].style.width = upAreaSize + 'px';
                elAreaDown[0].style.width = scrollBarSize - upAreaSize - btnAndThumbSize + 'px';

                this._setElementLeftPosition(elAreaUp, btnSize);
                this._setElementLeftPosition(elThumb, btnSize + upAreaSize);
                this._setElementLeftPosition(elAreaDown, 2 + btnSize + upAreaSize + thumbSize);
            }
        },

        _arrange: function () {
            if (this._initialLayout) {
                this._initialLayout = false;
                return;
            }

            var element = this.element;
            var elAreaUp = this.areaUp;
            var elAreaDown = this.areaDown;
            var elBtnUp = this.btnUp;
            var elBtnDown = this.btnDown;
            var elThumb = this.btnThumb;
            var elWrap = this.scrollWrap;

            var height = parseInt(this.element.style.height);
            var width = parseInt(this.element.style.width);
            if (this.isPercentage) {
                var height = this.host.height();
                var width = this.host.width();
            }
           
            if (isNaN(height)) height = 0;
            if (isNaN(width)) width = 0;

            this._width = width;
            this._height = height;
            var btnSize = (!this.vertical) ? height : width;
            if (!this.showButtons) {
                btnSize = 0;
            }

            elBtnUp[0].style.width = btnSize + 'px';
            elBtnUp[0].style.height = btnSize + 'px';
            elBtnDown[0].style.width = btnSize + 'px';
            elBtnDown[0].style.height = btnSize + 'px';

            if (this.vertical) {
                elWrap[0].style.width = width + 2 + 'px';
            }
            else {
                elWrap[0].style.height = height + 2 + 'px';
            }

            // position the up button
            this._setElementPosition(elBtnUp, 0, 0);

            var btnSizeAndBorder = btnSize + 2;
            // position the down button
            if (this.vertical) {
                this._setElementPosition(elBtnDown, 0, height - btnSizeAndBorder);
            }
            else {
                this._setElementPosition(elBtnDown, width - btnSizeAndBorder, 0);
            }

            var scrollBarSize = (!this.vertical) ? width : height;
            this.scrollBarSize = scrollBarSize;
            var thumbSize = this._getThumbSize(scrollBarSize - 2 * btnSize);
            thumbSize = Math.round(thumbSize);

            if (thumbSize < this.thumbMinSize)
                thumbSize = this.thumbMinSize;

            var touchStyle = false;
            if (this.isTouchDevice && this.touchModeStyle != false) {
                touchStyle = true;
            }

            if (!this.vertical) {
                elThumb[0].style.width = thumbSize + 'px';
                elThumb[0].style.height = height + 'px';
                if (touchStyle && this.thumbTouchSize !== 0) {
                    elThumb.css({ height: this.thumbTouchSize + 'px' });
                    elThumb.css('margin-top', (this.host.height() - this.thumbTouchSize) / 2);
                }
            }
            else {
                elThumb[0].style.width = width + 'px';
                elThumb[0].style.height = thumbSize + 'px';

                if (touchStyle && this.thumbTouchSize !== 0) {
                    elThumb.css({ width: this.thumbTouchSize + 'px' });
                    elThumb.css('margin-left', (this.host.width() - this.thumbTouchSize) / 2);
                }
            }

            if (height == NaN || height < 10)
                height = 10;

            if (width == NaN || width < 10)
                width = 10;

            btnSize += 2;
            this.btnSize = btnSize;

            var btnAndThumbSize = (this.vertical) ?
                2 * this.btnSize + (2 + parseInt(elThumb[0].style.height)) :
                2 * this.btnSize + (2 + parseInt(elThumb[0].style.width));

            btnAndThumbSize = Math.round(btnAndThumbSize);
            this._btnAndThumbSize = btnAndThumbSize;

            var upAreaSize = (scrollBarSize - btnAndThumbSize) / (this.max - this.min) * (this.value - this.min);
            if (this.rtl && !this.vertical) {
                upAreaSize = (scrollBarSize - btnAndThumbSize) / (this.max - this.min) * (this.max - this.value - this.min);
            }
            upAreaSize = Math.round(upAreaSize);
            if (upAreaSize === -Infinity || upAreaSize == Infinity) upAreaSize = 0;
            if (isNaN(upAreaSize)) {
                upAreaSize = 0;
            }
            if (upAreaSize < 0) {
                upAreaSize = 0;
            }

            if (this.vertical) {
                var newAreaHeight = (scrollBarSize - upAreaSize - btnAndThumbSize);
                if (newAreaHeight < 0) newAreaHeight = 0;
                elAreaDown[0].style.height = newAreaHeight + 'px';
                elAreaDown[0].style.width = width + 'px';
                elAreaUp[0].style.height = upAreaSize + 'px';
                elAreaUp[0].style.width = width + 'px';

                var hostHeight = parseInt(this.element.style.height);
                if (this.isPercentage) {
                    hostHeight = this.host.height();
                }

                elThumb[0].style.visibility = 'inherit';

                if (hostHeight - 3 * parseInt(btnSize) < 0) {
                    elThumb[0].style.visibility = 'hidden';
                }
                else if (hostHeight < btnAndThumbSize) {
                    elThumb[0].style.visibility = 'hidden';
                }
                else if (this.element.style.visibility == 'visible') {
                    elThumb[0].style.visibility = 'inherit';
                }

                this._setElementPosition(elAreaUp, 0, btnSize);
                this._setElementPosition(elThumb, 0, btnSize + upAreaSize);
                this._setElementPosition(elAreaDown, 0, btnSize + upAreaSize + thumbSize);
            }
            else {
                if (upAreaSize > 0) {
                    elAreaUp[0].style.width = upAreaSize + 'px';
                }
                if (height > 0) {
                    elAreaUp[0].style.height = height + 'px';
                }
                var newAreaWidth = (scrollBarSize - upAreaSize - btnAndThumbSize);
                if (newAreaWidth < 0) newAreaWidth = 0;

                elAreaDown[0].style.width = newAreaWidth + 'px';
                elAreaDown[0].style.height = height + 'px';

                var hostWidth = parseInt(this.element.style.width);
                if (this.isPercentage) {
                    hostWidth = this.host.width();
                }

                elThumb[0].style.visibility = 'inherit';
                if (hostWidth - 3 * parseInt(btnSize) < 0) {
                    elThumb[0].style.visibility = 'hidden';
                }
                else if (hostWidth < btnAndThumbSize) {
                    elThumb[0].style.visibility = 'hidden';
                }
                else if (this.element.style.visibility == 'visible') {
                    elThumb[0].style.visibility = 'inherit';
                }

                this._setElementPosition(elAreaUp, btnSize, 0);
                this._setElementPosition(elThumb, btnSize + upAreaSize, 0);
                this._setElementPosition(elAreaDown, 2 + btnSize + upAreaSize + thumbSize, 0);
            }
        }
    }); // jqxScrollBar
})(jQuery);

(function ($) {

    $.jqx.jqxWidget("jqxPanel", "", {});

    $.extend($.jqx._jqxPanel.prototype, {

        defineInstance: function () {
            //Type: String.
            //Default: null.
            //Sets the panel width.
            this.width = null;
            //Type: String.
            //Default: null.
            //Sets the panel height.
            this.height = null;
            // gets or sets whether the panel is disabled.
            this.disabled = false;
            // Type: Number
            // Default: 15
            // gets or sets the scrollbars size.
            this.scrollBarSize = $.jqx.utilities.scrollBarSize;
            // Type: String
            // Default: 'fixed'
            // Sets the sizing mode. In the 'fixed' mode, the panel displays scrollbars, if its content requires it. 
            // In the wrap mode, the scrollbars are not displayed and the panel automatically changes its size.
            // Possible Values: 'fixed', 'wrap'
            this.sizeMode = 'fixed';
            // Type: Boolean
            // Default: false
            // Automatically updates the panel, if its children size is changed.
            this.autoUpdate = false;
            // Type: Number
            // Default: 500
            // Gets or sets the autoUpdate interval.
            this.autoUpdateInterval = 500;
            this.touchMode = 'auto';
            this.horizontalScrollBarMax = null;
            this.verticalScrollBarMax = null;
            this.touchModeStyle = 'auto';
            this.rtl = false;
            // jqxPanel events.
            this.events =
			[
            // occurs when the layout is performed.
		  	   'layout',
     		];
        },

        // creates a new jqxPanel instance.
        createInstance: function (args) {
            this.render();
        },

        render: function () {
            var self = this;
            this.host.addClass(this.toThemeProperty("jqx-panel"));
            this.host.addClass(this.toThemeProperty("jqx-widget"));
            this.host.addClass(this.toThemeProperty("jqx-widget-content"));
            this.host.addClass(this.toThemeProperty("jqx-rc-all"));

            var panelStructure = $("<div id='panelWrapper' style='overflow: hidden; width: 100%; height: 100%; background-color: transparent; -webkit-appearance: none; outline: none; align:left; border: 0px; padding: 0px; margin: 0px; left: 0px; top: 0px; valign:top; position: relative;'>" +
                "<div id='panelContent' style='-webkit-appearance: none; -moz-box-sizing: border-box; box-sizing: border-box; width: 100%; height: 100%; outline: none; border: none; padding: 0px; position: absolute; margin: 0px; align:left; valign:top; left: 0px; top: 0px;'/>" +
                "<div id='verticalScrollBar' style='align:left; valign:top; left: 0px; top: 0px; position: absolute;'/>" +
                "<div id='horizontalScrollBar' style='align:left; valign:top; left: 0px; top: 0px; position: absolute;'/>" +
                "<div id='bottomRight' style='align:left; valign:top; left: 0px; top: 0px; position: absolute;'/>" +
                "</div>");

            if (!this.host.jqxButton) {
                throw new Error("jqxPanel: Missing reference to jqxbuttons.js.");
            }
            if (!this.host.jqxScrollBar) {
                throw new Error("jqxPanel: Missing reference to jqxscrollbar.js.");
            }

            var children = this.host.children();
            this._rtl = false;
            if (children.length > 0 && children.css('direction') == 'rtl') {
                this.rtl = true;
                this._rtl = true;
            }

            this.host.wrapInner(panelStructure);
            var verticalScrollBar = this.host.find("#verticalScrollBar");
            verticalScrollBar[0].id = this.element.id + 'verticalScrollBar';

            this.vScrollBar = verticalScrollBar.jqxScrollBar({ 'vertical': true, rtl: this.rtl, touchMode: this.touchMode, theme: this.theme });
            var horizontalScrollBar = this.host.find("#horizontalScrollBar");
            horizontalScrollBar[0].id = this.element.id + 'horizontalScrollBar';
            this.hScrollBar = horizontalScrollBar.jqxScrollBar({ 'vertical': false, rtl: this.rtl, touchMode: this.touchMode, theme: this.theme });
            this.content = this.host.find("#panelContent");
            this.wrapper = this.host.find("#panelWrapper");
            this.content.addClass(this.toThemeProperty('jqx-widget-content'));
            this.wrapper[0].id = this.wrapper[0].id + this.element.id;
            this.content[0].id = this.content[0].id + this.element.id;
            this.bottomRight = this.host.find("#bottomRight").addClass(this.toThemeProperty('jqx-panel-bottomright'));
            this.bottomRight[0].id = 'bottomRight' + this.element.id;

            this.vScrollBar.css('visibility', 'inherit');
            this.hScrollBar.css('visibility', 'inherit');
            this.vScrollInstance = $.data(this.vScrollBar[0], 'jqxScrollBar').instance;
            this.hScrollInstance = $.data(this.hScrollBar[0], 'jqxScrollBar').instance;

            var me = this;
            this.propertyChangeMap['disabled'] = function (instance, key, oldVal, value) {
                me.vScrollBar.jqxScrollBar({ disabled: me.disabled });
                me.hScrollBar.jqxScrollBar({ disabled: me.disabled });
            };

            this.vScrollBar.jqxScrollBar({ disabled: this.disabled });
            this.hScrollBar.jqxScrollBar({ disabled: this.disabled });

            this._addHandlers();

            if (this.width == null) this.width = this.content.width();
            if (this.height == null) this.height = this.content.height();

            this._arrange();

            this.contentWidth = me.content[0].scrollWidth;
            this.contentHeight = me.content[0].scrollHeight;

            if (this.autoUpdate) {
                me._autoUpdate();
            }

            this.propertyChangeMap['autoUpdate'] = function (instance, key, oldVal, value) {
                if (me.autoUpdate) {
                    me._autoUpdate();
                }
                else {
                    clearInterval(me.autoUpdateId);
                    me.autoUpdateId = null;
                }
            }

            // unload
            this.addHandler($(window), 'unload', function () {
                if (me.autoUpdateId != null) {
                    clearInterval(me.autoUpdateId);
                    me.autoUpdateId = null;
                    me.destroy();
                }
            });

            this._updateTouchScrolling();
            this._render();
        },

        hiddenParent: function () {
            return $.jqx.isHidden(this.host);
        },

        _updateTouchScrolling: function () {
            var self = this;
            if (this.touchMode == true) {
                $.jqx.mobile.setMobileSimulator(this.element);
            }

            var isTouchDevice = this.isTouchDevice();
            if (isTouchDevice) {
                $.jqx.mobile.touchScroll(this.element, self.vScrollInstance.max, function (left, top) {
                    if (self.vScrollBar.css('visibility') != 'hidden') {
                        var oldValue = self.vScrollInstance.value;
                        self.vScrollInstance.setPosition(oldValue + top);
                    }
                    if (self.hScrollBar.css('visibility') != 'hidden') {
                        var oldValue = self.hScrollInstance.value;
                        self.hScrollInstance.setPosition(oldValue + left);
                    }
                }, this.element.id, this.hScrollBar, this.vScrollBar);
                this._arrange();
            }

            this.vScrollBar.jqxScrollBar({ touchMode: this.touchMode });
            this.hScrollBar.jqxScrollBar({ touchMode: this.touchMode });
        },

        isTouchDevice: function () {
            var isTouchDevice = $.jqx.mobile.isTouchDevice();
            if (this.touchMode == true) {
                isTouchDevice = true;
            }
            else if (this.touchMode == false) {
                isTouchDevice = false;
            }
            if (isTouchDevice && this.touchModeStyle != false) {
                this.scrollBarSize = $.jqx.utilities.touchScrollBarSize;
            }
            return isTouchDevice;
        },

        // append element.
        // @param element
        append: function (element) {
            if (element != null) {
                this.content.append(element);
                this._arrange();
            }
        },

        setcontent: function (html) {
            this.content[0].innerHTML = html;
            this._arrange();
            var that = this;
            setTimeout(function () {
                that._arrange();
            }, 100);
        },

        // prepend element.
        // @param element
        prepend: function (element) {
            if (element != null) {
                this.content.prepend(element);
                this._arrange();
            }
        },

        // clears the content.
        clearcontent: function () {
            this.content.text('');
            this.content.children().remove();
            this._arrange();
        },

        // remove element.
        // @param element
        remove: function (element) {
            if (element != null) {
                $(element).remove();
                this._arrange();
            }
        },

        _autoUpdate: function () {
            var me = this;
            this.autoUpdateId = setInterval(function () {
                var newWidth = me.content[0].scrollWidth;
                var newHeight = me.content[0].scrollHeight;
                var doarrange = false;
                if (me.contentWidth != newWidth) {
                    me.contentWidth = newWidth;
                    doarrange = true;
                }

                if (me.contentHeight != newHeight) {
                    me.contentHeight = newHeight;
                    doarrange = true;
                }

            //    if ($.jqx.browser.mozilla) doarrange = true;
                if (doarrange) {
                    me._arrange();
                }
            }, this.autoUpdateInterval);
        },

        _addHandlers: function () {
            var self = this;
            this.addHandler(this.vScrollBar, 'valuechanged', function (event) {
                self._render(self);
            });

            this.addHandler(this.hScrollBar, 'valuechanged', function (event) {
                self._render(self);
            });

            this.addHandler(this.host, 'mousewheel', function (event) {
                self.wheel(event, self);
            });

            this.addHandler(this.wrapper, 'scroll', function (event) {
                if (self.wrapper[0].scrollTop != 0) {
                    self.wrapper[0].scrollTop = 0;
                }

                if (self.wrapper[0].scrollLeft != 0) {
                    self.wrapper[0].scrollLeft = 0;
                }
            });
       
            this.addHandler(this.host, 'mouseleave', function (event) {
                self.focused = false;
            });

            this.addHandler(this.host, 'focus', function (event) {
                self.focused = true;
            });

            this.addHandler(this.host, 'blur', function (event) {
                self.focused = false;
            });

            this.addHandler(this.host, 'mouseenter', function (event) {
                self.focused = true;
            });
            $.jqx.utilities.resize(this.host, function () {
                if ($.jqx.isHidden(self.host))
                    return;

                self._arrange(false);
            });
        },

        _removeHandlers: function () {
            var self = this;
            this.removeHandler(this.vScrollBar, 'valuechanged');
            this.removeHandler(this.hScrollBar, 'valuechanged');
            this.removeHandler(this.host, 'mousewheel');
            this.removeHandler(this.host, 'mouseleave');
            this.removeHandler(this.host, 'focus');
            this.removeHandler(this.host, 'blur');
            this.removeHandler(this.host, 'mouseenter');
            this.removeHandler(this.wrapper, 'scroll');
            this.removeHandler($(window), 'resize.' + this.element.id);
        },

        // performs mouse wheel.
        wheel: function (event, self) {
            var delta = 0;
            // fix for IE8 and IE7
            if (event.originalEvent && $.jqx.browser.msie && event.originalEvent.wheelDelta) {
                delta = event.originalEvent.wheelDelta / 120;
            }

            if (!event) /* For IE. */
                event = window.event;
            if (event.wheelDelta) { /* IE/Opera. */
                delta = event.wheelDelta / 120;
            } else if (event.detail) { /** Mozilla case. */
                delta = -event.detail / 3;
            }

            if (delta) {
                var result = self._handleDelta(delta);

                if (!result) {
                    if (event.preventDefault)
                        event.preventDefault();
                }

                if (!result) {
                    return result;
                }
                else return false;
            }

            if (event.preventDefault)
                event.preventDefault();
            event.returnValue = false;
        },

        // scrolls down.
        scrollDown: function () {
            if (this.vScrollBar.css('visibility') == 'hidden')
                return false;

            var vScrollInstance = this.vScrollInstance;
            if (vScrollInstance.value + vScrollInstance.largestep <= vScrollInstance.max) {
                vScrollInstance.setPosition(vScrollInstance.value + vScrollInstance.largestep);
                return true;
            }
            else {
                if (vScrollInstance.value + vScrollInstance.largestep != vScrollInstance.max) {
                    vScrollInstance.setPosition(vScrollInstance.max);
                    return true;
                }
            }

            return false;
        },

        // scrolls up.
        scrollUp: function () {
            if (this.vScrollBar.css('visibility') == 'hidden')
                return false;

            var vScrollInstance = this.vScrollInstance;
            if (vScrollInstance.value - vScrollInstance.largestep >= vScrollInstance.min) {
                vScrollInstance.setPosition(vScrollInstance.value - vScrollInstance.largestep);
                return true;
            }
            else {
                if (vScrollInstance.value - vScrollInstance.largestep != vScrollInstance.min) {
                    vScrollInstance.setPosition(vScrollInstance.min);
                    return true;
                }
            }
            return false;
        },

        _handleDelta: function (delta) {
            if (this.focused) {
                var oldvalue = this.vScrollInstance.value;
                if (delta < 0) {
                    this.scrollDown();
                }
                else this.scrollUp();
                var newvalue = this.vScrollInstance.value;
                if (oldvalue != newvalue) {
                    return false;
                }
            }

            return true;
        },

        _render: function (self) {
            if (self == undefined) self = this;
            var vScroll = self.vScrollInstance.value;
            var hScroll = self.hScrollInstance.value;
            if (this.rtl) {
                if (this.hScrollBar[0].style.visibility != 'hidden') {
                    if (this._rtl == false) {
                        hScroll = self.hScrollInstance.max - hScroll;
                    }
                    else {
                        hScroll = -self.hScrollInstance.value;
                    }
                }
            }
            self.content.css({ left: -hScroll + 'px', top: -vScroll + 'px' });
        },

        // Moves the scrollbars to a specific position.
        // @param left. Specifies the horizontal scrollbar position.
        // @param top. Specifies the vertical scrollbar position.
        scrollTo: function (left, top) {
            if (left == undefined || top == undefined)
                return;

            this.vScrollInstance.setPosition(top);
            this.hScrollInstance.setPosition(left);
        },

        // Gets scrollable height.
        getScrollHeight: function () {
            return this.vScrollInstance.max;
        },

        // Gets vertical scroll position.
        getVScrollPosition: function () {
            return this.vScrollInstance.value;
        },

        // Gets scrollable width.
        getScrollWidth: function () {
            return this.hScrollInstance.max;
        },

        // gets the horizontal scroll position.
        getHScrollPosition: function () {
            return this.hScrollInstance.value;
        },

        _getScrollSize: function () {
            // scrollbar Size.
            var scrollSize = this.scrollBarSize;
            if (isNaN(scrollSize)) {
                scrollSize = parseInt(scrollSize);
                if (isNaN(scrollSize)) {
                    scrollSize = '17px';
                }
                else scrollSize = scrollSize + 'px';
            }

            if (this.isTouchDevice()) {
                scrollSize = $.jqx.utilities.touchScrollBarSize;
            }

            scrollSize = parseInt(scrollSize);
            return scrollSize;
        },

        _getScrollArea: function () {
            var contentLeft = 0;
            this.content.css('margin-right', '0px');
            this.content.css('max-width', '9999999px');
            if ($.jqx.browser.msie && $.jqx.browser.version < 10) {
                contentLeft = parseInt(this.content.css('left'));
                this.content.css('left', 0);
            }
            this.content.css('overflow', 'auto');
            if (this.rtl) {
                this.content.css('direction', 'rtl');
            }
            var contentWidth = parseInt(this.content[0].scrollWidth);
            $.each(this.content.children(), function () {
                contentWidth = Math.max(contentWidth, this.scrollWidth);
                contentWidth = Math.max(contentWidth, $(this).outerWidth());
            });
            if ($.jqx.browser.msie && $.jqx.browser.version < 10) {
                this.content.css('left', contentLeft);
            }

            var contentHeight = parseInt(this.content[0].scrollHeight);
            this.content.css('overflow', 'visible');

            if ($.jqx.browser.msie && $.jqx.browser.version < 9) {
                var contentHeight = parseInt(this.content[0].scrollHeight);

                switch (this.sizeMode) {
                    case "wrap":
                        var contentHeight = parseInt(this.content[0].scrollHeight);
                        var contentWidth = parseInt(this.content[0].scrollWidth);
                        break;
                    case "horizontalWrap":
                    case "horizontalwrap":
                        break;
                    case "verticalWrap":
                    case "verticalwrap":
                        var contentHeight = parseInt(this.content[0].scrollHeight);
                        break;
                }
            }
            if (this.rtl) {
                this.content.css('direction', 'ltr');
            }

            return { width: contentWidth, height: contentHeight };
        },

        _arrange: function (updateDefaultSize) {
            if (updateDefaultSize !== false) {
                if (this.width != null) {
                    this.host.width(this.width);
                }
                if (this.height != null) {
                    this.host.height(this.height);
                }
            }

            var scrollSize = this._getScrollSize();
            var width = this.host.width();
            var height = this.host.height();
            var contentArea = this._getScrollArea();
            var contentWidth = contentArea.width;
            var contentHeight = contentArea.height;
            var vScrollMaximum = contentHeight - parseInt(Math.round(this.host.height()));
            var hScrollMaximum = contentWidth -  parseInt(Math.round(this.host.width()));
            // sync with user defined horizontalScrollBarMax and verticalScrollBarMax
            if (this.horizontalScrollBarMax != undefined) {
                hScrollMaximum = this.horizontalScrollBarMax;
            }
            if (this.verticalScrollBarMax != undefined) {
                vScrollMaximum = this.verticalScrollBarMax;
            }

            var updateVScrollVisibility = function (that, vScrollMaximum) {
                var borderOffset = 5;
                // update vertical scroll's visibility.
                if (vScrollMaximum > borderOffset) {
                    that.vScrollBar.jqxScrollBar({ 'max': vScrollMaximum });
                    that.vScrollBar.css('visibility', 'inherit');
                }
                else {
                    that.vScrollBar.jqxScrollBar('setPosition', 0);
                    that.vScrollBar.css('visibility', 'hidden');
                }
            }

            var updateHScrollVisibility = function (that, hScrollMaximum) {
                // update horizontal scroll's visibility.
                if (hScrollMaximum > 0) {
                    if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                        if (hScrollMaximum - 10 <= scrollSize) {
                            that.hScrollBar.css('visibility', 'hidden');
                            that.hScrollBar.jqxScrollBar('setPosition', 0);
                        }
                        else {
                            that.hScrollBar.jqxScrollBar({ 'max': hScrollMaximum + 4 });
                            that.hScrollBar.css('visibility', 'inherit');
                        }
                    }
                    else {
                        that.hScrollBar.jqxScrollBar({ 'max': hScrollMaximum + 4 });
                        that.hScrollBar.css('visibility', 'inherit');
                    }
                }
                else {
                    that.hScrollBar.css('visibility', 'hidden');
                    that.hScrollBar.jqxScrollBar('setPosition', 0);
                }
            }

            switch (this.sizeMode) {
                case "wrap":
                    this.host.width(contentWidth);
                    this.host.height(contentHeight);
                    this.vScrollBar.css('visibility', 'hidden');
                    this.hScrollBar.css('visibility', 'hidden');
                    return;
                case "horizontalWrap":
                case "horizontalwrap":
                    this.host.width(contentWidth);
                    this.hScrollBar.css('visibility', 'hidden');
                    updateVScrollVisibility(this, vScrollMaximum);
                    this._arrangeScrollbars(scrollSize, width, height);
                    return;
                case "verticalWrap":
                case "verticalwrap":
                    this.host.height(contentHeight);
                    this.vScrollBar.css('visibility', 'hidden');
                    updateHScrollVisibility(this, hScrollMaximum);
                    this._arrangeScrollbars(scrollSize, width, height);
                    return;
            }

            updateVScrollVisibility(this, vScrollMaximum);

            var borderSize = 2;
            // set maximum values.
            if (this.vScrollBar.css('visibility') != 'hidden') {
                if (this.horizontalScrollBarMax == undefined) {
                    hScrollMaximum += scrollSize + borderSize;
                }
            }
            updateHScrollVisibility(this, hScrollMaximum);

            if (this.hScrollBar.css('visibility') != 'hidden') {
                this.vScrollBar.jqxScrollBar({ 'max': vScrollMaximum + scrollSize + borderSize });
            }

            this._arrangeScrollbars(scrollSize, width, height);
        },

        _arrangeScrollbars: function (scrollSize, width, height) {
            var vscrollVisible = this.vScrollBar[0].style.visibility != 'hidden';
            var hscrollVisible = this.hScrollBar[0].style.visibility != 'hidden';

            var borderSize = 2;
            var scrollBorderSize = 2;

            this.hScrollBar.height(scrollSize);
            this.hScrollBar.css({ top: height - scrollSize - borderSize - scrollBorderSize + 'px', left: '0px' });
            this.hScrollBar.width(width - borderSize + 'px');

            this.vScrollBar.width(scrollSize);
            this.vScrollBar.height(parseInt(height) - borderSize + 'px');
            this.vScrollBar.css({ left: parseInt(width) - parseInt(scrollSize) - borderSize - scrollBorderSize + 'px', top: '0px' });
            if (this.rtl) {
                this.vScrollBar.css({ left: '0px' });
                var leftMargin = vscrollVisible ? parseInt(scrollSize) + 'px' : 0;
                if (this.content.children().css('direction') != 'rtl') {
                    var ie7 = false;
                    if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                        ie7 = true;
                    }
                    if (!ie7) {
                        this.content.css('padding-left', leftMargin);
                    }
                }
            }
            else {
                if (this.vScrollBar.css('visibility') != 'hidden') {
                    this.content.css('max-width', this.host.width() - this.vScrollBar.outerWidth());
                }
            }

            if ((this.vScrollBar.css('visibility') != 'hidden') && (this.hScrollBar.css('visibility') != 'hidden')) {
                this.bottomRight.css('visibility', 'inherit');
                this.bottomRight.css({ left: 1 + parseInt(this.vScrollBar.css('left')), top: 1 + parseInt(this.hScrollBar.css('top')) });
                this.bottomRight.width(parseInt(scrollSize) + 3);
                this.bottomRight.height(parseInt(scrollSize) + 3);
                if (this.rtl) {
                    this.bottomRight.css({ left: '0px' });
                    this.hScrollBar.css({ left: scrollSize + scrollBorderSize + 'px' });
                }
                this.hScrollBar.width(width - (1 * scrollSize) - borderSize - scrollBorderSize + 'px');
                this.vScrollBar.height(parseInt(height) - borderSize - scrollSize - scrollBorderSize + 'px');
            }
            else this.bottomRight.css('visibility', 'hidden');
            this.hScrollInstance.refresh();
            this.vScrollInstance.refresh();
        },

        destroy: function () {
            clearInterval(this.autoUpdateId);
            this.autoUpdateId = null;
            this.autoUpdate = false;
            $.jqx.utilities.resize(this.host, null, true);              
            this._removeHandlers();
            this.removeHandler($(window), 'unload');
            this.vScrollBar.jqxScrollBar('destroy');
            this.hScrollBar.jqxScrollBar('destroy');
            this.host.remove();
        },

        _raiseevent: function (id, oldValue, newValue) {
            if (this.isInitialized != undefined && this.isInitialized == true) {
                var evt = this.events[id];
                var event = new jQuery.Event(evt);
                event.previousValue = oldValue;
                event.currentValue = newValue;
                event.owner = this;
                var result = this.host.trigger(event);
                return result;
            }
        },

        beginUpdateLayout: function () {
            this.updating = true;
        },

        resumeUpdateLayout: function () {
            this.updating = false;
            this.vScrollInstance.value = 0;
            this.hScrollInstance.value = 0;
            this._arrange();
            this._render();
        },

        propertyChangedHandler: function (object, key, oldValue, value) {
            if (!object.isInitialized)
                return;

            if (key == 'rtl') {
                this.vScrollBar.jqxScrollBar({ rtl: value });
                this.hScrollBar.jqxScrollBar({ rtl: value });
                object._arrange();
            }

            if (!object.updating) {
                if (key == 'scrollBarSize' || key == 'width' || key == 'height') {
                    if (oldValue != value) {
                        object._arrange();
                    }
                }
            }
            if (key == 'touchMode') {
                if (value != 'auto') {
                    object._updateTouchScrolling();
                }
            }
            if (key == 'theme') {
                object.host.removeClass();
                object.host.addClass(this.toThemeProperty("jqx-panel"));
                object.host.addClass(this.toThemeProperty("jqx-widget"));
                object.host.addClass(this.toThemeProperty("jqx-widget-content"));
                object.host.addClass(this.toThemeProperty("jqx-rc-all"));
                object.vScrollBar.jqxScrollBar({ theme: this.theme });
                object.hScrollBar.jqxScrollBar({ theme: this.theme });
                object.bottomRight.removeClass();
                object.bottomRight.addClass(this.toThemeProperty('jqx-panel-bottomright'));
                object.content.removeClass();
                object.content.addClass(this.toThemeProperty('jqx-widget-content'));
            }
        },

        invalidate: function()
        {
            if ($.jqx.isHidden(this.host))
                return;
            
            this.refresh();
        },

        refresh: function (initialRefresh) {
            this._arrange();
        }
    });
})(jQuery);
﻿

(function ($) {

    $.jqx.jqxWidget("jqxTooltip", "", {});

    $.extend($.jqx._jqxTooltip.prototype, {
        defineInstance: function () {
            //// properties
            this.width = 'auto';
            this.height = 'auto';
            this.position = 'default'; // possible values: top, bottom, left, right, top-left, bottom-left, top-right, bottom-right, absolute, mouse, mouseenter, default
            this.enableBrowserBoundsDetection = true; // possible values: true, false
            this.content = '';
            this.left = 0;
            this.top = 0;
            this.absolutePositionX = 0;
            this.absolutePositionY = 0;
            this.trigger = 'hover'; // possible values: hover, click, none
            this.showDelay = 100;
            this.autoHide = true; // possible values: true, false
            this.autoHideDelay = 3000;
            this.closeOnClick = true; // possible values: true, false
            this.disabled = false; // possible values: true, false
            this.animationShowDelay = 200;
            this.animationHideDelay = 'fast';
            this.showArrow = true; // possible values: true, false
            this.name = '';
            this.opacity = 0.9;
            this.rtl = false;
            this._isOpen = false;
            this.opening = null;
            this.value = null;
            this._eventsMap = {
                'mousedown': $.jqx.mobile.getTouchEventName('touchstart'),
                'mouseup': $.jqx.mobile.getTouchEventName('touchend')
            };

            //// events
            this.events = ['open', 'close', 'opening', 'closing'];
        },

        createInstance: function (args) {
            this._isTouchDevice = $.jqx.mobile.isTouchDevice();

            // creates an array based on the name property for storing tooltip IDs
            var id_array = $.data(document.body, "_tooltipIDArray" + this.name);
            if (!id_array) {
                this.ID_Array = new Array();
                $.data(document.body, "_tooltipIDArray" + this.name, this.ID_Array);
            } else {
                this.ID_Array = id_array;
            };

            // generates a new ID and adds it to an array, based on the name property
            var key = this._generatekey();
            var newID = 'jqxtooltip' + key;
            this.ID_Array.push({ tooltipID: newID, tooltipHost: this.host });

            // appends the tooltip div to the body
            var tooltipHTML = $('<div id="' + newID + '"><div id ="' + newID + 'Main"><div id="' + newID + 'Text"></div></div><div id="' + newID + 'Arrow"></div></div>');
            if ($.jqx.browser.msie) {
                tooltipHTML.addClass(this.toThemeProperty('jqx-noshadow'));
            }

            $("body").append(tooltipHTML);

            // sets the tooltips theme and classes
            this._setTheme();

            // hides the tooltip divs
            var $newID = $("#" + newID);
            $newID.css("visibility", "hidden");
            $newID.css("display", "none");
            $newID.css("opacity", 0);
            $newID.css("z-index", 9999);

            // hides the tooltip's arrow
            if (this.showArrow == false) {
                $("#" + newID + "Arrow").css("visibility", "hidden");
                $("#" + newID + "Arrow").css("display", "none");
            };

            // sets the width and height of the tooltip
            this._setSize();

            // sets the content of the tooltip
            this._setContent();

            //sets the initial position of the tooltip
            //            this._initialPosition();

            // triggers the tooltip
            if (this.disabled == false) {
                this._trigger();
                if (this.closeOnClick == true) {
                    this._clickHide();
                };
            };
        },

        //// public methods

        // opens (shows) the tooltip
        open: function () {
            if (arguments) {
                if (arguments.length) {
                    if (arguments.length == 2) {
                        this.position = "absolute";
                        this.left = arguments[0];
                        this.top = arguments[1];
                        this.absolutePositionX = arguments[0];
                        this.absolutePositionY = arguments[1];
                    }
                }
            }

            if (this.disabled == false && this._id() != "removed") {
                if (this.position == 'mouse' || this.position == 'mouseenter') {
                    var tempPosition = this.position;
                    this.position = 'default';
                    this._raiseEvent('2');
                    this._setPosition();
                    this._animateShow();
                    this.position = tempPosition;
                } else {
                    this._raiseEvent('2');
                    this._setPosition();
                    this._animateShow();
                };
            };
        },

        close: function (delay) {
            var me = this;
            if ($.isEmptyObject(delay)) {
                delay = this.animationHideDelay;
            };
            var opacityValue = new Number($(this._id()).css("opacity")).toFixed(2);

            var hide = function () {
                clearTimeout(me.autoHideTimeout);
                me._raiseEvent('3');
                $(me._id()).animate({
                    opacity: 0
                }, delay, function () {
                    $(me._id()).css("visibility", "hidden");
                    $(me._id()).css("display", "none");
                    me._raiseEvent('1');
                    me._isOpen = false;
                });
            }

            if (this._isOpen == false && opacityValue != 0) {
                $(me._id()).stop();
                hide();
                return;
            }

            if (this._isOpen == true && opacityValue == this.opacity) {
                hide();
            };
        },

        // removes the tooltip
        destroy: function () {
            var length = this.ID_Array.length;
            this._removeHandlers();
            $(this._id()).remove();
            for (var i = 0; i < length; i++) {
                if (this.ID_Array[i].tooltipHost === this.host) {
                    this.ID_Array.splice(i, 1);
                    break;
                };
            };
            $(this.element).removeData('jqxTooltip');
        },

        //// private methods

        // refreshes the tooltip
        refresh: function (initialRefresh) {
            if (initialRefresh == true) {
                return;
            };

            if (this.rtl) {
                $(this._id() + 'Text').addClass(this.toThemeProperty('jqx-rtl'));
                $(this._id() + 'Text').css({ direction: 'rtl' });
            };

            var me = this;
            var opacityValue = new Number($(this._id()).css("opacity")).toFixed(2);
            if (this._id() != "removed") {
                if (this.disabled == true && this._isOpen == true && opacityValue == this.opacity) {
                    clearTimeout(this.autoHideTimeout);
                    $(this._id()).stop();
                    $(this._id()).animate({
                        opacity: 0
                    }, this.animationHideDelay, function () {
                        $(me._id()).css("visibility", "hidden");
                        $(me._id()).css("display", "none");
                        me._isOpen = false;
                    });
                };
                this._setTheme();
                this._setContent();
                this._setSize();
                if (this.position != 'mouse' && this.position != 'mouseenter') {
                    this._setPosition();
                };
                this._removeHandlers();
                if (this.disabled == false) {
                    this._trigger();
                    if (this.closeOnClick == true) {
                        this._clickHide();
                    };
                };
            };
        },

        // executed when a property is changed
        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (key == "content") {
                this.changeContentFlag = true;
            };
            object.refresh();
        },

        // raises an event
        _raiseEvent: function (id, args) {
            var evt = this.events[id];
            var event = new jQuery.Event(evt);
            event.owner = this;
            event.args = args;

            try {
                var result = this.host.trigger(event);
            }
            catch (error) {
            }

            return result;
        },

        // generates a random number, used for unique id
        _generatekey: function () {
            var S4 = function () {
                return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
            };
            return (S4() + S4());
        },

        // selects the id of the current tooltip
        _id: function () {
            var ID_tmp, True_ID;
            var length = this.ID_Array.length;
            for (var i = 0; i < length; i++) {
                if (this.ID_Array[i].tooltipHost === this.host) {
                    ID_tmp = this.ID_Array[i].tooltipID;
                    True_ID = "#" + ID_tmp;
                    break;
                };
            };
            if (True_ID == undefined) {
                True_ID = "removed";
            };
            return True_ID;
        },

        // positions the tooltip
        _setPosition: function (event) {
            if ((this._isOpen == false && $(this._id()).css("opacity") == 0) || this.changeContentFlag == true) {
                if (!event && (this.position == "mouse" || this.position == "mouseenter")) {
                    return;
                };
                $(this._id()).css('display', 'block');
                this.changeContentFlag = false;
                this.documentTop = $(document).scrollTop();
                this.documentLeft = $(document).scrollLeft();
                this.windowWidth = $(window).width();
                this.windowHeight = $(window).height();

                this.host_width = this.host.outerWidth();
                this.host_height = this.host.outerHeight();
                this.tooltip_width = $(this._id()).width();
                this.tooltip_height = $(this._id()).height();
                this.host_offset = this.host.offset();
                this.tooltip_offset = $(this._id()).offset();
                this.default_offset = 30;

                this.offset_horizontal = parseInt(this.left); // horizontal offset
                this.offset_vertical = parseInt(this.top); // vertical offset

                var $arrow = $(this._id() + 'Arrow');
                var $main = $(this._id() + 'Main');

                this.arrow_size = 5; // defines the size of the tooltip arrow
                this.tooltip_main_offset = $main.offset();
                this.tooltip_arrow_offset;

                switch (this.position) {
                    case 'top':
                        this.tooltip_offset.left = this.host_offset.left + this.host_width / 2 - this.tooltip_width / 2 + this.offset_horizontal;
                        this.tooltip_offset.top = this.host_offset.top - this.tooltip_height - this.arrow_size + this.offset_vertical;

                        this._detectBrowserBounds();

                        // arrow specifications
                        this.tooltip_main_offset = $main.offset();
                        $arrow.removeClass(this.toThemeProperty("jqx-tooltip-arrow-l-r"));
                        $arrow.addClass(this.toThemeProperty("jqx-tooltip-arrow-t-b"));
                        $arrow.css({ "border-width": this.arrow_size + "px " + this.arrow_size + "px  0px" });
                        this.tooltip_arrow_offset = $arrow.offset();
                        this.tooltip_arrow_offset.left = this.tooltip_main_offset.left + (($main.width()) / 2 - this.arrow_size);
                        this.tooltip_arrow_offset.top = this.tooltip_main_offset.top + $main.height();
                        $arrow.offset({ top: this.tooltip_arrow_offset.top, left: this.tooltip_arrow_offset.left });
                        break;

                    case 'bottom':
                        this.tooltip_offset.left = this.host_offset.left + this.host_width / 2 - this.tooltip_width / 2 + this.offset_horizontal;
                        this.tooltip_offset.top = this.host_offset.top + this.host_height + this.arrow_size + this.offset_vertical;

                        this._detectBrowserBounds();

                        // arrow specifications
                        this.tooltip_main_offset = $main.offset();
                        $arrow.removeClass(this.toThemeProperty("jqx-tooltip-arrow-l-r"));
                        $arrow.addClass(this.toThemeProperty("jqx-tooltip-arrow-t-b"));
                        $arrow.css({ "border-width": "0 " + this.arrow_size + "px " + this.arrow_size + "px" });
                        this.tooltip_arrow_offset = $arrow.offset();
                        this.tooltip_arrow_offset.left = this.tooltip_main_offset.left + (($main.width()) / 2 - this.arrow_size);
                        this.tooltip_arrow_offset.top = this.tooltip_main_offset.top - this.arrow_size;
                        $arrow.offset({ top: this.tooltip_arrow_offset.top, left: this.tooltip_arrow_offset.left });
                        break;

                    case 'left':
                        this.tooltip_offset.left = -1 + this.host_offset.left - this.tooltip_width - this.arrow_size + this.offset_horizontal;
                        this.tooltip_offset.top = this.host_offset.top + this.host_height / 2 - this.tooltip_height / 2 + this.offset_vertical;

                        this._detectBrowserBounds();

                        // arrow specifications
                        this.tooltip_main_offset = $main.offset();
                        $arrow.removeClass(this.toThemeProperty("jqx-tooltip-arrow-t-b"));
                        $arrow.addClass(this.toThemeProperty("jqx-tooltip-arrow-l-r"));
                        $arrow.css({ "border-width": this.arrow_size + "px 0px " + this.arrow_size + "px " + this.arrow_size + "px" });
                        this.tooltip_main_offset = $main.offset();
                        this.tooltip_arrow_offset = $arrow.offset();
                        this.tooltip_arrow_offset.left = 1 + this.tooltip_main_offset.left + $main.width();
                        this.tooltip_arrow_offset.top = this.tooltip_main_offset.top + ($main.height()) / 2 - this.arrow_size;
                        $arrow.offset({ top: this.tooltip_arrow_offset.top, left: this.tooltip_arrow_offset.left });
                        break;

                    case 'right':
                        this.tooltip_offset.left = this.host_offset.left + this.host_width + this.arrow_size + this.offset_horizontal;
                        this.tooltip_offset.top = this.host_offset.top + this.host_height / 2 - this.tooltip_height / 2 + this.offset_vertical;

                        this._detectBrowserBounds();

                        // arrow specifications
                        this.tooltip_main_offset = $main.offset();
                        $arrow.removeClass(this.toThemeProperty("jqx-tooltip-arrow-t-b"));
                        $arrow.addClass(this.toThemeProperty("jqx-tooltip-arrow-l-r"));
                        $arrow.css({ "border-width": this.arrow_size + "px " + this.arrow_size + "px " + this.arrow_size + "px 0px" });
                        this.tooltip_arrow_offset = $arrow.offset();
                        this.tooltip_arrow_offset.left = (this.tooltip_main_offset.left - this.arrow_size);
                        this.tooltip_arrow_offset.top = this.tooltip_main_offset.top + ($main.height()) / 2 - this.arrow_size;
                        $arrow.offset({ top: this.tooltip_arrow_offset.top, left: this.tooltip_arrow_offset.left });
                        break;

                    case 'top-left':
                        this.tooltip_offset.left = this.host_offset.left + this.default_offset - this.tooltip_width + this.offset_horizontal;
                        this.tooltip_offset.top = this.host_offset.top - this.tooltip_height - this.arrow_size + this.offset_vertical;

                        this._detectBrowserBounds();

                        // arrow specifications
                        this.tooltip_main_offset = $main.offset();
                        $arrow.removeClass(this.toThemeProperty("jqx-tooltip-arrow-l-r"));
                        $arrow.addClass(this.toThemeProperty("jqx-tooltip-arrow-t-b"));
                        $arrow.css({ "border-width": this.arrow_size + "px " + this.arrow_size + "px  0px" });
                        this.tooltip_arrow_offset = $arrow.offset();
                        this.tooltip_arrow_offset.left = this.tooltip_main_offset.left + $main.width() - 6 * this.arrow_size;
                        this.tooltip_arrow_offset.top = this.tooltip_main_offset.top + $main.height();
                        $arrow.offset({ top: this.tooltip_arrow_offset.top, left: this.tooltip_arrow_offset.left });
                        break;

                    case 'bottom-left':
                        this.tooltip_offset.left = this.host_offset.left + this.default_offset - this.tooltip_width + this.offset_horizontal;
                        this.tooltip_offset.top = this.host_offset.top + this.host_height + this.arrow_size + this.offset_vertical;

                        this._detectBrowserBounds();

                        // arrow specifications
                        this.tooltip_main_offset = $main.offset();
                        $arrow.removeClass(this.toThemeProperty("jqx-tooltip-arrow-l-r"));
                        $arrow.addClass(this.toThemeProperty("jqx-tooltip-arrow-t-b"));
                        $arrow.css({ "border-width": "0 " + this.arrow_size + "px " + this.arrow_size + "px" });
                        this.tooltip_arrow_offset = $arrow.offset();
                        this.tooltip_arrow_offset.left = this.tooltip_main_offset.left + $main.width() - 6 * this.arrow_size;
                        this.tooltip_arrow_offset.top = this.tooltip_main_offset.top - this.arrow_size;
                        $arrow.offset({ top: this.tooltip_arrow_offset.top, left: this.tooltip_arrow_offset.left });
                        break;

                    case 'top-right':
                        this.tooltip_offset.left = this.host_offset.left + this.host_width - this.default_offset + this.offset_horizontal;
                        this.tooltip_offset.top = this.host_offset.top - this.tooltip_height - this.arrow_size + this.offset_vertical;

                        this._detectBrowserBounds();

                        // arrow specifications
                        this.tooltip_main_offset = $main.offset();
                        $arrow.removeClass(this.toThemeProperty("jqx-tooltip-arrow-l-r"));
                        $arrow.addClass(this.toThemeProperty("jqx-tooltip-arrow-t-b"));
                        $arrow.css({ "border-width": this.arrow_size + "px " + this.arrow_size + "px  0px" });
                        this.tooltip_arrow_offset = $arrow.offset();
                        this.tooltip_arrow_offset.left = this.tooltip_main_offset.left + 4 * this.arrow_size;
                        this.tooltip_arrow_offset.top = this.tooltip_main_offset.top + $main.height();
                        $arrow.offset({ top: this.tooltip_arrow_offset.top, left: this.tooltip_arrow_offset.left });
                        break;

                    case 'bottom-right':
                        this.tooltip_offset.left = this.host_offset.left + this.host_width - this.default_offset + this.offset_horizontal;
                        this.tooltip_offset.top = this.host_offset.top + this.host_height + this.arrow_size + this.offset_vertical;

                        this._detectBrowserBounds();

                        // arrow specifications
                        this.tooltip_main_offset = $main.offset();
                        $arrow.removeClass(this.toThemeProperty("jqx-tooltip-arrow-l-r"));
                        $arrow.addClass(this.toThemeProperty("jqx-tooltip-arrow-t-b"));
                        $arrow.css({ "border-width": "0 " + this.arrow_size + "px " + this.arrow_size + "px" });
                        this.tooltip_arrow_offset = $arrow.offset();
                        this.tooltip_arrow_offset.left = this.tooltip_main_offset.left + 4 * this.arrow_size;
                        this.tooltip_arrow_offset.top = this.tooltip_main_offset.top - this.arrow_size;
                        $arrow.offset({ top: this.tooltip_arrow_offset.top, left: this.tooltip_arrow_offset.left });
                        break;

                    case 'absolute':
                        $(this._id()).offset({ top: this.absolutePositionY, left: this.absolutePositionX });

                        // arrow specifications, NO arrow
                        $arrow.css({ "border-width": "0px" });
                        break;

                    case 'mouse':
                        var me = this;
                        if (this._isTouchDevice == false) {
                            switch (this.trigger) {
                                case 'hover':
                                    if (this.mouseHoverTimeout) {
                                        clearTimeout(this.mouseHoverTimeout);
                                    }
                                    this.mouseHoverTimeout = setTimeout(function () {
                                        me.tooltip_offset.left = event.pageX + 10;
                                        me.tooltip_offset.top = event.pageY + 10;
                                        me._detectBrowserBounds();
                                    }, this.showDelay);
                                    break;
                                case 'click':
                                    this.tooltip_offset.left = event.pageX + 10;
                                    this.tooltip_offset.top = event.pageY + 10;
                                    this._detectBrowserBounds();
                                    break;
                            };
                        } else {
                            var x = event.pageX;
                            var y = event.pageY;
                            if (event.originalEvent) {
                                var touch = null;
                                if (event.originalEvent.touches && event.originalEvent.touches.length) {
                                    var touch = event.originalEvent.touches[0];
                                } else if (event.originalEvent.changedTouches && event.originalEvent.changedTouches.length) {
                                    var touch = event.originalEvent.changedTouches[0];
                                }
                                if (touch != undefined) {
                                    x = touch.pageX;
                                    y = touch.pageY;
                                }
                            }

                            this.tooltip_offset.left = x + 10;
                            this.tooltip_offset.top = y + 10;
                            this._detectBrowserBounds();
                        };

                        // arrow specifications, NO arrow
                        $arrow.css({ "border-width": "0px" });

                        break;

                    case 'mouseenter':
                        var mousecoordinates = { top: event.pageY, left: event.pageX };

                        // mouse from TOP
                        if ((mousecoordinates.top < (this.host_offset.top + 10)) && (mousecoordinates.top > (this.host_offset.top - 10))) {
                            this.tooltip_offset.left = mousecoordinates.left - this.tooltip_width / 2;
                            this.tooltip_offset.top = this.host_offset.top - this.tooltip_height - this.arrow_size;

                            this._detectBrowserBounds();

                            // arrow specifications, the same as TOP arrow
                            this.tooltip_main_offset = $main.offset();
                            $arrow.removeClass(this.toThemeProperty("jqx-tooltip-arrow-l-r"));
                            $arrow.addClass(this.toThemeProperty("jqx-tooltip-arrow-t-b"));
                            $arrow.css({ "border-width": this.arrow_size + "px " + this.arrow_size + "px  0px" });
                            this.tooltip_arrow_offset = $arrow.offset();
                            this.tooltip_arrow_offset.left = this.tooltip_main_offset.left + (($main.width()) / 2 - this.arrow_size);
                            this.tooltip_arrow_offset.top = this.tooltip_main_offset.top + $main.height();
                            $arrow.offset({ top: this.tooltip_arrow_offset.top, left: this.tooltip_arrow_offset.left });
                        }
                        // mouse from BOTTOM
                        else if ((mousecoordinates.top < ((this.host_offset.top + this.host_height) + 10)) && (mousecoordinates.top > ((this.host_offset.top + this.host_height) - 10))) {
                            this.tooltip_offset.left = mousecoordinates.left - this.tooltip_width / 2;
                            this.tooltip_offset.top = this.host_offset.top + this.host_height + this.arrow_size;

                            this._detectBrowserBounds();

                            // arrow specifications, the same as BOTTOM arrow
                            this.tooltip_main_offset = $main.offset();
                            $arrow.removeClass(this.toThemeProperty("jqx-tooltip-arrow-l-r"));
                            $arrow.addClass(this.toThemeProperty("jqx-tooltip-arrow-t-b"));
                            $arrow.css({ "border-width": "0 " + this.arrow_size + "px " + this.arrow_size + "px" });
                            this.tooltip_arrow_offset = $arrow.offset();
                            this.tooltip_arrow_offset.left = this.tooltip_main_offset.left + (($main.width()) / 2 - this.arrow_size);
                            this.tooltip_arrow_offset.top = this.tooltip_main_offset.top - this.arrow_size;
                            $arrow.offset({ top: this.tooltip_arrow_offset.top, left: this.tooltip_arrow_offset.left });
                        }
                        // mouse from LEFT
                        else if ((mousecoordinates.left < (this.host_offset.left + 10)) && (mousecoordinates.left > (this.host_offset.left - 10))) {
                            this.tooltip_offset.left = this.host_offset.left - this.tooltip_width - this.arrow_size;
                            this.tooltip_offset.top = mousecoordinates.top - this.tooltip_height / 2;

                            this._detectBrowserBounds();

                            // arrow specifications, the same as LEFT arrow
                            this.tooltip_main_offset = $main.offset();
                            $arrow.removeClass(this.toThemeProperty("jqx-tooltip-arrow-t-b"));
                            $arrow.addClass(this.toThemeProperty("jqx-tooltip-arrow-l-r"));
                            $arrow.css({ "border-width": this.arrow_size + "px 0px " + this.arrow_size + "px " + this.arrow_size + "px" });
                            this.tooltip_main_offset = $main.offset();
                            this.tooltip_arrow_offset = $arrow.offset();
                            this.tooltip_arrow_offset.left = this.tooltip_main_offset.left + $main.width();
                            this.tooltip_arrow_offset.top = this.tooltip_main_offset.top + ($main.height()) / 2 - this.arrow_size;
                            $arrow.offset({ top: this.tooltip_arrow_offset.top, left: this.tooltip_arrow_offset.left });
                        }
                        // mouse from RIGHT
                        else if ((mousecoordinates.left < (this.host_offset.left + this.host_width + 10)) && (mousecoordinates.left > (this.host_offset.left + this.host_width - 10))) {
                            this.tooltip_offset.left = this.host_offset.left + this.host_width + this.arrow_size;
                            this.tooltip_offset.top = mousecoordinates.top - this.tooltip_height / 2;

                            this._detectBrowserBounds();

                            // arrow specifications, the same as RIGHT arrow
                            this.tooltip_main_offset = $main.offset();
                            $arrow.removeClass(this.toThemeProperty("jqx-tooltip-arrow-t-b"));
                            $arrow.addClass(this.toThemeProperty("jqx-tooltip-arrow-l-r"));
                            $arrow.css({ "border-width": this.arrow_size + "px " + this.arrow_size + "px " + this.arrow_size + "px 0px" });
                            this.tooltip_main_offset = $main.offset();
                            this.tooltip_arrow_offset = $arrow.offset();
                            this.tooltip_arrow_offset.left = (this.tooltip_main_offset.left - this.arrow_size);
                            this.tooltip_arrow_offset.top = this.tooltip_main_offset.top + ($main.height()) / 2 - this.arrow_size;
                            $arrow.offset({ top: this.tooltip_arrow_offset.top, left: this.tooltip_arrow_offset.left });
                        };
                        break;

                    case 'default':

                        // similar to 'bottom-right' but without this.offset_horizontal and this.offset_vertical
                        this.tooltip_offset.left = this.host_offset.left + this.host_width - this.default_offset;
                        this.tooltip_offset.top = this.host_offset.top + this.host_height + this.arrow_size;

                        this._detectBrowserBounds();

                        // arrow specifications
                        this.tooltip_main_offset = $main.offset();
                        $arrow.removeClass(this.toThemeProperty("jqx-tooltip-arrow-l-r"));
                        $arrow.addClass(this.toThemeProperty("jqx-tooltip-arrow-t-b"));
                        $arrow.css({ "border-width": "0 " + this.arrow_size + "px " + this.arrow_size + "px" });
                        this.tooltip_arrow_offset = $arrow.offset();
                        this.tooltip_arrow_offset.left = this.tooltip_main_offset.left + 4 * this.arrow_size;
                        this.tooltip_arrow_offset.top = this.tooltip_main_offset.top - this.arrow_size;
                        $arrow.offset({ top: this.tooltip_arrow_offset.top, left: this.tooltip_arrow_offset.left });
                        break;
                };
            };
        },

        // sets the content of the tooltip
        _setContent: function () {
            $(this._id() + 'Text').html(this.content);
        },

        opened: function () {
            return this._isOpen && this.host.css('display') == 'block' && this.host.css('visibility') == 'visible';
        },

        // shows the tooltip with animation
        _animateShow: function () {
            this._closeAll();
            clearTimeout(this.autoHideTimeout);
            var opacityValue = new Number($(this._id()).css("opacity")).toFixed(2);
            if (this._isOpen == false && opacityValue == 0) {
                var me = this;
                var $id = $(this._id());
                $id.css("visibility", "visible");
                $id.css("display", "block");
                $id.stop();
                $id.css('opacity', 0);
                if (this.opening) {
                    var canOpen = this.opening(this);
                    if (canOpen === false)
                        return;
                }

                $id.animate({
                    opacity: this.opacity
                }, this.animationShowDelay, function () {
                    me._raiseEvent('0');
                    me._isOpen = true;

                    // creates a variable, showing the instance of the opened tooltip
                    var opened_tooltip = $.data(document.body, "_openedTooltip" + me.name);

                    me.openedTooltip = me;
                    $.data(document.body, "_openedTooltip" + me.name, me);
                    if (me.autoHideTimeout) clearTimeout(me.autoHideTimeout);
                    me.autoHideTimeout = setTimeout(function () {
                        me._autoHide();
                    }, me.autoHideDelay);
                });
            };
        },

        // triggers the tooltip
        _trigger: function () {
            if (this._id() != "removed") {
                this._enterFlag;
                this._leaveFlag;
                var me = this;
                if (this._isTouchDevice == false) {
                    switch (this.trigger) {
                        case 'hover':
                            if (this.position == 'mouse') {
                                this.addHandler(this.host, 'mousemove.tooltip', function (event) {
                                    if (me._enterFlag == 1) {
                                        me._raiseEvent('2');
                                        me._setPosition(event);
                                        clearTimeout(me.hoverShowTimeout);
                                        me.hoverShowTimeout = setTimeout(function () {
                                            me._animateShow();
                                            me._enterFlag = 0;
                                        }, me.showDelay);
                                    }
                                });
                                this.addHandler(this.host, 'mouseenter.tooltip', function () {
                                    if (me._leaveFlag != 0) {
                                        me._enterFlag = 1;
                                    };
                                });
                                this.addHandler(this.host, 'mouseleave.tooltip', function (event) {
                                    me._leaveFlag = 1;
                                    clearTimeout(me.hoverShowTimeout);

                                    var tooltipbounds = $(me._id()).offset();
                                    var width = $(me._id()).width();
                                    var height = $(me._id()).height();

                                    if (parseInt(event.pageX) < parseInt(tooltipbounds.left) || parseInt(event.pageX) > parseInt(tooltipbounds.left) + width) {
                                        me.close();
                                    }
                                    if (parseInt(event.pageY) < parseInt(tooltipbounds.top) || parseInt(event.pageY) > parseInt(tooltipbounds.top) + height) {
                                        me.close();
                                    }
                                });
                                this.addHandler($(this._id()), 'mouseleave.tooltip', function (event) {
                                    me._checkBoundariesAuto(event);
                                    if (me._clickFlag != 0 && me._autoFlag != 0) {
                                        me._leaveFlag = 0;
                                    } else {
                                        me._leaveFlag = 1;
                                        me.close();
                                    };
                                });
                            } else {
                                this.addHandler(this.host, 'mouseenter.tooltip', function (event) {
                                    clearTimeout(me.hoverShowTimeout);
                                    me.hoverShowTimeout = setTimeout(function () {
                                        me._raiseEvent('2');
                                        me._setPosition(event);
                                        me._animateShow();
                                    }, me.showDelay);
                                });
                                this.addHandler(this.host, 'mouseleave.tooltip', function (event) {
                                    me._leaveFlag = 1;
                                    clearTimeout(me.hoverShowTimeout);

                                    if (me.autoHide) {
                                        var x = event.pageX;
                                        var y = event.pageY;
                                        var tooltipbounds = $(me._id()).offset();
                                        var left = tooltipbounds.left;
                                        var top = tooltipbounds.top;
                                        var width = $(me._id()).width();
                                        var height = $(me._id()).height();

                                        if (parseInt(x) < parseInt(left) || parseInt(x) > parseInt(left) + width || parseInt(y) < parseInt(top) || parseInt(y) > parseInt(top) + height) {
                                            me.close();
                                        };
                                    };
                                });
                                this.addHandler($(this._id()), 'mouseleave.tooltip', function (event) {
                                    me._checkBoundariesAuto(event);
                                    if (me._clickFlag != 0 && me._autoFlag != 0) {
                                        me._leaveFlag = 0;
                                    } else {
                                        me._leaveFlag = 1;
                                        if (me.autoHide) {
                                            me.close();
                                        }
                                    };
                                });
                            };
                            break;
                        case 'click':
                            this.addHandler(this.host, 'click.tooltip', function (event) {
                                if (me.position == 'mouseenter') {
                                    me.position = 'mouse';
                                };
                                me._raiseEvent('2');
                                me._setPosition(event);
                                me._animateShow();
                            });
                            break;
                        case 'none':
                            break;
                    };
                } else {
                    // if the device is touch
                    if (this.trigger != "none") {
                        this.addHandler(this.host, 'touchstart.tooltip', function (event) {
                            if (me.position == 'mouseenter') {
                                me.position = 'mouse';
                            };
                            me._raiseEvent('2');
                            me._setPosition(event);
                            me._animateShow();
                        });
                    };
                };
            };
        },

        // automatically hides the tooltip
        _autoHide: function () {
            var me = this;

            var opacityValue = new Number($(this._id()).css("opacity")).toFixed(2);
            if (this.autoHide == true && this._isOpen == true && opacityValue >= this.opacity) {
                me._raiseEvent('3');
                $(me._id()).animate({
                    opacity: 0
                }, me.animationHideDelay, function () {
                    $(me._id()).css("visibility", "hidden");
                    $(me._id()).css("display", "none");
                    me._raiseEvent('1');
                    me._isOpen = false;
                });
            };
        },

        // hides the tooltip when it is clicked
        _clickHide: function () {
            var me = this;
            this.addHandler($(this._id()), 'click.tooltip', function (event) {
                me._checkBoundariesClick(event);
                me.close();
            });
        },

        // sets the width and height of the tooltip
        _setSize: function () {
            $(this._id()).css({ "width": this.width, "height": this.height });
        },

        // sets the tooltips theme and classes
        _setTheme: function () {
            var id = this._id();
            var $main = $(id + 'Main');
            var $text = $(id + 'Text');
            var $arrow = $(id + 'Arrow');

            $main.addClass(this.toThemeProperty("jqx-widget"));
            $text.addClass(this.toThemeProperty("jqx-widget"));
            $arrow.addClass(this.toThemeProperty("jqx-widget"));

            $main.addClass(this.toThemeProperty("jqx-fill-state-normal"));
            $text.addClass(this.toThemeProperty("jqx-fill-state-normal"));
            $arrow.addClass(this.toThemeProperty("jqx-fill-state-normal"));

            $(id).addClass(this.toThemeProperty("jqx-tooltip"));
            $(id).addClass(this.toThemeProperty("jqx-popup"));
            $main.addClass(this.toThemeProperty("jqx-tooltip-main"));
            $text.addClass(this.toThemeProperty("jqx-tooltip-text"));
            $arrow.addClass(this.toThemeProperty("jqx-tooltip-arrow"));
        },

        // sets the initial position of the tooltip as 'default'
        _initialPosition: function () {
            var tempPosition = this.position;
            this.position = 'default';
            this._setPosition();
            this.position = tempPosition;
        },

        // checks the tooltip for browser bounds conflicts and sets the tooltip's offset accordingly (if enableBrowserBoundsDetection == true), otherwise just sets the tooltip's offset
        _detectBrowserBounds: function () {
            var id = this._id();
            if (this.enableBrowserBoundsDetection) {
                // top and left
                if (this.tooltip_offset.top < this.documentTop && this.tooltip_offset.left < 0) {
                    $(id).offset({ top: this.documentTop, left: this.documentLeft });
                    // top and right
                } else if (this.tooltip_offset.top < this.documentTop && (this.tooltip_offset.left + this.tooltip_width) > this.windowWidth + this.documentLeft) {
                    $(id).offset({ top: this.documentTop, left: (this.windowWidth + this.documentLeft - this.tooltip_width) });
                    // top
                } else if (this.tooltip_offset.top < this.documentTop) {
                    $(id).offset({ top: this.documentTop, left: this.tooltip_offset.left });
                    // bottom and left
                } else if ((this.tooltip_offset.top + this.tooltip_height) > (this.windowHeight + this.documentTop) && this.tooltip_offset.left < 0) {
                    $(id).offset({ top: (this.windowHeight + this.documentTop - this.tooltip_height), left: this.documentLeft });
                    // bottom and right
                } else if ((this.tooltip_offset.top + this.tooltip_height) > (this.windowHeight + this.documentTop) && (this.tooltip_offset.left + this.tooltip_width) > this.windowWidth + this.documentLeft) {
                    $(id).offset({ top: (this.windowHeight + this.documentTop - this.tooltip_height), left: (this.windowWidth + this.documentLeft - this.tooltip_width) });
                    // bottom
                } else if ((this.tooltip_offset.top + this.tooltip_height) > (this.windowHeight + this.documentTop)) {
                    $(id).offset({ top: (this.windowHeight + this.documentTop - this.tooltip_height), left: this.tooltip_offset.left });
                    // left
                } else if (this.tooltip_offset.left < 0) {
                    $(id).offset({ top: this.tooltip_offset.top, left: this.documentLeft });
                    // right
                } else if ((this.tooltip_offset.left + this.tooltip_width) > this.windowWidth + this.documentLeft) {
                    $(id).offset({ top: this.tooltip_offset.top, left: (this.windowWidth + this.documentLeft - this.tooltip_width) });
                    // no conflict
                } else {
                    $(id).offset({ top: this.tooltip_offset.top, left: this.tooltip_offset.left });
                };
                // if enableBrowserBoundsDetection == false, the same as no conflict case
            } else {
                $(id).offset({ top: this.tooltip_offset.top, left: this.tooltip_offset.left });
            };
        },

        // checks if a mouseevent was within the boundaries of the host
        _checkBoundaries: function (event) {
            if (event.pageX >= this.host_offset.left && event.pageX <= (this.host_offset.left + this.host_width) && event.pageY >= this.host_offset.top && event.pageY <= (this.host_offset.top + this.host_height)) {
                return true;
            } else {
                return false;
            };
        },

        // checks if a click was within the boundaries of the host
        _checkBoundariesClick: function (event) {
            if (this._checkBoundaries(event)) {
                this._clickFlag = 1;
            } else {
                this._clickFlag = 0;
            };
        },

        // checks if the mouse was was within the boundaries of the host when the tooltip was automatically closed
        _checkBoundariesAuto: function (event) {
            if (this._checkBoundaries(event)) {
                this._autoFlag = 1;
            } else {
                this._autoFlag = 0;
            };
        },

        // removes all event handlers
        _removeHandlers: function () {
            this.removeHandler(this.host, 'mouseenter.tooltip');
            this.removeHandler(this.host, 'mousemove.tooltip');
            this.removeHandler(this.host, 'mouseleave.tooltip');
            this.removeHandler(this.host, 'click.tooltip');
            this.removeHandler(this.host, 'touchstart.tooltip');
            this.removeHandler($(this._id()), 'click.tooltip');
            this.removeHandler($(this._id()), 'mouseleave.tooltip');
        },

        // closes all tooltips, created together
        _closeAll: function () {
            var length = this.ID_Array.length;
            for (var i = 0; i < length; i++) {
                var itterationID = "#" + this.ID_Array[i].tooltipID;
                if (itterationID != this._id()) {
                    $(itterationID).css({ opacity: 0, visibility: "hidden", display: "none" });
                    this._isOpen = false;
                };
            };
        }
    });
})(jQuery);
(function ($) {

    $.jqx.jqxWidget("jqxCalendar", "", {});

    $.extend($.jqx._jqxCalendar.prototype, {
        defineInstance: function () {
            // enables or disables the Calendar control.
            this.disabled = false;

            // not available in this version.
            this.multipleMonthRows = 1;

            // not available in this version.
            this.multipleMonthColumns = 1;

            // Specifies the Calendar's minimum navigation date.
            if (this.minDate == undefined) {
                this.minDate = $.jqx._jqxDateTimeInput.getDateTime(new Date());
                this.minDate._setYear(1900);
                this.minDate._setMonth(1);
                this.minDate._setDay(1);
                this.minDate._setHours(0);
                this.minDate._setMinutes(0);
                this.minDate._setSeconds(0);
                this.minDate._setMilliseconds(0);
            }

            // Specifies the Calendar's maximum navigation date.
            if (this.maxDate == undefined) {
                this.maxDate = $.jqx._jqxDateTimeInput.getDateTime(new Date());
                this.maxDate._setYear(2100);
                this.maxDate._setMonth(1);
                this.maxDate._setDay(1);
                this.maxDate._setHours(0);
                this.maxDate._setMinutes(0);
                this.maxDate._setSeconds(0);
                this.maxDate._setMilliseconds(0);
            }
            this.min = new Date(1900, 0, 1);
            this.max = new Date(2100, 0, 1);

            this.navigationDelay = 400;
            // Type: Number
            // Default: 1
            // Gets or sets the navigation step.
            if (this.stepMonths === undefined) {
                this.stepMonths = 1; // Number of months to step back/forward
            }

            // Type: Number
            // Default: null
            // Gets or sets the Calendar's width.
            this.width = null;

            // Type: height
            // Default: null
            // Gets or sets the Calendar's height.
            this.height = null;

            // Type: $.jqx._jqxDateTimeInput.getDateTime
            // Default:  $.jqx._jqxDateTimeInput.getDateTime(new Date()); (Today)
            // Gets or sets the Calendar's value.
            if (this.value === undefined) {
                this.value = $.jqx._jqxDateTimeInput.getDateTime(new Date());
                this.value._setHours(0);
                this.value._setMinutes(0);
                this.value._setSeconds(0);
                this.value._setMilliseconds(0);
            }

            // Type: Number.
            // Default: 0
            // Gets or sets the first day of the week - Sunday = 0, Monday = 1, Tuesday = 2, Wednesday = 3, Thursday = 4, Friday = 5, Saturday = 6.
            this.firstDayOfWeek = 0;

            // Type: Boolean.
            // Default: false.
            // Shows or hides the week numbers.
            this.showWeekNumbers = false;

            // Type: Boolean.
            // Default: true.
            // Shows or hides the Day Names.
            this.showDayNames = true;

            // Type: Boolean
            // Default: false
            // Enables or disables the weekend highlight option.
            this.enableWeekend = false;

            // Type: Boolean
            // Default: true
            // Enables or disables the other month highlight.
            this.enableOtherMonthDays = true;

            // Type: Boolean
            // Default: true
            // Shows or hides the other month days.
            this.showOtherMonthDays = true;

            // Gets or sets the row header's width.
            // Type: Number.
            this.rowHeaderWidth = 25;

            // Default: 20
            // Gets or sets the column header's height.
            // Type: Number.
            this.columnHeaderHeight = 20;

            // Default: 25
            // Gets or sets the title's height.
            // Type: Number.
            this.titleHeight = 25;

            // Type: String.
            // Gets or sets the string format of the day names.
            // Possible values: default, shortest, firstTwoLetters, firstLetter, full
            this.dayNameFormat = 'firstTwoLetters';

            this.monthNameFormat = 'default';

            // Type: string.
            // Represents the title format displayed between the navigation arrow.
            this.titleFormat = ["MMMM yyyy", "yyyy", "yyyy", "yyyy"];
            this.enableViews = true;
            // Type: Boolean.
            // Default: false
            // Gets or sets the readonly state. In this state the user can navigate through the months, but is not allowed to select.
            if (this.readOnly === undefined) {
                this.readOnly = false;
            }

            //Type: string
            //Default: 'default'
            //Gets or sets the calendar's culture.
            if (this.culture == undefined) {
                this.culture = "default";
            }

            // Type: Boolean
            // Default: true.
            // Enables or disables the fast navigation when the user holds the mouse pressed over a navigation arrow.
            if (this.enableFastNavigation == undefined) {
                this.enableFastNavigation = true;
            }

            // Type: Boolean
            // Default: true
            // Enables or disables the hover state.
            if (this.enableHover == undefined) {
                this.enableHover = true;
            }

            // Type: Boolean
            // Default: true
            // When this property is true, click on other month date will automatically navigate to the previous or next month.
            if (this.enableAutoNavigation == undefined) {
                this.enableAutoNavigation = true;
            }

            // Type: Boolean
            // Default: false
            // enables or disabled the calendar tooltips.
            if (this.enableTooltips === undefined) {
                this.enableTooltips = false;
            }

            // Type: String
            // Back Button Text.
            this.backText = "Back";
            // Type: String
            // Forward Button Text.
            this.forwardText = "Forward";

            // Type: Array
            // Represents a collection of special calendar days.
            if (this.specialDates === undefined) {
                this.specialDates = new Array();
            }
            this.keyboardNavigation = true;
            // Selects a range of dates.
            this.selectionMode = 'default';
            this.todayString = 'Today';
            this.clearString = 'Clear';
            this.showFooter = false;
            this.selection = { from: null, to: null };
            this.canRender = true;
            this._checkForHiddenParent = true;
            //Type: Number.
            //Default: 0.
            //Sets height of the calendar in pixels. 
            this.height = null;
            this.rtl = false;
            // month, year, decade
            this.view = 'month';
            this.localization = {
                backString: "Back",
                forwardString: "Forward",
                todayString: "Today",
                clearString: "Clear",
                calendar: {
                    name: "Gregorian_USEnglish",
                    "/": "/",
                    // separator of parts of a time (e.g. ":" in 05:44 PM)
                    ":": ":",
                    // the first day of the week (0 = Sunday, 1 = Monday, etc)
                    firstDay: 0,
                    days: {
                        // full day names
                        names: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
                        // abbreviated day names
                        namesAbbr: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
                        // shortest day names
                        namesShort: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"]
                    },
                    months: {
                        // full month names (13 months for lunar calendards -- 13th month should be "" if not lunar)
                        names: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December", ""],
                        // abbreviated month names
                        namesAbbr: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", ""]
                    },
                    // AM and PM designators in one of these forms:
                    // The usual view, and the upper and lower case versions
                    //      [standard,lowercase,uppercase]
                    // The culture does not use AM or PM (likely all standard date formats use 24 hour time)
                    //      null
                    AM: ["AM", "am", "AM"],
                    PM: ["PM", "pm", "PM"],
                    eras: [
                    // eras in reverse chronological order.
                    // name: the name of the era in this culture (e.g. A.D., C.E.)
                    // start: when the era starts in ticks (gregorian, gmt), null if it is the earliest supported era.
                    // offset: offset in years from gregorian calendar
                        {"name": "A.D.", "start": null, "offset": 0 }
                    ],
                    twoDigitYearMax: 2029,
                    patterns: {
                        // short date pattern
                        d: "M/d/yyyy",
                        // long date pattern
                        D: "dddd, MMMM dd, yyyy",
                        // short time pattern
                        t: "h:mm tt",
                        // long time pattern
                        T: "h:mm:ss tt",
                        // long date, short time pattern
                        f: "dddd, MMMM dd, yyyy h:mm tt",
                        // long date, long time pattern
                        F: "dddd, MMMM dd, yyyy h:mm:ss tt",
                        // month/day pattern
                        M: "MMMM dd",
                        // month/year pattern
                        Y: "yyyy MMMM",
                        // S is a sortable format that does not vary by culture
                        S: "yyyy\u0027-\u0027MM\u0027-\u0027dd\u0027T\u0027HH\u0027:\u0027mm\u0027:\u0027ss",
                        // formatting of dates in MySQL DataBases
                        ISO: "yyyy-MM-dd hh:mm:ss"
                    }
                }
            };
            // Calendar events.
            this.events =
			[
            // occurs when the back button is clicked.
		  	   'backButtonClick',
            // occurs when the forward button is clicked.
               'nextButtonClick',
            // occurs when the value is changed.
               'valuechanged',
            // occurs when the user clicks a cell.
               'cellMouseDown',
            // occurs when the user clicks a cell but is still holding the mouse key pressed.
               'cellMouseUp',
            // occurs when the user selects a cell.
               'cellSelected',
            // occurs when a cell is unselected. For example: user selects a cell and then selects another cell. The first selected cell is unselected.
               'cellUnselected',
            // occurs when the date is changed.
               'change',
            // occurs when the view is changed.
               'viewChange'
			];
        },

        createInstance: function (args) {
            this.setCalendarSize();
            if (this.element.id === "") {
                this.element.id = $.jqx.utilities.createId();
            }

            this.host.attr('data-role', 'calendar');
            var id = this.element.id;
            var me = this;
            this.propertyChangeMap['width'] = function (instance, key, oldVal, value) {
                me.setCalendarSize();
            };

            this.propertyChangeMap['height'] = function (instance, key, oldVal, value) {
                me.setCalendarSize();
            };

            if ($.global) {
                $.global.preferCulture(this.culture);
            }

            if (this.culture != 'default') {
                if ($.global) {
                    $.global.preferCulture(this.culture);
                    this.localization.calendar = $.global.culture.calendar;
                }
                else if (Globalize) {
                    var culture = Globalize.culture(this.culture);
                    this.localization.calendar = culture.calendar;
                }
                this.firstDayOfWeek = this.localization.calendar.firstDay;
            }
            if (this.localization.backString != "Back") {
                this.backText = this.localization.backString;
            }
            if (this.localization.forwardString != "Forward") {
                this.forwardText = this.localization.forwardString;
            }
            if (this.localization.todayString != "Today") {
                this.todayString = this.localization.todayString;
            }
            if (this.localization.clearString != "Clear") {
                this.clearString = this.localization.clearString;
            }
            this.setMaxDate(this.max, false);
            this.setMinDate(this.min, false);

            if (!this.host.attr('tabIndex')) {
                this.host.attr('tabIndex', 0);
            }

            this.host.css('outline', 'none');
            this.host.addClass(this.toThemeProperty("jqx-calendar"));
            this.host.addClass(this.toThemeProperty("jqx-widget"));
            this.host.addClass(this.toThemeProperty("jqx-widget-content"));
            this.host.addClass(this.toThemeProperty("jqx-rc-all"));
            this._addInput();

            this.addHandler(this.host, 'keydown',
            function (event) {
                var result = true;
                if (me.keyboardNavigation) {
                    if (me._handleKey != undefined) {
                        result = me._handleKey(event);
                        if (!result) {
                            if (event.stopPropagation) event.stopPropagation();
                            if (event.preventDefault) event.preventDefault();
                        }
                    }
                }
                return result;
            });

            var loaded = false;
            var myCalendar = this;

            var percentageSize = false;

            if (me.width != null && me.width.toString().indexOf("%") != -1) {
                percentageSize = true;
            }

            if (me.height != null && me.height.toString().indexOf("%") != -1) {
                percentageSize = true;
            }

            $.jqx.utilities.resize(this.host, function () {
                   var month = myCalendar.host.find("#View" + me.element.id);
                   if (!loaded) {
                       loaded = true;
                       myCalendar.render();
                   }
                   else myCalendar.refreshTitle(month);

                   if (percentageSize) {
                       if (me.refreshTimer) {
                           clearTimeout(me.refreshTimer);
                       }

                       me.refreshTimer = setTimeout(function () {
                           me.refreshControl();
                       }, 1);
                   }
               });

            var calendarID = 'View';
            this.propertyChangeMap['disabled'] = function (instance, key, oldVal, value) {
                if (value) {
                    instance.host.addClass(me.toThemeProperty('jqx-fill-state-disabled'));
                }
                else {
                    instance.host.removeClass(me.toThemeProperty('jqx-fill-state-disabled'));
                }
                me.refreshControl();
            }
        },

        _addInput: function () {
            var name = this.host.attr('name');
            if (!name) name = this.element.id;
            this.input = $("<input type='hidden'/>");
            this.host.append(this.input);
            this.input.attr('name', name);
            this.input.val(this.getDate().toString());
        },

        setCalendarSize: function () {
            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                this.host.width(this.width);
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    this.host.width(this.width);
                }

            if (this.width != null && this.width.toString().indexOf("%") != -1) {
                this.host.css('width', this.width);
            }

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                this.host.height(this.height);
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                this.host.height(this.height);
            };

            if (this.height != null && this.height.toString().indexOf("%") != -1) {
                this.host.css('height', this.height);
            }
        },

        _getYearAndMonthPart: function (date) {
            var newDate = new Date(date.getFullYear(), date.getMonth(), 1);
            return newDate;
        },

        _handleKey: function (event) {
            if (this.readOnly)
                return true;

            var key = event.keyCode;
            var me = this;
            var selectedDate = this._getSelectedDate();
            if (selectedDate == undefined)
                return true;

            if (event.altKey) {
                return true;
            }

            if (this._animating)
                return false;

            if (this.view != "month" && key == 13) {
                var cell = this._getSelectedCell();
                this._setDateAndSwitchViews(cell);
            }

            if (this.view == "year") {
                var month = selectedDate.getMonth();
                var minDate = this._getYearAndMonthPart(this.getMinDate());
                var maxDate = this._getYearAndMonthPart(this.getMaxDate());

                switch (key) {
                    case 37:
                        // previous
                        if (month == 0) {
                            var newDate = new Date(selectedDate.getFullYear() - 1, 11, 1);
                            if (newDate >= minDate) {
                                this.selectedDate = newDate;
                                this.navigateBackward();
                            }
                            else if (this.selectedDate != minDate) {
                                this.selectedDate = minDate;
                                this.navigateBackward();
                            }
                        }
                        else {
                            var newDate = new Date(selectedDate.getFullYear(), month - 1, 1)
                            if (newDate >= minDate) {
                                this._selectDate(newDate, 'key');
                            }
                        }
                        return false;
                    case 38:
                        var newDate = new Date(selectedDate.getFullYear(), month - 4, 1);
                        if (newDate < minDate) {
                            newDate = minDate;
                        }

                        if (month - 4 < 0) {
                            this.selectedDate = newDate;
                            this.navigateBackward();
                        }
                        else {
                            this._selectDate(newDate, 'key');
                        }
                        return false;
                    case 40:
                        // down
                        var newDate = new Date(selectedDate.getFullYear(), month + 4, 1);
                        if (newDate > maxDate) {
                            newDate = maxDate;
                        }

                        if (month + 4 > 11) {
                            this.selectedDate = newDate;
                            this.navigateForward();
                        }
                        else {
                            this._selectDate(newDate, 'key');
                        }

                        return false;
                    case 39:
                        if (month == 11) {
                            var newDate = new Date(selectedDate.getFullYear() + 1, 0, 1); ;
                            if (newDate <= maxDate) {
                                this.selectedDate = newDate;
                                this.navigateForward();
                            }
                            else {
                                if (this.selectedDate != maxDate) {
                                    this.selectedDate = maxDate;
                                    this.navigateForward();
                                }
                            }
                        }
                        else {
                            var newDate = new Date(selectedDate.getFullYear(), month + 1, 1);
                            if (newDate <= maxDate) {
                                this._selectDate(newDate, 'key');
                            }
                        }
                        // next
                        return false;
                }
                return true;
            }

            if (this.view == "decade") {
                var startYear = this._renderStartDate.getFullYear();
                var endYear = this._renderEndDate.getFullYear();
                var fullYear = selectedDate.getFullYear();
                var minYear = this.getMinDate().getFullYear();
                var maxYear = this.getMaxDate().getFullYear();

                switch (key) {
                    case 37:
                        // previous
                        if (fullYear - 1 >= minYear) {
                            if (fullYear <= startYear) {
                                this.selectedDate = new Date(fullYear - 1, selectedDate.getMonth(), 1);
                                this.navigateBackward();
                            }
                            else {
                                this._selectDate(new Date(fullYear - 1, selectedDate.getMonth(), 1), 'key');
                            }
                        }
                        return false;
                    case 38:
                        // up
                        var newYear = fullYear - 4;
                        if (fullYear - 4 < minYear) newYear = minYear;

                        if (newYear < startYear) {
                            this.selectedDate = new Date(newYear, selectedDate.getMonth(), 1);
                            this.navigateBackward();
                        }
                        else {
                            this._selectDate(new Date(newYear, selectedDate.getMonth(), 1), 'key');
                        }
                        return false;
                    case 40:
                        // down
                        var newYear = fullYear + 4;
                        if (newYear > maxYear) newYear = maxYear;

                        if (newYear > endYear) {
                            this.selectedDate = new Date(newYear, selectedDate.getMonth(), 1);
                            this.navigateForward();
                        }
                        else {
                            this._selectDate(new Date(newYear, selectedDate.getMonth(), 1), 'key');
                        }

                        return false;
                    case 39:
                        // next
                        if (fullYear + 1 <= maxYear) {
                            if (fullYear == endYear) {
                                this.selectedDate = new Date(fullYear + 1, selectedDate.getMonth(), 1);
                                this.navigateForward();
                            }
                            else {
                                this._selectDate(new Date(fullYear + 1, selectedDate.getMonth(), 1), 'key');
                            }
                        }
                        return false;
                }

                return true;
            }

            var date = new $.jqx._jqxDateTimeInput.getDateTime(selectedDate);
            var start = this.getViewStart();
            var end = this.getViewEnd();
            var monthInstance = $.data(this.element, "View" + this.element.id);
            if (monthInstance == undefined || monthInstance == null)
                return true;

            if (key == 36) {
                date._setDay(1);
                this._selectDate(date.dateTime, 'key');
                return false;
            }

            if (key == 35) {
                var maxDays = this.value._daysInMonth(this.value.year, this.value.month);
                date._setDay(maxDays);
                this._selectDate(date.dateTime, 'key');
                return false;
            }

            var step = 1;
            if (event.ctrlKey) step = 12;
            if (key == 34) {
                var res = this.navigateForward(step);
                if (res) {
                    date._addMonths(step);
                    this._selectDate(date.dateTime, 'key');
                }
                return false;
            }

            if (key == 33) {
                var res = this.navigateBackward(step);
                if (res) {
                    date._addMonths(-step);
                    this._selectDate(date.dateTime, 'key');
                }
                return false;
            }

            if (key == 38) {
                date._addDays(-7);
                if (date.dateTime < this.getMinDate())
                    return false;

                if (date.dateTime < start) {
                    var res = this.navigateBackward();
                    if (!res)
                        return false;
                }

                this._selectDate(date.dateTime, 'key');
                for (var i = 0; i < monthInstance.cells.length; i++) {
                    var cell = monthInstance.cells[i];
                    var cellDate = cell.getDate();
                    if (cell.isOtherMonth && cell.isSelected && cellDate <= date.dateTime) {
                        this.value.day = cellDate.getDate();
                        this.navigateBackward();
                        this._selectDate(date.dateTime, 'key');
                        break;
                    }
                }
                return false;
            }
            else if (key == 40) {
                date._addDays(7);
                if (date.dateTime > this.getMaxDate())
                    return false;

                if (date.dateTime > end) {
                    var res = this.navigateForward();
                    if (!res)
                        return false;
                }

                this._selectDate(date.dateTime, 'key');
                for (var i = 0; i < monthInstance.cells.length; i++) {
                    var cell = monthInstance.cells[i];
                    var cellDate = cell.getDate();
                    if (cell.isOtherMonth && cell.isSelected && cellDate >= date.dateTime) {
                        this.value.day = cellDate.getDate();
                        this.navigateForward();
                        this._selectDate(date.dateTime, 'key');
                        break;
                    }
                }

                return false;
            }

            if (key == 37) {
                date._addDays(-1);
                if (date.dateTime < this.getMinDate()) {
                    return false;
                }

                if (date.dateTime < start) {
                    var res = this.navigateBackward();
                    if (!res)
                        return false;
                }

                this._selectDate(date.dateTime, 'key');
                for (var i = 0; i < monthInstance.cells.length; i++) {
                    var cell = monthInstance.cells[i];
                    var cellDate = cell.getDate();
                    if (cell.isOtherMonth && cell.isSelected && cellDate <= date.dateTime) {
                        if (date.dateTime < this.getMinDate() || date.dateTime > this.getMaxDate()) {
                            return false;
                        }

                        this.navigateBackward();
                        this._selectDate(date.dateTime, 'key');
                        break;
                    }
                }

                return false;
            }
            else if (key == 39) {
                date._addDays(1);
                if (date.dateTime > this.getMaxDate()) {
                    return false;
                }

                if (date.dateTime > end) {
                    var res = this.navigateForward();
                    if (!res)
                        return false;
                }

                this._selectDate(date.dateTime, 'key');
                for (var i = 0; i < monthInstance.cells.length; i++) {
                    var cell = monthInstance.cells[i];
                    var cellDate = cell.getDate();
                    if (cell.isOtherMonth && cell.isSelected && cellDate >= date.dateTime) {
                        if (date.dateTime < this.getMinDate() || date.dateTime > this.getMaxDate()) {
                            return false;
                        }

                        this.navigateForward();
                        this._selectDate(date.dateTime, 'key');
                        break;
                    }
                }
                return false;
            }

            return true;
        },

        render: function () {
            if (!this.canRender) return;

            this.host.children().remove();
            var month = this._renderSingleCalendar("View" + this.element.id);
            var me = this;
            if (this._checkForHiddenParent) {
                if (!this._hiddenParentTimer) {
                    if ($.jqx.isHidden(this.host)) {
                        this._hiddenParentTimer = setInterval(function () {
                            if (!$.jqx.isHidden(me.host)) {
                                try {
                                    clearInterval(me._hiddenParentTimer);
                                    me.updateSize();
                                    me._hiddenParentTimer = 0;
                                }
                                catch (error) {
                                }
                            }
                        }, 10);
                    }
                }
            }
            this.host.append(month);
        },

        // adds a special date to the calendar.
        // @param - Date.
        // @param - css class name(optional).
        // @param - string for the special date's tooltip(optional).
        addSpecialDate: function (date, className, tooltipContent) {
            if (this.multipleMonthRows == 1 && this.multipleMonthColumns == 1) {
                var specialDatesLength = this.specialDates.length;
                this.specialDates[specialDatesLength] = { Date: date, Class: className, Tooltip: tooltipContent };

                this.refreshControl();
            }
        },

        refresh: function (initialRefresh) {
            this.render();
        },

        invalidate: function () {
            this.refreshControl();
        },

        refreshControl: function () {
            if (this.multipleMonthRows == 1 && this.multipleMonthColumns == 1) {
                this.refreshSingleCalendar("View" + this.element.id, null);
            }
        },

        // gets the view's start date.
        getViewStart: function () {
            var visibleDate = this.getVisibleDate();
            var firstDay = this.getFirstDayOfWeek(visibleDate);
            return firstDay.dateTime;
        },

        // gets the view's end date.
        getViewEnd: function () {
            var start = this.getViewStart();
            var end = new $.jqx._jqxDateTimeInput.getDateTime(start);
            end._addDays(41);
            return end.dateTime;
        },

        refreshSingleCalendar: function (calendarID, parent) {
            if (!this.canRender) return;
            var month = this.host.find("#" + calendarID);
            var visibleDate = this.getVisibleDate();
            var firstDay = this.getFirstDayOfWeek(visibleDate);

            this.refreshCalendarCells(month, firstDay, calendarID);
            this.refreshTitle(month);
            this.refreshRowHeader(month, calendarID);
            if (this.selectedDate != undefined) {
                this._selectDate(this.selectedDate);
            }
            var contentHeight = this.host.height() - this.titleHeight - this.columnHeaderHeight;
            if (!this.showDayNames) {
                contentHeight = this.host.height() - this.titleHeight;
            }
            if (this.showFooter) {
                contentHeight -= 20;
            }

            var cellsTableElement = month.find("#cellsTable" + calendarID);
            var rowHeaderElement = month.find("#calendarRowHeader" + calendarID);
            cellsTableElement.height(contentHeight);
            rowHeaderElement.height(contentHeight);
        },

        refreshRowHeader: function (month, calendarID) {
            if (!this.showWeekNumbers)
                return;

            var visibleDate = this.getVisibleDate();
            var firstDay = this.getFirstDayOfWeek(visibleDate);
            var dayOfWeek = firstDay.dayOfWeek;
            var weekOfYear = this.getWeekOfYear(firstDay);
            var rowHeader = this.rowHeader.find('table');

            rowHeader.width(this.rowHeaderWidth);
            //   month.find("#calendarRowHeader" + month[0].id).append(rowHeader);
            var currentDate = firstDay;
            var rowHeaderCells = new Array();

            for (var i = 0; i < 6; i++) {
                var weekString = weekOfYear.toString();
                var cell = new $.jqx._jqxCalendar.cell(currentDate.dateTime);
                var cellID = i + 1 + this.element.id;
                var cellElement = $(rowHeader[0].rows[i].cells[0]);
                cell.element = cellElement;
                cell.row = i;
                cell.column = 0;
                var cellContent = cellElement.find("#headerCellContent" + cellID);
                cellContent.addClass(this.toThemeProperty('jqx-calendar-row-cell'));
                cellContent[0].innerHTML = weekOfYear;
                rowHeaderCells[i] = cell;
                currentDate = new $.jqx._jqxDateTimeInput.getDateTime(new Date(currentDate._addWeeks(1)));
                weekOfYear = this.getWeekOfYear(currentDate);
            }

            var monthInstance = $.data(this.element, month[0].id);
            monthInstance.rowCells = rowHeaderCells;
            this._refreshOtherMonthRows(monthInstance, calendarID);
        },

        _refreshOtherMonthRows: function (month, calendarID) {
            if (this.showOtherMonthDays)
                return;

            this._displayLastRow(true, calendarID);
            this._displayFirstRow(true, calendarID);

            var canDisplayFirstRow = false;
            var canDisplayLastRow = false;

            for (var i = 0; i < month.cells.length; i++) {
                var cell = month.cells[i];
                if (cell.isVisible && i < 7) {
                    canDisplayFirstRow = true;
                }
                else if (cell.isVisible && i >= month.cells.length - 7) {
                    canDisplayLastRow = true;
                }
            }

            if (!canDisplayFirstRow) {
                this._displayFirstRow(false, calendarID);
            }

            if (!canDisplayLastRow) {
                this._displayLastRow(false, calendarID);
            }
        },

        _displayLastRow: function (show, calendarID) {
            var month = this.host.find("#" + calendarID);
            var calendarRowHeader = month.find("#calendarRowHeader" + month[0].id).find('table');
            var lastRow = null;
            if (this.showWeekNumbers) {
                if (calendarRowHeader[0].cells) {
                    var lastRow = $(calendarRowHeader[0].rows[5]);
                }
            }
            var lastMonthRow = $(month.find("#cellTable" + month[0].id)[0].rows[5]);
            if (show) {
                if (this.showWeekNumbers && lastRow) {
                    lastRow.css('display', 'table-row');
                }
                lastMonthRow.css('display', 'table-row');
            }
            else {
                if (this.showWeekNumbers && lastRow) {
                    lastRow.css('display', 'none');
                }
                lastMonthRow.css('display', 'none');
            }
        },

        _displayFirstRow: function (show, calendarID) {
            var month = this.host.find("#" + calendarID);
            var calendarRowHeader = month.find("#calendarRowHeader" + month[0].id).find('table');
            var firstRow = null;
            if (this.showWeekNumbers) {
                if (calendarRowHeader[0].cells) {
                    var firstRow = $(calendarRowHeader[0].rows[0]);
                }
            }
            var firstMonthRow = $(month.find("#cellTable" + month[0].id)[0].rows[0]);

            if (show) {
                if (this.showWeekNumbers && firstRow) {
                    firstRow.css('display', 'table-row');
                }
                firstMonthRow.css('display', 'table-row');
            }
            else {
                if (this.showWeekNumbers && firstRow) {
                    firstRow.css('display', 'none');
                }
                firstMonthRow.css('display', 'none');
            }
        },

        _renderSingleCalendar: function (calendarID, parent) {
            if (!this.canRender) return;

            var oldMonthElement = this.host.find("#" + calendarID.toString());
            if (oldMonthElement != null) {
                oldMonthElement.remove();
            }

            var month = $("<div id='" + calendarID.toString() + "'></div>");

            var visibleDate = this.getVisibleDate();
            var firstDay = this.getFirstDayOfWeek(visibleDate);
            var endDay = new $.jqx._jqxDateTimeInput.getDateTime(firstDay.dateTime);
            endDay._addMonths(1);

            var monthInstance = $.jqx._jqxCalendar.monthView(firstDay, endDay, null, null, null, month);

            if (parent == undefined || parent == null) {
                this.host.append(month);

                if (this.height != undefined && !isNaN(this.height)) {
                    month.height(this.height);
                }
                else if (this.height != null && this.height.toString().indexOf("px") != -1) {
                    month.height(this.height);
                }

                if (this.width != undefined && !isNaN(this.width)) {
                    month.width(this.width);
                }
                else if (this.width != null && this.width.toString().indexOf("px") != -1) {
                    month.width(this.width);
                }

                if (this.width != null && this.width.toString().indexOf("%") != -1) {
                    month.width('100%');
                }
                if (this.height != null && this.height.toString().indexOf("%") != -1) {
                    month.height('100%');
                }
            }
            else parent.append(month);

            $.data(this.element, calendarID, monthInstance);

            var contentHeight = this.host.height() - this.titleHeight - this.columnHeaderHeight;
            if (!this.showDayNames) {
                contentHeight = this.host.height() - this.titleHeight;
            }
            if (this.showFooter) {
                contentHeight -= 20;
            }

            if (this.rowHeaderWidth < 0) this.rowHeaderWidth = 0;
            if (this.columnHeaderHeight < 0) this.columnHeaderHeight = 0;
            if (this.titleHeight < 0) this.titleHeight = 0;

            var rowHeaderWidth = this.rowHeaderWidth;
            var columnHeaderHeight = this.columnHeaderHeight;

            if (!this.showWeekNumbers) {
                rowHeaderWidth = 0;
            }

            if (!this.showDayNames) {
                columnHeaderHeight = 0;
            }


            var title = $("<div style='height:" + this.titleHeight + "px;'><table role='grid' style='margin: 0px; width: 100%; height: 100%; border-spacing: 0px;' cellspacing='0' cellpadding='0'><tr role='row' id='calendarTitle' width='100%'>" +
               "<td role='gridcell' NOWRAP id='leftNavigationArrow'></td>" + "<td aria-live='assertive' aria-atomic='true' role='gridcell' align='center' NOWRAP id='calendarTitleHeader'></td>" + "<td role='gridcell' NOWRAP id='rightNavigationArrow'></td>" +
               "</tr></table></div>");

            title.addClass(this.toThemeProperty('jqx-calendar-title-container'));
            month.append(title);
            var monthStructure = $("<table role='grid' style='margin: 0px; border-spacing: 0px;' cellspacing='0' cellpadding='0'>" +
               "<tr role='row' id='calendarHeader' height='" + columnHeaderHeight + "'>" +
               "<td role='gridcell' id='selectCell' width='" + rowHeaderWidth + "'></td>" + "<td role='gridcell' colspan='2' style='padding-left: 2px; padding-right: 2px' id='calendarColumnHeader'></td>" +
               "</tr>" +
               "<tr role='row' id='calendarContent'>" +
               "<td role='gridcell' id='calendarRowHeader' valign='top' height='" + contentHeight + "' width='" + rowHeaderWidth + "'></td>" + "<td role='gridcell' valign='top' colspan='2' style='padding-left: 2px; padding-right: 2px' id='cellsTable' height='" + contentHeight + "'></td>" +
               "</tr>" +
               "</table>"
           );
            var footerHeight = 20;
            var footer = $("<div style='margin: 0px; display: none; height:" + footerHeight + "px;'><table style='width: 100%; height: 100%; border-spacing: 0px;' cellspacing='0' cellpadding='0'>" +
            "<tr id='calendarFooter'>" +
            "<td align='right' id='todayButton'></td>" + "<td align='left' colspan='2' id=doneButton></td>" +
            "</tr>" + "</table></div>");

            if (this.showFooter) {
                footer.css('display', 'block');
            }

            month.append(monthStructure);
            month.append(footer);
            monthStructure.addClass(this.toThemeProperty('jqx-calendar-month'));

            this._footer = footer;
            this.header = month.find('#calendarHeader');
            this.header[0].id = 'calendarHeader' + calendarID;
            this.header.addClass(this.toThemeProperty('calendar-header'));
            this.columnHeader = month.find('#calendarColumnHeader');
            this.columnHeader[0].id = 'calendarColumnHeader' + calendarID;
            this.table = month.find('#cellsTable');
            this.table[0].id = 'cellsTable' + calendarID;
            this.rowHeader = month.find('#calendarRowHeader');
            this.rowHeader[0].id = 'calendarRowHeader' + calendarID;
            this.selectCell = month.find('#selectCell');
            this.selectCell[0].id = 'selectCell' + calendarID;
            this.title = month.find('#calendarTitle');
            this.title[0].id = 'calendarTitle' + calendarID;
            this.leftButton = month.find('#leftNavigationArrow');
            this.leftButton[0].id = 'leftNavigationArrow' + calendarID;
            this.titleHeader = month.find('#calendarTitleHeader');
            this.titleHeader[0].id = 'calendarTitleHeader' + calendarID;
            this.rightButton = month.find('#rightNavigationArrow');
            this.rightButton[0].id = 'rightNavigationArrow' + calendarID;
            this.footer = month.find('#calendarFooter');
            this.footer[0].id = 'calendarFooter' + calendarID;
            this.todayButton = month.find('#todayButton');
            this.todayButton[0].id = 'todayButton' + calendarID;
            this.doneButton = month.find('#doneButton');
            this.doneButton[0].id = 'doneButton' + calendarID;

            //  month.find('td').css({ padding: 0, margin: 0, border: 'none' });
            month.find('tr').addClass(this.toThemeProperty('jqx-reset'));
            month.addClass(this.toThemeProperty("jqx-widget-content"));
            month.addClass(this.toThemeProperty("jqx-calendar-month-container"));
            this.month = month;
            this.selectCell.addClass(this.toThemeProperty('jqx-reset'));
            this.selectCell.addClass(this.toThemeProperty('jqx-calendar-top-left-header'));

            if (this.showWeekNumbers) {
                this._renderRowHeader(month);
            }
            else {
                this.table[0].colSpan = 3;
                this.columnHeader[0].colSpan = 3;
                this.rowHeader.css('display', 'none');
                this.selectCell.css('display', 'none');
            }

            if (this.showFooter) {
                this.footer.height(20);
                var todayLink = $("<a href='javascript:;'>" + this.todayString + "</a>");
                todayLink.appendTo(this.todayButton);
                var clearLink = $("<a href='javascript:;'>" + this.clearString + "</a>");
                clearLink.appendTo(this.doneButton);
                clearLink.addClass(this.toThemeProperty('jqx-calendar-footer'));
                todayLink.addClass(this.toThemeProperty('jqx-calendar-footer'));
                var self = this;

                var eventName = "mousedown";
                if ($.jqx.mobile.isTouchDevice()) {
                    eventName = $.jqx.mobile.getTouchEventName('touchstart');
                }

                this.addHandler(todayLink, eventName, function () {
                    if (self.today) {
                        self.today();
                    }
                    else {
                        self.setDate(new Date(), 'mouse');
                    }
                    return false;
                });
                this.addHandler(clearLink, eventName, function () {
                    if (self.clear) {
                        self.clear();
                    }
                    else {
                        self.setDate(null, 'mouse');
                    }
                    return false;
                });
            }

            if (this.view != "month") {
                this.header.hide();
            }

            if (this.showDayNames && this.view == "month") {
                this.renderColumnHeader(month);
            }

            this.renderCalendarCells(month, firstDay, calendarID)
            if (parent == undefined || parent == null) {
                this.renderTitle(month);
            }
            this._refreshOtherMonthRows(monthInstance, calendarID);
            month.find('tbody').css({ border: 'none', background: 'transparent' });
            if (this.selectedDate != undefined) {
                this._selectDate(this.selectedDate);
            }

            var me = this;
            this.addHandler(this.host, 'focus', function () {
                me.focus();
            });

            return month;
        },

        _getTitleFormat: function () {
            switch (this.view) {
                case 'month':
                    return this.titleFormat[0];
                case 'year':
                    return this.titleFormat[1];
                case 'decade':
                    return this.titleFormat[2];
                case 'centuries':
                    return this.titleFormat[3];
            }
        },

        renderTitle: function (month) {
            var leftArrow = $("<div role='button' style='float: left;'></div>");
            var rightArrow = $("<div role='button' style='float: right;'></div>");
            var titleElement = this.title;
            titleElement.addClass(this.toThemeProperty("jqx-reset"));
            titleElement.addClass(this.toThemeProperty("jqx-widget-header"));
            titleElement.addClass(this.toThemeProperty("jqx-calendar-title-header"));
            var titleCells = titleElement.find('td');

            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                if (titleCells.css('background-color') != 'transparent') {
                    var bgColor = titleElement.css('background-color');
                    titleCells.css('background-color', bgColor);
                }
                if (titleCells.css('background-image') != 'transparent') {
                    var bgImage = titleElement.css('background-image');
                    var bgRepeat = titleElement.css('background-repeat');
                    var bgPosition = titleElement.css('background-position');

                    titleCells.css('background-image', bgImage);
                    titleCells.css('background-repeat', bgRepeat);
                    titleCells.css('background-position', 'left center scroll');
                }
            }
            else {
                titleCells.css('background-color', 'transparent');
            }

            if (this.disabled) {
                titleElement.addClass(this.toThemeProperty("jqx-calendar-title-header-disabled"));
            }

            leftArrow.addClass(this.toThemeProperty("jqx-calendar-title-navigation"));
            leftArrow.addClass(this.toThemeProperty("jqx-icon-arrow-left"));
            leftArrow.appendTo(this.leftButton);
            var leftArrowElement = this.leftButton;

            rightArrow.addClass(this.toThemeProperty("jqx-calendar-title-navigation"));
            rightArrow.addClass(this.toThemeProperty("jqx-icon-arrow-right"));
            rightArrow.appendTo(this.rightButton);
            var rightArrowElement = this.rightButton;

            if (this.enableTooltips) {
                if ($(leftArrowElement).jqxTooltip) {
                    $(leftArrowElement).jqxTooltip({ name: this.element.id, position: 'mouse', theme: this.theme, content: this.backText });
                    $(rightArrowElement).jqxTooltip({ name: this.element.id, position: 'mouse', theme: this.theme, content: this.forwardText });
                }
            }

            var titleHeader = this.titleHeader;
            var title = this._format(this.value.dateTime, this._getTitleFormat(), this.culture);
            if (this.view == "decade") {
                var startText = this._format(this._renderStartDate, this._getTitleFormat(), this.culture);
                var endText = this._format(this._renderEndDate, this._getTitleFormat(), this.culture);
                title = startText + " - " + endText;
            }
            else if (this.view == "centuries") {
                var startText = this._format(this._renderCenturyStartDate, this._getTitleFormat(), this.culture);
                var endText = this._format(this._renderCenturyEndDate, this._getTitleFormat(), this.culture);
                title = startText + " - " + endText;
            }

            var titleContent = $("<div style='background: transparent; margin: 0; padding: 0; border: none;'>" + title + "</div>");
            titleHeader.append(titleContent);
            titleContent.addClass(this.toThemeProperty('jqx-calendar-title-content'));

            var arrowWidth = parseInt(leftArrow.width());
            var headerWidth = month.width() - 2 * arrowWidth;
            var newContent = titleHeader.find(".jqx-calendar-title-content").width(headerWidth);

            $.data(leftArrow, 'navigateLeft', this);
            $.data(rightArrow, 'navigateRight', this);
            var isTouchDevice = $.jqx.mobile.isTouchDevice();

            if (!this.disabled) {
                var me = this;
                this.addHandler(titleHeader, 'mousedown',
                function (event) {
                    if (me.enableViews) {
                        if (!me._viewAnimating && !me._animating) {
                            var oldView = me.view;
                            switch (me.view) {
                                case 'month':
                                    me.view = "year";
                                    break;
                                case 'year':
                                    me.view = "decade";
                                    break;
                            }
                            if (oldView != me.view) {
                                var calendarID = "View" + me.element.id;
                                var month = me.host.find("#" + calendarID);
                                var visibleDate = me.getVisibleDate();
                                var firstDay = me.getFirstDayOfWeek(visibleDate);
                                me.renderCalendarCells(month, firstDay, calendarID, true);
                                me.refreshTitle(month);
                            }
                        }
                        return false;
                    }
                });

                this.addHandler(leftArrow, 'mousedown',
                function (event) {
                    if (!me._animating) {
                        $.data(leftArrow, 'navigateLeftRepeat', true);
                        var element = $.data(leftArrow, 'navigateLeft');
                        if (element.enableFastNavigation && !isTouchDevice) {
                            element.startRepeat(element, leftArrow, true, 500);
                        }
                        element.navigateBackward();

                        return element._raiseEvent(0, event)
                    }
                    else return false;
                });

                this.addHandler(leftArrow, 'mouseup',
                function (event) {
                    $.data(leftArrow, 'navigateLeftRepeat', false);
                });

                this.addHandler(leftArrow, 'mouseleave',
                function (event) {
                    $.data(leftArrow, 'navigateLeftRepeat', false);
                });

                this.addHandler(rightArrow, 'mousedown',
                function (event) {
                    if (!me._animating) {
                        $.data(rightArrow, 'navigateRightRepeat', true);
                        var element = $.data(rightArrow, 'navigateRight')

                        if (element.enableFastNavigation && !isTouchDevice) {
                            element.startRepeat(element, rightArrow, false, 500);
                        }
                        element.navigateForward();
                        return element._raiseEvent(1, event)
                    }
                    else return false;
                });

                this.addHandler(rightArrow, 'mouseup',
                function (event) {
                    $.data(rightArrow, 'navigateRightRepeat', false);
                });

                this.addHandler(rightArrow, 'mouseleave',
                function (event) {
                    $.data(rightArrow, 'navigateRightRepeat', false);
                });
            }
        },

        refreshTitle: function (month) {
            var title = this._format(this.value.dateTime, this._getTitleFormat(), this.culture);
            if (this.view == "decade") {
                var startText = this._format(this._renderStartDate, this._getTitleFormat(), this.culture);
                var endText = this._format(this._renderEndDate, this._getTitleFormat(), this.culture);
                title = startText + " - " + endText;
            }
            else if (this.view == "centuries") {
                var startText = this._format(this._renderCenturyStartDate, this._getTitleFormat(), this.culture);
                var endText = this._format(this._renderCenturyEndDate, this._getTitleFormat(), this.culture);
                title = startText + " - " + endText;
            }
            var titleHeader = this.titleHeader;
            if (this.titleHeader) {
                var oldContent = titleHeader.find(".jqx-calendar-title-content");

                var titleContent = $("<div style='background: transparent; margin: 0; padding: 0; border: none;'>" + title + "</div>");
                titleHeader.append(titleContent);
                titleContent.addClass(this.toThemeProperty('jqx-calendar-title-content'));

                if (oldContent != null) {
                    oldContent.remove();
                }
            }
        },

        startRepeat: function (element, navigationElement, isLeft, timeout) {
            var timeoutobj = window.setTimeout(function () {
                var value = $.data(navigationElement, 'navigateLeftRepeat');
                if (!isLeft) {
                    value = $.data(navigationElement, 'navigateRightRepeat');
                }

                if (value) {
                    if (timeout < 25) timeout = 25;

                    if (isLeft) {
                        element.navigateBackward();
                        element.startRepeat(element, navigationElement, true, timeout);
                    }
                    else {
                        element.navigateForward();
                        timeoutobj = element.startRepeat(element, navigationElement, false, timeout);
                    }
                }
                else {
                    window.clearTimeout(timeoutobj);
                    return;
                }
            }, timeout);
        },

        // navigates (n) month(s) forward.
        // @param - Date
        navigateForward: function (step) {
            if (step == undefined || step == null) {
                step = this.stepMonths;
            }
            var year = this.value.year;
            if (this.view == 'decade') {
                year = this._renderStartDate.getFullYear() + 12;
                if (this._renderEndDate.getFullYear() >= this.getMaxDate().getFullYear())
                    return;

            }
            else if (this.view == "year") {
                year = this.value.year + 1;
            }
            else if (this.view == "centuries") {
                year = this.value.year + 100;
            }

            if (this.view != "month") {
                var maxYear = this.getMaxDate().getFullYear();
                if (maxYear < year || year > maxYear) {
                    year = maxYear;
                }
                if (this.value.year == year) {
                    return;
                }

                this.value.year = year;
                this.value.month = 1;
                this.value.day = 1;
            }

            var day = this.value.day;
            var month = this.value.month;
            if (month + step <= 12) {
                var maxDays = this.value._daysInMonth(this.value.year, this.value.month + step);
                if (day > maxDays)
                    day = maxDays;
            }

            if (this.view == "month") {
                var date = new Date(this.value.year, this.value.month - 1 + step, day)
            }
            else {
                var date = new Date(this.value.year, this.value.month - 1, day)
            }

            return this.navigateTo(date);
        },

        // navigates (n) month(s) back.
        // @param - Number  
        navigateBackward: function (step) {
            if (step == undefined || step == null) {
                step = this.stepMonths;
            }

            var year = this.value.year;
            if (this.view == 'decade') {
                year = this._renderStartDate.getFullYear() - 12;
            }
            else if (this.view == "year") {
                year = this.value.year - 1;
            }
            else if (this.view == "centuries") {
                year = this.value.year - 100;
            }

            if (this.view != "month") {
                var minYear = this.getMinDate().getFullYear();
                if (year < minYear) year = minYear;
                if (this.view == "decade") {
                    if (this._renderStartDate) {
                        if (this._renderStartDate.getFullYear() == year) {
                            return;
                        }
                    }
                }

                // if (this.value.year == year) return;
                this.value.year = year;
                this.value.month = 1;
                this.value.day = 1;
            }

            var day = this.value.day;
            var month = this.value.month;
            if (month - step >= 1) {
                var maxDays = this.value._daysInMonth(this.value.year, this.value.month - step);
                if (day > maxDays)
                    day = maxDays;
            }

            if (this.view == 'month') {
                var date = new Date(this.value.year, this.value.month - 1 - step, day);
            }
            else {
                var date = new Date(this.value.year, this.value.month - 1, day);
            }

            return this.navigateTo(date);
        },

        refreshCalendarCells: function (month, firstDay, calendarID) {
            if (this.view == "year" || this.view == "decade" || this.view == 'centuries') {
                this.refreshViews(month, firstDay, calendarID);
                return;
            }
            var tableElement = this.table;
            var cellsTable = tableElement.find("#" + 'cellTable' + calendarID.toString());
            var currentDate = firstDay;
            var cells = new Array();
            var k = 0;
            var today = new $.jqx._jqxDateTimeInput.getDateTime(new Date());

            for (var i = 0; i < 6; i++) {
                for (var j = 0; j < 7; j++) {
                    var cellRowID = i + 1;
                    var r = j;
                    if (this.rtl) r = 6 - r;
                    var cellColumnID = r + 1;
                    var cellID = "#cell" + cellRowID + cellColumnID + this.element.id;
                    var date = new Date(currentDate.dateTime.getFullYear(), currentDate.dateTime.getMonth(), currentDate.dateTime.getDate());
                    var cell = new $.jqx._jqxCalendar.cell(date);
                    var cellElement = $(cellsTable[0].rows[i].cells[cellColumnID-1]);
                    cellElement[0].id = cellID.substring(1);

                    cell.element = cellElement;
                    cell.row = i;
                    cell.column = j;

                    cell.isVisible = true;
                    cell.isOtherMonth = false;
                    cell.isToday = false;
                    cell.isWeekend = false;
                    cell.isHighlighted = false;
                    cell.isSelected = false;

                    if (currentDate.month != this.value.month) {
                        cell.isOtherMonth = true;
                        cell.isVisible = this.showOtherMonthDays;
                    }

                    if (date < this.getMinDate() || date > this.getMaxDate()) {
                        cell.isDisabled = true;
                    }

                    if (currentDate.month == today.month && currentDate.day == today.day && currentDate.year == today.year) {
                        cell.isToday = true;
                    }

                    if (currentDate.isWeekend()) {
                        cell.isWeekend = true;
                    }

                    $.data(this.element, "cellContent" + cellID.substring(1), cell);
                    $.data(this.element, cellID.substring(1), cell);
                    cells[k] = cell;
                    k++;
                    $.jqx.utilities.html(cellElement, currentDate.day);

                    this._applyCellStyle(cell, cellElement, cellElement);

                    currentDate = new $.jqx._jqxDateTimeInput.getDateTime(new Date(currentDate._addDays(1)));
                }
            }

            var monthInstance = $.data(this.element, month[0].id);
            if (monthInstance != undefined && monthInstance != null) {
                monthInstance.cells = cells;
            }
            this.renderedCells = cells;
            this._refreshOtherMonthRows(monthInstance, calendarID);
        },

        _getDecadeAndCenturiesData: function () {
            var renderYears = new Array();
            var renderDates = new Array();
            var length = this.getMaxDate().getFullYear() - this.getMinDate().getFullYear();
            if (length < 12) length = 12;
            var minDate = this.getMinDate();
            var maxDate = this.getMaxDate();
            var currentYear = this.value.dateTime.getFullYear();

            if (this.view == "decade") {
                if (currentYear + 12 > maxDate.getFullYear()) {
                    currentYear = maxDate.getFullYear() - 11;
                }
                if (currentYear < minDate.getFullYear()) {
                    currentYear = minDate.getFullYear();
                }
                for (var i = 0; i < length; i++) {
                    var date = new Date(minDate.getFullYear() + i, 0, 1);
                    if (minDate.getFullYear() <= currentYear && currentYear <= date.getFullYear()) {
                        var renderStartDate = new Date(date.getFullYear(), date.getMonth(), 1);

                        for (var j = 0; j < 12; j++) {
                            var newDate = new Date(renderStartDate.getFullYear() + j, this.value.dateTime.getMonth(), this.value.dateTime.getDate());
                            var year = newDate.getFullYear();

                            if (minDate.getFullYear() <= year && year <= maxDate.getFullYear()) {
                                renderYears.push(year);
                                renderDates.push(newDate);
                                if (j == 0) {
                                    this._renderStartDate = newDate;
                                }
                                this._renderEndDate = newDate;
                            }
                            else {
                                renderYears.push(year);
                                renderDates.push(newDate);
                            }

                        }

                        break;
                    }
                }
            }
            else if (this.view == "centuries") {
                for (var i = 0; i < length; i += 120) {
                    var date = new Date(minDate.getFullYear() + i + 120, 0, 1);

                    if (minDate.getFullYear() <= currentYear && currentYear <= date.getFullYear()) {
                        var renderStartDate = new Date(date.getFullYear() - 130, date.getMonth(), 1);

                        if (renderStartDate < minDate) {
                            renderStartDate = minDate;
                        }

                        for (var j = 0; j < 12; j++) {
                            var centuriesDate = new Date(renderStartDate.getFullYear() + j * 10, renderStartDate.getMonth(), 1);
                            if (renderStartDate.getFullYear() >= minDate.getFullYear() && centuriesDate.getFullYear() <= maxDate.getFullYear()) {
                                renderYears.push("<span style='visibility: hidden;'>-</span>" + centuriesDate.getFullYear() + "-" + (centuriesDate.getFullYear() + 9));
                                renderDates.push(centuriesDate);
                                if (j == 0) {
                                    this._renderCenturyStartDate = centuriesDate;
                                }
                                this._renderCenturyEndDate = new Date(centuriesDate.getFullYear() + 9, 0, 1);
                            }
                        }
                        break;
                    }
                }
            }
            return { years: renderYears, dates: renderDates };
        },

        refreshViews: function (month, firstDay, calendarID) {
            var me = this;
            var cells = new Array();
            var cellsTable = month.find('#cellTable' + calendarID.toString());

            var data = this._getDecadeAndCenturiesData();
            var renderYears = data.years;
            var renderDates = data.dates;

            var k = 0;
            var minDate = this.getMinDate();
            var maxDate = this.getMaxDate();

            for (var i = 0; i < 3; i++) {
                for (var j = 0; j < 4; j++) {
                    var cellRowID = i + 1;
                    var r = j;
                    if (this.rtl) r = 3 - r;
                    var cellColumnID = r + 1;
                    var date = new Date(this.value.dateTime);
                    date.setMonth(i * 4 + r);
                    var cell = new $.jqx._jqxCalendar.cell(date);
                    var row = cellsTable[0].rows["row" + (1 + i) + this.element.id];
                    var cellElement = $(row.cells[j]);

                    cell.isVisible = true;
                    cell.element = cellElement;
                    cell.row = i;
                    cell.column = j;
                    cell.index = cells.length;
                    var text = "";
                    if (this.view == "year") {
                        var monthNames = this.localization.calendar.months.names;
                        var monthString = monthNames[i * 4 + r];

                        // Possible values: default, shortest, firstTwoLetters, firstLetter, full
                        switch (this.monthNameFormat) {
                            case 'default':
                                monthString = this.localization.calendar.months.namesAbbr[i * 4 + r];
                                break;
                            case 'shortest':
                                monthString = this.localization.calendar.months.namesShort[i * 4 + r];
                                break;
                            case 'firstTwoLetters':
                                monthString = monthString.substring(0, 2);
                                break;
                            case 'firstLetter':
                                monthString = monthString.substring(0, 1);
                                break;
                        }
                        text = monthString;
                    }
                    else if (this.view == "decade" || this.view == "centuries") {
                        text = renderYears[i * 4 + r];
                        if (undefined == text) {
                            text = "<span style='cursor: default; visibility: hidden;'>2013</span>";
                        }
                        cell.setDate(renderDates[i * 4 + r]);
                    }
                    var date = cell.getDate();
                    if (this.view == "year") {
                        if (this._getYearAndMonthPart(date) < this._getYearAndMonthPart(minDate))
                            cell.isDisabled = true;
                        if (this._getYearAndMonthPart(date) > this._getYearAndMonthPart(maxDate))
                            cell.isDisabled = true;
                    }
                    else {
                        if (date.getFullYear() < minDate.getFullYear())
                            cell.isDisabled = true;
                        if (date.getFullYear() > maxDate.getFullYear())
                            cell.isDisabled = true;
                    }

                    $.jqx.utilities.html(cellElement, text);
                    cells[k] = cell;
                    k++;
                }
            }
            var monthInstance = $.data(this.element, month[0].id);
            if (monthInstance != undefined && monthInstance != null) {
                monthInstance.cells = cells;
            }
            this.renderedCells = cells;
            this._applyCellStyles();
        },

        _createViewClone: function () {
            var table = this.host.find('.jqx-calendar-month');
            var viewClone = table.clone();
            viewClone.css('position', 'absolute');
            viewClone.css('top', table.position().top);
            return viewClone;
        },

        _addCellsTable: function (tableElement, cellsTable) {
            var me = this;
            //            cellsTable.find('table').css({ background: 'none', padding: 0, margin: 0, border: 0 });
            //            cellsTable.find('td').css({ padding: 1, margin: 0 });
            //            cellsTable.find('tr').css({ background: 'none', padding: 0, margin: 0, border: 0 });

            var footerHeight = this.showFooter ? 20 : 0;
            if (this.view != "month") {
                cellsTable.height(this.host.height() - this.titleHeight);
            }
            else {
                cellsTable.height(this.host.height() - this.titleHeight - this.columnHeaderHeight - footerHeight);
            }

            this._viewAnimating = true;
            var container = this.host.find('.jqx-calendar-month-container');
            container.css('position', 'relative');
            var table = this.host.find('.jqx-calendar-month');
            var viewClone = this._createViewClone();
            container.append(viewClone);

            if (this.view != "month") {
                this.header.fadeOut(0);
                if (this.showWeekNumbers) {
                    this.rowHeader.fadeOut(0);
                }
                if (this.showFooter) {
                    this._footer.fadeOut(0);
                }
            }
            else {
                this.header.fadeIn(this.navigationDelay + 200);
                if (this.showWeekNumbers) {
                    this.rowHeader.fadeIn(this.navigationDelay + 200);
                }
                if (this.showFooter) {
                    this._footer.fadeIn(this.navigationDelay + 200);
                }
            }

            tableElement.children().remove();
            tableElement.append(cellsTable);

            this._animateViews(viewClone, cellsTable, function () {
                if (!me.selectedDate) {
                    me.selectedDate = me.renderedCells[0].getDate();
                }
                try {
                    me.renderedCells[0].element.focus();
                    setTimeout(function () {
                        me.renderedCells[0].element.focus();
                    }, 10);
                }
                catch (error) {
                }

                me._viewAnimating = false;
            });

            cellsTable.addClass(this.toThemeProperty("jqx-calendar-view"));
        },

        _animateViews: function (view1, view2, callback) {
            var me = this;
            me._viewAnimating = true;
            view1.fadeOut(this.navigationDelay + 100, function () {
                view1.remove();
            });
            view2.fadeOut(0);
            view2.fadeIn(this.navigationDelay + 200, function () {
                callback();
            });
        },

        focus: function () {
            try {
                if (this.renderedCells && this.renderedCells.length > 0) {
                    var me = this;
                    var focusChanged = false;
                    if (!me.selectedDate && me.selectionMode != 'range') {
                        this.setDate(new Date(), 'mouse');
                    }

                    this.element.focus();
                }
            }
            catch (error) {
            }
        },

        renderViews: function (month, firstDay, calendarID) {
            var me = this;
            var cells = new Array();
            var cellsTable = $("<table role='grid' style='width: 100%; height: 100%;' cellspacing='2' cellpadding='0' id=" + 'cellTable' + calendarID.toString() + ">" +
                 "<tr role='row' id='row1" + this.element.id + "'>" +
                 "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" +
                 "</tr>" +
                 "<tr role='row' id='row2" + this.element.id + "'>" +
                 "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" +
                 "</tr>" +
                 "<tr role='row' id='row3" + this.element.id + "'>" +
                 "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" +
                 "</tr>" +
                 "</table>"
             );

            var container = this.host.find('.jqx-calendar-month-container');
            container.css('position', 'relative');
            var tableElement = month.find("#cellsTable" + month[0].id);

            var data = this._getDecadeAndCenturiesData();
            var renderYears = data.years;
            var renderDates = data.dates;
            var k = 0;
            var minDate = this.getMinDate();
            var maxDate = this.getMaxDate();
            var valueDate = new Date(this.value.dateTime);
            valueDate.setDate(1);

            for (var i = 0; i < 3; i++) {
                for (var j = 0; j < 4; j++) {
                    var cellRowID = i + 1;
                    var r = j;
                    if (this.rtl) r = 3 - r;
                    var cellColumnID = r + 1;
                    var row = cellsTable[0].rows["row" + (1 + i) + this.element.id];
                    var date = new Date(valueDate);
                    date.setMonth(i * 4 + r);
                    var cell = new $.jqx._jqxCalendar.cell(date);
                    var cellElement = $(row.cells[j]);
                    cell.isVisible = true;
                    cell.element = cellElement;
                    cell.row = i;
                    cell.column = j;
                    cell.index = cells.length;

                    var text = "";
                    if (this.view == "year") {
                        if (date.getMonth() == this.getDate().getMonth()) {
                            cell.isSelected = true;
                        }
                        var monthNames = this.localization.calendar.months.names;
                        var monthString = monthNames[i * 4 + r];

                        // Possible values: default, shortest, firstTwoLetters, firstLetter, full
                        switch (this.monthNameFormat) {
                            case 'default':
                                monthString = this.localization.calendar.months.namesAbbr[i * 4 + r];
                                break;
                            case 'shortest':
                                monthString = this.localization.calendar.months.namesShort[i * 4 + r];
                                break;
                            case 'firstTwoLetters':
                                monthString = monthString.substring(0, 2);
                                break;
                            case 'firstLetter':
                                monthString = monthString.substring(0, 1);
                                break;
                        }
                        text = monthString;
                    }
                    else if (this.view == "decade" || this.view == "centuries") {
                        text = renderYears[i * 4 + r];
                        cell.setDate(renderDates[i * 4 + r]);
                        if (cell.getDate().getFullYear() == this.getDate().getFullYear()) {
                            cell.isSelected = true;
                        }
                        if (undefined == text) {
                            text = "<span style='cursor: default; visibility: hidden;'>2013</span>";
                        }
                    }

                    var date = cell.getDate();
                    if (this.view == "year") {
                        if (this._getYearAndMonthPart(date) < this._getYearAndMonthPart(minDate))
                            cell.isDisabled = true;
                        if (this._getYearAndMonthPart(date) > this._getYearAndMonthPart(maxDate))
                            cell.isDisabled = true;
                    }
                    else {
                        if (date.getFullYear() < minDate.getFullYear())
                            cell.isDisabled = true;
                        if (date.getFullYear() > maxDate.getFullYear())
                            cell.isDisabled = true;
                    }

                    $.jqx.utilities.html(cellElement, text);
                    cells[k] = cell;
                    k++;
                }
            }
            $.each(cells, function () {
                var element = this.element;
                var cell = this;
                if (!me.disabled) {
                    me.addHandler(element, 'mousedown',
                    function (event) {
                        me._setDateAndSwitchViews(cell);
                    });

                    me.addHandler(element, 'mouseover',
                    function (event) {
                        var renderCell = me.renderedCells[cell.index];
                        if (me.view != 'centuries' && renderCell.element.html().toLowerCase().indexOf('span') != -1) return;

                        renderCell.isHighlighted = true;
                        me._applyCellStyle(renderCell, renderCell.element, renderCell.element);
                    });

                    me.addHandler(element, 'mouseout',
                    function (event) {
                        var renderCell = me.renderedCells[cell.index];
                        if (me.view != 'centuries' && renderCell.element.html().toLowerCase().indexOf('span') != -1) return;

                        renderCell.isHighlighted = false;
                        me._applyCellStyle(renderCell, renderCell.element, renderCell.element);
                    });
                }
            });

            var monthInstance = $.data(this.element, month[0].id);
            if (monthInstance != undefined && monthInstance != null) {
                monthInstance.cells = cells;
            }
            this.renderedCells = cells;
            this._addCellsTable(tableElement, cellsTable);
            this._applyCellStyles();
        },

        _setDateAndSwitchViews: function (cell) {
            if (!this._viewAnimating && !this._animating) {
                var oldDate = this.getDate();
                var date = this.renderedCells[cell.index].getDate();
                var day = this.value.dateTime.getDate();
                var newDate = new Date(date);
                newDate.setDate(day);
                if (newDate.getMonth() == date.getMonth()) {
                    date = newDate;
                }

                var minDate = this.getMinDate();
                var maxDate = this.getMaxDate();

                if (this.view == "year") {
                    if (this._getYearAndMonthPart(date) < this._getYearAndMonthPart(minDate))
                        return;
                    if (this._getYearAndMonthPart(date) > this._getYearAndMonthPart(maxDate))
                        return;
                }
                else {
                    if (date.getFullYear() < minDate.getFullYear())
                        return;
                    if (date.getFullYear() > maxDate.getFullYear())
                        return;
                }

                this._selectDate(date);
                switch (this.view) {
                    case "year":
                        this.view = 'month';
                        break;
                    case "decade":
                        this.view = 'year';
                        break;
                }

                if (this.view == "year") {
                    if (this._getYearAndMonthPart(date) < this._getYearAndMonthPart(minDate))
                        date = minDate;

                    if (this._getYearAndMonthPart(date) > this._getYearAndMonthPart(maxDate))
                        date = maxDate;
                }
                else {
                    if (date.getFullYear() < minDate.getFullYear())
                        date = minDate;

                    if (date.getFullYear() > maxDate.getFullYear())
                        date = maxDate;
                }

                this.value._setYear(date.getFullYear());
                this.value._setDay(date.getDate());
                this.value._setMonth(date.getMonth() + 1);
                var visibleDate = this.getVisibleDate();
                var firstDay = this.getFirstDayOfWeek(visibleDate);
                var calendarID = "View" + this.element.id;
                this.renderCalendarCells(this.month, firstDay, calendarID, true);
                this.refreshTitle(this.month);
                this._selectDate(oldDate, 'view');
            }
        },

        renderCalendarCells: function (month, firstDay, calendarID, switchViews) {
            if (this.view == "year" || this.view == "decade" || this.view == 'centuries') {
                this.renderViews(month, firstDay, calendarID);
                return;
            }
            var cellsTable = $("<table role='grid' style='width: 100%; height: 100%;' cellspacing='2' cellpadding='1' id=" + 'cellTable' + calendarID.toString() + ">" +
               "<tr role='row'>" +
               "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" +
               "</tr>" +
               "<tr role='row'>" +
               "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" +
               "</tr>" +
               "<tr role='row'>" +
               "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" +
               "</tr>" +
               "<tr role='row'>" +
               "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" +
               "</tr>" +
               "<tr role='row'>" +
               "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" +
               "</tr>" +
               "<tr role='row'>" +
               "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" +
               "</tr>" +
               "</table>"
           );

            var tableElement = this.table;

            if (switchViews == undefined) {
                //      cellsTable.find('table').css({ background: 'none', padding: 0, margin: 0, border: 0 });
                //      cellsTable.find('td').css({ padding: 1, margin: 0 });
                //       cellsTable.find('tr').css({ background: 'none', padding: 0, margin: 0, border: 0 });
                var oldCellsTable = tableElement.find("#" + 'cellTable' + calendarID.toString());
                if (oldCellsTable != null) {
                    oldCellsTable.remove();
                }

                tableElement.append(cellsTable);
            }

            var currentDate = firstDay;

            var startRow = this.showDayNames ? 1 : 0;
            var startColumn = this.showWeekNumbers ? 1 : 0;
            var cells = new Array();
            var k = 0;

            var cellWidth = (month.width() - this.rowHeaderWidth - 2) / 7;
            if (!this.showWeekNumbers) {
                cellWidth = (month.width() - 2) / 7;
            }
            cellWidth = parseInt(cellWidth);
            var today = new $.jqx._jqxDateTimeInput.getDateTime(new Date());

            for (var i = 0; i < 6; i++) {
                for (var j = 0; j < 7; j++) {
                    var cellRowID = i + 1;
                    var r = j;
                    if (this.rtl) r = 6 - r;
                    var cellColumnID = r + 1;
                    var cellID = "#cell" + cellRowID + cellColumnID + this.element.id;
                    var date = new Date(currentDate.dateTime.getFullYear(), currentDate.dateTime.getMonth(), currentDate.dateTime.getDate());
                    var cell = new $.jqx._jqxCalendar.cell(date);
                    var cellElement = $(cellsTable[0].rows[i].cells[cellColumnID-1]);
                    cellElement[0].id = cellID.substring(1);

                    cell.isVisible = true;
                    cell.isDisabled = false;
                    if (currentDate.month != this.value.month) {
                        cell.isOtherMonth = true;
                        cell.isVisible = this.showOtherMonthDays;
                    }
                    if (date < this.getMinDate() || date > this.getMaxDate()) {
                        cell.isDisabled = true;
                    }

                    if (currentDate.month == today.month && currentDate.day == today.day && currentDate.year == today.year) {
                        cell.isToday = true;
                    }

                    if (currentDate.isWeekend()) {
                        cell.isWeekend = true;
                    }

                    cell.element = cellElement;
                    cell.row = startRow;
                    cell.column = startColumn;
                    $.jqx.utilities.html(cellElement, currentDate.day);

                    currentDate = new $.jqx._jqxDateTimeInput.getDateTime(new Date(currentDate._addDays(1)));

                    $.data(this.element, "cellContent" + cellID.substring(1), cell);
                    $.data(this.element, "" + cellID.substring(1), cell);
                    var me = this;
                    this.addHandler(cellElement, 'mousedown',
                    function (event) {
                       if (!me.readOnly && !me.disabled) {
                           var content = $(event.target);
                           var cell = $.data(me.element, content[0].id);
                           var result = me._raiseEvent(3, event);
                           if (cell != null && cell != undefined) {
                               var date = cell.getDate();
                               if (me.getMinDate() <= date && date <= me.getMaxDate()) {
                                   if (!cell.isDisabled) {
                                       if (cell.isOtherMonth && me.enableAutoNavigation) {
                                           if (cell.row < 2)
                                               me.navigateBackward();
                                           else
                                               me.navigateForward();
                                           me._selectDate(cell.getDate(), 'mouse', event.shiftKey);
                                       }
                                       else {
                                           var oldDate = new Date(me.getDate());
                                           me._selectDate(cell.getDate(), 'mouse', event.shiftKey);
                                           me.value._setYear(date.getFullYear());
                                           me.value._setDay(1);
                                           me.value._setMonth(date.getMonth() + 1);
                                           me.value._setDay(date.getDate());
                                           var table = me.host.find('.jqx-calendar-month');
                                           table.stop();
                                           table.css('margin-left', '0px');
                                           var currentDate = me.getDate();
                                           me._raiseEvent('2');
                                           if(cell.isOtherMonth)
                                           {
                                               me._raiseEvent('5', { selectionType: 'mouse' });
                                           }
                                       }
                                   }
                               }
                           }
                           return false;
                       }
                   });

                    if (!me.disabled) {
                        var highlight = function (event, highlight) {
                            if (!me.readOnly) {
                                var content = $(event.target);
                                var cell = $.data(me.element, content[0].id);

                                if (cell != null && cell != undefined) {
                                    var date = cell.getDate();
                                    if (me.getMinDate() <= date && date <= me.getMaxDate()) {
                                        cell.isHighlighted = highlight;
                                        me._applyCellStyle(cell, cell.element, content);
                                    }
                                }
                            }
                        }

                        this.addHandler(cellElement, 'mouseenter',
                              function (event) {
                                  highlight(event, true);
                                  return false;
                              });

                        this.addHandler(cellElement, 'mouseleave',
                              function (event) {
                                  highlight(event, false);
                                  return false;
                              });
                    }

                    startColumn++;
                    cells[k] = cell;
                    k++;
                }
                startColumn = 0;
                startRow++;
            }

            var monthInstance = $.data(this.element, month[0].id);
            if (monthInstance != undefined && monthInstance != null) {
                monthInstance.cells = cells;
            }
            this.renderedCells = cells;
            if (switchViews != undefined) {
                this._addCellsTable(tableElement, cellsTable);
            }
            this._applyCellStyles();
            this._refreshOtherMonthRows(monthInstance, calendarID);
        },

        // sets the maximum navigation date. 
        // @param - Date
        setMaxDate: function (date) {
            if (date != null && typeof (date) == "string") {
                date = new Date(date);
                if (date == "Invalid Date")
                    return;
            }

            this.maxDate = $.jqx._jqxDateTimeInput.getDateTime(date);
            this.render();
        },

        // gets the maximum navigation date.
        getMaxDate: function () {
            if (this.maxDate != null && this.maxDate != undefined) {
                return this.maxDate.dateTime;
            }

            return null;
        },

        // sets the minimum date. 
        // @param - Date
        setMinDate: function (date) {
            if (date != null && typeof (date) == "string") {
                date = new Date(date);
                if (date == "Invalid Date")
                    return;
            }

            this.minDate = $.jqx._jqxDateTimeInput.getDateTime(date);
            this.render();
        },

        // gets the minimum date.
        getMinDate: function () {
            if (this.minDate != null && this.minDate != undefined) {
                return this.minDate.dateTime;
            }

            return null;
        },


        // sets the calendar's date. 
        // @param - Date
        navigateTo: function (date, reason) {
            if (this.view == 'month') {
                var minDate = this.getMinDate();
                var maxDate = new Date(this.getMaxDate().getFullYear(), this.getMaxDate().getMonth() + 1, this.getMaxDate().getDate()); ;
                if ((date < this._getYearAndMonthPart(minDate)) || (date > this._getYearAndMonthPart(maxDate))) {
                    return false;
                }
            }
            else if (date.getFullYear() < this.getMinDate().getFullYear() || date.getFullYear() > this.getMaxDate().getFullYear()) {
                return false;
            }

            if (date == null) {
                return false;
            }

            if (reason == undefined) {
                var me = this;
                if (this._animating) {
                    return;
                }

                this._animating = true;
                var container = this.host.find('.jqx-calendar-month-container');
                if (this._viewClone) {
                    this._viewClone.stop();
                    this._viewClone.remove();
                }
                if (this._newViewClone) {
                    this._newViewClone.stop();
                    this._newViewClone.remove();
                }

                var table = this.host.find('.jqx-calendar-month');
                table.stop();
                table.css('margin-left', '0px');

                var viewClone = table.clone();
                this._viewClone = viewClone;
                var value = new Date(this.value.dateTime);
                this.value._setYear(date.getFullYear());
                this.value._setDay(date.getDate());
                this.value._setMonth(date.getMonth() + 1);

                me.refreshControl();

                container.css('position', 'relative');
                viewClone.css('position', 'absolute');
                viewClone.css('top', table.position().top);
                container.append(viewClone);
                if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                    this.month.css('position', 'relative');
                    this.month.css('overflow', 'hidden');
                    this.table.css('position', 'relative');
                    this.table.css('overflow', 'hidden');
                }

                var width = -this.host.width();
                if (date < value) {
                    if (this.view == "month" && date.getMonth() != value.getMonth()) {
                        width = this.host.width();
                    }
                    else if (date.getFullYear() != value.getFullYear()) {
                        width = this.host.width();
                    }
                }

                viewClone.animate({
                    marginLeft: parseInt(width) + 'px'
                }, this.navigationDelay, function () {
                    viewClone.remove();
                });
                var newViewClone = table.clone();
                this._newViewClone = newViewClone;
                newViewClone.css('position', 'absolute');
                newViewClone.css('top', table.position().top);
                container.append(newViewClone);
                newViewClone.css('margin-left', -width);
                table.css('visibility', 'hidden');
                newViewClone.animate({
                    marginLeft: '0px'
                }, this.navigationDelay, function () {
                    newViewClone.remove();
                    table.css('visibility', 'visible');
                    me._animating = false;
                });
            }
            else {
                this.value._setYear(date.getFullYear());
                this.value._setDay(date.getDate());
                this.value._setMonth(date.getMonth() + 1);
                var table = this.host.find('.jqx-calendar-month');
                table.stop();
                table.css('margin-left', '0px');

                this.refreshControl();
            }


            this._raiseEvent('2');
            this._raiseEvent('8');
            return true;
        },

        // sets the calendar's date. 
        // @param - Date
        setDate: function (date) {
            if (date != null && typeof (date) == "string") {
                date = new Date(date);
            }

            if (this.canRender == false) {
                this.canRender = true;
                this.render();
            }
            this.navigateTo(date, 'api');
            this._selectDate(date);
            if (this.selectionMode == 'range') {
                this._selectDate(date, 'mouse');
            }

            return true;
        },

        val: function (value) {
            if (arguments.length != 0) {
                if (value == null)
                    this.setDate(null);

                if (value instanceof Date)
                    this.setDate(value);

                if (typeof (value) == "string") {
                    this.setDate(value);
                }
            }
            return this.getDate();
        },

        // gets the calendar's date.
        getDate: function () {
            if (this.selectedDate == undefined)
                return new Date();

            return this.selectedDate;
        },

        getValue: function () {
            if (this.value == undefined)
                return new Date();

            return this.value.dateTime; ;
        },

        setRange: function (from, to) {
            if (this.canRender == false) {
                this.canRender = true;
                this.render();
            }

            this.navigateTo(from, 'api');
            this._selectDate(from, 'mouse');
            this._selectDate(to, 'mouse');
        },

        getRange: function () {
            return this.selection;
        },

        // selects a date.
        // @param - Date
        _selectDate: function (date, type, shift) {
            if (this.selectionMode == 'none')
                return;

            if (type == null || type == undefined) type = 'none';
            if (shift == null || shift == undefined) shift = false;

            var monthInstance = $.data(this.element, "View" + this.element.id);
            if (monthInstance == undefined || monthInstance == null)
                return;

            var self = this;
            if (this.input) {
                if (date != null) {
                    this.input.val(date.toString());
                }
                else this.input.val("");
            }
            var oldDate = this.selectedDate;
            this.selectedDate = date;

            if (this.view != "month") {
                if (oldDate != date) {
                    this._raiseEvent(7);
                }

                $.each(this.renderedCells, function (index) {
                    var cell = this;
                    var cellDate = cell.getDate();
                    var cellElement = $(cell.element);
                    var cellContent = cellElement.find("#cellContent" + cellElement[0].id);
                    if (date == null) {
                        cell.isSelected = false;
                        cell.isDisabled = false;
                    }
                    else {
                        cell.isSelected = false;
                        if (cellDate) {
                            if ((cellDate.getMonth() == date.getMonth() && self.view == "year") || (self.view == "decade" && cellDate.getFullYear() == date.getFullYear())) {
                                cell.isSelected = true;
                                try {
                                    cell.element.focus();
                                }
                                catch (error) {
                                }
                            }
                        }
                    }
                    self._applyCellStyle(cell, cellElement, cellElement);
                });
                return;
            }

            if (this.view == "month") {
                if (this.selectionMode == "range" && type == "key") {
                    var visibleDate = this.getVisibleDate();
                    var firstDay = this.getFirstDayOfWeek(visibleDate);
                    this.refreshCalendarCells(this.month, firstDay, "View" + this.element.id);
                }
            }

            $.each(this.renderedCells, function (index) {
                var cell = this;
                var cellDate = cell.getDate();
                var cellElement = $(cell.element);
                var cellContent = cellElement;
                if (cellElement.length == 0)
                    return false;


                if (date == null) {
                    cell.isSelected = false;
                    cell.isDisabled = false;
                    if (index == 0) {
                        self.selection = { from: null, to: null };
                        self._raiseEvent('2');
                        self._raiseEvent('5', { selectionType: type });
                    }
                }
                else {
                    if (self.selectionMode != 'range' || type == 'key') {
                        if (cellDate.getDate() == date.getDate() && cellDate.getMonth() == date.getMonth() && cellDate.getFullYear() == date.getFullYear() && cell.isSelected) {
                            self._applyCellStyle(cell, cellElement, cellContent);
                            return;
                        }

                        if (cell.isSelected) {
                            self._raiseEvent('6', { selectionType: type });
                        }

                        cell.isSelected = false;
                        if (cellDate.getDate() == date.getDate() && cellDate.getMonth() == date.getMonth() && cellDate.getFullYear() == date.getFullYear()) {
                            cell.isSelected = true;
                            if (index == 0) {
                                self.selection = { date: date };
                            }
                            try {
                                cell.element.focus();
                            }
                            catch (error) {
                            }

                            if (!cell.isOtherMonth) {
                                self.value._setMonth(date.getMonth() + 1);
                                self.value._setDay(date.getDate());
                                self.value._setYear(date.getFullYear());
                                self._raiseEvent('2');
                                self._raiseEvent('5', { selectionType: type });
                            }
                        }
                        if (self.selectionMode == 'range') {
                            self._clicks = 0;
                            self.selection = { from: date, to: date };
                        }
                    }
                    else if (self.selectionMode == 'range') {
                        if (type == "view") {
                            cell.isSelected = false;
                            cell.isDisabled = false;
                            if (self.getMaxDate() < cellDate) {
                                cell.isDisabled = true;
                            }
                            if (self.getMinDate() > cellDate) {
                                cell.isDisabled = true;
                            }
                            self._applyCellStyle(cell, cellElement, cellContent);
                            return true;
                        }

                        if (index == 0) {
                            if (type != 'none') {
                                if (self._clicks == undefined) self._clicks = 0;
                                self._clicks++;
                                if (shift) {
                                    self._clicks++;
                                }

                                if (self._clicks == 1) {
                                    self.selection = { from: date, to: date };
                                }
                                else {
                                    var from = self.selection.from;
                                    var min = from <= date ? from : date;
                                    var max = from <= date ? date : from;
                                    if (min) {
                                        var start = new Date(min.getFullYear(), min.getMonth(), min.getDate());
                                    }
                                    if (max) {
                                        var end = new Date(max.getFullYear(), max.getMonth(), max.getDate(), 23, 59, 59);
                                    }
                                    self.selection = { from: start, to: end };
                                    self._clicks = 0;
                                }
                            }
                            else {
                                if (self.selection == null || self.selection.from == null) {
                                    self.selection = { from: date, to: date };
                                    if (self._clicks == undefined) self._clicks = 0;
                                    self._clicks++;
                                    if (self._clicks == 2) self._clicks = 0;
                                }
                            }
                        }

                        var getDatePart = function (date) {
                            if (date == null) {
                                return new Date();
                            }

                            var newDate = new Date();
                            newDate.setHours(0, 0, 0, 0);
                            newDate.setFullYear(date.getFullYear(), date.getMonth(), date.getDate());
                            return newDate;
                        }

                        if (!cell.isOtherMonth && getDatePart(cellDate).toString() == getDatePart(date).toString()) {
                            self.value._setMonth(date.getMonth() + 1);
                            self.value._setDay(date.getDate());
                            self.value._setYear(date.getFullYear());
                            self._raiseEvent('2');
                            self._raiseEvent('5', { selectionType: type });
                        }
                        cell.isSelected = false;
                        cell.isDisabled = false;

                        if (getDatePart(cellDate) < getDatePart(self.selection.from) && self._clicks == 1) {
                            cell.isDisabled = true;
                        }
                        if (self.getMaxDate() < cellDate) {
                            cell.isDisabled = true;
                        }
                        if (self.getMinDate() > cellDate) {
                            cell.isDisabled = true;
                        }

                        if (getDatePart(cellDate) >= getDatePart(self.selection.from) && getDatePart(cellDate) <= getDatePart(self.selection.to)) {
                            cell.isSelected = true;
                        }
                    }
                }

                self._applyCellStyle(cell, cellElement, cellContent);
            });

            if (self.selectionMode == "range" && self._clicks == 0) {
                self._raiseEvent(7);
                return;
            }
            else if (self.selectionMode == "range")
                return;

            if (oldDate != date) {
                self._raiseEvent(7);
            }
        },

        // gets the selected date.
        _getSelectedDate: function () {
            var monthInstance = $.data(this.element, "View" + this.element.id);
            if (monthInstance == undefined || monthInstance == null)
                return;

            if (this.view != "month")
                return this.selectedDate;

            for (var i = 0; i < monthInstance.cells.length; i++) {
                var cell = monthInstance.cells[i];
                var cellDate = cell.getDate();
                if (cell.isSelected) {
                    return cellDate;
                }
            }
            if (this.selectedDate) {
                return this.selectedDate;
            }
        },

        // gets the selected cell.
        _getSelectedCell: function () {
            var monthInstance = $.data(this.element, "View" + this.element.id);
            if (monthInstance == undefined || monthInstance == null)
                return;

            for (var i = 0; i < monthInstance.cells.length; i++) {
                var cell = monthInstance.cells[i];
                var cellDate = cell.getDate();
                if (cell.isSelected) {
                    return cell;
                }
            }
        },

        _applyCellStyle: function (cell, cellElement, cellContent) {
            var self = this;
            if (cellContent == null || (cellContent != null && cellContent.length == 0)) {
                cellContent = cellElement;
            }

            cellContent.removeClass();
            cellContent[0].className = "";
            cellContent.addClass(this.toThemeProperty("jqx-rc-all"));

            if (this.disabled || cell.isDisabled) {
                cellContent.addClass(this.toThemeProperty("jqx-calendar-cell-disabled"));
                cellContent.addClass(this.toThemeProperty("jqx-fill-state-disabled"));
            }

            if (cell.isOtherMonth && this.enableOtherMonthDays && cell.isVisible) {
                cellContent.addClass(this.toThemeProperty("jqx-calendar-cell-othermonth"));
            }

            if (cell.isWeekend && this.enableWeekend && cell.isVisible && cell.isVisible) {
                cellContent.addClass(this.toThemeProperty("jqx-calendar-cell-weekend"));
            }

            if (!cell.isVisible) {
                cellContent.addClass(this.toThemeProperty("jqx-calendar-cell-hidden"));
            }
            else {
                cellContent.addClass(this.toThemeProperty("jqx-calendar-cell"));
                if (this.view != "month") {
                    if (cellContent.length > 0 && cellContent.html().toLowerCase().indexOf('span') != -1) {
                        cellContent.css('cursor', 'default');
                    }
                }
            }

            cellContent.removeAttr('aria-selected');
            if (cell.isSelected && cell.isVisible) {
                cellContent.addClass(this.toThemeProperty("jqx-calendar-cell-selected"));
                cellContent.addClass(this.toThemeProperty("jqx-fill-state-pressed"));
                cellContent.attr('aria-selected', true);
                this.host.removeAttr("aria-activedescendant").attr("aria-activedescendant", cellContent[0].id);
            }

            if (cell.isHighlighted && cell.isVisible && this.enableHover) {
                if (!cell.isDisabled) {
                    cellContent.addClass(this.toThemeProperty("jqx-calendar-cell-hover"));
                    cellContent.addClass(this.toThemeProperty("jqx-fill-state-hover"));
                }
            }

            cellContent.addClass(this.toThemeProperty("jqx-calendar-cell-" + this.view));

            if (cell.isToday && cell.isVisible) {
                cellContent.addClass(this.toThemeProperty("jqx-calendar-cell-today"));
            }

            if (this.specialDates.length > 0) {
                var me = this;
                $.each(this.specialDates, function () {
                    if (this.Class != undefined && this.Class != null && this.Class != '') {
                        cellContent.removeClass(this.Class);
                    }
                    else {
                        cellContent.removeClass(self.toThemeProperty("jqx-calendar-cell-specialDate"));
                    }

                    var date = cell.getDate();

                    if (date.getFullYear() == this.Date.getFullYear() && date.getMonth() == this.Date.getMonth() && date.getDate() == this.Date.getDate()) {
                        if (cell.tooltip == null && this.Tooltip != null) {
                            cell.tooltip = this.Tooltip;
                            if ($(cellContent).jqxTooltip) {
                                var className = this.Class;
                                $(cellContent).jqxTooltip({
                                    value: { cell: cell, specialDate: this.Date },
                                    name: me.element.id, content: this.Tooltip, position: 'mouse', theme: me.theme,
                                    opening: function (tooltip) {
                                        if (cellContent.hasClass(self.toThemeProperty("jqx-calendar-cell-specialDate"))) {
                                            return true;
                                        }
                                        if (cellContent.hasClass(className)) {
                                            return true;
                                        }
                                        return false;
                                    }
                                });
                            }
                        }

                        cellContent.removeClass(self.toThemeProperty("jqx-calendar-cell-othermonth"));
                        cellContent.removeClass(self.toThemeProperty("jqx-calendar-cell-weekend"));

                        if (this.Class == undefined || this.Class == '') {
                            cellContent.addClass(self.toThemeProperty("jqx-calendar-cell-specialDate"));
                            return false;
                        }
                        else {
                            cellContent.addClass(this.Class);
                            return false;
                        }
                    }
                }
                );
            }
        },

        _applyCellStyles: function () {
            var monthInstance = $.data(this.element, "View" + this.element.id);
            if (monthInstance == undefined || monthInstance == null)
                return;

            for (var i = 0; i < monthInstance.cells.length; i++) {
                var cell = monthInstance.cells[i];
                var cellElement = $(cell.element);
                var cellContent = cellElement.find("#cellContent" + cellElement[0].id);
                if (cellContent.length == 0) cellContent = cellElement;
                this._applyCellStyle(cell, cellElement, cellContent);
            }
        },

        // gets the week of year by Date.
        getWeekOfYear: function (date) {
            var dayOfYear = date.dayOfYear(date.dateTime) - 1;
            var week = date.dayOfWeek - (dayOfYear % 7);
            var offset = ((week - this.firstDayOfWeek) + 14) % 7;
            return Math.ceil((((dayOfYear + offset) / 7) + 1));
        },

        renderColumnHeader: function (month) {
            if (!this.showDayNames)
                return;

            var columnHeader = $("<table role='grid' style='border-spacing: 0px; border-collapse: collapse; width: 100%; height: 100%;' cellspacing='0' cellpadding='1'>" +
               "<tr role='row'>" +
               "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" + "<td role='gridcell'></td>" +
               "</tr>" +
               "</table>"
            );
            columnHeader.find('table').addClass(this.toThemeProperty('jqx-reset'));
            columnHeader.find('tr').addClass(this.toThemeProperty('jqx-reset'));
            columnHeader.find('td').css({ background: 'transparent', padding: 1, margin: 0, border: 'none' });
            columnHeader.addClass(this.toThemeProperty("jqx-reset"));
            columnHeader.addClass(this.toThemeProperty("jqx-calendar-column-header"));
            this.columnHeader.append(columnHeader);

            var visibleDate = this.getVisibleDate();
            var firstDay = this.getFirstDayOfWeek(visibleDate);
            var dayOfWeek = firstDay.dayOfWeek;
            var weekOfYear = this.getWeekOfYear(firstDay);

            var day = this.firstDayOfWeek;
            var dayNames = this.localization.calendar.days.names;

            var columnHeaderCells = new Array();
            var currentDate = firstDay;
            var cellWidth = (month.width() - this.rowHeaderWidth - 2) / 7;
            if (!this.showWeekNumbers) {
                cellWidth = (month.width() - 2) / 7;
            }

            for (var i = 0; i < 7; i++) {
                var dayString = dayNames[day];
                if (this.rtl) {
                    dayString = dayNames[6 - day];
                }

                // Possible values: default, shortest, firstTwoLetters, firstLetter, full
                switch (this.dayNameFormat) {
                    case 'default':
                        dayString = this.localization.calendar.days.namesAbbr[day];
                        break;
                    case 'shortest':
                        dayString = this.localization.calendar.days.namesShort[day];
                        break;
                    case 'firstTwoLetters':
                        dayString = dayString.substring(0, 2);
                        break;
                    case 'firstLetter':
                        dayString = dayString.substring(0, 1);
                        break;
                }

                var cell = new $.jqx._jqxCalendar.cell(currentDate.dateTime);
                var r = i + 1;

                var cellID = r + this.element.id;
                var cellElement = $(columnHeader[0].rows[0].cells[i]);

                var oldI = i;

                if (this.enableTooltips) {
                    if ($(cellElement).jqxTooltip) {
                        $(cellElement).jqxTooltip({
                            name: this.element.id, content: dayNames[day], theme: this.theme, position: 'mouse'
                        });
                    }
                }

                if (day >= 6) {
                    day = 0;
                }
                else {
                    day++;
                }

                i = oldI;
                cell.element = cellElement;
                cell.row = 0;
                cell.column = i + 1;
                var textWidth = this._textwidth(dayString);
                var cellContent = "<div style='padding: 0; margin: 0; border: none; background: transparent;' id='columnCell" + cellID + "'>" + dayString + "</div>";
                cellElement.append(cellContent);
                cellElement.find("#columnCell" + cellID).addClass(this.toThemeProperty('jqx-calendar-column-cell'));
                cellElement.width(cellWidth);
                if (this.disabled) {
                    cellElement.find("#columnCell" + cellID).addClass(this.toThemeProperty('jqx-calendar-column-cell-disabled'));
                }

                if (textWidth > 0 && cellWidth > 0) {
                    while (textWidth > cellElement.width()) {
                        if (dayString.length == 0)
                            break;

                        dayString = dayString.substring(0, dayString.length - 1);
                        $.jqx.utilities.html(cellElement.find("#columnCell" + cellID), dayString);
                        textWidth = this._textwidth(dayString);
                    }
                }

                columnHeaderCells[i] = cell;
                currentDate = new $.jqx._jqxDateTimeInput.getDateTime(new Date(currentDate._addDays(1)));
            }

            if (parseInt(this.columnHeader.width()) > parseInt(this.host.width())) {
                this.columnHeader.width(this.host.width())
            }

            var monthInstance = $.data(this.element, month[0].id);
            monthInstance.columnCells = columnHeaderCells;
        },

        _format: function (date, format, culture) {
            var globalize = false;
            try {
                if (Globalize != undefined) {
                    globalize = true;
                }
            }
            catch (error) {
            }

            if ($.global) {
                $.global.culture.calendar = this.localization.calendar;
                return $.global.format(date, format, this.culture);
            }
            else if (globalize) {
                try
                {
                    if (Globalize.cultures[this.culture]) {
                        Globalize.cultures[this.culture].calendar = this.localization.calendar;
                        return Globalize.format(date, format, this.culture);
                    }
                    else {
                        return Globalize.format(date, format, this.culture);
                    }
                }
                catch (error) {
                    return Globalize.format(date, format);
                }
            }
            else if ($.jqx.dataFormat) {
                return $.jqx.dataFormat.formatdate(date, format, this.localization.calendar);
            }
        },

        _textwidth: function (text) {
            var measureElement = $('<span>' + text + '</span>');
            measureElement.addClass(this.toThemeProperty('jqx-calendar-column-cell'));
            $(this.host).append(measureElement);
            var width = measureElement.width();
            measureElement.remove();
            return width;
        },

        _textheight: function (text) {
            var measureElement = $('<span>' + text + '</span>');
            $(this.host).append(measureElement);
            var height = measureElement.height();
            measureElement.remove();
            return height;
        },

        _renderRowHeader: function (month) {
            var visibleDate = this.getVisibleDate();
            var firstDay = this.getFirstDayOfWeek(visibleDate);
            var dayOfWeek = firstDay.dayOfWeek;
            var weekOfYear = this.getWeekOfYear(firstDay);

            var rowHeader = $("<table style='overflow: hidden; width: 100%; height: 100%;' cellspacing='0' cellpadding='1'>" +
               "<tr>" +
               "<td></td>" +
               "</tr>" +
               "<tr>" +
               "<td/>" +
               "</tr>" +
               "<tr>" +
               "<td/>" +
               "</tr>" +
               "<tr>" +
               "<td/>" +
               "</tr>" +
               "<tr>" +
               "<td/>" +
               "</tr>" +
               "<tr>" +
               "<td/>" +
               "</tr>" +
               "</table>"
           );

            rowHeader.find('table').addClass(this.toThemeProperty('jqx-reset'));
            rowHeader.find('td').addClass(this.toThemeProperty('jqx-reset'));
            rowHeader.find('tr').addClass(this.toThemeProperty('jqx-reset'));
            rowHeader.addClass(this.toThemeProperty("jqx-calendar-row-header"));
            rowHeader.width(this.rowHeaderWidth);
            this.rowHeader.append(rowHeader);

            var currentDate = firstDay;
            var rowHeaderCells = new Array();

            for (var i = 0; i < 6; i++) {
                var weekString = weekOfYear.toString();
                var cell = new $.jqx._jqxCalendar.cell(currentDate.dateTime);
                var cellID = i + 1 + this.element.id;
                var cellElement = $(rowHeader[0].rows[i].cells[0]);
                cell.element = cellElement;
                cell.row = i;
                cell.column = 0;
                var cellContent = "<div style='background: transparent; border: none; padding: 0; margin: 0;' id ='headerCellContent" + cellID + "'>" + weekString + "</div>";
                cellElement.append(cellContent);
                cellElement.find("#headerCellContent" + cellID).addClass(this.toThemeProperty('jqx-calendar-row-cell'));
                rowHeaderCells[i] = cell;
                currentDate = new $.jqx._jqxDateTimeInput.getDateTime(new Date(currentDate._addWeeks(1)));
                weekOfYear = this.getWeekOfYear(currentDate);
            }

            var monthInstance = $.data(this.element, month[0].id);
            monthInstance.rowCells = rowHeaderCells;
        },

        // gets the first week day.
        // @param - Date
        getFirstDayOfWeek: function (visibleDate) {
            var date = visibleDate;

            if (this.firstDayOfWeek < 0 || this.firstDayOfWeek > 6)
                this.firstDayOfWeek = 6;

            var num = date.dayOfWeek - this.firstDayOfWeek;
            if (num <= 0) {
                num += 7;
            }

            var newDate = $.jqx._jqxDateTimeInput.getDateTime(date._addDays(-num));
            return newDate;
        },

        // gets the visible date in the current month.
        getVisibleDate: function () {
            var visibleDate = new $.jqx._jqxDateTimeInput.getDateTime(new Date(this.value.dateTime));
            if (visibleDate < this.minDate) {
                visibleDate = this.minDate;
            }

            if (visibleDate > this.maxDate) {
                this.visibleDate = this.maxDate;
            }

            visibleDate.dateTime.setHours(0);
            var dayInMonth = visibleDate.day;
            var newVisibleDate = $.jqx._jqxDateTimeInput.getDateTime(visibleDate._addDays(-dayInMonth + 1));
            visibleDate = newVisibleDate;
            return visibleDate;
        },

        destroy: function (removeFromDom) {
            this.host
			.removeClass();

            if (removeFromDom != false) {
                this.host.remove();
            }
        },

        _raiseEvent: function (id, arg) {
            if (arg == undefined)
                arg = { owner: null };

            var evt = this.events[id];
            var args = arg ? arg : {};

            args.owner = this;
            var event = new jQuery.Event(evt);
            event.owner = this;
            event.args = args;
            if (id == 0 || id == 1 || id == 2 || id == 3 || id == 4 || id == 5 || id == 6 || id == 7 || id == 8) {
                event.args.date = event.args.selectedDate = this.getDate();
                event.args.range = this.getRange();
                var start = this.getViewStart();
                var end = this.getViewEnd();
                event.args.view = { from: start, to: end };
            }

            var result = this.host.trigger(event);
            if (id == 0 || id == 1) {
                result = false;
            }

            return result;
        },

        propertyMap: function (key) {
            if (key == "value") {
                if (this.selectionMode != 'range') {
                    return this.getDate();
                }
                else return this.getRange();
            }
            return null;
        },

        updateSize: function () {
            var month = this.host.find("#View" + this.element.id);
            if (month.length > 0) {

                this.setCalendarSize();
                if (this.height != undefined && !isNaN(this.height)) {
                    month.height(this.height);
                }
                else if (this.height != null && this.height.toString().indexOf("px") != -1) {
                    month.height(this.height);
                }

                if (this.width != undefined && !isNaN(this.width)) {
                    month.width(this.width);
                }
                else if (this.width != null && this.width.toString().indexOf("px") != -1) {
                    month.width(this.width);
                }

                var contentHeight = this.host.height() - this.titleHeight - this.columnHeaderHeight;
                var calendarID = "View" + this.element.id;
                month.find('#cellsTable' + calendarID).height(contentHeight);
                month.find('#calendarRowHeader' + calendarID).height(contentHeight);
                this.refreshControl();
            }
        },

        clear: function () {
            if (this.selectionMode == "range") {
                this._clicks = 1;
                this.setRange(null, null);
                this._raiseEvent(7);
            }
            else {
                this.setDate(null, 'mouse');
            }
            this._clicks = 0;
            this.selection = { from: null, to: null };
        },

        today: function()
        {
            if (this.selectionMode == 'range') {
                this.setRange(new Date(), new Date());
            }
            else {
                this.setDate(new Date(), 'mouse');
            }
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (this.isInitialized == undefined || this.isInitialized == false)
                return;

            if (key == "enableHover")
                return;
            if (key == "keyboardNavigation")
                return;

            if (key == 'localization') {
                if (this.localization) {
                    if (this.localization.backString) {
                        this.backText = this.localization.backString;
                    }
                    if (this.localization.forwardString) {
                        this.forwardText = this.localization.forwardString;
                    }
                    if (this.localization.todayString) {
                        this.todayString = this.localization.todayString;
                    }
                    if (this.localization.clearString) {
                        this.clearString = this.localization.clearString;
                    }
                    this.firstDayOfWeek = this.localization.calendar.firstDay;
                }
            }

            if (key == 'culture') {
                try
                {
                    if ($.global) {
                        $.global.preferCulture(object.culture);
                        object.localization.calendar = $.global.culture.calendar;
                    }
                    else if (Globalize) {
                        var culture = Globalize.culture(object.culture);
                        object.localization.calendar = culture.calendar;
                    }
                }
                catch (error) {
                }
            }
            if (key == 'width' || key == 'height') {
                object.updateSize();
                return;
            }
            else if (key == 'theme') {
                $.jqx.utilities.setTheme(oldvalue, value, this.host);
            }
            else {
                this.view = "month";
                this.render();
            }
        }
    });
})(jQuery);

(function ($) {
    $.jqx._jqxCalendar.cell = function (date) {
        var cell =
        {
            dateTime: new $.jqx._jqxDateTimeInput.getDateTime(date),
            _date: date,
            getDate: function ()
            {
                return this._date;
            },
            setDate: function(date)
            {
                this.dateTime = new $.jqx._jqxDateTimeInput.getDateTime(date);
                this._date = date;
            },
            isToday: false,
            isWeekend: false,
            isOtherMonth: false,
            isVisible: true,
            isSelected: false,
            isHighlighted: false,
            element: null,
            row: -1,
            column: -1,
            tooltip: null
        };

        return cell;
    } // calendar cell

    $.jqx._jqxCalendar.monthView = function (startDate, endDate, cells, rowHeaderCells, columnHeaderCells, element) {
        var month =
        {
            start: startDate,
            end: endDate,
            cells: cells,
            rowCells: rowHeaderCells,
            columnCells: columnHeaderCells,
            element: element
        };

        return month;
    } // calendar month

})(jQuery);(function ($) {
    $.jqx.jqxWidget("jqxDateTimeInput", "", {});

    $.extend($.jqx._jqxDateTimeInput.prototype, {

        defineInstance: function () {
            if (this.value == undefined) {
                this.value = $.jqx._jqxDateTimeInput.getDateTime(new Date());
                this.value._setHours(0);
                this.value._setMinutes(0);
                this.value._setSeconds(0);
                this.value._setMilliseconds(0);
            }
            if (this.minDate == undefined) {
                this.minDate = $.jqx._jqxDateTimeInput.getDateTime(new Date());
                this.minDate._setYear(1900);
                this.minDate._setMonth(1);
                this.minDate._setDay(1);
                this.minDate._setHours(1);
                this.minDate._setMinutes(1);
                this.minDate._setSeconds(1);
                this.minDate._setMilliseconds(1);
            }
            this.defaultMinDate = this.minDate;
            if (this.maxDate == undefined) {
                this.maxDate = $.jqx._jqxDateTimeInput.getDateTime(new Date());
                this.maxDate._setYear(2100);
                this.maxDate._setMonth(1);
                this.maxDate._setDay(1);
                this.maxDate._setHours(1);
                this.maxDate._setMinutes(1);
                this.maxDate._setSeconds(1);
                this.maxDate._setMilliseconds(1);
            }
            this.defaultMaxDate = this.maxDate;
            this.min = new Date(1900, 0, 1);
            this.max = new Date(2100, 0, 1);
            this.rowHeaderWidth = 25;

            // Default: 20
            // Gets or sets the column header's height.
            // Type: Number.
            this.columnHeaderHeight = 20;

            // Default: 25
            // Gets or sets the title's height.
            // Type: Number.
            this.titleHeight = 25;
            // Type: Number.
            // Default: 0
            // Gets or sets the first day of the week - Sunday = 0, Monday = 1, Tuesday = 2, Wednesday = 3, Thursday = 4, Friday = 5, Saturday = 6.
            if (this.firstDayOfWeek == undefined) {
                this.firstDayOfWeek = 0;
            }
            // Type: Boolean.
            // Default: false.
            // Shows or hides the week numbers.
            if (this.showWeekNumbers == undefined) {
                this.showWeekNumbers = false;
            }
            // store value in cookie
            this.cookies = false;
            this.cookieoptions = null;
            this.showFooter = false;
            //Type: String.
            //Default: null.
            //Sets the masked input's formatString.
            // Available ready to use patterns:
            // short date pattern: "d",
            // long date pattern: "D"
            // short time pattern: "t"
            // long time pattern: "T"
            // long date, short time pattern: "f"
            // long date, long time pattern: "F"
            // month/day pattern: "M"
            // month/year pattern: "Y"    
            // sortable format that does not vary by culture: "S"
            if (this.formatString === undefined) {
                this.formatString = "dd/MM/yyyy";
            }
            //Type: Number.
            //Default: 0.
            //Sets width of the masked input in pixels. Only positive values have effect.
            if (this.width === undefined) {
                this.width = null;
            }

            //Type: Number.
            //Default: 0.
            //Sets height of the masked input in pixels. 
            if (this.height === undefined) {
                this.height = null;
            }

            // Type: String.
            // Gets or sets the string format of the day names.
            // Possible values: default, shortest, firstTwoLetters, firstLetter, full
            if (this.dayNameFormat === undefined) {
                this.dayNameFormat = 'firstTwoLetters';
            }

            // Type: String
            // Sets the  text alignment.
            if (this.textAlign === undefined) {
                this.textAlign = 'left';
            }

            // Type: Boolean
            // Default: false
            // Sets the readonly state of the input.
            if (this.readonly === undefined) {
                this.readonly = false;
            }

            // Type: String
            // sets the culture.
            // Default: 'default'
            if (this.culture === undefined) {
                this.culture = "default";
            }

            this.activeEditor = this.activeEditor || null;

            // Type: Boolean
            // Default:true.
            // shows or hides the calendar's button.
            if (this.showCalendarButton === undefined) {
                this.showCalendarButton = true;
            }
            // Type: Number
            // Default: 250
            // Sets the animation's duration when the calendar is displayed.
            if (this.openDelay == undefined) {
                this.openDelay = 250;
            }

            // Type: Number
            // Default: 300
            // Sets the animation's duration when the calendar is going to be hidden.
            if (this.closeDelay === undefined) {
                this.closeDelay = 300;
            }

            // Type: Boolean
            // Default: true
            // Sets whether to close the calendar after selecting a date.
            if (this.closeCalendarAfterSelection === undefined) {
                this.closeCalendarAfterSelection = true;
            }
            // internal property
            this.isEditing = false;
            // Type: Boolean.
            // enables the browser window bounds detection.
            // Default: false.
            this.enableBrowserBoundsDetection = false;
            this.dropDownHorizontalAlignment = 'left';
            // Type: Boolean
            // Enables absolute date selection. When this property is true, the user selects one symbol at a time instead of a group of symbols.
            // Default: false
            this.enableAbsoluteSelection = false;
            // Type: Boolean
            // Enables or disables the DateTimeInput.
            // Default: false
            this.disabled = false;
            // Type: Number
            // Default: 18
            // Sets the button's size.
            this.buttonSize = 18;
            // default, none
            // Type: String.
            // enables or disables the animation.
            this.animationType = 'slide';
            // Type: String
            // Default: auto ( the drop down takes the calendar's width.)
            // Sets the popup's width.
            this.dropDownWidth = '205px';
            // Type: String
            // Default: 200px ( the height is 200px )
            // Sets the popup's height.
            this.dropDownHeight = '205px';
            // 'none', 'range', 'default'
            this.selectionMode = 'default';
            this.rtl = false;
            this._editor = false;
            this.todayString = 'Today';
            this.clearString = 'Clear';
            this.popupZIndex = 100000;
            this.allowNullDate = true;
            this.allowKeyboardDelete = true;
            this.localization = {
                backString: "Back",
                forwardString: "Forward",
                todayString: "Today",
                clearString: "Clear",
                calendar: {
                    name: "Gregorian_USEnglish",
                    "/": "/",
                    // separator of parts of a time (e.g. ":" in 05:44 PM)
                    ":": ":",
                    // the first day of the week (0 = Sunday, 1 = Monday, etc)
                    firstDay: 0,
                    days: {
                        // full day names
                        names: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
                        // abbreviated day names
                        namesAbbr: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
                        // shortest day names
                        namesShort: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"]
                    },
                    months: {
                        // full month names (13 months for lunar calendards -- 13th month should be "" if not lunar)
                        names: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December", ""],
                        // abbreviated month names
                        namesAbbr: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", ""]
                    },
                    // AM and PM designators in one of these forms:
                    // The usual view, and the upper and lower case versions
                    //      [standard,lowercase,uppercase]
                    // The culture does not use AM or PM (likely all standard date formats use 24 hour time)
                    //      null
                    AM: ["AM", "am", "AM"],
                    PM: ["PM", "pm", "PM"],
                    eras: [
                    // eras in reverse chronological order.
                    // name: the name of the era in this culture (e.g. A.D., C.E.)
                    // start: when the era starts in ticks (gregorian, gmt), null if it is the earliest supported era.
                    // offset: offset in years from gregorian calendar
                        { "name": "A.D.", "start": null, "offset": 0 }
                    ],
                    twoDigitYearMax: 2029,
                    patterns: {
                        // short date pattern
                        d: "M/d/yyyy",
                        // long date pattern
                        D: "dddd, MMMM dd, yyyy",
                        // short time pattern
                        t: "h:mm tt",
                        // long time pattern
                        T: "h:mm:ss tt",
                        // long date, short time pattern
                        f: "dddd, MMMM dd, yyyy h:mm tt",
                        // long date, long time pattern
                        F: "dddd, MMMM dd, yyyy h:mm:ss tt",
                        // month/day pattern
                        M: "MMMM dd",
                        // month/year pattern
                        Y: "yyyy MMMM",
                        // S is a sortable format that does not vary by culture
                        S: "yyyy\u0027-\u0027MM\u0027-\u0027dd\u0027T\u0027HH\u0027:\u0027mm\u0027:\u0027ss",
                        // formatting of dates in MySQL DataBases
                        ISO: "yyyy-MM-dd hh:mm:ss"
                    }
                }
            };
            // DateTimeInput events.
            this.events =
			[
            // Occurs when the value is changed.
		  	   'valuechanged',
            // Occurs when the text is changed.
               'textchanged',
            // Occurs when the mouse button is clicked.
               'mousedown',
            // Occurs when the mouse button is clicked.
               'mouseup',
            // Occurs when the user presses a key. 
               'keydown',
            // Occurs when the user presses a key. Fired after keydown and keypress
               'keyup',
            // Occurs when the user presses a key.
               'keypress',
            // Occurs when the calendar is opened.
               'open',
            // Occurs when the calendar is hidden.
               'close',
               // Occurs when the value is changed.
               'change'
			];
            this.aria =
            {
                "aria-valuenow": { name: "getDate", type: "date" },
                "aria-valuetext": { name: "getText", type: "string" },
                "aria-valuemin": { name: "min", type: "date" },
                "aria-valuemax": { name: "max", type: "date" },
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
        },

        // creates the masked input's instance. 
        createInstance: function (args) {
            var hasAttr = "";
            if (!this.host.jqxCalendar) {
                throw new Error("jqxDateTimeInput: Missing reference to jqxcalendar.js.");
            }

            if (this.host.attr('value')) {
                hasAttr = true;
                var val = this.host.attr('value');
                if (this.selectionMode != 'range') {
                    var date = new Date(val);
                    if (date != undefined && !isNaN(date)) {
                        this.value = $.jqx._jqxDateTimeInput.getDateTime(date);
                    }
                }
            }

            if (this.value != null && this.value instanceof Date) {
                this.value = $.jqx._jqxDateTimeInput.getDateTime(this.value);
            }
            else if (this.value != null && typeof (this.value) == "string") {
                var date = new Date(this.value);
                if (date != undefined && !isNaN(date)) {
                    this.value = $.jqx._jqxDateTimeInput.getDateTime(date);
                }
            }

            this.host.attr('data-role', 'input');
            this.render();
            $.jqx.aria(this);
            if (this.getDate() != null) {
                $.jqx.aria(this, "aria-label", "Current focused date is " + this.getDate().toLocaleString());
            }
            else {
                $.jqx.aria(this, "aria-label", "Current focused date is Null");
            }

            if (this.minDate !== this.defaultMinDate) {
                this.min = this.minDate;
            }
            if (this.maxDate !== this.defaultMaxDate) {
                this.max = this.maxDate;
            }

            this.setMaxDate(this.max, false);
            this.setMinDate(this.min, false);
   
            if (this.selectionMode == 'range') {
                if (hasAttr) {
                    var val = this.host.attr('value');
                    var val1 = val.substring(0, val.indexOf('-'));
                    var val2 = val.substring(val.indexOf('-') + 1);
                    var from = new Date(val1);
                    var to = new Date(val2);
                    if (from != undefined && !isNaN(from)) {
                        if (to != undefined && !isNaN(to)) {
                            this.setRange(from, to);
                        }
                    }
                }
                else {
                    if (this.getDate() != null) {
                        this.setRange(this.getDate(), this.getDate());
                    }
                }
            }
        },

        _format: function (date, format, culture) {
            var globalize = false;
            try {
                if (Globalize != undefined) {
                    globalize = true;
                }
            }
            catch (error) {
            }

            if ($.global) {
                return $.global.format(date, format, this.culture);
            }
            else if (globalize) {
                try {
                    var format = Globalize.format(date, format, this.culture);
                    return format;
                }
                catch (error) {
                    return Globalize.format(date, format);
                }
            }
            else if ($.jqx.dataFormat) {
                if (date instanceof Date) {
                    return $.jqx.dataFormat.formatdate(date, format, this.localization.calendar);
                }
                else if (typeof date === "number") {
                    return $.jqx.dataFormat.formatnumber(date, format, this.localization.calendar);
                }
                else {
                    return $.jqx.dataFormat.formatdate(date, format, this.localization.calendar);
                }
            }
            else throw new Error("jqxDateTimeInput: Missing reference to globalize.js.");
        },

        render: function () {
            this._removeHandlers();
            this.element.innerHTML = "";
            this.host
		    .attr({
		        role: "textbox"
		    });
            this.id = $.jqx.utilities.createId();
            var id = $.jqx.utilities.createId();
            var buttonid = $.jqx.utilities.createId();
            var dateTimeInputStructure = $("<div class='jqx-datetimeinput-container' style='overflow: hidden; border: 0px;'>" +
                "<div id='dateTimeWrapper' style='float: none; position: relative; width: 100%; height: 100%;'>" +
                "<div class='jqx-datetimeinput-content' id='dateTimeContent" + id + "' style='position: relative; overflow: hidden; float: left;'/>" +
                "<div id='dateTimeButton" + buttonid + "' style='position: relative; float: right;'/>" +
                "</div>" +
                "</div>");

            this.host.css('overflow', 'hidden');
            this._setSize();
            if (this.width == null) {
                this.width = this.host.width();
                this.host.width(this.width);
            }

            this.touch = $.jqx.mobile.isTouchDevice();

            this.host.append(dateTimeInputStructure);
            this.dateTimeWrapper = this.host.find('#dateTimeWrapper');
            this.inputElement = this.host.find("#dateTimeContent" + id);
            this.calendarElement = this.host.find("#dateTimeButton" + buttonid);
            this.dateTimeInput = $("<input autocomplete='off' style='position: relative; border: none; margin: 0; padding: 0;' id='inputElement' class='jqx-input-content' type='textarea'/>").appendTo(this.inputElement);
            this.dateTimeInput[0].id = "input" + this.element.id;
            this.dateTimeInput.removeClass(this.toThemeProperty("jqx-input-content"));
            this.dateTimeInput.addClass(this.toThemeProperty("jqx-input-content"));
            this.dateTimeInput.addClass(this.toThemeProperty("jqx-widget-content"));
            this.dateTimeInput.addClass(this.toThemeProperty("jqx-rc-all"));
            var name = this.host.attr('name');
            if (!name) name = this.element.id;
            this.dateTimeInput.attr('name', name);
            if (this.rtl) {
                this.dateTimeInput.css('direction', 'rtl');
                this.dateTimeInput.addClass('jqx-rtl');
                this.inputElement.css('float', 'right');
                this.calendarElement.css('float', 'left');
            }

            this.inputElement.addClass(this.toThemeProperty("jqx-input"));
            this.inputElement.addClass(this.toThemeProperty("jqx-widget-content"));
            this.inputElement.addClass(this.toThemeProperty("jqx-rc-all"));
            this.inputElement.height(this.host.height() - 2);

            this.calendarButton = $("<div style='padding: 0px; margin: 0px; top: 0; font-size: 3px; position: relative;' class='jqx-input-button-header'>"
            + "<div style='position: relative; font-size: 3px;' class='jqx-input-button-innerheader'></div></div><div style='padding: 0px; margin: 0px; top: 0; position: relative;' class='jqx-input-button-content'/>").appendTo(this.calendarElement);
            this.calendarButtonContent = this.host.find(".jqx-input-button-content");
            this.calendarButtonHeader = this.host.find(".jqx-input-button-header");
            this.calendarButtonInnerHeader = this.host.find(".jqx-input-button-innerheader");
            this.calendarButtonContent.removeClass(this.toThemeProperty("jqx-input-button-content"));
            this.calendarButtonContent.addClass(this.toThemeProperty("jqx-input-button-content"));
            this.calendarButtonContent.removeClass(this.toThemeProperty("jqx-widget-content"));
            this.calendarButtonContent.addClass(this.toThemeProperty("jqx-widget-content"));
            this.calendarButtonHeader.removeClass(this.toThemeProperty("jqx-input-button-header"));
            this.calendarButtonHeader.addClass(this.toThemeProperty("jqx-input-button-header"));
            this.calendarButtonHeader.removeClass(this.toThemeProperty("jqx-widget-header"));
            this.calendarButtonHeader.addClass(this.toThemeProperty("jqx-widget-header"));
            this.calendarButtonInnerHeader.removeClass(this.toThemeProperty("jqx-input-button-innerHeader"));
            this.calendarButtonInnerHeader.addClass(this.toThemeProperty("jqx-input-button-innerHeader"));

            var me = this;
            this._arrange();
            this.addHandler(this.host, 'loadContent', function (event) {
                me._arrange();
            });

            if (this.showCalendarButton) {
                this.calendarButton.css('display', 'block');
            }
            else {
                this.calendarButton.css('display', 'none');
            }

            if ($.jqx._jqxCalendar != null && $.jqx._jqxCalendar != undefined) {
                try {
                    var calendarID = 'calendar' + this.id;
                    var oldContainer = $($.find('#' + calendarID));
                    if (oldContainer.length > 0) {
                        oldContainer.remove();
                    }
                    $.jqx.aria(this, "aria-owns", calendarID);
                    $.jqx.aria(this, "aria-haspopup", true);
                    $.jqx.aria(this, "aria-readonly", this.selectionMode == 'range' ? true : false);

                    var container = $("<div style='overflow: hidden; background: transparent; position: absolute;' id='calendar" + this.id + "'><div id='innerCalendar" + this.id + "'></div></div>");
                    if ($.jqx.utilities.getBrowser().browser == 'opera') {
                        container.hide();
                    }
                    container.appendTo(document.body);
                    this.container = container;
                    this.calendarContainer = $($.find('#innerCalendar' + this.id)).jqxCalendar({ rowHeaderWidth: this.rowHeaderWidth, titleHeight: this.titleHeight, columnHeaderHeight: this.columnHeaderHeight, _checkForHiddenParent: false, enableAutoNavigation: false, canRender: false, localization: this.localization, todayString: this.todayString, clearString: this.clearString, dayNameFormat: this.dayNameFormat, rtl: this.rtl, culture: this.culture, showFooter: this.showFooter, selectionMode: this.selectionMode, firstDayOfWeek: this.firstDayOfWeek, showWeekNumbers: this.showWeekNumbers, width: this.dropDownWidth, height: this.dropDownHeight, theme: this.theme });
                    this.calendarContainer.css({ position: 'absolute', zIndex: this.popupZIndex, top: 0, left: 0 });
                    this.calendarContainer.addClass(this.toThemeProperty('jqx-popup'));
                    if ($.jqx.browser.msie) {
                        this.calendarContainer.addClass(this.toThemeProperty('jqx-noshadow'));
                    }
                    this._calendar = $.data(this.calendarContainer[0], "jqxCalendar").instance;
                    var me = this;
                    this._calendar.today = function () {
                        me.today();
                    }
                    this._calendar.clear = function () {
                        me.clear();
                    }

                    if ($.jqx.utilities.getBrowser().browser == 'opera') {
                        container.show();
                    }
                    container.height(parseInt(this.calendarContainer.height()) + 25);
                    container.width(parseInt(this.calendarContainer.width()) + 25);

                    if (this.selectionMode == 'range') {
                        this.readonly = true;
                    }

                    if (this.animationType == 'none') {
                        this.container.css('display', 'none');
                    }
                    else {
                        this.container.hide();
                    }

                }
                catch (e) {

                }
            }

            if ($.global) {
                $.global.preferCulture(this.culture);
            }

            this.selectedText = "";

            this._addHandlers();
            this.self = this;
            this.oldValue = this.getDate();
            this.items = new Array();
            this.editors = new Array();

            if (this.value) {
                this.calendarButtonContent.html("<div style='line-height: 16px;  color: inherit; background: transparent; margin: 0; border: 0; padding: 0px; text-align: center; vertical-align: middle;'>" + "<b style='border: 0; padding: 0px; margin: 0px; background: transparent;'>" + this.value.day + "</b>" + "</div>");
            }
            this._loadItems();
            this.editorText = "";

            if (this.readonly == true) {
                this.dateTimeInput.css("readonly", this.readonly);
            }

            this.dateTimeInput.css("text-align", this.textAlign);
            this.host.addClass(this.toThemeProperty('jqx-widget'));

            this.propertyChangeMap['disabled'] = function (instance, key, oldVal, value) {
                if (value) {
                    instance.host.addClass(me.toThemeProperty('jqx-input-disabled'));
                    instance.dateTimeInput.addClass(me.toThemeProperty('jqx-input-disabled'));
                    instance.host.addClass(me.toThemeProperty('jqx-fill-state-disabled'));
                }
                else {
                    instance.host.removeClass(me.toThemeProperty('jqx-fill-state-disabled'));
                    instance.host.removeClass(me.toThemeProperty('jqx-input-disabled'));
                    instance.dateTimeInput.removeClass(me.toThemeProperty('jqx-input-disabled'));
                }
                $.jqx.aria(this, "aria-disabled", value);
            }

            if (this.disabled) {
                this.host.addClass(this.toThemeProperty('jqx-input-disabled'));
                this.host.addClass(this.toThemeProperty('jqx-input-disabled'));
                this.dateTimeInput.addClass(this.toThemeProperty('jqx-input-disabled'));
            }

            if (this.host.parents('form').length > 0) {
                this.addHandler(this.host.parents('form'), 'reset', function () {
                    setTimeout(function () {
                        me.setDate(new Date());
                    }, 10);
                });
            }

            if (this.cookies) {
                var date = $.jqx.cookie.cookie("jqxDateTimeInput" + this.element.id);
                if (date != null) {
                    this.setDate(new Date(date));
                }
            }

            // fix for IE7
            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                if (this.host.parents('.jqx-window').length > 0) {
                    var zIndex = this.host.parents('.jqx-window').css('z-index');
                    this.container.css('z-index', zIndex + 10);
                    this.calendarContainer.css('z-index', zIndex + 10);
                }
            }

            if (this.culture != 'default')
            {
                this._applyCulture();
            }
        },

        val: function (value) {
            if (arguments.length != 0) {
                if (value == null)
                    this.setDate(null);

                if (this.selectionMode == 'range') {
                    this.setRange(arguments[0], arguments[1]);
                    return this.getText();
                }

                if (value instanceof Date) {
                    this.setDate(value);
                }

                if (typeof (value) == "string") {
                    if (value == 'date') {
                        return this.getDate();
                    }

                    this.setDate(value);
                }
            }
            return this.getText();
        },

        _setSize: function () {
            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                this.host.width(this.width);
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    this.host.width(this.width);
                }

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                this.host.height(this.height);
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                this.host.height(this.height);
            }

            var isPercentage = false;
            if (this.width != null && this.width.toString().indexOf("%") != -1) {
                isPercentage = true;
                this.host.width(this.width);
            }

            if (this.height != null && this.height.toString().indexOf("%") != -1) {
                isPercentage = true;
                this.host.height(this.height);
            }

            var me = this;
            var resizeFunc = function () {
                if (me.calendarContainer) {
                    me._arrange();
                    if (me.dropDownWidth == 'auto') {
                        var width = me.host.width();
                        me.calendarContainer.jqxCalendar({ width: width });
                        me.container.width(parseInt(width) + 25);
                    }
                }
            }

            if (isPercentage) {
                if (this.calendarContainer) {
                    this.refresh(false);
                    var width = this.host.width();
                    if (this.dropDownWidth != 'auto') {
                        width = this.dropDownWidth;
                    }
                    this.calendarContainer.jqxCalendar({ width: width });
                    this.container.width(parseInt(width) + 25);
                }
            }
            $.jqx.utilities.resize(this.host, function () {
                resizeFunc();
            });
        },

        _arrange: function () {
            var width = parseInt(this.host.width());
            var height = parseInt(this.host.height());
            var buttonSize = this.buttonSize;
            var rightOffset = 3;
            this.calendarButtonHeader.width(buttonSize);
            this.calendarButtonContent.height(buttonSize - rightOffset - 1);
            this.calendarButtonContent.width(buttonSize);
            this.inputElement.height(height - 2);

            var inputElementOffset = parseInt(this.inputElement.outerHeight()) - parseInt(this.inputElement.height());
            inputElementOffset = 0;

            var contentWidth = width - buttonSize -2 - 1 * rightOffset;
            if (contentWidth > 0) {
                this.inputElement.width(contentWidth + 'px');
            }

            this.dateTimeInput.width(contentWidth - rightOffset + 'px');
            this.dateTimeInput.css('left', 0);
            this.dateTimeInput.css('top', 0);
            this.inputElement.css('left', 0);
            this.inputElement.css('top', 0);

            var buttonMiddle = parseInt(this.calendarButtonHeader.outerWidth()) / 2 - parseInt(this.calendarButtonInnerHeader.outerWidth()) / 2;
            this.calendarButtonInnerHeader.css('left', buttonMiddle);
            var buttonsHeight = parseInt(this.calendarButtonContent.outerHeight()) + parseInt(this.calendarButtonHeader.outerHeight());
            var top = parseInt(this.inputElement.outerHeight()) / 2 - buttonsHeight / 2;
            this.calendarElement.css('top', parseInt(top) + 'px');

            var inputHeight = this.dateTimeInput.outerHeight();
            if (inputHeight == 0) {
                inputHeight = parseInt(this.dateTimeInput.css('font-size')) + 3;
            }
            var inputTop = parseInt(this.inputElement.height()) / 2 - parseInt(inputHeight) / 2;
            var height = this.host.height() - 2;
            if (height > 16) {
                this.dateTimeInput.height(height);
            }

      //      this.dateTimeInput.css('margin-top', -inputHeight / 2);
      //      this.dateTimeInput.css('top', "50%");
        },

        _removeHandlers: function () {
            var me = this;
            this.removeHandler($(document), 'mousedown.' + this.id);
            if (this.dateTimeInput) {
                this.removeHandler(this.dateTimeInput, 'keydown.' + this.id);
                this.removeHandler(this.dateTimeInput, 'blur');
                this.removeHandler(this.dateTimeInput, 'focus');
                this.removeHandler(this.host, 'focus');
                this.removeHandler(this.dateTimeInput, 'mousedown');
                this.removeHandler(this.dateTimeInput, 'mouseup');
                this.removeHandler(this.dateTimeInput, 'keydown');
                this.removeHandler(this.dateTimeInput, 'keyup');
                this.removeHandler(this.dateTimeInput, 'keypress');
            }
            if (this.calendarButton != null) {
                this.removeHandler(this.calendarButton, 'mousedown');
            }
            if (this.calendarContainer != null) {
                this.removeHandler(this.calendarContainer, 'cellSelected');
                this.removeHandler(this.calendarContainer, 'cellMouseDown');
            }
            this.removeHandler($(window), 'resize.' + this.id);
        },

        isOpened: function () {
            var me = this;
            var openedCalendar = $.data(document.body, "openedJQXCalendar" + this.id);
            if (openedCalendar != null && openedCalendar == me.calendarContainer) {
                return true;
            }

            return false;
        },

        wheel: function (event, self) {
            var delta = 0;
            if (!event) /* For IE. */
                event = window.event;
            if (event.originalEvent && event.originalEvent.wheelDelta) {
                event.wheelDelta = event.originalEvent.wheelDelta;
            }
            if (event.wheelDelta) { /* IE/Opera. */
                delta = event.wheelDelta / 120;
            } else if (event.detail) { /** Mozilla case. */
                delta = -event.detail / 3;
            }

            if (delta) {
                var result = self._handleDelta(delta);
                if (!result) {
                    if (event.preventDefault)
                        event.preventDefault();
                    event.returnValue = false;
                    return result;
                }
                else return false;
            }

            if (event.preventDefault)
                event.preventDefault();
            event.returnValue = false;
        },

        _handleDelta: function (delta) {
            if (delta < 0) {
                this.spinDown();
            }
            else this.spinUp();

            return false;
        },

        focus: function () {
            try {

                this.dateTimeInput.focus();
            }
            catch (error) {
            }
        },

        _addHandlers: function () {
            var id = this.element.id;
            var el = this.element;
            var me = this;

            if (this.host.parents()) {
                this.addHandler(this.host.parents(), 'scroll.datetimeinput' + this.element.id, function (event) {
                    var opened = me.isOpened();
                    if (opened) {
                        me.close();
                    }
                });
            }

            this.addHandler(this.host, 'mousewheel', function (event) {
                me.wheel(event, me);
            });

            this.addHandler($(document), 'mousedown.' + this.id, this._closeOpenedCalendar, { me: this });
            if ($.jqx.mobile.isTouchDevice()) {
                this.addHandler($(document), $.jqx.mobile.getTouchEventName('touchstart') + '.' + this.id, this._closeOpenedCalendar, { me: this });
            }

            this.addHandler(this.dateTimeInput, 'keydown.' + this.id, function (event) {
                var openedCalendar = $.data(document.body, "openedJQXCalendar" + me.id);
                if (openedCalendar != null && openedCalendar == me.calendarContainer) {
                    var result = me.handleCalendarKey(event, me);
                    return result;
                }
            });

            if (this.calendarContainer != null) {
                this.addHandler(this.calendarContainer, 'keydown', function (event) {
                    if (event.keyCode == 13) {
                        if (me.isOpened()) {
                            if (!me._calendar._viewAnimating && me._calendar.view == "month") {
                                me.hideCalendar('selected');
                                me.dateTimeInput.focus();
                                return false;
                            }
                        }
                        return true;
                    }
                    else if (event.keyCode == 9) {
                        if (me.isOpened()) {
                            me.hideCalendar('selected');
                            return true;
                        }
                    }
                    else if (event.keyCode == 27) {
                        if (me.isOpened()) {
                            me.hideCalendar();
                            me.dateTimeInput.focus();
                            return false;
                        }
                        return true;
                    }
                    if (event.keyCode == 115) {
                        if (me.isOpened()) {
                            me.hideCalendar();
                            me.dateTimeInput.focus();
                            return false;
                        }
                        else if (!me.isOpened()) {
                            me.showCalendar();
                            me.dateTimeInput.focus();
                            return false;
                        }
                    }

                    if (event.altKey) {
                        if (event.keyCode == 38) {
                            if (me.isOpened()) {
                                me.hideCalendar();
                                me.dateTimeInput.focus();
                                return false;
                            }
                        }
                        else if (event.keyCode == 40) {
                            if (!me.isOpened()) {
                                me.showCalendar();
                                me.dateTimeInput.focus();
                                return false;
                            }
                        }
                    }
                });

                this.addHandler(this.calendarContainer, 'cellSelected',
                function (event) {
                    if (me.closeCalendarAfterSelection) {
                        var calendarOldValue = $.data(document.body, "openedJQXCalendarValue");
                        if (event.args.selectionType == 'mouse') {
                            if (me.selectionMode != 'range') {
                                me.hideCalendar('selected');
                            }
                            else {
                                if (me._calendar._clicks == 0) {
                                    me.hideCalendar('selected');
                                }
                            }
                        }
                    }
                });

                this.addHandler(this.calendarContainer, 'cellMouseDown',
                function (event) {
                    if (me.closeCalendarAfterSelection) {
                        if (me._calendar.value) {
                            $.data(document.body, "openedJQXCalendarValue", new $.jqx._jqxDateTimeInput.getDateTime(me._calendar.value.dateTime));
                        }
                    }
                });
            }

            this.addHandler(this.dateTimeInput, 'blur', function (event) {
                if (me.value != null) {
                    me.isEditing = false;
                    me._validateValue();
                    me._updateText();
                    me._raiseEvent(9, event);
                }
                me.inputElement.removeClass(me.toThemeProperty('jqx-fill-state-focus'));
            });

            this.addHandler(this.host, 'focus', function (event) {
                me.focus();
            });

            this.addHandler(this.dateTimeInput, 'focus', function (event) {
                if (me.value != null) {
                    if (me.selectionMode != 'range') {
                        me._oldDT = new Date(me.value.dateTime);
                    }
                    else me._oldDT = me.getRange();

                    var selection = me._selection();
                    me.isEditing = true;
                    me._validateValue();
                    me._updateText();
                    me._setSelectionStart(0);
                    me._selectGroup(-1);
                    me.inputElement.addClass(me.toThemeProperty('jqx-fill-state-focus'));
                }
                else {
                    me._setSelectionStart(0);
                    me._selectGroup(-1);
                    me.inputElement.addClass(me.toThemeProperty('jqx-fill-state-focus'));
                }

                if (event.preventDefault) {
                    event.preventDefault();
                    return false;
                }
            });

            var eventName = 'mousedown';
            if (this.touch) {
                eventName = $.jqx.mobile.getTouchEventName('touchstart');
            }

            this.addHandler(this.calendarButton, eventName,
                function (event) {
                    var calendar = me.container;
                    var isOpen = calendar.css('display') == 'block';
                    if (!me.disabled) {
                        if (!me.isanimating) {
                            if (isOpen) {
                                me.hideCalendar();
                                return false;
                            }
                            else {
                                me.showCalendar();
                                event.preventDefault();
                            }
                        }
                    }
                });

            this.addHandler(this.dateTimeInput, 'mousedown',
            function (event) {
                return me._raiseEvent(2, event)
            });

            this.addHandler(this.dateTimeInput, 'mouseup',
            function (event) {
                return me._raiseEvent(3, event)
            });

            this.addHandler(this.dateTimeInput, 'keydown',
            function (event) {
                return me._raiseEvent(4, event)
            });

            this.addHandler(this.dateTimeInput, 'keyup',
            function (event) {
                return me._raiseEvent(5, event)
            });

            this.addHandler(this.dateTimeInput, 'keypress',
            function (event) {
                return me._raiseEvent(6, event)
            });
        },

        createID: function () {
            var id = Math.random() + '';
            id = id.replace('.', '');
            id = '99' + id;
            id = id / 1;
            return 'dateTimeInput' + id;
        },

        setMaxDate: function (date, refresh) {
            if (date == null)
                return;

            if (date != null && typeof (date) == "string") {
                date = new Date(date);
                if (date == "Invalid Date")
                    return;
            }

            this.maxDate = $.jqx._jqxDateTimeInput.getDateTime(date);
            if (this._calendar != null) {
                this._calendar.setMaxDate(date);
            }
            if (refresh != false) {
                if (this.getDate() > date) {
                    this.setDate(date);
                }
                $.jqx.aria(this, "aria-valuemax", date);
                this._refreshValue();
                this._updateText();
            }
        },

        getMaxDate: function () {
            if (this.maxDate != null && this.maxDate != undefined) {
                return this.maxDate.dateTime;
            }

            return null;
        },

        setMinDate: function (date, refresh) {
            if (date == null)
                return;

            if (date != null && typeof (date) == "string") {
                date = new Date(date);
                if (date == "Invalid Date")
                    return;
            }

            this.minDate = $.jqx._jqxDateTimeInput.getDateTime(date);
            if (this._calendar != null) {
                this._calendar.setMinDate(date);
            }
            if (refresh != false) {
                if (this.getDate() < date) {
                    this.setDate(date);
                }
                $.jqx.aria(this, "aria-valuemin", date);
                this._refreshValue();
                this._updateText();
            }
        },

        getMinDate: function () {
            if (this.minDate != null && this.minDate != undefined) {
                return this.minDate.dateTime;
            }

            return null;
        },

        _applyCulture: function()
        {
            var globalize = false;
            try {
                if (Globalize != undefined) {
                    globalize = true;
                }
            }
            catch (error) {
            }

            try
            {
                if ($.global) {
                    $.global.preferCulture(this.culture);
                    this.localization.calendar = $.global.culture.calendar;
                }
                else if (globalize) {
                    var culture = Globalize.culture(this.culture);
                    this.localization.calendar = culture.calendar;
                }
                this._loadItems();
                if (this._calendar != null) {
                    this._calendar.culture = this.culture;
                    this._calendar.localization = this.localization;
                    this._calendar.render();
                }
            }
            catch (error) {
            }
        },

        propertyMap: function(key)
        {
            if (key == "value") {
                if (this.selectionMode != 'range') {
                    return this.getDate();
                }
                else return this.getRange();
            }
            return null;
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (object.isInitialized == undefined || object.isInitialized == false)
                return;

            if (key == "popupZIndex") {
                object.calendarContainer.css({zIndex: value});
            }

            if (key == "selectionMode") {
                object._calendar.selectionMode = value;
                object.refreshValue();
            }

            if (key == "min") {
                if (typeof (value) == "string") {
                    object.setMinDate(new Date(value));
                }
                else {
                    object.setMinDate(value);
                }
            }
            if (key == "max") {
                if (typeof (value) == "string") {
                    object.setMaxDate(new Date(value));
                }
                else {
                    object.setMaxDate(value);
                }
            }

            if (key == "value") {
                if (value != null && value instanceof Date) {
                    if (isNaN(value.getFullYear()) || isNaN(value.getMonth()) || isNaN(value.getDate())) {
                        this.value = oldvalue;
                        return;
                    }

                    value = $.jqx._jqxDateTimeInput.getDateTime(value);
                }
                else if (value != null && typeof (value) == "string") {
                    var date = new Date(value);
                    if (date != undefined && !isNaN(date)) {
                        this.value = $.jqx._jqxDateTimeInput.getDateTime(date);
                    }
                }
            }

            if (key == 'rtl') {
                object.calendarContainer.jqxCalendar({ rtl: value });
                if (value) {
                    object.dateTimeInput.css('direction', 'rtl');
                    object.dateTimeInput.addClass('jqx-rtl');
                    object.inputElement.css('float', 'right');
                    object.calendarElement.css('float', 'left');
                }
                else {
                    object.dateTimeInput.css('direction', 'ltr');
                    object.dateTimeInput.removeClass('jqx-rtl');
                    object.inputElement.css('float', 'left');
                    object.calendarElement.css('float', 'right');
                }
            }

            if (key == 'todayString' || key == 'clearString') {
                object.calendarContainer.jqxCalendar({ clearString: object.clearString, todayString: object.todayString });
            }

            if (key == 'dayNameFormat') {
                object.calendarContainer.jqxCalendar({ dayNameFormat: value });
            }

            if (key == 'firstDayOfWeek') {
                object.calendarContainer.jqxCalendar({ firstDayOfWeek: value });
            }
            if (key == 'showWeekNumbers') {
                object.calendarContainer.jqxCalendar({ showWeekNumbers: value });
            }

            if (key == 'culture' || key == 'localization') {
                object._applyCulture();
            }
            else if (key == 'formatString') {
                object._loadItems();
            }

            if (key == "theme") {
                if (object.dateTimeInput) {
                    object.host.removeClass();
                    object.host.addClass(object.toThemeProperty('jqx-widget'));

                    object.dateTimeInput.removeClass();
                    object.dateTimeInput.addClass(object.toThemeProperty("jqx-input-content"));
                    object.dateTimeInput.addClass(object.toThemeProperty("jqx-widget-content"));

                    object.inputElement.removeClass();
                    object.inputElement.addClass(object.toThemeProperty("jqx-input"));
                    object.inputElement.addClass(object.toThemeProperty("jqx-widget-content"));
                    object.inputElement.addClass(object.toThemeProperty("jqx-rc-all"));

                    object.calendarButtonContent.removeClass();
                    object.calendarButtonContent.addClass(object.toThemeProperty("jqx-input-button-content"));
                    object.calendarButtonContent.addClass(object.toThemeProperty("jqx-widget-content"));
                    object.calendarButtonHeader.removeClass();
                    object.calendarButtonHeader.addClass(object.toThemeProperty("jqx-input-button-header"));
                    object.calendarButtonHeader.addClass(object.toThemeProperty("jqx-widget-header"));
                    object.calendarButtonInnerHeader.removeClass();
                    object.calendarButtonInnerHeader.addClass(object.toThemeProperty("jqx-input-button-innerHeader"));

                    object.calendarContainer.jqxCalendar({ theme: value });
                }
            }

            if (key == "width" || key == "height") {
                object.refresh();
                return;
            }

            object._setOption(key, value);
            if (key == 'dropDownWidth' || key == 'dropDownHeight') {
                object.calendarContainer.jqxCalendar({ width: object.dropDownWidth, height: object.dropDownHeight });
                object._calendar.render();
                object.container.height(object.calendarContainer.height());
                object.container.width(object.calendarContainer.width());
            }
        },

        clear: function()
        {
            if (this.allowNullDate) {
                if (this.selectionMode != 'range') {
                    this.setDate(null);
                }
                else {
                    this._calendar._clicks = 1
                    this.setRange(null, null);
                }
                this._calendar._clicks = 0
            }
            else {
                if (this.selectionMode != 'range') {
                    this.setDate(me.getMinDate());
                }
                else {
                    this._calendar._clicks = 1
                    this.setRange(me.getMinDate(), me.getMinDate());
                    this._calendar._clicks = 0
                }
            }
            this.hideCalendar();
        },

        today: function () {
            var date = new Date();
            date.setHours(0, 0, 0, 0);
            if (this.selectionMode != 'range') {
                this.setDate(date);
            }
            else {
                this._calendar._clicks = 1
                this.setRange(date, date);
                this._calendar._clicks = 0
            }

            this.hideCalendar();
        },

        setDate: function (date) {
            if (date != null && typeof (date) == "string") {
                date = new Date(date);
                if (date == "Invalid Date")
                    return;
            }

            if (date == null || date == 'null' || date == 'undefined') {
                if (!this.allowNullDate) {
                    date = this.min;
                }
            }

            if (date == "Invalid Date")
                date = null;

            if (date == null || date == 'null' || date == 'undefined') {
                if (this.value != null) {
                    this.value = null;
                    this._calendar.setDate(null);
                    this._refreshValue();
                    if (this.cookies) {
                        if (this.value != null) {
                            $.jqx.cookie.cookie("jqxDateTimeInput" + this.element.id, this.value.dateTime.toString(), this.cookieoptions);
                        }
                    }
                    this._setSelectionStart(0);
                    this._selectGroup(-1);
                    this._raiseEvent('0', date);
                    this._raiseEvent('9', date);
                }
                return;
            }

            if (date < this.getMinDate() || date > this.getMaxDate()) {
                return;
            }

            if (this.value == null) {
                this.value = new $.jqx._jqxDateTimeInput.getDateTime(new Date());
                this.value._setHours(0);
                this.value._setMinutes(0);
                this.value._setSeconds(0);
                this.value._setMilliseconds(0);
            }

            if (date.getFullYear) {
                this.value._setYear(date.getFullYear());
                this.value._setDay(1);
                this.value._setMonth(date.getMonth() + 1);
                this.value._setHours(date.getHours());
                this.value._setMinutes(date.getMinutes());
                this.value._setSeconds(date.getSeconds());
                this.value._setMilliseconds(date.getMilliseconds());
                this.value._setDay(date.getDate());
            }

            this._refreshValue();

            if (this.cookies) {
                if (this.value != null) {
                    $.jqx.cookie.cookie("jqxDateTimeInput" + this.element.id, this.value.dateTime.toString(), this.cookieoptions);
                }
            }
            this._raiseEvent('0', date);
            this._raiseEvent('9', date);
        },

        getDate: function () {
            if (this.value == undefined)
                return null;

            return new Date(this.value.dateTime);
        },

        getText: function()
        {
            return this.dateTimeInput.val();
        },

        setRange: function (from, to) {
            if (from == "Invalid Date") from = null;
            if (to == "Invalid Date") to = null;

            if (from != null && typeof (from) == "string") {
                from = new Date(from);
                if (from == "Invalid Date")
                    return;
            }
            if (to != null && typeof (to) == "string") {
                to = new Date(to);
                if (to == "Invalid Date")
                    return;
            }

            if (from && isNaN(from) && from.toString() == "NaN" && typeof (from) != "string") {
                return;
            }
            if (to && isNaN(to) && to.toString() == "NaN" && typeof (to) != "string") {
                return;
            }

            this._calendar.setRange(from, to);
            var date = from;
            if (date != null && date.getFullYear) {
                if (this.value == null) {
                    this.value = new $.jqx._jqxDateTimeInput.getDateTime(new Date());
                    this.value._setHours(0);
                    this.value._setMinutes(0);
                    this.value._setSeconds(0);
                    this.value._setMilliseconds(0);
                }

                this.value._setYear(date.getFullYear());
                this.value._setMonth(date.getMonth() + 1);
                this.value._setHours(date.getHours());
                this.value._setMinutes(date.getMinutes());
                this.value._setSeconds(date.getSeconds());
                this.value._setMilliseconds(date.getMilliseconds());
                this.value._setDay(date.getDate());
            }
            this._refreshValue();
            if (this.value) {
                this._raiseEvent('0', this.value.dateTime);
            }
            else {
                this._raiseEvent('0', null);
            }
        },

        getRange: function () {
            return this._calendar.getRange();
        },

        _validateValue: function () {
            var needValueUpdate = false;
            for (var i = 0; i < this.items.length; i++) {
                var editValue = this.editors[i].value;
                switch (this.items[i].type) {
                    case 'FORMAT_AMPM':
                        if (editValue < 0) {
                            editValue = 0;
                        }
                        else if (editValue > 1) {
                            editValue = 1;
                        }
                        break;
                    case 'Character':
                        break;
                    case 'Day':
                        if (editValue < 1) {
                            editValue = 1;
                        }
                        else if (editValue > 31) {
                            editValue = 31;
                        }
                        break;
                    case 'FORMAT_hh':
                        if (editValue < 1) {
                            editValue = 1;
                        }
                        else if (editValue > 12) {
                            editValue = 12;
                        }
                        break;
                    case 'FORMAT_HH':
                        if (editValue < 0) {
                            editValue = 0;
                        }
                        else if (editValue > 23) {
                            editValue = 23;
                        }
                        break;
                    case 'Millisecond':
                        if (editValue < 0) {
                            editValue = 0;
                        }
                        else if (editValue > 99) {
                            editValue = 99;
                        }
                        break;
                    case 'Minute':
                        if (editValue < 0) {
                            editValue = 0;
                        }
                        else if (editValue > 59) {
                            editValue = 59;
                        }
                        break;
                    case 'Month':
                        if (editValue < 1) {
                            editValue = 1;
                        }
                        else if (editValue > 12) {
                            editValue = 12;
                        }
                        break;
                    case 'ReadOnly':
                        break;
                    case 'Second':
                        if (editValue < 0) {
                            editValue = 0;
                        }
                        else if (editValue > 59) {
                            editValue = 59;
                        }
                        break;
                    case 'Year':
                        if (editValue < this.minDate.year) {
                            editValue = this.minDate.year;
                        }
                        else if (editValue > this.maxDate.year) {
                            editValue = this.maxDate.year;
                        }
                        break;
                }

                if (this.editors[i].value != editValue) {
                    this.editors[i].value = editValue;
                    needValueUpdate = true;
                }
            }

            this.updateValue();

            if (this.value != null) {
                if (this.value.dateTime > this.maxDate.dateTime) {
                    this._internalSetValue(this.maxDate);
                    this._updateEditorsValue();
                }
                else if (this.value.dateTime < this.minDate.dateTime) {
                    this._internalSetValue(this.minDate);
                    this._updateEditorsValue();
                }
            }
        },

        spinUp: function () {
            var value = this.value;
            if (value == null)
                return;

            if (this.activeEditor != null) {
                var currentEditorIndex = this.editors.indexOf(this.activeEditor);
                if (currentEditorIndex == -1) return;
                if (this.items[currentEditorIndex].type == 'Day') {
                    if (this.value != null) {
                        this.activeEditor.maxValue = this.value._daysInMonth(this.value.year, this.value.month);
                    }
                }

                var positions = this.activeEditor.positions;
                this.activeEditor.increaseValue(this.enableAbsoluteSelection);

                this.activeEditor.positions = positions;
            }

            if (this.isEditing) this.isEditing = false;

            this.updateValue();
            this.isEditing = true;
            this._updateText();

            var index1 = this.editors.indexOf(this.activeEditor);
            if (index1 >= 0) {
                this._selectGroup(index1);
            }
        },

        spinDown: function () {
            var value = this.value;
            if (value == null)
                return;

            if (this.activeEditor != null) {
                var currentEditorIndex = this.editors.indexOf(this.activeEditor);
                if (currentEditorIndex == -1) return;
                if (this.items[currentEditorIndex].type == 'Day') {
                    if (this.value != null) {
                        this.activeEditor.maxValue = this.value._daysInMonth(this.value.year, this.value.month);
                    }
                }

                var positions = this.activeEditor.positions;
                this.activeEditor.decreaseValue(this.enableAbsoluteSelection);
                this.activeEditor.positions = positions;
            }

            if (this.isEditing) this.isEditing = false;

            this.updateValue();
            this.isEditing = true;
            this._updateText();

            var index1 = this.editors.indexOf(this.activeEditor);
            if (index1 >= 0) {
                this._selectGroup(index1);
            }
        },

        _passKeyToCalendar: function (event) {
            if (event.keyCode == 13 || event.keyCode == 9) {
                this.hideCalendar('selected');
                return true;
            }
            else if (event.keyCode == 27) {
                var calendar = this.calendarContainer;
                var calendarInstance = this._calendar;
                var closeAfterSelection = this.closeCalendarAfterSelection;
                this.closeCalendarAfterSelection = false;
                calendarInstance.setDate(this.value.dateTime);
                this.closeCalendarAfterSelection = closeAfterSelection;
                this.hideCalendar();
            }

            var closeAfterSelection = this.closeCalendarAfterSelection;
            this.closeCalendarAfterSelection = false;
            var result = this._calendar._handleKey(event);
            this.closeCalendarAfterSelection = closeAfterSelection;
            return result;
        },

        handleCalendarKey: function (event, me) {
            var $target = $(event.target);
            var openedCalendar = $.data(document.body, "openedJQXCalendar" + this.id);
            if (openedCalendar != null) {
                if (openedCalendar.length > 0) {
                    var result = me._passKeyToCalendar(event);
                    return result;
                }
            }

            return true;
        },

        _findPos: function (obj) {
            if (obj == null)
                return;

            while (obj && (obj.type == 'hidden' || obj.nodeType != 1 || $.expr.filters.hidden(obj))) {
                obj = obj['nextSibling'];
            }
            var position = $(obj).coord(true);
            return [position.left, position.top];
        },

        testOffset: function (element, offset, inputHeight) {
            var dpWidth = element.outerWidth();
            var dpHeight = element.outerHeight();
            var viewWidth = $(window).width() + $(window).scrollLeft();
            var viewHeight = $(window).height() + $(window).scrollTop();
            if (offset.left + dpWidth > viewWidth) {
                if (dpWidth > this.host.width()) {
                    var hostLeft = this.host.coord().left;
                    var hOffset = dpWidth - this.host.width();
                    offset.left = hostLeft - hOffset + 2;
                }
            }
            if (offset.left < 0) {
                offset.left = parseInt(this.host.coord().left) + 'px'
            }

            offset.top -= Math.min(offset.top, (offset.top + dpHeight > viewHeight && viewHeight > dpHeight) ?
                Math.abs(dpHeight + inputHeight + 23) : 0);

            return offset;
        },

        open: function () {
            this.showCalendar();
        },

        close: function (reason) {
            this.hideCalendar();
        },

        _getBodyOffset: function () {
            var top = 0;
            var left = 0;
            if ($('body').css('border-top-width') != '0px') {
                top = parseInt($('body').css('border-top-width'));
                if (isNaN(top)) top = 0;
            }
            if ($('body').css('border-left-width') != '0px') {
                left = parseInt($('body').css('border-left-width'));
                if (isNaN(left)) left = 0;
            }
            return { left: left, top: top };
        },

        showCalendar: function () {
            var calendar = this.calendarContainer;
            var calendarInstance = this._calendar;
            $.jqx.aria(this, "aria-expanded", true);
        
            if (this.value != null) {
                if (this.selectionMode != 'range') {
                    this._oldDT = new Date(this.value.dateTime);
                }
                else
                {
                    this._oldDT = this.getRange();
                }
            }
            else {
                this._oldDT = null;
            }
            if (!calendarInstance.canRender)
            {
                calendarInstance.canRender = true;
                calendarInstance.render();
            }
            var container = this.container;
            var self = this;
            var scrollPosition = $(window).scrollTop();
            var scrollLeftPosition = $(window).scrollLeft();
            var top = parseInt(this._findPos(this.inputElement[0])[1]) + parseInt(this.inputElement.outerHeight()) - 1 + 'px';
            var left, leftPos = parseInt(Math.round(this.host.coord(true).left));
            left = leftPos + 'px';

            var isMobileBrowser = $.jqx.mobile.isSafariMobileBrowser() || $.jqx.mobile.isWindowsPhone();
            var hasTransform = $.jqx.utilities.hasTransform(this.host);

            if (hasTransform || (isMobileBrowser != null && isMobileBrowser)) {
                left = $.jqx.mobile.getLeftPos(this.element);
                top = $.jqx.mobile.getTopPos(this.element) + parseInt(this.host.outerHeight());
                if ($('body').css('border-top-width') != '0px') {
                    top = parseInt(top) - this._getBodyOffset().top + 'px';
                }
                if ($('body').css('border-left-width') != '0px') {
                    left = parseInt(left) - this._getBodyOffset().left + 'px';
                }
            }

            this.container.css('left', left);
            this.container.css('top', top);

            var closeAfterSelection = this.closeCalendarAfterSelection;
            this.closeCalendarAfterSelection = false;
            this.isEditing = false;
            if (self.selectionMode == 'default') {
                this._validateValue();
                this._updateText();
                var value = this.value != null ? this.value.dateTime : new Date();
                calendarInstance.setDate(value);
            }
            this.closeCalendarAfterSelection = closeAfterSelection;

            var positionChanged = false;

            if (this.dropDownHorizontalAlignment == 'right' || this.rtl) {
                var containerWidth = this.container.outerWidth();
                var containerLeftOffset = Math.abs(containerWidth - this.host.outerWidth() + 2);
                if (!this.rtl) containerLeftOffset -= 2;

                if (containerWidth > this.host.width()) {
                    var offset = this.rtl ? 23 : 2;
                    this.container.css('left', offset + parseInt(Math.round(leftPos)) - containerLeftOffset + "px");
                }
                else this.container.css('left', 25 + parseInt(Math.round(leftPos)) + containerLeftOffset + "px");
            }

            if (this.enableBrowserBoundsDetection) {
                var newOffset = this.testOffset(calendar, { left: parseInt(this.container.css('left')), top: parseInt(top) }, parseInt(this.host.outerHeight()));
                if (parseInt(this.container.css('top')) != newOffset.top) {
                    positionChanged = true;
                    calendar.css('top', 23);
                }
                else calendar.css('top', 0);

                this.container.css('top', newOffset.top);
                if (parseInt(this.container.css('left')) != newOffset.left) {
                    this.container.css('left', newOffset.left);
                }
            }

            this._raiseEvent(7, calendar);

            if (this.animationType != 'none') {
                this.container.css('display', 'block');
                var height = parseInt(calendar.outerHeight());
                calendar.stop();

                this.isanimating = true;
                this.opening = true;
                if (this.animationType == 'fade') {
                    calendar.css('margin-top', 0);
                    calendar.css('opacity', 0);
                    calendar.animate({ 'opacity': 1 }, this.openDelay, function () {
                        self.isanimating = false;
                        self.opening = false;
                        $.data(document.body, "openedJQXCalendar" + self.id, calendar);
                        self.calendarContainer.focus();
                    });
                }
                else {
                    calendar.css('opacity', 1);
                    if (positionChanged) {
                        calendar.css('margin-top', height);
                    }
                    else {
                        calendar.css('margin-top', -height);
                    }
                    calendar.animate({ 'margin-top': 0 }, this.openDelay, function () {
                        self.isanimating = false;
                        self.opening = false;
                        $.data(document.body, "openedJQXCalendar" + self.id, calendar);
                        self.calendarContainer.focus();
                    });
                }
            }
            else {
                calendar.stop();
                self.isanimating = false;
                self.opening = false;
                calendar.css('opacity', 1);
                calendar.css('margin-top', 0);
                this.container.css('display', 'block');
                $.data(document.body, "openedJQXCalendar" + self.id, calendar);
                this.calendarContainer.focus();
            }

            if (this.value == null) {
                if (this._calendar && this._calendar._getSelectedCell()) {
                    this._calendar._getSelectedCell().isSelected = false;
                }
            }
     //       this._calendar._clicks = 0;
        },

        hideCalendar: function (reason) {
            var calendar = this.calendarContainer;
            var container = this.container;
            var self = this;
            $.jqx.aria(this, "aria-expanded", false);

            $.data(document.body, "openedJQXCalendar" + this.id, null);
            if (this.animationType != 'none') {
                var height = calendar.outerHeight();
                calendar.css('margin-top', 0);
                this.isanimating = true;
                var animationValue = -height;
                if (parseInt(this.container.coord().top) < parseInt(this.host.coord().top)) {
                    animationValue = height;
                }
                if (this.animationType == 'fade') {
                    calendar.animate({ 'opacity': 0 }, this.closeDelay, function () { container.css('display', 'none'); self.isanimating = false; });
                }
                else {
                    calendar.animate({ 'margin-top': animationValue }, this.closeDelay, function () { container.css('display', 'none'); self.isanimating = false; });
                }
            }
            else {
                container.css('display', 'none');
            }

            if (reason != undefined) {
                this._updateSelectedDate();
            }
            
            this._raiseEvent(8, calendar);
        },

        _updateSelectedDate: function () {
            var value = this.value;
            if (value == null) {
                value = new $.jqx._jqxDateTimeInput.getDateTime(new Date());
                value._setHours(0);
                value._setMinutes(0);
                value._setSeconds(0);
                value._setMilliseconds(0);
            }

            var hour = value.hour;
            var minute = value.minute;
            var second = value.second;
            var milisecond = value.millisecond;
            if (this.selectionMode == 'range' && this._calendar.getRange().from == null) {
                this.setDate(null);
                return;
            }

            var date = new $.jqx._jqxDateTimeInput.getDateTime(this._calendar.value.dateTime);

            date._setHours(hour);
            date._setMinutes(minute);
            date._setSeconds(second);
            date._setMilliseconds(milisecond);
            this.setDate(date.dateTime);
        },

        _closeOpenedCalendar: function (event) {
            var $target = $(event.target);
            var openedCalendar = $.data(document.body, "openedJQXCalendar" + event.data.me.id);
            var isCalendar = false;
            $.each($target.parents(), function () {
                if (this.className && this.className.indexOf) {
                    if (this.className.indexOf('jqx-calendar') != -1) {
                        isCalendar = true;
                        return false;
                    }
                    if (this.className.indexOf('jqx-input') != -1) {
                        isCalendar = true;
                        return false;
                    }
                }
            });

            if ($(event.target).ischildof(event.data.me.host)) {
                return true;
            }

            if (event.target != null && (event.target.tagName == "B" || event.target.tagName == 'b')) {
                var hostOffset = event.data.me.host.coord();
                var hostWidth = event.data.me.host.width();
                var hostHeight = event.data.me.host.height();
                var top = parseInt(hostOffset.top);
                var left = parseInt(hostOffset.left);

                if (top <= event.pageY && event.pageY <= top + hostHeight) {
                    if (left <= event.pageX && event.pageX <= left + hostWidth) {
                        return true;
                    }
                }
            }

            if (openedCalendar != null && !isCalendar) {
                if (openedCalendar.length > 0) {
                    var calendarID = openedCalendar[0].id.toString();
                    var inputID = calendarID.toString().substring(13);
                    var datetimeinput = $(document).find("#" + inputID);
                    event.data.me.hideCalendar();
                    $.data(document.body, "openedJQXCalendar" + event.data.me.id, null);
                }
            }
        },

        _loadItems: function () {
            if (this.value != null) {
                this.items = new Array();
                var expandedMask = this._getFormatValue(this.formatString);
                this.items = this._parseFormatValue(expandedMask);
                this.editors = new Array();
                for (var i = 0; i < this.items.length; i++) {
                    var editor = this.items[i].getDateTimeEditorByItemType(this.value, this);
                    this.editors[i] = editor;
                }
            }

            this._updateEditorsValue();
            this._updateText();
        },

        _updateText: function () {
            var text = "";
            if (this.items.length == 0 && this.value != null) {
                this._loadItems();
            }

            if (this.value != null) {
                if (this.items.length >= 1) {
                    text = this.format(this.value, 0, this.items.length);
                }


                var oldText = this.dateTimeInput.val();
                if (oldText != text) {
                    this._raiseEvent(1, this.value);
                }
            }

            if (this.selectionMode == 'range') {
                var range = this.getRange();
                fromText = this.format(this.value, 0, this.items.length);
                if (range.to) {
                    var from = $.jqx._jqxDateTimeInput.getDateTime(range.from);
                    fromText = this.format(from, 0, this.items.length);
                    var to = $.jqx._jqxDateTimeInput.getDateTime(range.to);
                    toText = this.format(to, 0, this.items.length);
                    var text = fromText + " - " + toText;
                    if (text == ' - ') text = "";
                }
                else {
                    text = "";
                    this.calendarButtonContent.html("<div style='line-height: 16px; background: transparent; margin: 0; border: 0; padding: 0px; text-align: center; vertical-align: middle;'>" + "<b style='border: 0; padding: 0px; margin: 0px; background: transparent;'>" + '' + "</b>" + "</div>");
                }
            }

            this.dateTimeInput.val(text)
        },


        format: function (value, startFormatIndex, endFormatIndex) {
            var result = "";
            for (var i = startFormatIndex; i < endFormatIndex; ++i) {
                var parsedValue = this.items[i].dateParser(value, this);

                if (this.isEditing && this.items[i].type != 'ReadOnly') {
                    if (this.selectionMode != 'range') {
                        var isReadOnlyDay = this.items[i].type == 'Day' && this.items[i].format.length > 2;
                        if (this.items[i].type == 'FORMAT_AMPM') {
                            isReadOnlyDay = true;
                            if (this.editors[i].value == 0)
                                parsedValue = this.editors[i].amString;
                            else parsedValue = this.editors[i].pmString;
                        }

                        if (!isReadOnlyDay) {
                            parsedValue = this.items[i].dateParserInEditMode(new Number(this.editors[i].value), "d" + this.editors[i].maxEditPositions, this);
                            while (parsedValue.length < this.editors[i].maxEditPositions) {
                                parsedValue = '0' + parsedValue;
                            }
                        }
                    }
                }
                result += parsedValue;
            }
            return result;
        },

        _getFormatValueGroupLength: function (item) {
            for (i = 1; i < item.toString().length; ++i) {
                if (item.substring(i, i + 1) != item.substring(0, 1))
                    return i;
            }
            return item.length;
        },

        _parseFormatValue: function (value) {
            var myResult = new Array();
            var currentValue = value.toString();
            var i = 0;
            while (currentValue.length > 0) {
                var formatItemLength = this._getFormatValueGroupLength(currentValue);
                var myItem = null;

                switch (currentValue.substring(0, 1)) {
                    case ':':
                    case '/':
                        formatItemLength = 1;
                        myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, 1), 'ReadOnly', this.culture);
                        break;
                    case '"':
                    case '\'':
                        var closingQuotePosition = currentValue.indexOf(currentValue[0], 1);
                        myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(1, 1 + Math.max(1, closingQuotePosition - 1)), 'ReadOnly', this.culture);
                        formatItemLength = Math.max(1, closingQuotePosition + 1);
                        break;
                    case '\\':
                        if (currentValue.length >= 2) {
                            myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(1, 1), 'ReadOnly', this.culture);
                            formatItemLength = 2;
                        }
                        break;
                    case 'd':
                    case 'D':
                        if (formatItemLength > 2) {
                            myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, formatItemLength), 'Day', this.culture);
                        }
                        else {
                            myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, formatItemLength), 'Day', this.culture);

                        }
                        break;
                    case 'f':
                    case 'F':
                        if (formatItemLength > 7) {
                            formatItemLength = 7;
                        }
                        if (formatItemLength > 3) {
                            myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, formatItemLength), 'ReadOnly', this.culture);
                        }
                        else {
                            myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, formatItemLength), 'Millisecond', this.culture);
                        }
                        break;
                    case 'g':
                        myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, formatItemLength), 'ReadOnly', this.culture);
                        break;
                    case 'h':
                        myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, formatItemLength), 'FORMAT_hh', this.culture);
                        break;
                    case 'H':
                        myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, formatItemLength), 'FORMAT_HH', this.culture);
                        break;
                    case 'm':
                        myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, formatItemLength), 'Minute', this.culture);
                        break;
                    case 'M':
                        if (formatItemLength > 4)
                            formatItemLength = 4;
                        myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, formatItemLength), 'Month', this.culture);
                        break;
                    case 's':
                    case 'S':
                        myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, formatItemLength), 'Second', this.culture);
                        break;
                    case 't':
                    case 'T':
                        myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, formatItemLength), 'FORMAT_AMPM', this.culture);
                        break;
                    case 'y':
                    case 'Y':
                        if (formatItemLength > 1) {
                            myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, formatItemLength), 'Year', this.culture);
                        }
                        else {
                            formatItemLength = 1;
                            myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, 1), dateTimeFormatInfo, 'ReadOnly', this.culture);
                        }
                        break;
                    case 'z':
                        myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, formatItemLength), 'ReadOnly', this.culture);
                        break;

                    default:
                        formatItemLength = 1;
                        myItem = $.jqx._jqxDateTimeInput.DateTimeFormatItem._create(currentValue.substring(0, 1), 'ReadOnly', this.culture);
                        break;
                }

                myResult[i] = $.extend(true, {}, myItem);
                currentValue = currentValue.substring(formatItemLength);
                i++;
            }

            return myResult;
        },

        _getFormatValue: function (format) {
            if (format == null || format.length == 0)
                format = "d";

            if (format.length == 1) {
                switch (format.substring(0, 1)) {
                    case "d":
                        return this.localization.calendar.patterns.d;
                    case "D":
                        return this.localization.calendar.patterns.D;
                    case "t":
                        return this.localization.calendar.patterns.t;
                    case "T":
                        return this.localization.calendar.patterns.T;
                    case "f":
                        return this.localization.calendar.patterns.f;
                    case "F":
                        return this.localization.calendar.patterns.F;
                    case "M":
                        return this.localization.calendar.patterns.M;
                    case "Y":
                        return this.localization.calendar.patterns.Y;
                    case "S":
                        return this.localization.calendar.patterns.S;
                }
            }
            if (format.length == 2 && format.substring(0, 1) == '%')
                format = format.substring(1);
            return format;
        },

        _updateEditorsValue: function () {
            var value = this.value;

            if (value == null)
                return;

            var year = value.year;
            var day = value.day;
            var hour = value.hour;
            var millisecond = value.millisecond;
            var second = value.second;
            var minute = value.minute;
            var month = value.month;

            if (this.items == null)
                return;

            for (var i = 0; i < this.items.length; i++) {
                switch (this.items[i].type) {
                    case 'FORMAT_AMPM':
                        var initialValue = hour % 12;
                        if (initialValue == 0)
                            initialValue = 12;

                        if (hour >= 0 && hour < 12) {
                            this.editors[i].value = 0;
                        }
                        else {
                            this.editors[i].value = 1;
                        }
                        break;
                    case 'Day':
                        this.editors[i].value = day;
                        break;
                    case 'FORMAT_hh':
                        var initialValue = hour % 12;
                        if (initialValue == 0)
                            initialValue = 12;

                        this.editors[i].value = initialValue;
                        break;
                    case 'FORMAT_HH':
                        this.editors[i].value = hour;
                        break;
                    case 'Millisecond':
                        this.editors[i].value = millisecond;
                        break;
                    case 'Minute':
                        this.editors[i].value = minute;
                        break;
                    case 'Month':
                        this.editors[i].value = month;
                        break;
                    case 'Second':
                        this.editors[i].value = second;
                        break;
                    case 'Year':
                        this.editors[i].value = year;
                        break;
                }
            }
        },


        updateValue: function () {
            if (this.isEditing)
                return;

            var dateTime = 0;
            var year = 1;
            var day = 1;
            var hour = 0;
            var milisecond = 0;
            var second = 0;
            var minute = 0;
            var month = 1;
            var amPmOffset = 0;
            var hasYear = false;
            var hasMonth = false;
            var hasDay = false;

            var dayEditors = new Array();
            var amPmEditor = null;

            var k = 0;
            for (var i = 0; i < this.items.length; i++) {
                switch (this.items[i].type) {
                    case 'FORMAT_AMPM':
                        amPmOffset = this.editors[i].value;
                        amPmEditor = this.editors[i];
                        break;
                    case 'Character':
                        break;
                    case 'Day':
                        if (this.items[i].format.length < 4) {
                            day = this.editors[i].value;
                            dayEditors[k++] = this.editors[i];
                            if (day == 0)
                                day = 1;

                            hasDay = true;
                        }
                        break;
                    case 'FORMAT_hh':
                        var hoursEditor = this.editors[i];
                        hour = hoursEditor.value;
                        break;
                    case 'FORMAT_HH':
                        hour = this.editors[i].value;
                        break;
                    case 'Millisecond':
                        milisecond = this.editors[i].value;
                        break;
                    case 'Minute':
                        minute = this.editors[i].value;
                        break;
                    case 'Month':
                        month = this.editors[i].value;
                        hasMonth = true;
                        if (month == 0)
                            month = 1; break;
                    case 'ReadOnly':
                        break;
                    case 'Second':
                        second = this.editors[i].value;
                        break;
                    case 'Year':
                        hasYear = true;
                        year = this.editors[i].value;

                        var yearFormatValue = this.editors[i].getDateTimeItem().format;
                        if (yearFormatValue.length < 3) {
                            var yearString = "1900";
                            if (yearString.Length == 4) {
                                var baseYearString = "" + yearString[0] + yearString[1];
                                var baseYear;
                                baseYear = parseInt(baseYearString);
                                year = year + (baseYear * 100);
                            }
                        }

                        if (year == 0)
                            year = 1;
                        break;
                }
            }

            var oldDate = this.value != null ? new Date(this.value.dateTime) : null;

            if (year > 0 && month > 0 && day > 0 && minute >= 0 && hour >= 0 && second >= 0 && milisecond >= 0) {
                var val = this.value;
                if (val != null) {
                    if (!hasYear) {
                        year = val.year;
                    }

                    if (!hasMonth) {
                        month = val.month;
                    }

                    if (!hasDay) {
                        day = val.day;
                    }
                }

                try {
                    if (month > 12) month = 12;
                    if (month < 1) month = 1;
                    if (val._daysInMonth(year, month) <= day) {
                        day = val._daysInMonth(year, month);
                        if (dayEditors != null && dayEditors.length > 0) {
                            for (i = 0; i < dayEditors.length; i++) {
                                dayEditors[i].value = day;
                            }
                        }
                    }

                    if (amPmEditor != null) {
                        if (amPmEditor.value == 0) {
                            if (hour >= 12) {
                                hour -= 12;
                            }
                        }
                        else {
                            if (hour + 12 < 24) {
                                hour += 12;
                            }
                        }
                    }

                    this.value._setYear(parseInt(year));
                    this.value._setDay(day);
                    this.value._setMonth(month);
                    this.value._setHours(hour);
                    this.value._setMinutes(minute);
                    this.value._setSeconds(second);
                    this.value._setMilliseconds(milisecond);
                }
                catch (err) {
                    this.value = val;
                }

                if (oldDate != null) {
                    var areEqual = this.value.dateTime.getFullYear() == oldDate.getFullYear() && this.value.dateTime.getDate() == oldDate.getDate() && this.value.dateTime.getMonth() == oldDate.getMonth() && this.value.dateTime.getHours() == oldDate.getHours() && this.value.dateTime.getMinutes() == oldDate.getMinutes() && this.value.dateTime.getSeconds() == oldDate.getSeconds();
                    if (!areEqual) {
                        this._raiseEvent('0', this.value.dateTime);
                        if (this.cookies) {
                            if (this.value != null) {
                                $.jqx.cookie.cookie("jqxDateTimeInput" + this.element.id, this.value.dateTime.toString(), this.cookieoptions);
                            }
                        }
                    }

                    this.calendarButtonContent.html("<div style='line-height: 16px; background: transparent; margin: 0; border: 0; padding: 0px; text-align: center; vertical-align: middle;'>" + "<b style='border: 0; padding: 0px; margin: 0px; background: transparent;'>" + this.value.day + "</b>" + "</div>");
                }
                else {
                    this.calendarButtonContent.html("<div style='line-height: 16px; background: transparent; margin: 0; border: 0; padding: 0px; text-align: center; vertical-align: middle;'>" + "<b style='border: 0; padding: 0px; margin: 0px; background: transparent;'>" + '' + "</b>" + "</div>");
                }
            }

            var editorIndex = this.editors.indexOf(this.activeEditor);
            var currentItem = this.items[editorIndex];
        },

        _internalSetValue: function (date) {
            this.value._setYear(parseInt(date.year));
            this.value._setDay(date.day);
            this.value._setMonth(date.month);
            this.value._setHours(date.hour);
            this.value._setMinutes(date.minute);
            this.value._setSeconds(date.second);
            this.value._setMilliseconds(date.milisecond);
        },

        _raiseEvent: function (id, arg) {
            var evt = this.events[id];
            var args = {};
            args.owner = this;
            if (arg == null) {
                arg = {};
            }
            var key = arg.charCode ? arg.charCode : arg.keyCode ? arg.keyCode : 0;
            var result = true;
            var isreadOnly = this.readonly;
            var event = new jQuery.Event(evt);
            event.owner = this;
            event.args = args;
            event.args.date = this.getDate();
            this.element.value = this.dateTimeInput.val();
            if (id == 9 && this.selectionMode != 'range') {
                var date = event.args.date;
                if (this._oldDT) {
                    if (date != null) {
                        if (!(date.getFullYear() != this._oldDT.getFullYear() || date.getMonth() != this._oldDT.getMonth() || date.getDate() != this._oldDT.getDate() || date.getHours() != this._oldDT.getHours() || date.getMinutes() != this._oldDT.getMinutes() || date.getSeconds() != this._oldDT.getSeconds())) {
                            return true;
                        }
                    }

                    $.jqx.aria(this, "aria-valuenow", this.getDate());
                    $.jqx.aria(this, "aria-valuetext", this.getText());
                    if (this.getDate() != null) {
                        $.jqx.aria(this, "aria-label", "Current focused date is " + this.getDate().toLocaleString());
                    }
                    else {
                        $.jqx.aria(this, "aria-label", "Current focused date is Null");
                    }
                }
            }
            if (this.selectionMode == 'range') {
                event.args.date = this.getRange();
                if (this._oldDT) {
                    var date = event.args.date.from;
                    if (id == 9) {
                        var from = false;
                        var to = false;
                        var oldDate = this._oldDT.from;
                        if (date != null && oldDate) {
                            if (!(date.getFullYear() != oldDate.getFullYear() || date.getMonth() != oldDate.getMonth() || date.getDate() != oldDate.getDate() || date.getHours() != oldDate.getHours() || date.getMinutes() != oldDate.getMinutes() || date.getSeconds() != oldDate.getSeconds())) {
                                from = true;
                            }
                        }
                        var date = event.args.date.to;
                        if (date != null) {
                            oldDate = this._oldDT.to;
                            if (oldDate) {
                                if (!(date.getFullYear() != oldDate.getFullYear() || date.getMonth() != oldDate.getMonth() || date.getDate() != oldDate.getDate() || date.getHours() != oldDate.getHours() || date.getMinutes() != oldDate.getMinutes() || date.getSeconds() != oldDate.getSeconds())) {
                                    to = true;
                                }
                            }
                        }
                        if (from && to) {
                            return true;
                        }

                        var from = event.args.date.from;
                        if (from == null) from = "";
                        else from = from.toString();
                        var to = event.args.date.to;
                        if (to == null) to = "";
                        else to = to.toString();

                        $.jqx.aria(this, "aria-valuenow", from + "-" + to);
                        $.jqx.aria(this, "aria-valuetext", this.getText());
                        if (from && to) {
                            $.jqx.aria(this, "aria-label", "Current focused range is " + from.toLocaleString() + "-" + to.toLocaleString());
                        }
                    }
                }
            }

            if (this.host.css('display') == 'none')
                return true;

            if (id != 2 && id != 3) {
                result = this.host.trigger(event);
            }
            var me = this;

            if (!isreadOnly) {
                if (id == 2 && !this.disabled) {
                    setTimeout(function () {
                        me.isEditing = true;
                        me._selectGroup(-1);
                    }, 25);
                }
            }


            if (id == 4) {
                if (isreadOnly || this.disabled) {
                    if (key == 8 || key == 46) {
                        this.isEditing = false;
                        if (this.allowKeyboardDelete) {
                            if (this.allowNullDate) {
                                this.setDate(null);
                            }
                            else {
                                if (this.selectionMode != 'range') {
                                    this.setDate(this.getMinDate());
                                }
                                else {
                                    this.setRange(this.getMinDate(), this.getMinDate());
                                }
                            }
                        }
                    }
                    if (key == 9)
                        return true;

                    return false;
                }

                result = this._handleKeyDown(arg, key);
            }

            else if (id == 5) {
                if (key == 9)
                    return true;

                if (isreadOnly || this.disabled) {
                    return false;
                }


            }
            else if (id == 6) {
                if (key == 9)
                    return true;

                if (isreadOnly || this.disabled) {
                    return false;
                }

                result = this._handleKeyPress(arg, key)
            }

            return result;
        },

        _doLeftKey: function () {
            if (this.activeEditor != null) {
                if (!this.isEditing) this.isEditing = true;

                var lastEditor = this.activeEditor;
                var newEditor = false;
                var index3 = this.editors.indexOf(this.activeEditor);
                var tmpIndex3 = index3;

                if (this.enableAbsoluteSelection) {
                    if (index3 >= 0 && this.activeEditor.positions > 0) {
                        this.activeEditor.positions--;
                        this._selectGroup(index3);
                        return;
                    }
                }

                while (index3 > 0) {
                    this.activeEditor = this.editors[--index3];
                    this._selectGroup(index3);
                    if (this.items[index3].type != 'ReadOnly') {
                        newEditor = true;
                        break;
                    }
                }
                if (!newEditor) {
                    if (tmpIndex3 >= 0) {
                        this.activeEditor = this.editors[tmpIndex3];
                    }
                }
                if (this.activeEditor != null && lastEditor != this.activeEditor) {
                    if (this.items[index3].type != 'ReadOnly') {
                        if (this.enableAbsoluteSelection) {
                            this.activeEditor.positions = this.activeEditor.maxEditPositions - 1;
                        }
                        else {
                            this.activeEditor.positions = 0;
                        }
                    }
                }

                if (this.activeEditor != lastEditor) {
                    this._validateValue();
                    this._updateText();
                    this._selectGroup(this.editors.indexOf(this.activeEditor));
                    return true;
                }
                else return false;
            }
        },

        _doRightKey: function () {
            if (this.activeEditor != null) {
                if (!this.isEditing) this.isEditing = true;

                var lastEditor = this.activeEditor;
                var newEditor = false;
                var index4 = this.editors.indexOf(this.activeEditor);
                var tmpIndex3 = index4;

                if (this.enableAbsoluteSelection) {
                    if (index4 >= 0 && this.activeEditor.positions < this.activeEditor.maxEditPositions - 1) {
                        this.activeEditor.positions++;
                        this._selectGroup(index4);
                        return;
                    }
                }

                while (index4 <= this.editors.length - 2) {
                    this.activeEditor = this.editors[++index4];
                    this._selectGroup(index4);
                    if (this.items[index4].type != 'ReadOnly') {
                        if (this.items[index4].type == 'Day' && this.items[index4].format.length > 2)
                            break;

                        newEditor = true;
                        break;
                    }
                }
                if (!newEditor) {
                    if (tmpIndex3 >= 0) {
                        this.activeEditor = this.editors[tmpIndex3];
                    }
                }
                if (this.activeEditor != null && this.activeEditor != lastEditor) {
                    if (this.items[index4].type != 'ReadOnly') {
                        this.activeEditor.positions = 0;
                    }
                }

                if (this.activeEditor != lastEditor) {
                    this._validateValue();
                    this._updateText();
                    this._selectGroup(this.editors.indexOf(this.activeEditor));
                    return true;
                }
                else return false;
            }
        },


        _saveSelectedText: function () {
            var selection = this._selection();
            var text = "";
            var allText = this.dateTimeInput.val();
            if (selection.start > 0 || selection.length > 0) {
                for (i = selection.start; i < selection.end; i++) {
                    text += allText[i];
                }
            }
            window.clipboardData.setData("Text", text);
            return text;
        },

        _selectWithAdvancePattern: function () {
            var editorIndex = this.editors.indexOf(this.activeEditor);
            var canAdvance = false;
            if (this.items[editorIndex].type != 'ReadOnly') {
                canAdvance = true;
            }

            if (!canAdvance)
                return;

            var numericEditor = this.activeEditor;

            if (numericEditor != null) {
                var canSelectRight = numericEditor.positions == numericEditor.maxEditPositions;
                if (canSelectRight) {
                    this.editorText = "";
                    var editValue = numericEditor.value;
                    var needValueUpdate = false;

                    switch (this.items[editorIndex].type) {
                        case 'FORMAT_AMPM':
                            if (editValue < 0) {
                                editValue = 0;
                            }
                            else if (editValue > 1) {
                                editValue = 1;
                            }
                            break;
                        case 'Character':
                            break;
                        case 'Day':
                            if (editValue < 1) {
                                editValue = 1;
                            }
                            else if (editValue > 31) {
                                editValue = 31;
                            }
                            break;
                        case 'FORMAT_hh':
                            if (editValue < 1) {
                                editValue = 1;
                            }
                            else if (editValue > 12) {
                                editValue = 12;
                            }
                            break;
                        case 'FORMAT_HH':
                            if (editValue < 0) {
                                editValue = 0;
                            }
                            else if (editValue > 23) {
                                editValue = 23;
                            }
                            break;
                        case 'Millisecond':
                            if (editValue < 0) {
                                editValue = 0;
                            }
                            else if (editValue > 99) {
                                editValue = 99;
                            }
                            break;
                        case 'Minute':
                            if (editValue < 0) {
                                editValue = 0;
                            }
                            else if (editValue > 59) {
                                editValue = 59;
                            }
                            break;
                        case 'Month':
                            if (editValue < 1) {
                                editValue = 1;
                            }
                            else if (editValue > 12) {
                                editValue = 12;
                            }
                            break;
                        case 'ReadOnly':
                            break;
                        case 'Second':
                            if (editValue < 0) {
                                editValue = 0;
                            }
                            else if (editValue > 59) {
                                editValue = 59;
                            }
                            break;
                        case 'Year':
                            if (editValue < this.minDate.year) {
                                editValue = this.minDate.year;
                            }
                            else if (editValue > this.maxDate.year) {
                                editValue = this.maxDate.year;
                            }
                            break;
                    }

                    if (numericEditor.value != editValue) {
                        needValueUpdate = true;
                    }

                    if (!needValueUpdate) {
                        this.isEditing = false;
                        this._validateValue();
                        this._updateText();
                        this.isEditing = true;
                        this._doRightKey();
                        return true;
                    }

                    return false;
                }
            }
        },


        _handleKeyPress: function (e, key) {
            var selection = this._selection();
            var rootElement = this;
            if ((e.ctrlKey && key == 97 /* firefox */) || (e.ctrlKey && key == 65) /* opera */) {
                return true;
            }

            if (key == 8) {
                if (selection.start > 0) {
                    rootElement._setSelectionStart(selection.start);
                }
                return false;
            }

            if (key == 46) {
                if (selection.start < this.items.length) {
                    rootElement._setSelectionStart(selection.start);
                }

                return false;
            }

            if (selection.start >= 0) {
                var letter = String.fromCharCode(key);
                var digit = parseInt(letter);
                if (!isNaN(digit)) {
                    if (this.container.css('display') == 'block') {
                        this.hideCalendar();
                    }

                    this.updateValue();
                    this._updateText();
                    var inserted = false;
                    var activeItem = this.editors.indexOf(this.activeEditor);
                    var dateTimeEditor = null;
                    this.isEditing = true;
                    if (activeItem.type != "ReadOnly") {
                        dateTimeEditor = this.activeEditor;
                    }

                    if (dateTimeEditor != null && dateTimeEditor.positions == 0) {
                        this.editorText = "";
                    }

                    if (this.activeEditor == null) {
                        this.activeEditor = this.editors[0];
                    }
                    if (this.activeEditor == null) return false;
                    this.activeEditor.insert(letter);
                    if (dateTimeEditor != null && this.editorText.length >= dateTimeEditor.maxEditPositions) {
                        this.editorText = "";
                    }

                    this.editorText += letter;
                    var advanced = this._selectWithAdvancePattern();

                    if (this.activeEditor.positions == this.activeEditor.maxEditPositions) {
                        var lastEditorIndex = this._getLastEditableEditorIndex();
                        if (this.editors.indexOf(this.activeEditor) == lastEditorIndex && advanced && this.enableAbsoluteSelection) {
                            this.activeEditor.positions = this.activeEditor.maxEditPositions - 1;
                        }
                        else {
                            this.activeEditor.positions = 0;
                        }
                    }

                    inserted = true;

                    this.updateValue();
                    this._updateText();
                    this._selectGroup(this.editors.indexOf(this.activeEditor));

                    return false;
                }
            }
            var specialKey = this._isSpecialKey(key);
            return specialKey;
        },

        _getLastEditableEditorIndex: function () {
            var i = 0;
            var me = this;
            for (itemIndex = this.items.length - 1; itemIndex >= 0; itemIndex--) {
                if (this.items[itemIndex].type != 'ReadOnly') {
                    return itemIndex;
                }
            }

            return -1;
        },

        _handleKeyDown: function (e, key) {
            if (e.keyCode == 115) {
                if (this.isOpened()) {
                    this.hideCalendar();
                    return false;
                }
                else if (!this.isOpened()) {
                    this.showCalendar();
                    return false;
                }
            }

            if (e.altKey) {
                if (e.keyCode == 38) {
                    if (this.isOpened()) {
                        this.hideCalendar();
                        return false;
                    }
                }
                else if (e.keyCode == 40) {
                    if (!this.isOpened()) {
                        this.showCalendar();
                        return false;
                    }
                }
            }

            if (this.isOpened()) {
                if (e.keyCode == 9) {
                    this.hideCalendar('selected');
                    return true;
                }

                return;
            }

            var selection = this._selection();
            if ((e.ctrlKey && key == 99 /* firefox */) || (e.ctrlKey && key == 67) /* opera */) {
                this._saveSelectedText(e);
                return false;
            }

            if ((e.ctrlKey && key == 122 /* firefox */) || (e.ctrlKey && key == 90) /* opera */) return false;

            if ((e.ctrlKey && key == 118 /* firefox */) || (e.ctrlKey && key == 86) /* opera */
            || (e.shiftKey && key == 45)) {

                return false;
            }

            if (key == 8 || key == 46) {
                if (!e.altKey && !e.ctrlKey && key == 46) {
                    this.isEditing = false;
                    if (this.allowKeyboardDelete) {
                        if (this.allowNullDate) {
                            this.setDate(null);
                        }
                        else {
                            if (this.selectionMode != 'range') {
                                this.setDate(this.getMinDate());
                            }
                            else {
                                this.setRange(this.getMinDate(), this.getMinDate());
                            }
                        }
                    }
                }
                else {
                    if (this.activeEditor != null) {
                        var activeEditorIndex = this.editors.indexOf(this.activeEditor);
                        if (this.activeEditor.positions >= 0) {
                            var formattedValue = this._format(Number(this.activeEditor.value), "d" + this.activeEditor.maxEditPositions, this.culture)
                            tmp = formattedValue;
                            tmp = tmp.substring(0, this.activeEditor.positions) + '0' + tmp.substring(this.activeEditor.positions + 1);
                            if (parseInt(tmp) < this.activeEditor.minValue) {
                                tmp = this._format(Number(this.activeEditor.minValue), "d" + this.activeEditor.maxEditPositions, this.culture)
                            }

                            if (this.enableAbsoluteSelection) {
                                this.activeEditor.value = tmp;
                            }
                            else this.activeEditor.value = this.activeEditor.minValue;

                            this._validateValue();
                            this._updateText();

                            if (key == 8) {
                                var myself = this;

                                if (this.enableAbsoluteSelection && this.activeEditor.positions > 0) {
                                    setTimeout(function () {
                                        myself.activeEditor.positions = myself.activeEditor.positions - 1;
                                        myself._selectGroup(activeEditorIndex);
                                    }, 10);
                                }
                                else {
                                    setTimeout(function () {
                                        myself._doLeftKey();
                                    }, 10);
                                }
                            }
                            else this._selectGroup(activeEditorIndex);
                        }
                        else this._doLeftKey();
                    }
                }
                return false;
            }

            if (key == 38) {
                this.spinUp();
                return false;
            }
            else if (key == 40) {
                this.spinDown();
                return false;
            }

            if (key == 37) {
                if (this._editor) {
                    var result = this._doLeftKey();
                    if (!result) {
                        this.isEditing = false;
                        this._validateValue();
                    }
                    return !result;
                }
                else {
                    this._doLeftKey()
                    return false;
                }
            }
            else if (key == 39 || key == 191) {
                if (this._editor) {
                    var result = this._doRightKey();
                    if (!result) {
                        this.isEditing = false;
                        this._validateValue();
                    }
                    return !result;
                }
                else {
                    this._doRightKey();
                    return false;
                }
            }

            var specialKey = this._isSpecialKey(key);

            if (this.value == null && (key >= 48 && key <= 57 || key >= 96 && key <= 105)) {
                this.setDate(new Date());
            }

            if (!$.jqx.browser.mozilla)
                return true;
            if ($.jqx.browser.mozilla && $.jqx.browser.version > 24) {
                return true;
            }

            return specialKey;
        },


        _isSpecialKey: function (key) {
            if (key != 8 /* backspace */ &&
			key != 9 /* tab */ &&
			key != 13 /* enter */ &&
			key != 35 /* end */ &&
			key != 36 /* home */ &&
			key != 37 /* left */ &&
			key != 39 /* right */ &&
			key != 27 /* right */ &&
			key != 46 /* del */
		    ) {
                return false;
            }

            return true;
        },


        _selection: function () {
            if ('selectionStart' in this.dateTimeInput[0]) {
                var e = this.dateTimeInput[0];
                var selectionLength = e.selectionEnd - e.selectionStart;
                return { start: e.selectionStart, end: e.selectionEnd, length: selectionLength, text: e.value };
            }
            else {
                var r = document.selection.createRange();
                if (r == null) {
                    return { start: 0, end: e.value.length, length: 0 }
                }

                var re = this.dateTimeInput[0].createTextRange();
                var rc = re.duplicate();
                re.moveToBookmark(r.getBookmark());
                rc.setEndPoint('EndToStart', re);
                var selectionLength = r.text.length;

                return { start: rc.text.length, end: rc.text.length + r.text.length, length: selectionLength, text: r.text };
            }
        },

        _selectGroup: function (value) {
            if (this.host.css('display') == 'none')
                return;

            if (this.readonly) return;

            var selection = this._selection();
            var str = "";
            var currentString = "";
            var activeEditor = null;
            for (var i = 0; i < this.items.length; i++) {
                currentString = this.items[i].dateParser(this.value, this);
                if (this.isEditing && this.items[i].type != 'ReadOnly') {
                    var isReadOnlyDay = this.items[i].type == 'Day' && this.items[i].format.length > 2;

                    if (!isReadOnlyDay && this.items[i].type != 'FORMAT_AMPM') {
                        currentString = this.items[i].dateParserInEditMode(new Number(this.editors[i].value), "d" + this.editors[i].maxEditPositions, this);
                        while (currentString.length < this.editors[i].maxEditPositions) {
                            currentString = '0' + currentString;
                        }
                    }
                }

                str += currentString;

                if (this.items[i].type == 'ReadOnly')
                    continue;

                if (this.items[i].type == 'Day' && this.items[i].format.length > 2)
                    continue;

                if (value != undefined && value != -1) {
                    if (i >= value) {
                        var selectionStart = str.length - currentString.length;
                        var selectionLength = currentString.length;

                        if (this.enableAbsoluteSelection) {
                            if (!isNaN(parseInt(currentString)) && this.isEditing && value != -1) {
                                selectionLength = 1;
                                selectionStart += this.editors[i].positions;
                            }
                        }

                        if (selectionStart == this.dateTimeInput.val().length) {
                            selectionStart--;
                        }

                        this._setSelection(selectionStart, selectionStart + selectionLength);
                        activeEditor = this.editors[i];
                        this.activeEditor = activeEditor;
                        break;
                    }
                }
                else if (str.length >= selection.start) {
                    activeEditor = this.editors[i];
                    this.activeEditor = activeEditor;
                    var selectionStart = str.length - currentString.length;
                    var selectionLength = 1;
                    if (this.enableAbsoluteSelection) {
                        if (!isNaN(parseInt(currentString)) && this.isEditing && value != -1) {
                            selectionLength = 1;
                            selectionStart += this.editors[i].positions;
                        }
                    }
                    else selectionLength = currentString.length;

                    this._setSelection(selectionStart, selectionStart + selectionLength);
                    break;
                }
            }

            if (i < this.items.length && value == -1) {
                if (this.items[i].type != 'ReadOnly') {
                    this.activeEditor.positions = 0;
                }
            }

            var newSelection = this._selection();
            if (newSelection.length == 0) {
                if (newSelection.start > 0) {
                    var editorIndex = this._getLastEditableEditorIndex();
                    if (editorIndex >= 0) {
                        this._selectGroup(editorIndex);
                    }
                }
            }
        },

        _getLastEditableEditorIndex: function () {
            var editorIndex = -1;
            for (i = 0; i < this.editors.length; i++) {
                if (this.items[i].type == 'ReadOnly')
                    continue;

                if (this.items[i].type == 'Day' && this.items[i].format.length > 2)
                    continue;

                editorIndex = i;
            }

            return editorIndex;
        },

        _setSelection: function (start, end) {
            try
            {
                if ('selectionStart' in this.dateTimeInput[0]) {
                    //  this.dateTimeInput[0].focus();
                    this.dateTimeInput[0].setSelectionRange(start, end);
                }
                else {
                    var range = this.dateTimeInput[0].createTextRange();
                    range.collapse(true);
                    range.moveEnd('character', end);
                    range.moveStart('character', start);
                    range.select();
                }
            }
            catch (error) {
            }
        },

        _setSelectionStart: function (start) {
            this._setSelection(start, start);
        },

        destroy: function () {
            this.host
			.removeClass("jqx-rc-all")
			;
            this._calendar.destroy();
            this.container.remove();
            this._removeHandlers();
            this.dateTimeInput.remove();
            this.host.remove();
        },

        refreshValue: function()
        {
            this._refreshValue();
        },

        refresh: function (initialRefresh) {
            if (initialRefresh != true) {
                this._setSize();
                this._arrange();
            }
        },

        _setOption: function (key, value) {
            if (key === "value") {
                this.value = value;
                this._refreshValue();
                this._raiseEvent(9, {});
            }
            if (key == 'maxDate') {
                this._calendar.maxDate = value;
                this._raiseEvent(9, {});
            }

            if (key == 'minDate') {
                this._calendar.minDate = value;
                this._raiseEvent(9, {});
            }

            if (key == 'showCalendarButton') {
                if (value) {
                    this.calendarButton.css('display', 'block');
                }
                else {
                    this.calendarButton.css('display', 'none');
                }
            }

            if (key == "disabled") {
                this.dateTimeInput.attr("disabled", value);
            }

            if (key == "readonly") {
                this.readonly = value;
                this.dateTimeInput.css("readonly", value);
            }

            if (key == "textAlign") {
                this.dateTimeInput.css("text-align", value);
                this.textAlign = value;
            }

            if (key == "width") {
                this.width = value;
                this.width = parseInt(this.width);
                this._arrange();
            }
            else if (key == "height") {
                this.height = value;
                this.height = parseInt(this.height);
                this._arrange();
            }
        },


        _refreshValue: function () {
            this._updateEditorsValue();
            this.updateValue();
            this._validateValue();
            this._updateText();
        }
    })
})(jQuery);


(function ($) {
    $.jqx._jqxDateTimeInput.DateTimeFormatItem = {};
       $.extend($.jqx._jqxDateTimeInput.DateTimeFormatItem, { 

    _create: function(format, type, culture)
    {
        this.format = format;
        this.type = type;
        this.culture = culture;
        return this;
    },

    _itemValue: function()
    {
        switch (this.format.length)
        {
            case 1:
                return 9;
            case 2:
                return 99;
            case 3:
            default:
                return 999;
        }
    },

    _maximumValue: function()
    {
        switch (this.format.length)
        {
            case 1:
                return 9;
            case 2:
                return 99;
            case 3:
            default:
                return 999;
        }     
    },

    dateParser: function(formattedDateTime, that)
    {
        if (formattedDateTime == null)
            return "";
        var value = that._format(formattedDateTime.dateTime, this.format.length == 1 ? '%' + this.format : this.format, this.culture);
        return value;
    },

    dateParserInEditMode: function(val, format, that)
    {
        if (val == null)
            return "";

        var value = that._format(val.toString(), format.length == 1 ? '%' + format: format, this.culture);
        return value;
    },

    getDateTimeEditorByItemType: function(value, that)
    {
        switch (this.type)
        {
            case 'FORMAT_AMPM':
                var aMpMEditor = $.jqx._jqxDateTimeInput.AmPmEditor._createAmPmEditor(this.format, value.hour / 12, that.localization.calendar.AM[0], that.localization.calendar.PM[0], this, that);
                var newEditor = $.extend({}, aMpMEditor); 
                return newEditor;
             case 'Character':
                return null;
            case 'Day':
                var year = value.year;
                var month = value.month;
                var dayNames;
                if (this.format.length == 3)
                    dayNames = that.localization.calendar.days.namesAbbr;
                else if (this.format.length > 3)
                    dayNames = that.localization.calendar.days.names;
                else
                    dayNames = null;

                var val = value.day;
                if (dayNames != null)
                    val =  value.dayOfWeek + 1;

                var dayEditor = $.jqx._jqxDateTimeInput.DateEditor._createDayEditor(value, value.day, 1, value._daysInMonth(year, month), this.format.length == 1 ? 1 : 2, 2, dayNames, this, that);
                var newEditor = $.extend({}, dayEditor); 
                return newEditor;
            case 'FORMAT_hh':
                var initialValue = value.hour % 12;
                if (initialValue == 0)
                    initialValue = 12;
                var hhEditor = $.jqx._jqxDateTimeInput.NumberEditor._createNumberEditor(initialValue, 1, 12, this.format.length == 1 ? 1 : 2, 2, this, that);
                var newEditor = $.extend({}, hhEditor); 
                return newEditor;
            case 'FORMAT_HH':
                var HHEditor = $.jqx._jqxDateTimeInput.NumberEditor._createNumberEditor(value.hour, 0, 23, this.format.length == 1 ? 1 : 2, 2, this, that);
                var newEditor = $.extend({}, HHEditor); 
                return newEditor;
            case 'Millisecond':
                var milisecondEditor = $.jqx._jqxDateTimeInput.NumberEditor._createNumberEditor(value.millisecond / this._itemValue(), 0, this._maximumValue(), this.format.length, this.format.length, this, that);
                var newEditor = $.extend({}, milisecondEditor); 
                return newEditor;
            case 'Minute':
                var minuteEditor = $.jqx._jqxDateTimeInput.NumberEditor._createNumberEditor(value.minute, 0, 59, this.format.length == 1 ? 1 : 2, 2, this, that);
                var newEditor = $.extend({}, minuteEditor); 
                return newEditor;
           case 'Month':
                var monthNames;
                if (this.format.length == 3)
                    monthNames = that.localization.calendar.months.namesAbbr;
                else if (this.format.length > 3)
                    monthNames = that.localization.calendar.months.names;
                else
                    monthNames = null;
                var monthEditor = $.jqx._jqxDateTimeInput.DateEditor._createMonthEditor(value.month, this.format.length == 2 ? 2 : 1, monthNames, this, that);
                var newEditor = $.extend({}, monthEditor); 
                return newEditor;
            case 'ReadOnly':
                return $.jqx._jqxDateTimeInput.DisabledEditor._create(this.format.length, value.day, this, that);
            case 'Second':
                var secondEditor = $.jqx._jqxDateTimeInput.NumberEditor._createNumberEditor(value.second, 0, 59, this.format.length == 1 ? 1 : 2, 2, this, that);
                var newEditor = $.extend({}, secondEditor); 
                return newEditor;
          case 'Year':
              var yearEditor = $.jqx._jqxDateTimeInput.DateEditor._createYearEditor(value.year, this.format.length, this, that);
               var newEditor = $.extend({}, yearEditor); 
               return newEditor;
        }

        return null;
    }
    //[optimize]
    //getDateTimeWithOffset: function(offset, value)
    //{
    //    if (offset == null || value == null)
    //    {
	//	    throw 'Invalid arguments';
    //    }

    //    var hours = value.hour;
    //    var minutes = value.minute;
    //    var seconds = value.second;
    //    var days = value.day();
    //    var months = value.month();
    //    var years = value.year();

    //    var dateTime = value;
    //    var newDateTime = value;

    //    switch (this.type)
    //    {
    //        case 'FORMAT_AMPM':
    //            hours = 12 * (offset - hours / 12);
    //            break;
    //        case 'Day':
    //            days = offset - days;
    //            if (days != offset)
    //            {
    //                if (offset == 29 && months == 2)
    //                {
    //                    newDateTime = dateTime;
    //                    while (!DateTime._isLeapYear(newDateTime.year))
    //                    {
    //                        newDateTime = newDateTime._addYears(1);
    //                    }

    //                        newDateTime = newDateTime._addDays(offset - newDateTime.day);
    //                }
    //                else
    //                {
    //                    newDateTime = dateTime._addMonths(1 - dateTime.month);
    //                    newDateTime = newDateTime._addDays(offset - dateTime.day);
    //                }
    //            }
    //            break;
    //        case 'FORMAT_hh':
    //            var res = offset == 12 ? 0 : offset;
    //            dateTime = dateTime._addHours(res - (dateTime.hour % 12));
    //            break;
    //        case 'FORMAT_HH':
    //            dateTime = dateTime._addHours(offset - dateTime.hour);
    //            break;
    //        case 'Millisecond':
    //            dateTime = dateTime._addMilliseconds(offset * this._itemValue() - dateTime.millisecond);
    //            break;
    //        case 'Minute':
    //            dateTime = dateTime._addMinutes(offset - dateTime.minute);
    //            break;
    //        case 'Month':
    //            newDateTime = dateTime._addMonths(offset - dateTime.month);
    //            if (offset == 2 && dateTime.day == 29 && dateTime.day != newDateTime.day
    //                )
    //            {
    //                newDateTime = dateTime;
    //                while (!dateTime.IsLeapYear(newDateTime.year))
    //                {
    //                    newDateTime = newDateTime._addYears(1);
    //                }

    //                newDateTime = newDateTime._addMonths(offset - newDateTime.month);
    //            }

    //            dateTime = newDateTime;
    //            break;
    //        case 'ReadOnly':
    //            break;
    //        case 'Second':
    //            dateTime = dateTime._addSeconds(offset - dateTime.second);

    //            break;
    //        case 'Year':
    //            if (offset == 0)
    //                offset = 1;

    //            dateTime = dateTime._addYears(offset - value.year);
    //            break;
    //    }
    //    return dateTime;
    //}
    });
})(jQuery);

(function ($) {
         $.jqx._jqxDateTimeInput.DateEditor = $.extend($.jqx._jqxDateTimeInput.DateEditor, { 

        formatValueLength: 0,
        handleYears: false,
        handleDays: false,
        handleMonths: false,
        positions: 0,
        value: 0,
        minEditPositions : 0,
        maxEditPositions: 0,
        minValue: 0,
        maxValue: 0,
        item: null,
        dateTimeFormatInfo: null,
        days: null,
        dateTimeMonths: null,
        lastDayInput: null,

        minPositions : function()
        {
            if (this.handleYears)
            {
                if (this.formatValueLength == 4)
                {
                    if (this.positions <= 1)
                    {
                        return 1;
                    }
                    else
                    {
                        if (this.positions >= 4)
                        {
                            return 4;
                        }
                    }

                    return this.positions;
                }
                else
                {
                    return this.minEditPositions;
                }
            }
            return this.minEditPositions;   
        },
        //[optimize]
        initializeFields: function(minValue, maxValue, minEditPositions, maxEditPositions, item)
        {
            this.minValue = minValue;
            this.maxValue = maxValue;
            this.minEditPositions = minEditPositions;
            this.maxEditPositions = maxEditPositions;
            this.updateActiveEditor(minValue);
            this.item = item;
        },
        //[optimize]
        _createYearEditor: function(baseYear, formatValueLength, item, that)
        {
            $.jqx._jqxDateTimeInput.DateEditor = $.extend(true, {}, this);
            this.initializeFields(formatValueLength <= 4 ? 0 : 0, formatValueLength < 4 ? 99 : 9999, (formatValueLength == 2) ? 2 : 1, formatValueLength > 3 ? 4 : 2, item);
            this.initializeYearEditor(baseYear, formatValueLength, item.culture);
            this.handleYears = true;
            this.that = that;
            return this;
        },
        //[optimize]
        initializeYearEditor: function(baseYear, formatValueLength, info)
        {
            this.formatValueLength = formatValueLength;
            this.dateTimeFormatInfo = info;

            var realYear = baseYear;
            realYear = Math.min(realYear, 9999);
            realYear = Math.max(realYear, 1);
            realYear = this.formatValueLength < 4 ? realYear % 100 : realYear;
            this.updateActiveEditor(realYear);
            this.value = realYear;
        },
        //[optimize]
        updateActiveEditor: function(newValue)
        {
            this.value = newValue;
            this.positions = 0;
        },
        //[optimize]
        _createDayEditor: function(editedValue, initialValue, minValue, maxValue, minEditingPositions, maxEditingPositions, dayKeys, item, that)
        {
            $.jqx._jqxDateTimeInput.DateEditor = $.extend(true, {}, this);
            this.initializeFields(minValue, maxValue, 1, maxEditingPositions, item);
            this.currentValue = editedValue;
            this.value = initialValue;
            this.days = dayKeys;
            this.handleDays = true;
            this.that = that;
            return this;
        },
        //[optimize]
        getDayOfWeek: function(val)
        {
            if (typeof this.currentValue == $.jqx._jqxDateTimeInput.DateTime)
            {
                 this.currentValue.dayOfWeek();
            }
            return val;
        },
        //[optimize]
        defaultTextValue: function()
        {
            var value = this.value;
            var minPositions = this.minEditPositions;
            var minFormattedPositions = minPositions;
            var formattedValue = this.that._format(this.value, "d" + minFormattedPositions, "");

            return formattedValue;
        },
        //[optimize]
        textValue : function()
        {
            if (this.handleDays)
            {
                if (this.days == null)
                {
                    return this.defaultTextValue();
                }
                else
                {
                    var val = (this.value % 7) + 1;
                    val = this.getDayOfWeek(val);
                    return this.days[val];
                }
            }
            else if (this.handleMonths)
            {
                if (this.dateTimeMonths == null || this.value < 1 || this.value > 12)
                {
                    return this.defaultTextValue();
                }
                else
                {
                    return this.dateTimeMonths[this.value - 1];
                }
            }
            return this.defaultTextValue();
       },
       //[optimize]
        defaultInsertString: function(inseredValue)
        {
            if (inseredValue == null)
            {
                return this.deleteValue();
            }

            if (inseredValue.length == 0)
            {
                 return this.deleteValue();
            }

           var character = inseredValue.substring(0, 1);
           if (isNaN(character))
           {
              return;
           }

           var res = true;
           var tmp;
           var entries = 1; 
           var formattedValue = this.that._format(Number(this.value), "d" + this.maxEditPositions, this.culture)     
           tmp = formattedValue;
           if (this.positions >= this.maxEditPositions)
           {
              this.positions = 0;
           }
            
           tmp = tmp.substring(0, this.positions) + character + tmp.substring(this.positions + 1);
           tmp = this.setValueByString(tmp, entries);
           return true;
        },
        //[optimize]
        setValueByString: function(tmp, entries)
        {
            tmp = this.fixValueString(tmp);
            var nextValue = new Number(tmp);
            this.value = nextValue;
            this.positions += entries;
            return tmp;
        },
        //[optimize]
        fixValueString: function(tmp)
        {
            if (tmp.length > this.maxEditPositions)
            {
                tmp = tmp.substring(tmp.length - this.maxEditPositions);
            }

//            var enteredDigit = parseInt(tmp[this.positions]);
//            var pos = this.maxEditPositions - 1;
//            while(parseInt(tmp) > this.maxValue)
//            {
//                if (pos < 0)
//                    break;

//                if (tmp[pos] > 0)
//                {
//                    var digit = parseInt(tmp[pos])-1;
//                    tmp = tmp.substring(0, pos) + digit + tmp.substring(pos+1);
//                }
//                else pos--;
//            }

            return tmp;
        },
        //[optimize]
        initializeValueString: function(formattedValue)
        {
            var tmp;
            tmp = "";

            if (this.hasDigits())
            {
                tmp = formattedValue;
            }
            return tmp;
        },
        //[optimize]
        deleteValue: function()
        {
            if (this.value == this.minValue && this.hasDigits() == false)
            {
                return false;
            }

            this.updateActiveEditor(this.minValue);
            return true;
        },
        //[optimize]
        hasDigits: function()
        {
            return this.positions > 0;
        },
        //[optimize]
        insert: function(input)
        {
            if (this.handleDays)
            {
                if (this.days != null)
                {
                    var res = false;
                    res = this.insertLongString(input, res);
                    if (res)
                    {
                        return res;
                    }
                    res = this.insertShortString(input, res);
                    if (res)
                    {
                        return res;
                    }
                }              

                if (this.value == 1 && this.lastDayInput != null && this.lastDayInput.toString().length > 0 && this.lastDayInput.toString() == "0")
                {
                    this.value = 0;
                }
               
                this.lastDayInput = input;

                return this.defaultInsertString(input);
            }
            else if ( this.handleMonths)
            {
                if (this.dateTimeMonths != null)
                {
                    var res = false;
                    res = this.insertLongString2(input, res);

                    if (res)
                    {
                        return res;
                    }

                    res = this.insertShortString2(input, res);

                    if (res)
                    {
                        return res;
                    }
                }
            }

            return this.defaultInsertString(input);     
        },
        //[optimize]
        insertShortString: function(input, res)
        {
            if (input.length == 1)
            {
                for (i = 0; i < 6; ++i)
                {
                    var testedDay = (this.value + i) % 7 + 1;
                    var dayName = this.days[testedDay - 1];
                    if (dayName.substring(0, 1) == input)
                    {
                        this.updateActiveEditor(testedDay);
                        res = true;
                        return res;
                    }
                }
            }
            return res;
        },
        //[optimize]
        insertLongString: function(input, res)
        {
            if (input.length > 0)
            {
                for (i = 0; i < 6; ++i)
                {
                    var testedDay = (this.value + i) % 7 + 1;
                    if (this.days[testedDay - 1] == input)
                    {
                        this.updateActiveEditor(testedDay);
                        res = true;
                        return res;
                    }
                }
            }
            return res;
        },
        //[optimize]
        _createMonthEditor: function(baseValue, positions, monthsNames, item, that)
        {
            $.jqx._jqxDateTimeInput.DateEditor = $.extend(true, {}, this);

            this.initializeFields(1, 12, positions, 2, item);
            this.dateTimeMonths = monthsNames;
            this.value = baseValue;
            if (this.dateTimeMonths != null && this.dateTimeMonths[12] != null && this.dateTimeMonths[12].length > 0)
                this.dateTimeMonths = null;
            this.handleMonths = true;
            this.that = that;
            return this;
        }, 
        //[optimize]
        insertLongString2: function(input, res)
        {
            if (input.length > 0)
            {
                for (i = 0; i < 11; ++i)
                {
                    month = (this.value + i) % 12 + 1;
                    if (this.dateTimeMonths[month - 1] == input)
                    {
                        this.updateActiveEditor(month);
                        res = true;
                        return res;
                    }
                }
            }
            return res;
        },
        //[optimize]
        insertShortString2: function(input, res)
        {
            if (input.length == 1)
            {
                for (i = 0; i < 11; ++i)
                {
                    var month = (this.value + i) % 12 + 1;
                    var monthName = this.dateTimeMonths[month - 1];
                    if (monthName.substring(0, 1) == input)
                    {
                        this.updateActiveEditor(month);
                        res = true;
                        return res;
                    }
                }
            }
            return res;
        },
        //[optimize]
        correctMaximumValue : function(val)
        {
            if (val > this.maxValue)
            {
                val = this.minValue;
            }
            return val;
        },
        //[optimize]
        correctMinimumValue: function(val)
        {
            if (val < this.minValue)
            {
                val = this.maxValue;
            }
            return val;
        },
        //[optimize]
        increaseValue: function(byPosition)
        {
            var formattedValue = this.that._format(Number(this.value), "d" + this.maxEditPositions, this.culture)
            var digit = formattedValue.toString()[this.positions];
            digit = parseInt(digit) + 1;
            if (digit > 9 ) digit = 0;
            
            if (!byPosition)
            {
                var tmpValue = this.value + 1;
                tmpValue = this.correctMaximumValue(tmpValue);
                this.updateActiveEditor(tmpValue);
                return true;          
            }

            var val = formattedValue.substring(0, this.positions) + digit + formattedValue.substring(this.positions + 1);
          
            if (val != this.value || this.hasDigits())
            {
                this.updateActiveEditor(val);
                return true;
            }
            else
            {
                return false;
            }
        },
        //[optimize]
        decreaseValue: function(byPosition)
        {
            var formattedValue = this.that._format(Number(this.value), "d" + this.maxEditPositions, this.culture)     
            var digit = formattedValue.toString()[this.positions];
            digit = parseInt(digit) - 1;
            if (digit < 0 ) digit = 9;

            if (!byPosition)
            {
                var tmpValue = this.value - 1;
                tmpValue = this.correctMinimumValue(tmpValue);
                this.updateActiveEditor(tmpValue);
                return true;          
            }

            var val = formattedValue.substring(0, this.positions) + digit + formattedValue.substring(this.positions + 1);
          
            if (val != this.value || this.hasDigits())
            {
                this.updateActiveEditor(val);
                return true;
            }
            else
            {
                return false;
            }
        },
        //[optimize]
        getDateTimeItem: function()
        {
            return this.item;
        }
    })
})(jQuery);

//Number Editor
(function ($) {
     $.jqx._jqxDateTimeInput.NumberEditor = {};
       $.extend($.jqx._jqxDateTimeInput.NumberEditor, { 

        formatValueLength: 0,
        positions: 0,
        value: 0,
        minEditPositions : 0,
        maxEditPositions: 0,
        minValue: 0,
        maxValue: 0,
        item: null,
        //[optimize]
        minPositions : function()
        {
            if (this.handleYears)
            {
                if (this.formatValueLength == 4)
                {
                    if (this.positions <= 1)
                    {
                        return 1;
                    }
                    else
                    {
                        if (this.positions >= 4)
                        {
                            return 4;
                        }
                    }

                    return this.positions;
                }
                else
                {
                    return this.minEditPositions;
                }
            }
            return this.minEditPositions;   
        },
        //[optimize]
        _createNumberEditor: function(value, minValue, maxValue, minEditPositions, maxEditPositions, item, that)            
        {
            $.jqx._jqxDateTimeInput.NumberEditor = $.extend(true, {}, this);
            this.initializeFields(minValue, maxValue, minEditPositions, maxEditPositions, item);
            this.that = that;

            return this;
         },
        //[optimize]
        initializeFields: function(minValue, maxValue, minEditPositions, maxEditPositions, item)
        {
            this.minValue = minValue;
            this.maxValue = maxValue;
            this.minEditPositions = minEditPositions;
            this.maxEditPositions = maxEditPositions;
            this.updateActiveEditor(minValue);
            this.item = item;
        },
        //[optimize]
        updateActiveEditor: function(newValue)
        {
            this.value = newValue;
            this.positions = 0;
        },
        //[optimize]
        getDayOfWeek: function(val)
        {
            if (typeof this.currentValue == $.jqx._jqxDateTimeInput.DateTime)
            {
                 this.currentValue.dayOfWeek();
            }
            return val;
        },
        //[optimize]
        textValue: function()
        {
            var value = this.value;
            var minPositions = this.minEditPositions;
            var minFormattedPositions = minPositions;
            var formattedValue = this.that._format(this.value, "d" + minFormattedPositions, "");

            return formattedValue;
        },
        //[optimize]
        insert: function(inseredValue)
        {
            if (inseredValue == null)
            {
                return this.deleteValue();
            }

            if (inseredValue.length == 0)
            {
                 return this.deleteValue();
            }

           var character = inseredValue.substring(0, 1);
           if (isNaN(character))
           {
              return;
           }

           var res = true;
           var tmp;
           var entries = 1; 
           var formattedValue = this.that._format(Number(this.value), "d" + this.maxEditPositions, this.culture)     
           tmp = formattedValue;
           if (this.positions >= this.maxEditPositions)
           {
              this.positions = 0;
           }
            
           tmp = tmp.substring(0, this.positions) + character + tmp.substring(this.positions + 1);
           tmp = this.setValueByString(tmp, entries);
           return true;
        },
        //[optimize]
        setValueByString: function(tmp, entries)
        {
            tmp = this.fixValueString(tmp);
            var nextValue = new Number(tmp);
            this.value = nextValue;
            this.positions += entries;
            return tmp;
        },
        //[optimize]
        fixValueString: function(tmp)
        {
            if (tmp.length > this.maxEditPositions)
            {
                tmp = tmp.substring(tmp.length - this.maxEditPositions);
            }

//            var enteredDigit = parseInt(tmp[this.positions]);
//            var pos = this.maxEditPositions - 1;
//            while(parseInt(tmp) > this.maxValue)
//            {
//                if (pos < 0)
//                    break;

//                if (tmp[pos] > 0)
//                {
//                    var digit = parseInt(tmp[pos])-1;
//                    tmp = tmp.substring(0, pos) + digit + tmp.substring(pos+1);
//                }
//                else pos--;
//            }

            return tmp;
        },
        //[optimize]
        initializeValueString: function(formattedValue)
        {
            var tmp;
            tmp = "";

            if (this.hasDigits())
            {
                tmp = formattedValue;
            }
            return tmp;
        },
        //[optimize]
        deleteValue: function()
        {
            if (this.value == this.minValue && this.hasDigits() == false)
            {
                return false;
            }

            this.updateActiveEditor(this.minValue);
            return true;
        },
        //[optimize]
        hasDigits: function()
        {
            return this.positions > 0;
        },
        //[optimize]
        correctMaximumValue : function(val)
        {
            if (val > this.maxValue)
            {
                val = this.minValue;
            }
            return val;
        },
        //[optimize]
        correctMinimumValue: function(val)
        {
            if (val < this.minValue)
            {
                val = this.maxValue;
            }
            return val;
        },
        //[optimize]
        increaseValue: function(byPosition)
        {
            var formattedValue = this.that._format(Number(this.value), "d" + this.maxEditPositions, this.culture)
            var digit = formattedValue.toString()[this.positions];
            digit = parseInt(digit) + 1;
            if (digit > 9 ) digit = 0;
            
            if (!byPosition)
            {
                var tmpValue = this.value + 1;
                tmpValue = this.correctMaximumValue(tmpValue);
                this.updateActiveEditor(tmpValue);
                return true;          
            }

            var val = formattedValue.substring(0, this.positions) + digit + formattedValue.substring(this.positions + 1);
          
            if (val != this.value || this.hasDigits())
            {
                this.updateActiveEditor(val);
                return true;
            }
            else
            {
                return false;
            }
        },
        //[optimize]
        decreaseValue: function(byPosition)
        {
            var formattedValue = this.that._format(Number(this.value), "d" + this.maxEditPositions, this.culture)
            var digit = formattedValue.toString()[this.positions];
            digit = parseInt(digit) - 1;
            if (digit < 0 ) digit = 9;

            if (!byPosition)
            {
                var tmpValue = this.value - 1;
                tmpValue = this.correctMinimumValue(tmpValue);
                this.updateActiveEditor(tmpValue);
                return true;          
            }

            var val = formattedValue.substring(0, this.positions) + digit + formattedValue.substring(this.positions + 1);
          
            if (val != this.value || this.hasDigits())
            {
                this.updateActiveEditor(val);
                return true;
            }
            else
            {
                return false;
            }
        },
        //[optimize]
        getDateTimeItem: function()
        {
            return this.item;
        }
    })
})(jQuery);

//DisabledEditor
(function ($) {

   $.jqx._jqxDateTimeInput.DisabledEditor = {};
       $.extend($.jqx._jqxDateTimeInput.DisabledEditor, { 

         _create: function (format, baseValue, am, pm, item, that) {
            this.format = format;
            this.value = -1;  
            this.item = item;
            this.that = that;

            return this;
         },

        textValue: function()
        {
            return "";
        },

        insert: function(val)
        {
            return false;
        },

        deleteValue: function()
        {
           return false;
        },

        increaseValue: function()
        {
           return false;
        },

        decreaseValue: function()
        {
            return false;
        },

        getDateTimeItem: function()
        {
            return this.item;
        }
    })
})(jQuery);

//AmPmEditor
(function ($) {

    $.jqx._jqxDateTimeInput.AmPmEditor = {};
       $.extend($.jqx._jqxDateTimeInput.AmPmEditor, { 
         _createAmPmEditor: function (format, baseValue, am, pm, item, that) {
            this.format = format;
            this.value = baseValue;
            this.amString = am;
            this.pmString = pm;
            this.item = item;
            this.that = that;

            if (am == pm)
            {
                this.amString  = "<" + am;
                this.pmString = ">" + pm;
            }
            return this;
        },
        //[optimize]
        textValue: function()
        {
           var res = this.amString;
           if (this.value != 0)
           {
               res = this.pmString;
           }
              
           if (this.format.length == 1 && res.length > 1)
           {
               res = res.substring(0, 1);
           }

            return res;
        },
        //[optimize]
        insert: function(val)
        {
            var inserted = val.toString();
            if (inserted.Length == 0)
            {
                return this.deleteValue();
            }

            var res = false;
            if (this.amString.Length > 0
            && this.pmString.Length > 0)
            {
                var amChar = amString[0];
                var newChar = inserted[0];
                var pmChar = pmString[0];

                if (amChar.toString() == newChar.toString())
                {
                    this.value = 0;
                    res = true;

                }
                else if (pmChar.toString() == newChar.toString())
                {
                    this.value = 1;
                    res = true;
                }
            }
            else if (this.pmString.Length > 0)
            {
                this.value = 1;
                res = true;
            }
            else if (this.amString.Length > 0)
            {
                this.value = 0;
                res = true;
            }
          
            return res;
        },
        //[optimize]
        deleteValue: function()
        {
            var isValid = true;

            if (this.amString.Length == 0
                && this.pmString.Length != 0)
            {
                if (this.value == 0)
                {
                    return false;
                }

                this.value = 0;
            }
            else
            {
                if (this.value == 1)
                {
                    return false;
                }

                this.value = 1;
            }
            return isValid;
        },

        increaseValue: function()
        {
           this.value = 1 - this.value;
           return true;
        },

        decreaseValue: function()
        {
            this.increaseValue();
            return true;
        },

        getDateTimeItem: function()
        {
            return this.item;
        }
    })
})(jQuery);

// DateTime 
(function ($) {
    $.jqx._jqxDateTimeInput.getDateTime = function (date)
    {
        var result =
        {
            dateTime: new Date(date),
            daysPer4Years: 0x5b5,
            daysPerYear: 0x16d,
            daysToMonth365:  { 0:0, 1:0x1f, 2:0x3b, 3:90, 4:120, 5:0x97, 6:0xb5, 7:0xd4, 8:0xf3, 9:0x111, 10:0x130, 11:0x14e, 12:0x16d },
            daysToMonth366: { 0:0, 1:0x1f, 2:60, 3:0x5b, 4:0x79, 5:0x98, 6:0xb6, 7:0xd5, 8:0xf4, 9:0x112, 10:0x131, 11:0x14f, 12:0x16e },
            maxValue: 0x2bca2875f4373fff,
            millisPerDay: 0x5265c00,
            millisPerHour: 0x36ee80,
            millisPerMinute: 0xea60,
            millisPerSecond: 0x3e8,
            minTicks: 0,
            minValue: 0,
            ticksPerDay: 0xc92a69c000,
            ticksPerHour: 0x861c46800,
            ticksPerMillisecond: 0x2710,
            ticksPerMinute: 0x23c34600,
            ticksPerSecond: 0x989680,
            hour: date.getHours(),
            minute:  date.getMinutes(),                
            day: date.getDate(),                
            second: date.getSeconds(),
            month: 1+date.getMonth(),
            year: date.getFullYear(),
            millisecond:date.getMilliseconds(),
            dayOfWeek: date.getDay(),
            isWeekend: function(value)
            {
                if (value == undefined || value == null)
                    value = this.dateTime;

                var isWeekend = value.getDay()%6 == 0;
                return isWeekend;
            },
            dayOfYear: function(value)
            {
                if (value == undefined || value == null)
                    value = this.dateTime;

                var firstDay = new Date(value.getFullYear(), 0, 1);
                return Math.ceil((value - firstDay) / 86400000);
            },
            _setDay: function(value)
            {
                if (value == undefined || value == null)
                    value = 0;

                this.dateTime.setDate(value);
                this.day = this.dateTime.getDate();
            },
            _setMonth: function(value)
            {
                if (value == undefined || value == null)
                    value = 0;

                this.dateTime.setMonth(value-1);
                this.month = 1 + this.dateTime.getMonth();
            },
            _setYear: function(value)
            {
                if (value == undefined || value == null)
                    value = 0;

                this.dateTime.setFullYear(value);
                this.year = this.dateTime.getFullYear();
            },
            _setHours: function(value)
            {
                if (value == undefined || value == null)
                    value = 0;

                this.dateTime.setHours(value);
                this.hour = this.dateTime.getHours();
            },
            _setMinutes: function(value)
            {
                if (value == undefined || value == null)
                    value = 0;

                this.dateTime.setMinutes(value);
                this.minute = this.dateTime.getMinutes();
            },
            _setSeconds: function(value)
            {
                if (value == undefined || value == null)
                    value = 0;

                this.dateTime.setSeconds(value);
                this.second = this.dateTime.getSeconds();
            },
            _setMilliseconds: function(value)
            {
                if (value == undefined || value == null)
                  value = 0;

                this.dateTime.setMilliseconds(value);
                this.millisecond = this.dateTime.getMilliseconds();
            },
            _addDays: function(value)
            {
                var newDate = this.dateTime;
                var day = newDate.getDate();
                newDate.setDate(newDate.getDate() + value);
                if (day === newDate.getDate()) {
                    newDate.setHours(newDate.getHours() + newDate.getTimezoneOffset() / 60);
                }
                return newDate;
            },
             _addWeeks: function(value)
            {
                var newDate = this.dateTime;
                newDate.setDate(newDate.getDate() + 7*value);
                return newDate;
            },
            _addMonths: function(value)
            {
                var newDate = this.dateTime;
                newDate.setMonth(newDate.getMonth() + value);
                return newDate;
            },
            _addYears: function(value)
            {
                var newDate = this.dateTime;
                newDate.setFullYear(newDate.getFullYear() + value);
                return newDate;
            },
            _addHours: function(value)
            {
                var newDate = this.dateTime;
                newDate.setHours(newDate.getHours() + value);
                return newDate;
            },
            _addMinutes: function(value)
            {
                var newDate = this.dateTime;
                newDate.setMinutes(newDate.getMinutes() + value);
                return newDate;
            },
            _addSeconds: function(value)
            {
                var newDate = this.dateTime;
                newDate.setSeconds(newDate.getSeconds() + value);
                return newDate;
            },
            _addMilliseconds: function(value)
            {
                var newDate = this.dateTime;
                newDate.setMilliseconds(newDate.getMilliseconds() + value);
                return newDate;
            },
            _isLeapYear: function(year)
            {
                if ((year < 1) || (year > 0x270f))
                {
                    throw "invalid year";
                }
                if ((year % 4) != 0)
                {
                    return false;
                }
                if ((year % 100) == 0)
                {
                    return ((year % 400) == 0);
                }
                return true;
            },
            _dateToTicks: function(year, month, day)
            {
                if (((year >= 1) && (year <= 0x270f)) && ((month >= 1) && (month <= 12)))
                {
                    var numArray = this._isLeapYear(year) ? this.daysToMonth366 : this.daysToMonth365;
                    if ((day >= 1) && (day <= (numArray[month] - numArray[month - 1])))
                    {
                        var year = year - 1;
                        var ticks = ((((((year * 0x16d) + (year / 4)) - (year / 100)) + (year / 400)) + numArray[month - 1]) + day) - 1;
                        return (ticks * 0xc92a69c000);
                    }
                }
            },
            _daysInMonth: function(year, month)
            {
                if ((month < 1) || (month > 12))
                {
                    throw("Invalid month.");
                }
                var arr = this._isLeapYear(year) ? this.daysToMonth366 : this.daysToMonth365;
                return (arr[month] - arr[month - 1]);
            },
            _timeToTicks: function(hour, minute, second)
            {
                var ticks = ((hour * 0xe10) + (minute * 60)) + second;
                return (ticks * 0x989680);
            },
            _equalDate: function(date)
            {
                if (this.year == date.getFullYear() && this.day == date.getDate() && this.month == date.getMonth() + 1)
                    return true;
                      
                return false;
            }
         }
        return result;
    }
})(jQuery);
/*
jQWidgets v3.0.3 (2013-Oct-01)
Copyright (c) 2011-2013 jQWidgets.
License: http://jqwidgets.com/license/
*/

/*
jQWidgets v2.9.4 (2013-July-11)
Copyright (c) 2011-2013 jQWidgets.
License: http://jqwidgets.com/license/
*/

(function ($) {
    $.jqx.jqxWidget("jqxChart", "", {});

    $.extend($.jqx._jqxChart.prototype,
    {
        defineInstance: function () {
            this.title = 'Title';
            this.description = 'Description';
            this.source = [];
            this.seriesGroups = [];
            this.categoryAxis = {};
            this.renderEngine = undefined;
            this.enableAnimations = true;
            this.backgroundImage = this.background = undefined;
            this.padding = { left: 5, top: 5, right: 5, bottom: 5 };
            this.backgroundColor = '#FFFFFF';
            this.showBorderLine = true;
            this.borderLineWidth = 1;
            this.titlePadding = { left: 2, top: 2, right: 2, bottom: 2 };
            this.showLegend = true;
            this.legendLayout = undefined;
            this.enabled = true;
            this.colorScheme = 'scheme01';
            this.animationDuration = 500;
            this.showToolTips = true;
            this.toolTipShowDelay = this.toolTipDelay = 500;
            this.toolTipHideDelay = 4000;
            this.toolTipFormatFunction = undefined;
            this.columnSeriesOverlap = false;
            this.rtl = false;
            this.legendPosition = null;
            this.borderLineColor = null;
            this.borderColor = null;
            this.greyScale = false;
            this.axisPadding = 5;
            this.enableCrosshairs = false;
            this.crosshairsColor = '#888888';
            this.crosshairsDashStyle = '2,2';
            this.crosshairsLineWidth = 1.0;
        },

        createInstance: function (args) {
            if (!$.jqx.dataAdapter) {
                throw 'jqxdata.js is not loaded';
                return;
            }

            this._refreshOnDownloadComlete();

            var self = this;
            this.host.on('mousemove', function (event) {
                if (self.enabled == false)
                    return;

                event.preventDefault();
                var x = event.pageX || event.clientX || event.screenX;
                var y = event.pageY || event.clientY || event.screenY;

                var pos = self.host.offset();
                x -= pos.left;
                y -= pos.top;

                self.onmousemove(x, y);
            });

            this.addHandler(this.host, 'mouseleave', function (event) {
                if (self.enabled == false)
                    return;

                self._cancelTooltipTimer();
                self._hideToolTip(0);
            });
            var isTouchDevice = $.jqx.mobile.isTouchDevice();

            this.addHandler(this.host, 'click', function (event) {
                if (self.enabled == false)
                    return;

                if (!isTouchDevice) {
                    self._cancelTooltipTimer();
                    self._hideToolTip();
                }

                if (self._pointMarker && self._pointMarker.element) {
                    var group = self.seriesGroups[self._pointMarker.gidx];
                    var serie = group.series[self._pointMarker.sidx];
                    self._raiseEvent('click', group, serie, self._pointMarker.iidx);
                }
            });

            if (this.element.style) {
                var sizeInPercentage = false;
                if (this.element.style.width != null) {
                    sizeInPercentage |= this.element.style.width.toString().indexOf('%') != -1;
                }
                if (this.element.style.height != null) {
                    sizeInPercentage |= this.element.style.height.toString().indexOf('%') != -1;
                }
                if (sizeInPercentage) {
                    $(window).resize(function () {
                        if (self.timer) {
                            clearTimeout(self.timer);
                        }
                        var delay = $.jqx.browser.msie ? 200 : 1;
                        self.timer = setTimeout(function () {
                            var tmp = self.enableAnimations;
                            self.enableAnimations = false;
                            self.refresh();
                            self.enableAnimations = tmp;
                        }, delay);
                    });
                }
            }
        }, // createInstance

        _refreshOnDownloadComlete: function () {
            if (this.source instanceof $.jqx.dataAdapter) {
                var me = this;
                var adapteroptions = this.source._options;
                if (adapteroptions == undefined || (adapteroptions != undefined && !adapteroptions.autoBind)) {
                    this.source.autoSync = false;
                    this.source.dataBind();
                }
                if (this.source.records.length == 0) {
                    var updateFunc = function () {
                        // sends a callback function to the user. This allows him to add additional initialization logic before the chart is rendered.
                        if (me.ready) {
                            me.ready();
                        }
                        me.refresh();
                    }
                    this.source.unbindDownloadComplete(this.element.id);
                    this.source.bindDownloadComplete(this.element.id, updateFunc);
                }
                else {
                    // sends a callback function to the user. This allows him to add additional initialization logic before the chart is rendered.
                    if (me.ready) {
                        me.ready();
                    }
                }
                this.source.unbindBindingUpdate(this.element.id);
                this.source.bindBindingUpdate(this.element.id, function () {
                    me.refresh();
                });
            }
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (this.isInitialized == undefined || this.isInitialized == false)
                return;

            if (key == 'source') {
                this._refreshOnDownloadComlete();
            }

            this.refresh();
        },

        //[optimize]
        _internalRefresh: function () {
            // validate visiblity
            if ($.jqx.isHidden(this.host))
                return;

            this._stopAnimations();
            this.host.empty();

            // clears the data.
            this._renderData = new Array();
            var renderer = null;

            if (document.createElementNS && (this.renderEngine == 'SVG' || this.renderEngine == undefined)) {
                renderer = new $.jqx.svgRenderer();
                if (!renderer.init(this.host)) {
                    if (this.renderEngine == 'SVG')
                        throw 'Your browser does not support SVG';

                    return;
                }
            }

            if (renderer == null && this.renderEngine != 'HTML5') {
                renderer = new $.jqx.vmlRenderer();
                if (!renderer.init(this.host)) {
                    if (this.renderEngine == 'VML')
                        throw 'Your browser does not support VML';

                    return;
                }
                this._isVML = true;
            }

            if (renderer == null && (this.renderEngine == 'HTML5' || this.renderEngine == undefined)) {
                renderer = new $.jqx.HTML5Renderer();
                if (!renderer.init(this.host)) {
                    throw 'Your browser does not support HTML5 Canvas';
                }
            }

            this.renderer = renderer;
            var rect = this.renderer.getRect();
            this._render({ x: 1, y: 1, width: rect.width, height: rect.height });

            if (this.renderer instanceof $.jqx.HTML5Renderer) {
                this.renderer.refresh();
            }
        },

        saveAsPNG: function (filename, exportServer) {
            return this._saveAsImage('png', filename, exportServer);
        },

        saveAsJPEG: function (filename, exportServer) {
            return this._saveAsImage('jpeg', filename, exportServer);
        },

        //[optimize]
        _saveAsImage: function (type, fileName, exportServer) {
            if (fileName == undefined || fileName == '')
                fileName = 'chart.' + type;

            if (exportServer == undefined || exportServer == '')
                exportServer = 'http://www.jqwidgets.com/export_server/export.php';

            var renderEngineSaved = this.renderEngine;
            var enableAnimationsSaved = this.enableAnimations;

            this.enableAnimations = false;

            // try switching to HTML5
            this.renderEngine = 'HTML5';

            if (this.renderEngine != renderEngineSaved) {
                try {
                    this.refresh();
                }
                catch (e) {
                    this.renderEngine = renderEngineSaved;
                    this.refresh();
                    this.enableAnimations = enableAnimationsSaved;
                }
            }

            try {
                var canvas = this.renderer.getContainer()[0];
                if (canvas) {
                    var data = canvas.toDataURL("image/" + type);

                    data = data.replace("data:image/" + type + ";base64,", "");
                    var form = document.createElement('form');
                    form.method = 'POST';
                    form.action = exportServer;
                    form.style.display = 'none';
                    document.body.appendChild(form);

                    var inputFName = document.createElement('input');
                    inputFName.name = 'fname';
                    inputFName.value = fileName;
                    inputFName.style.display = 'none';

                    var inputContent = document.createElement('input');
                    inputContent.name = 'content';
                    inputContent.value = data;
                    inputContent.style.display = 'none';

                    form.appendChild(inputFName);
                    form.appendChild(inputContent);

                    form.submit();

                    document.body.removeChild(form);
                }
            }
            catch (e) {
            }

            // switch back to existing engine
            if (this.renderEngine != renderEngineSaved) {
                this.renderEngine = renderEngineSaved;
                this.refresh();
                this.enableAnimations = enableAnimationsSaved;
            }

            return true;
        },

        refresh: function () {
            this._internalRefresh();
        },

        //[optimize]
        _seriesTypes: [
            'line', 'stackedline', 'stackedline100',
            'spline', 'stackedspline', 'stackedspline100',
            'stepline', 'stackedstepline', 'stackedstepline100',
            'area', 'stackedarea', 'stackedarea100',
            'splinearea', 'stackedsplinearea', 'stackedsplinearea100',
            'steparea', 'stackedsteparea', 'stackedsteparea100',
            'rangearea', 'splinerangearea', 'steprangearea',
            'column', 'stackedcolumn', 'stackedcolumn100', 'rangecolumn',
            'pie', 'donut', 'scatter', 'bubble'],

        //[optimize]
        _render: function (rect) {
            this.renderer.clear();

            var bckgImg = this.backgroundImage;
            if (bckgImg == undefined || bckgImg == '')
                this.host.css({ 'background-image': '' });
            else
                this.host.css({ 'background-image': (bckgImg.indexOf('(') != -1 ? bckgImg : "url('" + bckgImg + "')") });

            // build stats
            this._buildStats();
            var padding = this.padding || { left: 5, top: 5, right: 5, bottom: 5 };
            var rFill = this.renderer.rect(rect.x, rect.y, rect.width - 2, rect.height - 2);

            var groupAll = this.renderer.beginGroup();
            var clipAll = this.renderer.createClipRect(rect);
            this.renderer.setClip(groupAll, clipAll);

            if (bckgImg == undefined || bckgImg == '')
                this.renderer.attr(rFill, { fill: this.background || this.backgroundColor || 'white' });
            else
                this.renderer.attr(rFill, { fill: 'transparent' });

            if (this.showBorderLine != false) {
                var borderColor = this.borderLineColor == undefined ? this.borderColor : this.borderLineColor;
                if (borderColor == undefined)
                    borderColor = '#888888';

                var borderLineWidth = this.borderLineWidth;
                if (isNaN(borderLineWidth) || borderLineWidth < 0 || borderLineWidth > 10)
                    borderLineWidth = 1;

                this.renderer.attr(rFill, { 'stroke-width': borderLineWidth, stroke: borderColor });
            }

            var paddedRect = { x: padding.left, y: padding.top, width: rect.width - padding.left - padding.right, height: rect.height - padding.top - padding.bottom };
            this._paddedRect = paddedRect;
            var titlePadding = this.titlePadding || { left: 2, top: 2, right: 2, bottom: 2 };
            if (this.title && this.title.length > 0) {
                var cssTitle = this.toThemeProperty('jqx-chart-title-text', null);
                var sz = this.renderer.measureText(this.title, 0, { 'class': cssTitle });
                this.renderer.text(this.title, paddedRect.x + titlePadding.left, paddedRect.y + titlePadding.top, paddedRect.width - (titlePadding.left + titlePadding.right), sz.height, 0, { 'class': cssTitle }, true, 'center', 'center');
                paddedRect.y += sz.height;
                paddedRect.height -= sz.height;
            }
            if (this.description && this.description.length > 0) {
                var cssDesc = this.toThemeProperty('jqx-chart-title-description', null);
                var sz = this.renderer.measureText(this.description, 0, { 'class': cssDesc });
                this.renderer.text(this.description, paddedRect.x + titlePadding.left, paddedRect.y + titlePadding.top, paddedRect.width - (titlePadding.left + titlePadding.right), sz.height, 0, { 'class': cssDesc }, true, 'center', 'center');

                paddedRect.y += sz.height;
                paddedRect.height -= sz.height;
            }

            if (this.title || this.description) {
                paddedRect.y += (titlePadding.bottom + titlePadding.top);
                paddedRect.height -= (titlePadding.bottom + titlePadding.top);
            }

            var plotRect = { x: paddedRect.x, y: paddedRect.y, width: paddedRect.width, height: paddedRect.height };

            var isPieOnly = this._isPieOnlySeries();

            // axis validation
            var hashCatAxis = {};
            for (var i = 0; i < this.seriesGroups.length && !isPieOnly; i++) {
                if (this.seriesGroups[i].type == 'pie' || this.seriesGroups[i].type == 'donut')
                    continue;

                var swap = this.seriesGroups[i].orientation == 'horizontal';
                var sgvx = this.seriesGroups[i].valueAxis;
                if (!sgvx) {
                    throw 'seriesGroup[' + i + '] is missing ' + (swap ? 'categoryAxis' : 'valueAxis') + ' definition';
                }
                var sghx = this._getCategoryAxis(i);
                if (!sghx) {
                    throw 'seriesGroup[' + i + '] is missing ' + (!swap ? 'categoryAxis' : 'valueAxis') + ' definition';
                }

                var catId = sghx == this.categoryAxis ? -1 : i;
                hashCatAxis[catId] = 0x00;
            }

            var axisPadding = this.axisPadding;
            if (isNaN(axisPadding))
                axisPadding = 5;

            // get vertical axis width
            var wYAxis = { left: 0, right: 0, leftCount: 0, rightCount: 0 };
            var wYAxisArr = [];

            for (var i = 0; i < this.seriesGroups.length; i++) {
                if (this.seriesGroups[i].type == 'pie' || this.seriesGroups[i].type == 'donut') {
                    wYAxisArr.push(0);
                    continue;
                }

                var swap = this.seriesGroups[i].orientation == 'horizontal';
                var catId = this._getCategoryAxis(i) == this.categoryAxis ? -1 : i;
                var w = sgvx.axisSize;
                var axisR = { x: 0, y: plotRect.y, width: plotRect.width, height: plotRect.height };
                var position = undefined;

                if (!w || w == 'auto') {
                    if (swap) {
                        w = this._renderCategoryAxis(i, axisR, true, plotRect).width;
                        if ((hashCatAxis[catId] & 0x01) == 0x01)
                            w = 0;
                        else
                            hashCatAxis[catId] |= 0x01;

                        position = this._getCategoryAxis(i).position;
                    }
                    else {
                        w = this._renderValueAxis(i, axisR, true, plotRect).width;
                        if (this.seriesGroups[i].valueAxis)
                            position = this.seriesGroups[i].valueAxis.position;
                    }
                }

                if (position != 'left' && this.rtl == true)
                    position = 'right';
                if (position != 'right')
                    position = 'left';

                if (wYAxis[position + 'Count'] > 0 && wYAxis[position] > 0 && w > 0)
                    wYAxis[position] += axisPadding;

                wYAxisArr.push({ width: w, position: position, xRel: wYAxis[position] });
                wYAxis[position] += w;
                wYAxis[position + 'Count']++;
            }

            // get horizontal axis height
            var hXAxis = { top: 0, bottom: 0, topCount: 0, bottomCount: 0 };
            var hXAxisArr = [];

            for (var i = 0; i < this.seriesGroups.length; i++) {
                if (this.seriesGroups[i].type == 'pie' || this.seriesGroups[i].type == 'donut') {
                    hXAxisArr.push(0);
                    continue;
                }
                var swap = this.seriesGroups[i].orientation == 'horizontal';
                var sghx = this._getCategoryAxis(i);
                var catId = sghx == this.categoryAxis ? -1 : i;
                position = undefined;

                var h = sghx.axisSize;
                if (!h || h == 'auto') {
                    if (swap) {
                        h = this._renderValueAxis(i, { x: 0, y: 0, width: 10000000, height: 0 }, true, plotRect).height;
                        if (this.seriesGroups[i].valueAxis)
                            position = this.seriesGroups[i].valueAxis.position;
                    }
                    else {
                        h = this._renderCategoryAxis(i, { x: 0, y: 0, width: 10000000, height: 0 }, true).height;
                        if ((hashCatAxis[catId] & 0x02) == 0x02)
                            h = 0;
                        else
                            hashCatAxis[catId] |= 0x02;
                        position = this._getCategoryAxis(i).position;
                    }
                }

                if (position != 'top')
                    position = 'bottom';

                if (hXAxis[position + 'Count'] > 0 && hXAxis[position] > 0 && h > 0)
                    hXAxis[position] += axisPadding;

                hXAxisArr.push({ height: h, position: position, yRel: hXAxis[position] });

                hXAxis[position] += h;
                hXAxis[position + 'Count']++;
            }

            this._plotRect = plotRect;

            var showLegend = (this.showLegend != false);
            var szLegend = !showLegend || this.legendLayout ? { width: 0, height: 0} : this._renderLegend(paddedRect, true);

            if (paddedRect.height < hXAxis.top + hXAxis.bottom + szLegend.height || paddedRect.width < wYAxis.left + wYAxis.right)
                return;

            plotRect.height -= hXAxis.top + hXAxis.bottom + szLegend.height;

            plotRect.x += wYAxis.left;
            plotRect.width -= wYAxis.left + wYAxis.right;
            plotRect.y += hXAxis.top;

            if (!isPieOnly) {
                var lineColor = this.categoryAxis.tickMarksColor || '#888888';

                for (var i = 0; i < this.seriesGroups.length; i++) {
                    var swap = this.seriesGroups[i].orientation == 'horizontal';
                    var catId = this._getCategoryAxis(i) == this.categoryAxis ? -1 : i;
                    var axisR = { x: plotRect.x, y: 0, width: plotRect.width, height: hXAxisArr[i].height };
                    if (hXAxisArr[i].position != 'top')
                        axisR.y = plotRect.y + plotRect.height + hXAxisArr[i].yRel;
                    else
                        axisR.y = plotRect.y - hXAxisArr[i].yRel - hXAxisArr[i].height;

                    if (swap) {
                        this._renderValueAxis(i, axisR, false, plotRect);
                    }
                    else {
                        if ((hashCatAxis[catId] & 0x04) == 0x04)
                            continue;
                        this._renderCategoryAxis(i, axisR, false, plotRect);
                        hashCatAxis[catId] |= 0x04;
                    }
                }
            }

            if (showLegend) {
                var x = plotRect.x + $.jqx._ptrnd((plotRect.width - szLegend.width) / 2);
                var y = plotRect.y + plotRect.height + hXAxis.bottom;
                var w = plotRect.width;
                var h = szLegend.height;
                if (this.legendLayout) {
                    x = this.legendLayout.left || x;
                    y = this.legendLayout.top || y;
                    w = this.legendLayout.width || w;
                    h = this.legendLayout.height || h;
                }
                if (x + w > rect.x + rect.width)
                    w = rect.x + rect.width - x;
                if (y + h > rect.y + rect.height)
                    h = rect.y + rect.height - y;

                this._renderLegend({ x: x, y: y, width: w, height: h });
            }

            this._hasHorizontalLines = false;
            if (!isPieOnly) {
                for (var i = 0; i < this.seriesGroups.length; i++) {
                    var swap = this.seriesGroups[i].orientation == 'horizontal';
                    var axisR = { x: plotRect.x - wYAxisArr[i].xRel - wYAxisArr[i].width, y: plotRect.y, width: wYAxisArr[i].width, height: plotRect.height };
                    if (wYAxisArr[i].position != 'left')
                        axisR.x = plotRect.x + plotRect.width + wYAxisArr[i].xRel;

                    if (swap) {
                        if ((hashCatAxis[this._getCategoryAxis(i)] & 0x08) == 0x08)
                            continue;

                        this._renderCategoryAxis(i, axisR, false, plotRect);
                        hashCatAxis[this._getCategoryAxis(i)] |= 0x08;
                    }
                    else
                        this._renderValueAxis(i, axisR, false, plotRect);
                }
            }

            if (plotRect.width <= 0 || plotRect.height <= 0)
                return;

            this._plotRect = { x: plotRect.x, y: plotRect.y, width: plotRect.width, height: plotRect.height };

            var g = this.renderer.beginGroup();
            var clip = this.renderer.createClipRect({ x: plotRect.x, y: plotRect.y, width: plotRect.width, height: plotRect.height });
            this.renderer.setClip(g, clip);

            this._createAnimationGroup("series");

            for (var i = 0; i < this.seriesGroups.length; i++) {
                var sg = this.seriesGroups[i];
                var isValid = false;
                for (var validtype in this._seriesTypes) {
                    if (this._seriesTypes[validtype] == sg.type) {
                        isValid = true;
                        break;
                    }
                }
                if (!isValid) {
                    throw 'jqxChart: invalid series type "' + sg.type + '"';
                    continue;
                }

                if (sg.bands) {
                    for (var j = 0; j < sg.bands.length; j++)
                        this._renderBand(i, j, plotRect);
                }

                if (sg.type.indexOf('column') != -1)
                    this._renderColumnSeries(i, plotRect);
                else if (sg.type.indexOf('pie') != -1 || sg.type.indexOf('donut') != -1)
                    this._renderPieSeries(i, plotRect);
                else if (sg.type.indexOf('line') != -1 || sg.type.indexOf('area') != -1)
                    this._renderLineSeries(i, plotRect);
                else if (sg.type == 'scatter' || sg.type == 'bubble')
                    this._renderScatterSeries(i, plotRect);
            }

            this._startAnimation("series");

            this.renderer.endGroup();

            if (this.enabled == false) {
                var el = this.renderer.rect(rect.x, rect.y, rect.width, rect.height);
                this.renderer.attr(el, { fill: '#777777', opacity: 0.5, stroke: '#00FFFFFF' });
            }

            this.renderer.endGroup();
        },

        _isPieOnlySeries: function () {
            if (this.seriesGroups.length == 0)
                return false;

            for (var i = 0; i < this.seriesGroups.length; i++) {
                if (this.seriesGroups[i].type != 'pie' && this.seriesGroups[i].type != 'donut')
                    return false;
            }

            return true;
        },

        //[optimize]
        _renderChartLegend: function (data, rect, isMeasure, isVerticalFlow) {
            var r = { x: rect.x + 3, y: rect.y + 3, width: rect.width - 6, height: rect.height - 6 };

            var szMeasure = { width: r.width, height: 0 };

            var x = 0, y = 0;
            var rowH = 20;
            var rowW = 0;
            var barSize = 10;
            var space = 10;
            var maxWidth = 0;
            for (var i = 0; i < data.length; i++) {
                var css = data[i].css;
                if (!css)
                    css = this.toThemeProperty('jqx-chart-legend-text', null);

                var text = data[i].text;
                var sz = this.renderer.measureText(text, 0, { 'class': css });
                if (sz.height > rowH)
                    rowH = sz.height;

                if (sz.width > maxWidth)
                    maxWidth = sz.width;

                if (isVerticalFlow) {
                    if (i != 0)
                        y += rowH;

                    if (y > r.height) {
                        y = 0;
                        x += maxWidth + space;
                        maxWidth = sz.width;
                        szMeasure.width = x + maxWidth;
                    }
                }
                else {
                    if (x != 0)
                        x += space;

                    if (x + 2 * barSize + sz.width > r.width && sz.width < r.width) {
                        x = 0;
                        y += rowH;
                        rowH = 20;
                        rowW = r.width;
                        szMeasure.heigh = y + rowH;
                    }
                }

                if (!isMeasure &&
                    r.x + x + sz.width < rect.x + rect.width &&
                    r.y + y + sz.height < rect.y + rect.height
                  ) {
                    var color = data[i].color;
                    var elem = this.renderer.rect(r.x + x, r.y + y + barSize / 2, barSize, barSize);
                    this.renderer.attr(elem, { fill: color, 'fill-opacity': data[i].opacity, stroke: color, 'stroke-width': 1 });
                    this.renderer.text(text, r.x + x + 1.5 * barSize, r.y + y, sz.width, rowH, 0, { 'class': css }, false, 'center', 'center');

                    /*
                    var g = this.seriesGroups[data[i].groupIndex];
                    var s = g.series[data[i].seriesIndex];

                    var enableSeriesToggle = s.enableSeriesToggle;
                    if (enableSeriesToggle == undefined)
                    enableSeriesToggle = g.enableSeriesToggle == true;

                    if (enableSeriesToggle && data[i].itemIndex == undefined) {
                    var self = this;
                    this.renderer.addHandler(elem, 'click', function (e) {
                    e.preventDefault();
                    });
                    }*/

                }

                if (isVerticalFlow) {
                }
                else {
                    x += sz.width + 2 * barSize;
                    if (rowW < x)
                        rowW = x;
                }

            }

            if (isMeasure) {
                szMeasure.height = $.jqx._ptrnd(y + rowH);
                szMeasure.width = $.jqx._ptrnd(rowW);
                return szMeasure;
            }
        },


        //[optimize]
        _renderLegend: function (rect, isMeasure) {
            var legendData = [];
            for (var gidx = 0; gidx < this.seriesGroups.length; gidx++) {
                var g = this.seriesGroups[gidx];
                if (g.showLegend == false)
                    continue;

                var categoryAxis = this._getCategoryAxis(gidx);
                var catfs = categoryAxis.toolTipFormatSettings || categoryAxis.formatSettings;
                var catff = categoryAxis.toolTipFormatFunction || categoryAxis.formatFunction;

                for (var sidx = 0; sidx < g.series.length; sidx++) {
                    var s = g.series[sidx];
                    if (s.showLegend == false)
                        continue;

                    var settings = this._getSerieSettings(gidx, sidx);

                    if (g.type == 'pie' || g.type == 'donut') {
                        var colorScheme = s.colorScheme || g.colorScheme || this.colorScheme;
                        var dataLength = this._getDataLen(gidx);
                        for (var i = 0; i < dataLength; i++) {
                            var legendText = this._getDataValue(i, s.displayText, gidx);
                            legendText = this._formatValue(legendText, catfs, catff);

                            var color = this._getColor(colorScheme, sidx * dataLength + i, gidx, sidx);

                            legendData.push({ groupIndex: gidx, seriesIndex: sidx, itemIndex: i, text: legendText, css: s.displayTextClass, color: color, opacity: settings.opacity });
                        }

                        continue;
                    }

                    var text = s.displayText || s.dataField || '';
                    var color = this._getSeriesColor(gidx, sidx);

                    legendData.push({ groupIndex: gidx, seriesIndex: sidx, text: text, css: s.displayTextClass, color: color, opacity: settings.opacity });
                }
            }

            return this._renderChartLegend(legendData, rect, isMeasure, (this.legendLayout && this.legendLayout.flow == 'vertical'));
        },

        //[optimize]
        _renderCategoryAxis: function (groupIndex, rect, isMeasure, chartRect) {
            var axis = this._getCategoryAxis(groupIndex);
            var swapXY = this.seriesGroups[groupIndex].orientation == 'horizontal';
            var szMeasure = { width: 0, height: 0 };
            if (!axis || axis.visible == false)
                return szMeasure;

            if (this.rtl) {
                axis.flip = true;
            }

            var text = axis.text;

            var gridLinesSettings = { visible: (axis.showGridLines != false), color: (axis.gridLinesColor || '#888888'), unitInterval: (axis.gridLinesInterval || axis.unitInterval), dashStyle: axis.gridLinesDashStyle };
            var tickMarksSettings = { visible: (axis.showTickMarks != false), color: (axis.tickMarksColor || '#888888'), unitInterval: (axis.tickMarksInterval || axis.unitInterval), dashStyle: axis.tickMarksDashStyle };

            var textRotationAngle = axis.textRotationAngle || 0;

            var offsetR = rect;
            if (swapXY)
                offsetR = { x: rect.x, y: rect.y, width: rect.height, height: rect.width };
            var offsets = this._calculateXOffsets(groupIndex, offsetR);
            var ui = axis.unitInterval;
            if (isNaN(ui))
                ui = 1;

            var hTextAlign = axis.horizontalTextAlignment;
            var valuesOnTicks = this._alignValuesWithTicks(groupIndex);

            var widgetRect = this.renderer.getRect();
            var paddingRight = widgetRect.width - rect.x - rect.width;
            var len = this._getDataLen(groupIndex);

            var items = [];
            if (axis.type != 'date') {
                var isCustomRange = offsets.customRange != false;
                var step = ui;
                for (var i = offsets.min; i <= offsets.max; i += step) {
                    if (isCustomRange || axis.dataField == undefined || axis.dataField == '') {
                        value = i;
                    }
                    else {
                        var idx = Math.round(i);

                        value = this._getDataValue(idx, axis.dataField);
                    }

                    var text = this._formatValue(value, axis.formatSettings, axis.formatFunction, undefined, undefined, idx);
                    if (text == undefined)
                        text = !isCustomRange ? value.toString() : (i).toString();

                    items.push(text);

                    if (i + step > offsets.max) {
                        step = offsets.max - i;
                        if (step <= ui / 2)
                            break;
                    }
                }
            }
            else {
                var arr = this._getDateTimeArray(offsets.min, offsets.max, axis.baseUnit, valuesOnTicks, ui);
                for (var i = 0; i < arr.length; i += ui)
                    items.push(this._formatValue(arr[i], axis.formatSettings, axis.formatFunction));
            }

            if (axis.flip == true || this.rtl)
                items.reverse();

            var cssDesc = axis.descriptionClass;
            if (!cssDesc)
                cssDesc = this.toThemeProperty('jqx-chart-axis-description', null);

            var cssItems = axis['class'];
            if (!cssItems)
                cssItems = this.toThemeProperty('jqx-chart-axis-text', null);

            if (swapXY)
                textRotationAngle -= 90;

            var axisTextSettings = { text: axis.description, style: cssDesc, halign: axis.horizontalDescriptionAlignment || 'center', valign: axis.verticalDescriptionAlignment || 'center', textRotationAngle: swapXY ? -90 : 0 };
            var itemsTextSettings = { textRotationAngle: textRotationAngle, style: cssItems, halign: hTextAlign, valign: axis.verticalTextAlignment || 'center', textRotationPoint: axis.textRotationPoint || 'auto', textOffset: axis.textOffset };

            var isMirror = (swapXY && axis.position == 'right') || (!swapXY && axis.position == 'top');

            return this._renderAxis(swapXY, isMirror, axisTextSettings, itemsTextSettings, { x: rect.x, y: rect.y, width: rect.width, height: rect.height }, chartRect, ui, false, valuesOnTicks, items, offsets, gridLinesSettings, tickMarksSettings, isMeasure);
        },

        _renderAxis: function (isVertical, isMirror, axisTextSettings, textSettings, rect, chartRect, ui, isLogAxis, valuesOnTicks, items, offsets, gridLinesSettings, tickMarksSettings, isMeasure) {
            var tickMarkSize = tickMarksSettings.visible ? 4 : 0;
            var padding = 2;

            var szMeasure = { width: 0, height: 0 };
            var szMeasureDesc = { width: 0, height: 0 };

            if (isVertical)
                szMeasure.height = szMeasureDesc.height = rect.height;
            else
                szMeasure.width = szMeasureDesc.width = rect.width;

            if (!isMeasure && isMirror) {
                if (isVertical)
                    rect.x -= rect.width;
            }

            if (axisTextSettings.text != undefined && axisTextSettings != '') {
                var textRotationAngle = axisTextSettings.textRotationAngle;
                var sz = this.renderer.measureText(axisTextSettings.text, textRotationAngle, { 'class': axisTextSettings.style });
                szMeasureDesc.width = sz.width;
                szMeasureDesc.height = sz.height;

                if (!isMeasure) {
                    this.renderer.text(
                        axisTextSettings.text,
                        rect.x + (isVertical ? (!isMirror ? padding : -padding + 2 * rect.width - szMeasureDesc.width) : 0),
                        rect.y + (!isVertical ? (!isMirror ? rect.height - padding - szMeasureDesc.height : padding) : 0),
                        isVertical ? szMeasureDesc.width : rect.width,
                        !isVertical ? szMeasureDesc.height : rect.height,
                        textRotationAngle,
                        { 'class': axisTextSettings.style },
                        true,
                        axisTextSettings.halign,
                        axisTextSettings.valign);
                }
            }

            var offset = 0;
            var textXAdjust = valuesOnTicks ? -offsets.itemWidth / 2 : 0;

            if (valuesOnTicks && !isVertical) {
                textSettings.halign = 'center';
            }

            var baseX = rect.x;
            var baseY = rect.y;

            var userOffset = textSettings.textOffset;
            if (userOffset) {
                if (!isNaN(userOffset.x))
                    baseX += userOffset.x;
                if (!isNaN(userOffset.y))
                    baseY += userOffset.y;
            }

            if (!isVertical) {
                baseX += textXAdjust;
                if (isMirror) {
                    baseY += szMeasureDesc.height > 0 ? szMeasureDesc.height + 3 * padding : 2 * padding;
                    baseY += tickMarkSize - (valuesOnTicks ? tickMarkSize : tickMarkSize / 4);
                }
                else {
                    baseY += valuesOnTicks ? tickMarkSize : tickMarkSize / 4;
                }
            }
            else {
                baseX += padding + (szMeasureDesc.width > 0 ? (szMeasureDesc.width + padding) : 0) + (isMirror ? rect.width - szMeasureDesc.width : 0);
                baseY += textXAdjust;
            }


            var h = 0;
            var w = 0;
            var itemWidth = offsets.itemWidth;
            for (var i = 0; i < items.length; i++, offset += itemWidth) {
                var text = items[i];

                var textAngle = textSettings.textRotationAngle;

                var sz = this.renderer.measureText(text, textAngle, { 'class': textSettings.style });
                if (sz.width > w)
                    w = sz.width;
                if (sz.height > h)
                    h = sz.height;

                if (!isMeasure) {
                    if ((isVertical && offset > rect.height + 2) || (!isVertical && offset > rect.width + 2))
                        break;

                    if (!isLogAxis || (isLogAxis && (i % ui) == 0)) {
                        this.renderer.text(
                        text,
                        isVertical ? baseX : baseX + offset,
                        isVertical ? baseY + offset : baseY,
                        !isVertical ? itemWidth : rect.width - 2 * padding - tickMarkSize - ((szMeasureDesc.width > 0) ? szMeasureDesc.width + padding : 0),
                        isVertical ? itemWidth : rect.height - 2 * padding - tickMarkSize - ((szMeasureDesc.height > 0) ? szMeasureDesc.height + padding : 0),
                        textAngle,
                        { 'class': textSettings.style },
                        false,
                        textSettings.halign,
                        textSettings.valign,
                        textSettings.textRotationPoint);
                    }
                }
            }

            szMeasure.width += 2 * padding + tickMarkSize + szMeasureDesc.width + w + (isVertical && szMeasureDesc.width > 0 ? padding : 0);
            szMeasure.height += 2 * padding + tickMarkSize + szMeasureDesc.height + h + (!isVertical && szMeasureDesc.height > 0 ? padding : 0);

            var gridLinePts = {};
            var strokeAttributes = { stroke: gridLinesSettings.color, 'stroke-width': 1, 'stroke-dasharray': gridLinesSettings.dashStyle || '' };


            if (!isMeasure) {
                var y = $.jqx._ptrnd(rect.y + (isMirror ? rect.height : 0));
                if (isVertical)
                    this.renderer.line($.jqx._ptrnd(rect.x + rect.width), rect.y, $.jqx._ptrnd(rect.x + rect.width), rect.y + rect.height, strokeAttributes);
                else {
                    this.renderer.line($.jqx._ptrnd(rect.x), y, $.jqx._ptrnd(rect.x + rect.width + 1), y, strokeAttributes);
                }
            }

            var rndErr = 0.5;

            // render vertical grid lines
            if (!isMeasure && gridLinesSettings.visible != false) {
                var gridLinesInterval = gridLinesSettings.unitInterval;
                if (isNaN(gridLinesInterval) || gridLinesInterval <= 0)
                    gridLinesInterval = ui;

                var len = isLogAxis ? items.length : offsets.rangeLength;
                var step = isLogAxis ? 1 : gridLinesInterval;
                var offsetStep = isLogAxis ? itemWidth : (isVertical ? rect.height : rect.width) / offsets.rangeLength;
                var i = 0;
                while (i <= len) {
                    if (isLogAxis && (i % gridLinesInterval) != 0) {
                        i += step;
                        continue;
                    }

                    var lineOffset = 0;

                    if (isVertical) {
                        lineOffset = $.jqx._ptrnd(rect.y + i * offsetStep);
                        if (lineOffset > rect.y + rect.height + rndErr)
                            break;
                    }
                    else {
                        lineOffset = $.jqx._ptrnd(rect.x + i * offsetStep);
                        if (lineOffset > rect.x + rect.width + rndErr)
                            break;
                    }

                    if (isVertical)
                        this.renderer.line($.jqx._ptrnd(chartRect.x), lineOffset, $.jqx._ptrnd(chartRect.x + chartRect.width), lineOffset, strokeAttributes);
                    else
                        this.renderer.line(lineOffset, $.jqx._ptrnd(chartRect.y), lineOffset, $.jqx._ptrnd(chartRect.y + chartRect.height), strokeAttributes);

                    gridLinePts[lineOffset] = true;

                    i += step;
                    if (i > len && i != len + step)
                        i = len;
                }
            }

            // render category axis tick marks
            var strokeAttributes = { stroke: tickMarksSettings.color, 'stroke-width': 1, 'stroke-dasharray': tickMarksSettings.dashStyle || '' };

            if (!isMeasure && tickMarksSettings.visible) {
                var tickMarksInterval = tickMarksSettings.unitInterval;
                if (isNaN(tickMarksInterval) || tickMarksInterval <= 0)
                    tickMarksInterval = ui;

                var len = isLogAxis ? items.length : offsets.rangeLength + tickMarksInterval;
                var step = isLogAxis ? 1 : tickMarksInterval;
                var offsetStep = isLogAxis ? itemWidth : (isVertical ? rect.height : rect.width) / offsets.rangeLength;

                for (var i = 0; i <= len; i += step) {
                    if (isLogAxis && (i % tickMarksInterval / ui) != 0)
                        continue;

                    var lineOffset = $.jqx._ptrnd((isVertical ? rect.y : rect.x) + i * offsetStep);

                    if (gridLinePts[lineOffset - 1])
                        lineOffset--;
                    else if (gridLinePts[lineOffset + 1])
                        lineOffset++;

                    if (isVertical) {
                        if (lineOffset > rect.y + rect.height + rndErr)
                            break;
                    }
                    else {
                        if (lineOffset > rect.x + rect.width + rndErr)
                            break;
                    }

                    var tickSize = !isMirror ? -tickMarkSize : tickMarkSize;
                    if (isVertical) {
                        this.renderer.line(rect.x + rect.width, lineOffset, rect.x + rect.width + tickSize, lineOffset, strokeAttributes);
                    }
                    else {
                        var y = $.jqx._ptrnd(rect.y + (isMirror ? rect.height : 0));
                        this.renderer.line(lineOffset, y, lineOffset, y - tickSize, strokeAttributes);
                    }
                }
            }

            szMeasure.width = $.jqx._rup(szMeasure.width);
            szMeasure.height = $.jqx._rup(szMeasure.height);

            return szMeasure;
        },

        //[optimize]
        _renderValueAxis: function (groupIndex, rect, isMeasure, chartRect) {
            var g = this.seriesGroups[groupIndex];
            var swapXY = g.orientation == 'horizontal';
            var axis = g.valueAxis;
            if (!axis)
                throw 'SeriesGroup ' + groupIndex + ' is missing valueAxis definition';

            var szMeasure = { width: 0, height: 0 };

            if (this._isPieOnlySeries()) {
                if (isMeasure)
                    return szMeasure;

                return;
            }

            var gstat = this._stats.seriesGroups[groupIndex];
            if (!gstat || !gstat.isValid || false == axis.displayValueAxis || false == axis.visible) {
                if (isMeasure)
                    return szMeasure;
                return;
            }

            var cssDesc = axis.descriptionClass;
            if (!cssDesc)
                cssDesc = this.toThemeProperty('jqx-chart-axis-description', null);

            var axisTextSettings = {
                text: axis.description,
                style: cssDesc,
                halign: axis.horizontalDescriptionAlignment || 'center',
                valign: axis.verticalDescriptionAlignment || 'center',
                textRotationAngle: swapXY ? 0 : (!this.rtl ? -90 : 90)
            };

            var cssItems = axis.itemsClass;
            if (!cssItems)
                cssItems = this.toThemeProperty('jqx-chart-axis-text', null);

            var itemsTextSettings =
            {
                style: cssItems,
                halign: axis.horizontalTextAlignment || 'center',
                valign: axis.verticalTextAlignment || 'center',
                textRotationAngle: axis.textRotationAngle || 0,
                textRotationPoint: axis.textRotationPoint || 'auto',
                textOffset: axis.textOffset
            };

            var valuesOnTicks = axis.valuesOnTicks != false;

            var field = axis.dataField;
            var ints = gstat.intervals;

            var min = gstat.min;
            var mu = gstat.mu;

            var format = axis.formatSettings;
            var isStacked100 = g.type.indexOf("stacked") != -1 && g.type.indexOf("100") != -1;
            if (isStacked100 && !format)
                format = { sufix: '%' };

            if (!valuesOnTicks) {
                ints = Math.max(ints - 1, 1);
            }

            var logAxis = axis.logarithmicScale == true;
            var logBase = axis.logarithmicScaleBase || 10;

            if (logAxis) {
                mu = !isNaN(axis.unitInterval) ? axis.unitInterval : 1;
            }

            var unitH = (swapXY ? rect.width : rect.height) / ints;
            var yOffset = rect.y + rect.height - unitH;

            var items = [];
            var offsets = {};
            offsets.data = [];
            offsets.itemWidth = unitH;

            for (var i = 0; i <= ints; i++) {
                var value = 0;
                if (logAxis) {
                    if (isStacked100)
                        value = gstat.max / Math.pow(logBase, ints - i);
                    else
                        value = min * Math.pow(logBase, i);
                }
                else {
                    value = valuesOnTicks ? min + i * mu : min + (i + 0.5) * mu;
                }

                var text = (axis.formatFunction) ? axis.formatFunction(value) : this._formatNumber(value, format);

                items.push(text);
                offsets.data.push(yOffset + unitH / 2);

                yOffset -= unitH;
            }

            offsets.rangeLength = logAxis && !isStacked100 ? gstat.intervals : (gstat.intervals) * mu;

            if (g.valueAxis.flip != true) {
                offsets.data = offsets.data.reverse();
                items = items.reverse();
            }

            var gridLinesInterval = axis.gridLinesInterval || axis.unitInterval;
            if (isNaN(gridLinesInterval) || (logAxis && gridLinesInterval < mu))
                gridLinesInterval = mu;

            var gridLinesSettings = { visible: (axis.showGridLines != false), color: (axis.gridLinesColor || '#888888'), unitInterval: gridLinesInterval, dashStyle: axis.gridLinesDashStyle };

            var tickMarksInterval = axis.tickMarksInterval || axis.unitInterval;
            if (isNaN(tickMarksInterval) || (logAxis && tickMarksInterval < mu))
                tickMarksInterval = mu;

            var tickMarksSettings = { visible: (axis.showTickMarks != false), color: (axis.tickMarksColor || '#888888'), unitInterval: tickMarksInterval, dashStyle: axis.tickMarksDashStyle };

            var isMirror = (swapXY && axis.position == 'top') || (!swapXY && axis.position == 'right') || (!swapXY && this.rtl && axis.position != 'left'); ;

            return this._renderAxis(!swapXY, isMirror, axisTextSettings, itemsTextSettings, rect, chartRect, mu, logAxis, valuesOnTicks, items, offsets, gridLinesSettings, tickMarksSettings, isMeasure);
        },

        //[optimize]
        _buildStats: function () {
            var stat = { seriesGroups: new Array() };
            this._stats = stat;

            for (var g = 0; g < this.seriesGroups.length; g++) {
                var group = this.seriesGroups[g];
                stat.seriesGroups[g] = {};
                var grst = stat.seriesGroups[g];
                grst.isValid = true;

                var hasValueAxis = group.valueAxis != undefined;

                var logAxis = false;
                var logBase = 10;

                if (hasValueAxis) {
                    logAxis = group.valueAxis.logarithmicScale == true;
                    logBase = group.valueAxis.logarithmicScaleBase;
                    if (isNaN(logBase))
                        logBase = 10;
                }

                var isStacked = -1 != group.type.indexOf("stacked");
                var isStacked100 = isStacked && -1 != group.type.indexOf("100");
                var isRange = -1 != group.type.indexOf("range");

                if (isStacked100) {
                    grst.psums = new Array();
                    grst.nsums = new Array();
                }

                var gmin = NaN, gmax = NaN;
                var gsumP = NaN, gsumN = NaN;
                var gbase = group.baselineValue;
                if (isNaN(gbase))
                    gbase = logAxis && !isStacked100 ? 1 : 0;

                var len = this._getDataLen(g);
                var gMaxRange = 0;
                var minPercent = NaN;
                for (var i = 0; i < len && grst.isValid; i++) {
                    var min = hasValueAxis ? group.valueAxis.minValue : Infinity;
                    var max = hasValueAxis ? group.valueAxis.maxValue : -Infinity;
                    var sumP = 0, sumN = 0;

                    for (var s = 0; s < group.series.length; s++) {
                        var valMax = undefined, valMin = undefined;
                        if (isRange) {
                            var valFrom = this._getDataValueAsNumber(i, group.series[s].dataFieldFrom, g);
                            var valTo = this._getDataValueAsNumber(i, group.series[s].dataFieldTo, g);
                            valMax = Math.max(valFrom, valTo);
                            valMin = Math.min(valFrom, valTo);
                        }
                        else {
                            var val = this._getDataValueAsNumber(i, group.series[s].dataField, g);
                            if (isNaN(val) || (logAxis && val <= 0))
                                continue;

                            valMin = valMax = val;
                        }


                        if ((isNaN(max) || valMax > max) && ((!hasValueAxis || isNaN(group.valueAxis.maxValue)) ? true : valMax <= group.valueAxis.maxValue))
                            max = valMax;
                        if ((isNaN(min) || valMin < min) && ((!hasValueAxis || isNaN(group.valueAxis.minValue)) ? true : valMin >= group.valueAxis.minValue))
                            min = valMin;

                        if (val > gbase)
                            sumP += val;
                        else if (val < gbase)
                            sumN += val;
                    }

                    if (logAxis && isStacked100) {
                        for (var s = 0; s < group.series.length; s++) {
                            var val = this._getDataValueAsNumber(i, group.series[s].dataField, g);
                            if (isNaN(val) || val <= 0)
                                continue;

                            var p = sumP == 0 ? 0 : val / sumP;
                            if (isNaN(minPercent) || p < minPercent)
                                minPercent = p;
                        }
                    }

                    var range = sumP - sumN;
                    if (gMaxRange < range)
                        gMaxRange = range;

                    if (isStacked100) {
                        grst.psums[i] = sumP;
                        grst.nsums[i] = sumN;
                    }

                    if (max > gmax || isNaN(gmax))
                        gmax = max;
                    if (min < gmin || isNaN(gmin))
                        gmin = min;

                    if (sumP > gsumP || isNaN(gsumP))
                        gsumP = sumP;
                    if (sumN < gsumN || isNaN(gsumN))
                        gsumN = sumN;
                }

                if (isStacked100) {
                    gsumP = gsumP == 0 ? 0 : Math.max(gsumP, -gsumN);
                    gsumN = gsumN == 0 ? 0 : Math.min(gsumN, -gsumP);
                }

                var mu = hasValueAxis ? group.valueAxis.unitInterval : 0;
                if (!mu) {
                    mu = isStacked ? (gsumP - gsumN) / 10 : (gmax - gmin) / 10;
                }

                var intervals = NaN;

                ///
                // log axis scale
                var minPow = 0;
                var maxPow = 0;
                if (logAxis) {
                    if (isStacked100) {
                        intervals = 0;
                        var p = 1;
                        minPow = maxPow = $.jqx.log(100, logBase);

                        while (p > minPercent) {
                            p /= logBase;
                            minPow--;
                            intervals++;
                        }
                        gmin = Math.pow(logBase, minPow);

                    }
                    else {
                        if (isStacked)
                            gmax = Math.max(gmax, gsumP);

                        maxPow = $.jqx._rnd($.jqx.log(gmax, logBase), 1, true);
                        gmax = Math.pow(logBase, maxPow);

                        minPow = $.jqx._rnd($.jqx.log(gmin, logBase), 1, false);
                        gmin = Math.pow(logBase, minPow);
                    }

                    mu = logBase;
                }
                ////

                var tickMarksInterval = hasValueAxis ? group.valueAxis.tickMarksInterval || mu : 0;
                var gridLinesInterval = hasValueAxis ? group.valueAxis.gridLinesInterval || mu : 0;

                if (gmin < gsumN)
                    gsumN = gmin;
                if (gmax > gsumP)
                    gsumP = gmax;

                var mn = logAxis ? gmin : $.jqx._rnd(isStacked ? gsumN : gmin, mu, false);
                var mx = logAxis ? gmax : $.jqx._rnd(isStacked ? gsumP : gmax, mu, true);
                if (isStacked100 && mx > 100)
                    mx = 100;

                if (isStacked100 && !logAxis) {
                    mx = (mx > 0) ? 100 : 0;
                    mn = (mn < 0) ? -100 : 0;
                    mu = hasValueAxis ? group.valueAxis.unitInterval : 10;
                    if (isNaN(mu) || mu <= 0 || mu >= 100)
                        mu = 10;
                    if (tickMarksInterval <= 0 || tickMarksInterval >= 100)
                        tickMarksInterval = 10;
                    if (gridLinesInterval <= 0 || gridLinesInterval >= 100)
                        gridLinesInterval = 10;
                }

                if (isNaN(mx) || isNaN(mn) || isNaN(mu))
                    continue;

                if (isNaN(intervals))
                    intervals = (mx - mn) / (mu == 0 ? 1 : mu);

                if (logAxis && !isStacked100) {
                    intervals = maxPow - minPow;
                    gMaxRange = Math.pow(logBase, intervals);
                }

                if (intervals < 1)
                    continue;

                var diff = mx - mn;
                grst.rmax = isStacked ? gsumP : gmax;
                grst.rmin = isStacked ? gsumN : gmin;
                grst.min = mn;
                grst.max = mx;
                grst.minPow = minPow;
                grst.maxPow = maxPow;
                grst.mu = mu;
                grst.maxRange = gMaxRange;
                grst.intervals = intervals;
                grst.tickMarksInterval = tickMarksInterval;
                grst.tickMarksIntervals = tickMarksInterval == 0 ? 0 : diff / tickMarksInterval;
                grst.gridLinesInterval = gridLinesInterval;
                grst.gridLinesIntervals = gridLinesInterval == 0 ? 0 : diff / gridLinesInterval;
                if (diff == 0)
                    diff = 1;
                grst.scale = isStacked ? (gsumP - gsumN) / diff : (gmax - gmin) / diff;
            }
        },

        //[optimize]
        _getDataLen: function (groupIndex) {
            var ds = this.source;
            if (groupIndex != undefined && groupIndex != -1 && this.seriesGroups[groupIndex].source)
                ds = this.seriesGroups[groupIndex].source;

            if (ds instanceof $.jqx.dataAdapter)
                ds = ds.records;

            if (ds)
                return ds.length;

            return 0;
        },

        //[optimize]
        _getDataValue: function (index, dataField, groupIndex) {
            var ds = this.source;
            if (groupIndex != undefined && groupIndex != -1)
                ds = this.seriesGroups[groupIndex].source || ds;

            if (ds instanceof $.jqx.dataAdapter)
                ds = ds.records;

            if (!ds || index < 0 || index > ds.length - 1)
                return NaN;

            return (dataField && dataField != '') ? ds[index][dataField] : ds[index];
        },

        //[optimize]
        _getDataValueAsNumber: function (index, dataField, groupIndex) {
            var val = this._getDataValue(index, dataField, groupIndex);
            if (this._isDate(val))
                return val.valueOf();

            if (typeof (val) != 'number')
                val = parseFloat(val);
            if (typeof (val) != 'number')
                val = undefined;
            return val;
        },

        //[optimize]
        _renderPieSeries: function (groupIndex, rect) {
            var dataLength = this._getDataLen(groupIndex);
            var group = this.seriesGroups[groupIndex];

            while (this._renderData.length < groupIndex + 1)
                this._renderData.push(null);

            this._renderData[groupIndex] = [];

            for (var sidx = 0; sidx < group.series.length; sidx++) {
                var s = group.series[sidx]

                var settings = this._getSerieSettings(groupIndex, sidx);

                var colorScheme = s.colorScheme || group.colorScheme || this.colorScheme;
                var initialAngle = s.initialAngle || 0;
                var currentAngle = initialAngle;
                var radius = s.radius || Math.min(rect.width, rect.height) * 0.4;
                if (isNaN(radius))
                    radius = 1;

                var innerRadius = s.innerRadius || 0;
                if (isNaN(innerRadius) || innerRadius >= radius)
                    innerRadius = 0;

                var centerOffset = s.centerOffset || 0;
                var offsetX = $.jqx.getNum([s.offsetX, group.offsetX, rect.width / 2]);
                var offsetY = $.jqx.getNum([s.offsetY, group.offsetY, rect.height / 2]);

                var anim = this._getAnimProps(groupIndex, sidx);
                var duration = anim.enabled && dataLength < 5000 && this._isVML != true ? anim.duration : 0;
                if ($.jqx.mobile.isMobileBrowser() && (this.renderer instanceof $.jqx.HTML5Renderer))
                    duration = 0;

                this._renderData[groupIndex].push([]);

                // compute the sum
                var sumP = 0;
                var sumN = 0;
                for (var i = 0; i < dataLength; i++) {
                    var val = this._getDataValueAsNumber(i, s.dataField, groupIndex);
                    if (isNaN(val))
                        continue;
                    if (val > 0)
                        sumP += val;
                    else
                        sumN += val;
                }

                var range = sumP - sumN;
                if (range == 0)
                    range = 1;

                // render
                for (var i = 0; i < dataLength; i++) {
                    var val = this._getDataValueAsNumber(i, s.dataField, groupIndex);
                    if (isNaN(val))
                        continue;

                    var angle = Math.round(Math.abs(val) / range * 360.0);
                    if (i + 1 == dataLength)
                        angle = 360 + initialAngle - currentAngle;

                    var x = rect.x + offsetX;
                    var y = rect.y + offsetY;

                    var sliceRenderData = { x1: x, y1: y, innerRadius: innerRadius, outerRadius: radius, key: groupIndex + '_' + sidx + '_' + i };
                    this._renderData[groupIndex][sidx].push(sliceRenderData);


                    var pieSliceElement = this.renderer.pieslice(x, y, innerRadius, radius, currentAngle, duration == 0 ? currentAngle + angle : currentAngle, centerOffset);

                    var centerOffsetValue = centerOffset;
                    if ($.isFunction(centerOffset)) {
                        centerOffsetValue = centerOffset({ seriesIndex: sidx, seriesGroupIndex: groupIndex, itemIndex: i });
                    }
                    if (isNaN(centerOffsetValue))
                        centerOffsetValue = 0;

                    var ctx = { x: x, y: y, innerRadius: innerRadius, outerRadius: radius, fromAngle: currentAngle, toAngle: currentAngle + angle, centerOffset: centerOffsetValue };
                    var self = this;
                    this._enqueueAnimation(
                        "series",
                        pieSliceElement,
                        undefined,
                        duration,
                        function (element, ctx, percent) {
                            var toAngle = ctx.fromAngle + percent * (ctx.toAngle - ctx.fromAngle);
                            var cmd = self.renderer.pieSlicePath(ctx.x, ctx.y, ctx.innerRadius, ctx.outerRadius, ctx.fromAngle, toAngle, ctx.centerOffset);
                            self.renderer.attr(element, { 'd': cmd });
                        },
                        ctx);

                    var colors = this._getColors(groupIndex, sidx, i, 'radialGradient', radius);

                    this.renderer.attr(pieSliceElement, { fill: colors.fillColor, stroke: colors.lineColor, 'stroke-width': settings.stroke, 'fill-opacity': settings.opacity, 'stroke-dasharray': settings.dashStyle });

                    ///////////////////////////////
                    // render label
                    var angleFrom = currentAngle, angleTo = currentAngle + angle;
                    var diff = Math.abs(angleFrom - angleTo);
                    var lFlag = diff > 180 ? 1 : 0;
                    if (diff > 360) {
                        angleFrom = 0;
                        angleTo = 360;
                    }

                    var radFrom = angleFrom * Math.PI * 2 / 360;
                    var radTo = angleTo * Math.PI * 2 / 360;
                    var midAngle = diff / 2 + angleFrom;
                    var radMid = midAngle * Math.PI * 2 / 360;

                    // measure
                    var sz = this._showLabel(groupIndex, sidx, i, { x: 0, y: 0, width: 0, height: 0 }, 'left', 'top', true);
                    var labelRadius = s.labelRadius || radius + Math.max(sz.width, sz.height);
                    labelRadius += centerOffset;
                    var x = $.jqx._ptrnd(rect.x + offsetX + labelRadius * Math.cos(radMid) - sz.width / 2);
                    var y = $.jqx._ptrnd(rect.y + offsetY - labelRadius * Math.sin(radMid) - sz.height / 2);

                    // render
                    this._showLabel(groupIndex, sidx, i, { x: x, y: y, width: sz.width, height: sz.height }, 'left', 'top');
                    /////////////////////////////////

                    // Install mouse event handlers
                    this._installHandlers(pieSliceElement, groupIndex, sidx, i);

                    currentAngle += angle;
                }
            }
        },

        //[optimize]
        _getColumnGroupsCount: function (orientation) {
            var cnt = 0;
            orientation = orientation || 'vertical';
            var sg = this.seriesGroups;
            for (var i = 0; i < sg.length; i++) {
                var groupOrientation = sg[i].orientation || 'vertical';
                if (sg[i].type.indexOf('column') != -1 && groupOrientation == orientation)
                    cnt++;
            }

            return cnt;
        },

        //[optimize]
        _getColumnGroupIndex: function (groupIndex) {
            var idx = 0;
            var orientation = this.seriesGroups[groupIndex].orientation || 'vertical';
            for (var i = 0; i < groupIndex; i++) {
                var sg = this.seriesGroups[i];
                var sgOrientation = sg.orientation || 'vertical';
                if (sg.type.indexOf('column') != -1 && sgOrientation == orientation)
                    idx++;
            }

            return idx;
        },

        //[optimize]
        _renderBand: function (groupIndex, bandIndex, rect) {
            var group = this.seriesGroups[groupIndex];
            if (!group.bands || group.bands.length <= bandIndex)
                return;
            var gRect = rect;
            if (group.orientation == 'horizontal')
                gRect = { x: rect.y, y: rect.x, width: rect.height, height: rect.width };

            var renderData = this._calcGroupOffsets(groupIndex, gRect);
            if (!renderData || renderData.length <= groupIndex)
                return;

            var band = group.bands[bandIndex];
            var bandRenderData = renderData.bands[bandIndex];

            var from = bandRenderData.from;
            var to = bandRenderData.to;
            var h = Math.abs(from - to);

            var elRect = { x: gRect.x, y: Math.min(from, to), width: gRect.width, height: h };
            if (group.orientation == 'horizontal') {
                var tmp = elRect.x;
                elRect.x = elRect.y;
                elRect.y = tmp;

                tmp = elRect.width;
                elRect.width = elRect.height;
                elRect.height = tmp;
            }

            var bandElement = this.renderer.rect(elRect.x, elRect.y, elRect.width, elRect.height);
            var fillColor = band.color || '#AAAAAA';
            var opacity = band.opacity;
            if (isNaN(opacity) || opacity < 0 || opacity > 1)
                opacity = 0.5;

            this.renderer.attr(bandElement, { fill: fillColor, 'fill-opacity': opacity, stroke: fillColor, 'stroke-width': 0 });

        },

        //[optimize]
        _renderColumnSeries: function (groupIndex, rect) {
            var group = this.seriesGroups[groupIndex];
            if (!group.series || group.series.length == 0)
                return;

            var isStacked = group.type.indexOf('stacked') != -1;
            var isStacked100 = isStacked && group.type.indexOf('100') != -1;
            var isRange = group.type.indexOf('range') != -1;

            var dataLength = this._getDataLen(groupIndex);

            var columnGap = group.columnsGapPercent;
            if (isNaN(columnGap) || columnGap < 0 || columnGap > 100)
                columnGap = 25;

            var seriesGap = group.seriesGapPercent;
            if (isNaN(seriesGap) || seriesGap < 0 || seriesGap > 100)
                seriesGap = 10;

            var inverse = group.orientation == 'horizontal';

            var gRect = rect;
            if (inverse)
                gRect = { x: rect.y, y: rect.x, width: rect.height, height: rect.width };

            var renderData = this._calcGroupOffsets(groupIndex, gRect);
            if (!renderData || renderData.xoffsets.length == 0)
                return;

            var columnGroupsCount = this._getColumnGroupsCount(group.orientation);
            var relativeGroupIndex = this._getColumnGroupIndex(groupIndex);
            if (this.columnSeriesOverlap == true) {
                columnGroupsCount = 1;
                relativeGroupIndex = 0;
            }

            for (var sidx = 0; sidx < group.series.length; sidx++) {
                var s = group.series[sidx];
                var columnsMaxWidth = s.columnsMaxWidth || group.columnsMaxWidth;

                var dataField = s.dataField;

                var anim = this._getAnimProps(groupIndex, sidx);
                var duration = anim.enabled && renderData.xoffsets.length < 100 ? anim.duration : 0;

                var valuesOnTicks = this._alignValuesWithTicks(groupIndex);

                var columnElements = [];
                for (var i = renderData.xoffsets.first; i <= renderData.xoffsets.last; i++) {
                    var val = this._getDataValueAsNumber(i, dataField, groupIndex);
                    if (typeof (val) != 'number')
                        continue;

                    var x1 = renderData.xoffsets.data[i];
                    var itemWidth = renderData.xoffsets.itemWidth;
                    if (valuesOnTicks)
                        x1 -= itemWidth / 2;

                    x1 += itemWidth * (relativeGroupIndex / columnGroupsCount);
                    itemWidth /= columnGroupsCount;

                    var x2 = x1 + itemWidth;
                    var wGroup = (x2 - x1 + 1);
                    var wGroupRender = (x2 - x1 + 1) / (1 + columnGap / 100);
                    var seriesSpace = (!isStacked && group.series.length > 1) ? (wGroupRender * seriesGap / 100) / (group.series.length - 1) : 0;
                    var wColumn = (wGroupRender - seriesSpace * (group.series.length - 1));
                    if (wGroupRender < 1)
                        wGroupRender = 1;

                    var col = 0;
                    if (!isStacked && group.series.length > 1) {
                        wColumn /= group.series.length;
                        col = sidx;
                    }

                    var x = x1 + (wGroup - wGroupRender) / 2 + col * (seriesSpace + wColumn);
                    if (col == group.series.length)
                        wColumn = wGroup - x1 + wGroupRender - x;

                    if (!isNaN(columnsMaxWidth)) {
                        var wColumnAdj = Math.min(wColumn, columnsMaxWidth);
                        x = x + (wColumn - wColumnAdj) / 2;
                        wColumn = wColumnAdj;
                    }


                    var to = renderData.offsets[sidx][i].to;
                    var from = renderData.offsets[sidx][i].from;
                    var base = renderData.baseOffset;
                    var h = from - to;

                    var elRect = { x: rect.x + x, y: Math.min(to, from), width: wColumn, height: Math.abs(h) };
                    if (inverse) {
                        elRect = { height: wColumn, y: rect.y + x };
                        elRect.x = from;
                        elRect.width = Math.abs(h);
                        if (h > 0)
                            elRect.x -= h;
                    }

                    columnElements.push({ itemIndex: i, rect: elRect, size: h, vertical: !inverse });
                }

                var ctx = { groupIndex: groupIndex, seriesIndex: sidx, items: columnElements };
                this._animateColumns(ctx, duration == 0 ? 1 : 0);
                var self = this;
                this._enqueueAnimation(
                        "series",
                        undefined,
                        undefined,
                        duration,
                        function (element, ctx, percent) {
                            self._animateColumns(ctx, percent);
                        },
                        ctx);
            }
        },

        _calcStackedItemSize: function (gidx, sidx, iidx, percent) {
            var data = this._renderData[gidx];

            var diff = Math.abs(data.offsets[sidx][iidx].to - data.offsets[sidx][iidx].from);
            if (isNaN(diff))
                return 0;

            var sum = 0, nsum = 0;
            for (var si = 0; si < data.offsets.length; si++) {
                var d = Math.abs(data.offsets[si][iidx].to - data.offsets[si][iidx].from);
                if (isNaN(d))
                    continue;
                if (data.offsets[si][iidx].to < data.baseOffset)
                    sum += d;
                else
                    nsum += d;
            }

            var nstop = nsum * percent;
            var stop = sum * percent;
            sum = 0;
            nsum = 0;
            var sz = 0;
            for (var si = 0; si <= sidx; si++) {
                sz = Math.abs(data.offsets[si][iidx].to - data.offsets[si][iidx].from);
                if (isNaN(sz))
                    continue;
                if (data.offsets[si][iidx].to < data.baseOffset)
                    sum += sz;
                else
                    nsum += sz;
            }

            if (data.offsets[sidx][iidx].to >= data.baseOffset) {
                sum = nsum;
                stop = nstop;
            }

            if (stop < sum - diff)
                return 0;
            if (stop >= sum)
                return diff;

            return stop - (sum - diff);
        },

        _animateColumns: function (context, percent) {
            var gidx = context.groupIndex;
            var sidx = context.seriesIndex;

            var group = this.seriesGroups[gidx];
            var s = group.series[sidx];

            var settings = this._getSerieSettings(gidx, sidx);
            var colors = settings.colors;

            var isStacked = group.type.indexOf('stacked') != -1;
            var items = context.items;
            for (var i = 0; i < items.length; i++) {
                var rect = items[i].rect;
                var size = $.jqx._ptrnd(items[i].size * percent);

                if (isStacked) {
                    size = this._calcStackedItemSize(gidx, sidx, i, percent);
                    if (items[i].size < 0)
                        size *= -1;
                }

                if (isNaN(size))
                    continue;

                if (items[i].element == undefined) {
                    items[i].element = this.renderer.rect(rect.x, rect.y, items[i].vertical ? rect.width : 0, items[i].vertical ? 0 : rect.height);
                    this.renderer.attr(items[i].element, { fill: colors.fillColor, 'fill-opacity': settings.opacity, stroke: colors.lineColor, 'stroke-width': settings.stroke, 'stroke-dasharray': settings.dashStyle });
                }

                size = Math.abs(size);

                if (size == 0)
                    this.renderer.attr(items[i].element, { display: 'none' });
                else
                    this.renderer.attr(items[i].element, { display: 'block' });


                if (items[i].vertical == true) {
                    if (items[i].size < 0)
                        this.renderer.attr(items[i].element, { height: size });
                    else
                        this.renderer.attr(items[i].element, { y: rect.y + rect.height - size, height: size });
                }
                else {
                    if (items[i].size < 0)
                        this.renderer.attr(items[i].element, { width: size });
                    else
                        this.renderer.attr(items[i].element, { x: rect.x + rect.width - size, width: size });

                }

                if (percent == 1.0) {
                    this._installHandlers(items[i].element, gidx, sidx, items[i].itemIndex);
                    var label = this._showLabel(gidx, sidx, items[i].itemIndex, rect);
                }
            }
        },

        //[optimize]
        _renderScatterSeries: function (groupIndex, rect) {
            var group = this.seriesGroups[groupIndex];
            if (!group.series || group.series.length == 0)
                return;

            var isBubble = group.type == 'bubble';

            var inverse = group.orientation == 'horizontal';

            var gRect = rect;
            if (inverse)
                gRect = { x: rect.y, y: rect.x, width: rect.height, height: rect.width };

            var renderData = this._calcGroupOffsets(groupIndex, gRect);

            if (!renderData || renderData.xoffsets.length == 0)
                return;

            var valuesOnTicks = this._alignValuesWithTicks(groupIndex);

            for (var sidx = 0; sidx < group.series.length; sidx++) {
                var settings = this._getSerieSettings(groupIndex, sidx);
                var colors = settings.colors;

                var s = group.series[sidx];
                var dataField = s.dataField;

                var min = NaN, max = NaN;
                if (isBubble) {
                    for (var i = renderData.xoffsets.first; i <= renderData.xoffsets.last; i++) {
                        var val = this._getDataValueAsNumber(i, s.radiusDataField, groupIndex);
                        if (typeof (val) != 'number')
                            throw 'Invalid radiusDataField value at [' + i + ']';

                        if (isNaN(min) || val < min)
                            min = val;
                        if (isNaN(max) || val > max)
                            max = val;
                    }
                }

                var minRadius = s.minRadius;
                if (isNaN(minRadius))
                    minRadius = rect.width / 50;

                var maxRadius = s.maxRadius;
                if (isNaN(maxRadius))
                    maxRadius = rect.width / 25;

                if (minRadius > maxRadius)
                    throw 'Invalid settings: minRadius must be less than or equal to maxRadius';

                var radius = s.radius || 5;

                var anim = this._getAnimProps(groupIndex, sidx);
                var duration = anim.enabled && renderData.xoffsets.length < 5000 ? anim.duration : 0;

                for (var i = renderData.xoffsets.first; i <= renderData.xoffsets.last; i++) {
                    var val = this._getDataValueAsNumber(i, dataField, groupIndex);
                    if (typeof (val) != 'number')
                        continue;

                    var x = renderData.xoffsets.data[i];
                    var y = renderData.offsets[sidx][i].to;

                    if (isNaN(x) || isNaN(y))
                        continue;

                    if (inverse) {
                        var tmp = x;
                        x = y;
                        y = tmp + rect.y;
                    }
                    else {
                        x += rect.x;
                    }

                    x = $.jqx._ptrnd(x);
                    y = $.jqx._ptrnd(y);


                    var r = radius;
                    if (isBubble) {
                        var rval = this._getDataValueAsNumber(i, s.radiusDataField, groupIndex);
                        if (typeof (rval) != 'number')
                            continue;
                        r = minRadius + (maxRadius - minRadius) * (rval - min) / Math.max(1, max - min);
                        if (isNaN(r))
                            r = minRadius;
                    }

                    var elem = this.renderer.circle(x, y, duration == 0 ? r : 0);
                    this.renderer.attr(elem, { fill: colors.fillColor, 'fill-opacity': settings.opacity, stroke: colors.lineColor, 'stroke-width': settings.stroke, 'stroke-dasharray': settings.dashStyle });

                    var ctx = { from: 0, to: r, groupIndex: groupIndex, seriesIndex: sidx, itemIndex: i, x: x, y: y };
                    var self = this;

                    this._enqueueAnimation("series", elem, undefined, duration,
                        function (element, context, percent) {
                            self._animR(element, context, percent);
                            if (percent == 1) {
                                var r = isBubble ? context.to : 0;
                                self._showLabel(context.groupIndex, context.seriesIndex, context.itemIndex, { x: context.x - r, y: context.y - r, width: 2 * r, height: 2 * r });
                            }
                        }, ctx);

                    this._installHandlers(elem, groupIndex, sidx, i);

                }
            }
        },

        _animR: function (element, context, percent) {
            var r = Math.round((context.to - context.from) * percent + context.from);
            if (this._isVML) {
                this.renderer.updateCircle(element, undefined, undefined, r);
            }
            else {
                this.renderer.attr(element, { r: r });
            }
        },

        //[optimize]
        _showToolTip: function (x, y, gidx, sidx, iidx) {
            var categoryAxis = this._getCategoryAxis(gidx);

            if (this._toolTipElement &&
                gidx == this._toolTipElement.gidx &&
                sidx == this._toolTipElement.sidx &&
                iidx == this._toolTipElement.iidx)
                return;

            var enableCrosshairs = this.enableCrosshairs;

            if (this._pointMarker) {
                // make it relative to the marker instead of cursor
                x = parseInt(this._pointMarker.x + 5);
                y = parseInt(this._pointMarker.y - 5);
            }
            else {
                enableCrosshairs = false;
            }

            var isCrossHairsOnly = enableCrosshairs && this.showToolTips == false;


            x = $.jqx._ptrnd(x);
            y = $.jqx._ptrnd(y);

            var isNew = this._toolTipElement == undefined;

            var group = this.seriesGroups[gidx];
            var series = group.series[sidx];

            if (group.showToolTips == false || series.showToolTips == false)
                return;

            var valfs = series.toolTipFormatSettings || group.toolTipFormatSettings;
            var valff = series.toolTipFormatFunction || group.toolTipFormatFunction || this.toolTipFormatFunction;

            var colors = this._getColors(gidx, sidx, iidx);

            var catvalue = this._getDataValue(iidx, categoryAxis.dataField, gidx);
            if (categoryAxis.dataField == undefined || categoryAxis.dataField == '')
                catvalue = iidx;
            if (categoryAxis.type == 'date')
                catvalue = this._castAsDate(catvalue);

            var text = '';

            if ($.isFunction(valff)) {

                var value = {};
                if (group.type.indexOf('range') == -1) {
                    value = this._getDataValue(iidx, series.dataField, gidx);
                }
                else {
                    value.from = this._getDataValue(iidx, series.dataFieldFrom, gidx);
                    value.to = this._getDataValue(iidx, series.dataFieldTo, gidx);
                }

                text = valff(value, iidx, series, group, catvalue, categoryAxis);
            }
            else {
                text = this._getFormattedValue(gidx, sidx, iidx, valfs, valff);

                var catfs = categoryAxis.toolTipFormatSettings || categoryAxis.formatSettings;
                var catff = categoryAxis.toolTipFormatFunction || categoryAxis.formatFunction;
                var categoryText = this._formatValue(catvalue, catfs, catff);

                if (group.type != 'pie' && group.type != 'donut')
                    text = (series.displayText || series.dataField || '') + ', ' + categoryText + ': ' + text;
                else {
                    catvalue = this._getDataValue(iidx, series.displayText || series.dataField, gidx);
                    categoryText = this._formatValue(catvalue, catfs, catff);
                    text = categoryText + ': ' + text;
                }
            }


            var cssToolTip = series.toolTipClass || group.toolTipClass || this.toThemeProperty('jqx-chart-tooltip-text', null);
            var toolTipFill = series.toolTipBackground || group.toolTipBackground || '#FFFFFF';
            var toolTipStroke = series.toolTipLineColor || group.toolTipLineColor || colors.lineColor;

            if (!this._toolTipElement) {
                this._toolTipElement = {};
            }
            this._toolTipElement.sidx = sidx;
            this._toolTipElement.gidx = gidx;
            this._toolTipElement.iidx = iidx;

            rect = this.renderer.getRect();

            if (enableCrosshairs) {
                var _x = $.jqx._ptrnd(this._pointMarker.x);
                var _y = $.jqx._ptrnd(this._pointMarker.y);
                if (this._toolTipElement.vLine && this._toolTipElement.hLine) {
                    this.renderer.attr(this._toolTipElement.vLine, { x1: _x, x2: _x });
                    this.renderer.attr(this._toolTipElement.hLine, { y1: _y, y2: _y });
                }
                else {
                    var color = this.crosshairsColor || '#888888';
                    this._toolTipElement.vLine = this.renderer.line(_x, this._plotRect.y, _x, this._plotRect.y + this._plotRect.height, { stroke: color, 'stroke-width': this.crosshairsLineWidth || 1.0, 'stroke-dasharray': this.crosshairsDashStyle || '' });
                    this._toolTipElement.hLine = this.renderer.line(this._plotRect.x, _y, this._plotRect.x + this._plotRect.width, _y, { stroke: color, 'stroke-width': this.crosshairsLineWidth || 1.0, 'stroke-dasharray': this.crosshairsDashStyle || '' });
                }
            }

            if (!isCrossHairsOnly && this.showToolTips != false) {
                var div = !isNew ? this._toolTipElement.box : document.createElement("div");
                var offset = { left: 0, top: 0 }; // $.jqx.utilities.getOffset(this.host);
                if (isNew) {
                    div.style.position = 'absolute';
                    div.style.cursor = 'default';
                    div.style.overflow = 'hidden';
                    $(div).addClass('jqx-rc-all jqx-button');
                    $(document.body).append(div);
                }
                div.style.backgroundColor = toolTipFill;
                div.style.borderColor = toolTipStroke;

                this._toolTipElement.box = div;
                this._toolTipElement.txt = text;

                var html = "<span class='" + cssToolTip + "'>" + text + "<span>";

                var measureDiv = this._toolTipElement.tmp;
                if (isNew) {
                    this._toolTipElement.tmp = measureDiv = document.createElement("div");
                    measureDiv.style.position = 'absolute';
                    measureDiv.style.cursor = 'default';
                    measureDiv.style.overflow = 'hidden';
                    measureDiv.style.display = 'none';
                    measureDiv.style.zIndex = 999999;
                    measureDiv.style.backgroundColor = toolTipFill;
                    measureDiv.style.borderColor = toolTipStroke;
                    $(measureDiv).addClass('jqx-rc-all jqx-button');
                    this.host.append(measureDiv);
                }
                $(measureDiv).html(html);

                var sz = { width: $(measureDiv).width(), height: $(measureDiv).height() };
                sz.width = sz.width + 5;
                sz.height = sz.height + 6;

                x = Math.max(x, rect.x);
                y = Math.max(y - sz.height, rect.y);

                if (sz.width > rect.width || sz.height > rect.height)
                    return;

                if (x + offset.left + sz.width > rect.x + rect.width - 5) {
                    x = rect.x + rect.width - sz.width - offset.left - 5;
                    div.style.left = offset.left + x + 'px';
                }

                if (y + offset.top + sz.height > rect.y + rect.height - 5) {
                    y = rect.y + rect.height - sz.height - 5;
                    div.style.top = offset.top + y + 'px';
                }

                var hostPosition = this.host.coord();
                if (isNew) {
                    $(div).fadeOut(0, 0);
                    div.style.left = offset.left + x + hostPosition.left + 'px';
                    div.style.top = offset.top + y + hostPosition.top + 'px';
                }

                $(div).html(html);
                $(div).clearQueue();
                $(div).fadeTo(400, 1);
                $(div).animate({ left: offset.left + x + hostPosition.left, top: offset.top + y + hostPosition.top, opacity: 1 }, 200, 'easeInOutCirc');
            }
        },

        //[optimize]
        _hideToolTip: function (delay) {
            if (!this._toolTipElement)
                return;

            if (this._toolTipElement.box) {
                if (delay == 0)
                    $(this._toolTipElement.box).hide();
                else
                    $(this._toolTipElement.box).fadeOut();
            }

            this._hideCrosshairs();

            this._toolTipElement.gidx = undefined;

        },

        _hideCrosshairs: function () {
            if (!this._toolTipElement)
                return;

            if (this._toolTipElement.vLine) {
                this.renderer.removeElement(this._toolTipElement.vLine);
                this._toolTipElement.vLine = undefined;
            }

            if (this._toolTipElement.hLine) {
                this.renderer.removeElement(this._toolTipElement.hLine);
                this._toolTipElement.hLine = undefined;
            }
        },

        //[optimize]
        _showLabel: function (gidx, sidx, iidx, rect, halign, valign, isMeasure) {
            var group = this.seriesGroups[gidx];
            var series = group.series[sidx];
            var sz = { width: 0, height: 0 };
            if (series.showLabels == false || (!series.showLabels && !group.showLabels))
                return sz;

            if (rect.width < 0 || rect.height < 0)
                return sz;

            var labelsAngle = series.labelAngle || series.labelsAngle || group.labelAngle || group.labelsAngle || 0;
            var labelOffset = series.labelOffset || group.labelOffset || { x: 0, y: 0 };
            var labelCSS = series.labelClass || group.labelClass || this.toThemeProperty('jqx-chart-label-text', null);

            halign = halign || 'center';
            valign = valign || 'center';
            var text = this._getFormattedValue(gidx, sidx, iidx);
            var w = rect.width;
            var h = rect.height;

            sz = this.renderer.measureText(text, labelsAngle, { 'class': labelCSS });
            if (isMeasure)
                return sz;

            var x = 0;
            if (halign == '' || halign == 'center')
                x += (w - sz.width) / 2;
            else if (halign == 'right')
                x += (w - sz.width);

            var y = 0;
            if (valign == '' || valign == 'center')
                y += (h - sz.height) / 2;
            else if (valign == 'bottom')
                y += (h - sz.height);

            var elemLabel = this.renderer.text(text, x + rect.x + labelOffset.x, y + rect.y + labelOffset.y, sz.width, sz.height, labelsAngle, {}, labelsAngle != 0, 'center', 'center');
            this.renderer.attr(elemLabel, { 'class': labelCSS });
            if (this._isVML) {
                this.renderer.removeElement(elemLabel);
                this.renderer.getContainer()[0].appendChild(elemLabel);
            }

            return elemLabel;
        },

        _getAnimProps: function (gidx, sidx) {
            var g = this.seriesGroups[gidx];
            var s = g.series[sidx];

            var enabled = this.enableAnimations == true;

            if (g.enableAnimations)
                enabled = g.enableAnimations == true;

            if (s.enableAnimations)
                enabled = s.enableAnimations == true;

            var duration = this.animationDuration;
            if (isNaN(duration))
                duration = 1000;

            var gd = g.animationDuration;
            if (!isNaN(gd))
                duration = gd;

            var sd = s.animationDuration;
            if (!isNaN(sd))
                duration = sd;

            if (duration > 5000)
                duration = 1000;

            return { enabled: enabled, duration: duration };
        },

        //[optimize]
        _renderLineSeries: function (groupIndex, rect) {
            var group = this.seriesGroups[groupIndex];
            if (!group.series || group.series.length == 0)
                return;

            var isArea = group.type.indexOf('area') != -1;
            var isStacked = group.type.indexOf('stacked') != -1;
            var isStacked100 = isStacked && group.type.indexOf('100') != -1;
            var isSpline = group.type.indexOf('spline') != -1;
            var isStep = group.type.indexOf('step') != -1;
            var isRange = group.type.indexOf('range') != -1;

            if (isStep && isSpline)
                return;

            var dataLength = this._getDataLen(groupIndex);
            var wPerItem = rect.width / dataLength;

            var swapXY = group.orientation == 'horizontal';
            var flipCategory = this._getCategoryAxis(groupIndex).flip == true;

            var gRect = rect;
            if (swapXY)
                gRect = { x: rect.y, y: rect.x, width: rect.height, height: rect.width };

            var renderData = this._calcGroupOffsets(groupIndex, gRect);

            if (!renderData || renderData.xoffsets.length == 0)
                return;

            var alignWithTicks = this._alignValuesWithTicks(groupIndex);

            for (var s = group.series.length - 1; s >= 0; s--) {
                var curr = renderData.xoffsets.first;
                var last = curr;
                do {
                    var points = [];
                    var rangeBasePoints = [];
                    var prev = -1;
                    var px = 0;
                    var xPrev = NaN;
                    var yPrev = NaN;
                    var pyStart = NaN;

                    if (renderData.xoffsets.length < 1)
                        continue;

                    var anim = this._getAnimProps(groupIndex, s);
                    var duration = anim.enabled && renderData.xoffsets.length < 10000 && this._isVML != true ? anim.duration : 0;
                    var first = curr;
                    var continueOnCurr = false;
                    for (var i = curr; i <= renderData.xoffsets.last; i++) {
                        curr = i;
                        var x = renderData.xoffsets.data[i];

                        if (x == undefined)
                            continue;

                        var py = renderData.offsets[s][i].to;
                        var pyFrom = renderData.offsets[s][i].from;
                        if (isNaN(py) || isNaN(pyFrom)) {
                            curr++;
                            continueOnCurr = true;
                            break;
                        }
                        last = i;

                        if (!isArea && isStacked100) {
                            if (py <= gRect.y)
                                py = gRect.y + 1;
                            if (py >= gRect.y + gRect.height)
                                py = gRect.y + gRect.height - 1;

                            if (pyFrom <= gRect.y)
                                pyFrom = gRect.y + 1;
                            if (pyFrom >= gRect.y + gRect.height)
                                pyFrom = gRect.y + gRect.h
                        }

                        x = Math.max(x, 1);
                        px = x;

                        if (isStep && !isNaN(xPrev) && !isNaN(yPrev)) {
                            if (yPrev != py) {
                                points.push(swapXY ? { y: gRect.x + px, x: $.jqx._ptrnd(yPrev)} : { x: gRect.x + px, y: $.jqx._ptrnd(yPrev) });
                            }
                        }

                        points.push(swapXY ? { y: gRect.x + px, x: $.jqx._ptrnd(py), index: i} : { x: gRect.x + px, y: $.jqx._ptrnd(py), index: i });
                        rangeBasePoints.push(swapXY ? { y: gRect.x + px, x: $.jqx._ptrnd(pyFrom), index: i} : { x: gRect.x + px, y: $.jqx._ptrnd(pyFrom), index: i });

                        xPrev = px;
                        yPrev = py;
                        if (isNaN(pyStart))
                            pyStart = py;

                    }

                    var left = gRect.x + renderData.xoffsets.data[first];
                    var right = gRect.x + renderData.xoffsets.data[last];

                    if (isArea && group.alignEndPointsWithIntervals == true) {
                        var sign = flipCategory ? -1 : 1;
                        if (left > gRect.x) {
                            left = gRect.x;
                        }
                        if (right < gRect.x + gRect.width)
                            right = gRect.x + gRect.width;

                        if (flipCategory) {
                            var tmp = left;
                            left = right;
                            right = tmp;
                        }
                    }
                    right = $.jqx._ptrnd(right);
                    left = $.jqx._ptrnd(left);

                    var yBase = renderData.baseOffset;
                    pyStart = $.jqx._ptrnd(pyStart);

                    var pyEnd = $.jqx._ptrnd(py) || yBase;

                    if (isRange) {
                        points = points.concat(rangeBasePoints.reverse());
                    }

                    var ctx = { groupIndex: groupIndex, seriesIndex: s, pointsArray: points, left: left, right: right, pyStart: pyStart, pyEnd: pyEnd, yBase: yBase, isArea: isArea, isSpline: isSpline, swapXY: swapXY, isRange: isRange };
                    this._animatePath(undefined, ctx, duration == 0 ? 1 : 0);
                    var self = this;
                    this._enqueueAnimation(
                        "series",
                        undefined,
                        undefined,
                        duration,
                        function (element, ctx, percent) {
                            self._animatePath(element, ctx, percent);
                        },
                        ctx);
                }
                while (curr < renderData.xoffsets.length - 1 || continueOnCurr);
            } // for s
        },

        _animatePath: function (element, ctx, percent) {
            var cmd = this._calculateLine(ctx.pointsArray, ctx.yBase, percent, ctx.isArea, ctx.swapXY);
            var cnt = ctx.pointsArray.length;
            if (!ctx.isArea)
                cnt = Math.round(cnt * percent);
            if (cmd != '')
                cmd = this._buildLineCmd(cmd, ctx.isRange, ctx.left, ctx.right, ctx.pyStart, ctx.pyEnd, ctx.yBase, ctx.isArea, cnt > 3 && ctx.isSpline, ctx.swapXY);
            else
                cmd = "M 0 0"; // workaround for errors in Chrome

            var pathElement = ctx.element;
            if (!pathElement) {
                var settings = this._getSerieSettings(ctx.groupIndex, ctx.seriesIndex);

                pathElement = this.renderer.path(
                    cmd,
                    {
                        'stroke-width': settings.stroke,
                        'stroke': settings.colors.lineColor,
                        'fill-opacity': settings.opacity,
                        'stroke-dasharray': settings.dashStyle,
                        fill: ctx.isArea ? settings.colors.fillColor : 'none'
                    }
                    );

                ctx.element = pathElement;
            }

            this.renderer.attr(pathElement, { 'd': cmd });

            if (percent == 1.0) {
                var settings = this._getSerieSettings(ctx.groupIndex, ctx.seriesIndex);
                for (var i = 0; i < ctx.pointsArray.length; i++) {
                    this._showLabel(ctx.groupIndex, ctx.seriesIndex, ctx.pointsArray[i].index, { x: ctx.pointsArray[i].x, y: ctx.pointsArray[i].y, width: 0, height: 0 });
                    this._drawSymbol(this._getSymbol(ctx.groupIndex, ctx.seriesIndex), ctx.pointsArray[i].x, ctx.pointsArray[i].y, settings.colors.fillColor, settings.colors.lineColor, 1/*lineSettings.stroke*/, settings.opacity);
                }

                this._installHandlers(pathElement, ctx.groupIndex, ctx.seriesIndex);
            }
        },

        _calculateLine: function (pointsArray, yBase, percent, isArea, swapXY) {
            var cmd = '';
            var cnt = pointsArray.length;
            if (!isArea)
                cnt = Math.round(cnt * percent);

            for (var i = 0; i < cnt; i++) {
                if (i > 0)
                    cmd += ' ';
                var y = pointsArray[i].y;
                var x = pointsArray[i].x;
                if (isArea) {
                    if (swapXY)
                        x = $.jqx._ptrnd((x - yBase) * percent + yBase);
                    else
                        y = $.jqx._ptrnd((y - yBase) * percent + yBase);
                }

                cmd += x + ',' + y;

                if (cnt == 1)
                    cmd += ' ' + (x + 2) + ',' + (y + 2);
            }

            return cmd;
        },

        _buildLineCmd: function (pointsArray, isRange, left, right, pyStart, pyEnd, yBase, isArea, isSpline, swapXY) {
            var cmd = pointsArray;
            if (isSpline)
                cmd = this._getBezierPoints(pointsArray);

            var split = cmd.split(' ');
            var firstPoint = split[0].replace('C', '');

            if (isArea) {
                if (!isRange) {
                    var ptTopLeft = swapXY ? pyStart + ',' + left : left + ',' + pyStart;
                    var ptTopRight = swapXY ? pyEnd + ',' + right : right + ',' + pyEnd;
                    var ptBottomLeft = swapXY ? yBase + ',' + left : left + ',' + yBase
                    var ptBottomRight = swapXY ? yBase + ',' + right : right + ',' + yBase;

                    cmd = 'M ' + ptBottomLeft + ' L ' + firstPoint
                        + (isSpline ? '' : (' L ' + firstPoint + ' '))
                        + cmd
                        + (isSpline ?
                            (' L' + ptBottomRight + ' M ' + ptBottomRight)
                            :
                            (' ' + ptBottomRight + ' ' + ptBottomLeft)
                        ) + ' Z';
                }
                else {
                    cmd = 'M ' + firstPoint + ' L ' + firstPoint
                        + (isSpline ? '' : (' L ' + firstPoint + ' '))
                        + cmd
                        + ' Z';
                }
            }
            else {
                if (isSpline)
                    cmd = 'M ' + firstPoint + ' ' + cmd;
                else
                    cmd = 'M ' + firstPoint + ' ' + 'L ' + firstPoint + ' ' + cmd;
            }

            return cmd;
        },

        //[optimize]
        _getSerieSettings: function (groupIndex, seriesIndex) {
            var group = this.seriesGroups[groupIndex];
            var isArea = group.type.indexOf('area') != -1;
            var isLine = group.type.indexOf('line') != -1;

            var colors = this._getColors(groupIndex, seriesIndex, undefined, this._getGroupGradientType(groupIndex));
            var serie = group.series[seriesIndex]

            var dashStyle = serie.dashStyle || group.dashStyle || '';

            var opacity = serie.opacity || group.opacity;
            if (isNaN(opacity) || opacity < 0 || opacity > 1)
                opacity = 1;

            var stroke = serie.lineWidth;
            if (isNaN(stroke) && stroke != 'auto')
                stroke = group.lineWidth;

            if (stroke == 'auto' || isNaN(stroke) || stroke < 0 || stroke > 15) {
                if (isArea)
                    stroke = 2;
                else if (isLine)
                    stroke = 3;
                else
                    stroke = 1;
            }

            return { colors: colors, stroke: stroke, opacity: opacity, dashStyle: dashStyle };
        },

        getItemColor: function (group, serie, itemIndex) {
            var gidx = -1;
            for (var i = 0; i < this.seriesGroups.length; i++)
                if (this.seriesGroups[i] == group) {
                    gidx = i;
                    break;
                }
            if (gidx == -1)
                return '#000000';
            var sidx = -1;
            for (var i = 0; i < this.seriesGroups[gidx].series.length; i++)
                if (this.seriesGroups[gidx].series[i] == serie) {
                    sidx = i;
                    break;
                }
            if (sidx == -1)
                return '#000000';

            return this._getColors(gidx, sidx, itemIndex);
        },

        //[optimize]
        _getColors: function (gidx, sidx, iidx, gradientType) {
            var group = this.seriesGroups[gidx];
            if (group.type != 'pie' && group.type != 'donut')
                iidx = undefined;

            var useGradient = group.series[sidx].useGradient || group.useGradient;
            if (useGradient == undefined)
                useGradient = true;

            var color;
            if (!isNaN(iidx)) {
                var dataLength = this._getDataLen(gidx);
                color = this._getColor(group.series[sidx].colorScheme || group.colorScheme || this.colorScheme, sidx * dataLength + iidx, gidx, sidx);
            }
            else
                color = this._getSeriesColor(gidx, sidx);

            var colorSelected = $.jqx._adjustColor(color, 1.1);

            var lineColor = $.jqx._adjustColor(color, 0.9);
            var lineSelected = $.jqx._adjustColor(colorSelected, 0.9);
            var fillColor = color;
            var fillSelected = colorSelected;

            var stops2 = [[0, 1.5], [100, 1]];
            var stops4 = [[0, 1], [25, 1.1], [50, 1.5], [100, 1]];
            var stopsR = [[0, 1.3], [90, 1.2], [100, 1.0]];

            if (useGradient) {
                if (gradientType == 'verticalLinearGradient') {
                    fillColor = this.renderer._toLinearGradient(color, true, stops2);
                    fillSelected = this.renderer._toLinearGradient(colorSelected, true, stops2);
                }
                else if (gradientType == 'horizontalLinearGradient') {
                    fillColor = this.renderer._toLinearGradient(color, false, stops4);
                    fillSelected = this.renderer._toLinearGradient(colorSelected, false, stops4);
                }
                else if (gradientType == 'radialGradient') {
                    var params = undefined;
                    var stops = stops2;
                    if ((group.type == 'pie' || group.type == 'donut') && iidx != undefined && this._renderData[gidx] && this._renderData[gidx][sidx]) {
                        params = this._renderData[gidx][sidx][iidx];
                        stops = stopsR;
                    }

                    fillColor = this.renderer._toRadialGradient(color, stops, params);
                    fillSelected = this.renderer._toRadialGradient(colorSelected, stops, params);
                }
            }

            return { baseColor: color, fillColor: fillColor, lineColor: lineColor, fillSelected: fillSelected, lineSelected: lineSelected };
        },

        //[optimize]
        _installHandlers: function (element, gidx, sidx, iidx) {
            var self = this;
            var g = this.seriesGroups[gidx];
            var s = this.seriesGroups[gidx].series[sidx];

            var isLineType = g.type.indexOf('line') != -1 || g.type.indexOf('area') != -1;

            if (!isLineType) {
                this.renderer.addHandler(element, 'mousemove', function (e) {
                    e.preventDefault();

                    var x = e.pageX || e.clientX || e.screenX;
                    var y = e.pageY || e.clientY || e.screenY;

                    var pos = self.host.offset();
                    x -= pos.left;
                    y -= pos.top;

                    if (self._mouseX == x && self._mouseY == y)
                        return;

                    if (self._toolTipElement) {
                        if (self._toolTipElement.gidx == gidx &&
                        self._toolTipElement.sidx == sidx &&
                        self._toolTipElement.iidx == iidx)
                            return;
                    }

                    self._startTooltipTimer(gidx, sidx, iidx);
                });
            }

            this.renderer.addHandler(element, 'mouseover', function (e) {
                e.preventDefault();
                self._select(element, gidx, sidx, iidx);
                // bypass for line and area series
                if (isLineType)
                    return;

                if (isNaN(iidx))
                    return;

                self._raiseEvent('mouseover', g, s, iidx);
            });

            this.renderer.addHandler(element, 'mouseout', function (e) {
                e.preventDefault();

                if (iidx != undefined)
                    self._cancelTooltipTimer();

                // bypass for line and area series
                if (isLineType)
                    return;

                self._unselect();

                if (isNaN(iidx))
                    return;

                self._raiseEvent('mouseout', g, s, iidx);
            });

            this.renderer.addHandler(element, 'click', function (e) {
                e.preventDefault();

                // bypass for line and area series
                if (isLineType)
                    return;

                if (g.type.indexOf('column') != -1)
                    self._unselect();

                if (isNaN(iidx))
                    return;

                self._raiseEvent('click', g, s, iidx);
            });

        },

        //[optimize]
        _getHorizontalOffset: function (gidx, sidx, x, y) {
            var rect = this._plotRect;
            var dataLength = this._getDataLen(gidx);
            if (dataLength == 0)
                return { index: undefined, value: x };

            var renderData = this._calcGroupOffsets(gidx, this._plotRect);
            if (renderData.xoffsets.length == 0)
                return { index: undefined, value: undefined };

            var px = x - rect.x;
            var py = y - rect.y;

            var g = this.seriesGroups[gidx];
            if (g.orientation == 'horizontal') {
                var tmp = px;
                px = py;
                py = tmp;
            }

            var inverse = this._getCategoryAxis(gidx).flip == true;

            var minDist = undefined;
            var idx = undefined;
            for (var i = renderData.xoffsets.first; i <= renderData.xoffsets.last; i++) {
                var x1 = renderData.xoffsets.data[i];
                var y1 = renderData.offsets[sidx][i].to;

                //var dist = Math.sqrt(Math.pow(Math.abs(px - x1), 2) + Math.pow(Math.abs(py - y1), 2));
                var dist = Math.abs(px - x1);
                if (isNaN(minDist) || minDist > dist) {
                    minDist = dist;
                    idx = i;
                }
            }

            return { index: idx, value: renderData.xoffsets.data[idx] };
        },

        //[optimize]
        onmousemove: function (x, y) {
            if (this._mouseX == x && this._mouseY == y)
                return;

            this._mouseX = x;
            this._mouseY = y;

            if (!this._selected)
                return;

            var rect = this._plotRect;

            var rBounds = this._paddedRect;
            if (x < rBounds.x || x > rBounds.x + rBounds.width ||
                y < rBounds.y || y > rBounds.y + rBounds.height) {
                this._unselect();
                return;
            }

            var gidx = this._selected.group;
            var g = this.seriesGroups[gidx];
            var s = g.series[this._selected.series];

            var inverse = g.orientation == 'horizontal';

            var type = this.seriesGroups[gidx].type;
            var rect = this._plotRect;
            if (type.indexOf('line') != -1 || type.indexOf('area') != -1) {
                var offset = this._getHorizontalOffset(gidx, this._selected.series, x, y);
                var i = offset.index;
                if (i == undefined)
                    return;

                if (this._selected.item != i) {
                    if (this._selected.item)
                        this._raiseEvent('mouseout', g, s, this._selected.item);

                    this._selected.item = i;
                    this._raiseEvent('mouseover', g, s, i);
                }

                var symbolType = this._getSymbol(this._selected.group, this._selected.series);
                if (symbolType == 'none')
                    symbolType = 'circle';

                var renderData = this._calcGroupOffsets(gidx, rect);
                var yTo = renderData.offsets[this._selected.series][i].to;

                var yFrom = yTo;
                if (g.type.indexOf('range') != -1) {
                    yFrom = renderData.offsets[this._selected.series][i].from;
                }

                var cmp = inverse ? x : y;
                if (!isNaN(yFrom) && Math.abs(cmp - yFrom) < Math.abs(cmp - yTo))
                    y = yFrom;
                else
                    y = yTo;

                if (isNaN(y))
                    return;

                x = offset.value;

                if (inverse) {
                    var tmp = x;
                    x = y;
                    y = tmp + rect.y;
                }
                else {
                    x += rect.x;
                }

                y = $.jqx._ptrnd(y);
                x = $.jqx._ptrnd(x);

                if (this._pointMarker) {
                    this.renderer.removeElement(this._pointMarker.element);
                }

                if (isNaN(x) || isNaN(y)) {
                    return;
                }

                var color = this._getSeriesColor(this._selected.group, this._selected.series);
                var strokeColor = $.jqx._adjustColor(color, 0.5);

                var opacity = s.opacity;
                if (isNaN(opacity) || opacity < 0 || opacity > 1.0)
                    opacity = g.opacity;
                if (isNaN(opacity) || opacity < 0 || opacity > 1.0)
                    opacity = 1.0;

                var symbolSize = s.symbolSize;
                if (isNaN(symbolSize) || symbolSize > 10 || symbolSize < 0)
                    symbolSize = g.symbolSize;
                if (isNaN(symbolSize) || symbolSize > 10 || symbolSize < 0)
                    symbolSize = 8;

                this._pointMarker = { type: symbolType, x: x, y: y, gidx: gidx, sidx: this._selected.series, iidx: i };
                this._pointMarker.element = this._drawSymbol(symbolType, x, y, color, strokeColor, 1, opacity, symbolSize);

                this._startTooltipTimer(gidx, this._selected.series, i);
            }
        },

        //[optimize]
        _drawSymbol: function (type, x, y, fill, stroke, lineWidth, opacity, size) {
            var element;
            var sz = size || 6;
            var sz2 = sz / 2;
            switch (type) {
                case 'none':
                    return undefined;
                case 'circle':
                    element = this.renderer.circle(x, y, sz / 2);
                    break;
                case 'square':
                    sz = sz - 1; sz2 = sz / 2;
                    element = this.renderer.rect(x - sz2, y - sz2, sz, sz);
                    break;
                case 'diamond':
                    {
                        var path = 'M ' + (x - sz2) + ',' + (y)
                            + ' L ' + (x) + ',' + (y + sz2)
                            + ' L ' + (x + sz2) + ',' + (y)
                            + ' L ' + (x) + ',' + (y - sz2)
                            + ' Z';
                        element = this.renderer.path(path);
                    } break;
                case 'triangle_up':
                    {
                        var path = 'M ' + (x - sz2) + ',' + (y + sz2)
                            + ' L ' + (x + sz2) + ',' + (y + sz2)
                            + ' L ' + (x) + ',' + (y - sz2)
                            + ' Z';
                        element = this.renderer.path(path);
                    } break;
                case 'triangle_down':
                    {
                        var path = 'M ' + (x - sz2) + ',' + (y - sz2)
                            + ' L ' + (x) + ',' + (y + sz2)
                            + ' L ' + (x + sz2) + ',' + (y - sz2)
                            + ' Z';
                        element = this.renderer.path(path);
                    } break;
                case 'triangle_left':
                    {
                        var path = 'M ' + (x - sz2) + ',' + (y)
                            + ' L ' + (x + sz2) + ',' + (y + sz2)
                            + ' L ' + (x + sz2) + ',' + (y - sz2)
                            + ' Z';
                        element = this.renderer.path(path);
                    } break;
                case 'triangle_right':
                    {
                        var path = 'M ' + (x - sz2) + ',' + (y - sz2)
                            + ' L ' + (x - sz2) + ',' + (y + sz2)
                            + ' L ' + (x + sz2) + ',' + (y)
                            + ' Z';
                        element = this.renderer.path(path);
                    } break;
                default:
                    element = this.renderer.circle(x, y, sz);
            }

            this.renderer.attr(element, { fill: fill, stroke: stroke, 'stroke-width': lineWidth, 'fill-opacity': opacity });
            return element;
        },

        //[optimize]
        _getSymbol: function (groupIndex, seriesIndex) {
            var symbols = ['circle', 'square', 'diamond', 'triangle_up', 'triangle_down', 'triangle_left', 'triangle_right'];
            var g = this.seriesGroups[groupIndex];
            var s = g.series[seriesIndex];
            var symbolType = undefined;
            if (s.symbolType != undefined)
                symbolType = s.symbolType;
            if (symbolType == undefined)
                symbolType = g.symbolType;

            if (symbolType == 'default')
                return symbols[seriesIndex % symbols.length];
            else if (symbolType != undefined)
                return symbolType;

            return 'none';
        },

        //[optimize]
        _startTooltipTimer: function (gidx, sidx, iidx) {
            this._cancelTooltipTimer();
            var self = this;
            var g = self.seriesGroups[gidx];
            var delay = this.toolTipShowDelay || this.toolTipDelay;
            if (isNaN(delay) || delay > 10000 || delay < 0)
                delay = 500;
            if (this._toolTipElement || (true == this.enableCrosshairs && false == this.showToolTips))
                delay = 0;

            clearTimeout(this._tttimerHide);

            this._tttimer = setTimeout(function () {
                self._showToolTip(self._mouseX, self._mouseY - 3, gidx, sidx, iidx);

                var toolTipHideDelay = self.toolTipHideDelay;

                if (isNaN(toolTipHideDelay))
                    toolTipHideDelay = 4000;

                self._tttimerHide = setTimeout(function () {
                    self._hideToolTip();
                }, toolTipHideDelay);
            }, delay);
        },

        //[optimize]
        _cancelTooltipTimer: function () {
            clearTimeout(this._tttimer);
        },

        //[optimize]
        _getGroupGradientType: function (gidx) {
            var g = this.seriesGroups[gidx];
            if (g.type.indexOf('area') != -1)
                return g.orientation == 'horizontal' ? 'horizontalLinearGradient' : 'verticalLinearGradient';
            else if (g.type.indexOf('column') != -1)
                return g.orientation == 'horizontal' ? 'verticalLinearGradient' : 'horizontalLinearGradient';
            else if (g.type.indexOf('scatter') != -1 || g.type.indexOf('bubble') != -1 || g.type.indexOf('pie') != -1 || g.type.indexOf('donut') != -1)
                return 'radialGradient';

            return undefined;
        },

        //[optimize]
        _select: function (element, gidx, sidx, iidx) {
            if (this._selected && this._selected.element != element) {
                this._unselect();
            }

            this._selected = { element: element, group: gidx, series: sidx, item: iidx };
            var g = this.seriesGroups[gidx];

            var colors = this._getColors(gidx, sidx, iidx, this._getGroupGradientType(gidx));
            if (g.type.indexOf('line') != -1 && g.type.indexOf('area') == -1)
                colors.fillSelected = 'none';

            this.renderer.attr(element, { 'stroke': colors.lineSelected, fill: colors.fillSelected });
        },

        //[optimize]
        _unselect: function () {
            if (this._selected) {
                var gidx = this._selected.group;
                var sidx = this._selected.series;
                var iidx = this._selected.item;
                var g = this.seriesGroups[gidx];
                var s = g.series[sidx];

                var colors = this._getColors(gidx, sidx, iidx, this._getGroupGradientType(gidx));
                if (g.type.indexOf('line') != -1 && g.type.indexOf('area') == -1)
                    colors.fillColor = 'none';

                this.renderer.attr(this._selected.element, { 'stroke': colors.lineColor, fill: colors.fillColor });

                if (g.type.indexOf('line') != -1 || g.type.indexOf('area') != -1 && !isNaN(iidx)) {
                    this._raiseEvent('mouseout', g, s, iidx);
                }

                this._selected = undefined;
            }

            if (this._pointMarker) {
                this.renderer.removeElement(this._pointMarker.element);
                this._pointMarker = undefined;
                this._hideCrosshairs();
            }
        },

        //[optimize]
        _raiseEvent: function (event, group, serie, index) {
            var fn = serie[event] || group[event];
            var gidx = 0;
            for (; gidx < this.seriesGroups.length; gidx++)
                if (this.seriesGroups[gidx] == group)
                    break;
            if (gidx == this.seriesGroups.length)
                return;

            if (fn && $.isFunction(fn))
                fn({ event: event, seriesGroup: group, serie: serie, elementIndex: index, elementValue: this._getDataValue(index, serie.dataField, gidx) });
        },

        //[optimize]
        _calcGroupOffsets: function (groupIndex, rect) {
            var group = this.seriesGroups[groupIndex];
            if (!group.series || group.series.length == 0)
                return;

            var inverse = group.valueAxis.flip == true;
            var logAxis = group.valueAxis.logarithmicScale == true;
            var logBase = group.valueAxis.logarithmicScaleBase || 10;

            if (!this._renderData)
                this._renderData = new Array();

            while (this._renderData.length < groupIndex + 1)
                this._renderData.push(null);

            if (this._renderData[groupIndex] != null)
                return this._renderData[groupIndex];

            var out = new Array();

            var isStacked = group.type.indexOf("stacked") != -1;
            var isStacked100 = isStacked && group.type.indexOf("100") != -1;
            var isRange = group.type.indexOf("range") != -1;

            var dataLength = this._getDataLen(groupIndex);
            var gbase = group.baselineValue || group.valueAxis.baselineValue || 0;
            if (isRange)
                gbase = 0;

            var stat = this._stats.seriesGroups[groupIndex];
            if (!stat || !stat.isValid)
                return;

            if (gbase > stat.max)
                gbase = stat.max;
            if (gbase < stat.min)
                gbase = stat.min;

            var range = (isStacked100 || logAxis) ? stat.maxRange : stat.max - stat.min;

            var min = stat.min;
            var max = stat.max;

            var scale = rect.height / (logAxis ? stat.intervals : range);

            var yzero = 0;
            if (isStacked100) {
                if (min * max < 0) {
                    range /= 2;
                    yzero = -(range + gbase) * scale;
                }
                else {
                    yzero = -gbase * scale;
                }
            }
            else
                yzero = -(gbase - min) * scale;

            if (inverse)
                yzero = rect.y - yzero;
            else
                yzero += rect.y + rect.height;

            var yPOffset = new Array();
            var yNOffset = new Array();

            var pIntervals, nIntervals;
            if (logAxis) {
                pIntervals = $.jqx.log(max, logBase) - $.jqx.log(gbase, logBase);
                if (isStacked) // force base value @ min for stacked log series
                {
                    pIntervals = stat.intervals;
                    gbase = isStacked100 ? 0 : min;
                }

                nIntervals = stat.intervals - pIntervals;
                if (!inverse)
                    yzero = rect.y + pIntervals / stat.intervals * rect.height;
            }

            yzero = $.jqx._ptrnd(yzero);

            var th = (min * max < 0) ? rect.height / 2 : rect.height;

            var logSums = [];

            var bands = [];
            if (group.bands) {
                for (var j = 0; j < group.bands.length; j++) {
                    var from = group.bands[j].minValue;
                    var to = group.bands[j].maxValue;

                    var y1 = 0;
                    var y2 = 0;

                    if (logAxis) {
                        y1 = ($.jqx.log(from, logBase) - $.jqx.log(gbase, logBase)) * scale;
                        y2 = ($.jqx.log(to, logBase) - $.jqx.log(gbase, logBase)) * scale;
                    }
                    else {
                        y1 = (from - gbase) * scale;
                        y2 = (to - gbase) * scale;
                    }

                    if (this._isVML) {
                        y1 = Math.round(y1);
                        y2 = Math.round(y2);
                    }
                    else {
                        y1 = $.jqx._ptrnd(y1) - 1;
                        y2 = $.jqx._ptrnd(y2) - 1;
                    }

                    if (inverse)
                        bands.push({ from: yzero + y2, to: yzero + y1 });
                    else
                        bands.push({ from: yzero - y2, to: yzero - y1 });
                }
            }

            for (var j = 0; j < group.series.length; j++) {
                if (!isStacked && logAxis)
                    logSums = [];

                var dataField = group.series[j].dataField;
                var dataFieldFrom = group.series[j].dataFieldFrom;
                var dataFieldTo = group.series[j].dataFieldTo;

                out.push(new Array());

                for (var i = 0; i < dataLength; i++) {
                    var valFrom = NaN;
                    if (isRange) {
                        valFrom = this._getDataValueAsNumber(i, dataFieldFrom, groupIndex);
                        if (isNaN(valFrom))
                            valFrom = gbase;
                    }

                    var val = NaN;
                    if (isRange)
                        val = this._getDataValueAsNumber(i, dataFieldTo, groupIndex);
                    else
                        val = this._getDataValueAsNumber(i, dataField, groupIndex);

                    if (isNaN(val) || (logAxis && val <= 0)) {
                        out[j].push({ from: undefined, to: undefined });
                        continue;
                    }

                    if (val > stat.rmax)
                        val = stat.rmax;
                    if (val < stat.rmin)
                        val = stat.rmin;

                    var yOffset = (val > gbase) ? yPOffset : yNOffset;

                    var h = scale * (val - gbase);
                    if (isRange) {
                        h = scale * (val - valFrom);
                    }

                    if (logAxis) {
                        while (logSums.length <= i)
                            logSums.push({ p: { value: 0, height: 0 }, n: { value: 0, height: 0} });

                        var base = isRange ? valFrom : gbase;
                        var sums = val > base ? logSums[i].p : logSums[i].n;

                        sums.value += val;

                        if (isStacked100) {
                            val = sums.value / (stat.psums[i] + stat.nsums[i]) * 100;
                            h = ($.jqx.log(val, logBase) - stat.minPow) * scale;
                        }
                        else {
                            h = $.jqx.log(sums.value, logBase) - $.jqx.log(base, logBase);

                            h *= scale;
                        }

                        h -= sums.height;
                        sums.height += h;
                    }

                    var y = yzero;
                    if (isRange) {
                        var yDiff = 0;
                        if (logAxis)
                            yDiff = ($.jqx.log(valFrom, logBase) - $.jqx.log(gbase, logBase)) * scale;
                        else
                            yDiff = (valFrom - gbase) * scale;

                        y += inverse ? yDiff : -yDiff;
                    }

                    if (isStacked) {
                        if (isStacked100 && !logAxis) {
                            var irange = (stat.psums[i] - stat.nsums[i]);

                            if (val > gbase) {
                                h = (stat.psums[i] / irange) * th;
                                if (stat.psums[i] != 0)
                                    h *= val / stat.psums[i];
                            }
                            else {
                                h = (stat.nsums[i] / irange) * th;
                                if (stat.nsums[i] != 0)
                                    h *= val / stat.nsums[i];
                            }
                        }

                        if (isNaN(yOffset[i])) {
                            yOffset[i] = y;
                        }

                        y = yOffset[i];
                    }

                    h = Math.abs(h);

                    h_new = this._isVML ? Math.round(h) : $.jqx._ptrnd(h) - 1;
                    if (Math.abs(h - h_new) > 0.5)
                        h = Math.round(h);
                    else
                        h = h_new;

                    // adjust the height to make sure it span the entire height
                    // otherwise there will be a few pixels inaccuracy
                    if (j == group.series.length - 1 && isStacked100) {
                        var sumH = 0;
                        for (var k = 0; k < j; k++)
                            sumH += Math.abs(out[k][i].to - out[k][i].from);
                        sumH += h;
                        if (sumH < th) {
                            if (h > 0.5)
                                h = $.jqx._ptrnd(h + th - sumH);
                            else {
                                var k = j - 1;
                                while (k >= 0) {
                                    var diff = Math.abs(out[k][i].to - out[k][i].from);
                                    if (diff > 1) {
                                        if (out[k][i].from > out[k][i].to) {
                                            out[k][i].from += th - sumH;
                                        }
                                        break;
                                    }
                                    k--;
                                }
                            }
                        }
                    }

                    if (inverse)
                        h *= -1;

                    var drawOpositeDirection = val < gbase;
                    if (isRange)
                        drawOpositeDirection = valFrom > val;

                    if (drawOpositeDirection) {
                        yOffset[i] += h;
                        out[j].push({ from: y, to: y + h });
                    }
                    else {
                        yOffset[i] -= h;
                        out[j].push({ from: y, to: y - h });
                    }
                }
            }

            this._renderData[groupIndex] = { baseOffset: yzero, offsets: out, bands: bands };

            // calculate horizontal offsets
            this._renderData[groupIndex].xoffsets = this._calculateXOffsets(groupIndex, rect);
            // end calculating horizontal offsets

            return this._renderData[groupIndex];
        },

        _isPointSeriesOnly: function () {
            for (var i = 0; i < this.seriesGroups.length; i++) {
                var g = this.seriesGroups[i];
                if (g.type.indexOf('line') == -1 && g.type.indexOf('area') == -1 && g.type.indexOf('scatter') == -1 && g.type.indexOf('bubble') == -1)
                    return false;
            }

            return true;
        },

        _alignValuesWithTicks: function (groupIndex) {
            var psonly = this._isPointSeriesOnly();

            // if categoryAxis
            var xAxis = this._getCategoryAxis(groupIndex);
            var xAxisValuesOnTicks = xAxis.valuesOnTicks == undefined ? psonly : xAxis.valuesOnTicks != false;
            if (groupIndex == undefined)
                return xAxisValuesOnTicks;

            var g = this.seriesGroups[groupIndex];

            if (g.valuesOnTicks == undefined)
                return xAxisValuesOnTicks;

            return g.valuesOnTicks;
        },

        _getYearsDiff: function (from, to) {
            return to.getFullYear() - from.getFullYear();
        },

        _getMonthsDiff: function (from, to) {
            return 12 * (to.getFullYear() - from.getFullYear()) + to.getMonth() - from.getMonth();
        },

        _getDateDiff: function (from, to, baseUnit, round) {
            var diff = 0;
            if (baseUnit != 'year' && baseUnit != 'month')
                diff = to.valueOf() - from.valueOf();

            switch (baseUnit) {
                case 'year':
                    diff = this._getYearsDiff(from, to);
                    break;
                case 'month':
                    diff = this._getMonthsDiff(from, to);
                    break;
                case 'day':
                    diff /= (24 * 3600 * 1000);
                    break;
                case 'hour':
                    diff /= (3600 * 1000);
                    break;
                case 'minute':
                    diff /= (60 * 1000);
                    break;
                case 'second':
                    diff /= (1000);
                    break;
                case 'millisecond':
                    break;
            }

            if (baseUnit != 'year' && baseUnit != 'month' && round != false)
                diff = $.jqx._rnd(diff, 1, true);

            return diff;
        },

        _getDateTimeArray: function (min, max, baseUnit, inclNext, unitInterval) {
            var arr = [];

            var len = this._getDateDiff(min, max, baseUnit);
            if (inclNext)
                len += unitInterval;

            if (baseUnit == 'year') {
                var val = min.getFullYear();
                for (var i = 0; i < len; i++) {
                    arr.push(new Date(val, 0, 1, 0, 0, 0, 0));
                    val++;
                }
            }
            else if (baseUnit == 'month') {
                var month = min.getMonth();
                var year = min.getFullYear();
                for (var i = 0; i < len; i++) {
                    arr.push(new Date(year, month, 1, 0, 0, 0, 0));
                    month++;
                    if (month > 11) {
                        year++;
                        month = 0;
                    }
                }
            }
            else if (baseUnit == 'day') {
                for (var i = 0; i < len; i++) {
                    var date = new Date(min.valueOf() + i * 1000 * 3600 * 24);
                    arr.push(date);
                }
            }
            else {
                var step = 0;
                switch (baseUnit) {
                    case 'millisecond':
                        step = 1;
                        break;
                    case 'second':
                        step = 1000;
                        break;
                    case 'minute':
                        step = 60 * 1000;
                        break;
                    case 'hour':
                        step = 3600 * 1000;
                        break;
                }
                for (var i = 0; i < len; i++) {
                    var date = new Date(min.valueOf() + i * step);
                    arr.push(date);
                }
            }

            return arr;
        },

        _getAsDate: function (value, dateTimeUnit) {
            value = this._castAsDate(value);
            if (dateTimeUnit == 'month')
                return new Date(value.getFullYear(), value.getMonth(), 1);

            if (dateTimeUnit == 'year')
                return new Date(value.getFullYear(), 0, 1);

            if (dateTimeUnit == 'day')
                return new Date(value.getFullYear(), value.getMonth(), value.getDate());

            return value;
        },

        _calculateXOffsets: function (groupIndex, rect) {
            var xAxis = this._getCategoryAxis(groupIndex);
            var xoffsets = new Array();
            var dataLength = this._getDataLen(groupIndex);
            var isDate = xAxis.type == 'date';
            var axisMin = isDate ? this._castAsDate(xAxis.minValue) : this._castAsNumber(xAxis.minValue);
            var axisMax = isDate ? this._castAsDate(xAxis.maxValue) : this._castAsNumber(xAxis.maxValue);

            var min = axisMin, max = axisMax;

            if (isNaN(min) || isNaN(max)) {
                for (var i = 0; i < dataLength; i++) {
                    var value = this._getDataValue(i, xAxis.dataField, groupIndex);
                    value = isDate ? this._castAsDate(value) : this._castAsNumber(value);

                    if (isNaN(value))
                        continue;
                    if (value < min || isNaN(min))
                        min = value;
                    if (value > max || isNaN(max))
                        max = value;
                }
            }

            if (isDate) {
                min = new Date(min);
                max = new Date(max);
            }


            min = axisMin || min;
            max = axisMax || max;

            if (isDate && !(this._isDate(min) && this._isDate(max))) {
                throw 'Invalid Date values';
            }

            var isRange = (xAxis.maxValue != undefined) || (xAxis.minValue != undefined);
            if (isRange && (isNaN(max) || isNaN(min))) {
                isRange = false;
                throw 'Invalid min/max category values';
            }

            if (!isRange && !isDate) {
                min = 0;
                max = dataLength - 1;
            }

            var dateTimeUnit = xAxis.baseUnit;
            var isTimeUnit = dateTimeUnit == 'hour' || dateTimeUnit == 'minute' || dateTimeUnit == 'second' || dateTimeUnit == 'millisecond';

            var interval = xAxis.unitInterval;
            if (isNaN(interval) || interval <= 0)
                interval = 1;

            if (isTimeUnit) {
                if (dateTimeUnit == 'second')
                    interval *= 1000;
                else if (dateTimeUnit == 'minute')
                    interval *= 60 * 1000;
                else if (dateTimeUnit == 'hour')
                    interval *= 3600 * 1000;
            }

            var rangeLength = NaN;
            var valuesOnTicks = this._alignValuesWithTicks(groupIndex);

            if (isRange) {
                if (valuesOnTicks)
                    rangeLength = max - min;
                else
                    rangeLength = max - min + interval;
            }
            else {
                rangeLength = dataLength - 1;
                if (!valuesOnTicks)
                    rangeLength++;
            }

            if (rangeLength == 0)
                rangeLength = interval;

            var dateRangeDays = 0;
            var _max = max;
            var _min = min;

            if (isDate) {
                var _max = this._getAsDate(max, dateTimeUnit);
                var _min = this._getAsDate(min, dateTimeUnit);

                if (!isTimeUnit && !valuesOnTicks) {
                    if (dateTimeUnit == 'month')
                        _max.setMonth(_max.getMonth() + 1);
                    else if (dateTimeUnit == 'year')
                        _max.setYear(_max.getFullYear() + 1);
                    else
                        _max.setDate(_max.getDate() + 1);
                }

                rangeLength = this._getDateDiff(_min, _max, isTimeUnit ? 'millisecond' : xAxis.baseUnit);

                while (_max <= max) {
                    rangeLength = $.jqx._rnd(rangeLength, interval, true);

                    if (xAxis.baseUnit == 'month') {
                        _min = new Date(_min.getFullYear(), _min.getMonth(), 1);
                        _max = new Date(_min);
                        _max.setMonth(_max.getMonth() + rangeLength);
                    }
                    else if (xAxis.baseUnit == 'year') {
                        _min = new Date(_min.getFullYear(), 0, 1);
                        _max = new Date(_min);
                        _max.setYear(_max.getFullYear() + rangeLength);
                    }
                    else {
                        if (isTimeUnit)
                            _max.setTime(_min.getTime() + rangeLength);
                        else
                            _max.setDate(_min.getDate() + rangeLength);
                    }

                    if (_max < max)
                        rangeLength++;
                    else
                        break;
                }

                dateRangeDays = $.jqx._rnd(this._getDateDiff(_min, _max, 'day', false), 1, false);
            }

            var itemsCount = Math.max(1, rangeLength / interval);
            var itemWidth = rect.width / itemsCount;

            var isColumn = groupIndex != undefined && this.seriesGroups[groupIndex].type.indexOf('column') != -1;

            var xAdjust = 0;
            if (!valuesOnTicks && (!isDate || dateTimeUnit == 'day') && !isColumn)
                xAdjust = itemWidth / 2;

            var dateTimeUnitSave = dateTimeUnit;
            if (dateTimeUnit == 'day' || dateTimeUnit == 'month' || dateTimeUnit == 'year')
                dateTimeUnit = 'day';
            else
                dateTimeUnit = 'millisecond';


            var first = -1, last = -1;
            for (var i = 0; i < dataLength; i++) {
                if (!isRange && !isDate) {
                    xoffsets.push($.jqx._ptrnd(xAdjust + (i - _min) / rangeLength * rect.width));
                    if (first == -1)
                        first = i;
                    if (last == -1 || last < i)
                        last = i;
                    continue;
                }

                var value = this._getDataValue(i, xAxis.dataField, groupIndex);
                value = isDate ? this._castAsDate(value) : this._castAsNumber(value);
                if (isNaN(value) || value < min || value > max) {
                    xoffsets.push(-1);
                    continue;
                }

                var x = 0;
                if (!isDate || (isDate && dateTimeUnit != 'day')) {
                    diffFromMin = value - _min;
                    x = (value - _min) * rect.width / rangeLength;
                }
                else {
                    x = this._getDateDiff(_min, value, dateTimeUnitSave, false) * itemWidth / interval;
                    if (dateTimeUnitSave != 'day') {
                        var adjust = this._getDateDiff(this._getAsDate(value, dateTimeUnitSave), value, dateTimeUnit, false);
                        x += adjust / dateRangeDays * rect.width;
                    }
                }

                x = $.jqx._ptrnd(xAdjust + x);

                xoffsets.push(x);
                if (first == -1)
                    first = i;
                if (last == -1 || last < i)
                    last = i;
            }

            if (xAxis.flip == true) {
                xoffsets.reverse();
            }

            if (isTimeUnit) {
                rangeLength = this._getDateDiff(_min, _max, xAxis.baseUnit);
                rangeLength = $.jqx._rnd(rangeLength, 1, false);
            }

            return { data: xoffsets, first: first, last: last, length: last == -1 ? 0 : last - first + 1, itemWidth: itemWidth, rangeLength: rangeLength, min: _min, max: _max, customRange: isRange };
        },

        //[optimize]
        _getCategoryAxis: function (gidx) {
            if (gidx == undefined || this.seriesGroups.length <= gidx)
                return this.categoryAxis;

            return this.seriesGroups[gidx].categoryAxis || this.categoryAxis;
        },

        //[optimize]
        _isGreyScale: function (groupIndex, seriesIndex) {
            var g = this.seriesGroups[groupIndex];
            var s = g.series[seriesIndex];

            if (s.greyScale == true)
                return true;
            else if (s.greyScale == false)
                return false;

            if (g.greyScale == true)
                return true;
            else if (g.greyScale == false)
                return false;

            return this.greyScale == true;
        },



        //[optimize]
        _getSeriesColor: function (groupIndex, seriesIndex) {
            var color = this._getSeriesColorInternal(groupIndex, seriesIndex);

            if (this._isGreyScale(groupIndex, seriesIndex) && color.indexOf('#') == 0) {
                color = $.jqx.toGreyScale(color);
            }

            return color;
        },

        //[optimize]
        _getSeriesColorInternal: function (groupIndex, seriesIndex) {
            var g = this.seriesGroups[groupIndex];
            var s = g.series[seriesIndex];

            if (s.color)
                return s.color;

            var sidx = 0;
            for (var i = 0; i <= groupIndex; i++) {
                for (var j in this.seriesGroups[i].series) {
                    if (i == groupIndex && j == seriesIndex)
                        break;
                    else
                        sidx++;
                }
            }

            var colorScheme = this.colorScheme;
            if (g.colorScheme) {
                colorScheme = g.colorScheme;
                sidex = seriesIndex;
            }

            if (colorScheme == undefined || colorScheme == '')
                colorScheme = this.colorSchemes[0].name;

            if (colorScheme) {
                for (var i = 0; i < this.colorSchemes.length; i++) {
                    var cs = this.colorSchemes[i];
                    if (cs.name == colorScheme) {
                        while (sidx > cs.colors.length) {
                            sidx -= cs.colors.length;
                            if (++i >= this.colorSchemes.length)
                                i = 0;
                            cs = this.colorSchemes[i];
                        }

                        return cs.colors[sidx % cs.colors.length];
                    }
                }
            }

            return '#222222';
        },

        _getColor: function (scheme, index, gidx, sidx) {
            if (scheme == undefined || scheme == '')
                scheme = this.colorSchemes[0].name;

            for (var i = 0; i < this.colorSchemes.length; i++)
                if (scheme == this.colorSchemes[i].name)
                    break;

            var j = 0;
            while (j <= index) {
                if (i == this.colorSchemes.length)
                    i = 0;

                var schLen = this.colorSchemes[i].colors.length;
                if (j + schLen <= index) {
                    j += schLen;
                    i++;
                }
                else {
                    var color = this.colorSchemes[i].colors[index - j];

                    if (this._isGreyScale(gidx, sidx) && color.indexOf('#') == 0)
                        color = $.jqx.toGreyScale(color);

                    return color;
                }
            }
        },

        getColorScheme: function (scheme) {
            for (var i in this.colorSchemes) {
                if (this.colorSchemes[i].name == scheme)
                    return this.colorSchemes[i].colors;
            }

            return undefined;
        },

        addColorScheme: function (scheme, colors) {
            for (var i in this.colorSchemes) {
                if (this.colorSchemes[i].name == scheme) {
                    this.colorSchemes[i].colors = colors;
                    return;
                }
            }

            this.colorSchemes.push({ name: scheme, colors: colors });
        },

        removeColorScheme: function (scheme) {
            for (var i in this.colorSchemes) {
                if (this.colorSchemes[i].name == scheme) {
                    this.colorSchemes.splice(i, 1);
                    break;
                }
            }
        },

        /************* COLOR SCHEMES ************/
        //[optimize]
        colorSchemes: [
            { name: 'scheme01', colors: ['#4572A7', '#AA4643', '#89A54E', '#71588F', '#4198AF'] },
            { name: 'scheme02', colors: ['#7FD13B', '#EA157A', '#FEB80A', '#00ADDC', '#738AC8'] },
            { name: 'scheme03', colors: ['#E8601A', '#FF9639', '#F5BD6A', '#599994', '#115D6E'] },
            { name: 'scheme04', colors: ['#D02841', '#FF7C41', '#FFC051', '#5B5F4D', '#364651'] },
            { name: 'scheme05', colors: ['#25A0DA', '#309B46', '#8EBC00', '#FF7515', '#FFAE00'] },
            { name: 'scheme06', colors: ['#0A3A4A', '#196674', '#33A6B2', '#9AC836', '#D0E64B'] },
            { name: 'scheme07', colors: ['#CC6B32', '#FFAB48', '#FFE7AD', '#A7C9AE', '#888A63'] },
            { name: 'scheme08', colors: ['#2F2933', '#01A2A6', '#29D9C2', '#BDF271', '#FFFFA6'] },
            { name: 'scheme09', colors: ['#1B2B32', '#37646F', '#A3ABAF', '#E1E7E8', '#B22E2F'] },
            { name: 'scheme10', colors: ['#5A4B53', '#9C3C58', '#DE2B5B', '#D86A41', '#D2A825'] },
            { name: 'scheme11', colors: ['#993144', '#FFA257', '#CCA56A', '#ADA072', '#949681']}///,
        //{ name: 'scheme02', colors: ['#105B63', '#FFFAD5', '#FFD34E', '#DB9E36', '#BD4932'] },
        //{ name: 'scheme04', colors: ['#BBEBBC', '#F0EE94', '#F5C465', '#FA7642', '#FF1E54'] },
        //{ name: 'scheme08', colors: ['#40371E', '#F2EEAC', '#BFA575', '#A63841', '#BFB8A3']},
        //{ name: 'scheme11', colors: ['#222526', '#FFBB6E', '#F28D00', '#D94F00', '#7F203B'] },
        //{ name: 'scheme12', colors: ['#381C19', '#472E29', '#948658', '#F0E99A', '#362E29'] },
        //{ name: 'scheme18', colors: ['#142D58', '#447F6E', '#E1B65B', '#C8782A', '#9E3E17'] },
        //{ name: 'scheme20', colors: ['#4D2B1F', '#635D61', '#7992A2', '#97BFD5', '#BFDCF5'] }//,
        //{ name: 'scheme04', colors: ['#844341', '#D5CC92', '#BBA146', '#897B26', '#55591C'] },
        //{ name: 'scheme05', colors: ['#56626B', '#6C9380', '#C0CA55', '#F07C6C', '#AD5472'] },
        //{ name: 'scheme07', colors: ['#96003A', '#FF7347', '#FFBC7B', '#FF4154', '#440203'] },
        //{ name: 'scheme08', colors: ['#5D7359', '#E0D697', '#D6AA5C', '#8C5430', '#661C0E'] },
        //{ name: 'scheme21', colors: ['#16193B', '#35478C', '#4E7AC7', '#7FB2F0', '#ADD5F7'] },
        //{ name: 'scheme24', colors: ['#7B1A25', '#BF5322', '#9DA860', '#CEA457', '#B67818'] },
        //{ name: 'scheme26', colors: ['#0081DA', '#3AAFFF', '#99C900', '#FFEB3D', '#309B46'] },
        //{ name: 'scheme27', colors: ['#0069A5', '#0098EE', '#7BD2F6', '#FFB800', '#FF6800'] },
        //{ name: 'scheme28', colors: ['#FF6800', '#A0A700', '#FF8D00', '#678900', '#0069A5'] }

        ],

        /********** END OF COLOR SCHEMES ********/
        //[optimize]
        _formatValue: function (value, formatSettings, formatFunction, group, serie, itemIndex) {
            if (value == undefined)
                return '';

            if (this._isObject(value) && !formatFunction)
                return '';

            if (formatFunction) {
                if (!$.isFunction(formatFunction))
                    return value.toString();

                try {
                    return formatFunction(value, itemIndex, serie, group);
                }
                catch (e) {
                    return e.message;
                }
            }

            if (this._isNumber(value))
                return this._formatNumber(value, formatSettings);

            if (this._isDate(value))
                return this._formatDate(value, formatSettings);

            if (formatSettings) {
                return (formatSettings.prefix || '') + value.toString() + (formatSettings.sufix || '');
            }

            return value.toString();
        },

        //[optimize]
        _getFormattedValue: function (groupIndex, seriesIndex, itemIndex, formatSettings, formatFunction) {
            var g = this.seriesGroups[groupIndex];
            var s = g.series[seriesIndex];
            var text = '';

            var fs = formatSettings, fn = formatFunction;
            if (!fn)
                fn = s.formatFunction || g.formatFunction;
            if (!fs)
                fs = s.formatSettings || g.formatSettings;

            // series format settings takes priority over group format function;
            if (!s.formatFunction && s.formatSettings)
                fn = undefined;

            if (g.type.indexOf('range') != -1) {
                var valueFrom = this._getDataValue(itemIndex, s.dataFieldFrom, groupIndex);
                var valueTo = this._getDataValue(itemIndex, s.dataFieldTo, groupIndex);

                if (fn && $.isFunction(fn)) {
                    try {
                        return fn({ from: valueFrom, to: valueTo }, itemIndex, s, g);
                    }
                    catch (e) {
                        return e.message;
                    }
                }

                if (valueFrom)
                    text = this._formatValue(valueFrom, fs, fn, g, s, itemIndex);

                if (valueTo)
                    text += ", " + this._formatValue(valueTo, fs, fn, g, s, itemIndex);
            }
            else {
                var value = this._getDataValue(itemIndex, s.dataField, groupIndex);
                if (value) {
                    // format function is used with priority when available.
                    text = this._formatValue(value, fs, fn, g, s, itemIndex);
                }
            }

            return text || '';
        },

        //[optimize]
        _isNumberAsString: function (text) {
            if (typeof (text) != 'string')
                return false;

            text = $.trim(text);
            for (var i = 0; i < text.length; i++) {
                var ch = text.charAt(i);
                if ((ch >= '0' && ch <= '9') || ch == ',' || ch == '.')
                    continue;

                if (ch == '-' && i == 0)
                    continue;

                if ((ch == '(' && i == 0) || (ch == ')' && i == text.length - 1))
                    continue;

                return false;
            }

            return true;
        },

        //[optimize]
        _castAsDate: function (value) {
            if (value instanceof Date && !isNaN(value))
                return value;

            if (typeof (value) == 'string') {
                var date = new Date(value);
                if (isNaN(date))
                    date = this._parseISO8601Date(value);
                if (date != undefined && !isNaN(date))
                    return date;
            }

            return undefined;
        },

        _parseISO8601Date: function (value) {
            var splitDateTime = value.split(" ");
            if (splitDateTime.length < 0)
                return NaN;
            var splitDate = splitDateTime[0].split("-");
            var splitTime = splitDateTime.length == 2 ? splitDateTime[1].split(":") : "";
            var yy = splitDate[0];
            var MM = splitDate.length > 1 ? splitDate[1] - 1 : 0;
            var dd = splitDate.length > 2 ? splitDate[2] : 1;
            var hh = splitTime[1];
            var mm = splitTime.length > 1 ? splitTime[1] : 0;
            var hh = splitTime.length > 2 ? splitTime[2] : 0;
            var ss = splitTime.length > 3 ? splitTime[3] : 0;
            return new Date(yy, MM, dd, hh, mm, ss);
        },


        //[optimize]
        _castAsNumber: function (value) {
            if (value instanceof Date && !isNaN(value))
                return value.valueOf();

            if (typeof (value) == 'string') {
                if (this._isNumber(value)) {
                    value = parseFloat(value);
                }
                else {
                    var date = new Date(value);
                    if (date != undefined)
                        value = date.valueOf();
                }
            }

            return value;
        },

        //[optimize]
        _isNumber: function (value) {
            if (typeof (value) == 'string') {
                if (this._isNumberAsString(value))
                    value = parseFloat(value);
            }
            return typeof value === 'number' && isFinite(value);
        },

        //[optimize]
        _isDate: function (value) {
            return value instanceof Date;
        },

        //[optimize]
        _isBoolean: function (value) {
            return typeof value === 'boolean';
        },

        //[optimize]
        _isObject: function (value) {
            return (value && (typeof value === 'object' || $.isFunction(value))) || false;
        },

        //[optimize]
        _formatDate: function (value, settings) {
            return value.toString();
        },

        //[optimize]
        _formatNumber: function (value, settings) {
            if (!this._isNumber(value))
                return value;

            settings = settings || {};

            var decimalSeparator = settings.decimalSeparator || '.';
            var thousandsSeparator = settings.thousandsSeparator || '';
            var prefix = settings.prefix || '';
            var sufix = settings.sufix || '';
            var decimalPlaces = settings.decimalPlaces || ((value * 100 != parseInt(value) * 100) ? 2 : 0);
            var negativeWithBrackets = settings.negativeWithBrackets || false;

            var negative = (value < 0);

            if (negative && negativeWithBrackets)
                value *= -1;

            var output = value.toString();
            var decimalindex;

            var decimal = Math.pow(10, decimalPlaces);
            output = (Math.round(value * decimal) / decimal).toString();
            if (isNaN(output)) {
                output = '';
            }

            decimalindex = output.lastIndexOf(".");
            if (decimalPlaces > 0) {
                if (decimalindex < 0) {
                    output += decimalSeparator;
                    decimalindex = output.length - 1;
                }
                else if (decimalSeparator !== ".") {
                    output = output.replace(".", decimalSeparator);
                }
                while ((output.length - 1 - decimalindex) < decimalPlaces) {
                    output += "0";
                }
            }

            decimalindex = output.lastIndexOf(decimalSeparator);
            decimalindex = (decimalindex > -1) ? decimalindex : output.length;
            var newoutput = output.substring(decimalindex);
            var cnt = 0;
            for (var i = decimalindex; i > 0; i--, cnt++) {
                if ((cnt % 3 === 0) && (i !== decimalindex) && (!negative || (i > 1) || (negative && negativeWithBrackets))) {
                    newoutput = thousandsSeparator + newoutput;
                }
                newoutput = output.charAt(i - 1) + newoutput;
            }
            output = newoutput;

            if (negative && negativeWithBrackets)
                output = '(' + output + ')';

            return prefix + output + sufix;
        },

        //[optimize]
        _defaultNumberFormat: { prefix: '', sufix: '', decimalSeparator: '.', thousandsSeparator: ',', decimalPlaces: 2, negativeWithBrackets: false },

        _getBezierPoints: function (arr) {
            var points = [];
            var split = arr.split(' ');
            for (var i = 0; i < split.length; i++) {
                var pt = split[i].split(',');
                points.push({ x: parseFloat(pt[0]), y: parseFloat(pt[1]) });
            }

            var result = '';

            for (var i = 0; i < points.length - 1; i++) {
                var p = [];
                if (0 == i) {
                    p.push(points[i]);
                    p.push(points[i]);
                    p.push(points[i + 1]);
                    p.push(points[i + 2]);
                } else if (points.length - 2 == i) {
                    p.push(points[i - 1]);
                    p.push(points[i]);
                    p.push(points[i + 1]);
                    p.push(points[i + 1]);
                } else {
                    p.push(points[i - 1]);
                    p.push(points[i]);
                    p.push(points[i + 1]);
                    p.push(points[i + 2]);
                }

                var out = [];
                var a = i == 0 ? 81 : 9;

                var c1 = { x: ((-p[0].x + a * p[1].x + p[2].x) / a), y: ((-p[0].y + a * p[1].y + p[2].y) / a) };
                var c2 = { x: ((p[1].x + a * p[2].x - p[3].x) / a), y: ((p[1].y + a * p[2].y - p[3].y) / a) };

                out.push({ x: p[1].x, y: p[1].y });
                out.push(c1);
                out.push(c2);
                out.push({ x: p[2].x, y: p[2].y });
                if (i == 0) {
                    out[1].x++;
                    out[1].y++;
                }

                result += "C" + $.jqx._ptrnd(out[1].x) + "," + $.jqx._ptrnd(out[1].y) + " " + $.jqx._ptrnd(out[2].x) + "," + $.jqx._ptrnd(out[2].y) + " " + $.jqx._ptrnd(out[3].x) + "," + $.jqx._ptrnd(out[3].y) + " ";
            }

            return result;
        },

        _animTickInt: 50,

        _createAnimationGroup: function (groupId) {
            if (!this._animGroups) {
                this._animGroups = {};
            }

            this._animGroups[groupId] = { animations: [], startTick: NaN };
        },

        _startAnimation: function (groupId) {
            var d = new Date();
            var currentTick = d.getTime();
            this._animGroups[groupId].startTick = currentTick;
            this._runAnimation();
            this._enableAnimTimer();
        },

        _enqueueAnimation: function (groupId, element, properties, duration, fn, context, easing) {
            if (duration < 0)
            	duration = 0;

            if (easing == undefined)
                easing = 'easeInOutSine';

            this._animGroups[groupId].animations.push({ key: element, properties: properties, duration: duration, fn: fn, context: context, easing: easing });
        },

        _stopAnimations: function () {
            clearTimeout(this._animtimer);
            this._animtimer = undefined;
            this._animGroups = undefined;
        },

        _enableAnimTimer: function () {
            if (!this._animtimer) {
                var self = this;
                this._animtimer = setTimeout(function () { self._runAnimation(); }, this._animTickInt);
            }
        },

        _runAnimation: function () {
            if (this._animGroups) {
                var d = new Date();
                var currentTick = d.getTime();

                var animGroupsNewList = {};
                for (var j in this._animGroups) {
                    var list = this._animGroups[j].animations;
                    var startTick = this._animGroups[j].startTick;

                    var maxDuration = 0;
                    for (var i = 0; i < list.length; i++) {
                        var item = list[i];

                        var tSince = (currentTick - startTick);
                        if (item.duration > maxDuration)
                            maxDuration = item.duration;

                        var percent = item.duration > 0 ? tSince / item.duration : 1;
                        var easeParecent = percent;
                        if (item.easing && item.duration != 0)
                            easeParecent = jQuery.easing[item.easing](percent, tSince, 0, 1, item.duration);

                        if (percent > 1) {
                            percent = 1;
                            easeParecent = 1;
                        }

                        if (item.fn) // custom function
                        {
                            item.fn(item.key, item.context, easeParecent);
                            continue;
                        }

                        var params = {};
                        for (var j = 0; j < item.properties.length; j++) {
                            var p = item.properties[j];
                            var val = 0;

                            if (percent == 1) {
                                val = p.to;
                            }
                            else {
                                val = easeParecent * (p.to - p.from) + p.from;
                            }

                            params[p.key] = val;
                        }
                        this.renderer.attr(item.key, params);
                    } // for i

                    if (startTick + maxDuration > currentTick)
                        animGroupsNewList[j] = ({ startTick: startTick, animations: list });
                } // for j

                this._animGroups = animGroupsNewList;

                if (this.renderer instanceof $.jqx.HTML5Renderer)
                    this.renderer.refresh();
            }

            this._animtimer = null;

            for (var j in this._animGroups) {
                this._enableAnimTimer();
                break;
            }

        }

    });

    //[optimize]
    $.jqx.toGreyScale = function (color) {
        var rgb = $.jqx.cssToRgb(color);
        rgb[0] = rgb[1] = rgb[2] = Math.round(0.3 * rgb[0] + 0.59 * rgb[1] + 0.11 * rgb[2]);
        var hex = $.jqx.rgbToHex(rgb[0], rgb[1], rgb[2]);
        return '#' + hex[0] + hex[1] + hex[2];
    },

    //[optimize]
    $.jqx._adjustColor = function (color, adj) {
        var rgb = $.jqx.cssToRgb(color);

        var color = '#'
        for (var i = 0; i < 3; i++) {
            var c = Math.round(adj * rgb[i]);
            if (c > 255)
                c = 255;
            else if (c <= 0)
                c = 0;
            c = $.jqx.decToHex(c);
            if (c.toString().length == 1)
                color += '0';

            color += c;
        }

        return color.toUpperCase();
    }

    //[optimize]
    $.jqx.decToHex = function (dec) {
        return dec.toString(16);
    },

    //[optimize]
        $.jqx.hexToDec = function (hex) {
            return parseInt(hex, 16);
        }

    //[optimize]
    $.jqx.rgbToHex = function (r, g, b) {
        return [$.jqx.decToHex(r), $.jqx.decToHex(g), $.jqx.decToHex(b)];
    }

    //[optimize]
    $.jqx.hexToRgb = function (h, e, x) {
        return [$.jqx.hexToDec(h), $.jqx.hexToDec(e), $.jqx.hexToDec(x)];
    }

    //[optimize]
    $.jqx.cssToRgb = function (color) {
        if (color.indexOf('rgb') <= -1) {
            return $.jqx.hexToRgb(color.substring(1, 3), color.substring(3, 5), color.substring(5, 7));
        }
        return color.substring(4, color.length - 1).split(',');
    }

    $.jqx.swap = function (x, y) {
        var tmp = x;
        x = y;
        y = tmp;
    }

    $.jqx.getNum = function (arr) {
        if (!$.isArray(arr)) {
            if (isNaN(arr))
                return 0;
        }
        else {
            for (var i = 0; i < arr.length; i++)
                if (!isNaN(arr[i]))
                    return arr[i];
        }

        return 0;
    }

    $.jqx._ptrnd = function (val) {
        if (!document.createElementNS) {
            if (Math.round(val) == val)
                return val;
            return $.jqx._rnd(val, 1, false);
        }

        var rnd = $.jqx._rnd(val, 0.5, false);
        if (Math.abs(rnd - Math.round(rnd)) != 0.5) {
            return rnd > val ? rnd - 0.5 : rnd + 0.5;
        }
        return rnd;
    }

    $.jqx._rup = function (n) {
        var nr = Math.round(n);
        if (n > nr)
            nr++;

        return nr;
    }

    $.jqx.log = function (val, base) {
        return Math.log(val) / (base ? Math.log(base) : 1);
    }


    $.jqx._rnd = function (num, unit, toGreater) {
        if (isNaN(num))
            return num;
        var a = num - num % unit;
        if (num == a)
            return a;

        if (toGreater) {
            if (num > a)
                a += unit;
        }
        else {
            if (a > num)
                a -= unit;
        }

        return a;
    }

    $.jqx.commonRenderer = {
        pieSlicePath: function (x, y, innerRadius, outerRadius, angleFrom, angleTo, centerOffset) {
            if (!outerRadius)
                outerRadius = 1;

            var diff = Math.abs(angleFrom - angleTo);
            var lFlag = diff > 180 ? 1 : 0;
            if (diff >= 360) {
                angleTo = angleFrom + 359.99;
            }
            var radFrom = angleFrom * Math.PI * 2 / 360;
            var radTo = angleTo * Math.PI * 2 / 360;

            var x1 = x, x2 = x, y1 = y, y2 = y;

            var isDonut = !isNaN(innerRadius) && innerRadius > 0;

            if (isDonut)
                centerOffset = 0;

            if (centerOffset + innerRadius > 0) {
                if (centerOffset > 0) {
                    var midAngle = diff / 2 + angleFrom;
                    var radMid = midAngle * Math.PI * 2 / 360;

                    x += centerOffset * Math.cos(radMid);
                    y -= centerOffset * Math.sin(radMid);
                }

                if (isDonut) {
                    var inR = innerRadius;
                    x1 = x + inR * Math.cos(radFrom);
                    y1 = y - inR * Math.sin(radFrom);
                    x2 = x + inR * Math.cos(radTo);
                    y2 = y - inR * Math.sin(radTo);
                }
            }

            var x3 = x + outerRadius * Math.cos(radFrom);
            var x4 = x + outerRadius * Math.cos(radTo);
            var y3 = y - outerRadius * Math.sin(radFrom);
            var y4 = y - outerRadius * Math.sin(radTo);

            var path = '';

            if (isDonut) {
                path = 'M ' + x2 + ',' + y2;
                path += ' a' + innerRadius + ',' + innerRadius;
                path += ' 0 ' + lFlag + ',1 ' + (x1 - x2) + ',' + (y1 - y2);
                path += ' L' + x3 + ',' + y3;
                path += ' a' + outerRadius + ',' + outerRadius;
                path += ' 0 ' + lFlag + ',0 ' + (x4 - x3) + ',' + (y4 - y3);
            }
            else {
                path = 'M ' + x4 + ',' + y4;
                path += ' a' + outerRadius + ',' + outerRadius;
                path += ' 0 ' + lFlag + ',1 ' + (x3 - x4) + ',' + (y3 - y4);
                path += ' L' + x + ',' + y + ' Z';
            }

            return path;
        }
    }

    $.jqx.svgRenderer = function () { }

    $.jqx.svgRenderer.prototype = {
        _svgns: "http://www.w3.org/2000/svg",

        init: function (host) {
            var s = "<table id=tblChart cellspacing='0' cellpadding='0' border='0' align='left' valign='top'><tr><td colspan=2 id=tdTop></td></tr><tr><td id=tdLeft></td><td class='chartContainer'></td></tr></table>";
            host.append(s);
            this.host = host;
            var container = host.find(".chartContainer");
            container[0].style.width = host.width() + 'px';
            container[0].style.height = host.height() + 'px';
            var offset;
            try {
                var svg = document.createElementNS(this._svgns, 'svg');
                svg.setAttribute('id', 'svgChart');
                svg.setAttribute('version', '1.1');
                svg.setAttribute('width', '100%');
                svg.setAttribute('height', '100%');
                svg.setAttribute('overflow', 'hidden');
                //svg.setAttribute('shape-rendering', 'chispEdges'); //crisp-edges
                container[0].appendChild(svg);
                this.canvas = svg;
            }
            catch (e) {
                return false;
            }

            this._id = new Date().getTime();
            this.clear();

            this._layout();
            this._runLayoutFix();

            return true;
        },

        //[optimize]
        _runLayoutFix: function () {
            var self = this;
            this._fixLayout();
        },

        //[optimize]
        _fixLayout: function () {
            var offset = $(this.canvas).position();

            var pxleft = (parseFloat(offset.left) == parseInt(offset.left));
            var pxtop = (parseFloat(offset.top) == parseInt(offset.top));

            if ($.jqx.browser.msie) {
                var pxleft = true, pxtop = true;
                var el = this.host;
                var xdiff = 0, ydiff = 0;
                while (el && el.position && el[0].parentNode) {
                    var pos = el.position();
                    xdiff += parseFloat(pos.left) - parseInt(pos.left);
                    ydiff += parseFloat(pos.top) - parseInt(pos.top);
                    el = el.parent();
                }
                pxleft = parseFloat(xdiff) == parseInt(xdiff);
                pxtop = parseFloat(ydiff) == parseInt(ydiff);
            }

            if (!pxleft)
                this.host.find("#tdLeft")[0].style.width = '0.5px';
            if (!pxtop)
                this.host.find("#tdTop")[0].style.height = '0.5px';

        },

        //[optimize]
        _layout: function () {
            var offset = $(this.canvas).offset();
            var container = this.host.find(".chartContainer");
            this._width = Math.max($.jqx._rup(this.host.width()) - 1, 0);
            this._height = Math.max($.jqx._rup(this.host.height()) - 1, 0);

            container[0].style.width = this._width;
            container[0].style.height = this._height;

            this._fixLayout();
        },

        getRect: function () {
            return { x: 0, y: 0, width: this._width, height: this._height };
        },

        getContainer: function () {
            var container = this.host.find(".chartContainer");
            return container;
        },

        clear: function () {
            while (this.canvas.childElementCount > 0) {
                this.canvas.removeChild(this.canvas.firstElementChild);
            }

            this._defs = document.createElementNS(this._svgns, 'defs');
            this._gradients = {};
            this.canvas.appendChild(this._defs);
        },

        removeElement: function (element) {
            if (element != undefined) {
                try {
                    if (element.parentNode)
                        element.parentNode.removeChild(element);
                    else
                        this.canvas.removeChild(element);
                }
                catch (error) {
                }
            }
        },

        _openGroups: [],

        beginGroup: function () {
            var parent = this._activeParent();
            var g = document.createElementNS(this._svgns, 'g');
            parent.appendChild(g);
            this._openGroups.push(g);

            return g;
        },

        endGroup: function () {
            if (this._openGroups.length == 0)
                return;

            this._openGroups.pop();
        },

        _activeParent: function () {
            return this._openGroups.length == 0 ? this.canvas : this._openGroups[this._openGroups.length - 1];
        },

        //[optimize]
        createClipRect: function (rect) {
            var c = document.createElementNS(this._svgns, 'clipPath');
            var r = document.createElementNS(this._svgns, 'rect');
            this.attr(r, { x: rect.x, y: rect.y, width: rect.width, height: rect.height });

            this._clipId = this._clipId || 0;
            c.id = 'cl' + this._id + '_' + (++this._clipId).toString();
            c.appendChild(r);

            this._defs.appendChild(c);

            return c;
        },

        //[optimize]
        setClip: function (elem, clip) {
            return this.attr(elem, { 'clip-path': 'url(#' + clip.id + ')' });
        },

        _clipId: 0,

        //[optimize]
        addHandler: function (element, event, fn) {
            element['on' + event] = fn;
        },

        //[optimize]
        shape: function (name, params) {
            var s = document.createElementNS(this._svgns, name);
            if (!s)
                return undefined;

            for (var param in params)
                s.setAttribute(param, params[param]);

            this._activeParent().appendChild(s);

            return s;
        },

        //[optimize]
        measureText: function (text, angle, params) {
            var txt = document.createElementNS(this._svgns, 'text');
            this.attr(txt, params);
            txt.appendChild(txt.ownerDocument.createTextNode(text));

            var parent = this._activeParent();
            parent.appendChild(txt);
            var bbox;
            try {
                bbox = txt.getBBox();
            }
            catch (e) {
                if (console && console.log)
                    console.log(e);
            }

            if (bbox == undefined || isNaN(bbox.width) || isNaN(bbox.height) || Math.abs(bbox.width) == Infinity || Math.abs(bbox.height) == Infinity) // fix for Opera SVG
                return { width: 0, height: 0 };

            var tw = $.jqx._rup(bbox.width);
            var th = $.jqx._rup(bbox.height);
            parent.removeChild(txt);

            if (angle == 0)
                return { width: tw, height: th };

            var rads = angle * Math.PI * 2 / 360;
            var sn = Math.abs(Math.sin(rads));
            var cs = Math.abs(Math.cos(rads));
            var bh = Math.abs(tw * sn + th * cs);
            var bw = Math.abs(tw * cs + th * sn);

            return { width: $.jqx._rup(bw), height: $.jqx._rup(bh) };
        },

        //[optimize]
        text: function (text, x, y, width, height, angle, params, clip, halign, valign, rotateAround) {
            var gClip;
            if (!halign)
                halign = 'center';
            if (!valign)
                valign = 'center';
            if (clip) {
                gClip = this.beginGroup();
                var crect = this.createClipRect({ x: $.jqx._rup(x) - 1, y: $.jqx._rup(y) - 1, width: $.jqx._rup(width) + 2, height: $.jqx._rup(height) + 2 });
                this.setClip(gClip, crect);
            }

            var txt = document.createElementNS(this._svgns, 'text');
            this.attr(txt, params);
            this.attr(txt, { cursor: 'default' });
            txt.appendChild(txt.ownerDocument.createTextNode(text));

            var parent = this._activeParent();
            parent.appendChild(txt);
            var bbox;
            try {
                bbox = txt.getBBox();
            }
            catch (e) {
                if (console && console.log)
                    console.log(e);
            }
            if (bbox == undefined)
                return;

            parent.removeChild(txt);

            var tw = bbox.width;
            var th = bbox.height * 0.6;

            var w = width || 0;
            var h = height || 0;

            if (!angle || angle == 0) {
                if (halign == 'center')
                    x += (w - tw) / 2;
                else if (halign == 'right')
                    x += (w - tw);

                y += th;

                if (valign == 'center')
                    y += (h - th) / 2;
                else if (valign == 'bottom')
                    y += h - th;

                if (!width)
                    width = tw;

                if (!height)
                    height = th;

                this.attr(txt, { x: $.jqx._rup(x), y: $.jqx._rup(y), width: $.jqx._rup(width), height: $.jqx._rup(height) });
                parent.appendChild(txt);
                this.endGroup();

                return txt; // parent == this.canvas ? txt : parent;
            }
            var rads = angle * Math.PI * 2 / 360;
            var sn = Math.sin(rads);
            var cs = Math.cos(rads);

            var h2 = tw * sn;
            var w2 = tw * cs;

            var ySave = y;
            var xSave = x;

            if (halign == 'center' || halign == '' || halign == 'undefined')
                x = x + width / 2;
            else if (halign == 'right')
                x = x + width;
            if (valign == 'center' || valign == '' || valign == 'undefined')
                y += height / 2;
            else if (valign == 'bottom')
                y += height - th / 2;
            else if (valign == 'top')
                y += th / 2;

            rotateAround = rotateAround || '';

            var adjustY = 'middle';
            if (rotateAround.indexOf('top') != -1)
                adjustY = 'top';
            else if (rotateAround.indexOf('bottom') != -1)
                adjustY = 'bottom';

            var adjustX = 'center';
            if (rotateAround.indexOf('left') != -1)
                adjustX = 'left';
            else if (rotateAround.indexOf('right') != -1)
                adjustX = 'right';

            if (adjustX == 'center') {
                x -= w2 / 2;
                y -= h2 / 2;
            }
            else if (adjustX == 'right') {
                x -= w2;
                y -= h2;
            }

            if (adjustY == 'top')
                x -= th * sn;
            else if (adjustY == 'middle')
                x -= th * sn / 2;

            x = $.jqx._rup(x);
            y = $.jqx._rup(y);

            var gTranslate = this.shape('g', { transform: 'translate(' + x + ',' + y + ')' });
            var gRotate = this.shape('g', { transform: 'rotate(' + angle + ')' });

            gTranslate.appendChild(gRotate);
            gRotate.appendChild(txt);

            parent.appendChild(gTranslate);

            this.endGroup();

            return gTranslate;
        },

        //[optimize]
        line: function (x1, y1, x2, y2, params) {
            var line = this.shape('line', { x1: x1, y1: y1, x2: x2, y2: y2 });
            this.attr(line, params);
            return line;
        },

        //[optimize]
        path: function (points, params) {
            var s = this.shape('path');
            s.setAttribute('d', points);
            if (params) {
                this.attr(s, params);
            }
            return s;
        },

        //[optimize]
        rect: function (x, y, w, h, params) {
            x = $.jqx._ptrnd(x);
            y = $.jqx._ptrnd(y);
            w = $.jqx._rup(w);
            h = $.jqx._rup(h);
            var s = this.shape('rect', { x: x, y: y, width: w, height: h });
            if (params)
                this.attr(s, params);
            return s;
        },

        //[optimize]
        circle: function (x, y, r) {
            return this.shape('circle', { cx: x, cy: y, r: r });
        },

        //[optimize]
        pieSlicePath: function (x, y, innerRadius, outerRadius, angleFrom, angleTo, centerOffset) {
            return $.jqx.commonRenderer.pieSlicePath(x, y, innerRadius, outerRadius, angleFrom, angleTo, centerOffset);
        },

        //[optimize]
        pieslice: function (x, y, innerRadius, outerRadius, angleFrom, angleTo, centerOffset, params) {
            var pathCmd = this.pieSlicePath(x, y, innerRadius, outerRadius, angleFrom, angleTo, centerOffset);

            var s = this.shape('path');
            s.setAttribute('d', pathCmd);

            if (params)
                this.attr(s, params);

            return s;
        },

        //[optimize]
        attr: function (element, params) {
            if (!element || !params)
                return;
            for (var param in params) {
                if (param == "textContent")
                    element.textContent = params[param];
                else
                    element.setAttribute(param, params[param]);
            }
        },

        //[optimize]
        getAttr: function (element, key) {
            return element['getAttribute'](key);
        },

        //[optimize]
        _gradients: {},

        //[optimize]
        _toLinearGradient: function (color, isVertical, stops) {
            var id = 'grd' + this._id + color.replace('#', '') + (isVertical ? 'v' : 'h');

            var url = 'url(#' + id + ')';
            if (this._gradients[url])
                return url;

            var gr = document.createElementNS(this._svgns, 'linearGradient');
            this.attr(gr, { x1: '0%', y1: '0%', x2: isVertical ? '0%' : '100%', y2: isVertical ? '100%' : '0%', id: id });

            for (var stop in stops) {
                var s = document.createElementNS(this._svgns, 'stop');
                var st = 'stop-color:' + $.jqx._adjustColor(color, stops[stop][1]);
                this.attr(s, { offset: stops[stop][0] + '%', style: st });
                gr.appendChild(s);
            }

            this._defs.appendChild(gr);
            this._gradients[url] = true;

            return url;
        },

        //[optimize]
        _toRadialGradient: function (color, stops, coords) {
            var id = 'grd' + this._id + color.replace('#', '') + 'r' + (coords != undefined ? coords.key : '');

            var url = 'url(#' + id + ')';
            if (this._gradients[url])
                return url;

            var gr = document.createElementNS(this._svgns, 'radialGradient');
            if (coords == undefined)
                this.attr(gr, { cx: '50%', cy: '50%', r: '100%', fx: '50%', fy: '50%', id: id });
            else
                this.attr(gr, { cx: coords.x1, cy: coords.y1, r: coords.outerRadius, id: id, gradientUnits: 'userSpaceOnUse' });

            for (var stop in stops) {
                var s = document.createElementNS(this._svgns, 'stop');
                var st = 'stop-color:' + $.jqx._adjustColor(color, stops[stop][1]);
                this.attr(s, { offset: stops[stop][0] + '%', style: st });
                gr.appendChild(s);
            }

            this._defs.appendChild(gr);
            this._gradients[url] = true;

            return url;
        }

    } // svgRenderer

    $.jqx.vmlRenderer = function () { };
    $.jqx.vmlRenderer.prototype = {
        init: function (host) {
            var s = "<div class='chartContainer' style=\"position:relative;overflow:hidden;\"><div>";
            host.append(s);
            this.host = host;
            var container = host.find(".chartContainer");
            container[0].style.width = host.width() + 'px';
            container[0].style.height = host.height() + 'px';

            var addNamespace = true;

            try {
                for (var i = 0; i < document.namespaces.length; i++) {
                    if (document.namespaces[i].name == 'v' && document.namespaces[i].urn == "urn:schemas-microsoft-com:vml") {
                        addNamespace = false;
                        break;
                    }
                }
            }
            catch (e) {
                return false;
            }

            if ($.jqx.browser.msie && parseInt($.jqx.browser.version) < 9 &&
                (document.childNodes && document.childNodes.length > 0 && document.childNodes[0].data && document.childNodes[0].data.indexOf('DOCTYPE') != -1)
                ) {
                if (addNamespace) {
                    document.namespaces.add('v', 'urn:schemas-microsoft-com:vml');
                }

                this._ie8mode = true;
            }
            else {
                if (addNamespace) {
                    document.namespaces.add('v', 'urn:schemas-microsoft-com:vml');
                    document.createStyleSheet().cssText = "v\\:* { behavior: url(#default#VML); display: inline-block; }";
                }
            }

            this.canvas = container[0];

            this._width = Math.max($.jqx._rup(container.width()), 0);
            this._height = Math.max($.jqx._rup(container.height()), 0);

            container[0].style.width = this._width + 2;
            container[0].style.height = this._height + 2;

            this._id = new Date().getTime();
            this.clear();
            return true;
        },

        getRect: function () {
            return { x: 0, y: 0, width: this._width, height: this._height };
        },

        getContainer: function () {
            var container = this.host.find(".chartContainer");
            return container;
        },

        clear: function () {
            while (this.canvas.childElementCount > 0) {
                this.canvas.removeChild(this.canvas.firstElementChild);
            }

            this._gradients = {};
        },

        removeElement: function (element) {
            if (element != null) {
                element.parentNode.removeChild(element);
            }
        },

        _openGroups: [],

        beginGroup: function () {
            var parent = this._activeParent();
            var g = document.createElement('v:group');
            g.style.position = 'absolute';
            g.coordorigin = "0,0";
            g.coordsize = this._width + ',' + this._height;
            g.style.left = 0;
            g.style.top = 0;
            g.style.width = this._width;
            g.style.height = this._height;

            parent.appendChild(g);
            this._openGroups.push(g);
            return g;
        },

        endGroup: function () {
            if (this._openGroups.length == 0)
                return;

            this._openGroups.pop();
        },

        _activeParent: function () {
            return this._openGroups.length == 0 ? this.canvas : this._openGroups[this._openGroups.length - 1];
        },

        //[optimize]
        createClipRect: function (rect) {
            var div = document.createElement("div");
            div.style.height = rect.height + 'px';
            div.style.width = rect.width + 'px';
            div.style.position = 'absolute';
            div.style.left = rect.x + 'px';
            div.style.top = rect.y + 'px';
            div.style.overflow = 'hidden';

            this._clipId = this._clipId || 0;
            div.id = 'cl' + this._id + '_' + (++this._clipId).toString();
            this._activeParent().appendChild(div);
            return div;
        },

        //[optimize]
        setClip: function (elem, clip) {
            //if (elem.parentElement)
            //    elem.parentElement.removeChild(elem);

            clip.appendChild(elem);
        },

        _clipId: 0,

        //[optimize]
        addHandler: function (element, event, fn) {
            if ($(element).on) {
                $(element).on(event, fn);
            }
            else {
                $(element).bind(event, fn);
            }
        },

        //[optimize]
        measureText: function (text, angle, params) {
            var txtbox = document.createElement('v:textbox');
            var span = document.createElement('span');
            span.appendChild(document.createTextNode(text));
            txtbox.appendChild(span);
            if (params['class'])
                span.className = params['class'];

            var parent = this._activeParent();
            parent.appendChild(txtbox);
            var box = $(txtbox);
            var tw = $.jqx._rup(box.width());
            var th = $.jqx._rup(box.height());
            parent.removeChild(txtbox);

            if (th == 0 && $.jqx.browser.msie && parseInt($.jqx.browser.version) < 9) {
                var fontSize = box.css('font-size');
                if (fontSize) {
                    th = parseInt(fontSize);
                    if (isNaN(th)) th = 0;
                }
            }

            if (angle == 0)
                return { width: tw, height: th };

            var rads = angle * Math.PI * 2 / 360;
            var sn = Math.abs(Math.sin(rads));
            var cs = Math.abs(Math.cos(rads));
            var bh = Math.abs(tw * sn + th * cs);
            var bw = Math.abs(tw * cs + th * sn);

            return { width: $.jqx._rup(bw), height: $.jqx._rup(bh) };
        },

        //[optimize]
        text: function (text, x, y, width, height, angle, params, clip, halign, valign) {
            var color = params.stroke || 'black';
            var gClip;

            if (!halign)
                halign = 'center';
            if (!valign)
                valign = 'center';
            clip = false;
            if (clip) {
                gClip = this.beginGroup();
                var crect = this.createClipRect({ x: $.jqx._rup(x), y: $.jqx._rup(y), width: $.jqx._rup(width), height: $.jqx._rup(height) });
                this.setClip(gClip, crect);
            }

            var txtbox = document.createElement('v:textbox');
            txtbox.style.position = 'absolute';

            var span = document.createElement('span');
            span.appendChild(document.createTextNode(text));
            if (params['class']) {
                span.className = params['class'];
            }
            txtbox.appendChild(span);

            var parent = this._activeParent();
            parent.appendChild(txtbox);

            var tw = $(txtbox).width();
            var th = $(txtbox).height();
            parent.removeChild(txtbox);

            var w = width || 0;
            var h = height || 0;

            if (!angle || angle == 0 || Math.abs(angle) != 90) {
                if (halign == 'center')
                    x += (w - tw) / 2;
                else if (halign == 'right')
                    x += (w - tw);

                if (valign == 'center')
                    y = y + (h - th) / 2;
                else if (valign == 'bottom')
                    y = y + h - th;

                if (!width)
                    width = tw;

                if (!height)
                    height = th;

                if (!gClip) {
                    txtbox.style.left = $.jqx._rup(x);
                    txtbox.style.top = $.jqx._rup(y);
                    txtbox.style.width = $.jqx._rup(width);
                    txtbox.style.height = $.jqx._rup(height);
                }
                parent.appendChild(txtbox);

                if (gClip) {
                    this.endGroup();
                    return parent;
                }

                return txtbox;
            }

            var rads = angle * Math.PI * 2 / 360;
            var bh = Math.abs(tw * Math.sin(rads) - th * Math.cos(rads));
            var bw = Math.abs(tw * Math.cos(rads) + th * Math.sin(rads));

            if (halign == 'center')
                x += (w - bw) / 2;
            else if (halign == 'right')
                x += (w - bw);

            if (valign == 'center')
                y = y + (h - bh) / 2;
            else if (valign == 'bottom')
                y = y + h - bh;

            x = $.jqx._rup(x);
            y = $.jqx._rup(y);
            var x2 = $.jqx._rup(x + bw);
            var y2 = $.jqx._rup(y + bh);

            if (Math.abs(angle) == 90) {
                parent.appendChild(txtbox);
                txtbox.style.left = $.jqx._rup(x);
                txtbox.style.top = $.jqx._rup(y);

                txtbox.style.filter = 'progid:DXImageTransform.Microsoft.BasicImage(rotation=3)';

                if (gClip) {
                    this.endGroup();
                    return parent;
                }

                return txtbox;
            }

            return txtbox;
        },

        //[optimize]
        shape: function (name, params) {
            var s = document.createElement(this._createElementMarkup(name));
            if (!s)
                return undefined;

            for (var param in params)
                s.setAttribute(param, params[param]);

            this._activeParent().appendChild(s);

            return s;
        },

        line: function (x1, y1, x2, y2, params) {
            var linePath = 'M ' + x1 + ',' + y1 + ' L ' + x2 + ',' + y2 + ' X E';
            var line = this.path(linePath);
            this.attr(line, params);
            return line;
        },

        _createElementMarkup: function (shape) {
            var str = '<v:' + shape + ' style=\"\">' + '</v:' + shape + '>';
            if (this._ie8mode) {
                str = str.replace('style=\"\"', 'style=\"behavior: url(#default#VML);\"');
            }

            return str;
        },

        //[optimize]
        path: function (points, params) {
            var shape = document.createElement(this._createElementMarkup('shape'));
            shape.style.position = 'absolute';
            shape.coordsize = this._width + ' ' + this._height;
            shape.coordorigin = '0 0';
            shape.style.width = parseInt(this._width);
            shape.style.height = parseInt(this._height);
            shape.style.left = 0;
            shape.style.top = 0;
            var path = document.createElement(this._createElementMarkup('path'));
            path.v = points;
            shape.appendChild(path);
            this._activeParent().appendChild(shape);
            if (params)
                this.attr(shape, params);

            return shape;
        },

        //[optimize]
        rect: function (x, y, w, h, params) {
            x = $.jqx._ptrnd(x);
            y = $.jqx._ptrnd(y);
            w = $.jqx._rup(w);
            h = $.jqx._rup(h);
            var vmlRect = this.shape('rect', params);
            vmlRect.style.position = 'absolute';
            vmlRect.style.left = x;
            vmlRect.style.top = y;
            vmlRect.style.width = w;
            vmlRect.style.height = h;
            vmlRect.strokeweight = 0;
            return vmlRect;
        },

        //[optimize]
        circle: function (x, y, r) {
            var vmlCircle = this.shape('oval');
            x = $.jqx._ptrnd(x - r);
            y = $.jqx._ptrnd(y - r);
            r = $.jqx._rup(r);
            vmlCircle.style.position = 'absolute';
            vmlCircle.style.left = x;
            vmlCircle.style.top = y;
            vmlCircle.style.width = r * 2;
            vmlCircle.style.height = r * 2;
            return vmlCircle;
        },

        updateCircle: function (circle, x, y, r) {
            if (x == undefined)
                x = parseFloat(circle.style.left) + parseFloat(circle.style.width) / 2;
            if (y == undefined)
                y = parseFloat(circle.style.top) + parseFloat(circle.style.height) / 2;
            if (r == undefined)
                r = parseFloat(circle.width) / 2;

            x = $.jqx._ptrnd(x - r);
            y = $.jqx._ptrnd(y - r);
            r = $.jqx._rup(r);
            circle.style.left = x;
            circle.style.top = y;
            circle.style.width = r * 2;
            circle.style.height = r * 2;
        },

        pieSlicePath: function (x, y, innerRadius, outerRadius, angleFrom, angleTo, centerOffset) {
            if (!outerRadius)
                outerRadius = 1;

            var diff = Math.abs(angleFrom - angleTo);
            var lFlag = diff > 180 ? 1 : 0;
            if (diff > 360) {
                angleFrom = 0;
                angleTo = 360;
            }
            var radFrom = angleFrom * Math.PI * 2 / 360;
            var radTo = angleTo * Math.PI * 2 / 360;

            var x1 = x, x2 = x, y1 = y, y2 = y;
            var isDonut = !isNaN(innerRadius) && innerRadius > 0;

            if (isDonut)
                centerOffset = 0;

            if (centerOffset > 0) {
                var midAngle = diff / 2 + angleFrom;
                var radMid = midAngle * Math.PI * 2 / 360;

                x += centerOffset * Math.cos(radMid);
                y -= centerOffset * Math.sin(radMid);
            }

            if (isDonut) {
                var inR = innerRadius;
                x1 = $.jqx._ptrnd(x + inR * Math.cos(radFrom));
                y1 = $.jqx._ptrnd(y - inR * Math.sin(radFrom));
                x2 = $.jqx._ptrnd(x + inR * Math.cos(radTo));
                y2 = $.jqx._ptrnd(y - inR * Math.sin(radTo));
            }

            var x3 = $.jqx._ptrnd(x + outerRadius * Math.cos(radFrom));
            var x4 = $.jqx._ptrnd(x + outerRadius * Math.cos(radTo));
            var y3 = $.jqx._ptrnd(y - outerRadius * Math.sin(radFrom));
            var y4 = $.jqx._ptrnd(y - outerRadius * Math.sin(radTo));

            outerRadius = $.jqx._ptrnd(outerRadius);
            innerRadius = $.jqx._ptrnd(innerRadius);

            x = $.jqx._ptrnd(x);
            y = $.jqx._ptrnd(y);

            var aStart = Math.round(angleFrom * 65535);
            var aEnd = Math.round(angleTo - angleFrom) * 65536;

            var path = '';
            if (isDonut) {
                path = 'M' + x1 + ' ' + y1;
                path += ' AE ' + x + ' ' + y + ' ' + innerRadius + ' ' + innerRadius + ' ' + aStart + ' ' + aEnd;
                path += ' L ' + x4 + ' ' + y4;
                aStart = Math.round(angleFrom - angleTo) * 65535;
                aEnd = Math.round(angleTo) * 65536;
                path += ' AE ' + x + ' ' + y + ' ' + outerRadius + ' ' + outerRadius + ' ' + aEnd + ' ' + aStart;
                path += ' L ' + x1 + ' ' + y1;
            }
            else {
                path = 'M' + x + ' ' + y;
                path += ' AE ' + x + ' ' + y + ' ' + outerRadius + ' ' + outerRadius + ' ' + aStart + ' ' + aEnd;
            }

            path += ' X E';

            return path;
        },

        pieslice: function (x, y, innerRadius, outerRadius, angleFrom, angleTo, centerOffset, params) {

            var pathCmd = this.pieSlicePath(x, y, innerRadius, outerRadius, angleFrom, angleTo, centerOffset);
            var el = this.path(pathCmd, params);

            if (params)
                this.attr(el, params);

            return el;
        },


        _keymap: [
                { svg: 'fill', vml: 'fillcolor' },
                { svg: 'stroke', vml: 'strokecolor' },
                { svg: 'stroke-width', vml: 'strokeweight' },
                { svg: 'stroke-dasharray', vml: 'dashstyle' },
                { svg: 'fill-opacity', vml: 'fillopacity' },
                { svg: 'opacity', vml: 'opacity' },
                { svg: 'cx', vml: 'style.left' },
                { svg: 'cy', vml: 'style.top' },
                { svg: 'height', vml: 'style.height' },
                { svg: 'width', vml: 'style.width' },
                { svg: 'x', vml: 'style.left' },
                { svg: 'y', vml: 'style.top' },
                { svg: 'd', vml: 'v' },
                { svg: 'display', vml: 'style.display' }
                ],

        //[optimize]
        _translateParam: function (name) {
            for (var key in this._keymap) {
                if (this._keymap[key].svg == name)
                    return this._keymap[key].vml;
            }

            return name;
        },

        //[optimize]
        attr: function (element, params) {
            if (!element || !params)
                return;
            for (var param in params) {
                var vmlparam = this._translateParam(param);
                if (vmlparam == 'fillcolor' && params[param].indexOf('grd') != -1) {
                    element.type = params[param];
                }
                else if (vmlparam == 'opacity' || vmlparam == 'fillopacity') {
                    if (element.fill) {
                        element.fill.opacity = params[param];
                    }
                }
                else if (vmlparam == 'textContent') {
                    element.children[0].innerText = params[param];
                }
                else if (vmlparam == 'dashstyle') {
                    element.dashstyle = params[param].replace(',', ' ');
                }
                else {
                    if (vmlparam.indexOf('style.') == -1)
                        element[vmlparam] = params[param];
                    else
                        element.style[vmlparam.replace('style.', '')] = params[param];
                }
            }
        },

        //[optimize]
        getAttr: function (element, key) {
            var vmlparam = this._translateParam(key);
            if (vmlparam == 'opacity' || vmlparam == 'fillopacity')
                if (element.fill) {
                    return element.fill.opacity;
                }
                else {
                    return 1;
                }

            if (vmlparam.indexOf('style.') == -1)
                return element[vmlparam];

            return element.style[vmlparam.replace('style.', '')];
        },

        //[optimize]
        _gradients: {},

        _toRadialGradient: function (color, isVertical, stops) {
            return color;
        },

        //[optimize]
        _toLinearGradient: function (color, isVertical, stops) {
            if (this._ie8mode) {
                return color;
            }

            var id = 'grd' + color.replace('#', '') + (isVertical ? 'v' : 'h');
            var ref = '#' + id + '';
            if (this._gradients[ref])
                return ref;

            var gr = document.createElement(this._createElementMarkup('fill'));
            gr.type = 'gradient';
            gr.method = 'linear';
            gr.angle = isVertical ? 0 : 90;

            var colors = '';
            for (var stop in stops) {
                if (stop > 0)
                    colors += ', ';
                colors += stops[stop][0] + '% ' + $.jqx._adjustColor(color, stops[stop][1]);
            }

            gr.colors = colors;

            var shapetype = document.createElement(this._createElementMarkup('shapetype'));
            shapetype.appendChild(gr);
            shapetype.id = id;

            this.canvas.appendChild(shapetype);

            return ref;
        }
    } // vmlRenderer

    /************************************************
    * jQWidgets HTML5 Canvas Renderer               *
    ************************************************/
    $.jqx.HTML5Renderer = function () { }

    $.jqx.ptrnd = function (val) {
        if (Math.abs(Math.round(val) - val) == 0.5)
            return val;

        var rnd = Math.round(val);
        if (rnd < val)
            rnd = rnd - 1;

        return rnd + 0.5;
    }


    $.jqx.HTML5Renderer.prototype = {
        _elements: {},

        init: function (host) {
            try {
                this.host = host;
                this.host.append("<canvas id='__jqxCanvasWrap' style='width:100%; height: 100%;'/>");
                this.canvas = host.find('#__jqxCanvasWrap');
                this.canvas[0].width = host.width();
                this.canvas[0].height = host.height();
                this.ctx = this.canvas[0].getContext('2d');
            }
            catch (e) {
                return false;
            }

            return true;
        },

        getContainer: function () {
            if (this.canvas && this.canvas.length == 1)
                return this.canvas;

            return undefined;
        },


        getRect: function () {
            return { x: 0, y: 0, width: this.canvas[0].width - 1, height: this.canvas[0].height - 1 };
        },

        beginGroup: function () {
            // TODO
        },

        endGroup: function () {
            // TODO
        },

        setClip: function () {
            // TODO
        },

        createClipRect: function (rect) {
            // TODO
        },

        addHandler: function (element, event, fn) {
            // TODO
            //element['on' + event] = fn;
        },


        clear: function () {
            this._elements = {};
            this._maxId = 0;
            this._renderers._gradients = {};
            this._gradientId = 0;
        },

        removeElement: function (element) {
            if (this._elements[element.id])
                delete this._elements[element, id];
        },

        _maxId: 0,

        shape: function (name, params) {
            var s = { type: name, id: this._maxId++ };

            for (var param in params)
                s[param] = params[param];

            this._elements[s.id] = s;

            return s;
        },

        attr: function (element, params) {
            for (var param in params)
                element[param] = params[param];
        },

        rect: function (x, y, w, h, params) {
            if (isNaN(x))
                throw 'Invalid value for "x"';
            if (isNaN(y))
                throw 'Invalid value for "y"';
            if (isNaN(w))
                throw 'Invalid value for "width"';
            if (isNaN(h))
                throw 'Invalid value for "height"';

            var s = this.shape('rect', { x: x, y: y, width: w, height: h });
            if (params)
                this.attr(s, params);
            return s;
        },

        path: function (pathCmd, params) {
            var s = this.shape('path', params);
            this.attr(s, { d: pathCmd });
            return s;
        },

        line: function (x1, y1, x2, y2, params) {
            return this.path('M ' + x1 + ',' + y1 + ' L ' + x2 + ',' + y2, params);
        },

        circle: function (x, y, r, params) {
            var s = this.shape('circle', { x: x, y: y, r: r });
            if (params)
                this.attr(s, params);
            return s;
        },

        pieSlicePath: function (x, y, innerRadius, outerRadius, angleFrom, angleTo, centerOffset) {
            return $.jqx.commonRenderer.pieSlicePath(x, y, innerRadius, outerRadius, angleFrom, angleTo, centerOffset);
        },

        pieslice: function (x, y, innerRadius, outerRadius, angleFrom, angleTo, centerOffset, params) {
            var element = this.path(this.pieSlicePath(x, y, innerRadius, outerRadius, angleFrom, angleTo, centerOffset), params);
            this.attr(element, { x: x, y: y, innerRadius: innerRadius, outerRadius: outerRadius, angleFrom: angleFrom, angleTo: angleTo });
            return element;
        },

        _getCSSStyle: function (name) {
            var sheets = document.styleSheets;
            try {
                for (var i = 0; i < sheets.length; i++) {
                    for (var j = 0; sheets[i].cssRules && j < sheets[i].cssRules.length; j++) {
                        if (sheets[i].cssRules[j].selectorText.indexOf(name) != -1)
                            return sheets[i].cssRules[j].style;
                    }
                }
            }
            catch (e) {
            }

            return {};
        },

        measureText: function (text, angle, params) {
            var fontFamily = 'Arial';
            var fontSize = '10pt';
            var fontWeight = '';
            if (params['class']) {
                var style = this._getCSSStyle(params['class']);
                if (style['fontSize'])
                    fontSize = style['fontSize'];
                if (style['fontFamily'])
                    fontFamily = style['fontFamily'];
                if (style['fontWeight'])
                    fontWeight = style['fontWeight'];
            }

            this.ctx.font = fontWeight + ' ' + fontSize + ' ' + fontFamily;
            var tw = this.ctx.measureText(text).width;

            var span = document.createElement("span");
            span.font = this.ctx.font;
            span.textContent = text;
            document.body.appendChild(span);
            var th = span.offsetHeight * 0.6;
            document.body.removeChild(span);

            if (angle == 0)
                return { width: tw, height: th };

            var rads = angle * Math.PI * 2 / 360;
            var sn = Math.abs(Math.sin(rads));
            var cs = Math.abs(Math.cos(rads));
            var bh = Math.abs(tw * sn + th * cs);
            var bw = Math.abs(tw * cs + th * sn);

            return { width: $.jqx._rup(bw), height: $.jqx._rup(bh) };
        },

        //[optimize]
        text: function (text, x, y, width, height, angle, params, clip, halign, valign, rotateAround) {
            var t = this.shape('text', { text: text, x: x, y: y, width: width, height: height, angle: angle, clip: clip, halign: halign, valign: valign, rotateAround: rotateAround });
            if (params) {
                this.attr(t, params);
            }

            t.fontFamily = 'Arial';
            t.fontSize = '10pt';
            t.fontWeight = '';
            t.color = '#000000';
            if (params['class']) {
                var style = this._getCSSStyle(params['class']);
                t.fontFamily = style.fontFamily || t.fontFamily;
                t.fontSize = style.fontSize || t.fontSize;
                t.fontWeight = style['fontWeight'] || t.fontWeight;
                t.color = style.color || t.color;
            }

            var sz = this.measureText(text, 0, params);
            t.textWidth = sz.width;
            t.textHeight = sz.height;

            return t;
        },

        _toLinearGradient: function (color, isVertical, stops) {
            if (this._renderers._gradients[color])
                return color;

            var colorStops = [];
            for (var i = 0; i < stops.length; i++)
                colorStops.push({ percent: stops[i][0] / 100, color: $.jqx._adjustColor(color, stops[i][1]) });

            var name = 'gr' + this._gradientId++;
            this.createGradient(name, isVertical ? 'vertical' : 'horizontal', colorStops);
            return name;
        },

        _toRadialGradient: function (color, stops) {
            if (this._renderers._gradients[color])
                return color;

            var colorStops = [];
            for (var i = 0; i < stops.length; i++)
                colorStops.push({ percent: stops[i][0] / 100, color: $.jqx._adjustColor(color, stops[i][1]) });

            var name = 'gr' + this._gradientId++;
            this.createGradient(name, 'radial', colorStops);
            return name;
        },

        _gradientId: 0,

        //[optimize]
        createGradient: function (name, orientation, colorStops) {
            this._renderers.createGradient(name, orientation, colorStops);
        },

        _renderers: {
            _gradients: {},

            //[optimize]
            createGradient: function (name, orientation, colorStops) {
                this._gradients[name] = { orientation: orientation, colorStops: colorStops };
            },

            setStroke: function (ctx, params) {
                ctx.strokeStyle = params['stroke'] || 'transparent';
                ctx.lineWidth = params['stroke-width'] || 1;
                if (ctx.setLineDash) {
                    if (params['stroke-dasharray'])
                        ctx.setLineDash(params['stroke-dasharray'].split(','));
                    else
                        ctx.setLineDash([]);
                }
            },

            setFillStyle: function (ctx, params) {
                ctx.fillStyle = 'transparent';

                if (params['fill-opacity']) {
                    ctx.globalAlpha = params['fill-opacity'];
                }
                else {
                    ctx.globalAlpha = 1;
                }

                if (params.fill && params.fill.indexOf('#') == -1 && this._gradients[params.fill]) {
                    var isVertical = this._gradients[params.fill].orientation != 'horizontal';
                    var isRadial = this._gradients[params.fill].orientation == 'radial';
                    var x1 = $.jqx.ptrnd(params.x);
                    var y1 = $.jqx.ptrnd(params.y);
                    var x2 = $.jqx.ptrnd(params.x + (isVertical ? 0 : params.width));
                    var y2 = $.jqx.ptrnd(params.y + (isVertical ? params.height : 0));

                    var gradient;

                    if ((params.type == 'circle' || params.type == 'path') && isRadial) {
                        x = $.jqx.ptrnd(params.x);
                        y = $.jqx.ptrnd(params.y);
                        r1 = params.innerRadius || 0;
                        r2 = params.outerRadius || params.r || 0;
                        gradient = ctx.createRadialGradient(x, y, r1, x, y, r2);
                    }

                    if (!isRadial) {
                        if (isNaN(x1) || isNaN(x2) || isNaN(y1) || isNaN(y2)) {
                            x1 = 0;
                            y1 = 0;
                            x2 = isVertical ? 0 : ctx.canvas.width;
                            y2 = isVertical ? ctx.canvas.height : 0;
                        }

                        gradient = ctx.createLinearGradient(x1, y1, x2, y2);
                    }

                    var colorStops = this._gradients[params.fill].colorStops;
                    for (var i = 0; i < colorStops.length; i++)
                        gradient.addColorStop(colorStops[i].percent, colorStops[i].color);

                    ctx.fillStyle = gradient;
                }
                else if (params.fill) {
                    ctx.fillStyle = params.fill;
                }
            },

            rect: function (ctx, params) {
                if (params.width == 0 || params.height == 0)
                    return;
                ctx.fillRect($.jqx.ptrnd(params.x), $.jqx.ptrnd(params.y), params.width, params.height);
                ctx.strokeRect($.jqx.ptrnd(params.x), $.jqx.ptrnd(params.y), params.width, params.height);
            },

            circle: function (ctx, params) {
                if (params.r == 0)
                    return;
                ctx.beginPath();
                ctx.arc($.jqx.ptrnd(params.x), $.jqx.ptrnd(params.y), params.r, 0, Math.PI * 2, false);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            },

            _parsePoint: function (str) {
                var x = this._parseNumber(str);
                var y = this._parseNumber(str);
                return ({ x: x, y: y });
            },

            _parseNumber: function (str) {
                var numStarted = false;
                for (var i = this._pos; i < str.length; i++) {
                    if ((str[i] >= '0' && str[i] <= '9') || str[i] == '.' || (str[i] == '-' && !numStarted)) {
                        numStarted = true;
                        continue;
                    }
                    if (!numStarted && (str[i] == ' ' || str[i] == ',')) {
                        this._pos++;
                        continue;
                    }

                    break;
                }

                var val = parseFloat(str.substring(this._pos, i));
                if (isNaN(val))
                    return undefined;

                this._pos = i;
                return val;
            },

            _pos: 0,
            _cmds: "mlcaz",
            _lastCmd: '',

            _isRelativeCmd: function (cmd) {
                return $.jqx.string.contains(this._cmds, cmd);
            },

            _parseCmd: function (string) {
                for (var i = this._pos; i < string.length; i++) {
                    if ($.jqx.string.containsIgnoreCase(this._cmds, string[i])) {
                        this._pos = i + 1;
                        this._lastCmd = string[i];
                        return this._lastCmd;
                    }
                    if (string[i] == ' ') {
                        this._pos++;
                        continue;
                    }
                    if (string[i] >= '0' && string[i] <= '9') {
                        this._pos = i /*+ 1*/;
                        if (this._lastCmd == '')
                            break;
                        else
                            return this._lastCmd;
                    }
                }

                return undefined;
            },

            _toAbsolutePoint: function (point) {
                return { x: this._currentPoint.x + point.x, y: this._currentPoint.y + point.y };
            },

            _currentPoint: { x: 0, y: 0 },

            path: function (ctx, params) {
                var path = params.d;

                this._pos = 0;
                this._lastCmd = '';

                var firstPoint = undefined;
                this._currentPoint = { x: 0, y: 0 };

                ctx.beginPath();

                var i = 0;
                while (this._pos < path.length) {
                    var cmd = this._parseCmd(path);
                    if (cmd == undefined)
                        break;

                    if (cmd == 'M' || cmd == 'm') {
                        var point = this._parsePoint(path);
                        if (point == undefined)
                            break;
                        ctx.moveTo(point.x, point.y);
                        this._currentPoint = point;
                        if (firstPoint == undefined)
                            firstPoint = point;

                        continue;
                    }

                    if (cmd == 'L' || cmd == 'l') {
                        var point = this._parsePoint(path);
                        if (point == undefined)
                            break;

                        ctx.lineTo(point.x, point.y);
                        this._currentPoint = point;
                        continue;
                    }

                    if (cmd == 'A' || cmd == 'a') {
                        var rx = this._parseNumber(path);
                        var ry = this._parseNumber(path);
                        var angle = this._parseNumber(path) * (Math.PI / 180.0);
                        var largeFlag = this._parseNumber(path);
                        var sweepFlag = this._parseNumber(path);
                        var endPoint = this._parsePoint(path);

                        if (this._isRelativeCmd(cmd)) {
                            endPoint = this._toAbsolutePoint(endPoint);
                        }

                        if (rx == 0 || ry == 0)
                            continue;

                        var cp = this._currentPoint;

                        /// START
                        // x1', y1'
                        var cp2 = {
                            x: Math.cos(angle) * (cp.x - endPoint.x) / 2.0 + Math.sin(angle) * (cp.y - endPoint.y) / 2.0,
                            y: -Math.sin(angle) * (cp.x - endPoint.x) / 2.0 + Math.cos(angle) * (cp.y - endPoint.y) / 2.0
                        };

                        // adjust radii
                        var adj = Math.pow(cp2.x, 2) / Math.pow(rx, 2) + Math.pow(cp2.y, 2) / Math.pow(ry, 2);
                        if (adj > 1) {
                            rx *= Math.sqrt(adj);
                            ry *= Math.sqrt(adj);
                        }

                        // cx', cy'
                        var s = (largeFlag == sweepFlag ? -1 : 1) * Math.sqrt(
								((Math.pow(rx, 2) * Math.pow(ry, 2)) - (Math.pow(rx, 2) * Math.pow(cp2.y, 2)) - (Math.pow(ry, 2) * Math.pow(cp2.x, 2))) /
								(Math.pow(rx, 2) * Math.pow(cp2.y, 2) + Math.pow(ry, 2) * Math.pow(cp2.x, 2))
							);

                        if (isNaN(s))
                            s = 0;

                        var cp3 = { x: s * rx * cp2.y / ry, y: s * -ry * cp2.x / rx };

                        // cx, cy
                        var centerPoint = {
                            x: (cp.x + endPoint.x) / 2.0 + Math.cos(angle) * cp3.x - Math.sin(angle) * cp3.y,
                            y: (cp.y + endPoint.y) / 2.0 + Math.sin(angle) * cp3.x + Math.cos(angle) * cp3.y
                        };

                        // vector magnitude
                        var m = function (v) { return Math.sqrt(Math.pow(v[0], 2) + Math.pow(v[1], 2)); }

                        // ratio between two vectors
                        var r = function (u, v) { return (u[0] * v[0] + u[1] * v[1]) / (m(u) * m(v)) }

                        // angle between two vectors
                        var a = function (u, v) { return (u[0] * v[1] < u[1] * v[0] ? -1 : 1) * Math.acos(r(u, v)); }

                        // initial angle
                        var startAngle = a([1, 0], [(cp2.x - cp3.x) / rx, (cp2.y - cp3.y) / ry]);

                        // angle delta
                        var u = [(cp2.x - cp3.x) / rx, (cp2.y - cp3.y) / ry];
                        var v = [(-cp2.x - cp3.x) / rx, (-cp2.y - cp3.y) / ry];
                        var deltaAngle = a(u, v);
                        if (r(u, v) <= -1)
                            deltaAngle = Math.PI;

                        if (r(u, v) >= 1)
                            deltaAngle = 0;

                        if (sweepFlag == 0 && deltaAngle > 0)
                            deltaAngle = deltaAngle - 2 * Math.PI;

                        if (sweepFlag == 1 && deltaAngle < 0)
                            deltaAngle = deltaAngle + 2 * Math.PI;

                        var r = (rx > ry) ? rx : ry;
                        var sx = (rx > ry) ? 1 : rx / ry;
                        var sy = (rx > ry) ? ry / rx : 1;

                        ctx.translate(centerPoint.x, centerPoint.y);
                        ctx.rotate(angle);
                        ctx.scale(sx, sy);
                        ctx.arc(0, 0, r, startAngle, startAngle + deltaAngle, 1 - sweepFlag);
                        ctx.scale(1 / sx, 1 / sy);
                        ctx.rotate(-angle);

                        ctx.translate(-centerPoint.x, -centerPoint.y);

                        continue;
                    }

                    if ((cmd == 'Z' || cmd == 'z') && firstPoint != undefined) {
                        ctx.lineTo(firstPoint.x, firstPoint.y);
                        this._currentPoint = firstPoint;
                        continue;
                    }

                    if (cmd == 'C' || cmd == 'c') {
                        var p1 = this._parsePoint(path);
                        var p2 = this._parsePoint(path);
                        var p3 = this._parsePoint(path);

                        ctx.bezierCurveTo(p1.x, p1.y, p2.x, p2.y, p3.x, p3.y);
                        this._currentPoint = p3;
                        continue;
                    }

                }

                ctx.fill();
                ctx.stroke();
                ctx.closePath();
            },

            text: function (ctx, params) {
                var x = $.jqx.ptrnd(params.x);
                var y = $.jqx.ptrnd(params.y);
                var width = $.jqx.ptrnd(params.width);
                var height = $.jqx.ptrnd(params.height);
                var halign = params.halign;
                var valign = params.valign;
                var angle = params.angle;
                var rotateAround = params.rotateAround;
                var clip = params.clip;
                if (clip == undefined)
                    clip = true;

                ctx.save();

                if (!halign)
                    halign = 'center';
                if (!valign)
                    valign = 'center';

                if (clip) {
                    ctx.rect(x - 2, y - 2, width + 5, height + 5);
                    ctx.clip();
                }

                var tw = params.textWidth;
                var th = params.textHeight;

                var w = width || 0;
                var h = height || 0;

                ctx.fillStyle = params.color;
                ctx.font = params.fontWeight + ' ' + params.fontSize + ' ' + params.fontFamily;

                if (!angle || angle == 0) {
                    if (halign == 'center')
                        x += (w - tw) / 2;
                    else if (halign == 'right')
                        x += (w - tw);

                    y += th;

                    if (valign == 'center')
                        y += (h - th) / 2;
                    else if (valign == 'bottom')
                        y += h - th;

                    if (!width)
                        width = tw;

                    if (!height)
                        height = th;

                    ctx.fillText(params.text, x, y);
                    ctx.restore();
                    return;
                }
                var rads = angle * Math.PI * 2 / 360;
                var sn = Math.sin(rads);
                var cs = Math.cos(rads);

                var h2 = tw * sn;
                var w2 = tw * cs;

                var ySave = y;
                var xSave = x;

                if (halign == 'center' || halign == '' || halign == 'undefined')
                    x = x + width / 2;
                else if (halign == 'right')
                    x = x + width;
                if (valign == 'center' || valign == '' || valign == 'undefined')
                    y = y + height / 2;
                else if (valign == 'bottom')
                    y += height - th / 2;
                else if (valign == 'top')
                    y += th / 2;

                rotateAround = rotateAround || '';

                var adjustY = 'middle';
                if (rotateAround.indexOf('top') != -1)
                    adjustY = 'top';
                else if (rotateAround.indexOf('bottom') != -1)
                    adjustY = 'bottom';

                var adjustX = 'center';
                if (rotateAround.indexOf('left') != -1)
                    adjustX = 'left';
                else if (rotateAround.indexOf('right') != -1)
                    adjustX = 'right';

                if (adjustX == 'center') {
                    x -= w2 / 2;
                    y -= h2 / 2;
                }
                else if (adjustX == 'right') {
                    x -= w2;
                    y -= h2;
                }

                if (adjustY == 'top')
                    x -= th * sn;
                else if (adjustY == 'middle')
                    x -= th * sn / 2;

                x = $.jqx._rup(x);
                y = $.jqx._rup(y);

                ctx.translate(x, y);
                ctx.rotate(rads);
                ctx.fillText(params.text, 0, 0);

                ctx.restore();
            }

        },

        refresh: function () {
            this.ctx.clearRect(0, 0, this.canvas[0].width, this.canvas[0].height);
            for (var element in this._elements) {
                var params = this._elements[element];

                this._renderers.setFillStyle(this.ctx, params);
                this._renderers.setStroke(this.ctx, params);

                this._renderers[this._elements[element].type](this.ctx, params);
            }
        }
    } // End of jQWidgets HTML5 renderer


})(jQuery);

(function ($) {

    /*
    *   RadialGauge's functionality
    */
    var radialGauge = {

        defineInstance: function () {
            this.width = 350;
            this.height = 350;
            this.radius = '50%';
            this.endAngle = 270;
            this.startAngle = 30;
            this.value = 0;
            this.min = 0;
            this.max = 220;
            this.disabled = false;
            this.ticksDistance = '20%';
            this.colorScheme = 'scheme01';
            this.animationDuration = 400;
            this.showRanges = true;
            this.easing = 'easeOutCubic';
            this.labels = null;
            this.pointer = null;
            this.cap = null;
            this.caption = null;
            this.border = null;
            this.ticksMinor = null;
            this.ticksMajor = null;
            this.style = null;
            this.ranges = [];

            //Equal to the radius without any reductions
            this._radius;
            this._border = null;
            this._radiusDifference = 2;
            this._pointer = null;
            this._labels = [];
            this._cap = null;
            this._ticks = [];
            this._ranges = [];
            this._gauge = null;
            this._caption = null;
            this._animationTimeout = 10;
            this._r = null;
            this._animations = [];
            this.aria =
            {
                "aria-valuenow": { name: "value", type: "number" },
                "aria-valuemin": { name: "min", type: "number" },
                "aria-valuemax": { name: "max", type: "number" },
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
        },

        createInstance: function (args) {
            $.jqx.aria(this);
            this._radius = this.radius;
            this.value = new Number(this.value);
            this.endAngle = this.endAngle * Math.PI / 180 + Math.PI / 2;
            this.startAngle = this.startAngle * Math.PI / 180 + Math.PI / 2;
            this._refresh();
            this.setValue(this.value, 0);
            this._r.getContainer().css('overflow', 'hidden');
            if (!this.host.jqxChart) {
                throw new Error("jqxGauge: Missing reference to jqxchart.js.");
            }
            var that = this;
            $.jqx.utilities.resize(this.host, function () {
                that._refresh();
            });

            this.host.addClass(this.toThemeProperty('jqx-widget'));
        },

        _validateEasing: function () {
            return !!$.easing[this.easing];
        },

        _validateProperties: function () {
            if (this.startAngle === this.endAngle) {
                throw new Error('The end angle can not be equal to the start angle!');
            }
            if (!this._validateEasing()) {
                this.easing = 'linear';
            }
            this.ticksDistance = this._validatePercentage(this.ticksDistance, '20%');
            this.border = this._borderConstructor(this.border, this);
            this.style = this.style || { fill: '#ffffff', stroke: '#E0E0E0' };
            this.ticksMinor = new this._tickConstructor(this.ticksMinor, this);
            this.ticksMajor = new this._tickConstructor(this.ticksMajor, this);
            this.cap = new this._capConstructor(this.cap, this);
            this.pointer = new this._pointerConstructor(this.pointer, this);
            this.labels = new this._labelsConstructor(this.labels, this);
            this.caption = new this._captionConstructor(this.caption, this);
            for (var i = 0; i < this.ranges.length; i += 1) {
                this.ranges[i] = new this._rangeConstructor(this.ranges[i], this);
            }
        },

        _hostInit: function () {
            var width = this._getScale(this.width, 'width', this.host.parent()),
                height = this._getScale(this.height, 'height', this.host.parent()),
                border = this._outerBorderOffset(),
                host = this.host,
                childSize;
            host.width(width);
            host.height(height);
            this.radius = childSize = (this._getScale(this._radius, 'width', this.host) || width / 2) - border;
            this._originalRadius = parseInt(this.radius, 10) - this._radiusDifference;
            this._innerRadius = this._originalRadius;
            if (this.border) {
                this._innerRadius -= this._getSize(this.border.size);
            }
            host[0].innerHTML = '<div />';
            this._gaugeParent = host.children();
            this._gaugeParent.width(width);
            this._gaugeParent.height(height);
            this._r.init(this._gaugeParent);
        },

        _refresh: function () {
            var renderer = null;
            this._isVML = false;

            if (document.createElementNS && (this.renderEngine == 'SVG' || this.renderEngine == undefined)) {
                renderer = new $.jqx.svgRenderer();
                if (!renderer.init(this.host)) {
                    if (this.renderEngine == 'SVG')
                        throw 'Your browser does not support SVG';

                    return;
                }
            }

            if (renderer == null && this.renderEngine != 'HTML5') {
                renderer = new $.jqx.vmlRenderer();
                if (!renderer.init(this.host)) {
                    if (this.renderEngine == 'VML')
                        throw 'Your browser does not support VML';

                    return;
                }
                this._isVML = true;
            }

            if (renderer == null && (this.renderEngine == 'HTML5' || this.renderEngine == undefined)) {
                renderer = new $.jqx.HTML5Renderer();
                if (!renderer.init(this.host)) {
                    throw 'Your browser does not support HTML5 Canvas';
                }
            }

            this._r = renderer;
            this._validateProperties();
            this._hostInit();
            //this._performLayout();
            this._removeElements();
            //this._hostInit();
            this._render();
            this.setValue(this.value, 0);
        },

        val: function (value) {
            if (arguments.length == 0 || typeof (value) == "object") {
                return this.value;
            }
            this.setValue(value, 0);
        },

        refresh: function () {
            this._refresh.apply(this, Array.prototype.slice(arguments));
        },

        _outerBorderOffset: function () {
            var borderStroke = parseInt(this.border.style['stroke-width'], 10) || 1;
            return borderStroke / 2;
            //console.log(this._r.getContainer().css('padding', 2));
            //this.
            //this.host.children('.chartContainer').css('padding', borderStroke);
        },

        _removeCollection: function (collection) {
            for (var i = 0; i < collection.length; i += 1) {
                $(collection[i]).remove();
            }
            collection = [];
        },

        _render: function () {
            this._addBorder();
            this._addGauge();
            this._addRanges();
            this._addTicks();
            this._addLabels();
            this._addCaption();
            this._addPointer();
            this._addCap();
        },

        _addBorder: function () {
            if (!this.border.visible) {
                return;
            }
            var color = this.border.style.fill,
                borderSize = this._outerBorderOffset();
            if (!color) {
                color = '#BABABA';
            }
            if (this.border.showGradient) {
                if (color.indexOf('url') < 0 && color.indexOf('#grd') < 0) {
                    this._originalColor = color;
                } else {
                    color = this._originalColor;
                }
                color = this._r._toLinearGradient(color, true, [[0, 1], [25, 1.1], [50, 1.5], [100, 1]]);
            }
            this._border = this._r.circle(this._originalRadius + borderSize, this._originalRadius + borderSize, this._originalRadius);
            this.border.style.fill = color;
            this._r.attr(this._border, this.border.style);
        },

        _addGauge: function () {
            var r = this._originalRadius,
                url = this._r._toLinearGradient('#ffffff', [[3, 2], [100, 1]]),
                borderSize = this._outerBorderOffset();
            this._gauge = this._r.circle(r + borderSize, r + borderSize, this._innerRadius);
            this._r.attr(this._gauge, this.style);
        },

        _addCap: function () {
            var visibility = 'visible',
                borderSize = this._outerBorderOffset();
            if (!this.cap.visible) {
                visibility = 'hidden';
            }
            var r = this._originalRadius,
                size = this._getSize(this.cap.size),
                circle;
            circle = this._r.circle(r + borderSize, r + borderSize, size);
            this._capCenter = [r, r];
            this._r.attr(circle, this.cap.style);
            $(circle).css('visibility', visibility);
            this._cap = circle;
        },

        _addTicks: function () {
            var ticksMinor = this.ticksMinor,
                ticksMajor = this.ticksMajor,
                minorStep = ticksMinor.interval,
                majorStep = ticksMajor.interval,
                oldVals = {};
            for (var i = this.min, j = this.min; i <= this.max || j <= this.max; i += minorStep, j += majorStep) {
                if (j <= this.max && ticksMajor.visible) {                   
                    this._drawTick({
                        angle: this._getAngleByValue(j),
                        distance: this._getDistance(this.ticksDistance),
                        style: ticksMajor.style,
                        size: this._getSize(ticksMajor.size),
                        type: 'major'
                    });
                    oldVals[j.toFixed(5)] = true;
                }
                if (!oldVals[i.toFixed(5)] && ticksMinor.visible) {
                    if (i <= this.max) {
                        this._drawTick({
                            angle: this._getAngleByValue(i),
                            distance: this._getDistance(this.ticksDistance),
                            style: ticksMinor.style,
                            size: this._getSize(ticksMinor.size),
                            type: 'minor'
                        });
                    }
                }
            }
            this._handleTicksVisibility();
        },

        _handleTicksVisibility: function () {
            if (!this.ticksMinor.visible) {
                this.host.children('.jqx-gauge-tick-minor').css('visibility', 'hidden');
            } else {
                this.host.children('.jqx-gauge-tick-minor').css('visibility', 'visible');
            }
            if (!this.ticksMajor.visible) {
                this.host.children('.jqx-gauge-tick-major').css('visibility', 'hidden');
            } else {
                this.host.children('.jqx-gauge-tick-major').css('visibility', 'visible');
            }
        },

        /*
        *   Calculates the size relatively to the inner gauge.
        *   _innerRadius is equal to the inner part of the gauge (without border).
        *   _originalRadius is the gauge + it's border.
        */
        _getSize: function (size) {
            if (size.toString().indexOf('%') >= 0) {
                size = (parseInt(size, 10) / 100) * this._innerRadius;
            }
            size = parseInt(size, 10);
            return size;
        },

        _getDistance: function (size) {
            return this._getSize(size) + (this._originalRadius - this._innerRadius);
        },

        _drawTick: function (options) {
            var angle = options.angle,
                distance = options.distance,
                size = options.size,
                borderSize = this._outerBorderOffset(),
                r = this._originalRadius,
                width = r - distance,
                innerWidth = width - size,
                x1 = r + borderSize + width * Math.sin(angle),
                y1 = r + borderSize + width * Math.cos(angle),
                x2 = r + borderSize + innerWidth * Math.sin(angle),
                y2 = r + borderSize + innerWidth * Math.cos(angle),
                line;
            options.style['class'] = this.toThemeProperty('jqx-gauge-tick-' + options.type);
            if (this._isVML) {
                x1 = Math.round(x1);
                x2 = Math.round(x2);
                y1 = Math.round(y1);
                y2 = Math.round(y2);
            }
            line = this._r.line(x1, y1, x2, y2, options.style);
            this._ticks.push(line);
        },

        _addRanges: function () {
            var visibility = 'visible';
            if (!this.showRanges) {
                visibility = 'hidden';
            } else {
                var ranges = this.ranges;
                for (var i = 0; i < ranges.length; i += 1) {
                    this._addRange(ranges[i], visibility);
                }
            }
        },

        _getMaxRangeSize: function () {
            var range, size = -1, start, end;
            for (var i = 0; i < this.ranges.length; i += 1) {
                start = this.ranges[i].startWidth;
                end = this.ranges[i].endWidth;
                if (start > size) {
                    size = start;
                }
                if (end > size) {
                    size = end;
                }
            }
            return size;
        },

        _getRangeDistance: function (distance, width) {
            var labelsPosition = this._getLabelsDistance(),
                rangeDistance = this._getDistance(distance),
                maxRangeSize = this._getMaxRangeSize();
            if (this.labels.position === 'outside') {
                if (labelsPosition < rangeDistance + this._getMaxTickSize()) {
                    return this._getDistance(this.ticksDistance) + maxRangeSize / 2 + this._getSize(this.ticksMajor.size);
                }
            } else if (this.labels.position === 'inside') {
                if (labelsPosition + this._getMaxTickSize() < rangeDistance) {
                    return this._getSize(this.border.size) + this._originalRadius / 20;
                }
            }
            return rangeDistance;
        },

        _addRange: function (range, visibility) {
            if (range.startValue < this.min || range.endValue > this.max) {
                return;
            }
            var startAngle = this._getAngleByValue(range.startValue),
                endAngle = this._getAngleByValue(range.endValue),
                radius = this._originalRadius,
                startDistance = radius - this._getRangeDistance(range.startDistance, range.startWidth),
                endDistance = radius - this._getRangeDistance(range.endDistance, range.endWidth),
                startWidth = range.startWidth,
                endWidth = range.endWidth,
                borderSize = this._outerBorderOffset(),
                startPoint = {
                    x: radius + borderSize + startDistance * Math.sin(startAngle),
                    y: radius + borderSize + startDistance * Math.cos(startAngle)
                },
                endPoint = {
                    x: radius + borderSize + endDistance * Math.sin(endAngle),
                    y: radius + borderSize + endDistance * Math.cos(endAngle)
                },
                startProjectionPoint = this._getProjectionPoint(startAngle, radius + borderSize, startDistance, startWidth),
                endProjectionPoint = this._getProjectionPoint(endAngle, radius + borderSize, endDistance, endWidth),
                orientation = 'default',
                path, range;
            if (Math.abs(endAngle - startAngle) > Math.PI) {
                orientation = 'opposite';
            }
            if (this._isVML) {
                path = this._rangeVMLRender(startPoint, endPoint, radius, startProjectionPoint, endProjectionPoint, endWidth, startWidth, startDistance, endDistance, orientation);
            } else {
                path = this._rangeSVGRender(startPoint, endPoint, radius, startProjectionPoint, endProjectionPoint, endWidth, startWidth, startDistance, endDistance, orientation);
            }
            range.style.visibility = visibility;
            range.style['class'] = this.toThemeProperty('jqx-gauge-range');
            range = this._r.path(path, range.style);
            this._ranges.push(range);
        },

        _rangeSVGRender: function (startPoint, endPoint, radius, startProjectionPoint, endProjectionPoint, endWidth, startWidth, startDistance, endDistance, orientation) {
            var path = '',
                startDistance = radius - startDistance,
                endDistance = radius - endDistance,
                circle = ['0,1', '0,0'];
            if (orientation === 'opposite') {
                circle = ['1,1', '1,0'];
            }
            path = 'M' + startPoint.x + ',' + startPoint.y + ' ';
            path += 'A' + (radius - startDistance) + ',' + (radius - startDistance) + ' 100 ' + circle[0] + ' ' + endPoint.x + ',' + endPoint.y + ' ';
            path += 'L ' + (endProjectionPoint.x) + ',' + (endProjectionPoint.y) + ' ';
            path += 'A' + (radius - endWidth - startDistance) + ',' + (radius - endWidth - startDistance) + ' 100 ' + circle[1] + ' ' + (startProjectionPoint.x) + ',' + (startProjectionPoint.y) + ' ';
            path += 'L ' + (startPoint.x) + ',' + (startPoint.y) + ' ';
            path += 'z';
            return path;
        },

        _rangeVMLRender: function (startPoint, endPoint, radius, startProjectionPoint, endProjectionPoint, endWidth, startWidth, startDistance, endDistance, orientation) {
            radius -= radius - startDistance + 10;
            var path = '',
                outerRadius = Math.floor(radius + (startWidth + endWidth) / 2),
                startDistance = Math.floor(radius - startDistance),
                endDistance = Math.floor(endDistance),
                middleProjection = {
                    x: (startProjectionPoint.x + endProjectionPoint.x) / 2,
                    y: (startProjectionPoint.y + endProjectionPoint.y) / 2
                },
                projDistance = Math.sqrt((endProjectionPoint.x - startProjectionPoint.x) * (endProjectionPoint.x - startProjectionPoint.x) + (endProjectionPoint.y - startProjectionPoint.y) * (endProjectionPoint.y - startProjectionPoint.y)),
                projCenterX = Math.floor(middleProjection.x + Math.sqrt(radius * radius - (projDistance / 2) * (projDistance / 2)) * (startProjectionPoint.y - endProjectionPoint.y) / projDistance),
                projCenterY = Math.floor(middleProjection.y + Math.sqrt(radius * radius - (projDistance / 2) * (projDistance / 2)) * (endProjectionPoint.x - startProjectionPoint.x) / projDistance),
                middle = {
                    x: (startPoint.x + endPoint.x) / 2,
                    y: (startPoint.y + endPoint.y) / 2
                },
                distance = Math.sqrt((endPoint.x - startPoint.x) * (endPoint.x - startPoint.x) + (endPoint.y - startPoint.y) * (endPoint.y - startPoint.y)),
                centerX = Math.floor(middle.x + Math.sqrt(Math.abs(outerRadius * outerRadius - (distance / 2) * (distance / 2))) * (startPoint.y - endPoint.y) / distance),
                centerY = Math.floor(middle.y + Math.sqrt(Math.abs(outerRadius * outerRadius - (distance / 2) * (distance / 2))) * (endPoint.x - startPoint.x) / distance);

            if (orientation === 'opposite') {
                projCenterX = Math.floor(middleProjection.x - Math.sqrt(radius * radius - (projDistance / 2) * (projDistance / 2)) * (startProjectionPoint.y - endProjectionPoint.y) / projDistance);
                projCenterY = Math.floor(middleProjection.y - Math.sqrt(radius * radius - (projDistance / 2) * (projDistance / 2)) * (endProjectionPoint.x - startProjectionPoint.x) / projDistance);

                centerX = Math.floor(middle.x - Math.sqrt(Math.abs(outerRadius * outerRadius - (distance / 2) * (distance / 2))) * (startPoint.y - endPoint.y) / distance);
                centerY = Math.floor(middle.y - Math.sqrt(Math.abs(outerRadius * outerRadius - (distance / 2) * (distance / 2))) * (endPoint.x - startPoint.x) / distance);
            }
            radius = Math.floor(radius);
            endPoint = { x: Math.floor(endPoint.x), y: Math.floor(endPoint.y) };
            startPoint = { x: Math.floor(startPoint.x), y: Math.floor(startPoint.y) };
            startProjectionPoint = { x: Math.floor(startProjectionPoint.x), y: Math.floor(startProjectionPoint.y) };
            endProjectionPoint = { x: Math.floor(endProjectionPoint.x), y: Math.floor(endProjectionPoint.y) };

            path = 'm ' + endPoint.x + ',' + endPoint.y;
            path += 'at ' + (centerX - outerRadius) + ' ' + (centerY - outerRadius) + ' ' + (outerRadius + centerX) + ' ' + (outerRadius + centerY) + ' ' + endPoint.x + ',' + endPoint.y + ' ' + startPoint.x + ',' + startPoint.y;
            path += 'l ' + startProjectionPoint.x + ',' + startProjectionPoint.y;
            path += 'm ' + endPoint.x + ',' + endPoint.y;
            path += 'l ' + endProjectionPoint.x + ',' + endProjectionPoint.y;
            path += 'at ' + (projCenterX - radius) + ' ' + (projCenterY - radius) + ' ' + (radius + projCenterX) + ' ' + (radius + projCenterY) + ' ' + endProjectionPoint.x + ',' + endProjectionPoint.y + ' ' + startProjectionPoint.x + ',' + startProjectionPoint.y;
            path += 'qx ' + startProjectionPoint.x + ' ' + startProjectionPoint.y;
            return path;
        },

        _getProjectionPoint: function (angle, radius, ratio, displacement) {
            var point = { x: radius + (ratio - displacement) * Math.sin(angle), y: radius + (ratio - displacement) * Math.cos(angle) };
            return point;
        },

        _addLabels: function (options) {
            var distance = this._getDistance(this._getLabelsDistance());
            for (var currentLabel = this.min; currentLabel <= this.max; currentLabel += this.labels.interval) {
                if (this.labels.visible) {
                    this._addLabel({
                        angle: this._getAngleByValue(currentLabel),
                        value: this.labels.interval >= 1 ? currentLabel : new Number(currentLabel).toFixed(2),
                        distance: distance,
                        style: this.labels.className
                    });
                }
            }
        },

        _getLabelsDistance: function () {
            var maxSize = this._getMaxLabelSize(),
                labelsDistance = this._getDistance(this.labels.distance),
                ticksDistance = this._getDistance(this.ticksDistance);
            maxSize = maxSize.width;
            if (this.labels.position === 'inside') {
                return ticksDistance + maxSize - 5;
            } else if (this.labels.position === 'outside') {
                if (labelsDistance < (ticksDistance - maxSize * 1.5)) {
                    return labelsDistance;
                }
                return Math.max(ticksDistance - maxSize * 1.5, 0.6 * maxSize);
            }
            return this.labels.distance;
        },

        _addLabel: function (options) {
            var angle = options.angle,
                r = this._originalRadius,
                w = r - options.distance,
                offset = this.labels.offset,
                callback = this.labels.formatValue,
                borderSize = this._outerBorderOffset(),
                x = r + borderSize + w * Math.sin(angle) + offset[0],
                y = r + borderSize + w * Math.cos(angle) + offset[1],
                value = options.value,
                className = options.style || '',
                textSize,
                label;
            if (typeof callback === 'function') {
                value = callback(value);
            }
            textSize = this._r.measureText(value, 0, { 'class': className });
            label = this._r.text(value, Math.round(x) - textSize.width / 2, Math.round(y), textSize.width, textSize.height, 0, { 'class': this.toThemeProperty('jqx-gauge-label') });
            this._labels.push(label);
        },

        _addCaption: function () {
            var text = this.caption.value,
                className = this.toThemeProperty('jqx-gauge-caption'),
                offset = this.caption.offset,
                size = this._r.measureText(text, 0, { 'class': className }),
                position = this._getPosition(this.caption.position, size, offset),
                style = this.caption.style,
                border = this._outerBorderOffset(),
                t = this._r.text(text, position.left + border, position.top + border, size.width, size.height, 0, { 'class': className });
            this._caption = t;
        },

        _getPosition: function (position, size, offset) {
            var left = 0,
                top = 0,
                r = this._originalRadius;
            switch (position) {
                case 'left':
                    left = (r - size.width) / 2;
                    top = r - size.height / 2;
                    break;
                case 'right':
                    left = r + (r - size.width) / 2;
                    top = r - size.height / 2;
                    break;
                case 'bottom':
                    left = (2 * r - size.width) / 2;
                    top = (r + 2 * r - size.height) / 2;
                    break;
                default:
                    left = (2 * r - size.width) / 2;
                    top = (r + size.height) / 2;
                    break;
            }
            return { left: left + offset[0], top: top + offset[1] };
        },

        _addPointer: function () {
            var visibility = 'visible';
            if (!this.pointer.visible) {
                visibility = 'hidden';
            }
            var radius = this._originalRadius,
                length = this._getSize(this.pointer.length),
                innerW = length * 0.9,
                angle = this._getAngleByValue(this.value),
                pointerType = this.pointer.pointerType,
                points;
            points = this._computePointerPoints(this._getSize(this.pointer.width), angle, length, pointerType !== 'default');
            this._pointer = this._r.path(points, this.pointer.style);
            $(this._pointer).css('visibility', visibility);
        },

        _computePointerPoints: function (pointerWidth, angle, pointerLength, rect) {
            if (!rect) {
                return this._computeArrowPoints(pointerWidth, angle, pointerLength);
            } else {
                return this._computeRectPoints(pointerWidth, angle, pointerLength);
            }
        },

        _computeArrowPoints: function (pointerWidth, angle, pointerLength) {
            var r = this._originalRadius - 0.5,
                sin = Math.sin(angle),
                cos = Math.cos(angle),
                borderSize = this._outerBorderOffset(),
                x = r + borderSize + pointerLength * sin,
                y = r + borderSize + pointerLength * cos,
                startX1 = r + borderSize + pointerWidth * cos,
                startY1 = r + borderSize - pointerWidth * sin,
                startX2 = r + borderSize - pointerWidth * cos,
                startY2 = r + borderSize + pointerWidth * sin,
                points;
            if (this._isVML) {
                startX1 = Math.round(startX1);
                startX2 = Math.round(startX2);
                startY1 = Math.round(startY1);
                startY2 = Math.round(startY2);
                x = Math.round(x);
                y = Math.round(y);
            }
            points = 'M ' + startX1 + ',' + startY1 + ' L ' + startX2 + ',' + startY2 + ' L ' + x + ',' + y + '';
            return points;
        },

        _computeRectPoints: function (pointerWidth, angle, pointerLength) {
            var r = this._originalRadius,
                sin = Math.sin(angle),
                cos = Math.cos(angle),
                arrowDistance = pointerLength,
                borderSize = this._outerBorderOffset(),
                endX1 = r + borderSize - pointerWidth * cos + pointerLength * sin,
                endY1 = r + borderSize + pointerWidth * sin + pointerLength * cos,
                endX2 = r + borderSize + pointerWidth * cos + pointerLength * sin,
                endY2 = r + borderSize - pointerWidth * sin + pointerLength * cos,
                startX1 = r + borderSize + pointerWidth * cos,
                startY1 = r + borderSize - pointerWidth * sin,
                startX2 = r + borderSize - pointerWidth * cos,
                startY2 = r + borderSize + pointerWidth * sin,
                points;
            if (this._isVML) {
                startX1 = Math.round(startX1);
                startX2 = Math.round(startX2);
                startY1 = Math.round(startY1);
                startY2 = Math.round(startY2);
                endX1 = Math.round(endX1);
                endY1 = Math.round(endY1);
                endX2 = Math.round(endX2);
                endY2 = Math.round(endY2);
            }
            points = 'M ' + startX1 + ',' + startY1 + ' L ' + startX2 + ',' + startY2 + ' L ' + endX1 + ',' + endY1 + ' ' + endX2 + ',' + endY2;
            return points;
        },

        _getAngleByValue: function (value) {
            var startAngle = this.startAngle,
                endAngle = this.endAngle,
                start = this.min,
                end = this.max,
                singleValue = (startAngle - endAngle) / (end - start);
            var angle = singleValue * (value - this.min) + startAngle + Math.PI;
      //      var degrees = angle * (180 / Math.PI);
            return angle;
        },

        _setValue: function (value) {
            if (value <= this.max && value >= this.min) {
                var angle = this._getAngleByValue(value),
                    pointerType = this.pointer.pointerType,
                    points = this._computePointerPoints(this._getSize(this.pointer.width), angle, this._getSize(this.pointer.length), pointerType !== 'default');
                if (this._isVML) {
                    this._r.attr(this._pointer.childNodes[0], { v: points });
                } else {
                    this._r.attr(this._pointer, { d: points });
                }
                this.value = value;
                $.jqx.aria(this, 'aria-valuenow', value);
            }
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (key == 'min') {
                this.min = parseInt(value);
                $.jqx.aria(object, 'aria-valuemin', value);
            }
            if (key == 'max') {
                this.max = parseInt(value);
                $.jqx.aria(object, 'aria-valuemax', value);
            }
            if (key == 'value') {
                this.value = parseInt(value);
            }

            if (key === 'disabled') {
                if (value) {
                    this.disable();
                } else {
                    this.enable();
                }
                $.jqx.aria(this, 'aria-disabled', value);
            } else if (key === 'value') {
                this.value = oldvalue;
                this.setValue(value);
            } else {
                if (key === 'startAngle') {
                    this.startAngle = this.startAngle * Math.PI / 180 + Math.PI / 2;
                } else if (key === 'endAngle') {
                    this.endAngle = this.endAngle * Math.PI / 180 + Math.PI / 2;
                } else if (key === 'colorScheme') {
                    this.pointer.style = null;
                    this.cap.style = null;
                } else if (key === 'radius') {
                    this._radius = value;
                }
                if (key !== 'animationDuration' && key !== 'easing') {
                    this._refresh();
                }
            }
            if (this._r instanceof $.jqx.HTML5Renderer)
                this._r.refresh();
        },

        _tickConstructor: function (data, jqx) {
            if (this.host) {
                return new this._tickConstructor(data, jqx);
            }
            data = data || {};
            this.size = jqx._validatePercentage(data.size, '10%');
            this.interval = parseFloat(data.interval);
            if (!this.interval) {
                this.interval = 5;
            }
            this.style = data.style || { stroke: '#898989', 'stroke-width': 1 };
            if (typeof data.visible === 'undefined') {
                this.visible = true;
            } else {
                this.visible = data.visible;
            }
        },

        _capConstructor: function (data, jqx) {
            var color = jqx._getColorScheme(jqx.colorScheme)[0];
            if (this.host) {
                return new this._capConstructor(data, jqx);
            }
            data = data || {};
            if (typeof data.visible === 'undefined') {
                this.visible = true;
            } else {
                this.visible = data.visible;
            }
            this.size = jqx._validatePercentage(data.size, '4%');
            this.style = data.style || { fill: color, 'stroke-width': '1px', stroke: color, 'z-index': 30 };
        },

        _pointerConstructor: function (data, jqx) {
            var color = jqx._getColorScheme(jqx.colorScheme)[0];
            if (this.host) {
                return new this._pointerConstructor(data, jqx);
            }
            data = data || {};
            if (typeof data.visible === 'undefined') {
                this.visible = true;
            } else {
                this.visible = data.visible;
            }
            this.pointerType = data.pointerType;
            if (this.pointerType !== 'default' && this.pointerType !== 'rectangle') {
                this.pointerType = 'default';
            }
            this.style = data.style || { 'z-index': 0, stroke: color, fill: color, 'stroke-width': 1 };
            this.length = jqx._validatePercentage(data.length, '70%');
            this.width = jqx._validatePercentage(data.width, '2%');
        },

        _labelsConstructor: function (data, jqx) {
            if (this.host) {
                return new this._labelsConstructor(data, jqx);
            }
            data = data || {};
            if (typeof data.visible === 'undefined') {
                this.visible = true;
            } else {
                this.visible = data.visible;
            }
            this.offset = data.offset;
            if (!(this.offset instanceof Array)) {
                this.offset = [0, -10];
            }
            this.interval = parseFloat(data.interval);
            if (!this.interval) {
                this.interval = 20;
            }
            this.distance = jqx._validatePercentage(data.distance, '38%');
            this.position = data.position;
            if (this.position !== 'inside' && this.position !== 'outside') {
                this.position = 'none';
            }
            this.formatValue = data.formatValue;
            if (typeof this.formatValue !== 'function') {
                this.formatValue = function (value) {
                    return value;
                }
            }
        },

        _captionConstructor: function (data, jqx) {
            if (this.host) {
                return new this._captionConstructor(data, jqx);
            }
            data = data || {};
            if (typeof data.visible === 'undefined') {
                this.visible = true;
            } else {
                this.visible = data.visible;
            }
            this.value = data.value || '';
            this.position = data.position;
            if (this.position !== 'bottom' && this.position !== 'top' &&
                this.position !== 'left' && this.position !== 'right') {
                this.position = 'bottom';
            }
            this.offset = data.offset;
            if (!(this.offset instanceof Array)) {
                this.offset = [0, 0];
            }
        },

        _rangeConstructor: function (data, jqx) {
            if (this.host) {
                return new this._rangeConstructor(data, jqx);
            }
            data = data || {};
            this.startDistance = jqx._validatePercentage(data.startDistance, '5%');
            this.endDistance = jqx._validatePercentage(data.endDistance, '5%');
            this.style = data.style || { fill: '#000000', stroke: '#111111' };
            this.startWidth = parseInt(data.startWidth, 10);
            if (!this.startWidth) {
                this.startWidth = 10;
            }
            this.startWidth = Math.max(this.startWidth, 2);
            this.endWidth = parseInt(data.endWidth, 10);
            if (!this.endWidth) {
                this.endWidth = 10;
            }
            this.endWidth = Math.max(this.endWidth, 2);
            this.startValue = parseInt(data.startValue, 10);
            if (!this.startValue) {
                this.startValue = 0;
            }
            this.endValue = parseInt(data.endValue, 10);
            if (undefined == this.endValue) {
                this.endValue = 100;
            }
        },

        _borderConstructor: function (data, jqx) {
            if (this.host) {
                return new this._borderConstructor(data, jqx);
            }
            data = data || {};
            this.size = jqx._validatePercentage(data.size, '10%');
            this.style = data.style || { stroke: '#cccccc' };
            if (typeof data.showGradient === 'undefined') {
                this.showGradient = true;
            } else {
                this.showGradient = data.showGradient;
            }
            if (typeof data.visible === 'undefined') {
                this.visible = true;
            } else {
                this.visible = data.visible;
            }
        }
    };



    /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
    *
    *
    *                                       Reusable methods
    *
    *
    * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */
    var common = {

        _events: ['valueChanging', 'valueChanged'],
        _animationTimeout: 10,
        _schemes: $.jqx._jqxChart.prototype.colorSchemes,

        _getScale: function (size, dim, parent) {
            if (size && size.toString().indexOf('%') >= 0) {
                size = parseInt(size, 10) / 100;
                return parent[dim]() * size;
            }
            return parseInt(size, 10);
        },

        _removeElements: function () {
            this.host.children('.chartContainer').remove();
            this.host.children('#tblChart').remove();
        },

        _getMaxLabelSize: function () {
            var maxVal = this.max,
                minVal = this.min;
            if (this.labels.interval < 1)
            {
                minVal = new Number(minVal).toFixed(2); 
                maxVal = new Number(maxVal).toFixed(2); 
            }
            var maxSize = this._r.measureText(maxVal, 0, { 'class': this.toThemeProperty('jqx-gauge-label') }),
                minSize = this._r.measureText(minVal, 0, { 'class': this.toThemeProperty('jqx-gauge-label') });
            if (minSize.width > maxSize.width) {
                return minSize;
            }
            return maxSize;
        },

        disable: function () {
            this.disabled = true;
            this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
        },

        enable: function () {
            this.disabled = false;
            this.host.removeClass(this.toThemeProperty('jqx-fill-state-disabled'));
        },

        destroy: function () {
            this._removeElements();
        },

        _validatePercentage: function (data, def) {
            if (parseFloat(data) !== 0 && (!data || !parseInt(data, 10))) {
                data = def;
            }
            return data;
        },

        _getColorScheme: function (name) {
            var scheme;
            for (var i = 0; i < this._schemes.length; i += 1) {
                scheme = this._schemes[i];
                if (scheme.name === name) {
                    return scheme.colors;
                }
            }
            return null;
        },

        setValue: function (value, duration) {
            if (!this.disabled) {
                if (value > this.max) {
                    value = this.max;
                }
                if (value < this.min) {
                    value = this.min;
                }
                duration = duration || this.animationDuration || 0;
                var distance = duration / this._animationTimeout;
                this._animate((value - this.value) / distance, this.value, value, duration);
                $.jqx.aria(this, 'aria-valuenow', value);
            }
        },

        _animate: function (step, start, end, duration) {
            if (this._timeout) {
                this._endAnimation(this.value, false);
            }
            if (!duration) {
                this._endAnimation(end, true);
                return;
            }
            this._animateHandler(step, start, end, 0, duration);
        },

        _animateHandler: function (step, start, end, current, duration) {
            var self = this;
            if (current <= duration) {
                this._timeout = setTimeout(function () {
                    self.value = start + (end - start) * $.easing[self.easing](current / duration, current, 0, 1, duration);
                    self._setValue(self.value);
                    self._raiseEvent(0, {
                        value: self.value
                    });
                    self._animateHandler(step, start, end, current + self._animationTimeout, duration);
                }, this._animationTimeout);
            } else {
                this._endAnimation(end, true);
            }
        },

        _endAnimation: function (end, toRaiseEvent) {
            clearTimeout(this._timeout);
            this._timeout = null;
            this._setValue(end);
            if (toRaiseEvent) {
                this._raiseEvent(1, {
                    value: end
                });
            }
        },

        _getMaxTickSize: function () {
            return Math.max(this._getSize(this.ticksMajor.size), this._getSize(this.ticksMinor.size));
        },

        _raiseEvent: function (eventId, args) {
            var event = $.Event(this._events[eventId]),
                result;
            event.args = args || {};
            result = this.host.trigger(event);
            return result;
        }
    },



    /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 
    *
    *
    *                               LinearGauge's functionality
    *
    *
    * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */
    linearGauge = {

        defineInstance: function () {
            this.value = -50;
            this.max = 40;
            this.min = -60;
            this.width = 100;
            this.height = 300;
            this.pointer = {};
            this.labels = {};
            this.animationDuration = 1000;
            this.showRanges = {};
            this.ticksMajor = { size: '15%', interval: 5 };
            this.ticksMinor = { size: '10%', interval: 2.5 };
            this.ranges = [];
            this.easing = 'easeOutCubic';
            this.colorScheme = 'scheme01';
            this.disabled = false;

            this.rangesOffset = 0;
            this.background = {};
            this.ticksPosition = 'both';
            this.rangeSize = '5%';
            this.scaleStyle = null;
            this.ticksOffset = null;
            this.scaleLength = '90%';
            this.orientation = 'vertical';
            this.aria =
            {
                "aria-valuenow": { name: "value", type: "number" },
                "aria-valuemin": { name: "min", type: "number" },
                "aria-valuemax": { name: "max", type: "number" },
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
            //Used for saving the solid background color when a gradient is used
            this._originalColor;
            this._width;
            this._height;
            this._r;
        },

        createInstance: function () {
            $.jqx.aria(this);
            this.host.css('overflow', 'hidden');
            if (!this.host.jqxChart) {
                throw new Error("jqxGauge: Missing reference to jqxchart.js.");
            }
            this.host.addClass(this.toThemeProperty('jqx-widget'));
            var that = this;
            $.jqx.utilities.resize(this.host, function () {
                that.refresh();
            });
        },

        val: function (value) {
            if (arguments.length == 0 || typeof (value) == "object") {
                return this.value;
            }
            this.setValue(value, 0);
        },

        refresh: function (init) {
            var renderer = null;
            this._isVML = false;

            if (document.createElementNS && (this.renderEngine == 'SVG' || this.renderEngine == undefined)) {
                renderer = new $.jqx.svgRenderer();
                if (!renderer.init(this.host)) {
                    if (this.renderEngine == 'SVG')
                        throw 'Your browser does not support SVG';

                    return;
                }
            }

            if (renderer == null && this.renderEngine != 'HTML5') {
                renderer = new $.jqx.vmlRenderer();
                if (!renderer.init(this.host)) {
                    if (this.renderEngine == 'VML')
                        throw 'Your browser does not support VML';

                    return;
                }
                this._isVML = true;
            }

            if (renderer == null && (this.renderEngine == 'HTML5' || this.renderEngine == undefined)) {
                renderer = new $.jqx.HTML5Renderer();
                if (!renderer.init(this.host)) {
                    throw 'Your browser does not support HTML5 Canvas';
                }
            }

            this._r = renderer;
            this._validateProperties();
            this._reset();
            this._init();
            this._performLayout();
            this._render();
            //this.setValue(this.value, 1);
        },

        _getBorderSize: function () {
            var def = 1,
                size;
            if (this._isVML) {
                def = 0;
            }
            if (this.background) {
                size = (parseInt(this.background.style['stroke-width'], 10) || def) / 2;
                if (this._isVML) {
                    return Math.round(size);
                }
                return size;
            }
            return def;
        },

        _validateProperties: function () {
            this.background = this._backgroundConstructor(this.background, this);
            this.ticksOffset = this.ticksOffset || this._getDefaultTicksOffset();
            this.rangesOffset = this.rangesOffset || 0;
            this.rangeSize = this._validatePercentage(this.rangeSize, 5);
            this.ticksOffset[0] = this._validatePercentage(this.ticksOffset[0], '5%');
            this.ticksOffset[1] = this._validatePercentage(this.ticksOffset[1], '5%');
            this.ticksMinor = this._tickConstructor(this.ticksMinor, this);
            this.ticksMajor = this._tickConstructor(this.ticksMajor, this);
            this.scaleStyle = this.scaleStyle || this.ticksMajor.style;
            this.labels = this._labelsConstructor(this.labels, this);
            this.pointer = this._pointerConstructor(this.pointer, this);
            for (var i = 0; i < this.ranges.length; i += 1) {
                this.ranges[i] = this._rangeConstructor(this.ranges[i], this);
            }
        },

        _getDefaultTicksOffset: function () {
            if (this.orientation === 'horizontal') {
                return ['5%', '36%'];
            }
            return ['36%', '5%'];
        },

        _handleOrientation: function () {
            if (this.orientation === 'vertical') {
                $.extend(this, linearVerticalGauge);
            } else {
                $.extend(this, linearHorizontalGauge);
            }
        },

        _reset: function () {
            this.host.empty();
        },

        _performLayout: function () {
            var borderStroke = parseInt(this.background.style['stroke-width'], 10) || 1;
            this._width -= borderStroke;
            this._height -= borderStroke;
            this.host.css('padding', borderStroke / 2);
        },

        _init: function () {
            var border = this._getBorderSize(),
                chartContainer;
            this._width = this._getScale(this.width, 'width', this.host.parent()) - 3;
            this._height = this._getScale(this.height, 'height', this.host.parent()) - 3;
            this.element.innerHTML = '<div/>';
            this.host.width(this._width);
            this.host.height(this._height);
            this.host.children().width(this._width);
            this.host.children().height(this._height);
            this._r.init(this.host.children());
            chartContainer = this._r.getContainer();
            chartContainer.width(this._width);
            chartContainer.height(this._height);
        },

        _render: function () {
            this._renderBackground();
            this._renderTicks();
            this._renderLabels();
            this._renderRanges();
            this._renderPointer();
        },

        _renderBackground: function () {
            if (!this.background.visible) {
                return;
            }
            var options = this.background.style,
                border = $.jqx._rup(this._getBorderSize()),
                shape = 'rect',
                rect;
            options = this._handleShapeOptions(options);
            if (this.background.backgroundType === 'roundedRectangle' && this._isVML) {
                shape = 'roundrect';
            }
            if (!this._Vml) {
                options.x = border;
                options.y = border;
            }
            rect = this._r.shape(shape, options);
            if (this._isVML) {
                this._fixVmlRoundrect(rect, options);
            }
        },

        _handleShapeOptions: function (options) {
            var color = this.background.style.fill,
                border = this._getBorderSize();
            if (!color) {
                color = '#cccccc';
            }
            if (this.background.showGradient) {
                if (color.indexOf('url') < 0 && color.indexOf('#grd') < 0) {
                    this._originalColor = color;
                } else {
                    color = this._originalColor;
                }
                color = this._r._toLinearGradient(color, this.orientation === 'horizontal', [[1, 1.1], [90, 1.5]]);
            }
            this.background.style.fill = color;
            if (this.background.backgroundType === 'roundedRectangle') {
                if (this._isVML) {
                    options.arcsize = this.background.borderRadius + '%';
                } else {
                    options.rx = this.background.borderRadius;
                    options.ry = this.background.borderRadius;
                }
            }
            options.width = this._width - 1;
            options.height = this._height - 1;
            return options;
        },

        _fixVmlRoundrect: function (rect, options) {
            var border = this._getBorderSize();
            rect.style.position = 'absolute';
            rect.style.left = border;
            rect.style.top = border;
            rect.style.width = this._width - 1;
            rect.style.height = this._height - 1;
            rect.strokeweight = 0;
            delete options.width;
            delete options.height;
            delete options.arcsize;
            this._r.attr(rect, options);
        },

        _renderTicks: function () {
            var distance = Math.abs(this.max - this.min),
                minor = this.ticksMinor,
                major = this.ticksMajor,
                majorCount = distance / major.interval,
                minorCount = distance / minor.interval,
                majorOptions, minorOptions;
            majorOptions = { size: this._getSize(major.size), style: major.style, visible: major.visible, interval: major.interval };
            minorOptions = { size: this._getSize(minor.size), style: minor.style, visible: minor.visible, interval: minor.interval, checkOverlap: true };
            if (this.ticksPosition === 'near' || this.ticksPosition === 'both') {
                this._ticksRenderHandler(majorOptions);
                this._ticksRenderHandler(minorOptions);
            }
            if (this.ticksPosition === 'far' || this.ticksPosition === 'both') {
                majorOptions.isFar = true;
                minorOptions.isFar = true;
                this._ticksRenderHandler(majorOptions);
                this._ticksRenderHandler(minorOptions);
            }
            this._renderConnectionLine();
        },

        _ticksRenderHandler: function (options) {
            if (!options.visible) {
                return;
            }
            var offsetLeft = this._getSize(this.ticksOffset[0], 'width'),
                offsetTop = this._getSize(this.ticksOffset[1], 'height'),
                border = this._getBorderSize(),
                inactiveOffset = this._calculateTickOffset() + this._getMaxTickSize();
            if (options.isFar) {
                inactiveOffset += options.size;
            }
            this._drawTicks(options, border, inactiveOffset + border);
        },

        _drawTicks: function (options, border, inactiveOffset) {
            var position;
            for (var i = this.min; i <= this.max; i += options.interval) {
                position = this._valueToCoordinates(i);
                if (!options.checkOverlap || !this._overlapTick(i)) {
                    this._renderTick(options.size, position, options.style, inactiveOffset);
                }
            }
        },

        _calculateTickOffset: function () {
            var offsetLeft = this._getSize(this.ticksOffset[0], 'width'),
                offsetTop = this._getSize(this.ticksOffset[1], 'height'),
                offset = offsetTop;
            if (this.orientation === 'vertical') {
                offset = offsetLeft;
            }
            return offset;
        },

        _overlapTick: function (value) {
            value += this.min;
            if (value % this.ticksMinor.interval === value % this.ticksMajor.interval) {
                return true;
            }
            return false;
        },

        _renderConnectionLine: function () {
            if (!this.ticksMajor.visible && !this.ticksMinor.visible) {
                return;
            }
            var scaleLength = this._getScaleLength(),
                border = this._getBorderSize(),
                maxPosition = this._valueToCoordinates(this.max),
                minPosition = this._valueToCoordinates(this.min),
                maxSize = this._getMaxTickSize(),
                offset = maxSize + border;
            if (this.orientation === 'vertical') {
                offset += this._getSize(this.ticksOffset[0], 'width');
                this._r.line(offset, maxPosition, offset, minPosition, this.scaleStyle);
            } else {
                offset += this._getSize(this.ticksOffset[1], 'height');
                this._r.line(maxPosition, offset, minPosition, offset, this.scaleStyle);
            }
        },

        _getScaleLength: function () {
            return this._getSize(this.scaleLength, (this.orientation === 'vertical' ? 'height' : 'width'));
        },

        _renderTick: function (size, distance, style, offset) {
            var coordinates = this._handleTickCoordinates(size, distance, offset);
            this._r.line(Math.round(coordinates.x1), Math.round(coordinates.y1), Math.round(coordinates.x2), Math.round(coordinates.y2), style);
        },

        _handleTickCoordinates: function (size, distance, offset) {
            if (this.orientation === 'vertical') {
                return {
                    x1: offset - size,
                    x2: offset,
                    y1: distance,
                    y2: distance
                };
            }
            return {
                x1: distance,
                x2: distance,
                y1: offset - size,
                y2: offset
            };
        },

        _getTickCoordinates: function (tickSize, offset) {
            var ticksCoordinates = this._handleTickCoordinates(tickSize, 0, this._calculateTickOffset());
            if (this.orientation === 'vertical') {
                ticksCoordinates = ticksCoordinates.x1;
            } else {
                ticksCoordinates = ticksCoordinates.y1;
            }
            ticksCoordinates += tickSize;
            return ticksCoordinates;

        },

        _renderLabels: function () {
            if (!this.labels.visible) {
                return;
            }
            var startPosition = this._getSize(this.ticksOffset[0], 'width'),
                tickSize = this._getMaxTickSize(),
                labelsPosition = this.labels.position,
                dimension = 'height',
                border = this._getBorderSize(),
                ticksCoordinates = this._calculateTickOffset() + tickSize,
                maxLabelSize;
            if (this.orientation === 'vertical') {
                startPosition = this._getSize(this.ticksOffset[1], 'height');
                dimension = 'width';
            }
            maxLabelSize = this._getMaxLabelSize()[dimension];
            if (labelsPosition === 'near' || labelsPosition === 'both') {
                this._labelListRender(ticksCoordinates - tickSize - maxLabelSize + border, startPosition + border, maxLabelSize, 'near');
            }
            if (labelsPosition === 'far' || labelsPosition === 'both') {
                this._labelListRender(ticksCoordinates + tickSize + maxLabelSize + border, startPosition + border, maxLabelSize, 'far');
            }
        },

        _labelListRender: function (offset, distance, maxLabelSize, position) {
            var interval = this.labels.interval,
                count = Math.abs(this.max - this.min) / interval,
                length = this._getScaleLength(),
                step = length / count,
                currentValue = (this.orientation === 'vertical') ? this.max : this.min;
            offset += this._getSize(this.labels.offset);
            for (var i = 0; i <= count; i += 1) {
                this._renderLabel(distance, position, offset, maxLabelSize, currentValue);
                currentValue += (this.orientation === 'vertical') ? -interval : interval;
                distance += step;
            }
        },

        _renderLabel: function (distance, position, offset, maxLabelSize, currentValue) {
            var param = { 'class': this.toThemeProperty('jqx-gauge-label') },
                interval = this.labels.interval,
                widthDiff, textSize, formatedValue;
            formatedValue = this.labels.formatValue(currentValue, position);
            textSize = this._r.measureText(formatedValue, 0, param);
            if (this.orientation === 'vertical') {
                widthDiff = (position === 'near') ? maxLabelSize - textSize.width : 0;
                this._r.text(formatedValue, Math.round(offset) + widthDiff - maxLabelSize / 2,
                             Math.round(distance - textSize.height / 2), textSize.width, textSize.height, 0, param);
            } else {
                widthDiff = (position === 'near') ? maxLabelSize - textSize.height : 0;
                this._r.text(formatedValue, Math.round(distance - textSize.width / 2),
                             Math.round(offset) + widthDiff - maxLabelSize / 2, textSize.width, textSize.height, 0, param);
            }
        },

        _renderRanges: function () {
            if (!this.showRanges) {
                return;
            }
            var dim = (this.orientation === 'vertical') ? 'width' : 'height',
                offset = this._getSize(this.rangesOffset, dim),
                size = this._getSize(this.rangeSize, dim),
                options;
            for (var i = 0; i < this.ranges.length; i += 1) {
                options = this.ranges[i];
                options.size = size;
                this._renderRange(options, offset);
            }
        },

        _renderRange: function (options, offset) {
            var scaleLength = this._getScaleLength(),
                border = this._getBorderSize(),
                offsetLeft = this._getSize(this.ticksOffset[0], 'width'),
                offsetTop = this._getSize(this.ticksOffset[1], 'height'),
                maxSize = this._getMaxTickSize(),
                size = this._getSize(options.size),
                top = this._valueToCoordinates(options.endValue);
                var startValue = options.startValue;
                if (startValue < this.min) startValue = this.min;
                var height = Math.abs(this._valueToCoordinates(startValue) - top),
                rect, width;
            if (this.orientation === 'vertical') {
                rect = this._r.rect(offsetLeft + maxSize + offset - size + border, top, options.size, height, options.style);
            } else {
                width = height;
                rect = this._r.rect(this._valueToCoordinates(options.startValue), offsetTop + maxSize + border, width, options.size, options.style);
            }
            this._r.attr(rect, options.style);
        },

        _renderPointer: function () {
            if (!this.pointer.visible) {
                return;
            }
            if (this.pointer.pointerType === 'default') {
                this._renderColumnPointer();
            } else {
                this._renderArrowPointer();
            }
        },

        _renderColumnPointer: function () {
            this._pointer = this._r.rect(0, 0, 0, 0, this.pointer.style);
            this._r.attr(this._pointer, this.pointer.style);
            this._setValue(this.value);
        },

        _renderArrowPointer: function () {
            var path = this._getArrowPathByValue(0);
            this._pointer = this._r.path(path, this.pointer.style);
        },

        _getArrowPathByValue: function (value) {
            var border = this._getBorderSize(),
                top = Math.ceil(this._valueToCoordinates(value)) + border,
                left = border,
                offsetLeft = Math.ceil(this._getSize(this.ticksOffset[0], 'width')),
                offsetTop = Math.ceil(this._getSize(this.ticksOffset[1], 'height')),
                offset = Math.ceil(this._getSize(this.pointer.offset)),
                maxSize = Math.ceil(this._getMaxTickSize()),
                size = Math.ceil(this._getSize(this.pointer.size)),
                side = Math.ceil(Math.sqrt((size * size) / 3)),
                path, topProjection, temp;
            if (this.orientation === 'vertical') {
                left += offsetLeft + maxSize + offset;
                topProjection = (offset >= 0) ? left + size : left - size;
                path = 'M ' + left + ' ' + top + ' L ' + topProjection + ' ' + (top - side) + ' L ' + topProjection + ' ' + (top + side);
            } else {
                left += offsetLeft + maxSize * 2 + side + offset;
                temp = top;
                top = left;
                left = temp;
                topProjection = (offset >= 0) ? top - size : top + size;
                path = 'M ' + left + ' ' + top + ' L ' + (left - side) + ' ' + topProjection + ' L ' + (left + side) + ' ' + topProjection;
            }
            return path;
        },

        _setValue: function (val) {
            if (this.pointer.pointerType === 'default') {
                this._performColumnPointerLayout(val);
            } else {
                this._performArrowPointerLayout(val);
            }
            this.value = val;
        },

        _performColumnPointerLayout: function (val) {
            var bottom = this._valueToCoordinates(this.min),
                top = this._valueToCoordinates(val),
                height = Math.abs(bottom - top),
                border = this._getBorderSize(),
                offsetLeft = this._getSize(this.ticksOffset[0], 'width'),
                offsetTop = this._getSize(this.ticksOffset[1], 'height'),
                maxSize = this._getMaxTickSize(),
                width = this._getSize(this.pointer.size),
                offset = this._getSize(this.pointer.offset),
                attrs = {},
                left;
            if (this.orientation === 'vertical') {
                left = offsetLeft + maxSize;
                attrs = { left: left + offset + 1 + border, top: top, height: height, width: width };
            } else {
                left = offsetTop + maxSize;
                attrs = { left: bottom, top: left + offset - width - 1 + border, height: width, width: height };
            }
            this._setRectAttrs(attrs);
        },

        _performArrowPointerLayout: function (val) {
            var attr = this._getArrowPathByValue(val);
            if (this._isVML) {
                this._r.attr(this._pointer.childNodes[0], { v: attr });
                this._pointer.v = attr;
            } else {
                this._r.attr(this._pointer, { d: attr });
            }
        },

        _setRectAttrs: function (attrs) {
            if (!this._isVML) {
                this._r.attr(this._pointer, { x: attrs.left });
                this._r.attr(this._pointer, { y: attrs.top });
                this._r.attr(this._pointer, { width: attrs.width });
                this._r.attr(this._pointer, { height: attrs.height });
            } else {
                this._pointer.style.top = attrs.top;
                this._pointer.style.left = attrs.left;
                this._pointer.style.width = attrs.width;
                this._pointer.style.height = attrs.height;
            }
        },

        _valueToCoordinates: function (value) {
            var border = this._getBorderSize(),
                scaleLength = this._getScaleLength(),
                offsetLeft = this._getSize(this.ticksOffset[0], 'width'),
                offsetTop = this._getSize(this.ticksOffset[1], 'height'),
                current = Math.abs(this.min - value),
                distance = Math.abs(this.max - this.min);
            if (this.orientation === 'vertical') {
                return this._height - (current / distance) * scaleLength - (this._height - offsetTop - scaleLength) + border;
            }
            return (current / distance) * scaleLength + (this._width - offsetLeft - scaleLength) + border;
        },

        _getSize: function (size, dim) {
            dim = dim || (this.orientation === 'vertical' ? 'width' : 'height');
            if (size.toString().indexOf('%') >= 0) {
                size = (parseInt(size, 10) / 100) * this['_' + dim];
            }
            size = parseInt(size, 10);
            return size;
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (key == 'min') {
                this.min = parseInt(value);
                $.jqx.aria(this, 'aria-valuemin', value);
            }
            if (key == 'max') {
                this.max = parseInt(value);
                $.jqx.aria(this, 'aria-valuemax', value);
            }
            if (key == 'value') {
                this.value = parseInt(value);
            }

            if (key === 'disabled') {
                if (value) {
                    this.disable();
                } else {
                    this.enable();
                }
                $.jqx.aria(this, 'aria-disabled', value);
            } else if (key === 'value') {
                this.value = oldvalue;
                this.setValue(value);
            } else {
                if (key === 'colorScheme') {
                    this.pointer.style = null;
                } else if (key === 'orientation' && oldvalue !== value) {
                    var temp = this.ticksOffset[0];
                    this.ticksOffset[0] = this.ticksOffset[1];
                    this.ticksOffset[1] = temp;
                }
                if (key !== 'animationDuration' && key !== 'easing') {
                    this.refresh();
                }
            }
            if (this._r instanceof $.jqx.HTML5Renderer)
                this._r.refresh();
        },

        //Constructor functions for property validation
        _backgroundConstructor: function (background, jqx) {
            if (this.host) {
                return new this._backgroundConstructor(background, jqx);
            }
            var validBackgroundTypes = { rectangle: true, roundedRectangle: true };
            background = background || {};
            this.style = background.style || { stroke: '#cccccc', fill: null };
            if (background.visible || typeof background.visible === 'undefined') {
                this.visible = true;
            } else {
                this.visible = false;
            }
            if (validBackgroundTypes[background.backgroundType]) {
                this.backgroundType = background.backgroundType;
            } else {
                this.backgroundType = 'roundedRectangle';
            }
            if (this.backgroundType === 'roundedRectangle') {
                if (typeof background.borderRadius === 'number') {
                    this.borderRadius = background.borderRadius;
                } else {
                    this.borderRadius = 15;
                }
            }
            if (typeof background.showGradient === 'undefined') {
                this.showGradient = true;
            } else {
                this.showGradient = background.showGradient;
            }
        },

        _tickConstructor: function (tick, jqx) {
            if (this.host) {
                return new this._tickConstructor(tick, jqx);
            }
            this.size = jqx._validatePercentage(tick.size, '10%');
            this.interval = parseFloat(tick.interval);
            if (!this.interval) {
                this.interval = 5;
            }
            this.style = tick.style || { stroke: '#A1A1A1', 'stroke-width': '1px' };
            if (typeof tick.visible === 'undefined') {
                this.visible = true;
            } else {
                this.visible = tick.visible;
            }
        },

        _labelsConstructor: function (label, jqx) {
            if (this.host) {
                return new this._labelsConstructor(label, jqx);
            }
            this.position = label.position;
            if (this.position !== 'far' && this.position !== 'near' && this.position !== 'both') {
                this.position = 'both';
            }
            if (typeof label.formatValue === 'function') {
                this.formatValue = label.formatValue;
            } else {
                this.formatValue = function (val) {
                    return val;
                }
            }
            this.visible = label.visible;
            if (this.visible !== false && this.visible !== true) {
                this.visible = true;
            }
            if (typeof label.interval !== 'number') {
                this.interval = 10;
            } else {
                this.interval = label.interval;
            }
            this.offset = jqx._validatePercentage(label.offset, 0);
        },

        _rangeConstructor: function (range, jqx) {
            if (this.host) {
                return new this._rangeConstructor(range, jqx);
            }
            if (typeof range.startValue === 'number') {
                this.startValue = range.startValue;
            } else {
                this.startValue = jqx.min;
            }
            if (typeof range.endValue === 'number' && range.endValue > range.startValue) {
                this.endValue = range.endValue;
            } else {
                this.endValue = this.startValue + 1;
            }
            this.style = range.style || { fill: '#dddddd', stroke: '#dddddd' };
        },

        _pointerConstructor: function (pointer, jqx) {
            if (this.host) {
                return new this._pointerConstructor(pointer, jqx);
            }
            var color = jqx._getColorScheme(jqx.colorScheme)[0];
            this.pointerType = pointer.pointerType;
            if (this.pointerType !== 'default' && this.pointerType !== 'arrow') {
                this.pointerType = 'default';
            }
            this.style = pointer.style || { fill: color, stroke: color, 'stroke-width': 1 };
            this.size = jqx._validatePercentage(pointer.size, '7%');
            this.visible = pointer.visible;
            if (this.visible !== true && this.visible !== false) {
                this.visible = true;
            }
            this.offset = jqx._validatePercentage(pointer.offset, 0);
        }

    };

    //Extending with the common functionality
    $.extend(radialGauge, common);
    $.extend(linearGauge, common);

    //Initializing jqxWidgets
    $.jqx.jqxWidget("jqxLinearGauge", "", {});
    $.jqx.jqxWidget("jqxGauge", "", {});

    //Extending the widgets' prototypes
    $.extend($.jqx._jqxGauge.prototype, radialGauge);
    $.extend($.jqx._jqxLinearGauge.prototype, linearGauge);

})(jQuery);(function ($) {

    $.jqx.jqxWidget("jqxCheckBox", "", {});

    $.extend($.jqx._jqxCheckBox.prototype, {
        defineInstance: function () {
            // Type: Number
            // Default: 250
            // Gets or sets the delay of the fade animation when the CheckBox is going to be opened.
            this.animationShowDelay = 300,
            // Type: Number
            // Default: 300
            // Gets or sets the delay of the fade animation when the CheckBox is going to be closed. 
             this.animationHideDelay = 300,
            // Type: Number.
            // Default: null.
            // Sets the width.
            this.width = null;
            // Type: Number.
            // Default: null.
            // Sets the height.
            this.height = null;
            // Type: String
            // Default: '13px'
            // Gets or sets the checkbox's size.
            this.boxSize = '13px';
            // Type: Bool and Null
            // Default: false
            // Gets or sets the ckeck state.
            // Possible Values: true, false and null.
            this.checked = false;
            // Type: Bool
            // Default: false
            // Gets or sets whether the checkbox has 3 states - checked, unchecked and indeterminate.
            this.hasThreeStates = false;
            // Type: Bool
            // Default: false
            // Gets whether the CheckBox is disabled.
            this.disabled = false;
            // Type: Bool
            // Default: true
            // Gets or sets whether the clicks on the container are handled as clicks on the check box.
            this.enableContainerClick = true;
            // Type: Bool
            // Default: true
            // Gets or sets whether the checkbox is locked. In this mode the user is not allowed to check/uncheck the checkbox.
            this.locked = false;
            // Type: String
            // Default: ''
            // Gets or sets the group name. When this property is set, the checkboxes in the same group behave as radio buttons.
            this.groupName = '';
            this.keyboardCheck = true;
            this.enableHover = true;
            this.hasInput = true;
            this.rtl = false;
            this.updated = null;
            this.disabledContainer = false;
            this._canFocus = true;
            this.aria =
            {
                "aria-checked": { name: "checked", type: "boolean" },
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
            // 'checked' is triggered when the checkbox is checked.
            // 'unchecked' is triggered when the checkbox is unchecked.
            // 'indeterminate' is triggered when the checkbox's ckecked property is going to be null.
            // 'change' is triggered when the checkbox's state is changed.
            this.events =
			 [
			    'checked', 'unchecked', 'indeterminate', 'change'
             ];
        },

        createInstance: function (args) {
            this.render();
        },

        _addInput: function()
        {
            if (this.hasInput) {
                var name = this.host.attr('name');
                if (!name) name = this.element.id;
                this.input = $("<input type='hidden'/>");
                this.host.append(this.input);
                this.input.attr('name', name);
                this.input.val(this.checked);

                this.host.attr('role', 'checkbox');
                $.jqx.aria(this);
            }
        },

        render: function()
        {
            this.init = true;
            var me = this;
            this.setSize();
            this.propertyChangeMap['width'] = function (instance, key, oldVal, value) {
                me.setSize();
            };

            this.propertyChangeMap['height'] = function (instance, key, oldVal, value) {
                me.setSize();
            };
            if (this.checkbox) {
                this.checkbox.remove();
            }

            if (this.boxSize == null) this.boxSize = 13;
            var boxSize = parseInt(this.boxSize) + 'px';
            this.checkbox = $('<div><div style="width: ' + boxSize + '; height: ' + boxSize + ';"><span style="width: ' + boxSize + '; height: ' + boxSize + ';"></span></div></div>');
            this.host.prepend(this.checkbox);
            if (!this.disabledContainer) {
                if (!this.host.attr('tabIndex')) {
                    this.host.attr('tabIndex', 0);
                }
                this.host.append($('<div style="clear: both;"></div>'));
            }

            this.checkMark = $(this.checkbox[0].firstChild.firstChild);//$(this.checkbox).find('span');
            this.box = this.checkbox;

            this.box.addClass(this.toThemeProperty('jqx-checkbox-default') + " " + this.toThemeProperty('jqx-fill-state-normal') + " " + this.toThemeProperty('jqx-rc-all'));

            if (this.disabled) {
                this.disable();
            }

            if (!this.disabledContainer) {
                this.host.addClass(this.toThemeProperty('jqx-widget'));
                this.host.addClass(this.toThemeProperty('jqx-checkbox'));
            }

            if (this.locked && !this.disabledContainer) {
                this.host.css('cursor', 'auto');
            }

            var checked = this.element.getAttribute('checked');
            if (checked == 'checked' || checked == 'true' || checked == true) {
                this.checked = true;
            }

            this._addInput();
            this._render();
            this._addHandlers();
            this.init = false;
        },

        refresh: function (initialRefresh) {
            if (!initialRefresh) {
                this.setSize();
                this._render();
            }
        },

        setSize: function () {
            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                this.host.width(this.width);
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    this.host.width(this.width);
                };

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                this.host.height(this.height);
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                this.host.height(this.height);
            };
        },

        _addHandlers: function () {
            var me = this;

            var isTouchDevice = $.jqx.mobile.isTouchDevice();
            var eventName = 'click';
            if (isTouchDevice) eventName = $.jqx.mobile.getTouchEventName('touchend');

            this.addHandler(this.box, eventName, function (event) {
                if (!me.disabled && !me.enableContainerClick && !me.locked) {
                    me.toggle();
                    if (me.updated) {
                        event.owner = me;
                        me.updated(event, me.checked, me.oldChecked);
                    }
                    if (event.preventDefault) {
                        event.preventDefault();
                    }
                    return false;
                }
            });

            if (!this.disabledContainer) {
                this.addHandler(this.host, 'keydown', function (event) {
                    if (!me.disabled && !me.locked && me.keyboardCheck) {
                        if (event.keyCode == 32) {
                            if (!me._canFocus) {
                                return true;
                            }

                            me.toggle();
                            if (me.updated) {
                                event.owner = me;
                                me.updated(event, me.checked, me.oldChecked);
                            }
                            if (event.preventDefault) {
                                event.preventDefault();
                            }
                            return false;
                        }
                    }
                });

                this.addHandler(this.host, eventName, function (event) {
                    if (!me.disabled && me.enableContainerClick && !me.locked) {
                        me.toggle();
                        if (event.preventDefault) {
                            event.preventDefault();
                        }
                        return false;
                    }
                });

                this.addHandler(this.host, 'selectstart', function (event) {
                    if (!me.disabled && me.enableContainerClick) {
                        if (event.preventDefault) {
                            event.preventDefault();
                        }
                        return false;
                    }
                });

                this.addHandler(this.host, 'mouseup', function (event) {
                    if (!me.disabled && me.enableContainerClick) {
                        if (event.preventDefault) {
                            event.preventDefault();
                        }
                    }
                });

                this.addHandler(this.host, 'focus', function (event) {
                    if (!me.disabled && !me.locked) {
                        if (!me._canFocus) {
                            return true;
                        }

                        if (me.enableHover) {
                            me.box.addClass(me.toThemeProperty('jqx-checkbox-hover'));
                        }
                        me.box.addClass(me.toThemeProperty('jqx-fill-state-focus'));
                        if (event.preventDefault) {
                            event.preventDefault();
                        }
                        me.hovered = true;
                        return false;
                    }
                });

                this.addHandler(this.host, 'blur', function (event) {
                    if (!me.disabled && !me.locked) {
                        if (!me._canFocus) {
                            return true;
                        }
                        if (me.enableHover) {
                            me.box.removeClass(me.toThemeProperty('jqx-checkbox-hover'));
                        }
                        me.box.removeClass(me.toThemeProperty('jqx-fill-state-focus'));
                        if (event.preventDefault) {
                            event.preventDefault();
                        }
                        me.hovered = false;
                        return false;
                    }
                });

                this.addHandler(this.host, 'mouseenter', function (event) {
                    if (me.locked) {
                        me.host.css('cursor', 'arrow')
                    }
                    if (me.enableHover) {
                        if (!me.disabled && me.enableContainerClick && !me.locked) {
                            me.box.addClass(me.toThemeProperty('jqx-checkbox-hover'));
                            me.box.addClass(me.toThemeProperty('jqx-fill-state-hover'));
                            if (event.preventDefault) {
                                event.preventDefault();
                            }
                            me.hovered = true;
                            return false;
                        }
                    }
                });

                this.addHandler(this.host, 'mouseleave', function (event) {
                    if (me.enableHover) {
                        if (!me.disabled && me.enableContainerClick && !me.locked) {
                            me.box.removeClass(me.toThemeProperty('jqx-checkbox-hover'));
                            me.box.removeClass(me.toThemeProperty('jqx-fill-state-hover'));
                            if (event.preventDefault) {
                                event.preventDefault();
                            }
                            me.hovered = false;
                            return false;
                        }
                    }
                });

                this.addHandler(this.box, 'mouseenter', function () {
                    if (me.locked) {
                        return;
                    }

                    if (!me.disabled && !me.enableContainerClick) {
                        me.box.addClass(me.toThemeProperty('jqx-checkbox-hover'));
                        me.box.addClass(me.toThemeProperty('jqx-fill-state-hover'));
                    }
                });

                this.addHandler(this.box, 'mouseleave', function () {
                    if (!me.disabled && !me.enableContainerClick) {
                        me.box.removeClass(me.toThemeProperty('jqx-checkbox-hover'));
                        me.box.removeClass(me.toThemeProperty('jqx-fill-state-hover'));
                    }
                });
            }
        },

        focus: function () {
            try {
                this.host.focus();
            }
            catch (error) {
            }
        },

        _removeHandlers: function () {
            var isTouchDevice = $.jqx.mobile.isTouchDevice();
            var eventName = 'click';
            if (isTouchDevice) eventName = 'touchend';

            this.removeHandler(this.box, eventName);
            this.removeHandler(this.box, 'mouseenter');
            this.removeHandler(this.box, 'mouseleave');
            this.removeHandler(this.host, eventName);
            this.removeHandler(this.host, 'mouseup');
            this.removeHandler(this.host, 'selectstart');
            this.removeHandler(this.host, 'mouseenter');
            this.removeHandler(this.host, 'mouseleave');
            this.removeHandler(this.host, 'keydown');
            this.removeHandler(this.host, 'blur');
            this.removeHandler(this.host, 'focus');
        },

        _render: function () {
            if (!this.disabled) {
                if (this.enableContainerClick) {
                    this.host.css('cursor', 'pointer');
                }
                else
                    if (!this.init) {
                        this.host.css('cursor', 'auto');
                    }
            }
            else {
                this.disable();
            }
            if (this.rtl) {
                this.box.addClass(this.toThemeProperty('jqx-checkbox-rtl'));
                this.host.addClass(this.toThemeProperty('jqx-rtl'));
            }

            this.updateStates();
        },

        _setState: function (checked) {
            if (this.checked != checked) {
                this.checked = checked;
                if (this.checked) {
                    this.checkMark[0].className = this.toThemeProperty('jqx-checkbox-check-checked');
                }
                else if (this.checked == null) {
                    this.checkMark[0].className = this.toThemeProperty('jqx-checkbox-check-indeterminate');
                }
                else {
                    this.checkMark[0].className = "";
                }
            }
        },

        val: function (value) {
            if (arguments.length == 0 || (value != null && typeof (value) == "object")) {
                return this.checked;
            }

            if (typeof value == "string") {
                if (value == "true") this.check();
                if (value == "false") this.uncheck();
                if (value == "") this.indeterminate();
            }
            else {
                if (value == true) this.check();
                if (value == false) this.uncheck();
                if (value == null) this.indeterminate();
            }
            return this.checked;
        },

        // checks the ckeckbox.
        check: function () {
            this.checked = true;
            var me = this;
            this.checkMark.removeClass();

            if ($.jqx.browser.msie || this.animationShowDelay == 0) {
                this.checkMark.addClass(this.toThemeProperty('jqx-checkbox-check-checked'));
            }
            else {
                this.checkMark.addClass(this.toThemeProperty('jqx-checkbox-check-checked'));
                this.checkMark.css('opacity', 0);
                this.checkMark.stop().animate({ opacity: 1 }, this.animationShowDelay, function () {
                });
            }
       
            if (this.groupName != null && this.groupName.length > 0) {
                var checkboxes = $.find(this.toThemeProperty('.jqx-checkbox', true));
                $.each(checkboxes, function () {
                    var groupName = $(this).jqxCheckBox('groupName');
                    if (groupName == me.groupName && this != me.element) {
                        $(this).jqxCheckBox('uncheck')
                    }
                });
            }

            this._raiseEvent('0', true);
            this._raiseEvent('3', { checked: true });
            if (this.input != undefined) {
                this.input.val(this.checked);
                $.jqx.aria(this, "aria-checked", this.checked);
            }
        },

        // unchecks the checkbox.
        uncheck: function () {
            this.checked = false;
            var me = this;

            if ($.jqx.browser.msie || this.animationHideDelay == 0) {
                if (me.checkMark[0].className != "")
                {
                    me.checkMark[0].className = "";
                }
            }
            else {
                this.checkMark.css('opacity', 1);
                this.checkMark.stop().animate({ opacity: 0 }, this.animationHideDelay, function () {
                    if (me.checkMark[0].className != "") {
                        me.checkMark[0].className = "";
                    }
                });
            }

            this._raiseEvent('1');
            this._raiseEvent('3', { checked: false });
            if (this.input != undefined) {
                this.input.val(this.checked);
                $.jqx.aria(this, "aria-checked", this.checked);
            }
        },

        // sets the indeterminate state.
        indeterminate: function () {
            this.checked = null;
            this.checkMark.removeClass();

            if ($.jqx.browser.msie || this.animationShowDelay == 0) {
                this.checkMark.addClass(this.toThemeProperty('jqx-checkbox-check-indeterminate'));
            }
            else {
                this.checkMark.addClass(this.toThemeProperty('jqx-checkbox-check-indeterminate'));
                this.checkMark.css('opacity', 0);
                this.checkMark.stop().animate({ opacity: 1 }, this.animationShowDelay, function () {
                });
            }

            this._raiseEvent('2');
            this._raiseEvent('3', { checked: null });
            if (this.input != undefined) {
                this.input.val(this.checked);
                $.jqx.aria(this, "aria-checked", "undefined");
            }
        },

        // toggles the check state.
        toggle: function () {
            if (this.disabled)
                return;

            if (this.locked)
                return;

            if (this.groupName != null && this.groupName.length > 0) {
                if (this.checked != true) {
                    this.checked = true;
                    this.updateStates();
                }
                return;
            }

            this.oldChecked = this.checked;
            if (this.checked == true) {
                this.checked = this.hasThreeStates ? null : false;
            }
            else {
                this.checked = this.checked != null;
            }

            this.updateStates();
            if (this.input != undefined) {
                this.input.val(this.checked);
            }
        },

        // updates check states depending on the value of the 'checked' property.
        updateStates: function () {
            if (this.checked) {
                this.check();
            }
            else if (this.checked == false) {
                this.uncheck();
            }
            else if (this.checked == null) {
                this.indeterminate();
            }
        },

        // disables the checkbox.
        disable: function () {
            this.disabled = true;

            if (this.checked == true) {
                this.checkMark.addClass(this.toThemeProperty('jqx-checkbox-check-disabled'));
            }
            else if (this.checked == null) {
                this.checkMark.addClass(this.toThemeProperty('jqx-checkbox-check-indeterminate-disabled'));
            }
            this.box.addClass(this.toThemeProperty('jqx-checkbox-disabled-box'));
            this.host.addClass(this.toThemeProperty('jqx-checkbox-disabled'));
            this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
            this.box.addClass(this.toThemeProperty('jqx-checkbox-disabled'));
            $.jqx.aria(this, "aria-disabled", this.disabled);
        },

        // enables the checkbox.
        enable: function () {
            if (this.checked == true) {
                this.checkMark.removeClass(this.toThemeProperty('jqx-checkbox-check-disabled'));
            }
            else if (this.checked == null) {
                this.checkMark.removeClass(this.toThemeProperty('jqx-checkbox-check-indeterminate-disabled'));
            }
            this.box.removeClass(this.toThemeProperty('jqx-checkbox-disabled-box'));
            this.host.removeClass(this.toThemeProperty('jqx-checkbox-disabled'));
            this.host.removeClass(this.toThemeProperty('jqx-fill-state-disabled'));
            this.box.removeClass(this.toThemeProperty('jqx-checkbox-disabled'));
            this.disabled = false;
            $.jqx.aria(this, "aria-disabled", this.disabled);
        },

        destroy: function () {
            this.host.remove();
        },

        _raiseEvent: function (id, args) {
            if (this.init) return;
            var evt = this.events[id];
            var event = new jQuery.Event(evt);
            event.owner = this;
            event.args = args;
            try
            {
                var result = this.host.trigger(event);
            }
            catch (error) {

            }

            return result;
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (this.isInitialized == undefined || this.isInitialized == false)
                return;

            if (key == object.enableContainerClick && !object.disabled && !object.locked) {
                if (value) {
                    object.host.css('cursor', 'pointer');
                }
                else object.host.css('cursor', 'auto');
            }

            if (key == "rtl") {
                if (value) {
                    object.box.addClass(object.toThemeProperty('jqx-checkbox-rtl'));
                    object.host.addClass(object.toThemeProperty('jqx-rtl'));
                }
                else
                {
                    object.box.removeClass(object.toThemeProperty('jqx-checkbox-rtl'));
                    object.host.removeClass(object.toThemeProperty('jqx-rtl'));
                }
            }

            if (key == 'theme') {
                $.jqx.utilities.setTheme(oldvalue, value, object.host);
            }

            if (key == 'checked') {
                if (value != oldvalue) {
                    switch (value) {
                        case true:
                            object.check();
                            break;
                        case false:
                            object.uncheck();
                            break;
                        case null:
                            object.indeterminate();
                            break;
                    }
                }
            }

            if (key == 'disabled') {
                if (value != oldvalue) {
                    if (value) {
                        object.disable();
                    } else object.enable();
                }
            }
        }
    });
})(jQuery);

(function ($) {

    $.jqx.jqxWidget("jqxButtonGroup", "", {});

    $.extend($.jqx._jqxButtonGroup.prototype, {
        defineInstance: function () {
            //Possible values: checkbox, radio, default
            this.mode = 'default';
            this.roundedCorners = true;
            this.disabled = false;
            this.enableHover = false;
            this.orientation = 'horizontal';
            this.width = null;
            this.height = null;
            this._eventsMap = {
                'mousedown': $.jqx.mobile.getTouchEventName('touchstart'),
                'mouseup': $.jqx.mobile.getTouchEventName('touchend')
            };
            this._events = ['selected', 'unselected', 'buttonclick'];
            this._buttonId = {};
            this._selected = null;
            this._pressed = null;
            this.rtl = false;
            this._baseId = 'group_button';
            this.aria =
            {
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
        },

        createInstance: function (args) {
            this._isTouchDevice = $.jqx.mobile.isTouchDevice();
            var me = this;
            $.jqx.aria(this);
            this.addHandler(this.host, 'selectstart', function (event) {
                if (!me.disabled) {
                    event.preventDefault();
                }
            });
        },

        refresh: function () {
            if (this.width) {
                if (this.width.toString() && this.width.indexOf('%') >= 0) {
                    this.element.style.width = this.width;
                }
                else {
                    this.host.width(this.width);
                }
            }
            if (this.height) this.host.height(this.height);
            this._refreshButtons();
        },

        render: function () {
            this.refresh();
        },

        _getEvent: function (event) {
            if (this._isTouchDevice) {
                var e = this._eventsMap[event] || event;
                e += "." + this.element.id;
                return e;
            }
            event += "." + this.element.id;
            return event;
        },

        _refreshButtons: function () {
            if (this.lastElement)
                this.lastElement.remove();
            
            this.lastElement = $("<div style='clear: both;'></div>");
            var children = this.host.children(),
                count = children.length,
                current;

            switch (this.mode) {
                case "radio":
                    this.host.attr('role', 'radiogroup');
                    break;
                case "checkbox":
                case "default":
                    this.host.attr('role', 'group');
                    break;
            }

            var width = new Number(100 / count).toFixed(2);
            for (var i = 0; i < count; i += 1) {
                current = $(children[i]);
                if (this.width) {
                    if (this.orientation === "horizontal") {
                        current.css('width', width + '%');
                        current.css('box-sizing', 'border-box');
                        current.css('-moz-box-sizing', 'border-box');
                        current.css('white-space', 'nowrap');
                        current.css('text-overflow', 'ellipsis');
                        current.css('overflow', 'hidden');
                    }
                    else {
                        current.css('box-sizing', 'border-box');
                        current.css('-moz-box-sizing', 'border-box');
                        current.css('width', '100%');
                    }
                }

                this._refreshButton(current, i, count);
            }
            this.lastElement.appendTo(this.host);
        },

        _refreshButton: function (btn, counter, count) {
            (function (btn) {
                btn = this._render(btn);
                this._removeStyles(btn);
                this._addStyles(btn, counter, count);
                this._performLayout(btn);
                this._removeButtonListeners(btn);
                this._addButtonListeners(btn);
                this._handleButtonId(btn, counter);
             
                if (this.mode == "radio") {
                    btn.attr('role', 'radio');
                }
                else {
                    btn.attr('role', 'button');
                }
                btn.attr('disabled', this.disabled);
                if (this.disabled) {
                    btn.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
                }
                else {
                    btn.removeClass(this.toThemeProperty('jqx-fill-state-disabled'));
                }
            }).apply(this, [btn]);
        },

        destroy: function (removeFromDom) {
            var children = this.host.children(),
            count = children.length,
            current;

            for (var i = 0; i < count; i += 1) {
                current = $(children[i]);
                this._removeStyles(current);
                this._removeButtonListeners(current);
            }

           if (removeFromDom != false) {
                this.host.remove();
            }
        },

        _render: function (btn) {
            if (btn[0].tagName.toLowerCase() === 'button') {
                return this._renderFromButton(btn);
            } else {
                return this._renderButton(btn);
            }
        },

        _renderButton: function (btn) {
            var content;
            btn.wrapInner('<div/>');
            return btn;
        },

        _removeStyles: function (btn) {
            this.host.removeClass('jqx-widget');
            this.host.removeClass('jqx-rc-all');
            btn.removeClass(this.toThemeProperty('jqx-fill-state-normal'));
            btn.removeClass(this.toThemeProperty('jqx-group-button-normal'));
            btn.removeClass(this.toThemeProperty('jqx-rc-tl'));
            btn.removeClass(this.toThemeProperty('jqx-rc-bl'));
            btn.removeClass(this.toThemeProperty('jqx-rc-tr'));
            btn.removeClass(this.toThemeProperty('jqx-rc-br'));
            btn.css('margin-left', 0);
        },

        _addStyles: function (btn, counter, count) {
            this.host.addClass(this.toThemeProperty('jqx-widget'));
            this.host.addClass(this.toThemeProperty('jqx-rc-all'));
            this.host.addClass(this.toThemeProperty('jqx-buttongroup'));
            btn.addClass(this.toThemeProperty('jqx-button'));
            btn.addClass(this.toThemeProperty('jqx-group-button-normal'));
            btn.addClass(this.toThemeProperty('jqx-fill-state-normal'));
            if (this.roundedCorners) {
                if (counter === 0) {
                    this._addRoundedCorners(btn, true);
                } else if (counter === count - 1) {
                    this._addRoundedCorners(btn, false);
                }
            }
            if (this.orientation == 'horizontal') {
                btn.css('margin-left', -parseInt(btn.css('border-left-width'), 10));
            }
            else {
                btn.css('margin-top', -parseInt(btn.css('border-left-width'), 10));
            }
        },

        _addRoundedCorners: function (button, left) {
            if (this.orientation == 'horizontal') {
                if (left) {
                    button.addClass(this.toThemeProperty('jqx-rc-tl'));
                    button.addClass(this.toThemeProperty('jqx-rc-bl'));
                } else {
                    button.addClass(this.toThemeProperty('jqx-rc-tr'));
                    button.addClass(this.toThemeProperty('jqx-rc-br'));
                }
            }
            else {
                if (left) {
                    button.addClass(this.toThemeProperty('jqx-rc-tl'));
                    button.addClass(this.toThemeProperty('jqx-rc-tr'));
                } else {
                    button.addClass(this.toThemeProperty('jqx-rc-bl'));
                    button.addClass(this.toThemeProperty('jqx-rc-br'));
                }
            }
        },

        _centerContent: function (content, parent) {
            content.css({
                'margin-top': (parent.height() - content.height()) / 2,
                'margin-left': (parent.width() - content.width()) / 2
            });
            return content;
        },

        _renderFromButton: function (btn) {
            var content = btn.val();
            if (content == "") {
                content = btn.html();
            }

            var div;
            var id = btn[0].id;
            btn.wrap('<div/>');
            div = btn.parent();
            div.attr('style', btn.attr('style'));
            btn.remove();
            $.jqx.utilities.html(div, content);
            div[0].id = id;
            return div;
        },

        _performLayout: function (btn) {
            if (this.orientation == 'horizontal') {
                if (this.rtl) {
                    btn.css('float', 'right');
                }
                else {
                    btn.css('float', 'left');
                }
            }
            else {
                btn.css('float', 'none');
            }

            this._centerContent($(btn.children()), btn);
        },

        _mouseEnterHandler: function (e) {
            var self = e.data.self,
                btn = $(e.currentTarget);
            if (self._isDisabled(btn) || !self.enableHover) {
                return;
            }
            btn.addClass(self.toThemeProperty('jqx-group-button-hover'));
            btn.addClass(self.toThemeProperty('jqx-fill-state-hover'));
        },

        _mouseLeaveHandler: function (e) {
            var self = e.data.self,
                btn = $(e.currentTarget);
            if (self._isDisabled(btn) || !self.enableHover) {
                return;
            }
            btn.removeClass(self.toThemeProperty('jqx-group-button-hover'));
            btn.removeClass(self.toThemeProperty('jqx-fill-state-hover'));
        },

        _mouseDownHandler: function (e) {
            var self = e.data.self,
                btn = $(e.currentTarget);
            if (self._isDisabled(btn)) {
                return;
            }
            self._pressed = btn;
            btn.addClass(self.toThemeProperty('jqx-group-button-pressed'));
            btn.addClass(self.toThemeProperty('jqx-fill-state-pressed'));
        },

        _mouseUpHandler: function (e) {
            var self = e.data.self,
                btn = $(e.currentTarget);
            if (self._isDisabled(btn)) {
                return;
            }
            self._handleSelection(btn);
            self._pressed = null;
            btn = self._buttonId[btn[0].id];
            self._raiseEvent(2, { index: btn.num, button: btn.btn });
        },

        _isDisabled: function (btn) {
            if (!btn || !btn[0]) {
                return false;
            }
            return this._buttonId[btn[0].id].disabled;
        },

        _documentUpHandler: function (e) {
            var self = e.data.self,
                pressedButton = self._pressed;
            if (pressedButton && !self._buttonId[pressedButton[0].id].selected) {
                pressedButton.removeClass(self.toThemeProperty('jqx-fill-state-pressed'));
                self._pressed = null;
            }
        },

        _addButtonListeners: function (btn) {
            var self = this;
            this.addHandler(btn, this._getEvent('mouseenter'), this._mouseEnterHandler, { self: this });
            this.addHandler(btn, this._getEvent('mouseleave'), this._mouseLeaveHandler, { self: this });
            this.addHandler(btn, this._getEvent('mousedown'), this._mouseDownHandler, { self: this });
            this.addHandler(btn, this._getEvent('mouseup'), this._mouseUpHandler, { self: this });
            this.addHandler($(document), this._getEvent('mouseup'), this._documentUpHandler, { self: this });
        },

        _removeButtonListeners: function (btn) {
            this.removeHandler(btn, this._getEvent('mouseenter'), this._mouseEnterHandler);
            this.removeHandler(btn, this._getEvent('mouseleave'), this._mouseLeaveHandler);
            this.removeHandler(btn, this._getEvent('mousedown'), this._mouseDownHandler);
            this.removeHandler(btn, this._getEvent('mouseup'), this._mouseUpHandler);
            this.removeHandler($(document), this._getEvent('mouseup'), this._documentUpHandler);
        },

        _handleSelection: function (btn) {
            if (this.mode === 'radio') {
                this._handleRadio(btn);
            } else if (this.mode === 'checkbox') {
                this._handleCheckbox(btn);
            } else {
                this._handleDefault(btn);
            }
        },

        _handleRadio: function (btn) {
            var selected = this._getSelectedButton();
            if (selected && selected.btn[0].id !== btn[0].id) {
                this._unselectButton(selected.btn, true);
            }
            for (var data in this._buttonId) {
                this._buttonId[data].selected = true;
                this._unselectButton(this._buttonId[data].btn, false);
            }

            this._selectButton(btn, true);
        },

        _handleCheckbox: function (btn) {
            var btnInfo = this._buttonId[btn[0].id];
            if (btnInfo.selected) {
                this._unselectButton(btnInfo.btn, true);
            } else {
                this._selectButton(btn, true);
            }
        },

        _handleDefault: function (btn) {
            this._selectButton(btn, false);
            for (var data in this._buttonId) {
                this._buttonId[data].selected = true;
                this._unselectButton(this._buttonId[data].btn, false);
            }
        },

        _getSelectedButton: function () {
            for (var data in this._buttonId) {
                if (this._buttonId[data].selected) {
                    return this._buttonId[data];
                }
            }
            return null;
        },

        _getSelectedButtons: function () {
            var selected = [];
            for (var data in this._buttonId) {
                if (this._buttonId[data].selected) {
                    selected.push(this._buttonId[data].num);
                }
            }
            return selected;
        },

        _getButtonByIndex: function (index) {
            var current;
            for (var data in this._buttonId) {
                if (this._buttonId[data].num === index) {
                    return this._buttonId[data];
                }
            }
            return null;
        },

        _selectButton: function (btn, raiseEvent) {
            var btnInfo = this._buttonId[btn[0].id];
            if (btnInfo.selected) {
                return;
            }
            btnInfo.btn.addClass(this.toThemeProperty('jqx-group-button-pressed'));
            btnInfo.btn.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
            btnInfo.selected = true;
            if (raiseEvent) {
                this._raiseEvent(0, { index: btnInfo.num, button: btnInfo.btn });
            }
            $.jqx.aria(btnInfo.btn, 'aria-checked', true);
        },

        _unselectButton: function (btn, raiseEvent) {
            var btnInfo = this._buttonId[btn[0].id];
            if (!btnInfo.selected) {
                return;
            }
            btnInfo.btn.removeClass(this.toThemeProperty('jqx-group-button-pressed'));
            btnInfo.btn.removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
            btnInfo.selected = false;
            if (raiseEvent) {
                this._raiseEvent(1, { index: btnInfo.num, button: btnInfo.btn });
            }
            $.jqx.aria(btnInfo.btn, 'aria-checked', false);
        },

        setSelection: function (index) {
            if (index === -1) {
                this.clearSelection();
                return;
            }

            if (this.mode === 'checkbox') {
                if (typeof index === 'number') {
                    this._setSelection(index);
                } else {
                    for (var i = 0; i < index.length; i += 1) {
                        this._setSelection(index[i]);
                    }
                }
            } else if (typeof index === 'number' && this.mode === 'radio') {
                this._setSelection(index);
            }
        },

        _setSelection: function (index) {
            var btn = this._getButtonByIndex(index);
            if (btn) {
                this._handleSelection(btn.btn);
            }
        },

        getSelection: function () {
            if (this.mode === 'radio') {
                return this._getSelectedButton().num;
            } else if (this.mode === 'checkbox') {
                return this._getSelectedButtons();
            }
            return undefined;
        },

        disable: function () {
            this.disabled = true;
            var current;
            for (var btn in this._buttonId) {
                current = this._buttonId[btn];
                this.disableAt(current.num);
            }
            $.jqx.aria(this, "aria-disabled", true);
        },

        enable: function () {
            this.disabled = false;
            var current;
            for (var btn in this._buttonId) {
                current = this._buttonId[btn];
                this.enableAt(current.num);
            }
            $.jqx.aria(this, "aria-disabled", false);
        },

        disableAt: function (index) {
            var btn = this._getButtonByIndex(index);
            if (!btn.disabled) {
                btn.disabled = true;
                btn.btn.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
            }
        },

        enableAt: function (index) {
            var btn = this._getButtonByIndex(index);
            if (btn.disabled) {
                btn.disabled = false;
                btn.btn.removeClass(this.toThemeProperty('jqx-fill-state-disabled'));
            }
        },

        _handleButtonId: function (btn, number) {
            var id = btn[0].id,
                btnId = { btn: btn, num: number, selected: false },
                widgetId;
            if (!id) {
                id = this._baseId + new Date().getTime();
            }
            btn[0].id = id;
            this._buttonId[id] = btnId;
            return id;
        },

        _raiseEvent: function (id, data) {
            var event = $.Event(this._events[id]);
            event.args = data;
            return this.host.trigger(event);
        },

        _unselectAll: function () {
            for (var data in this._buttonId) {
                this._unselectButton(this._buttonId[data].btn, false);
            }
        },

        clearSelection: function()
        {
            this._unselectAll();
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (key == 'theme' && value != null) {
                $.jqx.utilities.setTheme(oldvalue, value, object.host);
            }

            if (key === 'mode') {
                object._unselectAll();
                object.refresh();
                return;
            } else if (key === 'disabled') {
                if (value) {
                    object.disable();
                } else {
                    object.enable();
                }
            } else {
                object.refresh();
            }
        }
    });
})(jQuery);
(function ($) {

    $.jqx.jqxWidget("jqxListBox", "", {});

    $.extend($.jqx._jqxListBox.prototype, {
        defineInstance: function () {
            // Type: Boolean
            // Default: true    
            // enables/disables the listbox.
            this.disabled = false;
            // gets or sets the listbox width.
            this.width = null;
            // gets or sets the listbox height.
            this.height = null;
            // Represents the collection of list items.
            this.items = new Array();
            // Type: Boolean
            // Default: false
            // enables/disables the multiple selection.
            this.multiple = false;
            // Gets or sets the selected index.
            this.selectedIndex = -1;
            // Gets the selected item indexes.
            this.selectedIndexes = new Array();
            // Type: Object
            // Default: null
            // data source.
            this.source = null;
            // Type: Number
            // Default: 15
            // gets or sets the scrollbars size.
            this.scrollBarSize = $.jqx.utilities.scrollBarSize;
            // Type: Boolean
            // Default: true
            // enables/disables the hover state.
            this.enableHover = true;
            // Type: Boolean
            // Default: true
            // enables/disables the selection.
            this.enableSelection = true;
            // gets the visible items. // this property is internal for the listbox.
            this.visualItems = new Array();
            // gets the groups. // this property is internal for the listbox.
            this.groups = new Array();
            // Type: Boolean
            // Default: true
            // gets or sets whether the items width should be equal to the listbox's width.
            this.equalItemsWidth = true;
            // gets or sets the height of the ListBox Items. When the itemHeight == - 1, each item's height is equal to its desired height.
            this.itemHeight = -1;
            // this property is internal for the listbox.
            this.visibleItems = new Array();
            // Type: String
            // Default: Group
            // represents the text of the empty group. This is displayed only when the items are not loaded from html select element.
            this.emptyGroupText = 'Group';
            // Type: Boolean
            // Default: false
            // Gets or sets whether the listbox should display a checkbox next to each item.
            this.checkboxes = false;
            // Type: Boolean
            // Default: false
            // Gets or sets whether the listbox checkboxes have three states - checked, unchecked and indeterminate.           
            this.hasThreeStates = false;
            // Type: Boolean
            // Default: false
            // Gets or sets whether the listbox's height is equal to the sum of its items height          
            this.autoHeight = false;
            this.autoItemsHeight = false;
            // represents the listbox's events.    
            // Type: Boolean
            // Default: true
            // Gets or sets whether the listbox items are with rounded corners.         
            this.roundedcorners = true;
            this.touchMode = 'auto';
            this.displayMember = "";
            this.valueMember = "";
            // Type: String
            // Default: startswithignorecase
            // Possible Values: 'none, 'contains', 'containsignorecase', 'equals', 'equalsignorecase', 'startswithignorecase', 'startswith', 'endswithignorecase', 'endswith'
            this.searchMode = 'startswithignorecase';
            this.incrementalSearch = true;
            this.incrementalSearchDelay = 1000;
            this.incrementalSearchKeyDownDelay = 300;
            this.allowDrag = false;
            this.allowDrop = true;
            // Possible values: 'none, 'default', 'copy'
            this.dropAction = 'default';
            this.touchModeStyle = 'auto';
            this.keyboardNavigation = true;
            this.enableMouseWheel = true;
            this.multipleextended = false;
            this.emptyString = "null";
            this.rtl = false;
            this.rendered = null;
            this.renderer = null;
            this.dragStart = null;
            this.dragEnd = null;
            this.ready = null;
            this._checkForHiddenParent = true;
            this.aria =
            {
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
            this.events =
            [
            // triggered when the user selects an item.
                'select',
            // triggered when the user unselects an item.
                'unselect',
            // triggered when the selection is changed.
                'change',
            // triggered when the user checks or unchecks an item. 
                'checkChange',
            // triggered when the user drags an item. 
               'dragStart',
            // triggered when the user drops an item. 
               'dragEnd',
            // triggered when the binding is completed.
               'bindingComplete'
            ];
        },

        createInstance: function (args) {
            if (this.width == null) this.width = 200;
            if (this.height == null) this.height = 200;
            this.render();
            var that = this;
            $.jqx.utilities.resize(this.host, function () {
                that._updateSize();
            }, false, this._checkForHiddenParent);
        },

        render: function () {
            this.element.innerHTML = "";
            var self = this;

            var className = this.element.className;

            className += " " + this.toThemeProperty("jqx-listbox");
            className += " " + this.toThemeProperty("jqx-reset");
            className += " " + this.toThemeProperty("jqx-rc-all");
            className += " " + this.toThemeProperty("jqx-widget");
            className += " " + this.toThemeProperty("jqx-widget-content");

            this.element.className = className;

            var isPercentage = false;

            if (this.width != null && this.width.toString().indexOf("%") != -1) {
                this.host.width(this.width);
                isPercentage = true;
            }
            if (this.height != null && this.height.toString().indexOf("%") != -1) {
                this.host.height(this.height);
                if (this.host.height() == 0) {
                    this.host.height(200);
                }
                isPercentage = true;
            }
            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                this.host.width(this.width);
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    this.element.style.width = parseInt(this.width) + 'px';
                };

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                this.host.height(this.height);
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                this.element.style.height = parseInt(this.height) + 'px';
            };

            if (this.multiple || this.multipleextended || this.checkboxes) {
                $.jqx.aria(this, "aria-multiselectable", true);
            }
            else {
                $.jqx.aria(this, "aria-multiselectable", false);
            }

            var listBoxStructure = $("<div style='-webkit-appearance: none; background: transparent; outline: none; width:100%; height: 100%; align:left; border: 0px; padding: 0px; margin: 0px; left: 0px; top: 0px; valign:top; position: relative;'>" +
                "<div style='-webkit-appearance: none; border: none; background: transparent; outline: none; width:100%; height: 100%; padding: 0px; margin: 0px; align:left; left: 0px; top: 0px; valign:top; position: relative;'>" +
                "<div id='listBoxContent' style='-webkit-appearance: none; border: none; background: transparent; outline: none; border: none; padding: 0px; overflow: hidden; margin: 0px; align:left; valign:top; left: 0px; top: 0px; position: absolute;'/>" +
                "<div id='verticalScrollBar" + this.element.id + "' style='visibility: inherit; align:left; valign:top; left: 0px; top: 0px; position: absolute;'/>" +
                "<div id='horizontalScrollBar" + this.element.id + "' style='visibility: inherit; align:left; valign:top; left: 0px; top: 0px; position: absolute;'/>" +
                "<div id='bottomRight' style='align:left; valign:top; left: 0px; top: 0px; border: none; position: absolute;'/>" +
                "</div>" +
                "</div>");
            if (this._checkForHiddenParent) {
                this._addInput();
                if (!this.host.attr('tabIndex')) {
                    this.host.attr('tabIndex', 1);
                }
            }

            this.host.attr('role', 'listbox');
            if (this.checkboxes && !this.host.jqxCheckBox) {
                throw new Error("jqxListBox: Missing reference to jqxcheckbox.js.");
            }

            this.host.append(listBoxStructure);
            var verticalScrollBar = this.host.find("#verticalScrollBar" + this.element.id);
            if (!this.host.jqxButton) {
                throw new Error('jqxListBox: Missing reference to jqxbuttons.js.');
                return;
            }
            if (!verticalScrollBar.jqxScrollBar) {
                throw new Error('jqxListBox: Missing reference to jqxscrollbar.js.');
                return;
            }

            var largestep = parseInt(this.host.height()) / 2;
            if (largestep == 0) largestep = 10;

            this.vScrollBar = verticalScrollBar.jqxScrollBar({ _initialLayout: true, 'vertical': true, rtl: this.rtl, theme: this.theme, touchMode: this.touchMode, largestep: largestep });
            var horizontalScrollBar = this.host.find("#horizontalScrollBar" + this.element.id);
            this.hScrollBar = horizontalScrollBar.jqxScrollBar({ _initialLayout: true, 'vertical': false, rtl: this.rtl, touchMode: this.touchMode, theme: this.theme });

            this.content = this.host.find("#listBoxContent");
            this.content[0].id = 'listBoxContent' + this.element.id;
            this.bottomRight = this.host.find("#bottomRight").addClass(this.toThemeProperty('jqx-listbox-bottomright'));
            this.bottomRight[0].id = "bottomRight" + this.element.id;
            this.vScrollInstance = $.data(this.vScrollBar[0], 'jqxScrollBar').instance;
            this.hScrollInstance = $.data(this.hScrollBar[0], 'jqxScrollBar').instance;
            if (this.isTouchDevice()) {
                if (!($.jqx.browser.msie && $.jqx.browser.version < 9)) {
                    var overlayContent = $("<div class='overlay' style='z-index: 99; -webkit-appearance: none; border: none; background: black; opacity: 0.01; outline: none; border: none; padding: 0px; overflow: hidden; margin: 0px; align:left; valign:top; left: 0px; top: 0px; position: absolute;'></div>");
                    this.content.parent().append(overlayContent);
                    this.overlayContent = this.host.find('.overlay');
                }
            }
            this._updateTouchScrolling();

            this.host.addClass('jqx-disableselect');
            if (this.host.jqxDragDrop) {
                jqxListBoxDragDrop();
            }
        },

        _highlight: function (label, searchstring) {
            var query = searchstring.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, '\\$&')
            return label.replace(new RegExp('(' + query + ')', 'ig'), function ($1, match) {
                return '<b>' + match + '</b>'
            });
        },

        _addInput: function () {
            var name = this.host.attr('name');
            if (!name) name = this.element.id;
            else {
                this.host.attr('name', "");
            }

            this.input = $("<input type='hidden'/>");
            this.host.append(this.input);
            this.input.attr('name', name);
        },

        _updateTouchScrolling: function () {
            var self = this;
            if (this.isTouchDevice()) {
                self.enableHover = false;
                var element = this.overlayContent ? this.overlayContent : this.content;

                this.removeHandler($(element), $.jqx.mobile.getTouchEventName('touchstart') + '.touchScroll');
                this.removeHandler($(element), $.jqx.mobile.getTouchEventName('touchmove') + '.touchScroll');
                this.removeHandler($(element), $.jqx.mobile.getTouchEventName('touchend') + '.touchScroll');
                this.removeHandler($(element), 'touchcancel.touchScroll');

                $.jqx.mobile.touchScroll(element, self.vScrollInstance.max, function (left, top) {
                    if (self.vScrollBar.css('visibility') != 'hidden') {
                        var oldValue = self.vScrollInstance.value;
                        self.vScrollInstance.setPosition(oldValue + top);
                        self._lastScroll = new Date();
                    }
                    if (self.hScrollBar.css('visibility') != 'hidden') {
                        var oldValue = self.hScrollInstance.value;
                        self.hScrollInstance.setPosition(oldValue + left);
                        self._lastScroll = new Date();
                    }
                }, this.element.id, this.hScrollBar, this.vScrollBar);

                if (self.vScrollBar.css('visibility') != 'visible' && self.hScrollBar.css('visibility') != 'visible') {
                    $.jqx.mobile.setTouchScroll(false, this.element.id);
                }
                else {
                    $.jqx.mobile.setTouchScroll(true, this.element.id);
                }
                this._arrange();
            }
        },

        isTouchDevice: function () {
            var isTouchDevice = $.jqx.mobile.isTouchDevice();
            if (this.touchMode == true) {
                if (this.touchDevice)
                    return true;

                if ($.jqx.browser.msie && $.jqx.browser.version < 9)
                    return false;

                this.touchDevice = true;
                isTouchDevice = true;
                $.jqx.mobile.setMobileSimulator(this.element);
            }
            else if (this.touchMode == false) {
                isTouchDevice = false;
            }
            if (isTouchDevice && this.touchModeStyle != false) {
                this.scrollBarSize = $.jqx.utilities.touchScrollBarSize;
            }
            if (isTouchDevice) {
                this.host.addClass(this.toThemeProperty('jqx-touch'));
            }

            return isTouchDevice;
        },

        beginUpdate: function () {
            this.updatingListBox = true;
        },

        endUpdate: function () {
            this.updatingListBox = false;
            this._addItems();
            this._renderItems();
        },

        beginUpdateLayout: function () {
            this.updating = true;
        },

        resumeUpdateLayout: function () {
            this.updating = false;
            this.vScrollInstance.value = 0;
            this._render(false);
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (this.isInitialized == undefined || this.isInitialized == false)
                return;

            if (key == "itemHeight") {
                object.refresh();
            }

            if (key == 'source' || key == 'checkboxes') {
                if (value == null && oldvalue && oldvalue.unbindBindingUpdate) {
                    oldvalue.unbindBindingUpdate(object.element.id);
                    oldvalue.unbindDownloadComplete(object.element.id);
                }

                object.clearSelection();
                object.refresh();
            }

            if (key == 'scrollBarSize' || key == 'equalItemsWidth') {
                if (value != oldvalue) {
                    object._updatescrollbars();
                }
            }

            if (key == 'disabled') {
                object._renderItems();
                object.vScrollBar.jqxScrollBar({ disabled: value });
                object.hScrollBar.jqxScrollBar({ disabled: value });
            }

            if (key == "touchMode" || key == "rtl") {
                object._removeHandlers();
                object.vScrollBar.jqxScrollBar({ touchMode: value });
                object.hScrollBar.jqxScrollBar({ touchMode: value });
                if (key == "touchMode") {
                    if (!($.jqx.browser.msie && $.jqx.browser.version < 9)) {
                        var overlayContent = $("<div class='overlay' style='z-index: 99; -webkit-appearance: none; border: none; background: black; opacity: 0.01; outline: none; border: none; padding: 0px; overflow: hidden; margin: 0px; align:left; valign:top; left: 0px; top: 0px; position: absolute;'></div>");
                        object.content.parent().append(overlayContent);
                        object.overlayContent = object.host.find('.overlay');
                    }
                }
                object._updateTouchScrolling();
                object._addHandlers();
                object._render(false);
            }

            if (!this.updating) {
                if (key == "width" || key == "height") {
                    object._updateSize();
                }
            }

            if (key == 'theme') {
                if (oldvalue != value) {
                    object.hScrollBar.jqxScrollBar({ theme: object.theme });
                    object.vScrollBar.jqxScrollBar({ theme: object.theme });
                    object.host.removeClass();
                    object.host.addClass(object.toThemeProperty("jqx-listbox"));
                    object.host.addClass(object.toThemeProperty("jqx-widget"));
                    object.host.addClass(object.toThemeProperty("jqx-widget-content"));
                    object.host.addClass(object.toThemeProperty("jqx-reset"));
                    object.host.addClass(object.toThemeProperty("jqx-rc-all"));
                    object.refresh();
                }
            }

            if (key == 'selectedIndex') {
                object.clearSelection();
                object.selectIndex(value, true);
            }

            if (key == "displayMember" || key == "valueMember") {
                if (oldvalue != value) {
                    var oldSelectedIndex = object.selectedIndex;
                    object.refresh();
                    object.selectedIndex = oldSelectedIndex;
                    object.selectedIndexes[oldSelectedIndex] = oldSelectedIndex;
                }
                object._renderItems();
            }

            if (key == 'autoHeight') {
                if (oldvalue != value) {
                    object._render(false);
                }
                else {
                    object._updatescrollbars();
                    object._renderItems();
                }
            }
        },

        loadFromSelect: function (id) {
            if (id == null)
                return;

            var searchElementId = '#' + id;
            var selectElement = $(searchElementId);
            if (selectElement.length > 0) {
                var options = selectElement.find('option');
                var groups = selectElement.find('optgroup');
                var index = 0;
                var selectedOption = -1;
                var optionItems = new Array();

                $.each(options, function () {
                    var hasGroup = groups.find(this).length > 0;
                    var group = null;

                    if (this.text != this.value && (this.label == null || this.label == '')) {
                        this.label = this.text;
                    }

                    var item = { disabled: this.disabled, value: this.value, label: this.label, title: this.title, originalItem: this };

                    var ie7 = $.jqx.browser.msie && $.jqx.browser.version < 8;
                    if (ie7) {
                        if (item.value == '' && this.text != null && this.text.length > 0) {
                            item.value = this.text;
                        }
                    }

                    if (hasGroup) {
                        group = groups.find(this).parent()[0].label;
                        item.group = group;
                    }

                    if (this.selected) selectedOption = index;
                    optionItems[index] = item;
                    index++;
                });

                this.source = optionItems;
                this.fromSelect = true;
                this.clearSelection();
                this.selectedIndex = selectedOption;
                this.selectedIndexes[this.selectedIndex] = this.selectedIndex;
                this.refresh();
            }
        },

        invalidate: function () {
            this._cachedItemHtml = [];
            this._renderItems();
            this.virtualSize = null;
            this._updateSize();
        },

        refresh: function (initialRefresh) {
            var me = this;
            if (this.vScrollBar == undefined) {
                return;
            }
            this._cachedItemHtml = [];
            this.visibleItems = new Array();
            var selectInitialItem = function (initialRefresh) {
                if (initialRefresh == true) {
                    if (me.selectedIndex != -1) {
                        var tmpIndex = me.selectedIndex;
                        me.selectedIndex = -1;
                        me._stopEvents = true;
                        me.selectIndex(tmpIndex, false, true);
                        if (me.selectedIndex == -1) {
                            me.selectedIndex = tmpIndex;
                        }
                        me._stopEvents = false;
                    }
                }
            }
            if (this.itemswrapper != null) {
                this.itemswrapper.remove();
                this.itemswrapper = null;
            }
            if ($.jqx.dataAdapter && this.source != null && this.source._source) {
                this.databind(this.source);
                selectInitialItem(initialRefresh);
                return;
            }
            this.items = this.loadItems(this.source);
            this._raiseEvent('6');

            this._render(false, initialRefresh == true);
            selectInitialItem(initialRefresh);
        },

        _render: function (ensurevisible, initialRefresh) {
            this._addItems();
            this._renderItems();
            this.vScrollInstance.setPosition(0);
            this._cachedItemHtml = new Array();
            if (ensurevisible == undefined || ensurevisible) {
                if (this.items != undefined && this.items != null) {
                    if (this.selectedIndex >= 0 && this.selectedIndex < this.items.length) {
                        this.selectIndex(this.selectedIndex, true, true, true);
                    }
                }
            }

            if (this.allowDrag && this._enableDragDrop) {
                this._enableDragDrop();
                if (this.isTouchDevice()) {
                    this._removeHandlers();
                    if (this.overlayContent) {
                        this.overlayContent.remove();
                        this.overlayContent = null;
                    }
                    this._updateTouchScrolling();
                    this._addHandlers();
                    return;
                }
            }
            this._updateTouchScrolling();
            if (this.rendered) {
                this.rendered();
            }
            if (this.ready) {
                this.ready();
            }
        },

        _hitTest: function (hitLeft, hitTop) {
            var top = parseInt(this.vScrollInstance.value);
            var firstIndex = this._searchFirstVisibleIndex(hitTop + top, this.renderedVisibleItems)
            if (this.renderedVisibleItems[firstIndex] != undefined && this.renderedVisibleItems[firstIndex].isGroup)
                return null;

            if (this.renderedVisibleItems.length > 0) {
                var lastItem = this.renderedVisibleItems[this.renderedVisibleItems.length - 1];
                if (lastItem.height + lastItem.top < hitTop + top) {
                    return null;
                }
            }

            firstIndex = this._searchFirstVisibleIndex(hitTop + top)
            return this.visibleItems[firstIndex];

            return null;
        },

        _searchFirstVisibleIndex: function (value, collection) {
            if (value == undefined) {
                value = parseInt(this.vScrollInstance.value);
            }
            var min = 0;
            if (collection == undefined || collection == null) {
                collection = this.visibleItems;
            }

            var max = collection.length;
            while (min <= max) {
                mid = parseInt((min + max) / 2)
                var item = collection[mid];
                if (item == undefined)
                    break;

                if (item.initialTop > value && item.initialTop + item.height > value) {
                    max = mid - 1;
                } else if (item.initialTop < value && item.initialTop + item.height <= value) {
                    min = mid + 1;
                } else {
                    return mid;
                    break;
                }
            }

            return 0;
        },

        _renderItems: function () {
            if (this.items == undefined || this.items.length == 0) {
                this.visibleItems = new Array();
                return;
            }

            if (this.updatingListBox == true)
                return;

            var touchDevice = this.isTouchDevice();
            var vScrollInstance = this.vScrollInstance;
            var hScrollInstance = this.hScrollInstance;
            var top = parseInt(vScrollInstance.value);
            var left = parseInt(hScrollInstance.value);
            if (this.rtl) {
                if (this.hScrollBar[0].style.visibility != 'hidden') {
                    left = hScrollInstance.max - left;
                }
            }

            var itemsLength = this.items.length;
            var hostWidth = this.host.width();
            var contentWidth = parseInt(this.content[0].style.width);
            var width = contentWidth + parseInt(hScrollInstance.max);
            var vScrollBarWidth = parseInt(this.vScrollBar[0].style.width) + 2;
            if (this.vScrollBar[0].style.visibility == 'hidden') {
                vScrollBarWidth = 0;
            }

            if (this.hScrollBar[0].style.visibility != 'visible') {
                width = contentWidth;
            }
            var virtualItemsCount = this._getVirtualItemsCount();
            var renderCollection = new Array();
            var y = 0;
            var hostHeight = parseInt(this.element.style.height) + 2;
            if (this.element.style.height.indexOf('%') != -1) {
                hostHeight = this.host.outerHeight();
            }

            if (isNaN(hostHeight)) {
                hostHeight = 0;
            }
            var maxWidth = 0;
            var visibleIndex = 0;
            var renderIndex = 0;

            if (vScrollInstance.value == 0 || this.visibleItems.length == 0) {
                for (var indx = 0; indx < this.items.length; indx++) {
                    var item = this.items[indx];
                    if (item.visible) {
                        item.top = -top;
                        item.initialTop = -top;
                        if (!item.isGroup && item.visible) {
                            this.visibleItems[visibleIndex++] = item;
                            item.visibleIndex = visibleIndex - 1;
                        }

                        this.renderedVisibleItems[renderIndex++] = item;

                        item.left = -left;
                        var bottom = item.top + item.height;
                        if (bottom >= 0 && item.top - item.height <= hostHeight) {
                            renderCollection[y++] = { index: indx, item: item };
                        }

                        top -= item.height;
                    }
                }
            }
            var firstIndex = top > 0 ? this._searchFirstVisibleIndex(this.vScrollInstance.value, this.renderedVisibleItems) : 0;
            var initialHeight = 0;
            y = 0;
            var scrollValue = this.vScrollInstance.value;
            var iterations = 0;
            while (initialHeight < 100 + hostHeight) {
                var item = this.renderedVisibleItems[firstIndex];
                if (item == undefined)
                    break;
                if (item.visible) {
                    item.left = -left;
                    var bottom = item.top + item.height - scrollValue;
                    if (bottom >= 0 && item.initialTop - scrollValue - item.height <= 2 * hostHeight) {
                        renderCollection[y++] = { index: firstIndex, item: item };
                    }
                }

                firstIndex++;
                if (item.visible) {
                    initialHeight += item.initialTop - scrollValue + item.height - initialHeight;
                }
                iterations++;
                if (iterations > this.items.length - 1)
                    break;
            }

            var listItemNormalClass = this.toThemeProperty('jqx-listitem-state-normal') + ' ' + this.toThemeProperty('jqx-item');
            var listItemGroupClass = this.toThemeProperty('jqx-listitem-state-group');
            var listItemDisabledClass = this.toThemeProperty('jqx-listitem-state-disabled') + ' ' + this.toThemeProperty('jqx-fill-state-disabled');
            var middle = 0;
            var me = this;
            for (var indx = 0; indx < this.visualItems.length; indx++) {
                var itemElement = this.visualItems[indx];
                var hideItem = function () {
                    var spanElement = itemElement[0].firstChild; // itemElement.find('#spanElement');
                    if (me.checkboxes) {
                        spanElement = itemElement[0].lastChild;
                    }

                    if (spanElement != null) {
                        spanElement.style.visibility = 'hidden';
                        spanElement.className = "";
                    }

                    if (me.checkboxes && me.host.jqxCheckBox) {
                        var checkbox = itemElement.find('.chkbox');
                        checkbox.css({ 'visibility': 'hidden' });
                    }
                }

                if (indx < renderCollection.length) {
                    var item = renderCollection[indx].item;
                    if (item.initialTop - scrollValue >= hostHeight) {
                        hideItem();
                        continue;
                    }

                    var spanElement = $(itemElement[0].firstChild); // itemElement.find('#spanElement');
                    if (this.checkboxes) {
                        spanElement = $(itemElement[0].lastChild);
                    }

                    if (spanElement.length == 0)
                        continue;

                    if (spanElement[0] == null) continue;
                    spanElement[0].className = "";
                    spanElement[0].style.display = "block";
                    spanElement[0].style.visibility = "inherit";
                    var classNameBuilder = "";
                    //                    spanElement.css({ 'display': 'block', 'visibility': 'inherit' });

                    if (!item.isGroup && !this.selectedIndexes[item.index] >= 0) {
                        classNameBuilder = listItemNormalClass;
                        //spanElement.addClass(listItemNormalClass);
                    }
                    else {
                        classNameBuilder = listItemGroupClass;
                        //spanElement.addClass(listItemGroupClass);
                    }

                    if (item.disabled || this.disabled) {
                        classNameBuilder += " " + listItemDisabledClass;
                        //spanElement.addClass(listItemDisabledClass);
                    }

                    if (this.roundedcorners) {
                        classNameBuilder += " " + this.toThemeProperty('jqx-rc-all');
                        //spanElement.addClass(this.toThemeProperty('jqx-rc-all'));
                    }
                    if (touchDevice) {
                        classNameBuilder += " " + this.toThemeProperty('jqx-listitem-state-normal-touch');
                    }

                    spanElement[0].className = classNameBuilder;

                    if (this.renderer) {
                        if (!item.key) item.key = this.generatekey();
                        if (!this._cachedItemHtml) this._cachedItemHtml = new Array();
                        if (this._cachedItemHtml[item.key]) {
                            if (spanElement[0].innerHTML != this._cachedItemHtml[item.key]) {
                                spanElement[0].innerHTML = this._cachedItemHtml[item.key];
                            }
                        }
                        else {
                            var html = this.renderer(item.index, item.label, item.value);
                            spanElement[0].innerHTML = html;
                            this._cachedItemHtml[item.key] = spanElement[0].innerHTML;
                        }

                    }
                    else {
                        if (this.itemHeight !== -1) {
                            var paddingAndBorder = 2 + 2*parseInt(spanElement.css('padding-top'));
                            spanElement[0].style.lineHeight = (item.height - paddingAndBorder) + 'px';
                            spanElement.css('vertical-align', 'middle');
                        }

                        if (item.html != null && item.html.toString().length > 0) {
                            spanElement[0].innerHTML = item.html;
                        }
                        else if (item.label != null || item.value != null) {
                            if (item.label != null) {
                                if (spanElement[0].innerHTML !== item.label) {
                                    spanElement[0].innerHTML = item.label;
                                }
                                if (item.label == "") {
                                    spanElement[0].innerHTML = this.emptyString;
                                    if (this.emptyString == "") {
                                        spanElement[0].style.height = (item.height - 8) + 'px';
                                    }
                                }
                                if (!this.incrementalSearch && !item.disabled) {
                                    if (this.searchString != undefined && this.searchString != "") {
                                        spanElement[0].innerHTML = this._highlight(item.label, this.searchString);
                                    }
                                }
                            }
                            else if (item.label === null) {
                                spanElement[0].innerHTML = this.emptyString;
                                if (this.emptyString == "") {
                                    spanElement[0].style.height = (item.height - 8) + 'px';
                                }
                            }
                            else {
                                if (spanElement[0].innerHTML !== item.value) {
                                    spanElement[0].innerHTML = item.value;
                                }
                                else if (item.label == "") {
                                    spanElement[0].innerHTML = " ";
                                }
                            }
                        }
                        else if (item.label == "" || item.label == null) {
                            spanElement[0].innerHTML = "";
                            spanElement[0].style.height = (item.height - 8) + 'px';
                        }
                    }

                    itemElement[0].style.left = item.left + 'px';
                    itemElement[0].style.top = item.initialTop - scrollValue + 'px';

                    item.element = spanElement[0];
                    //  $.data(spanElement[0], 'item', item);
                    if (item.title) {
                        spanElement[0].title = item.title;
                    }

                    if (this.equalItemsWidth && !item.isGroup) {
                        if (maxWidth == 0) {
                            var itemWidth = parseInt(width);
                            var diff = parseInt(spanElement.outerWidth()) - parseInt(spanElement.width());
                            itemWidth -= diff;
                            var borderSize = 1;
                            if (borderSize != null) {
                                borderSize = parseInt(borderSize);
                            }
                            else borderSize = 0;
                            itemWidth -= 2 * borderSize;
                            maxWidth = itemWidth;
                            if (this.checkboxes && this.host.jqxCheckBox && this.hScrollBar[0].style.visibility == 'hidden') {
                                maxWidth -= 18;
                            }
                        }
                        if (contentWidth > this.virtualSize.width) {
                            spanElement[0].style.width = maxWidth + 'px';
                            item.width = maxWidth;
                        }
                        else {
                            spanElement[0].style.width = -4 + this.virtualSize.width + 'px';
                            item.width = this.virtualSize.width - 4;
                        }
                    }
                    else {
                        if (spanElement.width() < this.host.width()) {
                            spanElement.width(this.host.width() - 2);
                        }
                    }

                    if (this.rtl) {
                        spanElement[0].style.textAlign = 'right';
                    }

                    if (this.autoItemsHeight) {
                        spanElement[0].style.whiteSpace = 'normal';
                        spanElement.width(maxWidth);
                        item.width = maxWidth;
                    }
                    middle = 0;
                    if (this.checkboxes && this.host.jqxCheckBox && !item.isGroup) {
                        if (middle == 0) {
                            middle = (item.height - 16) / 2;
                            middle++;
                        }
                        var checkbox = $(itemElement.children()[0]);
                        checkbox[0].item = item;

                        if (!this.rtl) {
                            if (spanElement[0].style.left != '18px') {
                                spanElement[0].style.left = '18px';
                            }
                        }
                        else {
                            if (spanElement[0].style.left != '0px') {
                                spanElement[0].style.left = '0px';
                            }
                        }
                        if (this.rtl) {
                            checkbox.css('left', 8 + item.width + 'px');
                        }
                        checkbox.css('top', middle + 'px');
                        checkbox.css({ 'display': 'block', 'visibility': 'inherit' });
                        var checked = false;

                        if (checkbox.data().jqxCheckBox) {
                            var checkBoxInstance = checkbox.data().jqxCheckBox.instance;
                            var checked = checkBoxInstance.checked;
                        }
                        if ($.jqx.ariaEnabled) {
                            if (checked) {
                                itemElement[0].setAttribute('aria-selected', true);
                            }
                            else {
                                itemElement[0].removeAttribute('aria-selected');
                            }
                        }
                        if (checkBoxInstance) {
                            if (checked != item.checked) {
                                checkBoxInstance._setState(item.checked);
                                if (item.disabled != checkBoxInstance.disabled) {
                                    checkbox.jqxCheckBox({ disabled: item.disabled });
                                }
                            }
                            else {
                                if (item.disabled != checkBoxInstance.disabled) {
                                    checkbox.jqxCheckBox({ disabled: item.disabled });
                                }
                            }
                            if ((this.disabled || item.disabled) != checkBoxInstance.disabled) {
                                checkbox.jqxCheckBox({ disabled: this.disabled || item.disabled});
                            }
                        }
                    }
                    else if (this.checkboxes && this.host.jqxCheckBox) {
                        var checkbox = $(itemElement.children()[0]);
                        checkbox.css({ 'display': 'none', 'visibility': 'inherit' });
                    }

                    if (this.selectedIndexes[item.visibleIndex] >= 0 && !item.disabled) {
                        spanElement.addClass(this.toThemeProperty('jqx-listitem-state-selected'));
                        spanElement.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
                        if ($.jqx.ariaEnabled) {
                            itemElement[0].setAttribute('aria-selected', true);
                            this._activeElement = itemElement[0];
                        }
                    }
                    else if (!this.checkboxes) {
                        if ($.jqx.ariaEnabled) {
                            itemElement[0].removeAttribute('aria-selected');
                        }
                    }
                }
                else {
                    hideItem();
                }
            }
        },

        generatekey: function () {
            var S4 = function () {
                return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
            };
            return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
        },

        _calculateVirtualSize: function () {
            var width = 0;
            var height = 2;
            var currentItem = 0;
            var spanElement = $("<span></span>");
            if (this.equalItemsWidth) {
                spanElement.css('float', 'left');
            }
            var itemsPerPage = 0;
            var hostHeight = this.host.outerHeight();

            $(document.body).append(spanElement);
            var length = this.items.length;
            var w = this.host.width();
            if (this.autoItemsHeight) {
                w -= 10;
                if (this.vScrollBar.css('visibility') != 'hidden') w -= 20;
            }

            if (this.autoItemsHeight || this.renderer || this.groups.length > 1 || (length > 0 && this.items[0].html != null && this.items[0].html != "")) {
                for (var currentItem = 0; currentItem < length; currentItem++) {
                    var item = this.items[currentItem];

                    if (item.isGroup && (item.label == '' && item.html == '')) {
                        continue;
                    }

                    if (!item.visible)
                        continue;

                    var className = "";

                    if (!item.isGroup) {
                        className += this.toThemeProperty('jqx-listitem-state-normal jqx-rc-all');
                    }
                    else {
                        className += this.toThemeProperty('jqx-listitem-state-group jqx-rc-all');
                    }
                    className += " " + this.toThemeProperty('jqx-fill-state-normal');
                    if (this.isTouchDevice()) {
                        className += " " + this.toThemeProperty('jqx-touch');
                    }
                    spanElement[0].className = className;
                    if (this.autoItemsHeight) {
                        spanElement[0].style.whiteSpace = 'normal';
                        var checkWidth = this.checkboxes ? -20 : 0;
                        spanElement[0].style.width = (checkWidth + w) + 'px';
                    }

                    if (this.renderer) {
                        var html = this.renderer(item.index, item.label, item.value);
                        spanElement[0].innerHTML = html;
                    }
                    else {
                        if (item.html != null && item.html.toString().length > 0) {
                            spanElement[0].innerHTML = item.html;
                        }
                        else if (item.label != null || item.value != null) {
                            if (item.label != null) {
                                spanElement[0].innerHTML = item.label;
                                if (item.label == "") spanElement[0].innerHTML = "Empty";
                            }
                            else spanElement[0].innerHTML = item.value;
                        }
                    }

                    var spanHeight = spanElement.outerHeight();
                    var spanWidth = spanElement.outerWidth();

                    if (this.itemHeight > -1) {
                        spanHeight = this.itemHeight;
                    }

                    item.height = spanHeight;
                    item.width = spanWidth;
                    height += spanHeight;
                    width = Math.max(width, spanWidth);

                    if (height <= hostHeight) {
                        itemsPerPage++;
                    }
                }
            }
            else {
                var height = 0;
                var elementHeight = 0;
                var maxText = "";
                var maxTextLength = 0;
                var oldMaxTextLength = 0;
                var firstvisibleitem = -1;
                for (var currentItem = 0; currentItem < length; currentItem++) {
                    var item = this.items[currentItem];

                    if (item.isGroup && (item.label == '' && item.html == '')) {
                        continue;
                    }

                    if (!item.visible)
                        continue;
                    firstvisibleitem++;
                    var className = "";
                    if (firstvisibleitem == 0) {
                        className += this.toThemeProperty('jqx-listitem-state-normal jqx-rc-all');
                        className += " " + this.toThemeProperty('jqx-fill-state-normal');
                        className += " " + this.toThemeProperty('jqx-widget');
                        className += " " + this.toThemeProperty('jqx-listbox');
                        className += " " + this.toThemeProperty('jqx-widget-content');

                        if (this.isTouchDevice()) {
                            className += " " + this.toThemeProperty('jqx-touch');
                            className += " " + this.toThemeProperty('jqx-listitem-state-normal-touch');
                        }
                        spanElement[0].className = className;
                        if (this.autoItemsHeight) {
                            spanElement[0].style.whiteSpace = 'normal';
                            var checkWidth = this.checkboxes ? -20 : 0;
                            spanElement[0].style.width = (checkWidth + w) + 'px';
                        }

                        if (item.html == null || (item.label == "" || item.label == null)) {
                            spanElement[0].innerHTML = "Item";
                        }
                        else {
                            if (item.html != null && item.html.toString().length > 0) {
                                spanElement[0].innerHTML = item.html;
                            }
                            else if (item.label != null || item.value != null) {
                                if (item.label != null) {
                                    spanElement[0].innerHTML = item.label;
                                }
                                else spanElement[0].innerHTML = item.value;
                            }
                        }

                        var spanHeight = spanElement.outerHeight();

                        if (this.itemHeight > -1) {
                            spanHeight = this.itemHeight;
                        }
                        elementHeight = spanHeight;
                    }

                    if (maxTextLength != undefined) {
                        oldMaxTextLength = maxTextLength;
                    }

                    if (item.html != null && item.html.toString().length > 0) {
                        maxTextLength = Math.max(maxTextLength, item.html.toString().length);
                        if (oldMaxTextLength != maxTextLength) {
                            maxText = item.html;
                        }
                    }
                    else if (item.label != null) {
                        maxTextLength = Math.max(maxTextLength, item.label.length);
                        if (oldMaxTextLength != maxTextLength) {
                            maxText = item.label;
                        }
                    }
                    else if (item.value != null) {
                        maxTextLength = Math.max(maxTextLength, item.value.length);
                        if (oldMaxTextLength != maxTextLength) {
                            maxText = item.value;
                        }
                    }

                    item.height = elementHeight;
                    height += elementHeight;

                    if (height <= hostHeight) {
                        itemsPerPage++;
                    }
                }
                spanElement[0].innerHTML = maxText;
                width = spanElement.outerWidth();
            }

            height += 2;
            if (itemsPerPage < 10) itemsPerPage = 10;

            spanElement.remove();
            return { width: width, height: height, itemsPerPage: itemsPerPage };
        },

        _getVirtualItemsCount: function () {
            if (this.virtualItemsCount == 0) {
                var virtualItemsCount = parseInt(this.host.height()) / 5;
                if (virtualItemsCount > this.items.length) {
                    virtualItemsCount = this.items.length;
                }
                return virtualItemsCount;
            }
            else return this.virtualItemsCount;
        },

        _addItems: function (refreshUIItems) {
            if (this.updatingListBox == true)
                return;

            if (this.items == undefined || this.items.length == 0) {
                this.virtualSize = { width: 0, height: 0, itemsPerPage: 0 };
                this._updatescrollbars();
                this.renderedVisibleItems = new Array();
                if (this.itemswrapper) {
                    this.itemswrapper.children().remove();
                }
                return;
            }

            if (refreshUIItems == false) {
                var virtualSize = this._calculateVirtualSize();
                var virtualItemsCount = virtualSize.itemsPerPage * 2;
                if (this.autoHeight) {
                    virtualItemsCount = this.items.length;
                }

                this.virtualItemsCount = Math.min(virtualItemsCount, this.items.length);
                var me = this;
                var virtualWidth = virtualSize.width;
                this.virtualSize = virtualSize;
                this._updatescrollbars();
                return;
            }
            var self = this;
            var top = 0;
            this.visibleItems = new Array();
            this.renderedVisibleItems = new Array();
            this._removeHandlers();
            if (this.allowDrag && this._enableDragDrop) {
                this.itemswrapper = null;
            }
            if (this.itemswrapper == null) {
                this.content[0].innerHTML = '';
                this.itemswrapper = $('<div style="outline: 0 none; overflow:hidden; width:100%; position: relative;"></div>');
                this.itemswrapper.height(2 * this.host.height());
                this.content.append(this.itemswrapper);
            }

            var virtualSize = this._calculateVirtualSize();
            var virtualItemsCount = virtualSize.itemsPerPage * 2;
            if (this.autoHeight) {
                virtualItemsCount = this.items.length;
            }

            this.virtualItemsCount = Math.min(virtualItemsCount, this.items.length);
            var me = this;
            var virtualWidth = virtualSize.width;
            this.virtualSize = virtualSize;
            this.itemswrapper.width(Math.max(this.host.width(), 17 + virtualSize.width));
            var startIndex = 0;

            var html = "";
            for (var virtualItemIndex = startIndex; virtualItemIndex < this.virtualItemsCount; virtualItemIndex++) {
                var item = this.items[virtualItemIndex];
                var id = 'listitem' + virtualItemIndex + this.element.id;
                html += "<div role='option' id='" + id + "' class='jqx-listitem-element'>";
                if (this.checkboxes && this.host.jqxCheckBox) {
                    html += '<div style="background-color: transparent; padding: 0; margin: 0; position: absolute; float: left; width: 16px; height: 16px;" class="chkbox"></div>';
                }
                html += "<span style='-ms-touch-action: none;'></span></div>"
            }

            if (self.WinJS) {
                MSApp.execUnsafeLocalFunction(function () {
                    WinJS.Utilities.setInnerHTMLUnsafe(this.itemswrapper[0], html);
                });
            }
            else {
                this.itemswrapper[0].innerHTML = html;
            }

            var children = this.itemswrapper.children();
            for (var virtualItemIndex = startIndex; virtualItemIndex < this.virtualItemsCount; virtualItemIndex++) {
                var item = this.items[virtualItemIndex];
                var itemElement = $(children[virtualItemIndex]);

                if (this.allowDrag && this._enableDragDrop) {
                    itemElement.addClass('draggable');
                }

                if (this.checkboxes && this.host.jqxCheckBox) {
                    var checkbox = $(itemElement.children()[0]);
                    itemElement.css('float', 'left');
                    var spanElement = $(itemElement[0].firstChild);
                    spanElement.css('float', 'left');
                 //   itemElement.prepend(checkbox);
                    checkbox.jqxCheckBox({ locked: true, disabledContainer: true, hasInput: false, checked: item.checked, animationShowDelay: 0, animationHideDelay: 0, disabled: item.disabled, enableContainerClick: false, keyboardCheck: false, hasThreeStates: this.hasThreeStates, theme: this.theme });
                    item.checkBoxElement = checkbox[0];
                    item.checkBoxInstance = checkbox.data().jqxCheckBox.instance;
                    var updated = function (event, checked) {
                        var checkItem = event.owner.element.item;
                        if (checkItem != null) {
                            var args = event.args;
                            if (checked) {
                                me.checkIndex(checkItem.index, true);
                            }
                            else if (checkItem.checked == false) {
                                me.uncheckIndex(checkItem.index, true);
                            }
                            else {
                                if (checkItem.hasThreeStates && me.hasThreeStates) {
                                    if (checked == false) {
                                        me.uncheckIndex(checkItem.index, true);
                                    }
                                    else {
                                        me.indeterminateIndex(checkItem.index, true);
                                    }
                                }
                                else {
                                    me.uncheckIndex(checkItem.index, true);
                                }
                            }
                        }
                        me.focused = true;
                    }
                    item.checkBoxInstance.updated = updated;
                }

                itemElement[0].style.height = item.height + 'px';
                itemElement[0].style.top = top + 'px';

                top += item.height;
                this.visualItems[virtualItemIndex] = itemElement;
            };

            this._addHandlers();

            this._updatescrollbars();

            if (this.autoItemsHeight) {
                var virtualSize = this._calculateVirtualSize();
                var virtualItemsCount = virtualSize.itemsPerPage * 2;
                if (this.autoHeight) {
                    virtualItemsCount = this.items.length;
                }

                this.virtualItemsCount = Math.min(virtualItemsCount, this.items.length);
                var me = this;
                var virtualWidth = virtualSize.width;
                this.virtualSize = virtualSize;
                this._updatescrollbars();
            }

            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                this.host.attr('hideFocus', true);
                this.host.find('div').attr('hideFocus', true);
            }
        },

        _updatescrollbars: function () {
            if (!this.virtualSize) {
                return;
            }
            var virtualHeight = this.virtualSize.height;
            var virtualWidth = this.virtualSize.width;
            var vScrollInstance = this.vScrollInstance;
            var hScrollInstance = this.hScrollInstance;
            this._arrange(false);
            var hasChange = false;
            var outerWidth = this.host.outerWidth();
            if (virtualHeight > this.host.outerHeight()) {
                var hScrollOffset = 0; //parseInt(this.hScrollBar.height());
                if (virtualWidth > outerWidth) {
                    hScrollOffset = this.hScrollBar.outerHeight() + 2;
                }

                var oldmax = vScrollInstance.max;
                vScrollInstance.max = 2 + parseInt(virtualHeight) + hScrollOffset - parseInt(this.host.height());
                if (this.vScrollBar[0].style.visibility != 'inherit') {
                    this.vScrollBar[0].style.visibility = 'inherit';
                    hasChange = true;
                }
                if (oldmax != vScrollInstance.max) {
                    vScrollInstance._arrange();
                }
            }
            else {
                if (this.vScrollBar[0].style.visibility != 'hidden') {
                    this.vScrollBar[0].style.visibility = 'hidden';
                    hasChange = true;
                    vScrollInstance.setPosition(0);
                }
            }

            var scrollOffset = 0;
            if (this.vScrollBar[0].style.visibility != 'hidden') {
                scrollOffset = this.scrollBarSize + 6;
            }

            var checkboxes = this.checkboxes ? 20 : 0;

            if (this.autoItemsHeight) {
                this.hScrollBar[0].style.visibility = 'hidden';
            }
            else {
                if (virtualWidth >= outerWidth - scrollOffset - checkboxes) {
                    var changedMax = hScrollInstance.max;
                    if (this.vScrollBar[0].style.visibility == 'inherit') {
                        hScrollInstance.max = checkboxes + scrollOffset + parseInt(virtualWidth) - this.host.width() + 4;
                    }
                    else {
                        hScrollInstance.max = checkboxes + parseInt(virtualWidth) - this.host.width() + 6;
                    }

                    if (this.hScrollBar[0].style.visibility != 'inherit') {
                        this.hScrollBar[0].style.visibility = 'inherit';
                        hasChange = true;
                    }
                    if (changedMax != hScrollInstance.max) {
                        hScrollInstance._arrange();
                    }
                    if (this.vScrollBar[0].style.visibility == 'inherit') {
                        vScrollInstance.max = 2 + parseInt(virtualHeight) + this.hScrollBar.outerHeight() + 2 - parseInt(this.host.height());
                    }
                }
                else {
                    if (this.hScrollBar[0].style.visibility != 'hidden') {
                        this.hScrollBar[0].style.visibility = 'hidden';
                        hasChange = true;
                    }
                }
            }

            hScrollInstance.setPosition(0);

            if (hasChange) {
                this._arrange();
            }

            if (this.itemswrapper) {
                this.itemswrapper.width(Math.max(this.host.width(), 17 + virtualWidth));
                this.itemswrapper.height(2 * this.host.height());
            }

            var isTouchDevice = this.isTouchDevice();
            if (isTouchDevice) {
                if (this.vScrollBar.css('visibility') != 'visible' && this.hScrollBar.css('visibility') != 'visible') {
                    $.jqx.mobile.setTouchScroll(false, this.element.id);
                }
                else {
                    $.jqx.mobile.setTouchScroll(true, this.element.id);
                }
            }
        },

        clear: function () {
            this.source = null;
            this.clearSelection();
            this.refresh();
        },

        // clears the selection.
        clearSelection: function (render) {
            for (var indx = 0; indx < this.selectedIndexes.length; indx++) {
                if (this.selectedIndexes[indx] && this.selectedIndexes[indx] != -1) {
                    this._raiseEvent('1', { index: indx, type: 'api', item: this.getVisibleItem(indx), originalEvent: null });
                }

                this.selectedIndexes[indx] = -1;
            }
            this.selectedIndex = -1;
            if (render != false) {
                this._renderItems();
            }
        },

        // unselects item by index.
        unselectIndex: function (index, render) {
            if (isNaN(index))
                return;

            this.selectedIndexes[index] = -1;
            var hasIndexes = false;
            for (var indx = 0; indx < this.selectedIndexes.length; indx++) {
                var index = this.selectedIndexes[indx];
                if (index != -1 && index != undefined) {
                    hasIndexes = true;
                }
            }
            if (!hasIndexes) {
                this.selectedValue = null;
                this.selectedIndex = -1;
            }

            if (render == undefined || render == true) {
                this._renderItems();
                this._raiseEvent('1', { index: index, type: 'api', item: this.getVisibleItem(index), originalEvent: null });
            }
            this._updateInputSelection();

            this._raiseEvent('2', { index: index, type:'api', item: this.getItem(index) });
        },

        // gets item's instance.
        getItem: function (index) {
            if (index == -1 || isNaN(index) || typeof (index) === "string") {
                if (index === -1) {
                    return null;
                }
                return this.getItemByValue(index);
            }

            var result = null;
            var item = $.each(this.items, function () {
                if (this.index == index) {
                    result = this;
                    return false;
                }
            });

            return result;
        },

        getVisibleItem: function (index) {
            if (index == -1 || isNaN(index) || typeof (index) === "string") {
                if (index === -1) {
                    return null;
                }
                return this.getItemByValue(index);
            }
            return this.visibleItems[index];
        },

        getVisibleItems: function () {
            return this.visibleItems;
        },

        // checks a specific item by its index.
        checkIndex: function (index, render, raiseEvent) {
            if (!this.checkboxes || !this.host.jqxCheckBox) {
                return;
            }

            if (isNaN(index))
                return;

            if (index < 0 || index >= this.visibleItems.length)
                return;

            if (this.visibleItems[index] != null && this.visibleItems[index].disabled) {
                return;
            }

            if (this.disabled)
                return;

            var item = this.getItem(index);
            if (this.groups.length > 0) {
                var item = this.getVisibleItem(index);
            }
            if (item != null) {
                var checkbox = $(item.checkBoxElement);
                item.checked = true;
                if (render == undefined || render == true) {
                    this._updateCheckedItems();
                }
            }

            if (raiseEvent == undefined || raiseEvent == true) {
                this._raiseEvent(3, { label: item.label, value: item.value, checked: true, item: item });
            }
        },

        getCheckedItems: function () {
            if (!this.checkboxes || !this.host.jqxCheckBox) {
                return null;
            }

            var checkedItems = new Array();
            if (this.items == undefined) return;

            $.each(this.items, function () {
                if (this.checked) {
                    checkedItems[checkedItems.length] = this;
                }
            });
            return checkedItems;
        },

        checkAll: function (raiseEvents) {
            if (!this.checkboxes || !this.host.jqxCheckBox) {
                return;
            }

            if (this.disabled)
                return;

            var me = this;
            $.each(this.items, function () {
                var item = this;
                if (raiseEvents !== false && item.checked !== true) {
                     me._raiseEvent(3, { label: item.label, value: item.value, checked: true, item: item });
                }
                this.checked = true;
            });

            this._updateCheckedItems();
        },

        uncheckAll: function (raiseEvents) {
            if (!this.checkboxes || !this.host.jqxCheckBox) {
                return;
            }

            if (this.disabled)
                return;

            var me = this;
            $.each(this.items, function () {
                var item = this;
                if (raiseEvents !== false && item.checked !== false) {
                    this.checked = false;
                    me._raiseEvent(3, { label: item.label, value: item.value, checked: false, item: item });
                }
                this.checked = false;
            });

            this._updateCheckedItems();
        },

        // unchecks a specific item by its index.
        uncheckIndex: function (index, render, raiseEvent) {
            if (!this.checkboxes || !this.host.jqxCheckBox) {
                return;
            }

            if (isNaN(index))
                return;

            if (index < 0 || index >= this.visibleItems.length)
                return;

            if (this.visibleItems[index] != null && this.visibleItems[index].disabled) {
                return;
            }

            if (this.disabled)
                return;

            var item = this.getItem(index);
            if (this.groups.length > 0) {
                var item = this.getVisibleItem(index);
            }
            if (item != null) {
                var checkbox = $(item.checkBoxElement);
                item.checked = false;
                if (render == undefined || render == true) {
                    this._updateCheckedItems();
                }
            }
            if (raiseEvent == undefined || raiseEvent == true) {
                this._raiseEvent(3, { label: item.label, value: item.value, checked: false, item: item });
            }
        },

        // sets a specific item's checked property to null.
        indeterminateIndex: function (index, render, raiseEvent) {
            if (!this.checkboxes || !this.host.jqxCheckBox) {
                return;
            }

            if (isNaN(index))
                return;

            if (index < 0 || index >= this.visibleItems.length)
                return;

            if (this.visibleItems[index] != null && this.visibleItems[index].disabled) {
                return;
            }

            if (this.disabled)
                return;

            var item = this.getItem(index);
            if (this.groups.length > 0) {
                var item = this.getVisibleItem(index);
            }
            if (item != null) {
                var checkbox = $(item.checkBoxElement);
                item.checked = null;
                if (render == undefined || render == true) {
                    this._updateCheckedItems();
                }
            }
            if (raiseEvent == undefined || raiseEvent == true) {
                this._raiseEvent(3, { checked: null });
            }
        },

        // gets the selected index.
        getSelectedIndex: function () {
            return this.selectedIndex;
        },

        // gets all selected items.
        getSelectedItems: function () {
            var items = this.getVisibleItems();
            var selectedIndexes = this.selectedIndexes;
            var selectedItems = [];
            // get selected items.
            for (var index in selectedIndexes) {
                if (selectedIndexes[index] != -1) {
                    selectedItems[selectedItems.length] = items[index];
                }
            }

            return selectedItems;
        },

        // gets the selected item.
        getSelectedItem: function () {
            return this.getItem(this.selectedIndex);
        },

        _updateCheckedItems: function () {
            var selectedIndex = this.selectedIndex;
            this.clearSelection(false);
            var items = this.getCheckedItems();
            this.selectedIndex = selectedIndex;

            this._renderItems();
            var selectedElement = $.data(this.element, 'hoveredItem');
            if (selectedElement != null) {
                $(selectedElement).addClass(this.toThemeProperty('jqx-listitem-state-hover'));
                $(selectedElement).addClass(this.toThemeProperty('jqx-fill-state-hover'));
            }

            this._updateInputSelection();
        },

        getItemByValue: function (value) {
            if (this.visibleItems == null) {
                return;
            }

            if (this.itemsByValue)
                return this.itemsByValue[$.trim(value).split(" ").join("")];

            var items = this.visibleItems;

            for (var i = 0; i < items.length; i++) {
                if (items[i].value == value) {
                    return items[i];
                    break;
                }
            }
        },

        checkItem: function (item) {
            if (item != null) {
                var newItem = this._getItemByParam(item);
                return this.checkIndex(newItem.index, true);
            }
            return false;
        },

        uncheckItem: function (item) {
            if (item != null) {
                var newItem = this._getItemByParam(item);
                return this.uncheckIndex(newItem.index, true);
            }
            return false;
        },

        indeterminateItem: function (item) {
            if (item != null) {
                var newItem = this._getItemByParam(item);
                return this.indeterminateIndex(newItem.index, true);
            }
            return false;
        },

        val: function (value) {
            if (this.input && arguments.length == 0) {
                return this.input.val();
            }

            var item = this.getItemByValue(value);
            if (item != null) {
                this.selectItem(item);
            }

            if (this.input) {
                return this.input.val();
            }
        },

        selectItem: function (item) {
            if (item != null) {
                if (item.index == undefined) {
                    var newItem = this.getItemByValue(item);
                    if (newItem) item = newItem;
                }
                return this.selectIndex(item.visibleIndex, true);
            }
            return false;
        },

        unselectItem: function (item) {
            if (item != null) {
                if (item.index == undefined) {
                    var newItem = this.getItemByValue(item);
                    if (newItem) item = newItem;
                }
                return this.unselectIndex(item.visibleIndex, true);
            }
            return false;
        },

        // selects an item.
        selectIndex: function (index, ensureVisible, render, forceSelect, type, originalEvent) {
            if (isNaN(index))
                return;

            if (index < -1 || index >= this.visibleItems.length)
                return;

            if (this.visibleItems[index] != null && this.visibleItems[index].disabled) {
                return;
            }

            if (this.disabled)
                return;

            if (!this.multiple && !this.multipleextended && this.selectedIndex == index && !forceSelect)
                return;

            if (this.checkboxes) {
                this._updateCheckedItems();
                return;
            }

            this.focused = true;
            var newSelection = false;
            if (this.selectedIndex != index) newSelection = true;
            var oldIndex = this.selectedIndex;
            if (this.selectedIndex == index && !this.multiple) {
                oldIndex = -1;
            }

            if (type == undefined) {
                type = 'none';
            }

            var newItem = this.getItem(index);
            var oldItem = this.getItem(oldIndex);
            if (this.visibleItems && this.items && this.visibleItems.length != this.items.length) {
                newItem = this.getVisibleItem(index);
                oldItem = this.getVisibleItem(oldIndex);
            }

            if (forceSelect != undefined && forceSelect) {
                this._raiseEvent('1', { index: oldIndex, type: type, item: oldItem, originalEvent: originalEvent });
                this.selectedIndex = index;
                this.selectedIndexes[oldIndex] = -1;
                this.selectedIndexes[index] = index;
                if (newItem) {
                    this.selectedValue = newItem.value;
                }
                this._raiseEvent('0', { index: index, type: type, item: newItem, originalEvent: originalEvent });
            }
            else {
                var me = this;
                var singleSelect = function (index, oldIndex, type, oldItem, newItem, originalEvent) {
                    me._raiseEvent('1', { index: oldIndex, type: type, item: oldItem, originalEvent: originalEvent });
                    me.selectedIndex = index;
                    me.selectedIndexes[oldIndex] = -1;
                    oldIndex = index;
                    me.selectedIndexes[index] = index;
                    me._raiseEvent('0', { index: index, type: type, item: newItem, originalEvent: originalEvent });
                }
                var multipleSelect = function (index, oldIndex, type, oldItem, newItem, originalEvent) {
                    if (me.selectedIndexes[index] == undefined || me.selectedIndexes[index] == -1) {
                        me.selectedIndexes[index] = index;
                        me.selectedIndex = index;
                        me._raiseEvent('0', { index: index, type: type, item: newItem, originalEvent: originalEvent });
                    }
                    else {
                        oldIndex = me.selectedIndexes[index];
                        oldItem = me.getVisibleItem(oldIndex);
                        me.selectedIndexes[index] = -1;
                        me.selectedIndex = -1;
                        me._raiseEvent('1', { index: oldIndex, type: type, item: oldItem, originalEvent: originalEvent });
                    }
                }

                if (this.multipleextended) {
                    if (!this._shiftKey && !this._ctrlKey) {
                        if (type != 'keyboard' && type != 'mouse') {
                            multipleSelect(index, oldIndex, type, oldItem, newItem, originalEvent);
                            me._clickedIndex = index;
                        }
                        else {
                            this.clearSelection(false);
                            me._clickedIndex = index;
                            singleSelect(index, oldIndex, type, oldItem, newItem, originalEvent);
                        }
                    }
                    else if (this._ctrlKey) {
                        if (type == 'keyboard') {
                            this.clearSelection(false);
                            me._clickedIndex = index;
                        }
                        multipleSelect(index, oldIndex, type, oldItem, newItem, originalEvent);
                    }
                    else if (this._shiftKey) {
                        if (me._clickedIndex == undefined) me._clickedIndex = oldIndex;
                        var min = Math.min(me._clickedIndex, index);
                        var max = Math.max(me._clickedIndex, index);
                        this.clearSelection(false);
                        for (var i = min; i <= max; i++) {
                            me.selectedIndexes[i] = i;
                            me._raiseEvent('0', { index: i, type: type, item: this.getVisibleItem(i), originalEvent: originalEvent });
                        }
                        if (type != 'keyboard') {
                            me.selectedIndex = me._clickedIndex;
                        }
                        else {
                            me.selectedIndex = index;
                        }
                    }
                }
                else if (this.multiple) {
                    multipleSelect(index, oldIndex, type, oldItem, newItem, originalEvent);
                }
                else {
                    if (newItem) {
                        this.selectedValue = newItem.value;
                    }
                    singleSelect(index, oldIndex, type, oldItem, newItem, originalEvent);
                }
            }

            if (render == undefined || render == true) {
                this._renderItems();
            }

            if (ensureVisible != undefined && ensureVisible != null && ensureVisible == true) {
                this.ensureVisible(index);
            }

            this._raiseEvent('2', { index: index, item: newItem, oldItem: oldItem, type: type });
            this._updateInputSelection();
            return newSelection;
        },

        _updateInputSelection: function () {
            if (this.input) {
                if (this.selectedIndex == -1) {
                    this.input.val("");
                }
                else {
                    if (this.items) {
                        if (this.items[this.selectedIndex] != undefined) {
                            this.input.val(this.items[this.selectedIndex].value);
                        }
                    }
                }
                if (this.multiple || this.multipleextended || this.checkboxes) {
                    var items = !this.checkboxes ? this.getSelectedItems() : this.getCheckedItems();
                    var str = "";
                    if (items) {
                        for (var i = 0; i < items.length; i++) {
                            if (undefined != items[i]) {
                                if (i == items.length - 1) {
                                    str += items[i].value;
                                }
                                else {
                                    str += items[i].value + ",";
                                }
                            }
                        }
                        this.input.val(str);
                    }
                }
            }
        },

        // checks whether an item is in the visible view.
        isIndexInView: function (index) {
            if (isNaN(index)) {
                return false;
            }

            if (!this.items)
                return false;

            if (index < 0 || index >= this.items.length) {
                return false;
            }

            var scrollValue = this.vScrollInstance.value;
            var item = this.visibleItems[index];
            if (item == undefined)
                return true;

            var itemTop = item.initialTop;
            var itemHeight = item.height;

            if (itemTop - scrollValue < 0 || itemTop - scrollValue + itemHeight >= this.host.outerHeight()) {
                return false;
            }

            return true;
        },

        //[optimize]
        _itemsInPage: function () {
            var itemsCount = 0;
            var me = this;

            if (this.items) {
                $.each(this.items, function () {
                    if ((this.initialTop + this.height) >= me.content.height()) {
                        return false;
                    }
                    itemsCount++;
                });
            }
            return itemsCount;
        },

        _firstItemIndex: function () {
            if (this.visibleItems != null) {
                if (this.visibleItems[0]) {
                    if (this.visibleItems[0].isGroup) {
                        return this._nextItemIndex(0);
                    }
                    else return 0;
                }
                else return 0;
            }

            return -1;
        },

        _lastItemIndex: function () {
            if (this.visibleItems != null) {
                if (this.visibleItems[this.visibleItems.length - 1]) {
                    if (this.visibleItems[this.visibleItems.length - 1].isGroup) {
                        return this._prevItemIndex(this.visibleItems.length - 1);
                    }
                    else return this.visibleItems.length - 1;
                }
                else return this.visibleItems.length - 1;
            }

            return -1;
        },

        _nextItemIndex: function (index) {
            for (indx = index + 1; indx < this.visibleItems.length; indx++) {
                if (this.visibleItems[indx]) {
                    if (!this.visibleItems[indx].disabled && !this.visibleItems[indx].isGroup) {
                        return indx;
                    }
                }
            }

            return -1;
        },

        _prevItemIndex: function (index) {
            for (indx = index - 1; indx >= 0; indx--) {
                if (this.visibleItems[indx]) {
                    if (!this.visibleItems[indx].disabled && !this.visibleItems[indx].isGroup) {
                        return indx;
                    }
                }
            }

            return -1;
        },

        // get all matches of a searched value.
        _getMatches: function (value, startindex) {
            if (value == undefined || value.length == 0)
                return -1;

            if (startindex == undefined) startindex = 0;

            var items = this.getItems();
            var me = this;
            var index = -1;
            var newItemsIndex = 0;

            $.each(items, function (i) {
                var itemValue = '';
                if (!this.isGroup) {
                    if (this.label) {
                        itemValue = this.label.toString();
                    }
                    else if (this.value) {
                        itemValue = this.value.toString();
                    }
                    else if (this.title) {
                        itemValue = this.title.toString();
                    }
                    else itemValue = 'jqxItem';

                    var mathes = false;
                    switch (me.searchMode) {
                        case 'containsignorecase':
                            mathes = $.jqx.string.containsIgnoreCase(itemValue, value);
                            break;
                        case 'contains':
                            mathes = $.jqx.string.contains(itemValue, value);
                            break;
                        case 'equals':
                            mathes = $.jqx.string.equals(itemValue, value);
                            break;
                        case 'equalsignorecase':
                            mathes = $.jqx.string.equalsIgnoreCase(itemValue, value);
                            break;
                        case 'startswith':
                            mathes = $.jqx.string.startsWith(itemValue, value);
                            break;
                        case 'startswithignorecase':
                            mathes = $.jqx.string.startsWithIgnoreCase(itemValue, value);
                            break;
                        case 'endswith':
                            mathes = $.jqx.string.endsWith(itemValue, value);
                            break;
                        case 'endswithignorecase':
                            mathes = $.jqx.string.endsWithIgnoreCase(itemValue, value);
                            break;
                    }

                    if (mathes && this.visibleIndex >= startindex) {
                        index = this.visibleIndex;
                        return false;
                    }
                }
            });

            return index;
        },

        // gets all items that match to a search value.
        findItems: function (value) {
            var items = this.getItems();
            var me = this;
            var index = 0;
            var matchItems = new Array();

            $.each(items, function (i) {
                var itemValue = '';
                if (!this.isGroup) {
                    if (this.label) {
                        itemValue = this.label;
                    }
                    else if (this.value) {
                        itemValue = this.value;
                    }
                    else if (this.title) {
                        itemValue = this.title;
                    }
                    else itemValue = 'jqxItem';

                    var mathes = false;
                    switch (me.searchMode) {
                        case 'containsignorecase':
                            mathes = $.jqx.string.containsIgnoreCase(itemValue, value);
                            break;
                        case 'contains':
                            mathes = $.jqx.string.contains(itemValue, value);
                            break;
                        case 'equals':
                            mathes = $.jqx.string.equals(itemValue, value);
                            break;
                        case 'equalsignorecase':
                            mathes = $.jqx.string.equalsIgnoreCase(itemValue, value);
                            break;
                        case 'startswith':
                            mathes = $.jqx.string.startsWith(itemValue, value);
                            break;
                        case 'startswithignorecase':
                            mathes = $.jqx.string.startsWithIgnoreCase(itemValue, value);
                            break;
                        case 'endswith':
                            mathes = $.jqx.string.endsWith(itemValue, value);
                            break;
                        case 'endswithignorecase':
                            mathes = $.jqx.string.endsWithIgnoreCase(itemValue, value);
                            break;
                    }

                    if (mathes) {
                        matchItems[index++] = this;
                    }
                }
            });

            return matchItems;
        },

        _handleKeyDown: function (event) {
            var key = event.keyCode;
            var self = this;
            var index = self.selectedIndex;
            var selectedIndex = self.selectedIndex;
            var newSelection = false;

            if (!this.keyboardNavigation || !this.enableSelection)
                return;

            var doClear = function () {
                if (self.multiple) {
                    self.clearSelection(false);
                }
            }

            if (event.altKey) key = -1;
            if (self.incrementalSearch) {
                var matchindex = -1;
                if (!self._searchString) {
                    self._searchString = "";
                }

                if ((key == 8 || key == 46) && self._searchString.length >= 1) {
                    self._searchString = self._searchString.substr(0, self._searchString.length - 1);
                }

                var letter = String.fromCharCode(key);

                var isDigit = (!isNaN(parseInt(letter)));
                var toReturn = false;
                if ((key >= 65 && key <= 97) || isDigit || key == 8 || key == 32 || key == 46) {
                    if (!event.shiftKey) {
                        letter = letter.toLocaleLowerCase();
                    }

                    var startIndex = 1 + self.selectedIndex;
                    if (key != 8 && key != 32 && key != 46) {
                        if (self._searchString.length > 0 && self._searchString.substr(0, 1) == letter) {
                            startIndex = 1 + self.selectedIndex;
                        }
                        else {
                            self._searchString += letter;
                        }
                    }

                    if (key == 32) {
                        self._searchString += " ";
                    }

                    var matches = this._getMatches(self._searchString, startIndex);
                    matchindex = matches;
                    if (matchindex == self._lastMatchIndex || matchindex == -1) {
                        var matches = this._getMatches(self._searchString, 0);
                        matchindex = matches;
                    }
                    self._lastMatchIndex = matchindex;

                    if (matchindex >= 0) {
                        var toSelect = function () {
                            doClear();
                            self.selectIndex(matchindex, false, false, false, 'keyboard', event);
                            var isInView = self.isIndexInView(matchindex);
                            if (!isInView) {
                                self.ensureVisible(matchindex);
                            }
                            else {
                                self._renderItems();
                            }
                        }
                        if (self._toSelectTimer) clearTimeout(self._toSelectTimer);
                        self._toSelectTimer = setTimeout(function () {
                            toSelect();
                        }, self.incrementalSearchKeyDownDelay);
                    }
                    toReturn = true;
                }

                if (self._searchTimer != undefined) {
                    clearTimeout(self._searchTimer);
                }

                if (key == 27 || key == 13) {
                    self._searchString = "";
                }

                self._searchTimer = setTimeout(function () {
                    self._searchString = "";
                    self._renderItems();
                }, self.incrementalSearchDelay);
                if (matchindex >= 0) {
                    return;
                }
                if (toReturn)
                    return false;
            }

            if (this.checkboxes)
                return true;

            if (key == 33) {
                var itemsInPage = self._itemsInPage();
                if (self.selectedIndex - itemsInPage >= 0) {
                    doClear();
                    self.selectIndex(selectedIndex - itemsInPage, false, false, false, 'keyboard', event);
                }
                else {
                    doClear();
                    self.selectIndex(self._firstItemIndex(), false, false, false, 'keyboard', event);
                }
                self._searchString = "";
            }

            if (key == 32 && this.checkboxes) {
                var checkItem = this.getItem(index);
                if (checkItem != null) {
                    self._updateItemCheck(checkItem, index);
                    event.preventDefault();
                }
                self._searchString = "";
            }

            if (key == 36) {
                doClear();
                self.selectIndex(self._firstItemIndex(), false, false, false, 'keyboard', event);
                self._searchString = "";
            }

            if (key == 35) {
                doClear();
                self.selectIndex(self._lastItemIndex(), false, false, false, 'keyboard', event);
                self._searchString = "";
            }

            if (key == 34) {
                var itemsInPage = self._itemsInPage();
                if (self.selectedIndex + itemsInPage < self.visibleItems.length) {
                    doClear();
                    self.selectIndex(selectedIndex + itemsInPage, false, false, false, 'keyboard', event);
                }
                else {
                    doClear();
                    self.selectIndex(self._lastItemIndex(), false, false, false, 'keyboard', event);
                }
                self._searchString = "";
            }

            if (key == 38) {
                self._searchString = "";
                if (self.selectedIndex > 0) {
                    var newIndex = self._prevItemIndex(self.selectedIndex);
                    if (newIndex != self.selectedIndex && newIndex != -1) {
                        doClear();
                        self.selectIndex(newIndex, false, false, false, 'keyboard', event);
                    }
                    else return true;
                }
                else return false;
            }
            else if (key == 40) {
                self._searchString = "";
                if (self.selectedIndex + 1 < self.visibleItems.length) {
                    var newIndex = self._nextItemIndex(self.selectedIndex);
                    if (newIndex != self.selectedIndex && newIndex != -1) {
                        doClear();
                        self.selectIndex(newIndex, false, false, false, 'keyboard', event);
                    }
                    else return true;
                }
                else return false;
            }

            if (key == 35 || key == 36 || key == 38 || key == 40 || key == 34 || key == 33) {
                var isInView = self.isIndexInView(self.selectedIndex);
                if (!isInView) {
                    self.ensureVisible(self.selectedIndex);
                }
                else {
                    self._renderItems();
                }

                return false;
            }

            return true;
        },

        _updateItemCheck: function (checkItem, index) {
            if (checkItem.checked == true) {
                checkItem.checked = (checkItem.hasThreeStates && this.hasThreeStates) ? null : false;
            }
            else {
                checkItem.checked = checkItem.checked != null;
            }

            switch (checkItem.checked) {
                case true:
                    this.checkIndex(index);
                    break;
                case false:
                    this.uncheckIndex(index);
                    break;
                default:
                    this.indeterminateIndex(index);
                    break;
            }
        },

        // performs mouse wheel.
        wheel: function (event, self) {
            if (self.autoHeight || !self.enableMouseWheel) {
                event.returnValue = true;
                return true;
            }

            if (self.disabled) return true;

            var delta = 0;
            if (!event) /* For IE. */
                event = window.event;

            if (event.originalEvent && event.originalEvent.wheelDelta) {
                event.wheelDelta = event.originalEvent.wheelDelta;
            }

            if (event.wheelDelta) { /* IE/Opera. */
                delta = event.wheelDelta / 120;
            } else if (event.detail) { /** Mozilla case. */
                delta = -event.detail / 3;
            }

            if (delta) {
                var result = self._handleDelta(delta);
                if (result) {
                    if (event.preventDefault)
                        event.preventDefault();

                    if (event.originalEvent != null) {
                        event.originalEvent.mouseHandled = true;
                    }

                    if (event.stopPropagation != undefined) {
                        event.stopPropagation();
                    }
                }

                if (result) {
                    result = false;
                    event.returnValue = result;
                    return result;
                }
                else {
                    return false;
                }
            }

            if (event.preventDefault)
                event.preventDefault();
            event.returnValue = false;
        },

        _handleDelta: function (delta) {
            var oldvalue = this.vScrollInstance.value;
            if (delta < 0) {
                this.scrollDown();
            }
            else this.scrollUp();
            var newvalue = this.vScrollInstance.value;
            if (oldvalue != newvalue) {
                return true;
            }

            return false;
        },

        focus: function () {
            try {
                this.focused = true;
                this.host.focus();
                var me = this;
                setTimeout(function () {
                    me.host.focus();
                }, 10);
            }
            catch (error) {
            }
        },

        _removeHandlers: function () {
            var self = this;
            this.removeHandler($(document), 'keydown.listbox' + this.element.id);
            this.removeHandler($(document), 'keyup.listbox' + this.element.id);
            this.removeHandler(this.vScrollBar, 'valuechanged');
            this.removeHandler(this.hScrollBar, 'valuechanged');
            if (this._mousewheelfunc) {
                this.removeHandler(this.host, 'mousewheel', this._mousewheelfunc);
            }
            else {
                this.removeHandler(this.host, 'mousewheel');
            }

            this.removeHandler(this.host, 'keydown');
            this.removeHandler(this.content, 'mouseleave');
            this.removeHandler(this.content, 'focus');
            this.removeHandler(this.content, 'blur');
            this.removeHandler(this.host, 'focus');
            this.removeHandler(this.host, 'blur');
            this.removeHandler(this.content, 'mouseenter');
            this.removeHandler(this.content, 'mouseup');
            this.removeHandler(this.content, 'mousedown');
            this.removeHandler(this.content, 'touchend');

            if (this._mousemovefunc) {
                this.removeHandler(this.content, 'mousemove', this._mousemovefunc);
            }
            else {
                this.removeHandler(this.content, 'mousemove');
            }
            this.removeHandler(this.content, 'selectstart');
            if (this.overlayContent) {
                this.removeHandler(this.overlayContent, $.jqx.mobile.getTouchEventName('touchend'));
            }
        },

        _updateSize: function()
        {
            if (!this.virtualSize) {
                this._oldheight = null;
                this.virtualSize = this._calculateVirtualSize();
            }

            var self = this;
            self._arrange();
            if (self.host.height() != self._oldheight || self.host.width() != self._oldwidth) {
                var changedWidth = self.host.width() != self._oldwidth;

                if (self.autoItemsHeight) {
                    self._render(false);
                }
                else {
                    if (self.items) {
                        if (self.items.length > 0 && self.virtualItemsCount * self.items[0].height < self._oldheight) {
                            self._render(false);
                        }
                        else {
                            var _oldScrollValue = self.vScrollInstance.value;
                            self._updatescrollbars();
                            self._renderItems();
                            if (_oldScrollValue < self.vScrollInstance.max) {
                                self.vScrollInstance.setPosition(_oldScrollValue);
                            }
                            else {
                                self.vScrollInstance.setPosition(self.vScrollInstance.max);
                            }
                        }
                    }
                }
                self._oldwidth = self.host.width();
                self._oldheight = self.host.height();
            }
        },

        _addHandlers: function () {
            var self = this;
            this.focused = false;
            var animating = false;
            var prevValue = 0;
            var object = null;
            var prevValue = 0;
            var newValue = 0;
            var lastScroll = new Date();
            var isTouchDevice = this.isTouchDevice();
 
            this.addHandler(this.vScrollBar, 'valuechanged', function (event) {
                if ($.jqx.browser.msie && $.jqx.browser.version > 9) {
                    setTimeout(function () {
                        self._renderItems();
                    }, 1);
                }
                else self._renderItems();
            });

            this.addHandler(this.hScrollBar, 'valuechanged', function () {
                self._renderItems();
            });

            if (this._mousewheelfunc) {
                this.removeHandler(this.host, 'mousewheel', this._mousewheelfunc);
            }

            this._mousewheelfunc = function (event) {
                self.wheel(event, self);
            };
            this.addHandler(this.host, 'mousewheel', this._mousewheelfunc);

            this.addHandler($(document), 'keydown.listbox' + this.element.id, function (event) {
                self._ctrlKey = event.ctrlKey;
                self._shiftKey = event.shiftKey;
            });
            this.addHandler($(document), 'keyup.listbox' + this.element.id, function (event) {
                self._ctrlKey = event.ctrlKey;
                self._shiftKey = event.shiftKey;
            });

            this.addHandler(this.host, 'keydown', function (event) {
                return self._handleKeyDown(event);
            });

            this.addHandler(this.content, 'mouseleave', function (event) {
                self.focused = false;
                var hoveredItem = $.data(self.element, 'hoveredItem');
                if (hoveredItem != null) {
                    $(hoveredItem).removeClass(self.toThemeProperty('jqx-listitem-state-hover'));
                    $(hoveredItem).removeClass(self.toThemeProperty('jqx-fill-state-hover'));
                    $.data(self.element, 'hoveredItem', null);
                }
            });

            this.addHandler(this.content, 'focus', function (event) {
                if (!self.disabled) {
                    self.host.addClass(self.toThemeProperty('jqx-fill-state-focus'));
                    self.focused = true;
                }
            });

            this.addHandler(this.content, 'blur', function (event) {
                self.focused = false;
                self.host.removeClass(self.toThemeProperty('jqx-fill-state-focus'));
            });

            this.addHandler(this.host, 'focus', function (event) {
                if (!self.disabled) {
                    self.host.addClass(self.toThemeProperty('jqx-fill-state-focus'));
                    self.focused = true;
                }
            });

            this.addHandler(this.host, 'blur', function (event) {
                if ($.jqx.browser.msie && $.jqx.browser.version < 9 && self.focused) {
                    return;
                }

                self.host.removeClass(self.toThemeProperty('jqx-fill-state-focus'));
                self.focused = false;
            });

            this.addHandler(this.content, 'mouseenter', function (event) {
                self.focused = true;
            });
            var hasTransform = $.jqx.utilities.hasTransform(this.host);

            if (this.enableSelection) {
                var isTouch = self.isTouchDevice() && this.touchMode !== true;
                var eventName = !isTouch ? 'mousedown' : 'touchend';

                if (this.overlayContent) {
                    this.addHandler(this.overlayContent, $.jqx.mobile.getTouchEventName('touchend'), function (event) {
                        if (!self.enableSelection) {
                            return true;
                        }

                        if (isTouch) {
                            self._newScroll = new Date();
                            if (self._newScroll - self._lastScroll < 500) {
                                return true;
                            }
                        }

                        var touches = $.jqx.mobile.getTouches(event);
                        var touch = touches[0];
                        if (touch != undefined) {
                            var selfOffset = self.host.offset();
                            var left = parseInt(touch.pageX);
                            var top = parseInt(touch.pageY);
                            if (self.touchMode == true) {
                                left = parseInt(touch._pageX);
                                top = parseInt(touch._pageY);
                            }
                            left = left - selfOffset.left;
                            top = top - selfOffset.top;
                            var item = self._hitTest(left, top);
                            if (item != null && !item.isGroup) {
                                self._newScroll = new Date();
                                if (self._newScroll - self._lastScroll < 500) {
                                    return false;
                                }
                                if (self.checkboxes) {
                                    self._updateItemCheck(item, item.visibleIndex);
                                    return;
                                }


                                if (item.html.indexOf('href') != -1) {
                                    setTimeout(function () {
                                        self.selectIndex(item.visibleIndex, false, true, false, 'mouse', event);
                                        self.content.trigger('click');
                                    }, 100);
                                }
                                else {
                                    self.selectIndex(item.visibleIndex, false, true, false, 'mouse', event);
                                    self.content.trigger('click');
                                }
                            }
                        }
                    });
                }
                else {
                    this.addHandler(this.content, eventName, function (event) {
                        if (!self.enableSelection) {
                            return true;
                        }

                        if (isTouch) {
                            self._newScroll = new Date();
                            if (self._newScroll - self._lastScroll < 500) {
                                return false;
                            }
                        }

                        self.focused = true;
                        if (!self.isTouchDevice()) {
                            self.host.focus();
                        }
                        if (event.target.id != ('listBoxContent' + self.element.id) && self.itemswrapper[0] != event.target) {
                            var target = event.target;
                            var targetOffset = $(target).offset();
                            var selfOffset = self.host.offset();
                            if (hasTransform) {
                                var left = $.jqx.mobile.getLeftPos(target);
                                var top = $.jqx.mobile.getTopPos(target);
                                targetOffset.left = left; targetOffset.top = top;

                                left = $.jqx.mobile.getLeftPos(self.element);
                                top = $.jqx.mobile.getTopPos(self.element);
                                selfOffset.left = left; selfOffset.top = top;
                            }

                            var y = parseInt(targetOffset.top) - parseInt(selfOffset.top);
                            var x = parseInt(targetOffset.left) - parseInt(selfOffset.left);
                            var item = self._hitTest(x, y);
                            if (item != null && !item.isGroup) {
                                var doSelection = function (item, event) {
                                    if (!self._shiftKey)
                                        self._clickedIndex = item.visibleIndex;
                                    if (!self.checkboxes) {
                                        self.selectIndex(item.visibleIndex, false, true, false, 'mouse', event);
                                    } else {
                                        self.selectedIndex = item.visibleIndex;
                                        x = 20 + event.pageX - targetOffset.left;
                                        if (self.rtl) {
                                            var hscroll = self.hScrollBar.css('visibility') != 'hidden' ? self.hScrollInstance.max : self.host.width();
                                            if (x <= self.host.width() - 20) {
                                                self._updateItemCheck(item, item.visibleIndex);
                                            }
                                        }
                                        else {
                                            if (x + self.hScrollInstance.value >= 20) {
                                                self._updateItemCheck(item, item.visibleIndex);
                                            }
                                        }
                                    }
                                }

                                if (!item.disabled) {
                                    if (item.html.indexOf('href') != -1) {
                                        setTimeout(function () {
                                            doSelection(item, event);
                                        }, 100);
                                    }
                                    else {
                                        doSelection(item, event);
                                    }
                                }
                            }
                            if (eventName == 'mousedown') {
                                var rightclick = false;
                                if (event.which) rightclick = (event.which == 3);
                                else if (event.button) rightclick = (event.button == 2);
                                if (rightclick) return true;
                                return false;
                            }
                        }

                        return true;
                    });
                }

                this.addHandler(this.content, 'mouseup', function (event) {
                    self.vScrollInstance.handlemouseup(self, event);
                });

                if ($.jqx.browser.msie) {
                    this.addHandler(this.content, 'selectstart', function (event) {
                        return false;
                    });
                }
            }
            // hover behavior.
            var isTouchDevice = this.isTouchDevice();
            if (this.enableHover && !isTouchDevice) {
                this._mousemovefunc = function (event) {
                    if (isTouchDevice)
                        return true;

                    if (!self.enableHover)
                        return true;

                    var which = $.jqx.browser.msie == true && $.jqx.browser.version < 9 ? 0 : 1;
                    if (event.target == null)
                        return true;

                    if (self.disabled)
                        return true;

                    self.focused = true;
                    var scrolling = self.vScrollInstance.isScrolling();
                    if (!scrolling && event.target.id != ('listBoxContent' + self.element.id)) {
                        if (self.itemswrapper[0] != event.target) {
                            var target = event.target;
                            var targetOffset = $(target).offset();
                            var selfOffset = self.host.offset();
                            if (hasTransform) {
                                var left = $.jqx.mobile.getLeftPos(target);
                                var top = $.jqx.mobile.getTopPos(target);
                                targetOffset.left = left; targetOffset.top = top;

                                left = $.jqx.mobile.getLeftPos(self.element);
                                top = $.jqx.mobile.getTopPos(self.element);
                                selfOffset.left = left; selfOffset.top = top;
                            }
                            var y = parseInt(targetOffset.top) - parseInt(selfOffset.top);
                            var x = parseInt(targetOffset.left) - parseInt(selfOffset.left);
                            var item = self._hitTest(x, y);
                            if (item != null && !item.isGroup && !item.disabled) {
                                var selectedElement = $.data(self.element, 'hoveredItem');
                                if (selectedElement != null) {
                                    $(selectedElement).removeClass(self.toThemeProperty('jqx-listitem-state-hover'));
                                    $(selectedElement).removeClass(self.toThemeProperty('jqx-fill-state-hover'));
                                }

                                $.data(self.element, 'hoveredItem', item.element);
                                var $element = $(item.element);
                                $element.addClass(self.toThemeProperty('jqx-listitem-state-hover'));
                                $element.addClass(self.toThemeProperty('jqx-fill-state-hover'));
                            }
                        }
                    }
                };

                this.addHandler(this.content, 'mousemove', this._mousemovefunc);
            }
        },

        _arrange: function (arrangeScrollbars) {
            if (arrangeScrollbars == undefined) arrangeScrollbars = true;

            var width = null;
            var height = null;
            var me = this;
            var _setHostHeight = function (height) {
                height = me.host.height();
                if (height == 0) {
                    height = 200;
                    me.host.height(height);
                }
                return height;
            }

            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                width = this.width;
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    width = this.width;
                };

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                height = this.height;
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                height = this.height;
            };

            if (this.width != null && this.width.toString().indexOf("%") != -1) {
                this.host.css("width", this.width);
                width = this.host.width();
            }
            if (this.height != null && this.height.toString().indexOf("%") != -1) {
                this.host.css("height", this.height);
                height = _setHostHeight(height);
            }

            if (width != null) {
                width = parseInt(width);
                if (parseInt(this.element.style.width) != parseInt(this.width)) {
                    this.host.width(this.width);
                }
            }

            if (!this.autoHeight) {
                if (height != null) {
                    height = parseInt(height);
                    if (parseInt(this.element.style.height) != parseInt(this.height)) {
                        this.host.height(this.height);
                        _setHostHeight(height);
                    }
                }
            }
            else {
                if (this.virtualSize) {
                    if (this.hScrollBar.css('visibility') != 'hidden') {
                        this.host.height(this.virtualSize.height + parseInt(this.scrollBarSize) + 3);
                        this.height = this.virtualSize.height + parseInt(this.scrollBarSize) + 3;
                        height = this.height;
                    }
                    else {
                        this.host.height(this.virtualSize.height);
                        this.height = this.virtualSize.height;
                        height = this.virtualSize.height;
                    }
                }
            }

            // scrollbar Size.
            var scrollSize = this.scrollBarSize;
            if (isNaN(scrollSize)) {
                scrollSize = parseInt(scrollSize);
                if (isNaN(scrollSize)) {
                    scrollSize = '17px';
                }
                else scrollSize = scrollSize + 'px';
            }

            scrollSize = parseInt(scrollSize);
            var scrollOffset = 4;
            var bottomSizeOffset = 2;
            var rightSizeOffset = 0;
            // right scroll offset. 
            if (this.vScrollBar) {
                if (this.vScrollBar[0].style.visibility != 'hidden') {
                    rightSizeOffset = scrollSize + scrollOffset;
                }
                else {
                    this.vScrollInstance.setPosition(0);
                }
            }
            else return;

            if (this.hScrollBar) {
                // bottom scroll offset.
                if (this.hScrollBar[0].style.visibility != 'hidden') {
                    bottomSizeOffset = scrollSize + scrollOffset;
                }
                else {
                    this.hScrollInstance.setPosition(0);
                }
            }
            else return;

            if (this.autoItemsHeight) {
                this.hScrollBar[0].style.visibility = 'hidden';
                bottomSizeOffset = 0;
            }

            if (height == null) height = 0;
            var hScrollTop = parseInt(height) - scrollOffset - scrollSize;
            if (hScrollTop < 0) hScrollTop = 0;

            if (parseInt(this.hScrollBar[0].style.height) != scrollSize) {
                if (parseInt(scrollSize) < 0) {
                    scrollSize = 0;
                }

                this.hScrollBar[0].style.height = parseInt(scrollSize) + 'px';
            }

            if (this.hScrollBar[0].style.top != hScrollTop + 'px') {
                this.hScrollBar[0].style.top = hScrollTop + 'px';
                this.hScrollBar[0].style.left = '0px';
            }

            var hscrollwidth = width - scrollSize - scrollOffset;
            if (hscrollwidth < 0) hscrollwidth = 0;
            var hScrollWidth =  hscrollwidth + 'px';

            if (this.hScrollBar[0].style.width != hScrollWidth) {
                this.hScrollBar[0].style.width = hScrollWidth;
            }

            if (rightSizeOffset == 0) {
                this.hScrollBar.width(width - 2);
            }

            if (scrollSize != parseInt(this.vScrollBar[0].style.width)) {
                this.vScrollBar.width(scrollSize);
            }
            if ((parseInt(height) - bottomSizeOffset) != parseInt(this.vScrollBar[0].style.height)) {
                this.vScrollBar.height(parseInt(height) - bottomSizeOffset + 'px');
            }

            if (width == null) width = 0;
            var vScrollLeft = parseInt(width) - parseInt(scrollSize) - scrollOffset + 'px'; ;
            if (vScrollLeft != this.vScrollBar[0].style.left) {
                if (parseInt(vScrollLeft) >= 0) {
                    this.vScrollBar[0].style.left = vScrollLeft;
                }
                this.vScrollBar[0].style.top = '0px';
            }

            var vScrollInstance = this.vScrollInstance;
            vScrollInstance.disabled = this.disabled;
            if (arrangeScrollbars) {
                vScrollInstance._arrange();
            }

            var hScrollInstance = this.hScrollInstance;
            hScrollInstance.disabled = this.disabled;
            if (arrangeScrollbars) {
                hScrollInstance._arrange();
            }

            if ((this.vScrollBar[0].style.visibility != 'hidden') && (this.hScrollBar[0].style.visibility != 'hidden')) {
                this.bottomRight[0].style.visibility = 'inherit';
                this.bottomRight.css({ left: 1 + parseInt(this.vScrollBar[0].style.left), top: 1 + parseInt(this.hScrollBar[0].style.top) });
                if (this.rtl) {
                    this.bottomRight.css({ left: 0 });
                }
                this.bottomRight.width(parseInt(scrollSize) + 3);
                this.bottomRight.height(parseInt(scrollSize) + 3);
            }
            else {
                this.bottomRight[0].style.visibility = 'hidden';
            }

            if (parseInt(this.content[0].style.width) != (parseInt(width) - rightSizeOffset)) {
                var w = parseInt(width) - rightSizeOffset;
                this.content[0].style.width = w + 'px';
            }

            if (this.rtl) {
                this.vScrollBar.css({ left: 0 + 'px', top: '0px' });
                this.hScrollBar.css({ left: this.vScrollBar.width() + 2 + 'px' });
                if (this.vScrollBar[0].style.visibility != 'hidden') {
                    this.content.css('margin-left', 4 + this.vScrollBar.width());
                }
                else {
                    this.content.css('margin-left', 0);
                    this.hScrollBar.css({ left: '0px' });
                }
            }

            if (parseInt(this.content[0].style.height) != (parseInt(height) - bottomSizeOffset)) {
                var h = parseInt(height) - bottomSizeOffset;
                if (h < 0) h = 0;
                this.content[0].style.height = h + 'px';
            }
            if (this.overlayContent) {
                this.overlayContent.width(parseInt(width) - rightSizeOffset);
                this.overlayContent.height(parseInt(height) - bottomSizeOffset);
            }
        },

        // scrolls to a list box item.
        ensureVisible: function (index) {
            if (isNaN(index)) {
                var item = this.getItemByValue(index);
                if (item) {
                    index = item.index;
                }
            }

            var isInView = this.isIndexInView(index);
            if (!isInView) {
                if (index < 0)
                    return;
                if (this.autoHeight) {
                    var vScrollInstance = $.data(this.vScrollBar[0], 'jqxScrollBar').instance;
                    vScrollInstance.setPosition(0);
                }
                else {
                    for (indx = 0; indx < this.visibleItems.length; indx++) {
                        var item = this.visibleItems[indx];
                        if (item.visibleIndex == index && !item.isGroup) {
                            var vScrollInstance = $.data(this.vScrollBar[0], 'jqxScrollBar').instance;
                            var value = vScrollInstance.value;
                            var hScrollVisible = this.hScrollBar.css('visibility') === 'hidden';
                            var hScrollOffset = hScrollVisible ? 0 : this.scrollBarSize + 4;
                            if (item.initialTop < value) {
                                vScrollInstance.setPosition(item.initialTop);
                            }
                            else if (item.initialTop + item.height > value + this.host.height()) {
                                vScrollInstance.setPosition(item.initialTop + item.height + 2 - this.host.height() + hScrollOffset);
                            }

                            break;
                        }
                    }
                }
            }

            this._renderItems();
        },

        scrollTo: function(left, top)
        {
            if (this.vScrollBar.css('visibility') != 'hidden') {
                this.vScrollInstance.setPosition(top);
            }
            if (this.hScrollBar.css('visibility') != 'hidden') {
                this.hScrollInstance.setPosition(left);
            }
        },

        // scrolls down.
        scrollDown: function () {
            if (this.vScrollBar.css('visibility') == 'hidden')
                return false;

            var vScrollInstance = this.vScrollInstance;
            if (vScrollInstance.value + vScrollInstance.largestep <= vScrollInstance.max) {
                vScrollInstance.setPosition(vScrollInstance.value + vScrollInstance.largestep);
                return true;
            }
            else {
                vScrollInstance.setPosition(vScrollInstance.max);
                return true;
            }

            return false;
        },

        // scrolls up.
        scrollUp: function () {
            if (this.vScrollBar.css('visibility') == 'hidden')
                return false;

            var vScrollInstance = this.vScrollInstance;
            if (vScrollInstance.value - vScrollInstance.largestep >= vScrollInstance.min) {
                vScrollInstance.setPosition(vScrollInstance.value - vScrollInstance.largestep);
                return true;
            }
            else {
                if (vScrollInstance.value != vScrollInstance.min) {
                    vScrollInstance.setPosition(vScrollInstance.min);
                    return true;
                }
            }
            return false;
        },

        databind: function (source) {
            this.records = new Array();
            var isdataadapter = source._source ? true : false;
            var dataadapter = new $.jqx.dataAdapter(source,
                {
                    autoBind: false
                }
            );

            if (isdataadapter) {
                dataadapter = source;
                source = source._source;
            }

            var initadapter = function (me) {
                if (source.type != undefined) {
                    dataadapter._options.type = source.type;
                }
                if (source.formatdata != undefined) {
                    dataadapter._options.formatData = source.formatdata;
                }
                if (source.contenttype != undefined) {
                    dataadapter._options.contentType = source.contenttype;
                }
                if (source.async != undefined) {
                    dataadapter._options.async = source.async;
                }
            }

            var updatefromadapter = function (me, type) {
                var getItem = function (record) {
                    if (typeof record === 'string') {
                        var label = record;
                        var value = record;
                    }
                    else {
                        var value = record[me.valueMember];
                        var label = record[me.displayMember];
                    }
                    var listBoxItem = new $.jqx._jqxListBox.item();
                    listBoxItem.label = label;
                    listBoxItem.value = value;
                    listBoxItem.html = "";
                    listBoxItem.visible = true;
                    listBoxItem.originalItem = record;
                    listBoxItem.group = '';
                    listBoxItem.groupHtml = '';
                    listBoxItem.disabled = false;
                    listBoxItem.hasThreeStates = true;
                    return listBoxItem;
                }

                if (type != undefined) {
                    var dataItem = dataadapter._changedrecords[0];
                    if (dataItem) {
                        $.each(dataadapter._changedrecords, function () {
                            var index = this.index;
                            var item = this.record;
                            if (type != 'remove') {
                                var mapItem = getItem(item);
                            }

                            switch (type) {
                                case "update":
                                    me.updateAt(mapItem, index);
                                    break;
                                case "add":
                                    me.insertAt(mapItem, index);
                                    break;
                                case "remove":
                                    me.removeAt(index);
                                    break;
                            }
                        });
                        return;
                    }
                }

                me.records = dataadapter.records;
                var recordslength = me.records.length;
                me.items = new Array();
                me.itemsByValue = new Array();
                for (var i = 0; i < recordslength; i++) {
                    var record = me.records[i];
                    var listBoxItem = getItem(record);
                    listBoxItem.index = i;
                    me.items[i] = listBoxItem;

                    var key = listBoxItem.value;
                    if (listBoxItem.value == "" || listBoxItem.value == null) key = i;
                    me.itemsByValue[$.trim(key).split(" ").join("")] = listBoxItem;
                }
                me._render();
                me._raiseEvent('6');
            }

            initadapter(this);

            var me = this;
            switch (source.datatype) {
                case "local":
                case "array":
                default:
                    if (source.localdata != null) {
                        dataadapter.unbindBindingUpdate(this.element.id);
                        dataadapter.dataBind();
                        updatefromadapter(this);
                        dataadapter.bindBindingUpdate(this.element.id, function (updatetype) {
                            updatefromadapter(me, updatetype);
                        });
                    }
                    break;
                case "json":
                case "jsonp":
                case "xml":
                case "xhtml":
                case "script":
                case "text":
                case "csv":
                case "tab":
                    {
                        if (source.localdata != null) {
                            dataadapter.unbindBindingUpdate(this.element.id);
                            dataadapter.dataBind();
                            updatefromadapter(this);
                            dataadapter.bindBindingUpdate(this.element.id, function () {
                                updatefromadapter(me);
                            });
                            return;
                        }

                        var postdata = {};
                        if (dataadapter._options.data) {
                            $.extend(dataadapter._options.data, postdata);
                        }
                        else {
                            if (source.data) {
                                $.extend(postdata, source.data);
                            }
                            dataadapter._options.data = postdata;
                        }
                        var updateFunc = function () {
                            updatefromadapter(me);
                        }

                        dataadapter.unbindDownloadComplete(me.element.id);
                        dataadapter.bindDownloadComplete(me.element.id, updateFunc);

                        dataadapter.dataBind();
                    }
            }
        },

        loadItems: function (items) {
            if (items == null) {
                this.groups = new Array();
                this.items = new Array();
                this.visualItems = new Array();
                return;
            }

            var self = this;
            var index = 0;
            var length = 0;
            var itemIndex = 0;
            this.groups = new Array();
            this.items = new Array();
            this.visualItems = new Array();
            var listItems = new Array();
            this.itemsByValue = new Array();

            $.map(items, function (item) {
                if (item == undefined)
                    return null;

                var listBoxItem = new $.jqx._jqxListBox.item();
                var group = item.group;
                var groupHtml = item.groupHtml;
                var title = item.title;

                if (title == null || title == undefined) {
                    title = '';
                }

                if (group == null || group == undefined) {
                    group = '';
                }

                if (groupHtml == null || groupHtml == undefined) {
                    groupHtml = '';
                }

                if (!self.groups[group]) {
                    self.groups[group] = { items: new Array(), index: -1, caption: group, captionHtml: groupHtml };
                    index++;

                    var groupID = index + 'jqxGroup';
                    self.groups[groupID] = self.groups[group];
                    length++;
                    self.groups.length = length;
                }

                var uniqueGroup = self.groups[group];
                uniqueGroup.index++;
                uniqueGroup.items[uniqueGroup.index] = listBoxItem;

                if (typeof item === "string") {
                    listBoxItem.label = item;
                    listBoxItem.value = item;
                }
                else if (item.label == null && item.value == null && item.html == null && item.group == null && item.groupHtml == null) {
                    listBoxItem.label = item.toString();
                    listBoxItem.value = item.toString();
                }
                else {
                    listBoxItem.label = item.label || item.value;
                    listBoxItem.value = item.value || item.label;
                }

                if (typeof item != "string") {
                    if (self.displayMember != "") {
                        if (item[self.displayMember]) {
                            listBoxItem.label = item[self.displayMember];
                        }
                    }

                    if (self.valueMember != "") {
                        listBoxItem.value = item[self.valueMember];
                    }
                }

                listBoxItem.hasThreeStates = item.hasThreeStates != undefined ? item.hasThreeStates : true;
                listBoxItem.originalItem = item;
                listBoxItem.title = title;
                listBoxItem.html = item.html || '';
                if (item.html && item.html != '') {
                    //     listBoxItem.label = listBoxItem.value = item.html;
                    if (title && title != '') {
                        //           listBoxItem.label = listBoxItem.value = title;
                    }
                }

                listBoxItem.group = group;
                listBoxItem.checked = item.checked || false;
                listBoxItem.groupHtml = item.groupHtml || '';
                listBoxItem.disabled = item.disabled || false;
                listBoxItem.visible = item.visible != undefined ? item.visible : true;
                listBoxItem.index = itemIndex;
                listItems[itemIndex] = listBoxItem;
                itemIndex++;
                return listBoxItem;
            });

            var itemsArray = new Array();
            var uniqueItemIndex = 0;

            if (this.fromSelect == undefined || this.fromSelect == false) {
                for (var indx = 0; indx < length; indx++) {
                    var index = indx + 1;
                    var groupID = index + 'jqxGroup';
                    var group = this.groups[groupID];
                    if (group == undefined || group == null)
                        break;

                    if (indx == 0 && group.caption == '' && group.captionHtml == '' && length <= 1) {
                        for (var i = 0; i < group.items.length; i++) {
                            var key = group.items[i].value;
                            if (group.items[i].value == "" || group.items[i].value == null) key = i;
                            this.itemsByValue[$.trim(key).split(" ").join("")] = group.items[i];
                        }
                        return group.items;
                    }
                    else {
                        var listBoxItem = new $.jqx._jqxListBox.item();
                        listBoxItem.isGroup = true;
                        listBoxItem.label = group.caption;
                        if (group.caption == '' && group.captionHtml == '') {
                            group.caption = this.emptyGroupText;
                            listBoxItem.label = group.caption;
                        }

                        listBoxItem.html = group.captionHtml;
                        itemsArray[uniqueItemIndex] = listBoxItem;
                 
                        uniqueItemIndex++;
                    }

                    for (var j = 0; j < group.items.length; j++) {
                        itemsArray[uniqueItemIndex] = group.items[j];
                        var key = group.items[j].value;
                        if (group.items[j].value == "" || group.items[j].value == null) key = uniqueItemIndex;
                        self.itemsByValue[$.trim(key).split(" ").join("")] = group.items[j];

                        uniqueItemIndex++;
                   
                    }
                }
            }
            else {
                var uniqueItemIndex = 0;
                var checkedGroups = new Array();

                $.each(listItems, function () {
                    if (!checkedGroups[this.group]) {
                        if (this.group != '') {
                            var listBoxItem = new $.jqx._jqxListBox.item();
                            listBoxItem.isGroup = true;
                            listBoxItem.label = this.group;
                            itemsArray[uniqueItemIndex] = listBoxItem;
                            uniqueItemIndex++;
                            checkedGroups[this.group] = true;
                        }
                    }

                    itemsArray[uniqueItemIndex] = this;
                    var key = this.value;
                    if (this.value == "" || this.value == null) key = uniqueItemIndex - 1;
                    self.itemsByValue[$.trim(key).split(" ").join("")] = this;

                    uniqueItemIndex++;
                });
            }

            return itemsArray;
        },

        _mapItem: function (item) {
            var listBoxItem = new $.jqx._jqxListBox.item();
            if (this.displayMember) {
                if (item.label == undefined) {
                    item.label = item[this.displayMember];
                }
                if (item.value == undefined) {
                    item.value = item[this.valueMember];
                }
            }

            if (typeof item === "string") {
                listBoxItem.label = item;
                listBoxItem.value = item;
            }
            else if (typeof item === 'number') {
                listBoxItem.label = item.toString();
                listBoxItem.value = item.toString();
            }
            else {
                listBoxItem.label = item.label || item.value;
                listBoxItem.value = item.value || item.label;
            }
            if (listBoxItem.label == undefined && listBoxItem.value == undefined && listBoxItem.html == undefined) {
                listBoxItem.label = listBoxItem.value = item;
            }

            listBoxItem.html = item.html || '';
            listBoxItem.group = item.group || '';
            listBoxItem.title = item.title || '';
            listBoxItem.groupHtml = item.groupHtml || '';
            listBoxItem.disabled = item.disabled || false;
            listBoxItem.visible = item.visible || true;
            return listBoxItem;
        },

        // adds a new item.
        addItem: function (item) {
            var newItem = this._getItemByParam(item);
            return this.insertAt(newItem, this.items ? this.items.length : 0);
        },

        _getItemByParam: function(item)
        {
            if (item != null) {
                if (item.index == undefined) {
                    var newItem = this.getItemByValue(item);
                    if (newItem) item = newItem;
                }
            }
            return item;
        },

        insertItem: function(item, index)
        {
            var newItem = this._getItemByParam(item);
            return this.insertAt(newItem, index);
        },

        updateItem: function(item, oldItem)
        {
            var oldItemIndx = this._getItemByParam(oldItem);
            if (oldItemIndx && oldItemIndx.index != undefined) {
                return this.updateAt(item, oldItemIndx.index);
            }
            return false;
        },

        updateAt: function (item, index) {
            if (item != null) {
                var listBoxItem = this._mapItem(item);
                this.itemsByValue[$.trim(listBoxItem.value).split(" ").join("")] = this.items[index];

                this.items[index].value = listBoxItem.value;
                this.items[index].label = listBoxItem.label;
                this.items[index].html = listBoxItem.html;
                this.items[index].disabled = listBoxItem.disabled;

            }
            this._cachedItemHtml = [];
            this._renderItems();
            if (this.rendered) {
                this.rendered();
            }
        },

        // inserts an item at a specific position.
        insertAt: function (item, index) {
            if (item == null)
                return false;

            this._cachedItemHtml = [];
            if (this.items == undefined || this.items.length == 0) {
                this.source = new Array();
                this.refresh();
                var listBoxItem = this._mapItem(item);
                listBoxItem.index = 0;
                this.items[this.items.length] = listBoxItem;
                this._addItems(true);
                this._renderItems();
                if (this.rendered) {
                    this.rendered();
                }
                if (this.allowDrag && this._enableDragDrop) {
                    this._enableDragDrop();
                }
                var key = listBoxItem.value;
                if (listBoxItem.value == "" || listBoxItem.value == null) key = index;
                this.itemsByValue[$.trim(key).split(" ").join("")] = listBoxItem;

                return false;
            }

            var listBoxItem = this._mapItem(item);
            if (index == -1 || index == undefined || index == null || index >= this.items.length) {
                listBoxItem.index = this.items.length;
                this.items[this.items.length] = listBoxItem;
            }
            else {
                var itemsArray = new Array();
                var currentItemIndex = 0;
                var inserted = false;
                var visualItemIndex = 0;
                for (var itemIndex = 0; itemIndex < this.items.length; itemIndex++) {
                    if (this.items[itemIndex].isGroup == false) {
                        if (visualItemIndex >= index && !inserted) {
                            itemsArray[currentItemIndex++] = listBoxItem;
                            listBoxItem.index = index;
                            visualItemIndex++;
                            inserted = true;
                        }
                    }

                    itemsArray[currentItemIndex] = this.items[itemIndex];
                    if (!this.items[itemIndex].isGroup) {
                        itemsArray[currentItemIndex].index = visualItemIndex;
                        visualItemIndex++;
                    }
                    currentItemIndex++;
                }

                this.items = itemsArray;
            }
            var key = listBoxItem.value;
            if (listBoxItem.value == "" || listBoxItem.value == null) key = index;
            this.itemsByValue[$.trim(key).split(" ").join("")] = listBoxItem;

            this.visibleItems = new Array();
            this.renderedVisibleItems = new Array();
            var vScrollInstance = $.data(this.vScrollBar[0], 'jqxScrollBar').instance;
            var value = vScrollInstance.value;
            vScrollInstance.setPosition(0);
            if ((this.allowDrag && this._enableDragDrop) || (this.virtualSize && this.virtualSize.height < 10 + this.host.height())) {
                this._addItems(true);
            }
            else {
                this._addItems(false);
            }
            this._renderItems();
            if (this.allowDrag && this._enableDragDrop) {
                this._enableDragDrop();
            }
            vScrollInstance.setPosition(value);
            if (this.rendered) {
                this.rendered();
            }
            return true;
        },

        // removes an item from a specific position.
        removeAt: function (index) {
            if (index < 0 || index > this.items.length - 1)
                return false;

            var itemHeight = this.items[index].height;
            var key = this.items[index].value;
            if (key == "" || key == null) key = index;
            this.itemsByValue[$.trim(key).split(" ").join("")] = null;

            this.items.splice(index, 1);
            var itemsArray = new Array();
            var currentItemIndex = 0;
            var inserted = false;
            var visualItemIndex = 0;
            for (var itemIndex = 0; itemIndex < this.items.length; itemIndex++) {
                itemsArray[currentItemIndex] = this.items[itemIndex];
                if (!this.items[itemIndex].isGroup) {
                    itemsArray[currentItemIndex].index = visualItemIndex;
                    visualItemIndex++;
                }
                currentItemIndex++;
            }

            this.items = itemsArray;

            var vScrollInstance = $.data(this.vScrollBar[0], 'jqxScrollBar').instance;
            var vScrollInstance = $.data(this.vScrollBar[0], 'jqxScrollBar').instance;
            var value = vScrollInstance.value;
            vScrollInstance.setPosition(0);

            this.visibleItems = new Array();
            this.renderedVisibleItems = new Array();
            if (this.items.length > 0) {
                if (this.virtualSize) {
                    this.virtualSize.height -= itemHeight;
                    var virtualItemsCount = this.virtualSize.itemsPerPage * 2;
                    if (this.autoHeight) {
                        virtualItemsCount = this.items.length;
                    }

                    this.virtualItemsCount = Math.min(virtualItemsCount, this.items.length);
                }

                this._updatescrollbars();
            }
            else {
                this._addItems();
            }
            this._renderItems();
            if (this.allowDrag && this._enableDragDrop) {
                this._enableDragDrop();
            }
            if (this.vScrollBar.css('visibility') != 'hidden') {
                vScrollInstance.setPosition(value);
            }
            else {
                vScrollInstance.setPosition(0);
            }
            if (this.rendered) {
                this.rendered();
            }

            return true;
        },

        removeItem: function (item) {
            var newItem = this._getItemByParam(item);
            this.removeAt(newItem.index);
        },

        // gets all items.
        getItems: function () {
            return this.items;
        },

        disableItem: function (item) {
            var newItem = this._getItemByParam(item);
            this.disableAt(newItem.index);
        },

        enableItem: function (item) {
            var newItem = this._getItemByParam(item);
            this.enableAt(newItem.index);
        },

        // disables an item at position.
        disableAt: function (index) {
            if (!this.items)
                return false;

            if (index < 0 || index > this.items.length - 1)
                return false;

            this.items[index].disabled = true;
            this._renderItems();
            return true;
        },

        // enables an item at position.
        enableAt: function (index) {
            if (!this.items)
                return false;

            if (index < 0 || index > this.items.length - 1)
                return false;

            this.items[index].disabled = false;
            this._renderItems();
            return true;
        },

        destroy: function () {
            if (this.source && this.source.unbindBindingUpdate) {
                this.source.unbindBindingUpdate(this.element.id);
            }

            this._removeHandlers();
            this.vScrollBar.jqxScrollBar('destroy');
            this.hScrollBar.jqxScrollBar('destroy');
            this.vScrollBar.remove();
            this.hScrollBar.remove();
            this.content.remove();
            $.jqx.utilities.resize(this.host, null, true);

            var vars = $.data(this.element, "jqxListBox");
            delete this.hScrollInstance;
            delete this.vScrollInstance;
            delete this.vScrollBar;
            delete this.hScrollBar;
            delete this.content;
            delete this.bottomRight;
            delete this.itemswrapper;
            delete this.visualItems;
            delete this.visibleItems;
            delete this.items;
            delete this.groups;
            delete this.renderedVisibleItems;
            delete this._mousewheelfunc;
            delete this._mousemovefunc;
            delete this._cachedItemHtml;
            delete this.itemsByValue;
            delete this._activeElement;
            delete this.source;
            delete this.events;
      
            if (this.input) {
                this.input.remove();
                delete this.input;
            }
            if (vars) {
                delete vars.instance;
            }
            this.host.removeData();
            this.host.removeClass();
            this.host.remove();
            this.element = null;
            delete this.element;
            this.host = null;
            delete this.set;
            delete this.get;
            delete this.call;
            delete this.host;
        },

        _raiseEvent: function (id, arg) {
            if (this._stopEvents == true)
                return true;

            if (arg == undefined)
                arg = { owner: null };

            var evt = this.events[id];
            args = arg;
            args.owner = this;
            this._updateInputSelection();
            var event = new jQuery.Event(evt);
            event.owner = this;
            event.args = args;
            if (this.host != null) {
                var result = this.host.trigger(event);
            }
            return result;
        }
    })
})(jQuery);

(function ($) {
    $.jqx._jqxListBox.item = function () {
        var result =
        {
            group: '',
            groupHtml: '',
            selected: false,
            isGroup: false,
            highlighted: false,
            value: null,
            label: '',
            html: null,
            visible: true,
            disabled: false,
            element: null,
            width: null,
            height: null,
            initialTop: null,
            top: null,
            left: null,
            title: '',
            index: -1,
            checkBoxElement: null,
            originalItem: null,
            checked: false,
            visibleIndex: -1
        }
        return result;
    }
})(jQuery);
(function ($) {

    $.jqx.jqxWidget("jqxTree", "", {});

    $.extend($.jqx._jqxTree.prototype, {
        defineInstance: function () {
            //Type: Array
            //Gets the tree's items.
            this.items = new Array();
            //Type: Number.
            //Default: null.
            //Sets the width.
            this.width = null;
            //Type: Number.
            //Default: null.
            //Sets the height.
            this.height = null;
            //Type: String.
            //Default: easeInOutSine.
            //Gets or sets the animation's easing to one of the JQuery's supported easings.         
            this.easing = 'easeInOutCirc';
            //Type: Number.
            //Default: 'fast'.
            //Gets or sets the duration of the show animation.         
            this.animationShowDuration = 'fast';
            //Type: Number.
            //Default: 'fast'.
            //Gets or sets the duration of the hide animation.
            this.animationHideDuration = 'fast';
            //Type: Array.
            this.treeElements = new Array();
            //Type: Boolean.
            //Default: true.
            //Enables or disables the tree.
            this.disabled = false;
            // Type: Boolean
            // Default: true
            // enables or disables the hover state.
            this.enableHover = true;
            // Type: Boolean
            // Default: true
            // enables or disables the key navigation.
            this.keyboardNavigation = true;
            this.enableKeyboardNavigation = true;
            // Type: String
            // Default: click
            // Gets or sets user interaction used for expanding or collapsing any item. Possible values ['click', 'dblclick'].
            this.toggleMode = 'dblclick';
            // Type: Object
            // Default: null
            // data source.
            this.source = null;
            // Type: Boolean
            // Default: false
            // Gets or sets whether the tree should display a checkbox next to each item.
            this.checkboxes = false;
            this.checkSize = 13;
            this.toggleIndicatorSize = 16;
            // Type: Boolean
            // Default: false
            // Gets or sets whether the tree checkboxes have three states - checked, unchecked and indeterminate.           
            this.hasThreeStates = false;
            // Type: Object
            // Default: null
            // Private
            // gets the selected item. To select an item, use the selectItem function.
            this.selectedItem = null;
            this.touchMode = 'auto';
            // tree events.
            // expand is triggered when the user expands a tree item.
            // collapse is triggered when the user collapses a tree item.
            // select is triggered when the user selects a tree item.
            // add is triggered when the user adds a new tree item.
            // remove is triggered when the user removes a tree item.
            // checkchange is triggered when the user checks, unchecks or the checkbox is in indeterminate state.
            this.allowDrag = true;
            this.allowDrop = true;
            this.searchMode = 'startswithignorecase';
            this.incrementalSearch = true;
            this.incrementalSearchDelay = 700;
            this.animationHideDelay = 0;
            this.submitCheckedItems = false;
            this.dragStart = null;
            this.dragEnd = null;
            this.rtl = false;
            // Possible values: 'none, 'default', 'copy'
            this.dropAction = 'default';
            this.events =
		    [
                'expand', 'collapse', 'select', 'initialized', 'added', 'removed', 'checkChange', 'dragEnd', 'dragStart'
		    ];
            this.aria =
            {
                "aria-activedescendant": { name: "getActiveDescendant", type: "string" },
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
        },

        createInstance: function (args) {
            var self = this;
            this.host.attr('role', 'tree');
            this.host.attr('data-role', 'treeview');

            this.propertyChangeMap['disabled'] = function (instance, key, oldVal, value) {
                if (self.disabled) {
                    self.host.addClass(self.toThemeProperty('jqx-tree-disabled'));
                }
                else {
                    self.host.removeClass(self.toThemeProperty('jqx-tree-disabled'));
                }
                $.jqx.aria(self, "aria-disabled", value);
            }

            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                this.host.width(this.width);
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    this.host.width(this.width);
                };

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                this.host.height(this.height);
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                this.host.height(this.height);
            };

            if (this.width != null && this.width.toString().indexOf("%") != -1) {
                this.host.width(this.width);
            }
            if (this.height != null && this.height.toString().indexOf("%") != -1) {
                this.host.height(this.height);
            }

            this.host.attr('tabIndex', 1);

            if (this.disabled) {
                this.host.addClass(this.toThemeProperty('jqx-tree-disabled'));
                $.jqx.aria(this, "aria-disabled", true);
            }

            if (this.host.jqxDragDrop) {
                jqxTreeDragDrop();
            }

            this.originalInnerHTML = this.element.innerHTML;
            this.createdTree = false;
            if (this.element.innerHTML.indexOf('UL')) {
                var innerElement = this.host.find('ul:first');
                if (innerElement.length > 0) {
                    this.createTree(innerElement[0]);
                    this.createdTree = true;
                }
            }

            if (this.source != null) {
                var html = this.loadItems(this.source);
                this.element.innerHTML = html;
                var innerElement = this.host.find('ul:first');
                if (innerElement.length > 0) {
                    this.createTree(innerElement[0]);
                    this.createdTree = true;
                }
            }

            this._itemslength = this.items.length;

            if (!this.createdTree) {
                if (this.host.find('ul').length == 0) {
                    this.host.append($('<ul></ul>'));
                    var innerElement = this.host.find('ul:first');
                    if (innerElement.length > 0) {
                        this.createTree(innerElement[0]);
                        this.createdTree = true;
                    }

                    this.createdTree = true;
                }
            }

            if (this.createdTree == true) {
                this._render();
                this._handleKeys();
            }

            this._updateCheckLayout();
        },

        checkItems: function (item, baseItem) {
            var me = this;
            if (item != null) {
                var count = 0;
                var hasIndeterminate = false;
                var itemsCount = 0;

                var childItems = $(item.element).find('li');
                itemsCount = childItems.length;

                $.each(childItems, function (index) {
                    var child = me.itemMapping["id" + this.id].item;
                    if (child.checked != false) {
                        if (child.checked == null) {
                            hasIndeterminate = true;
                        }
                        count++;
                    }
                });

                if (item != baseItem) {
                    if (count == itemsCount) {
                        this.checkItem(item.element, true, 'tree');
                    }
                    else {
                        if (count > 0) {
                            this.checkItem(item.element, null, 'tree');
                        }
                        else this.checkItem(item.element, false, 'tree');

                    }
                }
                else {
                    var checked = baseItem.checked;
                    var childItems = $(baseItem.element).find('li');
                    $.each(childItems, function () {
                        var child = me.itemMapping["id" + this.id].item;
                        me.checkItem(this, checked, 'tree');
                    });
                }

                this.checkItems(this._parentItem(item), baseItem);
            }
            else {
                var checked = baseItem.checked;
                var childItems = $(baseItem.element).find('li');
                $.each(childItems, function () {
                    var child = me.itemMapping["id" + this.id].item;
                    me.checkItem(this, checked, 'tree');
                });
            }
        },

        _handleKeys: function () {
            var self = this;
            this.addHandler(this.host, 'keydown', function (event) {
                var key = event.keyCode;
                if (self.keyboardNavigation || self.enableKeyboardNavigation) {
                    if (self.selectedItem != null) {
                        var element = self.selectedItem.element;

                        switch (key) {
                            case 32:
                                if (self.checkboxes) {
                                    self.fromKey = true;
                                    var checked = $(self.selectedItem.checkBoxElement).jqxCheckBox('checked');
                                    self.checkItem(self.selectedItem.element, !checked, 'tree');
                                    if (self.hasThreeStates) {
                                        self.checkItems(self.selectedItem, self.selectedItem);
                                    }
                                    return false;
                                }
                                return true;
                            case 33:
                                var itemsOnPage = self._getItemsOnPage();
                                var prevItem = self.selectedItem;
                                for (var i = 0; i < itemsOnPage; i++) {
                                    prevItem = self._prevVisibleItem(prevItem);
                                }
                                if (prevItem != null) {
                                    self.selectItem(prevItem.element);
                                    self.ensureVisible(prevItem.element);
                                }
                                else {
                                    self.selectItem(self._firstItem().element);
                                    self.ensureVisible(self._firstItem().element);
                                }
                                return false;
                            case 34:
                                var itemsOnPage = self._getItemsOnPage();
                                var nextItem = self.selectedItem;
                                for (var i = 0; i < itemsOnPage; i++) {
                                    nextItem = self._nextVisibleItem(nextItem);
                                }
                                if (nextItem != null) {
                                    self.selectItem(nextItem.element);
                                    self.ensureVisible(nextItem.element);
                                }
                                else {
                                    self.selectItem(self._lastItem().element);
                                    self.ensureVisible(self._lastItem().element);
                                }
                                return false;
                            case 37:                             
                            case 39:
                                if ((key == 37 && !self.rtl) || (key == 39 && self.rtl)) {
                                    if (self.selectedItem.hasItems && self.selectedItem.isExpanded) {
                                        self.collapseItem(element);
                                    }
                                    else {
                                        var parentItem = self._parentItem(self.selectedItem);
                                        if (parentItem != null) {
                                            self.selectItem(parentItem.element);
                                            self.ensureVisible(parentItem.element);
                                        }
                                    }
                                }
                                if ((key == 39 && !self.rtl) || (key == 37 && self.rtl)) {
                                    if (self.selectedItem.hasItems) {
                                        if (!self.selectedItem.isExpanded) {
                                            self.expandItem(element);
                                        }
                                        else {
                                            var nextItem = self._nextVisibleItem(self.selectedItem);
                                            if (nextItem != null) {
                                                self.selectItem(nextItem.element);
                                                self.ensureVisible(nextItem.element);
                                            }
                                        }
                                    }
                                }
                                return false;
                            case 13:
                                if (self.selectedItem.hasItems) {
                                    if (self.selectedItem.isExpanded) {
                                        self.collapseItem(element);
                                    }
                                    else {
                                        self.expandItem(element);
                                    }
                                }
                                return false;
                            case 36:
                                self.selectItem(self._firstItem().element);
                                self.ensureVisible(self._firstItem().element);
                                return false;
                            case 35:
                                self.selectItem(self._lastItem().element);
                                self.ensureVisible(self._lastItem().element);
                                return false;
                            case 38:
                                var prevItem = self._prevVisibleItem(self.selectedItem);
                                if (prevItem != null) {
                                    self.selectItem(prevItem.element);
                                    self.ensureVisible(prevItem.element);
                                }
                                return false;
                            case 40:
                                var nextItem = self._nextVisibleItem(self.selectedItem);
                                if (nextItem != null) {
                                    self.selectItem(nextItem.element);
                                    self.ensureVisible(nextItem.element);
                                }
                                return false;
                        }
                    }
                }
            });
        },

        _firstItem: function () {
            var item = null;
            var me = this;
            var innerElement = this.host.find('ul:first');
            var liTags = $(innerElement).find('li');

            for (i = 0; i <= liTags.length - 1; i++) {
                var listTag = liTags[i];
                item = this.itemMapping["id" + listTag.id].item;
                if (me._isVisible(item)) {
                    return item;
                }
            }

            return null;
        },

        _lastItem: function () {
            var item = null;
            var me = this;
            var innerElement = this.host.find('ul:first');
            var liTags = $(innerElement).find('li');

            for (i = liTags.length - 1; i >= 0; i--) {
                var listTag = liTags[i];
                item = this.itemMapping["id" + listTag.id].item;
                if (me._isVisible(item)) {
                    return item;
                }
            }

            return null;
        },

        _parentItem: function (item) {
            if (item == null || item == undefined)
                return null;

            var parent = item.parentElement;
            if (!parent) return null;
            var parentItem = null;

            $.each(this.items, function () {
                if (this.element == parent) {
                    parentItem = this;
                    return false;
                }
            });

            return parentItem;
        },

        _nextVisibleItem: function (item) {
            if (item == null || item == undefined)
                return null;

            var currentItem = item;
            while (currentItem != null) {
                currentItem = currentItem.nextItem;
                if (this._isVisible(currentItem) && !currentItem.disabled)
                    return currentItem;
            }

            return null;
        },

        _prevVisibleItem: function (item) {
            if (item == null || item == undefined)
                return null;

            var currentItem = item;
            while (currentItem != null) {
                currentItem = currentItem.prevItem;
                if (this._isVisible(currentItem) && !currentItem.disabled)
                    return currentItem;
            }

            return null;
        },

        _isVisible: function (item) {
            if (item == null || item == undefined)
                return false;

            if (!this._isElementVisible(item.element))
                return false;

            var currentItem = this._parentItem(item);

            if (currentItem == null)
                return true;

            if (currentItem != null) {
                if (!this._isElementVisible(currentItem.element)) {
                    return false;
                }

                if (currentItem.isExpanded) {
                    while (currentItem != null) {
                        currentItem = this._parentItem(currentItem);
                        if (currentItem != null && !this._isElementVisible(currentItem.element)) {
                            return false;
                        }

                        if (currentItem != null && !currentItem.isExpanded)
                            return false;
                    }
                }
                else {
                    return false;
                }
            }

            return true;
        },

        _getItemsOnPage: function () {
            var itemsCount = 0;
            var position = this.panel.jqxPanel('getVScrollPosition');
            var height = parseInt(this.host.height());
            var itemsHeight = 0;
            var firstItem = this._firstItem();

            if (parseInt($(firstItem.element).height()) > 0) {
                while (itemsHeight <= height) {
                    itemsHeight += parseInt($(firstItem.element).outerHeight());
                    itemsCount++;
                }
            }

            return itemsCount;
        },

        _isElementVisible: function (element) {
            if (element == null)
                return false;

            if ($(element).css('display') != 'none' && $(element).css('visibility') != 'hidden') {
                return true;
            }

            return false;
        },

        refresh: function (initialRefresh) {
            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                this.host.width(this.width);
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    this.host.width(this.width);
                };

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                this.host.height(this.height);
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                this.host.height(this.height);
            };

            if (this.panel) {
                if (this.width != null && this.width.toString().indexOf("%") != -1) {
                    var me = this;
                    this.panel.jqxPanel('width', '100%');
                    me.removeHandler($(window), 'resize.jqxtree' + me.element.id);
                    me.addHandler($(window), 'resize.jqxtree' + me.element.id,
                    function () {
                        me._calculateWidth();
                    });
                }
                else {
                    this.panel.jqxPanel('width', this.host.width());
                }
                this.panel.jqxPanel('_arrange');
            }
            this._calculateWidth();
            if ($.jqx.isHidden(this.host)) {
                var me = this;
                this._hiddenTimer = setInterval(function () {
                    if (!$.jqx.isHidden(me.host)) {
                        clearInterval(me._hiddenTimer);
                        me._calculateWidth();
                    }
                }, 100);
            }
            if (initialRefresh != true) {
                if (this.checkboxes) {
                    this._updateCheckLayout(null);
                }
            }
        },

        loadItems: function (items) {
            if (items == null) {
                return;
            }

            var self = this;
            this.items = new Array();
            var html = '<ul>';
            $.map(items, function (item) {
                if (item == undefined)
                    return null;

                html += self._parseItem(item);
            });

            html += '</ul>';
            return html;
        },

        _parseItem: function (item) {
            var html = "";

            if (item == undefined)
                return null;

            var label = item.label;
            if (!item.label && item.html) {
                label = item.html;
            }
            if (!label) {
                label = "Item";
            }

            if (typeof item === 'string') {
                label = item;
            }

            var expanded = false;
            if (item.expanded != undefined && item.expanded) {
                expanded = true;
            }

            var locked = false;
            if (item.locked != undefined && item.locked) {
                locked = true;
            }

            var selected = false;
            if (item.selected != undefined && item.selected) {
                selected = true;
            }

            var disabled = false;
            if (item.disabled != undefined && item.disabled) {
                disabled = true;
            }

            var checked = false;
            if (item.checked != undefined && item.checked) {
                checked = true;
            }

            var icon = item.icon;
            var iconsize = item.iconsize;

            html += '<li';
            if (expanded) {
                html += ' item-expanded="true" ';
            }

            if (locked) {
                html += ' item-locked="true" ';
            }

            if (disabled) {
                html += ' item-disabled="true" ';
            }

            if (selected) {
                html += ' item-selected="true" ';
            }

            if (iconsize) {
                html += ' item-iconsize="' + item.iconsize + '" ';
            }

            if (icon != null && icon != undefined) {
                html += ' item-icon="' + icon + '" ';
            }

            if (item.label && !item.html) {
                html += ' item-label="' + label + '" ';
            }

            if (item.value != null) {
                html += ' item-value="' + item.value + '" ';
            }

            if (item.checked != undefined) {
                html += ' item-checked="' + checked + '" ';
            }

            var id = "";
            if (item.id != undefined) {
                id = item.id;
                html += ' id="' + id + '" ';
            }
            else {
                id = this.createID();
                html += ' id="' + id + '" ';
            }

            html += '>' + label;

            if (item.items) {
                html += this.loadItems(item.items);
            }
            if (!this._valueList) this._valueList = new Array();
            this._valueList[id] = item.value;

            html += '</li>';
            return html;
        },

        // ensures the visibility of an element.
        // @ param element.
        ensureVisible: function (element) {
            if (element == null || element == undefined)
                return;

            var position = this.panel.jqxPanel('getVScrollPosition');
            var hposition = this.panel.jqxPanel('getHScrollPosition');
            var height = parseInt(this.host.height());
            var elementPosition = $(element).position().top;

            if (elementPosition <= position || elementPosition >= height + position) {
                this.panel.jqxPanel('scrollTo', hposition, elementPosition - height + $(element).outerHeight());
            }
        },

        _syncItems: function (elements) {
            this._visibleItems = new Array();
            var me = this;
            $.each(elements, function () {
                var $element = $(this);
                if ($element.css('display') != 'none') {
                    var height = $element.outerHeight();
                    if ($element.height() > 0) {
                        var top = parseInt($element.offset().top);
                        me._visibleItems[me._visibleItems.length] = { element: this, top: top, height: height, bottom: top + height };
                    }
                }
            });
        },

        hitTest: function (left, top) {
            var me = this;
            var treeInstance = this;
            var treeItem = null;
            var elements = this.host.find('.draggable');
            this._syncItems(elements);

            if (treeInstance._visibleItems) {
                var hostLeft = parseInt(treeInstance.host.offset().left);
                var hostWidth = treeInstance.host.outerWidth();

                $.each(treeInstance._visibleItems, function (index) {
                    if (left >= hostLeft && left < hostLeft + hostWidth)
                        if (this.top + 5 < top && top < this.top + this.height) {
                            var parentElement = $(this.element).parents('li:first');
                            if (parentElement.length > 0) {
                                treeItem = treeInstance.getItem(parentElement[0]);
                                if (treeItem != null) {
                                    treeItem.height = this.height;
                                    treeItem.top = this.top;
                                    return false;
                                }
                            }
                        }
                });
            }
            return treeItem;
        },

        addBefore: function(items, sibling, refresh)
        {
            return this.addBeforeAfter(items, sibling, true, refresh);
        },

        addAfter: function (items, sibling, refresh) {
            return this.addBeforeAfter(items, sibling, false, refresh);
        },

        addBeforeAfter: function (items, sibling, before, refresh) {
            var treeInstance = this;

            var array = new Array();

            if (sibling && sibling.treeInstance != undefined) {
                sibling = sibling.element;
            }

            if (!$.isArray(items)) {
                array[0] = items;
            }
            else array = items;

            var html = "";
            var me = this;
            $.each(array, function () {
                html += me._parseItem(this);
            });
            var el = $(html);
            if (treeInstance.element.innerHTML.indexOf('UL')) {
                var innerElement = treeInstance.host.find('ul:first');
            }

            if (sibling == undefined && sibling == null) {
                innerElement.append(el);
            }
            else {
                if (before) {
                    $(sibling).before(el);
                }
                else {
                    $(sibling).after(el);
                }
            }

            var liTags = el;
            for (var index = 0; index < liTags.length; index++) {
                this._createItem(liTags[index]);
                var subTags = $(liTags[index]).find('li');
                if (subTags.length > 0) {
                    for (var j = 0; j < subTags.length; j++) {
                        this._createItem(subTags[j]);
                    }
                }
            }

            var update = function (drag) {
                me._refreshMapping(false);
                me._updateItemsNavigation();
                if (drag && me.allowDrag && me._enableDragDrop) {
                    me._enableDragDrop();
                }
                if (me.selectedItem != null) {
                    $(me.selectedItem.titleElement).addClass(me.toThemeProperty('jqx-fill-state-pressed'));
                    $(me.selectedItem.titleElement).addClass(me.toThemeProperty('jqx-tree-item-selected'));
                }
            }

            if (refresh == false) {
                update(true);
                this._raiseEvent('4', { items: this.getItems() });
                return;
            }

            update(false);
            me._render();
            this._raiseEvent('4', { items: this.getItems() });
            if (me.checkboxes) {
                me._updateCheckLayout(null);
            }
        },

        addTo: function (items, parentElement, refresh) {
            var treeInstance = this;

            var array = new Array();

            if (parentElement && parentElement.treeInstance != undefined) {
                parentElement = parentElement.element;
            }

            if (!$.isArray(items)) {
                array[0] = items;
            }
            else array = items;

            var html = "";
            var me = this;
            $.each(array, function () {
                html += me._parseItem(this);
            });
            var el = $(html);
            if (treeInstance.element.innerHTML.indexOf('UL')) {
                var innerElement = treeInstance.host.find('ul:first');
            }

            if (parentElement == undefined && parentElement == null) {
                innerElement.append(el);
            }
            else {
                parentElement = $(parentElement);
                var parentUL = parentElement.find('ul:first');
                if (parentUL.length == 0) {
                    ulElement = $('<ul></ul>');
                    $(parentElement).append(ulElement);
                    parentUL = parentElement.find('ul:first');
                    var item = treeInstance.itemMapping["id" + parentElement[0].id].item;
                    item.subtreeElement = parentUL[0];
                    item.hasItems = true;
                    parentUL.addClass(treeInstance.toThemeProperty('jqx-tree-dropdown'));
                    if (me.rtl) {
                        parentUL.addClass(treeInstance.toThemeProperty('jqx-tree-dropdown-rtl'));
                    }
                    parentUL.append(el);
                    var element = parentUL.find('li:first');
                    item.parentElement = element;
                }
                else {
                    parentUL.append(el);
                }
            }

            var liTags = el;
            for (var index = 0; index < liTags.length; index++) {
                this._createItem(liTags[index]);
                var subTags = $(liTags[index]).find('li');
                if (subTags.length > 0) {
                    for (var j = 0; j < subTags.length; j++) {
                        this._createItem(subTags[j]);
                    }
                }
            }

            var update = function (drag) {
                me._refreshMapping(false);
                me._updateItemsNavigation();
                if (drag && me.allowDrag && me._enableDragDrop) {
                    me._enableDragDrop();
                }
                if (me.selectedItem != null) {
                    $(me.selectedItem.titleElement).addClass(me.toThemeProperty('jqx-fill-state-pressed'));
                    $(me.selectedItem.titleElement).addClass(me.toThemeProperty('jqx-tree-item-selected'));
                }
            }

            if (refresh == false) {
                update(true);
                this._raiseEvent('4', { items: this.getItems() });
                return;
            }

            update(false);
            me._render();
            if (me.checkboxes) {
                me._updateCheckLayout(null);
            }
            this._raiseEvent('4', { items: this.getItems() });
        },

        updateItem: function(element, content)
        {
            var item = element.treeInstance != undefined ? element : this.getItem(element);
            if (!item) {
                var tmp = element;
                element = content;
                content = tmp;
                var item = element.treeInstance != undefined ? element : this.getItem(element);
            }

            if (item) {
                if (typeof (content) === "string") {
                    content = { label: content };
                }

                if (content.value) {
                    item.value = content.value;
                }
                if (content.label) {
                    item.label = content.label;
                    $.jqx.utilities.html($(item.titleElement), content.label);
                    var ie7 = $.jqx.browser.msie && $.jqx.browser.version < 8;
                    if (ie7) {
                        $(document.body).append(this._measureItem);
                        this._measureItem.html($(item.titleElement).text());
                        var width = this._measureItem.width();
                        if (item.icon) {
                            width += 20;
                        }
                        if ($($(item.titleElement).find('img')).length > 0) {
                            width += 20;
                        }

                        $(item.titleElement).css('max-width', width + 'px');
                        this._measureItem.remove();
                    }
                }

                if (content.icon) {
                    if ($(item.element).children('.itemicon').length > 0) {
                        $(item.element).find('.itemicon')[0].src = content.icon;
                    }
                    else {
                        var iconsize = content.iconsize;
                        if (!iconsize) iconsize = 16;

                        var icon = $('<img width="' + iconsize + '" height="' + iconsize + '" style="float: left;" class="itemicon" src="' + content.icon + '"/>');
                        $(item.titleElement).prepend(icon);
                        icon.css('margin-right', '4px');
                        if (this.rtl) {
                            icon.css('margin-right', '0px');
                            icon.css('margin-left', '4px');
                            icon.css('float', 'right');
                        }
                    }
                }

                if (content.expanded) {
                    this.expandItem(item);
                }
                if (content.disabled) {
                    this.disableItem(item);
                }
                if (content.selected) {
                    this.selectItem(item);
                }
                return true;
            }
           
            return false;
        },
        // removes an element.
        // @param element
        removeItem: function (element, refresh) {
            if (element == undefined || element == null) {
                return;
            }

            if (element.treeInstance != undefined) element = element.element;

            var me = this;
            var id = element.id;

            var itemIndex = -1;
            var itemToRemove = this.getItem(element);
            if (itemToRemove) {
                itemIndex = this.items.indexOf(itemToRemove);
                if (itemIndex != -1) {
                   (function removeItemFunc(item) {
                        var itemIndex = -1;
                        itemIndex = this.items.indexOf(item);
                        if (itemIndex != -1) {
                            this.items.splice(itemIndex, 1);
                        }
                        var itemElements = $(item.element).find('li');
                        var itemsCount = itemElements.length;
                        var me = this;
                        var items = new Array();
                        if (itemsCount > 0) {
                            $.each(itemElements, function (index) {
                                var child = me.itemMapping["id" + this.id].item;
                                items.push(child);
                            });

                            for (var i = 0; i < items.length; i++) {
                                removeItemFunc.apply(this, [items[i]]);
                            }
                        }
                    }).apply(this, [itemToRemove]);
                }
            }
            if (this.host.find('#' + element.id).length > 0) {
                $(element).remove();
            }
            
            if (refresh == false) {
                this._raiseEvent('5');
                return;
            }

            me._updateItemsNavigation();
            me._render();
            if (me.selectedItem != null) {
                if (me.selectedItem.element == element) {
                    $(me.selectedItem.titleElement).removeClass(me.toThemeProperty('jqx-fill-state-pressed'));
                    $(me.selectedItem.titleElement).removeClass(me.toThemeProperty('jqx-tree-item-selected'));
                    me.selectedItem = null;
                }
            }
            this._raiseEvent('5');
            if (me.checkboxes) {
                me._updateCheckLayout(null);
            }
        },

        clear: function () {
            this.items = new Array();
            this.itemMapping = new Array();
            var element = this.host.find('ul:first');
            if (element.length > 0) {
                element[0].innerHTML = "";
            }
            this.selectedItem = null;
        },

        // disables a tree item.
        // @param element
        disableItem: function (element) {
            if (element == null)
                return false;
            if (element.treeInstance != undefined) element = element.element;

            var me = this;
            $.each(me.items, function () {
                var item = this;
                if (item.element == element) {
                    // me.collapseItem(item.element);
                    item.disabled = true;
                    //      $(item.titleElement).removeClass(me.toThemeProperty('jqx-fill-state-pressed'));
                    //      $(item.titleElement).removeClass(me.toThemeProperty('jqx-tree-item-selected'));
                    $(item.titleElement).addClass(me.toThemeProperty('jqx-fill-state-disabled'));
                    $(item.titleElement).addClass(me.toThemeProperty('jqx-tree-item-disabled'));
                    if (me.checkboxes && item.checkBoxElement) {
                        $(item.checkBoxElement).jqxCheckBox({ disabled: true });
                    }
                    return false;
                }
            });
        },

        _updateInputSelection: function () {
            if (this.input) {
                if (this.selectedItem == null) {
                    this.input.val("");
                }
                else {
                    var label = this.selectItem.value;
                    if (label == null) label = this.selectedItem.label;
                    this.input.val(label);
                }
                if (this.checkboxes) {
                    var items = this.getCheckedItems();
                    if (this.submitCheckedItems) {
                        var str = "";
                        for (var i = 0; i < items.length; i++) {
                            var value = items[i].value;
                            if (value == null) value = items[i].label;
                            if (i == items.length - 1) {
                                str += value;
                            }
                            else {
                                str += value + ",";
                            }
                        }
                        this.input.val(str);
                    }
                }
            }
        },

        getCheckedItems: function () {
            var checkedItems = new Array();
            var me = this;
            $.each(me.items, function () {
                var item = this;
                if (item.checked) checkedItems.push(item);
            });
            return checkedItems;
        },

        getUncheckedItems: function () {
            var checkedItems = new Array();
            var me = this;
            $.each(me.items, function () {
                var item = this;
                if (!item.checked) checkedItems.push(item);
            });
            return checkedItems;
        },

        checkAll: function () {
            var me = this;
            $.each(me.items, function () {
                var item = this;
                if (!item.disabled) {
                    item.checked = true;
                    $(item.checkBoxElement).jqxCheckBox('_setState', true);
                }
            });
            this._raiseEvent('6', { element: this, checked: true });
        },

        uncheckAll: function () {
            var me = this;
            $.each(me.items, function () {
                var item = this;
                if (!item.disabled) {
                    item.checked = false;
                    $(item.checkBoxElement).jqxCheckBox('_setState', false);
                }
            });
            this._raiseEvent('6', { element: this, checked: false });
        },

        // checks a tree item.
        // @param element
        // @param checked state - true, false or null
        checkItem: function (element, checked, owner) {
            if (element == null)
                return false;

            if (checked === undefined) {
                checked = true;
            }

            if (element.treeInstance != undefined) element = element.element;

            var me = this;
            var stateChanged = false;
            var treeItem = null;
            $.each(me.items, function () {
                var item = this;
                if (item.element == element && !item.disabled) {
                    stateChanged = true;
                    item.checked = checked;
                    treeItem = item;
                    $(item.checkBoxElement).jqxCheckBox({ checked: checked });
                    return false;
                }
            });

            if (stateChanged) {
                this._raiseEvent('6', { element: element, checked: checked });
                this._updateInputSelection();
            }
            if (owner == undefined) {
                if (treeItem) {
                    if (this.hasThreeStates) {
                        this.checkItems(treeItem, treeItem);
                    }
                }
            }
        },

        uncheckItem: function (element) {
            this.checkItem(element, false);
        },

        // enables a tree item.
        // @param element
        enableItem: function (element) {
            if (element == null)
                return false;

            if (element.treeInstance != undefined) element = element.element;

            var me = this;
            $.each(me.items, function () {
                var item = this;
                if (item.element == element) {
                    item.disabled = false;
                    $(item.titleElement).removeClass(me.toThemeProperty('jqx-fill-state-disabled'));
                    $(item.titleElement).removeClass(me.toThemeProperty('jqx-tree-item-disabled'));
                    if (me.checkboxes && item.checkBoxElement) {
                        $(item.checkBoxElement).jqxCheckBox({ disabled: false });
                    }
                    return false;
                }
            });
        },

        // enables all items.
        enableAll: function () {
            var me = this;
            $.each(me.items, function () {
                var item = this;
                item.disabled = false;
                $(item.titleElement).removeClass(me.toThemeProperty('jqx-tree-item-disabled'));
                $(item.titleElement).removeClass(me.toThemeProperty('jqx-fill-state-disabled'));
                if (me.checkboxes && item.checkBoxElement) {
                    $(item.checkBoxElement).jqxCheckBox({ disabled: false });
                }
            });
        },

        // locks a tree item.
        // @param element
        lockItem: function (element) {
            if (element == null)
                return false;

            var me = this;
            $.each(me.items, function () {
                var item = this;
                if (item.element == element) {
                    item.locked = true;
                    return false;
                }
            });
        },

        // unlocks a tree item.
        // @param element
        unlockItem: function (element) {
            if (element == null)
                return false;

            var me = this;
            $.each(me.items, function () {
                var item = this;
                if (item.element == element) {
                    item.locked = false;
                    return false;
                }
            });
        },

        // gets all tree items.
        getItems: function () {
            return this.items;
        },

        // gets item's instance.
        getItem: function (element) {
            if (element == null || element == undefined)
                return null;

            if (this.itemMapping["id" + element.id]) {
                var item = this.itemMapping["id" + element.id].item;
                return item;
            }

            return null;
        },

        // gets whether the element is expanded.
        isExpanded: function (element) {
            if (element == null || element == undefined)
                return false;

            var item = this.itemMapping["id" + element.id].item;
            if (item != null) {
                return item.isExpanded;
            }

            return false;
        },

        // gets whether the element is selected.
        isSelected: function (element) {
            if (element == null || element == undefined)
                return false;

            var item = this.itemMapping["id" + element.id].item;
            if (item != null) {
                return item == this.selectedItem;
            }

            return false;
        },

        getPrevItem: function (element) {
            var item = this.getItem(element);
            if (element.treeInstance != undefined) item = element;
            var prevItem = this._prevVisibleItem(item);
            return prevItem;
        },

        getNextItem: function (element) {
            var item = this.getItem(element);
            if (element.treeInstance != undefined) item = element;

            var nextItem = this._nextVisibleItem(item);
            return nextItem;
        },

        getSelectedItem: function (element) {
            return this.selectedItem;
        },

        val: function (value) {
            if (arguments.length == 0 || typeof (value) == "object") {
                return this.selectedItem;
            }
            if (typeof value == "string") {
                var element = this.host.find("#" + value);
                if (element.length > 0) {
                    var item = this.getItem(element[0]);
                    this.selectItem(item);
                }
            }
            else {
                var item = this.getItem(value);
                this.selectItem(item);
            }
        },

        getActiveDescendant: function()
        {
            if (this.selectedItem) {
                return this.selectedItem.element.id;
            }
            return "";
        },

        // selects an item.
        // @param element
        selectItem: function (element) {
            if (this.disabled)
                return;

            var me = this;

            if (element && element.treeInstance != undefined) element = element.element;

            if (element == null || element == undefined) {
                if (me.selectedItem != null) {
                    $(me.selectedItem.titleElement).removeClass(me.toThemeProperty('jqx-fill-state-pressed'));
                    $(me.selectedItem.titleElement).removeClass(me.toThemeProperty('jqx-tree-item-selected'));
                    me.selectedItem = null;
                }
                return;
            }

            if (this.selectedItem != null && this.selectedItem.element == element)
                return;

            var oldSelectedElement = this.selectedItem != null ? this.selectedItem.element : null;
            if (oldSelectedElement) {
                $(oldSelectedElement).removeAttr('aria-selected');
            }

            $.each(me.items, function () {
                var item = this;
                if (!item.disabled) {
                    if (item.element == element) {
                        if (me.selectedItem == null || (me.selectedItem != null && me.selectedItem.titleElement != item.titleElement)) {
                            if (me.selectedItem != null) {
                                $(me.selectedItem.titleElement).removeClass(me.toThemeProperty('jqx-fill-state-pressed'));
                                $(me.selectedItem.titleElement).removeClass(me.toThemeProperty('jqx-tree-item-selected'));
                            }

                            $(item.titleElement).addClass(me.toThemeProperty('jqx-fill-state-pressed'));
                            $(item.titleElement).addClass(me.toThemeProperty('jqx-tree-item-selected'));
                            me.selectedItem = item;
                            $(item.element).attr('aria-selected', 'true');
                            $.jqx.aria(me, "aria-activedescendant", item.element.id);
                        }
                    }
                }
            });
            this._updateInputSelection();
            this._raiseEvent('2', { element: element, prevElement: oldSelectedElement });
        },

        // collapses all items.
        collapseAll: function () {
            var me = this;
            var items = me.items;
            $.each(items, function () {
                var item = this;
                if (item.isExpanded == true) {
                    me._collapseItem(me, item);
                }
            });
        },

        // expands all items.
        expandAll: function () {
            var me = this;

            $.each(this.items, function () {
                var item = this;
                if (item.hasItems) {
                    me._expandItem(me, item);
                }
            });
        },

        //  @param element
        //  expands a tree item by its html element.
        collapseItem: function (element) {
            if (element == null)
                return false;

            if (element.treeInstance != undefined) element = element.element;

            var me = this;
            $.each(this.items, function () {
                var item = this;
                if (item.isExpanded == true && item.element == element) {
                    me._collapseItem(me, item);
                    return false;
                }
            });

            return true;
        },

        // @param element
        // expands a tree item by its html element.
        expandItem: function (element) {
            if (element == null)
                return false;

            if (element.treeInstance != undefined) element = element.element;

            var me = this;
            $.each(me.items, function () {
                var item = this;

                if (item.isExpanded == false && item.element == element && !item.disabled && !item.locked) {
                    me._expandItem(me, item);
                    if (item.parentElement) {
                        me.expandItem(item.parentElement);
                    }
                }
            });

            return true;
        },

        _getClosedSubtreeOffset: function (item) {
            var $subtree = $(item.subtreeElement);
            var top = -$subtree.outerHeight();
            var left = -$subtree.outerWidth();
            left = 0;
            return { left: left, top: top };
        },

        _collapseItem: function (me, item, subs, force) {
            if (me == null || item == null)
                return false;

            if (item.disabled)
                return false;

            if (me.disabled)
                return false;

            if (me.locked)
                return false;

            var $subtree = $(item.subtreeElement);

            var subtreeOffset = this._getClosedSubtreeOffset(item);
            var top = subtreeOffset.top;
            var left = subtreeOffset.left;

            $treeElement = $(item.element);
            var delay = me.animationHideDelay;
            delay = 0;

            if ($subtree.data('timer').show != null) {
                clearTimeout($subtree.data('timer').show);
                $subtree.data('timer').show = null;
            }

            var hideFunc = function () {
                item.isExpanded = false;

                if (me.checkboxes) {
                    var checkboxes = $subtree.find('.chkbox');
                    checkboxes.stop();
                    checkboxes.css('opacity', 1);
                    $subtree.find('.chkbox').animate({ opacity: 0 }, 50);
                }
                var $arrowSpan = $(item.arrow);
                me._arrowStyle($arrowSpan, "", item.isExpanded);

                $subtree.slideUp(me.animationHideDuration, function () {
                    item.isCollapsing = false;
                    me._calculateWidth();
                    var $arrowSpan = $(item.arrow);
                    me._arrowStyle($arrowSpan, "", item.isExpanded);
                    $subtree.hide();
                    me._raiseEvent('1', { element: item.element });
                })
            }

            if (delay > 0) {
                $subtree.data('timer').hide = setTimeout(function () {
                    hideFunc();
                }, delay);
            }
            else {
                hideFunc();
            }
        },

        _expandItem: function (me, item) {
            if (me == null || item == null)
                return false;

            if (item.isExpanded)
                return false;

            if (item.locked)
                return false;

            if (item.disabled)
                return false;

            if (me.disabled)
                return false;

            var $subtree = $(item.subtreeElement);
            // stop hiding process.
            if (($subtree.data('timer')) != null && $subtree.data('timer').hide != null) {
                clearTimeout($subtree.data('timer').hide);
            }

            var $treeElement = $(item.element);

            var top = 0;
            var left = 0;

            if (parseInt($subtree.css('top')) == top) {
                item.isExpanded = true;
                return;
            }

            var $arrowSpan = $(item.arrow);
            me._arrowStyle($arrowSpan, "", item.isExpanded);


            if (me.checkboxes) {
                var checkboxes = $subtree.find('.chkbox');
                checkboxes.stop();
                checkboxes.css('opacity', 0);
                checkboxes.animate({ opacity: 1 }, me.animationShowDuration);
            }

            $subtree.slideDown(me.animationShowDuration, me.easing,
                        function () {
                            var $arrowSpan = $(item.arrow);
                            item.isExpanded = true;
                            me._arrowStyle($arrowSpan, "", item.isExpanded);
                            item.isExpanding = false;
                            me._raiseEvent('0', { element: item.element });
                            me._calculateWidth();
                        }) //animate subtree into view         
            //     }, 0);

            if (me.checkboxes) {
                me._updateCheckItemLayout(item);
                if (item.subtreeElement) {
                    var listTags = $(item.subtreeElement).find('li');
                    $.each(listTags, function () {
                        var subItem = me.getItem(this);
                        if (subItem != null) {
                            me._updateCheckItemLayout(subItem);
                        }
                    });
                }
            }
        },

        _calculateWidth: function () {
            var me = this;
            var checkboxOffset = this.checkboxes ? 20 : 0;
            var maxWidth = 0;

            $.each(this.items, function () {
                var height = $(this.element).height();
                if (height != 0) {
                    var titleWidth = this.titleElement.outerWidth() + 10 + checkboxOffset + (1 + this.level) * 20;
                    maxWidth = Math.max(maxWidth, titleWidth);
                    if (this.hasItems) {
                        var paddingOffset = parseInt($(this.titleElement).css('padding-top'));
                        if (isNaN(paddingOffset)) {
                            paddingOffset = 0;
                        }

                        paddingOffset = paddingOffset * 2;
                        paddingOffset += 2;

                        var offset = (paddingOffset + $(this.titleElement).height()) / 2 - 17 / 2;
                        if ($.jqx.browser.msie && $.jqx.browser.version < 9) {
                            $(this.arrow).css('margin-top', '3px');
                        }
                        else {
                            if (parseInt(offset) >= 0) {
                                $(this.arrow).css('margin-top', parseInt(offset) + 'px');
                            }
                        }
                    }
                }
            });

            if (this.toggleIndicatorSize > 16) {
                maxWidth = maxWidth + this.toggleIndicatorSize - 16;
            }

            if (me.panel) {
                if (maxWidth > this.host.width()) {
                    var scrollWidth = maxWidth - this.host.width();
                    var vScrollOffset = me.panel.jqxPanel('vScrollBar').css('visibility') !== "hidden" ? 10 : 0;
                    scrollWidth += vScrollOffset;
                    me.panel.jqxPanel({ horizontalScrollBarMax: scrollWidth });
                }
                else {
                    me.panel.jqxPanel({ horizontalScrollBarMax: 0 });
                }
            }

            this.host.find('ul:first').width(maxWidth);
            var minWidth = this.host.width() - 30;
            if (minWidth > 0) {
                this.host.find('ul:first').css('min-width', minWidth);
            }
            if (me.panel) {
                me.panel.jqxPanel('_arrange');
            }
        },

        _arrowStyle: function ($arrowSpan, uiState, expanded) {
            var me = this;
            if ($arrowSpan.length > 0) {
                $arrowSpan.removeClass();
                var state = "";
                if (uiState == 'hover') state = "-" + uiState;
                var expandState = expanded ? "-expand" : "-collapse";
                var className = 'jqx-tree-item-arrow' + expandState + state;
                $arrowSpan.addClass(me.toThemeProperty(className));
                if (this.rtl) {
                    $arrowSpan.addClass(me.toThemeProperty(className + '-rtl'));
                }
            }
        },

        _initialize: function (mode, oldmode) {
            var me = this;
            var maxHeight = 0;
            this.host.addClass(me.toThemeProperty('jqx-widget'));
            this.host.addClass(me.toThemeProperty('jqx-widget-content'));
            this.host.addClass(me.toThemeProperty('jqx-tree'));
            this._updateDisabledState();

            var ie7 = $.jqx.browser.msie && $.jqx.browser.version < 8;
            $.each(this.items, function () {
                var item = this;
                $element = $(item.element);
                var $arrowSpan = null;

                if (me.checkboxes && !item.hasItems && item.checkBoxElement) {
                    $(item.checkBoxElement).css('margin-left', '0px');
                }

                if (!ie7) {
                    if (!item.hasItems) {
                        if (!me.rtl) {
                            item.element.style.marginLeft = parseInt(me.toggleIndicatorSize) + 'px';
                        }
                        else {
                            item.element.style.marginRight = parseInt(me.toggleIndicatorSize) + 'px';
                        }
                        var oldArrow = $(item.arrow);
                        if (oldArrow.length > 0) {
                            oldArrow.remove();
                            item.arrow = null;
                        }
                        return true;
                    }
                    else item.element.style.marginLeft = '0px';
                }
                else {
                    if (!item.hasItems && $(item.element).find('ul').length > 0) {
                        $(item.element).find('ul').remove();
                    }
                }

                var oldArrow = $(item.arrow);
                if (oldArrow.length > 0) {
                    oldArrow.remove();
                }

                $arrowSpan = $('<span style="height: 17px; border: none; background-color: transparent;" id="arrow' + $element[0].id + '"></span>');
                $arrowSpan.prependTo($element);
                if (!me.rtl) {
                    $arrowSpan.css('float', 'left');
                }
                else {
                    $arrowSpan.css('float', 'right');
                }
                $arrowSpan.css('clear', 'both');

                $arrowSpan.width(me.toggleIndicatorSize);
                me._arrowStyle($arrowSpan, "", item.isExpanded);

                var paddingOffset = parseInt($(this.titleElement).css('padding-top'));
                if (isNaN(paddingOffset)) {
                    paddingOffset = 0;
                }

                paddingOffset = paddingOffset * 2;
                paddingOffset += 2;

                var offset = (paddingOffset + $(this.titleElement).height()) / 2 - 17 / 2;
                if ($.jqx.browser.msie && $.jqx.browser.version < 9) {
                    $arrowSpan.css('margin-top', '3px');
                }
                else {
                    if (parseInt(offset) >= 0) {
                        $arrowSpan.css('margin-top', parseInt(offset) + 'px');
                    }
                }
                $element.addClass(me.toThemeProperty('jqx-disableselect'));
                $arrowSpan.addClass(me.toThemeProperty('jqx-disableselect'));

                var eventName = 'click';
                var isTouchDevice = me.isTouchDevice();
                if (isTouchDevice) {
                    eventName = $.jqx.mobile.getTouchEventName('touchend');
                }
                me.addHandler($arrowSpan, eventName, function () {
                    if (!item.isExpanded) {
                        me._expandItem(me, item);
                    }
                    else {
                        me._collapseItem(me, item);
                    }

                    return false;
                });

                me.addHandler($arrowSpan, 'selectstart', function () {
                    return false;
                });

                me.addHandler($arrowSpan, 'mouseup', function () {
                    if (!isTouchDevice) {
                        return false;
                    }
                });

                if (!isTouchDevice) {
                    me.addHandler($arrowSpan, 'mouseenter', function () {
                        me._arrowStyle($arrowSpan, "hover", item.isExpanded);
                    });

                    me.addHandler($arrowSpan, 'mouseleave', function () {
                        me._arrowStyle($arrowSpan, "", item.isExpanded);
                    });
                }

                item.hasItems = $(item.element).find('li').length > 0;

                item.arrow = $arrowSpan[0];
                if (!item.hasItems) {
                    $arrowSpan.css('visibility', 'hidden');
                }

                $element.css('float', 'none');
            });
        },

        _getOffset: function (object) {
            var scrollTop = $(window).scrollTop();
            var scrollLeft = $(window).scrollLeft();
            var isSafari = $.jqx.mobile.isSafariMobileBrowser();
            var offset = $(object).offset();
            var top = offset.top;
            var left = offset.left;
            if (isSafari != null && isSafari) {
                return { left: left - scrollLeft, top: top - scrollTop };
            }
            else return $(object).offset();
        },

        _renderHover: function ($treeElement, item, isTouchDevice) {
            var me = this;
            if (!isTouchDevice) {
                var $titleElement = $(item.titleElement);
                me.addHandler($titleElement, 'mouseenter', function () {
                    if (!item.disabled && me.enableHover && !me.disabled) {
                        $titleElement.addClass(me.toThemeProperty('jqx-fill-state-hover'));
                        $titleElement.addClass(me.toThemeProperty('jqx-tree-item-hover'));
                    }
                });
                me.addHandler($titleElement, 'mouseleave', function () {
                    if (!item.disabled && me.enableHover && !me.disabled) {
                        $titleElement.removeClass(me.toThemeProperty('jqx-fill-state-hover'));
                        $titleElement.removeClass(me.toThemeProperty('jqx-tree-item-hover'));
                    }
                });
            }
        },

        _updateDisabledState: function () {
            if (this.disabled) {
                this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
            }
            else {
                this.host.removeClass(this.toThemeProperty('jqx-fill-state-disabled'));
            }
        },

        _addInput: function () {
            if (this.input == null) {
                var name = this.host.attr('name');
                if (!name) name = this.element.id;
                else {
                    this.host.attr('name', "");
                }

                this.input = $("<input type='hidden'/>");
                this.host.append(this.input);
                this.input.attr('name', name);
                this._updateInputSelection();
            }
        },

        render: function () {
            this._updateItemsNavigation();
            this._render();
        },

        _render: function (updateEvents, updateDrag) {
            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                var me = this;
                $.each(this.items, function () {
                    var $element = $(this.element);
                    var $parent = $element.parent();
                    var totalWidth = parseInt(this.titleElement.css('margin-left')) + this.titleElement[0].scrollWidth + 13;

                    $element.css('min-width', totalWidth);

                    var parentWidth = parseInt($parent.css('min-width'));
                    if (isNaN(parentWidth)) parentWidth = 0;
                    var elementMinWidth = $element.css('min-width');

                    if (parentWidth < parseInt($element.css('min-width'))) {
                        $parent.css('min-width', elementMinWidth);
                    }
                    this.titleElement[0].style.width = null;
                });
            }

            var zIndex = 1000;
            var popupElementoffset = [5, 5];
            var me = this;
            $.data(me.element, 'animationHideDelay', me.animationHideDelay);
            $.data(document.body, 'treeel', this);
            this._initialize();

            var isTouchDevice = this.isTouchDevice();
            if (isTouchDevice && this.toggleMode == 'dblclick') {
                this.toggleMode = 'click';
            }

            if (updateEvents == undefined || updateEvents == true) {
                $.each(this.items, function () {
                    me._updateItemEvents(me, this);
                });
            }
            if (this.allowDrag && this._enableDragDrop && (updateDrag == undefined || updateDrag == true)) {
                this._enableDragDrop();
            }
            this._addInput();
            // add panel.
            if (this.host.jqxPanel) {
                if (this.host.find('#panel' + this.element.id).length > 0) {
                    this.panel.jqxPanel({ touchMode: this.touchMode });
                    this.panel.jqxPanel('refresh');
                    return;
                }

                this.host.find('ul:first').wrap('<div style="background-color: transparent; overflow: hidden; width: 100%; height: 100%;" id="panel' + this.element.id + '"></div>');
                var panel = this.host.find('div:first');
                var sizeMode = 'fixed';

                if (this.height == null || this.height == 'auto') {
                    sizeMode = 'verticalwrap';
                }
                if (this.width == null || this.width == 'auto') {
                    if (sizeMode == 'fixed') {
                        sizeMode = 'horizontalwrap';
                    }
                    else sizeMode = 'wrap';
                }

                panel.jqxPanel({ rtl: this.rtl, theme: this.theme, width: '100%', height: '100%', touchMode: this.touchMode, sizeMode: sizeMode });
                if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                    panel.jqxPanel('content').css('left', '0px');
                }

                if (this.height == null || (this.height != null && this.height.toString().indexOf('%') != -1)) {
                    if (this.isTouchDevice()) {
                        this.removeHandler(panel, $.jqx.mobile.getTouchEventName('touchend') + '.touchScroll touchcancel.touchScroll');
                        this.removeHandler(panel, $.jqx.mobile.getTouchEventName('touchmove') + '.touchScroll');
                        this.removeHandler(panel, $.jqx.mobile.getTouchEventName('touchstart') + '.touchScroll');
                    }
                }

                var panelInstance = $.data(panel[0], 'jqxPanel').instance;
                if (panelInstance != null) {
                    this.vScrollInstance = panelInstance.vScrollInstance;
                    this.hScrollInstance = panelInstance.hScrollInstance;
                }
                this.panelInstance = panelInstance;
                if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                    this.host.attr('hideFocus', true);
                    this.host.find('div').attr('hideFocus', true);
                    this.host.find('ul').attr('hideFocus', true);
                }

                panel[0].className = '';
                this.panel = panel;
            }
            this._raiseEvent('3', this);
        },

        focus: function () {
            try {
                this.host.focus();

            }
            catch (error) {
            }
        },

        _updateItemEvents: function (me, item) {
            var isTouchDevice = this.isTouchDevice();
            if (isTouchDevice) {
                this.toggleMode = $.jqx.mobile.getTouchEventName('touchend');
            }

            var $treeElement = $(item.element);

            if (me.enableRoundedCorners) {
                $treeElement.addClass(me.toThemeProperty('jqx-rc-all'));
            }

            var checkEventName = !isTouchDevice ? 'click' : $.jqx.mobile.getTouchEventName('touchend');
            if (me.touchMode === true) {
                me.removeHandler($(item.checkBoxElement), 'click');
            }
            me.removeHandler($(item.checkBoxElement), checkEventName);
            me.addHandler($(item.checkBoxElement), checkEventName, function (event) {
                if (!me.disabled) {
                    if (!this.treeItem.disabled) {
                        this.treeItem.checked = !this.treeItem.checked;
                        me.checkItem(this.treeItem.element, this.treeItem.checked, 'tree');
                        if (me.hasThreeStates) {
                            me.checkItems(this.treeItem, this.treeItem);
                        }
                    }
                }
                return false;
            });

            var $titleElement = $(item.titleElement);

            me.removeHandler($treeElement);

            var drag = this.allowDrag && this._enableDragDrop;
            if (!drag) {
                me.removeHandler($titleElement);
            }
            else {
                me.removeHandler($titleElement, 'mousedown.item');
                me.removeHandler($titleElement, 'click');
                me.removeHandler($titleElement, 'dblclick');
                me.removeHandler($titleElement, 'mouseenter');
                me.removeHandler($titleElement, 'mouseleave');
            }

            me._renderHover($treeElement, item, isTouchDevice);
            var $subtree = $(item.subtreeElement);
            if ($subtree.length > 0) {
                var display = item.isExpanded ? 'block' : 'none';
                $subtree.css({ overflow: 'hidden', display: display })
                $subtree.data('timer', {});
            }

            me.addHandler($titleElement, 'selectstart', function (event) {
                return false;
            });

            if ($.jqx.browser.opera) {
                me.addHandler($titleElement, 'mousedown.item', function (event) {
                    return false;
                });
            }

            if (me.toggleMode != 'click') {
                me.addHandler($titleElement, 'click', function (event) {
                    me.selectItem(item.element);

                    if (me.panel != null) {
                        me.panel.jqxPanel({ focused: true });
                    }
                    me.host.focus();
                });
            }

            me.addHandler($titleElement, me.toggleMode, function (event) {
                if ($subtree.length > 0) {
                    clearTimeout($subtree.data('timer').hide)
                }

                if (me.panel != null) {
                    me.panel.jqxPanel({ focused: true });
                }

                me.selectItem(item.element);
                if (item.isExpanding == undefined)
                    item.isExpanding = false;
                if (item.isCollapsing == undefined)
                    item.isCollapsing = false;

                if ($subtree.length > 0) {
                    if (!item.isExpanded) {
                        if (false == item.isExpanding) {
                            item.isExpanding = true;
                            me._expandItem(me, item);
                        }
                    }
                    else {
                        if (false == item.isCollapsing) {
                            item.isCollapsing = true;
                            me._collapseItem(me, item, true);
                        }
                    }
                    return false;
                }
            });
        },

        isTouchDevice: function () {
            if (this._isTouchDevice != undefined) return this._isTouchDevice;
            var isTouchDevice = $.jqx.mobile.isTouchDevice();
            if (this.touchMode == true) {
                isTouchDevice = true;
            }
            else if (this.touchMode == false) {
                isTouchDevice = false;
            }
            this._isTouchDevice = isTouchDevice;
            return isTouchDevice;
        },

        createID: function () {
            return $.jqx.utilities.createId();
        },

        // creates the tree.
        createTree: function (uiObject) {
            if (uiObject == null)
                return;

            var self = this;
            var liTags = $(uiObject).find('li');
            var k = 0;

            this.items = new Array();

            this.itemMapping = new Array();
            $(uiObject).addClass(self.toThemeProperty('jqx-tree-dropdown-root'));
            if (this.rtl) {
                $(uiObject).addClass(self.toThemeProperty('jqx-tree-dropdown-root-rtl'));
            }
          
            if (this.rtl || $.jqx.browser.msie && $.jqx.browser.version < 8) {
                this._measureItem = $("<span style='position: relative; visibility: hidden;'></span>");
                this._measureItem.addClass(this.toThemeProperty('jqx-widget'));
                this._measureItem.addClass(this.toThemeProperty('jqx-fill-state-normal'));
                this._measureItem.addClass(this.toThemeProperty('jqx-tree-item'));
                this._measureItem.addClass(this.toThemeProperty('jqx-item'));
                $(document.body).append(this._measureItem);
            }
            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
   //             $(uiObject).css('position', 'relative');
    //            $(uiObject).css('left', '-40px');
            }

            for (var index = 0; index < liTags.length; index++) {
                this._createItem(liTags[index]);
            }

            if (this.rtl || $.jqx.browser.msie && $.jqx.browser.version < 8) {
                this._measureItem.remove();
            }

            this._updateItemsNavigation();
            this._updateCheckStates();
        },

        _updateCheckLayout: function (level) {
            var me = this;
            if (!this.checkboxes) return;

            $.each(this.items, function () {
                if (this.level == level || level == undefined) {
                    me._updateCheckItemLayout(this);
                }
            });
        },

        _updateCheckItemLayout: function (item) {
            if (this.checkboxes) {
                if ($(item.titleElement).css('display') != 'none') {
                    var checkbox = $(item.checkBoxElement);
                    var offset = $(item.titleElement).outerHeight() / 2 - 1 - parseInt(this.checkSize) / 2;
                    checkbox.css('margin-top', offset);
                    if (!this.rtl) {
                        if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                            item.titleElement.css('margin-left', parseInt(this.checkSize) + 25);
                        }
                        else {
                            if (item.hasItems) {
                                checkbox.css('margin-left', this.toggleIndicatorSize);
                            }
                        }
                    }
                }
            }
        },

        _updateCheckStates: function () {
            var me = this;
            if (me.hasThreeStates) {
                $.each(this.items, function () {
                    me._updateCheckState(this);
                });
            }
            else {
                $.each(this.items, function () {
                    if (this.checked == null) {
                        me.checkItem(this.element, false, 'tree');
                    }
                });
            }
        },

        _updateCheckState: function (item) {
            if (item == null || item == undefined)
                return;
            var me = this;
            var count = 0;
            var hasIndeterminate = false;
            var itemsCount = 0;

            var childItems = $(item.element).find('li');
            itemsCount = childItems.length;

            if (item.checked && itemsCount > 0) {
                $.each(childItems, function (index) {
                    var child = me.itemMapping["id" + this.id].item;
                    var checked = child.element.getAttribute('item-checked');
                    if (checked == undefined || checked == null || checked == 'true' || checked == true) {
                        me.checkItem(child.element, true, 'tree');
                    }
                });
            }

            $.each(childItems, function (index) {
                var child = me.itemMapping["id" + this.id].item;
                if (child.checked != false) {
                    if (child.checked == null) {
                        hasIndeterminate = true;
                    }
                    count++;
                }
            });

            if (itemsCount > 0) {
                if (count == itemsCount) {
                    this.checkItem(item.element, true, 'tree');
                }
                else {
                    if (count > 0) {
                        this.checkItem(item.element, null, 'tree');
                    }
                    else this.checkItem(item.element, false, 'tree');
                }
            }
        },

        _updateItemsNavigation: function () {
            var innerElement = this.host.find('ul:first');
            var liTags = $(innerElement).find('li');
            var k = 0;
            for (var i = 0; i < liTags.length; i++) {
                var listTag = liTags[i];
                if (this.itemMapping["id" + listTag.id]) {
                    var treeItem = this.itemMapping["id" + listTag.id].item;
                    if (!treeItem)
                        continue;

                    treeItem.prevItem = null;
                    treeItem.nextItem = null;
                    if (i > 0) {
                        if (this.itemMapping["id" + liTags[i - 1].id]) {
                            treeItem.prevItem = this.itemMapping["id" + liTags[i - 1].id].item;
                        }
                    }

                    if (i < liTags.length - 1) {
                        if (this.itemMapping["id" + liTags[i + 1].id]) {
                            treeItem.nextItem = this.itemMapping["id" + liTags[i + 1].id].item;
                        }
                    }
                }
            }
        },

        _applyTheme: function (oldTheme, newTheme) {
            var me = this;
            this.host.removeClass('jqx-tree-' + oldTheme);
            this.host.removeClass('jqx-widget-' + oldTheme);
            this.host.removeClass('jqx-widget-content-' + oldTheme);
            this.host.addClass(me.toThemeProperty('jqx-tree'));
            this.host.addClass(me.toThemeProperty('jqx-widget'));
            var uiObject = this.host.find('ul:first');
            $(uiObject).removeClass(me.toThemeProperty('jqx-tree-dropdown-root-' + oldTheme));
            $(uiObject).addClass(me.toThemeProperty('jqx-tree-dropdown-root'));
            if (this.rtl) {
                $(uiObject).removeClass(me.toThemeProperty('jqx-tree-dropdown-root-rtl-' + oldTheme));
                $(uiObject).addClass(me.toThemeProperty('jqx-tree-dropdown-root-rtl'));
            }
            var liTags = $(uiObject).find('li');
            for (var index = 0; index < liTags.length; index++) {
                var listTag = liTags[index];
                $(listTag).children().each(function () {
                    if (this.tagName == 'ul' || this.tagName == 'UL') {
                        $(this).removeClass(me.toThemeProperty('jqx-tree-dropdown-' + oldTheme));
                        $(this).addClass(me.toThemeProperty('jqx-tree-dropdown'));
                        if (me.rtl) {
                            $(this).removeClass(me.toThemeProperty('jqx-tree-dropdown-rtl-' + oldTheme));
                            $(this).addClass(me.toThemeProperty('jqx-tree-dropdown-rtl'));
                        }
                        return false;
                    }
                });
            }

            $.each(this.items, function () {
                var item = this;
                var $treeElement = $(item.element);

                $treeElement.removeClass(me.toThemeProperty('jqx-tree-item-li-' + oldTheme));
                $treeElement.addClass(me.toThemeProperty('jqx-tree-item-li'));
                if (this.rtl) {
                    $treeElement.removeClass(me.toThemeProperty('jqx-tree-item-li-' + oldTheme));
                    $treeElement.addClass(me.toThemeProperty('jqx-tree-item-li'));
                }
                $(item.titleElement).removeClass(me.toThemeProperty('jqx-tree-item-' + oldTheme));
                $(item.titleElement).addClass(me.toThemeProperty('jqx-tree-item'));

                $(item.titleElement).removeClass('jqx-item-' + oldTheme);
                $(item.titleElement).addClass(me.toThemeProperty('jqx-item'));

                var $arrowSpan = $(item.arrow);
                if ($arrowSpan.length > 0) {
                    me._arrowStyle($arrowSpan, "", item.isExpanded);
                }

                if (item.checkBoxElement) {
                    $(item.checkBoxElement).jqxCheckBox({ theme: newTheme });
                }
                if (me.enableRoundedCorners) {
                    $treeElement.removeClass('jqx-rc-all-' + oldTheme);
                    $treeElement.addClass(me.toThemeProperty('jqx-rc-all'));
                }
            });

            if (this.host.jqxPanel) {
                this.panel.jqxPanel({ theme: newTheme });
            }
        },

        _refreshMapping: function (updateEvents, tags) {
            var liTags = this.host.find('li');
            var itemMapping = new Array();

            var newItems = new Array();
            var storage = $.data(document.body, 'treeItemsStorage');
            var me = this;
            for (var index = 0; index < liTags.length; index++) {
                var listTag = liTags[index];
                var $listTag = $(listTag);
                var item = storage[listTag.id];
                if (item == null) {
                    continue;
                }
                newItems[newItems.length] = item;
                if (updateEvents == undefined || updateEvents == true) {
                    this._updateItemEvents(this, item);
                }
                item.level = $listTag.parents('li').length;
                item.treeInstance = this;
                var parentElement = null;
                var parentId = null;
                if (item.titleElement[0].className.indexOf('jqx-fill-state-pressed') != -1) {
                    $(item.titleElement).removeClass(me.toThemeProperty('jqx-fill-state-pressed'));
                    $(item.titleElement).removeClass(me.toThemeProperty('jqx-tree-item-selected'));
                }

                var children = $listTag.children();
                children.each(function () {
                    if (this.tagName == 'ul' || this.tagName == 'UL') {
                        item.subtreeElement = this;
                        $(this).addClass(me.toThemeProperty('jqx-tree-dropdown'));
                        if (me.rtl) {
                            $(this).addClass(me.toThemeProperty('jqx-tree-dropdown-rtl'));
                        }
                        return false;
                    }
                });

                var parents = $listTag.parents();
                parents.each(function () {
                    if ((this.tagName == 'li' || this.tagName == 'LI')) {
                        parentId = this.id;
                        parentElement = this;
                        return false;
                    }
                });

                item.parentElement = parentElement;
                item.parentId = parentId;
                item.hasItems = $(item.element).find('li').length > 0;

                if (item != null) {
                    itemMapping[index] = { element: listTag, item: item };
                    itemMapping["id" + listTag.id] = itemMapping[index];
                }
            }

            this.itemMapping = itemMapping;
            this.items = newItems;
        },

        _createItem: function (element) {
            if (element == null || element == undefined)
                return;

            var id = element.id;
            if (!id) {
                id = this.createID();
            }

            var listTag = element;
            var $listTag = $(element);

            listTag.id = id;

            var treeItemsStorage = $.data(document.body, 'treeItemsStorage');
            if (treeItemsStorage == undefined) {
                treeItemsStorage = new Array();
            }

            var k = this.items.length;
            this.items[k] = new $.jqx._jqxTree.jqxTreeItem();
            this.treeElements[id] = this.items[k];
            treeItemsStorage[listTag.id] = this.items[k];
            $.data(document.body, 'treeItemsStorage', treeItemsStorage)
            k = this.items.length;
            var parentId = 0;
            var me = this;
            var parentElement = null;

            $listTag.attr('role', 'treeitem');
            $listTag.children().each(function () {
                if (this.tagName == 'ul' || this.tagName == 'UL') {
                    me.items[k - 1].subtreeElement = this;
                    $(this).addClass(me.toThemeProperty('jqx-tree-dropdown'));
                    if (me.rtl) {
                        $(this).addClass(me.toThemeProperty('jqx-tree-dropdown-rtl'));
                        $(this).css('clear', 'both');
                    }
                    return false;
                }
            });

            $listTag.parents().each(function () {
                if ((this.tagName == 'li' || this.tagName == 'LI')) {
                    parentId = this.id;
                    parentElement = this;
                    return false;
                }
            });

            var expanded = element.getAttribute('item-expanded');
            if (expanded == null || expanded == undefined || (expanded != 'true' && expanded != true)) {
                expanded = false;
            }
            else expanded = true;
            listTag.removeAttribute('item-expanded');
            var locked = element.getAttribute('item-locked');
            if (locked == null || locked == undefined || (locked != 'true' && locked != true)) {
                locked = false;
            }
            else locked = true;
            listTag.removeAttribute('item-locked');

            var selected = element.getAttribute('item-selected');
            if (selected == null || selected == undefined || (selected != 'true' && selected != true)) {
                selected = false;
            }
            else selected = true;
            listTag.removeAttribute('item-selected');

            var disabled = element.getAttribute('item-disabled');
            if (disabled == null || disabled == undefined || (disabled != 'true' && disabled != true)) {
                disabled = false;
            }
            else disabled = true;
            listTag.removeAttribute('item-disabled');

            var checked = element.getAttribute('item-checked');
            if (checked == null || checked == undefined || (checked != 'true' && checked != true)) {
                checked = false;
            }
            else checked = true;

            var title = element.getAttribute('item-title');
            if (title == null || title == undefined || (title != 'true' && title != true)) {
                title = false;
            }
            listTag.removeAttribute('item-title');

            var icon = element.getAttribute('item-icon');
            var iconsize = element.getAttribute('item-iconsize');
            var label = element.getAttribute('item-label');
            var value = element.getAttribute('item-value');

            listTag.removeAttribute('item-icon');
            listTag.removeAttribute('item-iconsize');
            listTag.removeAttribute('item-label');
            listTag.removeAttribute('item-value');

            var treeItem = this.items[k - 1];
            treeItem.id = id;
            if (treeItem.value == undefined) {
                if (this._valueList && this._valueList[id]) {
                    treeItem.value = this._valueList[id];
                }
                else {
                    treeItem.value = value;
                }
            }
            treeItem.icon = icon;
            treeItem.iconsize = iconsize;
            treeItem.parentId = parentId;
            treeItem.disabled = disabled;
            treeItem.parentElement = parentElement;
            treeItem.element = element;
            treeItem.locked = locked;
            treeItem.selected = selected;
            treeItem.checked = checked;
            treeItem.isExpanded = expanded;
            treeItem.treeInstance = this;

            this.itemMapping[k - 1] = { element: listTag, item: treeItem };
            this.itemMapping["id" + listTag.id] = this.itemMapping[k - 1];
            var hasTitleAttribute = false;
            var isSameLI = false;
            hasTitleAttribute = false;
            if (this.rtl) {
                $(treeItem.element).css('float', 'right');
                $(treeItem.element).css('clear', 'both');
            }

            if (!hasTitleAttribute || !isSameLI) {
                if ($(listTag.firstChild).length > 0) {
                    if (treeItem.icon) {
                        var iconsize = treeItem.iconsize;
                        if (!iconsize) iconsize = 16;

                        var icon = $('<img width="' + iconsize + '" height="' + iconsize + '" style="float: left;" class="itemicon" src="' + treeItem.icon + '"/>');
                        $(listTag).prepend(icon);
                        icon.css('margin-right', '4px');
                        if (this.rtl) {
                            icon.css('margin-right', '0px');
                            icon.css('margin-left', '4px');
                            icon.css('float', 'right');
                        }
                    }

                    var ulindex = listTag.innerHTML.indexOf('<ul');
                    if (ulindex == -1) {
                        ulindex = listTag.innerHTML.indexOf('<UL');
                    }

                    if (ulindex == -1) {
                        treeItem.originalTitle = listTag.innerHTML;
                        listTag.innerHTML = '<div style="display: inline-block;">' + listTag.innerHTML + '</div>';
                        treeItem.titleElement = $($(listTag)[0].firstChild);
                    }
                    else {
                        var listhtml = listTag.innerHTML.substring(0, ulindex);
                        listhtml = $.trim(listhtml);
                        treeItem.originalTitle = listhtml;
                        listhtml = $('<div style="display: inline-block;">' + listhtml + '</div>');

                        var ul = $(listTag).find('ul:first');
                        ul.remove();
                        listTag.innerHTML = "";
                        $(listTag).prepend(listhtml);
                        $(listTag).append(ul);

                        treeItem.titleElement = listhtml;
                        if (this.rtl) {
                            listhtml.css('float', 'right');
                        }
                    }

                    if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                        $($(listTag)[0].firstChild).css('display', 'inline-block');
                        var removeMeasureItem = false;
                        if (this._measureItem.parents().length == 0) {
                            $(document.body).append(this._measureItem);
                            removeMeasureItem = true;
                        }
                        this._measureItem.css('min-width', '20px');
                        this._measureItem[0].innerHTML = ($(treeItem.titleElement).text());
                        var width = this._measureItem.width();
                        if (treeItem.icon) {
                            width += 20;
                        }
                        if ($($(item.titleElement).find('img')).length > 0) {
                            width += 20;
                        }
                        $($(listTag)[0].firstChild).css('max-width', width + 'px');
                        if (removeMeasureItem) {
                            this._measureItem.remove();
                        }
                    }
                }
                else {
                    treeItem.originalTitle = "Item";
                    $(listTag).append($('<span>Item</span>'));
                    $(listTag.firstChild).wrap('<span/>');
                    treeItem.titleElement = $(listTag)[0].firstChild;
                    if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                        $(listTag.firstChild).css('display', 'inline-block');
                    }
                }
            }

            var $itemTitle = $(treeItem.titleElement);
            var itemTitleClassName = this.toThemeProperty('jqx-rc-all');

            if (this.allowDrag) {
                $itemTitle.addClass('draggable');
            }
            if (label == null || label == undefined) {
                label = treeItem.titleElement;
                treeItem.label = $.trim($itemTitle.text());
            }
            else treeItem.label = label;

            $(listTag).addClass(this.toThemeProperty('jqx-tree-item-li'));
            if (this.rtl) {
                $(listTag).addClass(this.toThemeProperty('jqx-tree-item-li-rtl'));
            }
            itemTitleClassName += " " + this.toThemeProperty('jqx-tree-item') + " " + this.toThemeProperty('jqx-item');
            if (this.rtl) {
                itemTitleClassName += " " + this.toThemeProperty('jqx-tree-item-rtl')
            }

            $itemTitle[0].className = $itemTitle[0].className + " " + itemTitleClassName;

            treeItem.level = $(element).parents('li').length;

            treeItem.hasItems = $(element).find('li').length > 0;
            if (this.rtl && treeItem.parentElement) {
                if (!this.checkboxes) {
                    $itemTitle.css('margin-right', '5px');
                }
            }

            if (this.checkboxes) {
                if (this.host.jqxCheckBox) {
                    var checkbox = $('<div style="position: absolute; width: 18px; height: 18px;" tabIndex=0 class="chkbox"/>');
                    checkbox.width(parseInt(this.checkSize));
                    checkbox.height(parseInt(this.checkSize));
                    $(listTag).prepend(checkbox);

                    if (this.rtl) {
                        checkbox.css('float', 'right');
                        checkbox.css('position', 'static');
                    }

                    checkbox.jqxCheckBox({ hasInput: false, checked: treeItem.checked, boxSize: this.checkSize, animationShowDelay: 0, animationHideDelay: 0, disabled: disabled, theme: this.theme });
                    if (!this.rtl) {
                        $itemTitle.css('margin-left', parseInt(this.checkSize) + 6);
                    }
                    else {
                        var minMargin = 5;
                        // if (treeItem.hasItems)
                        //   minMargin = this.toggleIndicatorSize;
                        if (treeItem.parentElement) {
                            checkbox.css('margin-right', minMargin + 5 + 'px');
                        }
                        else {
                            checkbox.css('margin-right', minMargin + 'px');
                        }
                    }

                    treeItem.checkBoxElement = checkbox[0];
                    checkbox[0].treeItem = treeItem;
                    var offset = $itemTitle.outerHeight() / 2 - 1 - parseInt(this.checkSize) / 2;
                    checkbox.css('margin-top', offset);
                    if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                        $itemTitle.css('width', '1%');
                        $itemTitle.css('margin-left', parseInt(this.checkSize) + 25);
                    }
                    else {
                        if (treeItem.hasItems) {
                            if (!this.rtl) {
                                checkbox.css('margin-left', this.toggleIndicatorSize);
                            }
                        }
                    }
                }
                else {
                    throw new Error('jqxTree: Missing reference to jqxcheckbox.js.');
                    return;
                }
            }
            else {
                if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                    $itemTitle.css('width', '1%');
                }
            }

            if (disabled) {
                this.disableItem(treeItem.element);
            }

            if (selected) {
                this.selectItem(treeItem.element);
            }

            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                $(listTag).css('margin', '0px');
                $(listTag).css('padding', '0px');
            }
        },

        destroy: function () {
            this.removeHandler($(window), 'resize.jqxtree' + this.element.id);
            this.host.removeClass();
            if (this.isTouchDevice()) {
                this.removeHandler(this.panel, $.jqx.mobile.getTouchEventName('touchend') + '.touchScroll touchcancel.touchScroll');
                this.removeHandler(this.panel, $.jqx.mobile.getTouchEventName('touchmove') + '.touchScroll');
                this.removeHandler(this.panel, $.jqx.mobile.getTouchEventName('touchstart') + '.touchScroll');
            }
            var me = this;
            var isTouchDevice = this.isTouchDevice();
            $.each(this.items, function () {
                var item = this;
                var $treeElement = $(this.element);
                var checkEventName = !isTouchDevice ? 'click' : $.jqx.mobile.getTouchEventName('touchend');
                me.removeHandler($(item.checkBoxElement), checkEventName);
                var $titleElement = $(item.titleElement);
                me.removeHandler($treeElement);
                var drag = me.allowDrag && me._enableDragDrop;
                if (!drag) {
                    me.removeHandler($titleElement);
                }
                else {
                    me.removeHandler($titleElement, 'mousedown.item');
                    me.removeHandler($titleElement, 'click');
                    me.removeHandler($titleElement, 'dblclick');
                    me.removeHandler($titleElement, 'mouseenter');
                    me.removeHandler($titleElement, 'mouseleave');
                }
                $arrowSpan = $(item.arrow);
                if ($arrowSpan.length > 0) {
                    me.removeHandler($arrowSpan, checkEventName);
                    me.removeHandler($arrowSpan, 'selectstart');
                    me.removeHandler($arrowSpan, 'mouseup');

                    if (!isTouchDevice) {
                        me.removeHandler($arrowSpan, 'mouseenter');
                        me.removeHandler($arrowSpan, 'mouseleave');
                    }

                    me.removeHandler($titleElement, 'selectstart');
                }
                if ($.jqx.browser.opera) {
                    me.removeHandler($titleElement, 'mousedown.item');
                }

                if (me.toggleMode != 'click') {
                    me.removeHandler($titleElement, 'click');
                }

                me.removeHandler($titleElement, me.toggleMode);
            });
            if (this.panel) {
                this.panel.jqxPanel('destroy');
                this.panel = null;
            }
            this.host.remove();
        },

        _raiseEvent: function (id, arg) {
            if (arg == undefined)
                arg = { owner: null };

            var evt = this.events[id];
            args = arg;
            args.owner = this;

            var event = new jQuery.Event(evt);
            event.owner = this;
            event.args = args;

            var result = this.host.trigger(event);
            return result;
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (this.isInitialized == undefined || this.isInitialized == false)
                return;

            if (key == 'submitCheckedItems') {
                object._updateInputSelection();
            }

            if (key == 'disabled') {
                object._updateDisabledState();
            }

            if (key == 'theme') {
                object._applyTheme(oldvalue, value);
            }

            if (key == "keyboardNavigation") {
                object.enableKeyboardNavigation = value;
            }

            if (key == 'width' || key == 'height') {
                object.refresh();
                object._initialize();
                object._calculateWidth();

                if (object.host.jqxPanel) {
                    var sizeMode = 'fixed';
                    if (this.height == null || this.height == 'auto') {
                        sizeMode = 'verticalwrap';
                    }
                    if (this.width == null || this.width == 'auto') {
                        if (sizeMode == 'fixed') {
                            sizeMode = 'horizontalwrap';
                        }
                        else sizeMode = 'wrap';
                    }

                    object.panel.jqxPanel({ sizeMode: sizeMode });
                }
            }

            if (key == 'touchMode') {
                object._isTouchDevice = null;
                if (value) {
                    object.enableHover = false;
                }
                object._render();
            }

            if (key == 'source') {
                if (this.source != null) {
                    var expandedItems = [];
                    $.each(object.items, function () {
                        if (this.isExpanded) {
                            expandedItems[expandedItems.length] = { label: this.label, level: this.level };
                        }
                    });

                    var html = object.loadItems(object.source);
                    if (!object.host.jqxPanel) {
                        object.element.innerHTML = html;
                    }
                    else {
                        object.panel.jqxPanel('setcontent', html);
                    }

                    var disabled = object.disabled;
                    var innerElement = object.host.find('ul:first');
                    if (innerElement.length > 0) {
                        object.createTree(innerElement[0]);
                        object._render();
                    }

                    var me = object;
                    var duration = me.animationShowDuration;
                    me.animationShowDuration = 0;
                    object.disabled = false;
                    if (expandedItems.length > 0) {
                        $.each(object.items, function () {
                            for (var m = 0; m < expandedItems.length; m++) {
                                if (expandedItems[m].label == this.label && expandedItems[m].level == this.level) {
                                    var item = me.getItem(this.element);
                                    me._expandItem(me, item);
                                }
                            }
                        });
                    }
                    object.disabled = disabled;
                    me.animationShowDuration = duration;
                }
            }

            if (key == 'hasThreeStates') {
                object._render();
                object._updateCheckStates();
            }

            if (key == 'toggleIndicatorSize') {
                object._updateCheckLayout();
                object._render();
            }
        }
    });
})(jQuery);

(function ($) {
    $.jqx._jqxTree.jqxTreeItem = function(id, parentId, type) {
        var treeItem =
        {
            // gets the item's label.
            label: null,
            // gets the id.
    	    id: id,
            // gets the parent id.
            parentId: parentId,
            // gets the parent element.
            parentElement: null,
            // gets the parent item instance.
            parentItem: null,
            // gets whether the item is disabled.
            disabled: false,
            // gets whether the item is selected.
            selected: false,
            // gets whether the item is locked.
            locked: false,
            // gets the checked state.
            checked: false,
            // gets the item's level.
            level: 0,
            // gets a value whether the item is opened.
            isExpanded: false,
            // has sub elements.
            hasItems: false,
            // li element
            element: null,
            // subtree element.
            subtreeElement: null,
            // checkbox element.
            checkBoxElement: null,
            // titleElement element.
            titleElement: null,
            // arrow element.
            arrow: null,
            // prev item.
            prevItem: null,
            // next item.
            nextItem: null
         }
        return treeItem;
    }; // 
})(jQuery);
(function ($) {

    $.jqx.jqxWidget('jqxDragDrop', '', {});

    $.extend($.jqx._jqxDragDrop.prototype, {
        defineInstance: function () {
            this.restricter = 'document';
            this.handle = false;
            this.feedback = 'clone';
            this.opacity = 0.6;
            this.revert = false;
            this.revertDuration = 400;
            this.distance = 5;
            this.disabled = false;
            this.tolerance = 'intersect';
            this.data = null;
            this.dropAction = 'default';
            this.dragZIndex = 999999;
            this.appendTo = 'parent';
            this.cursor = 'move';
            this.onDragEnd = null;
            this.onDrag = null;
            this.onDragStart = null;
            this.onTargetDrop = null;
            this.onDropTargetEnter = null;
            this.onDropTargetLeave = null;
            this.initFeedback = null;
            this.dropTarget = null;
            this.isDestroyed = false;
            this.triggerEvents = true;
            this._touchEvents = {
                'mousedown': $.jqx.mobile.getTouchEventName('touchstart'),
                'click': $.jqx.mobile.getTouchEventName('touchstart'),
                'mouseup': $.jqx.mobile.getTouchEventName('touchend'),
                'mousemove': $.jqx.mobile.getTouchEventName('touchmove'),
                'mouseenter': 'mouseenter',
                'mouseleave': 'mouseleave'
            };
            this._restricter = null;
            this._zIndexBackup = 0;
            this._targetEnterFired = false;
            this._oldOpacity = 1;
            this._feedbackType;
            this._isTouchDevice = false;
            this._events = [
                'dragStart', 'dragEnd', 'dragging', 'dropTargetEnter', 'dropTargetLeave'
            ];
        },

        createInstance: function () {
            this._createDragDrop();
        },

        _createDragDrop: function () {
            var count = $.data(document.body, 'jqx-draggables') || 1;
            this.appendTo = this._getParent();
            this._isTouchDevice = $.jqx.mobile.isTouchDevice();
            if ((/(static|relative)/).test(this.host.css('position'))) {
                if (!this.feedback || this.feedback === 'original') {
                    var pos = this._getRelativeOffset(this.host);
                    var parentOffset = this.appendTo.offset();
                    if (this.appendTo.css('position') != 'static') {
                        parentOffset = { left: 0, top: 0 };
                    }

                    this.element.style.position = 'absolute';
                    this.element.style.left = parentOffset.left + pos.left + 'px';
                    this.element.style.top = parentOffset.top + pos.top + 'px';
                }
            }
            this._validateProperties();
            this._idHandler(count);
            if (this.disabled) {
                this.disable();
            }
            if (typeof this.dropTarget === 'string') {
                this.dropTarget = $(this.dropTarget);
            }
            this._refresh();
            count += 1;
            $.data(document.body, 'jqx-draggables', count);
            this.host.addClass('jqx-draggable');
            if (!this.disabled) {
                this.host.css('cursor', this.cursor);
            }
        },

        _getParent: function () {
            var parent = this.appendTo;
            if (typeof this.appendTo === 'string') {
                switch (this.appendTo) {
                    case 'parent':
                        parent = this.host.parent();
                        break;
                    case 'document':
                        parent = $(document);
                        break;
                    case 'body':
                        parent = $(document.body);
                        break;
                    default:
                        parent = $(this.appendTo);
                        break
                }
            }
            return parent;
        },

        _idHandler: function (count) {
            if (!this.element.id) {
                var id = 'jqx-draggable-' + count;
                this.element.id = id;
            }
        },

        _refresh: function () {
            this._removeEventHandlers();
            this._addEventHandlers();
        },

        _getEvent: function (event) {
            if (this._isTouchDevice) {
                return this._touchEvents[event];
            } else {
                return event;
            }
        },

        _validateProperties: function () {
            if (this.feedback === 'clone') {
                this._feedbackType = 'clone';
            } else {
                this._feedbackType = 'original';
            }
            if (this.dropAction !== 'default') {
                this.dropAction = 'nothing';
            }
        },

        _removeEventHandlers: function () {
            this.removeHandler(this.host, 'dragstart');
            this.removeHandler(this.host, this._getEvent('mousedown') + '.draggable.' + this.element.id, this._mouseDown);
            this.removeHandler($(document), this._getEvent('mousemove') + '.draggable.' + this.element.id, this._mouseMove);
            this.removeHandler($(document), this._getEvent('mouseup') + '.draggable.' + this.element.id, this._mouseUp);
        },

        _addEventHandlers: function () {
            var self = this;
            this.addHandler(this.host, 'dragstart', function (event) {
                var isTouchDevice = $.jqx.mobile.isTouchDevice();
                if (!isTouchDevice) {
                    event.preventDefault();
                    return false;
                }
            });
            this.addHandler(this.host, this._getEvent('mousedown') + '.draggable.' + this.element.id, this._mouseDown, { self: this });
            this.addHandler($(document), this._getEvent('mousemove') + '.draggable.' + this.element.id, this._mouseMove, { self: this });
            this.addHandler($(document), this._getEvent('mouseup') + '.draggable.' + this.element.id, this._mouseUp, { self: this });
            if (document.referrer != "" || window.frameElement) {
                if (window.top != null) {
                    var parentLocation = '';
                    if (window.parent && document.referrer) {
                        parentLocation = document.referrer;
                    }

                    if (parentLocation.indexOf(document.location.host) != -1) {
                        var eventHandle = function (event) {
                            self._mouseUp(self);
                        };

                        if (window.top.document.addEventListener) {
                            window.top.document.addEventListener('mouseup', eventHandle, false);

                        } else if (window.top.document.attachEvent) {
                            window.top.document.attachEvent("on" + 'mouseup', eventHandle);
                        }
                    }
                }
            }
        },

        _mouseDown: function (event) {
            var self = event.data.self,
                mouseCoordinates = self._getMouseCoordinates(event),
                mouseCapture = self._mouseCapture(event);
            self._originalPageX = mouseCoordinates.left;
            self._originalPageY = mouseCoordinates.top;

            var captured = false;
            if (!self._mouseStarted) {
                self._mouseUp(event);
                captured = true;
            }
            if (mouseCapture) {
                self._mouseDownEvent = event;
            }
            if (self._isTouchDevice) {
         //       self._mouseStarted = true;
         //       self._mouseStart(self._mouseDownEvent, event)
         //       self._mouseDrag(event);
                //       return false;
                return true;
            }

            if (event.which !== 1 || !mouseCapture) {
                return true;
            }
            event.preventDefault();
            if (captured == true) {
             //   return false;
            }
            //     return false;
        },

        _mouseMove: function (event) {
            var self = event.data.self;
            if (self._mouseStarted) {
                self._mouseDrag(event);
                if (event.preventDefault) {
                    event.preventDefault();
                }
                return false;
            }
            if (self._mouseDownEvent && self._isMovedDistance(event)) {
                if (self._mouseStart(self._mouseDownEvent, event)) {
                    self._mouseStarted = true;
                } else {
                    self._mouseStarted = false;
                }
                if (self._mouseStarted) {
                    self._mouseDrag(event);
                } else {
                    self._mouseUp(event);
                }
            }
            return !self._mouseStarted;
        },

        _mouseUp: function (event) {
            var self;
            if (event.data && event.data.self) {
                self = event.data.self;
            } else {
                self = this;
            }
            self._mouseDownEvent = false;
            self._movedDistance = false;
            if (self._mouseStarted) {
                self._mouseStarted = false;
                self._mouseStop(event);
            }
            if (self.feedback && self.feedback[0] && self._feedbackType !== 'original' && typeof self.feedback.remove === 'function' && !self.revert) {
                self.feedback.remove();
            }
            if (!self._isTouchDevice) {
                return false;
            }
        },

        cancelDrag: function () {
            var revertDuration = this.revertDuration;
            this.revertDuration = 0;
            this._mouseDownEvent = false;
            this._movedDistance = false;
            this._mouseStarted = false;
            this._mouseStop();
            this.feedback.remove();
            this.revertDuration = revertDuration;
        },

        _isMovedDistance: function (event) {
            var mc = this._getMouseCoordinates(event);
            if (this._movedDistance) {
                return true;
            }
            if (mc.left >= this._originalPageX + this.distance ||
                mc.left <= this._originalPageX - this.distance ||
                mc.top >= this._originalPageY + this.distance ||
                mc.top <= this._originalPageY - this.distance) {
                this._movedDistance = true;
                return true;
            }
            return false;
        },

        _getMouseCoordinates: function (event) {
            if (this._isTouchDevice) {
                var pos = $.jqx.position(event);

                return {
                    left: pos.left,
                    top: pos.top
                };
            } else {
                return {
                    left: event.pageX,
                    top: event.pageY
                };
            }
        },

        destroy: function () {
            this.host
            .removeData('draggable')
            .off('.draggable')
            .removeClass('jqx-draggable'
                + ' jqx-draggable-dragging'
                + ' jqx-draggable-disabled');
            this._removeEventHandlers();
            this.isDestroyed = true;
            return this;
        },

        _disableSelection: function (element) {
            element.each(function () {
                $(this).attr('unselectable', 'on')
                    .css({
                        '-ms-user-select': 'none',
                        '-moz-user-select': 'none',
                        '-webkit-user-select': 'none',
                        'user-select': 'none'
                    })
                    .each(function () {
                        this.onselectstart = function () { return false; };
                    });
            });
        },

        _enableSelection: function (element) {
            element.each(function () {
                $(this).attr('unselectable', 'off')
                .css({
                    '-ms-user-select': 'text',
                    '-moz-user-select': 'text',
                    '-webkit-user-select': 'text',
                    'user-select': 'text'
                })
                .each(function () {
                    this.onselectstart = null;
                });
            });
        },

        _mouseCapture: function (event) {
            if (this.disabled) {
                return false;
            }
            if (!this._getHandle(event)) {
                return false;
            }
            this._disableSelection(this.host);
            return true;
        },

        _getScrollParent: function (element) {
            var scrollParent;
            if (($.jqx.browser.msie && (/(static|relative)/).test(element.css('position'))) ||
            (/absolute/).test(element.css('position'))) {
                scrollParent = element.parents().filter(function () {
                    return (/(relative|absolute|fixed)/).test($.css(this, 'position', 1)) &&
                    (/(auto|scroll)/).test($.css(this, 'overflow', 1) + $.css(this, 'overflow-y', 1) + $.css(this, 'overflow-x', 1));
                }).eq(0);
            } else {
                scrollParent = element.parents().filter(function () {
                    return (/(auto|scroll)/).test($.css(this, 'overflow', 1) + $.css(this, 'overflow-y', 1) + $.css(this, 'overflow-x', 1));
                }).eq(0);
            }

            return (/fixed/).test(element.css('position')) || !scrollParent.length ? $(document) : scrollParent;
        },

        _mouseStart: function (event) {
            var mouseCoordinates = this._getMouseCoordinates(event),
                parentOffset = this._getParentOffset(this.host);
            this.feedback = this._createFeedback(event);
            this._zIndexBackup = this.feedback.css('z-index');
            this.feedback[0].style.zIndex = this.dragZIndex;
            this._backupFeedbackProportions();
            this._backupeMargins();
            this._positionType = this.feedback.css('position');
            this._scrollParent = this._getScrollParent(this.feedback);
            this._offset = this.positionAbs = this.host.offset();
            this._offset = {
                top: this._offset.top - this.margins.top,
                left: this._offset.left - this.margins.left
            };
            $.extend(this._offset, {
                click: {
                    left: mouseCoordinates.left - this._offset.left,
                    top: mouseCoordinates.top - this._offset.top
                },
                parent: this._getParentOffset(),
                relative: this._getRelativeOffset(),
                hostRelative: this._getRelativeOffset(this.host)
            });
            this.position = this._generatePosition(event);
            this.originalPosition = this._fixPosition();
            if (this.restricter) {
                this._setRestricter();
            }
            this.feedback.addClass(this.toThemeProperty('jqx-draggable-dragging'));
            var result = this._raiseEvent(0, event);
            if (this.onDragStart && typeof this.onDragStart === 'function') {
                this.onDragStart(this.position);
            }
            this._mouseDrag(event, true);
            return true;
        },

        _fixPosition: function () {
            var parentOffset = this._getRelativeOffset(this.host),
                position = this.position;
            //if (this.feedback.parent()[0] !== this.host.parent()[0]) {
            position = {
                left: this.position.left + parentOffset.left,
                top: this.position.top + parentOffset.top
            }
            //}
            return position;
        },

        _mouseDrag: function (event, noPropagation) {
            this.position = this._generatePosition(event);
            this.positionAbs = this._convertPositionTo('absolute');
            this.feedback[0].style.left = this.position.left + 'px';
            this.feedback[0].style.top = this.position.top + 'px';
            this._raiseEvent(2, event);
            if (this.onDrag && typeof this.onDrag === 'function') {
                this.onDrag(this.data, this.position);
            }
            this._handleTarget();
            return false;
        },

        _over: function (position, dw, dh) {
            if (this.dropTarget) {
                var over = false, self = this;
                $.each(this.dropTarget, function (idx, droppable) {
                    over = self._overItem(droppable, position, dw, dh);
                    if (over.over) {
                        return false;
                    }
                });
            }
            return over;
        },

        _overItem: function (droppable, position, dw, dh) {
            droppable = $(droppable);
            var dropOffset = droppable.offset(),
                ch = droppable.outerHeight(),
                cw = droppable.outerWidth(),
                over;
            if (!droppable || droppable[0] === this.element) {
                return;
            }
            var over = false;
            switch (this.tolerance) {
                case 'intersect':
                    if (position.left + dw > dropOffset.left &&
                        position.left < dropOffset.left + cw &&
                        position.top + dh > dropOffset.top &&
                        position.top < dropOffset.top + ch) {
                        over = true;
                    }
                    break;
                case 'fit':
                    if (dw + position.left <= dropOffset.left + cw &&
                        position.left >= dropOffset.left &&
                        dh + position.top <= dropOffset.top + ch &&
                        position.top >= dropOffset.top) {
                        over = true;
                    }
                    break;
            }
            return { over: over, target: droppable };
        },

        _handleTarget: function () {
            if (this.dropTarget) {
                var position = this.feedback.offset(),
                    dw = this.feedback.outerWidth(),
                    dh = this.feedback.outerWidth(),
                    over = this._over(position, dw, dh);
                if (over.over) {
                    this._oldtarget = over.target;
                    if (!this._targetEnterFired) {
                        this._targetEnterFired = true;
                        this._raiseEvent(3, { target: over.target });
                        if (this.onDropTargetEnter && typeof this.onDropTargetEnter === 'function') {
                            this.onDropTargetEnter(over.target);
                        }
                    }
                } else {
                    if (this._targetEnterFired) {
                        this._targetEnterFired = false;
                        this._raiseEvent(4, { target: this._oldtarget || over.target });
                        if (this.onDropTargetLeave && typeof this.onDropTargetLeave === 'function') {
                            this.onDropTargetLeave(this._oldtarget || over.target);
                        }
                    }
                }
            }
        },

        _mouseStop: function (event) {
            var dropped = false,
                dropPosition = this._fixPosition(),
                size = {
                    width: this.host.outerWidth(),
                    height: this.host.outerHeight()
                };
            this.feedback[0].style.opacity = this._oldOpacity;
            if (!this.revert) {
                this.feedback[0].style.zIndex = this._zIndexBackup;
            }
            this._enableSelection(this.host);
            if (this.dropped) {
                dropped = this.dropped;
                this.dropped = false;
            }
            if ((!this.element || !this.element.parentNode) && this.feedback === 'original') {
                return false;
            }
            this._dropElement(dropPosition);
            //   return;
            this.feedback.removeClass(this.toThemeProperty('jqx-draggable-dragging'));
            this._raiseEvent(1, event);
            if (this.onDragEnd && typeof this.onDragEnd === 'function') {
                this.onDragEnd(this.data);
            }
            if (this.onTargetDrop && typeof this.onTargetDrop === 'function' && this._over(dropPosition, size.width, size.height).over) {
                this.onTargetDrop(this._over(dropPosition, size.width, size.height).target);
            }
            this._revertHandler();
            return false;
        },

        _dropElement: function (dropPosition) {
            if (this.dropAction === 'default' &&
                this.feedback && this.feedback[0] !== this.element &&
                this.feedback !== 'original') {
                if (!this.revert) {
                    if (!(/(fixed|absolute)/).test(this.host.css('position'))) {
                        this.host.css('position', 'relative')
                        var offset = this._getRelativeOffset(this.host);
                        dropPosition = this.position;
                        dropPosition.left -= offset.left;
                        dropPosition.top -= offset.top;

                        this.element.style.left = dropPosition.left + 'px';
                        this.element.style.top = dropPosition.top + 'px';
                    }
                }
            }
        },

        _revertHandler: function () {
            if (this.revert || ($.isFunction(this.revert) && this.revert())) {
                var self = this;
                if (this._feedbackType != 'original') {
                    //          $(this.host).css('left', self.originalPosition.left - self._offset.hostRelative.left);
                    //          $(this.host).css('top', self.originalPosition.top - self._offset.hostRelative.top);
                    if (this.feedback != null) {
                        if (this.dropAction != 'none') {
                            $(this.feedback).animate({
                                left: self.originalPosition.left - self._offset.hostRelative.left,
                                top: self.originalPosition.top - self._offset.hostRelative.top
                            }, parseInt(this.revertDuration, 10), function () {
                                if (self.feedback && self.feedback[0] && self._feedbackType !== 'original' && typeof self.feedback.remove === 'function') {
                                    self.feedback.remove();
                                }
                            });
                        }
                        else {
                            if (self.feedback && self.feedback[0] && self._feedbackType !== 'original' && typeof self.feedback.remove === 'function') {
                                self.feedback.remove();
                            }
                        }
                    }
                }
                else {
                    this.element.style.zIndex = this.dragZIndex;
                    $(this.host).animate({
                        left: self.originalPosition.left - self._offset.hostRelative.left,
                        top: self.originalPosition.top - self._offset.hostRelative.top
                    }, parseInt(this.revertDuration, 10), function () {
                        self.element.style.zIndex = self._zIndexBackup;
                    });
                }
            }
        },

        _getHandle: function (event) {
            var handle;
            if (!this.handle) {
                handle = true;
            } else {
                $(this.handle, this.host).find('*').andSelf().each(function () {
                    if (this == event.target) handle = true;
                });
            }
            return handle;
        },

        _createFeedback: function (event) {
            var feedback;
            if (typeof this._feedbackType === 'function') {
                feedback = this._feedbackType();
            } else if (this._feedbackType === 'clone') {
                feedback = this.host.clone().removeAttr('id');
            } else {
                feedback = this.host;
            }
            if (!(/(absolute|fixed)/).test(feedback.css('position'))) {
                feedback.css('position', 'absolute');
            }
            if (this.appendTo[0] !== this.host.parent()[0] ||
                feedback[0] !== this.element) {
                var pos = {};
                feedback.css({
                    left: this.host.offset().left - this._getParentOffset(this.host).left + this._getParentOffset(feedback).left,
                    top: this.host.offset().top - this._getParentOffset(this.host).top + this._getParentOffset(feedback).top
                });
                feedback.appendTo(this.appendTo);
            }
            if (typeof this.initFeedback === 'function') {
                this.initFeedback(feedback);
            }
            return feedback;
        },

        _getParentOffset: function (element) {
            var element = element || this.feedback;
            this._offsetParent = element.offsetParent();
            var parentOffset = this._offsetParent.offset();
            if (this._positionType == 'absolute' && this._scrollParent[0] !== document && $.contains(this._scrollParent[0], this._offsetParent[0])) {
                parentOffset.left += this._scrollParent.scrollLeft();
                parentOffset.top += this._scrollParent.scrollTop();
            }
            if ((this._offsetParent[0] == document.body) ||
                (this._offsetParent[0].tagName && this._offsetParent[0].tagName.toLowerCase() == 'html' && $.jqx.browser.msie)) {
                parentOffset = { top: 0, left: 0 };
            }
            return {
                top: parentOffset.top + (parseInt(this._offsetParent.css('border-top-width'), 10) || 0),
                left: parentOffset.left + (parseInt(this._offsetParent.css('border-left-width'), 10) || 0)
            };

        },

        _getRelativeOffset: function (element) {
            var parent = this._scrollParent || element.parent();
            element = element || this.feedback;
            if (element.css('position') === 'relative') {
                var position = this.host.position();
                return {
                    top: position.top - (parseInt(element.css('top'), 10) || 0),
                    left: position.left - (parseInt(element.css('left'), 10) || 0)
                };
            } else {
                return { top: 0, left: 0 };
            }
        },

        _backupeMargins: function () {
            this.margins = {
                left: (parseInt(this.host.css('margin-left'), 10) || 0),
                top: (parseInt(this.host.css('margin-top'), 10) || 0),
                right: (parseInt(this.host.css('margin-right'), 10) || 0),
                bottom: (parseInt(this.host.css('margin-bottom'), 10) || 0)
            };
        },

        _backupFeedbackProportions: function () {
            this.feedback[0].style.opacity = this.opacity;
            this._feedbackProportions = {
                width: this.feedback.outerWidth(),
                height: this.feedback.outerHeight()
            };
        },

        _setRestricter: function () {
            if (this.restricter == 'parent') {
                this.restricter = this.feedback[0].parentNode;
            }
            if (this.restricter == 'document' || this.restricter == 'window') {
                this._handleNativeRestricter();
            }
            if (typeof this.restricter.left !== 'undefined' && typeof this.restricter.top !== 'undefined' &&
                       typeof this.restricter.height !== 'undefined' && typeof this.restricter.width !== 'undefined') {
                this._restricter = [this.restricter.left, this.restricter.top, this.restricter.width, this.restricter.height];
            } else if (!(/^(document|window|parent)$/).test(this.restricter) && this.restricter.constructor != Array) {
                this._handleDOMParentRestricter();

            } else if (this.restricter.constructor == Array) {
                this._restricter = this.restricter;
            }

        },

        _handleNativeRestricter: function () {
            this._restricter = [
                    this.restricter === 'document' ? 0 : $(window).scrollLeft() - this._offset.relative.left - this._offset.parent.left,
                    this.restricter === 'document' ? 0 : $(window).scrollTop() - this._offset.relative.top - this._offset.parent.top,
                    (this.restricter === 'document' ? 0 : $(window).scrollLeft()) + $(this.restricter === 'document' ? document : window).width() - this._feedbackProportions.width - this.margins.left,
                    (this.restricter === 'document' ? 0 : $(window).scrollTop()) + ($(this.restricter === 'document' ? document : window).height() || document.body.parentNode.scrollHeight) - this._feedbackProportions.height - this.margins.top
                ];
        },

        _handleDOMParentRestricter: function () {
            var restricter = $(this.restricter),
                restricterElement = restricter[0];
            if (!restricterElement) {
                return;
            }
            var over = ($(restricterElement).css('overflow') !== 'hidden');
            this._restricter = [
                (parseInt($(restricterElement).css('borderLeftWidth'), 10) || 0) + (parseInt($(restricterElement).css('paddingLeft'), 10) || 0),
                (parseInt($(restricterElement).css('borderTopWidth'), 10) || 0) + (parseInt($(restricterElement).css('paddingTop'), 10) || 0),
                (over ? Math.max(restricterElement.scrollWidth, restricterElement.offsetWidth) : restricterElement.offsetWidth) - (parseInt($(restricterElement).css('borderLeftWidth'), 10) || 0) - (parseInt($(restricterElement).css('paddingRight'), 10) || 0) - this._feedbackProportions.width - this.margins.left - this.margins.right,
                (over ? Math.max(restricterElement.scrollHeight, restricterElement.offsetHeight) : restricterElement.offsetHeight) - (parseInt($(restricterElement).css('borderTopWidth'), 10) || 0) - (parseInt($(restricterElement).css('paddingBottom'), 10) || 0) - this._feedbackProportions.height - this.margins.top - this.margins.bottom
            ];
            this._restrictiveContainer = restricter;
        },

        _convertPositionTo: function (d, position) {
            if (!position) {
                position = this.position;
            }
            var mod, scroll, scrollIsRootNode;
            if (d === 'absolute') {
                mod = 1;
            } else {
                mod = -1;
            }
            if (this._positionType === 'absolute' && !(this._scrollParent[0] != document && $.contains(this._scrollParent[0], this._offsetParent[0]))) {
                scroll = this._offsetParent;
            } else {
                scroll = this._scrollParent;
            }
            scrollIsRootNode = (/(html|body)/i).test(scroll[0].tagName);
            return this._getPosition(position, mod, scrollIsRootNode, scroll);

        },

        _getPosition: function (position, mod, scrollIsRootNode, scroll) {
            return {
                top: (
                    position.top
                    + this._offset.relative.top * mod
                    + this._offset.parent.top * mod
                    - ($.jqx.browser.safari && $.jqx.browser.version < 526 && this._positionType == 'fixed' ? 0 : (this._positionType == 'fixed' ? -this._scrollParent.scrollTop() : (scrollIsRootNode ? 0 : scroll.scrollTop())) * mod)
                ),
                left: (
                    position.left
                    + this._offset.relative.left * mod
                    + this._offset.parent.left * mod
                    - ($.jqx.browser.safari && $.jqx.browser.version < 526 && this._positionType == 'fixed' ? 0 : (this._positionType == 'fixed' ? -this._scrollParent.scrollLeft() : scrollIsRootNode ? 0 : scroll.scrollLeft()) * mod)
                )
            };
        },

        _generatePosition: function (event) {
            var scroll =
                this._positionType == 'absolute' &&
                !(this._scrollParent[0] != document &&
                $.contains(this._scrollParent[0], this._offsetParent[0])) ?
                this._offsetParent :
                this._scrollParent, scrollIsRootNode = (/(html|body)/i).test(scroll[0].tagName);

            var mouseCoordinates = this._getMouseCoordinates(event),
                pageX = mouseCoordinates.left,
                pageY = mouseCoordinates.top;
            if (this.originalPosition) {
                var restricter;
                if (this.restricter) {
                    if (this._restrictiveContainer) {
                        var co = this._restrictiveContainer.offset();
                        restricter = [this._restricter[0] + co.left,
                             this._restricter[1] + co.top,
                             this._restricter[2] + co.left,
                             this._restricter[3] + co.top];
                    } else {
                        restricter = this._restricter;
                    }
                    if (mouseCoordinates.left - this._offset.click.left < restricter[0]) {
                        pageX = restricter[0] + this._offset.click.left;
                    }
                    if (mouseCoordinates.top - this._offset.click.top < restricter[1]) {
                        pageY = restricter[1] + this._offset.click.top;
                    }
                    if (mouseCoordinates.left - this._offset.click.left > restricter[2]) {
                        pageX = restricter[2] + this._offset.click.left;
                    }
                    if (mouseCoordinates.top - this._offset.click.top > restricter[3]) {
                        pageY = restricter[3] + this._offset.click.top;
                    }
                }
            }
            return {
                top: (
                    pageY - this._offset.click.top - this._offset.relative.top - this._offset.parent.top + ($.jqx.browser.safari && $.jqx.browser.version < 526 && this._positionType == 'fixed' ? 0 : (this._positionType == 'fixed' ? -this._scrollParent.scrollTop() : (scrollIsRootNode ? 0 : scroll.scrollTop())))
                ),
                left: (
                    pageX - this._offset.click.left - this._offset.relative.left - this._offset.parent.left + ($.jqx.browser.safari && $.jqx.browser.version < 526 && this._positionType == 'fixed' ? 0 : (this._positionType == 'fixed' ? -this._scrollParent.scrollLeft() : scrollIsRootNode ? 0 : scroll.scrollLeft()))
                )
            };
        },

        _raiseEvent: function (eventId, data) {
            if (this.triggerEvents != undefined && this.triggerEvents == false)
                return;

            var eventName = this._events[eventId],
            event = $.Event(eventName),
            data = data || {};
            data.position = this.position;
            data.element = this.element;
            $.extend(data, this.data);
            data.feedback = this.feedback;
           // this.data = data;
            event.args = data;
          
            return this.host.trigger(event);
        },

        disable: function () {
            this.disabled = true;
            this.host.addClass(this.toThemeProperty('jqx-draggable-disabled'));
        },

        enable: function () {
            this.disabled = false;
            this.host.removeClass(this.toThemeProperty('jqx-draggable-disabled'));
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (key === 'dropTarget') {
                if (typeof value === 'string') {
                    object.dropTarget = $(value);
                }
            }
            else if (key == 'cursor') {
                object.host.css('cursor', object.cursor);
            }
        }

    });

})(jQuery);
(function ($) {

jqxListBoxDragDrop = function () {
    $.extend($.jqx._jqxListBox.prototype,
    {
        _hitTestBounds: function (listBox, hitLeft, hitTop) {
            var selfOffset = listBox.host.offset();
            var y = hitTop - parseInt(selfOffset.top);
            var x = hitLeft - parseInt(selfOffset.left);
            var item = listBox._hitTest(x, y);

            if (y < 0)
                return null;

            if (item != null) {
                var left = parseInt(selfOffset.left);
                var right = left + listBox.host.width();
                if (left <= hitLeft + item.width / 2 && hitLeft <= right)
                    return item;

                return null;
            }


            if (listBox.items && listBox.items.length > 0) {
                var lastItem = listBox.items[listBox.items.length - 1];
                //        if (y - 20 <= lastItem.top)
                //            item = lastItem;
                if (lastItem.top + lastItem.height + 15 >= y) {
                    return lastItem;
                }
            }

            return null;
        },

        _handleDragStart: function (elements, me) {
            var isTouchDevice = $.jqx.mobile.isTouchDevice();
            if (isTouchDevice) {
                if (me.allowDrag) {
                    elements.on($.jqx.mobile.getTouchEventName('touchstart'), function () {
                        $.jqx.mobile.setTouchScroll(false, me.element.id);
                    });
                }
            }

            elements.off('dragStart');
            elements.on('dragStart', function (event) {
                if (me.allowDrag && !me.disabled) {
                    me.feedbackElement = $("<div style='z-index: 99999; position: absolute;'></div>");
                    me.feedbackElement.addClass(me.toThemeProperty('jqx-listbox-feedback'));
                    me.feedbackElement.appendTo($(document.body));
                    me.feedbackElement.hide();
                    me.isDragging = true;
                    me._dragCancel = false;
                    var mousePosition = me._getMouseCoordinates(event);
                    var item = me._hitTestBounds(me, mousePosition.left, mousePosition.top);
                    var listBoxes = $.find('.jqx-listbox');
                    me._listBoxes = listBoxes;
                    $.each(me._listBoxes, function () {
                        var listBoxInstance = $.data(this, "jqxListBox").instance;
                        listBoxInstance._enableHover = listBoxInstance.enableHover;
                        listBoxInstance.enableHover = false;
                        $.jqx.mobile.setTouchScroll(false, me.element.id);
                    });

                    var stopDrag = function () {
                        me._dragCancel = true;
                        $(event.args.element).jqxDragDrop({ triggerEvents: false });
                        $(event.args.element).jqxDragDrop('cancelDrag');
                        clearInterval(me._autoScrollTimer);
                        $(event.args.element).jqxDragDrop({ triggerEvents: true });
                        $.each(me._listBoxes, function () {
                            var listBoxInstance = $.data(this, "jqxListBox").instance;
                            if (listBoxInstance._enableHover != undefined) {
                                listBoxInstance.enableHover = listBoxInstance._enableHover;
                                $.jqx.mobile.setTouchScroll(true, me.element.id);
                            }
                        });
                    }

                    if (item != null && !item.isGroup) {
                        me._dragItem = item;              
                        if (me.dragStart) {
                            var result = me.dragStart(item);
                            if (result == false) {
                                stopDrag();
                                return false;
                            }
                        }
                        if (item.disabled) {
                            stopDrag();
                        }
                        me._raiseEvent(4, { label: item.label, value: item.value, originalEvent: event.args });
                    }
                    else if (item == null) {
                        stopDrag();
                    }
                }
                return false;
            });
        },

        _handleDragging: function (elements, me) {
            elements.off('dragging');
            elements.on('dragging', function (event) {
                var args = event.args;
                if (me._dragCancel)
                    return;

                var mousePosition = me._getMouseCoordinates(event);
                var position = mousePosition;
                me._lastDraggingPosition = mousePosition;

                me._dragOverItem = null;
                me.feedbackElement.hide();

                $.each(me._listBoxes, function () {
                    var offset = $(this).offset();
                    var top = offset.top + 20;
                    var bottom = $(this).height() + top - 40;
                    var left = offset.left;
                    var width = $(this).width();
                    var right = left + width;
                    var listBoxInstance = $.data(this, "jqxListBox").instance;

                    var item = listBoxInstance._hitTestBounds(listBoxInstance, mousePosition.left, mousePosition.top);
                    var vScrollInstance = listBoxInstance.vScrollInstance;
                    if (item != null) {
                        if (listBoxInstance.allowDrop && !listBoxInstance.disabled) {
                            me._dragOverItem = item;
                            if (item.element) {
                                me.feedbackElement.show();
                                var itemTop = $(item.element).offset().top + 1;
                                if (position.top > itemTop + item.height / 2) {
                                    itemTop = itemTop + item.height;
                                }

                                me.feedbackElement.css('top', itemTop);
                                me.feedbackElement.css('left', left);
                                if (listBoxInstance.vScrollBar.css('visibility') != 'visible') {
                                    me.feedbackElement.width($(this).width());
                                }
                                else me.feedbackElement.width($(this).width() - 20);
                            }
                        }
                    }

                    if (mousePosition.left >= left && mousePosition.left < right) {
                        if (args.position.top < top && args.position.top >= top - 30) {
                            clearInterval(listBoxInstance._autoScrollTimer);
                            if (vScrollInstance.value != 0) {
                                me.feedbackElement.hide();
                            }
                            listBoxInstance._autoScrollTimer = setInterval(function () {
                                var scrolled = listBoxInstance.scrollUp();
                                if (!scrolled) clearInterval(listBoxInstance._autoScrollTimer);
                            }, 100);
                        }
                        else if (args.position.top > bottom && args.position.top < bottom + 30) {
                            clearInterval(listBoxInstance._autoScrollTimer);
                            if ((listBoxInstance.vScrollBar.css('visibility') != 'hidden') && vScrollInstance.value != vScrollInstance.max) {
                                me.feedbackElement.hide();
                            }

                            listBoxInstance._autoScrollTimer = setInterval(function () {
                                var scrolled = listBoxInstance.scrollDown();
                                if (!scrolled) clearInterval(listBoxInstance._autoScrollTimer);
                            }, 100);
                        }
                        else {
                            clearInterval(listBoxInstance._autoScrollTimer);
                        }
                    }
                    else {
                        if (me._dragOverItem == null) {
                            me.feedbackElement.hide();
                        }
                        clearInterval(listBoxInstance._autoScrollTimer);
                    }
                });
            });
        },

        _handleDragEnd: function (elements, me) {
            var listBoxes = $.find('.jqx-listbox');
            elements.off('dragEnd');
            elements.on('dragEnd', function (event) {
                clearInterval(me._autoScrollTimer);
                var _isTouchDevice = $.jqx.mobile.isTouchDevice();
                var position = _isTouchDevice ? me._lastDraggingPosition : me._getMouseCoordinates(event);

                var listBoxes = $.find('.jqx-listbox');
                var listBox = null;
                me.feedbackElement.remove();
                if (me._dragCancel)
                    return;

                $.each(listBoxes, function () {
                    var left = parseInt($(this).offset().left);
                    var right = left + $(this).width();
                    var listBoxInstance = $.data(this, "jqxListBox").instance;
                    clearInterval(listBoxInstance._autoScrollTimer);
                    if (listBoxInstance._enableHover != undefined) {
                        listBoxInstance.enableHover = listBoxInstance._enableHover;
                        $.jqx.mobile.setTouchScroll(true, me.element.id);
                    }

                    if (me._dragItem != null) {
                        if (position.left + me._dragItem.width / 2 >= left && position.left < right) {
                            var top = parseInt($(this).offset().top);
                            var bottom = top + $(this).height();
                            if (position.top >= top && position.top <= bottom) {
                                listBox = $(this);
                            }
                        }
                    }
                });
                var oldItem = me._dragItem;
                if (listBox != null && listBox.length > 0) {
                    var listBoxInstance = $.data(listBox[0], "jqxListBox").instance;
                    var allowDrop = listBoxInstance.allowDrop;

                    if (allowDrop && !listBoxInstance.disabled) {
                        var listBoxInstance = $.data(listBox[0], "jqxListBox").instance;
                        var item = listBoxInstance._hitTestBounds(listBoxInstance, position.left, position.top);
                        item = me._dragOverItem;
                        if (item != null && !item.isGroup) {
                            var result = true;
                            if (me.dragEnd) {
                                result = me.dragEnd(oldItem, item, event.args);
                                if (result == false) {
                                    $(event.args.element).jqxDragDrop({ triggerEvents: false });
                                    $(event.args.element).jqxDragDrop('cancelDrag');
                                    clearInterval(me._autoScrollTimer);
                                    $(event.args.element).jqxDragDrop({ triggerEvents: true });
                                    if (event.preventDefault) {
                                        event.preventDefault();
                                    }
                                    if (event.stopPropagation) {
                                        event.stopPropagation();
                                    }
                                    return false;
                                }
                                if (result == undefined) result = true;
                            }
                            if (result) {
                                var itemIndex = item.index;
                                var getCorrectIndexAfterDrop = function () {
                                    var index = item.index;
                                    for (var m = index - 2; m <= index + 2; m++) {
                                        if (listBoxInstance.items && listBoxInstance.items.length > m) {
                                            var currentItem = listBoxInstance.items[m];
                                            if (currentItem != null) {
                                                if (currentItem.value == oldItem.value)
                                                    return m;
                                            }
                                        }
                                    }
                                    return index;
                                }

                                if (listBoxInstance.dropAction != 'none') {
                                    var itemTop = $(item.element).offset().top + 1;
                                    if (listBoxInstance.content.find('.draggable').length > 0) {
                                        listBoxInstance.content.find('.draggable').jqxDragDrop('destroy');
                                    }
                                    if (position.top > itemTop + item.height / 2) {
                                        listBoxInstance.insertAt(me._dragItem, item.index + 1);
                                    }
                                    else {
                                        listBoxInstance.insertAt(me._dragItem, item.index);
                                    }

                                    if (me.dropAction == 'default') {
                                        if (oldItem.index > 0) {
                                            me.selectIndex(oldItem.index - 1);
                                        }
                                        me.removeItem(oldItem);
                                    }
                                    var index = getCorrectIndexAfterDrop();
                                    listBoxInstance.selectIndex(index);
                                }
                            }
                        }
                        else {
                            if (listBoxInstance.dropAction != 'none') {
                                if (listBoxInstance.content.find('.draggable').length > 0)
                                {
                                    listBoxInstance.content.find('.draggable').jqxDragDrop('destroy');
                                }
                                if (me.dragEnd) {
                                    var result = me.dragEnd(me._dragItem, me._dragItem, event.args);
                                    if (result == false) {
                                        $(event.args.element).jqxDragDrop({ triggerEvents: false });
                                        $(event.args.element).jqxDragDrop('cancelDrag');
                                        clearInterval(me._autoScrollTimer);
                                        $(event.args.element).jqxDragDrop({ triggerEvents: true });
                                        if (event.preventDefault) {
                                            event.preventDefault();
                                        }
                                        if (event.stopPropagation) {
                                            event.stopPropagation();
                                        }
                                        return false;
                                    }
                                    if (result == undefined) result = true;
                                }
                                listBoxInstance.addItem(me._dragItem);
                                if (listBoxInstance.dropAction == 'default') {
                                    if (oldItem.index > 0) {
                                        me.selectIndex(oldItem.index - 1);
                                    }
                                    me.removeItem(oldItem);
                                }

                                listBoxInstance.selectIndex(listBoxInstance.items.length - 1);
                            }
                        }
                    }
                }
                else {
                    if (me.dragEnd) {
                        var dragEnd = me.dragEnd(oldItem, event.args);
                        if (false == dragEnd) {
                            if (event.preventDefault) {
                                event.preventDefault();
                            }
                            if (event.stopPropagation) {
                                event.stopPropagation();
                            }
                            return false;
                        } 
                    }
                }
                if (oldItem != null) {
                    me._raiseEvent(5, { label: oldItem.label, value: oldItem.value, originalEvent: event.args });
                }
                return false;
            });
        },

        _enableDragDrop: function () {
            if (this.allowDrag && this.host.jqxDragDrop) {
                var elements = this.content.find('.draggable');
                if (elements.length > 0) {
                    var me = this;
                    elements.jqxDragDrop({
                        cursor: 'arrow', revertDuration: 0, appendTo: 'body', dragZIndex: 99999, revert: true,
                        initFeedback: function (feedback) {
                            var title = $('<span style="white-space: nowrap;" class="' + me.toThemeProperty('jqx-fill-state-normal') + '">' + feedback.text() + '</span>');
                            $(document.body).append(title);
                            var width = title.width();
                            title.remove();
                            feedback.width(width + 5);
                            feedback.addClass(me.toThemeProperty('jqx-fill-state-pressed'));
                        }
                    });
                    this._autoScrollTimer = null;
                    me._dragItem = null;
                    me._handleDragStart(elements, me);
                    me._handleDragging(elements, me);
                    me._handleDragEnd(elements, me);
                }
            }
        },

        _getMouseCoordinates: function (event) {
            this._isTouchDevice = $.jqx.mobile.isTouchDevice();
            if (this._isTouchDevice) {
                var pos = $.jqx.position(event);
                return {
                    left: pos.left,
                    top: pos.top
                };
            } else {
                return {
                    left: event.args.pageX,
                    top: event.args.pageY
                };
            }
        }
    });
}

jqxTreeDragDrop = function () {
    $.extend($.jqx._jqxTree.prototype,
    {
        _hitTestBounds: function (treeInstance, left, top) {
            var me = this;
            var treeItem = null;
            if (treeInstance._visibleItems) {
                var hostLeft = parseInt(treeInstance.host.offset().left);
                var hostWidth = treeInstance.host.outerWidth();

                $.each(treeInstance._visibleItems, function (index) {
                    if (left >= hostLeft && left < hostLeft + hostWidth)
                        if (this.top + 5 < top && top < this.top + this.height) {
                            var parentElement = $(this.element).parents('li:first');
                            if (parentElement.length > 0) {
                                treeItem = treeInstance.getItem(parentElement[0]);
                                if (treeItem != null) {
                                    treeItem.height = this.height;
                                    treeItem.top = this.top;
                                    return false;
                                }
                            }
                        }
                });
            }
            return treeItem;
        },

        _handleDragStart: function (elements, me) {
            if (me._dragOverItem) {
                me._dragOverItem.titleElement.removeClass(me.toThemeProperty('jqx-fill-state-hover'));
            }

            var isTouchDevice = $.jqx.mobile.isTouchDevice();
            if (isTouchDevice) {
                if (me.allowDrag) {
                    elements.on($.jqx.mobile.getTouchEventName('touchstart'), function () {
                        $.jqx.mobile.setTouchScroll(false, 'panel' + me.element.id);
                    });
                }
            }

            elements.off('dragStart');
            elements.on('dragStart', function (event) {
                me.feedbackElement = $("<div style='z-index: 99999; position: absolute;'></div>");
                me.feedbackElement.addClass(me.toThemeProperty('jqx-listbox-feedback'));
                me.feedbackElement.appendTo($(document.body));
                me.feedbackElement.hide();
                me._dragCancel = false;
                var position = event.args.position;
                var trees = $.find('.jqx-tree');
                me._trees = trees;
                $.each(trees, function () {
                    var treeInstance = $.data(this, "jqxTree").instance;
                    var elements = treeInstance.host.find('.draggable');
                    treeInstance._syncItems(elements);
                    if (treeInstance.allowDrag && !treeInstance.disabled) {
                        var parentElement = $(event.target).parents('li:first');
                        if (parentElement.length > 0) {
                            var item = treeInstance.getItem(parentElement[0]);
                            if (item) {
                                me._dragItem = item;
                                if (treeInstance.dragStart) {
                                    var result = treeInstance.dragStart(item);
                                    if (result == false) {
                                        me._dragCancel = true;
                                        $(event.args.element).jqxDragDrop({ triggerEvents: false });
                                        $(event.args.element).jqxDragDrop('cancelDrag');
                                        clearInterval(me._autoScrollTimer);
                                        $(event.args.element).jqxDragDrop({ triggerEvents: treeInstance });
                                        return false;
                                    }
                                }
                                treeInstance._raiseEvent(8, { label: item.label, value: item.value, originalEvent: event.args })
                            }
                        }
                    }
                });

                return false;
            });
        },

        _getMouseCoordinates: function (event) {
            this._isTouchDevice = $.jqx.mobile.isTouchDevice();
            if (this._isTouchDevice) {
                var pos = $.jqx.position(event);
                return {
                    left: pos.left,
                    top: pos.top
                };
            } else {
                return {
                    left: event.args.pageX,
                    top: event.args.pageY
                };
            }
        },

        _handleDragging: function (elements, me) {
            var elements = this.host.find('.draggable');
            elements.off('dragging');
            elements.on('dragging', function (event) {
                var args = event.args;
                var position = args.position;
                var trees = me._trees;
                if (me._dragCancel)
                    return;

                if (me._dragOverItem) {
                    me._dragOverItem.titleElement.removeClass(me.toThemeProperty('jqx-fill-state-hover'));
                }

                var outsideTree = true;
                var mouseCoordinates = me._getMouseCoordinates(event);
                me._lastDraggingPosition = mouseCoordinates;
                $.each(trees, function () {
                    var offset = $(this).offset();
                    var top = offset.top + 20;
                    var bottom = $(this).height() + top - 40;
                    var left = offset.left;
                    var width = $(this).width();
                    var right = left + width;
                    var treeInstance = $.data(this, "jqxTree").instance;

                    if (treeInstance.disabled || !treeInstance.allowDrop)
                        return;

                    var vScrollInstance = treeInstance.vScrollInstance;
                    var item = treeInstance._hitTestBounds(treeInstance, mouseCoordinates.left, mouseCoordinates.top);
                    if (item != null) {
                        if (me._dragOverItem) {
                            me._dragOverItem.titleElement.removeClass(treeInstance.toThemeProperty('jqx-fill-state-hover'));
                        }
                        me._dragOverItem = item;
                        if (item.element) {
                            me.feedbackElement.show();
                            var itemTop = item.top;
                            var topPos = mouseCoordinates.top;
                            me._dropPosition = 'before';
                            if (topPos > itemTop + item.height / 3) {
                                itemTop = item.top + item.height / 2;
                                me._dragOverItem.titleElement.addClass(me.toThemeProperty('jqx-fill-state-hover'));
                                me.feedbackElement.hide();
                                me._dropPosition = 'inside';
                            }
                            if (topPos > (item.top + item.height) - item.height / 3) {
                                itemTop = item.top + item.height;
                                me._dragOverItem.titleElement.removeClass(me.toThemeProperty('jqx-fill-state-hover'));
                                me.feedbackElement.show();
                                me._dropPosition = 'after';
                            }

                            me.feedbackElement.css('top', itemTop);
                            var left = -2 + parseInt(item.titleElement.offset().left);
                            me.feedbackElement.css('left', left);
                            me.feedbackElement.width($(item.titleElement).width() + 12);
                        }
                    }

                    if (mouseCoordinates.left >= left && mouseCoordinates.left < right) {
                        if (mouseCoordinates.top + 20 >= top && mouseCoordinates.top <= top + treeInstance.host.height()) {
                            outsideTree = false;
                        }

                        if (mouseCoordinates.top < top && mouseCoordinates.top >= top - 30) {
                            clearInterval(treeInstance._autoScrollTimer);
                            if (vScrollInstance.value != 0) {
                                me.feedbackElement.hide();
                            }
                            treeInstance._autoScrollTimer = setInterval(function () {
                                var scrolled = treeInstance.panelInstance.scrollUp();
                                var treeElements = treeInstance.host.find('.draggable');
                                treeInstance._syncItems(treeElements);
                                if (!scrolled) clearInterval(treeInstance._autoScrollTimer);
                            }, 100);
                        }
                        else if (mouseCoordinates.top > bottom && mouseCoordinates.top < bottom + 30) {
                            clearInterval(treeInstance._autoScrollTimer);
                            if (vScrollInstance.value != vScrollInstance.max) {
                                me.feedbackElement.hide();
                            }

                            treeInstance._autoScrollTimer = setInterval(function () {
                                var scrolled = treeInstance.panelInstance.scrollDown();
                                var treeElements = treeInstance.host.find('.draggable');
                                treeInstance._syncItems(treeElements);
                                if (!scrolled) clearInterval(treeInstance._autoScrollTimer);
                            }, 100);
                        }
                        else {
                            clearInterval(treeInstance._autoScrollTimer);
                        }
                    }
                    else {
                        clearInterval(treeInstance._autoScrollTimer);
                    }
                });
                if (outsideTree) {
                    if (me.feedbackElement) {
                        me.feedbackElement.hide();
                    }
                }
            });
        },

        _handleDragEnd: function (elements, me) {
            elements.off('dragEnd');
            elements.on('dragEnd', function (event) {
                var elements = me.host.find('.draggable');
                clearInterval(me._autoScrollTimer);
                var position = event.args.position;
                var trees = me._trees;
                var tree = null;
                var _isTouchDevice = $.jqx.mobile.isTouchDevice();
                var mouseCoordinates = _isTouchDevice ? me._lastDraggingPosition : me._getMouseCoordinates(event);

                me.feedbackElement.remove();
                if (me._dragCancel)
                    return false;

                if (me._dragOverItem) {
                    me._dragOverItem.titleElement.removeClass(me.toThemeProperty('jqx-fill-state-hover'));
                }

                $.each(trees, function () {
                    var left = parseInt($(this).offset().left);
                    var right = left + $(this).width();
                    var treeInstance = $.data(this, "jqxTree").instance;
                    clearInterval(treeInstance._autoScrollTimer);
                    if (me._dragItem != null) {
                        if (mouseCoordinates.left >= left && mouseCoordinates.left < right) {
                            var top = parseInt($(this).offset().top);
                            var bottom = top + $(this).height();
                            if (mouseCoordinates.top >= top && mouseCoordinates.top <= bottom) {
                                tree = $(this);
                            }
                        }
                    }
                });
                var oldItem = me._dragItem;
                if (tree != null && tree.length > 0) {
                    var allowDrop = tree.jqxTree('allowDrop');
                    if (allowDrop) {
                        var treeInstance = $.data(tree[0], "jqxTree").instance;
                        var item = me._dragOverItem;
                        if (item != null && me._dragOverItem.treeInstance.element.id == treeInstance.element.id) {
                            var result = true;
                            if (me.dragEnd) {
                                result = me.dragEnd(oldItem, item, event.args, me._dropPosition, tree);
                                if (result == false) {
                                    $(event.args.element).jqxDragDrop({ triggerEvents: false });
                                    $(event.args.element).jqxDragDrop('cancelDrag');
                                    clearInterval(me._autoScrollTimer);
                                    $(event.args.element).jqxDragDrop({ triggerEvents: true });
                                }
                                if (undefined == result) result = true;
                            }
                            if (result) {
                                var updateSourceTree = function () {
                                    var oldTreeInstance = me._dragItem.treeInstance;
                                    oldTreeInstance._refreshMapping();
                                    oldTreeInstance._updateItemsNavigation();
                                    oldTreeInstance._render(true, false);
                                    if (oldTreeInstance.checkboxes) {
                                        oldTreeInstance._updateCheckStates();
                                    }
                                    me._dragItem.treeInstance = treeInstance;
                                    me._syncItems(me._dragItem.treeInstance.host.find('.draggable'));
                             //       oldTreeInstance._enableDragDrop();
                                }

                                if (treeInstance.dropAction != 'none') {
                                    if (me._dragItem.id != me._dragOverItem.id) {
                                        if (me._dropPosition == 'inside') {
                                            treeInstance._drop(me._dragItem.element, me._dragOverItem.element, -1, treeInstance);
                                            updateSourceTree();
                                        }
                                        else {
                                            var offset = 0;
                                            if (me._dropPosition == 'after') offset++;
                                            treeInstance._drop(me._dragItem.element, me._dragOverItem.parentElement, offset + $(me._dragOverItem.element).index(), treeInstance);
                                            updateSourceTree();
                                        }
                                    }
                                }

                                treeInstance._render(true, false);
                                var treeElements = treeInstance.host.find('.draggable');
                                me._syncItems(treeElements);
                                me._dragOverItem = null;
                                me._dragItem = null;
                                treeInstance._refreshMapping();
                                treeInstance._updateItemsNavigation();
                                treeInstance.selectedItem = null;
                                treeInstance.selectItem(oldItem.element);
                                if (treeInstance.checkboxes) {
                                    treeInstance._updateCheckStates();
                                }
                                treeInstance._render(true, false);
                                //      treeInstance._enableDragDrop();
                            }
                        }
                        else {
                            if (treeInstance.dropAction != 'none') {
                                if (treeInstance.allowDrop) {
                                    var result = true;
                                    if (me.dragEnd) {
                                        result = me.dragEnd(oldItem, item, event.args, me._dropPosition, tree);
                                        if (result == false) {
                                            $(event.args.element).jqxDragDrop({ triggerEvents: false });
                                            $(event.args.element).jqxDragDrop('cancelDrag');
                                            clearInterval(me._autoScrollTimer);
                                            $(event.args.element).jqxDragDrop({ triggerEvents: true });
                                        }
                                        if (undefined == result) result = true;
                                    }
                                    if (result) {
                                        me._dragItem.parentElement = null;
                                        treeInstance._drop(me._dragItem.element, null, -1, treeInstance);
                                        var oldInstance = me._dragItem.treeInstance;
                                        oldInstance._refreshMapping();
                                        oldInstance._updateItemsNavigation();
                                        if (oldInstance.checkboxes) {
                                            oldInstance._updateCheckStates();
                                        }
                                        var treeElements = oldInstance.host.find('.draggable');
                                        me._syncItems(treeElements);
                                        me._dragItem.treeInstance = treeInstance;
                                        treeInstance.items[treeInstance.items.length] = me._dragItem;
                                        treeInstance._render(true, false);
                                        treeInstance.selectItem(oldItem.element);
                                        treeInstance._refreshMapping();
                                        treeInstance._updateItemsNavigation();
                                        var treeElements = treeInstance.host.find('.draggable');
                                        treeInstance._syncItems(treeElements);
                                        if (treeInstance.checkboxes) {
                                            treeInstance._updateCheckStates();
                                        }
                                        me._dragOverItem = null;
                                        me._dragItem = null;
                                        //          treeInstance._enableDragDrop();
                                    }
                                }
                            }
                        }
                    }
                }
                else {
                    if (me.dragEnd) {
                        var dropResult = me.dragEnd(oldItem, event.args);
                        if (false == dropResult) {
                            return false;
                        }
                    }
                }
                if (oldItem != null) {
                    me._raiseEvent(7, { label: oldItem.label, value: oldItem.value, originalEvent: event.args });
                }
                return false;
            });
        },

        _drop: function (element, parentElement, index, treeInstance) {
            if ($(parentElement).parents('#' + element.id).length > 0)
                return;

            if (parentElement != null) {
                if (parentElement.id == element.id)
                    return;
            }

            var me = this;
            if (treeInstance.element.innerHTML.indexOf('UL')) {
                var innerElement = treeInstance.host.find('ul:first');
            }

            if (parentElement == undefined && parentElement == null) {
                if (index == undefined || index == -1) {
                    innerElement.append(element);
                }
                else {
                    if (innerElement.children('li').eq(index).length == 0) {
                        innerElement.children('li').eq(index - 1).after(element);
                    }
                    else {
                        if (innerElement.children('li').eq(index)[0].id != element.id) {
                            innerElement.children('li').eq(index).before(element);
                        }
                    }
                }
            }
            else if (index == undefined || index == -1) {
                parentElement = $(parentElement);
                var parentUL = parentElement.find('ul:first');
                if (parentUL.length == 0) {
                    ulElement = $('<ul></ul>');
                    $(parentElement).append(ulElement);
                    parentUL = parentElement.find('ul:first');
                    var item = treeInstance.itemMapping["id" + parentElement[0].id].item;
                    item.subtreeElement = parentUL[0];
                    item.hasItems = true;
                    parentUL.addClass(treeInstance.toThemeProperty('jqx-tree-dropdown'));
                    parentUL.append(element);
                    element = parentUL.find('li:first');
                    item.parentElement = element;
                }
                else {
                    parentUL.append(element);
                }
            }
            else {
                parentElement = $(parentElement);
                var parentUL = parentElement.find('ul:first');
                if (parentUL.length == 0) {
                    ulElement = $('<ul></ul>');
                    $(parentElement).append(ulElement);
                    parentUL = parentElement.find('ul:first');
                    if (parentElement) {
                        var item = treeInstance.itemMapping["id" + parentElement[0].id].item;
                        item.subtreeElement = parentUL[0];
                        item.hasItems = true;
                    }

                    parentUL.addClass(treeInstance.toThemeProperty('jqx-tree-dropdown'));
                    parentUL.append(element);
                    element = parentUL.find('li:first');
                    item.parentElement = element;
                }
                else {
                    if (parentUL.children('li').eq(index).length == 0) {
                        parentUL.children('li').eq(index - 1).after(element);
                    }
                    else {
                        if (parentUL.children('li').eq(index)[0].id != element.id) {
                            parentUL.children('li').eq(index).before(element);
                        }
                    }
                }
            }
        },

        _enableDragDrop: function () {
            if (this.allowDrag && this.host.jqxDragDrop) {
                var elements = this.host.find('.draggable');
                var me = this;

                if (elements.length > 0) {
                    elements.jqxDragDrop({ cursor: 'arrow', revertDuration: 0, appendTo: 'body', dragZIndex: 99999, revert: true,
                        initFeedback: function (feedback) {
                            var title = $('<span style="white-space: nowrap;" class="' + me.toThemeProperty('jqx-fill-state-normal') + '">' + feedback.text() + '</span>');
                            $(document.body).append(title);
                            var width = title.width();
                            title.remove();
                            feedback.width(width + 5);
                            feedback.addClass(me.toThemeProperty('jqx-fill-state-pressed'));
                        }
                    });
                    var destroyed = elements.jqxDragDrop('isDestroyed');
                    if (destroyed) {
                        elements.jqxDragDrop('_createDragDrop');
                    }

                    this._autoScrollTimer = null;
                    me._dragItem = null;
                    me._handleDragStart(elements, me);
                    me._handleDragging(elements, me);
                    me._handleDragEnd(elements, me);
                }
            }
        }
    });
}
})(jQuery);

(function ($) {

    $.jqx.jqxWidget("jqxComboBox", "", {});

    $.extend($.jqx._jqxComboBox.prototype, {
        defineInstance: function () {
            // enables/disables the combobox.
            this.disabled = false;
            // gets or sets the listbox width.
            this.width = 200;
            // gets or sets the listbox height.
            this.height = 25;
            // Represents the collection of list items.
            this.items = new Array();
            // Gets or sets the selected index.
            this.selectedIndex = -1;
            this.selectedItems = new Array();
            this._selectedItems = new Array();
            // data source.
            this.source = null;
            // gets or sets the scrollbars size.
            this.scrollBarSize = $.jqx.utilities.scrollBarSize;
            // gets or sets the scrollbars size.
            this.arrowSize = 18;
            // enables/disables the hover state.
            this.enableHover = true;
            // enables/disables the selection.
            this.enableSelection = true;
            // gets the visible items. // this property is internal for the combobox.
            this.visualItems = new Array();
            // gets the groups. // this property is internal for the combobox.
            this.groups = new Array();
            // gets or sets whether the items width should be equal to the combobox's width.
            this.equalItemsWidth = true;
            // gets or sets the height of the ListBox Items. When the itemHeight == - 1, each item's height is equal to its desired height.
            this.itemHeight = -1;
            // represents the combobox's events.
            this.visibleItems = new Array();
            // emptry group's text.
            this.emptyGroupText = 'Group';
            this.emptyString = "";
            // Type: Number
            // Default: 100
            // Showing Popup Animation's delay.
            if (this.openDelay == undefined) {
                this.openDelay = 250;
            }
            // Type: Number
            // Default: 200
            // Hiding Popup Animation's delay.
            if (this.closeDelay == undefined) {
                this.closeDelay = 300;
            }
            // default, none
            // Type: String.
            // enables or disables the animation.
            this.animationType = 'default';
            // Type: String
            // Default: auto ( the drop down takes the combobox's width.)
            // Sets the popup's width.
            this.dropDownWidth = 'auto';
            // Type: String
            // Default: 200px ( the height is 200px )
            // Sets the popup's height.
            this.dropDownHeight = '200px';
            // Type: Boolean
            // Default: false
            // Sets the popup's height to be equal to the items summary height;            
            this.autoDropDownHeight = false;
            // Type: Boolean
            // Default: false
            // Enables or disables the browser detection.
            this.enableBrowserBoundsDetection = false;
            this.dropDownHorizontalAlignment = 'left';
            // Type: String
            // Default: startswithignorecase
            // Possible Values: 'none, 'contains', 'containsignorecase', 'equals', 'equalsignorecase', 'startswithignorecase', 'startswith', 'endswithignorecase', 'endswith'
            this.searchMode = 'startswithignorecase';
            this.autoComplete = false;
            this.remoteAutoComplete = false;
            this.remoteAutoCompleteDelay = 500;
            this.selectionMode = "default";
            this.minLength = 2;
            this.displayMember = "";
            this.valueMember = "";
            this.keyboardSelection = true;
            this.renderer = null;
            this.autoOpen = false;
            this.checkboxes = false;
            this.promptText = "";
            this.placeHolder = "";
            this.rtl = false;
            this.listBox = null;
            this.renderSelectedItem = null;
            this.search = null;
            this.popupZIndex = 100000;
            this.searchString = null;
            this.multiSelect = false;
            this.showArrow = true;
            this.touchMode = 'auto';
            this.aria =
            {
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
            this.events =
	   	    [
            // occurs when the combobox is opened.
		      'open',
            // occurs when the combobox is closed.
              'close',
            // occurs when an item is selected.
              'select',
            // occurs when an item is unselected.
              'unselect',
            // occurs when the selection is changed.
              'change',
            // triggered when the user checks or unchecks an item. 
              'checkChange',
            // triggered when the binding is completed.
              'bindingComplete'
	   	    ];
        },

        createInstance: function (args) {
            var me = this;
            this.host.attr('role', 'combobox');
            $.jqx.aria(this, "aria-autocomplete", "both");

            if ($.jqx._jqxListBox == null || $.jqx._jqxListBox == undefined) {
                throw new Error("jqxComboBox: Missing reference to jqxlistbox.js.");
            }
            $.jqx.aria(this);

            // prompt text is deprecated.
            if (this.promptText != "") {
                this.placeHolder = this.promptText;
            }

            this.render();
        },

        render: function () {
            this.removeHandlers();
            this.isanimating = false;
            this.id = $.jqx.utilities.createId();
            this.element.innerHTML = "";
            var comboStructure = $("<div style='background-color: transparent; -webkit-appearance: none; outline: none; width:100%; height: 100%; padding: 0px; margin: 0px; border: 0px; position: relative;'>" +
                "<div id='dropdownlistWrapper' style='padding: 0; margin: 0; border: none; background-color: transparent; float: left; width:100%; height: 100%; position: relative;'>" +
                "<div id='dropdownlistContent' style='padding: 0; margin: 0; border-top: none; border-bottom: none; float: left; position: absolute;'/>" +
                "<div id='dropdownlistArrow' style='padding: 0; margin: 0; border-left-width: 1px; border-bottom-width: 0px; border-top-width: 0px; border-right-width: 0px; float: right; position: absolute;'/>" +
                "</div>" +
                "</div>");
            this.comboStructure = comboStructure;
            if ($.jqx._jqxListBox == null || $.jqx._jqxListBox == undefined) {
                throw "jqxComboBox: Missing reference to jqxlistbox.js.";
            }

            this.touch = $.jqx.mobile.isTouchDevice();
            if (this.touchMode === true) {
                this.touch = true;
            }

            this.host.append(comboStructure);

            this.dropdownlistWrapper = this.host.find('#dropdownlistWrapper');
            this.dropdownlistArrow = this.host.find('#dropdownlistArrow');
            this.dropdownlistContent = this.host.find('#dropdownlistContent');
            this.dropdownlistContent.addClass(this.toThemeProperty('jqx-combobox-content'));
            this.dropdownlistContent.addClass(this.toThemeProperty('jqx-widget-content'));
            this.dropdownlistWrapper[0].id = "dropdownlistWrapper" + this.element.id;
            this.dropdownlistArrow[0].id = "dropdownlistArrow" + this.element.id;
            this.dropdownlistContent[0].id = "dropdownlistContent" + this.element.id;

            this.dropdownlistContent.append($('<input autocomplete="off" style="margin: 0; padding: 0; border: 0;" type="textarea"/>'));
            this.input = this.dropdownlistContent.find('input');
            this.input.addClass(this.toThemeProperty('jqx-combobox-input'));
            this.input.addClass(this.toThemeProperty('jqx-widget-content'));
            this._addInput();
            if (this.rtl) {
                this.input.css({ direction: "rtl" });
                this.dropdownlistContent.addClass(this.toThemeProperty('jqx-combobox-content-rtl'));
            }

            try {
                var listBoxID = 'listBox' + this.id;
                var oldContainer = $($.find('#' + listBoxID));
                if (oldContainer.length > 0) {
                    oldContainer.remove();
                }
                $.jqx.aria(this, "aria-owns", listBoxID);
                $.jqx.aria(this, "aria-haspopup", true);
                $.jqx.aria(this, "aria-multiline", false);

                var container = $("<div style='overflow: hidden; border: none; background-color: transparent; position: absolute;' id='listBox" + this.id + "'><div id='innerListBox" + this.id + "'></div></div>");
                container.hide();
                container.appendTo(document.body);
                this.container = container;
                this.listBoxContainer = $($.find('#innerListBox' + this.id));

                var width = this.width;
                if (this.dropDownWidth != 'auto') {
                    width = this.dropDownWidth;
                }

                if (this.dropDownHeight == null) {
                    this.dropDownHeight = 200;
                }

                var me = this;
                this.container.width(parseInt(width) + 25);
                this.container.height(parseInt(this.dropDownHeight) + 25);
                this.addHandler(this.listBoxContainer, 'bindingComplete', function (event) {          
                    me._raiseEvent('6');
                });

                var initializing = true;
                this.listBoxContainer.jqxListBox({
                    _checkForHiddenParent: false,
                    checkboxes: this.checkboxes, emptyString: this.emptyString,
                    renderer: this.renderer, rtl: this.rtl, itemHeight: this.itemHeight, selectedIndex: this.selectedIndex, incrementalSearch: false, width: width, scrollBarSize: this.scrollBarSize, autoHeight: this.autoDropDownHeight, height: this.dropDownHeight, displayMember: this.displayMember, valueMember: this.valueMember, source: this.source, theme: this.theme,
                    rendered: function () {
                        me.listBox = $.data(me.listBoxContainer[0], "jqxListBox").instance;
                        if (me.remoteAutoComplete) {
                            if (me.autoDropDownHeight) {
                                me.container.height(me.listBox.virtualSize.height + 25);
                                me.listBoxContainer.height(me.listBox.virtualSize.height);
                                me.listBox._arrange();
                            }
                            else {
                                me.listBox._arrange();
                                me.listBox.ensureVisible(0);
                                me.listBox._renderItems();
                                me.container.height(me.listBoxContainer.height() + 25);
                            }

                            if (me.searchString != undefined && me.searchString.length >= me.minLength) {
                                var items = me.listBoxContainer.jqxListBox('items');
                                if (items) {
                                    if (items.length > 0) {
                                        if (!me.isOpened()) {
                                            me.open();
                                        }
                                    }
                                    else me.close();
                                } else me.close();
                            }
                            else {
                                me.close();
                            }
                        }
                        else {
                            me.renderSelection('mouse');
                            if (me.multiSelect) {
                                me.doMultiSelect(false);
                            }
                        }

                        if (me.rendered) {
                            me.rendered();
                        }
                    }
                });
                this.listBoxContainer.css({ position: 'absolute', zIndex: this.popupZIndex, top: 0, left: 0 });
                this.listBoxContainer.css('border-top-width', '1px');
                this.listBoxContainer.addClass(this.toThemeProperty('jqx-popup'));
                if ($.jqx.browser.msie) {
                    this.listBoxContainer.addClass(this.toThemeProperty('jqx-noshadow'));
                }
                this.listBox = $.data(this.listBoxContainer[0], "jqxListBox").instance;
                this.listBox.enableSelection = this.enableSelection;
                this.listBox.enableHover = this.enableHover;
                this.listBox.equalItemsWidth = this.equalItemsWidth;
                this.listBox._arrange();
                this.addHandler(this.listBoxContainer, 'unselect', function (event) {
                    if (!me.multiSelect) {
                        me._raiseEvent('3', { index: event.args.index, type: event.args.type, item: event.args.item });
                    }
                });
         
                this.addHandler(this.listBoxContainer, 'change', function (event) {
                    if (!me.multiSelect) {
                        me._raiseEvent('4', { index: event.args.index, type: event.args.type, item: event.args.item });
                    }
                });

                if (this.animationType == 'none') {
                    this.container.css('display', 'none');
                }
                else {
                    this.container.hide();
                }
                initializing = false;
            }
            catch (e) {

            }

            var self = this;
            self.input.attr('disabled', self.disabled);
            var ie7 = $.jqx.browser.msie && $.jqx.browser.version < 8;
            if (!ie7) {
                self.input.attr('placeholder', self.placeHolder);
            }

            this.propertyChangeMap['disabled'] = function (instance, key, oldVal, value) {
                if (value) {
                    instance.host.addClass(self.toThemeProperty('jqx-combobox-state-disabled'));
                    instance.host.addClass(self.toThemeProperty('jqx-fill-state-disabled'));
                    instance.dropdownlistContent.addClass(self.toThemeProperty('jqx-combobox-content-disabled'));
                }
                else {
                    instance.host.removeClass(self.toThemeProperty('jqx-combobox-state-disabled'));
                    instance.host.removeClass(self.toThemeProperty('jqx-fill-state-disabled'));
                    instance.dropdownlistContent.removeClass(self.toThemeProperty('jqx-combobox-content-disabled'));
                }
                instance.input.attr('disabled', instance.disabled);
                $.jqx.aria(instance, "aria-disabled", instance.disabled);
                instance.input.attr('disabled', self.disabled);
            }

            if (this.disabled) {
                this.host.addClass(this.toThemeProperty('jqx-combobox-state-disabled'));
                this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
                this.dropdownlistContent.addClass(this.toThemeProperty('jqx-combobox-content-disabled'));
            }

            this.host.addClass(this.toThemeProperty('jqx-combobox-state-normal'));
            this.host.addClass(this.toThemeProperty('jqx-combobox'));
            this.host.addClass(this.toThemeProperty('jqx-rc-all'));
            this.host.addClass(this.toThemeProperty('jqx-widget'));
            this.host.addClass(this.toThemeProperty('jqx-widget-content'));
            this.dropdownlistArrowIcon = $("<div></div>");
            this.dropdownlistArrowIcon.addClass(this.toThemeProperty('jqx-icon-arrow-down'));
            this.dropdownlistArrowIcon.addClass(this.toThemeProperty('jqx-icon'));
            this.dropdownlistArrow.append(this.dropdownlistArrowIcon);
            this.dropdownlistArrow.addClass(this.toThemeProperty('jqx-combobox-arrow-normal'));
            this.dropdownlistArrow.addClass(this.toThemeProperty('jqx-fill-state-normal'));
            if (!this.rtl) {
                this.dropdownlistArrow.addClass(this.toThemeProperty('jqx-rc-r'));
            }
            else {
                this.dropdownlistArrow.addClass(this.toThemeProperty('jqx-rc-l'));
            }

            this._setSize();
            this._updateHandlers();

            this.addHandler(this.input, 'keyup.textchange', function (event) {
                var foundMatch = me._search(event);
                if (me.cinput && me.input) {
                    me.cinput[0].value = me.input[0].value;
                }
            });

            // fix for IE7
            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                if (this.host.parents('.jqx-window').length > 0) {
                    var zIndex = this.host.parents('.jqx-window').css('z-index');
                    container.css('z-index', zIndex + 10);
                    this.listBoxContainer.css('z-index', zIndex + 10);
                }
            }

            if (this.checkboxes) {
                this.input.attr('readonly', true);
                $.jqx.aria(this, "aria-readonly", true);
            }
            else {
                $.jqx.aria(this, "aria-readonly", false);
            }
            if (!this.remoteAutoComplete) {
                this.searchString = "";
            }
        },

        _addInput: function () {
            var name = this.host.attr('name');
            if (!name) name = this.element.id;
            this.cinput = $("<input type='hidden'/>");
            this.host.append(this.cinput);
            this.cinput.attr('name', name);
        },

        _updateInputSelection: function () {
            if (this.cinput) {
                if (this.selectedIndex == -1) {
                    this.cinput.val("");
                }
                else {
                    var selectedItem = this.getSelectedItem();
                    if (selectedItem != null) {
                        this.cinput.val(selectedItem.value);
                    }
                    else {
                        this.cinput.val(this.dropdownlistContent.text());
                    }
                }

                if (this.checkboxes || this.multiSelect) {
                    if (!this.multiSelect) {
                        var items = this.getCheckedItems();
                    }
                    else {
                        var items = this.getSelectedItems();
                    }

                    var str = "";
                    if (items != null) {
                        for (var i = 0; i < items.length; i++) {
                            if (i == items.length - 1) {
                                str += items[i].value;
                            }
                            else {
                                str += items[i].value + ",";
                            }
                        }
                    }
                    this.cinput.val(str);
                }
            }
        },

        _search: function (event) {
            if (event.keyCode == 9)
                return;

            if (this.searchMode == 'none' || this.searchMode == null || this.searchMode == 'undefined') {
                return;
            }

            if (event.keyCode == 16 || event.keyCode == 17 || event.keyCode == 20)
                return false;

            if (this.checkboxes) {
                return false;
            }

            if (this.multiSelect) {
                var span = $("<span style='visibility: hidden; white-space: nowrap;'>" + this.input.val() + "</span>");
                span.addClass(this.toThemeProperty('jqx-widget'));
                $(document.body).append(span);
                var width = span.width() + 15;
                span.remove();

                if (width > this.host.width()) {
                    width = this.host.width();
                }
                if (width < 25) {
                    width = 25;
                }

                this.input.css('width', width + 'px');
                var top = parseInt(this._findPos(this.host[0])[1]) + parseInt(this.host.outerHeight()) - 1 + 'px';
                var isMobileBrowser = $.jqx.mobile.isSafariMobileBrowser() || $.jqx.mobile.isWindowsPhone();
                var hasTransform = $.jqx.utilities.hasTransform(this.host);
                if (hasTransform || (isMobileBrowser != null && isMobileBrowser)) {
                    top = $.jqx.mobile.getTopPos(this.element) + parseInt(this.host.outerHeight());
                    if ($('body').css('border-top-width') != '0px') {
                        top = parseInt(top) - this._getBodyOffset().top + 'px';
                    }
                }

                this.container.css('top', top);
                var height = parseInt(this.host.height());
                this.dropdownlistArrow.height(height);
            }

            if (!this.isanimating) {
                if (event.altKey && event.keyCode == 38) {
                    this.hideListBox('altKey');
                    return false;
                }

                if (event.altKey && event.keyCode == 40) {
                    if (!this.isOpened()) {
                        this.showListBox('altKey');
                    }
                    return false;
                }
            }

            if (event.keyCode == 37 || event.keyCode == 39)
                return false;

            if (event.altKey || event.keyCode == 18)
                return;

            if (event.keyCode >= 33 && event.keyCode <= 40) {
                return;
            }

            if (event.ctrlKey || this.ctrlKey) {
                return;
            }

            var value = this.input.val();
            if (value.length == 0 && !this.autoComplete) {
                this.listBox.searchString = this.input.val();
                this.hideListBox('search');
                this.searchString = this.input.val();
                return;
            }

            if (this.remoteAutoComplete) {
                var me = this;
                var clearListSelection = function () {
                    me.listBox.vScrollInstance.value = 0;
                }

                if (value.length >= me.minLength) {
                    if (!event.ctrlKey && !event.altKey) {
                        if (me.searchString != value) {
                            var source = me.listBoxContainer.jqxListBox('source');
                            if (source == null) {
                                me.listBoxContainer.jqxListBox({ source: me.source });
                            }
                            if (this._searchTimer) {
                                clearTimeout(this._searchTimer);
                            }
                            if (event.keyCode != 13 && event.keyCode != 27) {
                                this._searchTimer = setTimeout(function () {
                                    clearListSelection();
                                    if (me.autoDropDownHeight) {
                                        me.listBox.autoHeight = true;
                                    }
                                    me.searchString = me.input.val();
                                    if (me.search != null) {
                                        me.search(me.input.val());
                                    }
                                    else {
                                        throw "'search' function is not defined";
                                    }

                                }, this.remoteAutoCompleteDelay);
                            }
                        }
                        me.searchString = value;
                    }
                }
                else {
                    if (this._searchTimer) clearTimeout(this._searchTimer);
                    clearListSelection();
                    me.searchString = "";
                    me.listBoxContainer.jqxListBox({ source: null });
                }
                return;
            }

            var me = this;
            if (value === me.searchString) {
                return;
            }

            if (!(event.keyCode == '27' || event.keyCode == '13')) {
                var matches = this._updateItemsVisibility(value);
                var matchItems = matches.matchItems;
                var index = matches.index;
                if (!this.autoComplete && !this.removeAutoComplete) {
                    if (!this.multiSelect || (this.multiSelect && index >= 0)) {
                        this.listBox.selectIndex(index);
                        var isInView = this.listBox.isIndexInView(index);
                        if (!isInView) {
                            this.listBox.ensureVisible(index);
                        }
                        else {
                            this.listBox._renderItems();
                        }
                    }
                }

                if (this.autoComplete && matchItems.length === 0) {
                    this.hideListBox('search');
                }
            }

            if (event.keyCode == '13') {
                var isOpen = this.container.css('display') == 'block';
                if (isOpen && !this.isanimating) {
                    this.hideListBox('keyboard');
                    this._oldvalue = this.listBox.selectedValue;
                    return;
                }
            }
            else if (event.keyCode == '27') {
                var isOpen = this.container.css('display') == 'block';
                if (isOpen && !this.isanimating) {
                    if (!self.multiSelect) {
                        var item = this.listBox.getVisibleItem(this._oldvalue);
                        if (item) {
                            var self = this;
                            setTimeout(
                                   function () {
                                       if (self.autoComplete) {
                                           self._updateItemsVisibility("");
                                       }
                                       self.listBox.selectIndex(item.index);
                                       self.renderSelection('api');
                                   }, self.closeDelay);
                        }
                        else {
                            this.clearSelection();
                        }
                    }
                    else {
                        self.input.val("");
                        self.listBox.selectedValue = null;
                    }

                    this.hideListBox('keyboard');
                    this.renderSelection('api');
                    event.preventDefault();
                    return false;
                }
            }
            else {
                if (!this.isOpened() && !this.opening && !event.ctrlKey) {
                    if (this.listBox.visibleItems && this.listBox.visibleItems.length > 0) {
                        if (this.input.val() != this.searchString && this.searchString != undefined && index != -1) {
                            this.showListBox('search');
                        }
                    }
                }
                this.searchString = this.input.val();

                if (this.searchString == "") {
                    index = -1;
                }

                var item = this.listBox.getVisibleItem(index);

                if (item != undefined) {
                    this._updateInputSelection();
                }
            }
        },

        val: function (value) {
            if (!this.input) return "";
            if (typeof value === 'object' || arguments.length == 0) {
                var item = this.getSelectedItem();
                if (item) {
                    return item.value;
                }

                return this.input.val();
            }
            else {
                var item = this.getItemByValue(value);
                if (item != null) {
                    this.selectItem(item);
                }
                else {
                    this.input.val(value);
                }
                return this.input.val();
            }
        },

        focus: function () {
            var me = this;
            var doFocus = function () {
                me.input.focus();
                var val = me.input.val();
                me._setSelection(0, val.length);
            }
            doFocus();
            setTimeout(function () {
                doFocus();
            }, 10);
        },

        _setSelection: function (start, end) {
            try {
                if ('selectionStart' in this.input[0]) {
                    this.input[0].focus();
                    this.input[0].setSelectionRange(start, end);
                }
                else {
                    var range = this.input[0].createTextRange();
                    range.collapse(true);
                    range.moveEnd('character', end);
                    range.moveStart('character', start);
                    range.select();
                }
            }
            catch (error) {
            }
        },

        setContent: function (value) {
            this.input.val(value);
        },

        // get all matches of a searched value.
        _updateItemsVisibility: function (value) {
            var items = this.getItems();
            if (items == undefined) {
                return { index: -1, matchItem: new Array() }
            }

            var me = this;
            var index = -1;
            var matchItems = new Array();
            var newItemsIndex = 0;

            $.each(items, function (i) {
                var itemValue = '';
                if (!this.isGroup) {
                    if (this.label) {
                        itemValue = this.label;
                    }
                    else if (this.value) {
                        itemValue = this.value;
                    }
                    else if (this.title) {
                        itemValue = this.title;
                    }
                    else itemValue = 'jqxItem';

                    var matches = false;
                    switch (me.searchMode) {
                        case 'containsignorecase':
                            matches = $.jqx.string.containsIgnoreCase(itemValue, value);
                            break;
                        case 'contains':
                            matches = $.jqx.string.contains(itemValue, value);
                            break;
                        case 'equals':
                            matches = $.jqx.string.equals(itemValue, value);
                            break;
                        case 'equalsignorecase':
                            matches = $.jqx.string.equalsIgnoreCase(itemValue, value);
                            break;
                        case 'startswith':
                            matches = $.jqx.string.startsWith(itemValue, value);
                            break;
                        case 'startswithignorecase':
                            matches = $.jqx.string.startsWithIgnoreCase(itemValue, value);
                            break;
                        case 'endswith':
                            matches = $.jqx.string.endsWith(itemValue, value);
                            break;
                        case 'endswithignorecase':
                            matches = $.jqx.string.endsWithIgnoreCase(itemValue, value);
                            break;
                    }

                    if (me.autoComplete && !matches) {
                        this.visible = false;
                    }

                    if (matches && me.autoComplete) {
                        matchItems[newItemsIndex++] = this;
                        this.visible = true;
                        index = this.visibleIndex;
                    }

                    if (value == '' && me.autoComplete) {
                        this.visible = true;
                        matches = false;
                    }

                    if (me.multiSelect) {
                        this.disabled = false;
                        if (me.selectedItems.indexOf(this.value) >= 0) {
                            this.disabled = true;
                            matches = false;
                        }
                    }

                    if (!me.multiSelect) {
                        if (matches && !me.autoComplete) {
                            index = this.visibleIndex;
                            return false;
                        }
                    }
                    else {
                        if (matches && !me.autoComplete) {
                            if (index === -1) {
                                index = this.visibleIndex;
                            }
                            return true;
                        }
                    }
                }
            });
            this.listBox.searchString = value;
            var that = this;
            var selectFirstItem = function () {
                if (!that.multiSelect) return;
                var nonDisabledIndex = 0;
                var foundIndex = false;
                var item = null;
                for (var indx = 0; indx < that.listBox.items.length; indx++) {
                    that.listBox.selectedIndexes[indx] = -1;
                    if (!that.listBox.items[indx].disabled) {
                        if (foundIndex == false) {
                            item = that.listBox.items[indx];
                            nonDisabledIndex = item.visibleIndex;
                            foundIndex = true;
                        }
                    }
                }
                that.listBox.selectedIndex = -1;
                that.listBox.selectedIndex = nonDisabledIndex;
                that.listBox.selectedIndexes[nonDisabledIndex] = nonDisabledIndex;
                if (that.listBox.visibleItems.length > 0) {
                    if (item) {
                        that.listBox.selectedValue = item.value;
                    }
                    else {
                        that.listBox.selectedValue = null;
                    }
                }
                else {
                    that.listBox.selectedValue = null;
                }
                that.listBox.ensureVisible(0);
            }

            if (!this.autoComplete) {
                selectFirstItem();
                return { index: index, matchItems: matchItems };
            }

            this.listBox.renderedVisibleItems = new Array();
            var vScrollValue = this.listBox.vScrollInstance.value;
            this.listBox.vScrollInstance.value = 0;
            this.listBox.visibleItems = new Array();
            this.listBox._renderItems();
            var selectedValue = this.listBox.selectedValue;
            var item = this.listBox.getItemByValue(selectedValue);
            if (!this.multiSelect) {
                if (item) {
                    if (item.visible) {
                        this.listBox.selectedIndex = item.visibleIndex;
                        for (var indx = 0; indx < this.listBox.items.length; indx++) {
                            this.listBox.selectedIndexes[indx] = -1;
                        }
                        this.listBox.selectedIndexes[item.visibleIndex] = item.visibleIndex;
                    }
                    else {
                        for (var indx = 0; indx < this.listBox.items.length; indx++) {
                            this.listBox.selectedIndexes[indx] = -1;
                        }
                        this.listBox.selectedIndex = -1;
                    }
                }
            }
            else {
                selectFirstItem();
            }

            this.listBox._renderItems();
            var height = this.listBox._calculateVirtualSize().height;
            if (height < vScrollValue) {
                vScrollValue = 0;
                this.listBox.vScrollInstance.refresh();
            }
            if (this.autoDropDownHeight) {
                this._disableSelection = true;
                if (this.listBox.autoHeight != this.autoDropDownHeight) {
                    this.listBoxContainer.jqxListBox({ autoHeight: this.autoDropDownHeight });
                }
                this.container.height(height + 25);
                this.listBox.invalidate();
                this._disableSelection = false;
            }
            else {
                if (height < parseInt(this.dropDownHeight)) {
                    var scrollOffset = this.listBox.hScrollBar[0].style.visibility == "hidden" ? 0 : 20;
                    this.listBox.height = scrollOffset + height;
                    this.container.height(height + 25 + scrollOffset);
                    this.listBox.invalidate();
                }
                else {
                    this.listBox.height = parseInt(this.dropDownHeight);
                    this.container.height(parseInt(this.dropDownHeight) + 25);
                    this.listBox.invalidate();
                }
            }

            this.listBox.vScrollInstance.setPosition(vScrollValue);
            return { index: index, matchItems: matchItems };
        },

        // gets all items that match to a search value.
        findItems: function (value) {
            var items = this.getItems();
            var me = this;
            var index = 0;
            var matchItems = new Array();

            $.each(items, function (i) {
                var itemValue = '';
                if (!this.isGroup) {
                    if (this.label) {
                        itemValue = this.label;
                    }
                    else if (this.value) {
                        itemValue = this.value;
                    }
                    else if (this.title) {
                        itemValue = this.title;
                    }
                    else itemValue = 'jqxItem';

                    var matches = false;
                    switch (me.searchMode) {
                        case 'containsignorecase':
                            matches = $.jqx.string.containsIgnoreCase(itemValue, value);
                            break;
                        case 'contains':
                            matches = $.jqx.string.contains(itemValue, value);
                            break;
                        case 'equals':
                            matches = $.jqx.string.equals(itemValue, value);
                            break;
                        case 'equalsignorecase':
                            matches = $.jqx.string.equalsIgnoreCase(itemValue, value);
                            break;
                        case 'startswith':
                            matches = $.jqx.string.startsWith(itemValue, value);
                            break;
                        case 'startswithignorecase':
                            matches = $.jqx.string.startsWithIgnoreCase(itemValue, value);
                            break;
                        case 'endswith':
                            matches = $.jqx.string.endsWith(itemValue, value);
                            break;
                        case 'endswithignorecase':
                            matches = $.jqx.string.endsWithIgnoreCase(itemValue, value);
                            break;
                    }

                    if (matches) {
                        matchItems[index++] = this;
                    }
                }
            });

            return matchItems;
        },

        //[optimize]
        _resetautocomplete: function () {
            $.each(this.listBox.items, function (i) {
                this.visible = true;
            });
            this.listBox.vScrollInstance.value = 0;
            this.listBox._addItems();
            this.listBox.autoHeight = false;

            this.listBox.height = this.dropDownHeight;
            this.container.height(parseInt(this.dropDownHeight) + 25);
            this.listBoxContainer.height(parseInt(this.dropDownHeight));
            this.listBox._arrange();

            this.listBox._addItems();
            this.listBox._renderItems();
        },

        // gets all items.
        getItems: function () {
            var item = this.listBox.items;
            return item;
        },

        getVisibleItems: function () {
            return this.listBox.getVisibleItems();
        },

        _setSize: function () {
            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                this.host.width(this.width);
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    this.host.width(this.width);
                };

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                this.host.height(this.height);
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                this.host.height(this.height);
            };

            var isPercentage = false;
            if (this.width != null && this.width.toString().indexOf("%") != -1) {
                isPercentage = true;
                this.host.width(this.width);
            }

            if (this.height != null && this.height.toString().indexOf("%") != -1) {
                isPercentage = true;
                this.host.height(this.height);
            }

            if (isPercentage) {
                var me = this;
                var width = this.host.width();
                if (this.dropDownWidth != 'auto') {
                    width = this.dropDownWidth;
                }
                this.listBoxContainer.jqxListBox({ width: width });
                this.container.width(parseInt(width) + 25);
                this._arrange();
            }
            var me = this;
            var resizeFunc = function () {
                if (me.multiSelect) {
                    me.host.height(me.height);
                }

                me._arrange();
                if (me.multiSelect) {
                    me.host.height('auto');
                }
                if (me.dropDownWidth == 'auto') {
                    var width = me.host.width();
                    me.listBoxContainer.jqxListBox({ width: width });
                    me.container.width(parseInt(width) + 25);
                }
            }

            $.jqx.utilities.resize(this.host, function () {
                resizeFunc();
            });
        },

        // returns true when the listbox is opened, otherwise returns false.
        isOpened: function () {
            var me = this;
            var openedListBox = $.data(document.body, "openedComboJQXListBox" + this.element.id);

            if (this.container.css('display') != 'block')
                return false;

            if (openedListBox != null && openedListBox == me.listBoxContainer) {
                return true;
            }

            return false;
        },

        _updateHandlers: function () {
            var self = this;
            var hovered = false;
            this.removeHandlers();

            if (this.multiSelect) {
                this.addHandler(this.dropdownlistContent, 'click', function (event) {
                    if (event.target.href) return false;

                    self.input.focus();
                    setTimeout(function () {
                        self.input.focus();
                    }, 10);
                });
                this.addHandler(this.dropdownlistContent, 'focus', function (event) {
                    if (event.target.href) return false;

                    self.input.focus();
                    setTimeout(function () {
                        self.input.focus();
                    }, 10);
                });
            }

            if (!this.touch) {
                if (this.host.parents()) {
                    this.addHandler(this.host.parents(), 'scroll.combobox' + this.element.id, function (event) {
                        var opened = self.isOpened();
                        if (opened) {
                            self.close();
                        }
                    });
                }

                this.addHandler(this.host, 'mouseenter', function () {
                    if (!self.disabled && self.enableHover) {
                        hovered = true;
                        self.host.addClass(self.toThemeProperty('jqx-combobox-state-hover'));
                        self.dropdownlistArrowIcon.addClass(self.toThemeProperty('jqx-icon-arrow-down-hover'));
                        self.dropdownlistArrow.addClass(self.toThemeProperty('jqx-combobox-arrow-hover'));
                        self.dropdownlistArrow.addClass(self.toThemeProperty('jqx-fill-state-hover'));
                    }
                });
                this.addHandler(this.host, 'mouseleave', function () {
                    if (!self.disabled && self.enableHover) {
                        self.host.removeClass(self.toThemeProperty('jqx-combobox-state-hover'));
                        self.dropdownlistArrowIcon.removeClass(self.toThemeProperty('jqx-icon-arrow-down-hover'));
                        self.dropdownlistArrow.removeClass(self.toThemeProperty('jqx-combobox-arrow-hover'));
                        self.dropdownlistArrow.removeClass(self.toThemeProperty('jqx-fill-state-hover'));
                        hovered = false;
                    }
                });
            }

            if (self.autoOpen) {
                this.addHandler(this.host, 'mouseenter', function () {
                    var isOpened = self.isOpened();
                    if (!isOpened && self.autoOpen) {
                        self.open();
                        self.host.focus();
                    }
                });

                this.addHandler($(document), 'mousemove.' + self.id, function (event) {
                    var isOpened = self.isOpened();
                    if (isOpened && self.autoOpen) {
                        var offset = self.host.coord();
                        var top = offset.top;
                        var left = offset.left;
                        var popupOffset = self.container.coord();
                        var popupLeft = popupOffset.left;
                        var popupTop = popupOffset.top;

                        canClose = true;

                        if (event.pageY >= top && event.pageY <= top + self.host.height() + 2) {
                            if (event.pageX >= left && event.pageX < left + self.host.width())
                                canClose = false;
                        }
                        if (event.pageY >= popupTop && event.pageY <= popupTop + self.container.height() - 20) {
                            if (event.pageX >= popupLeft && event.pageX < popupLeft + self.container.width())
                                canClose = false;
                        }

                        if (canClose) {
                            self.close();
                        }
                    }
                });
            }

            var eventName = 'mousedown';
            if (this.touch) eventName = $.jqx.mobile.getTouchEventName('touchstart');

            var dropDownButtonClicked = function (event) {
                if (!self.disabled) {
                    var isOpen = self.container.css('display') == 'block';
                    if (!self.isanimating) {
                        if (isOpen) {
                            self.hideListBox('api');
                            if (!$.jqx.mobile.isTouchDevice()) {
                                self.input.focus();
                                setTimeout(function () {
                                    self.input.focus();
                                }, 10);
                            }
                            return false;
                        }
                        else {
                            if (self.autoDropDownHeight) {
                                self.container.height(self.listBoxContainer.height() + 25);
                                var autoheight = self.listBoxContainer.jqxListBox('autoHeight');
                                if (!autoheight) {
                                    self.listBoxContainer.jqxListBox({ autoHeight: self.autoDropDownHeight })
                                    self.listBox._arrange();
                                    self.listBox.ensureVisible(0);
                                    self.listBox._renderItems();
                                    self.container.height(self.listBoxContainer.height() + 25);
                                }
                            }
                            self.showListBox('api');
                            if (!$.jqx.mobile.isTouchDevice()) {
                                self.focus();
                            }
                            else {
                                return false;
                            }
                        }
                    }
                }
            }

            this.addHandler(this.dropdownlistArrow, eventName,
            function (event) {
                dropDownButtonClicked(event);
            });
            this.addHandler(this.dropdownlistArrowIcon, eventName,
            function (event) {
            });

            this.addHandler(this.host, 'focus', function () {
                self.focus();
            });

            this.addHandler(this.input, 'focus', function (event) {
                self.focused = true;
                self.host.addClass(self.toThemeProperty('jqx-combobox-state-focus'));
                self.host.addClass(self.toThemeProperty('jqx-fill-state-focus'));
                self.dropdownlistContent.addClass(self.toThemeProperty('jqx-combobox-content-focus'));
                if (event.stopPropagation) {
                    event.stopPropagation();
                }
                if (event.preventDefault) {
                    event.preventDefault();
                }
                return false;

            });
            this.addHandler(this.input, 'blur', function () {
                self.focused = false;
                if (!self.isOpened() && !self.opening) {
                    if (self.selectionMode == "dropDownList") {
                        self._selectOldValue();
                    }

                    self.host.removeClass(self.toThemeProperty('jqx-combobox-state-focus'));
                    self.host.removeClass(self.toThemeProperty('jqx-fill-state-focus'));
                    self.dropdownlistContent.removeClass(self.toThemeProperty('jqx-combobox-content-focus'));
                }
                if (self._searchTimer) clearTimeout(self._searchTimer);
            });
            this.addHandler($(document), 'mousedown.' + this.id, self.closeOpenedListBox, { me: this, listbox: this.listBox, id: this.id });
            if (this.touch) {
                this.addHandler($(document), $.jqx.mobile.getTouchEventName('touchstart') + '.' + this.id, self.closeOpenedListBox, { me: this, listbox: this.listBox, id: this.id });
            }

            this.addHandler(this.host, 'keydown', function (event) {
                var isOpen = self.container.css('display') == 'block';
                self.ctrlKey = event.ctrlKey;
                if (self.host.css('display') == 'none') {
                    return true;
                }

                if (event.keyCode == '13' || event.keyCode == '9') {
                    if (isOpen && !self.isanimating) {
                        if (self.listBox.selectedIndex != -1) {
                            self.renderSelection('mouse');
                            var index = self.listBox.selectedIndex;
                            var item = self.listBox.getVisibleItem(index);
                            if (item)
                            {
                                self.listBox.selectedValue = item.value;
                            }
                            self._setSelection(self.input.val().length, self.input.val().length);
                            self.hideListBox('keyboard');
                        }
                        if (event.keyCode == '13') {
                            self._oldvalue = self.listBox.selectedValue;
                        }
                        if (!self.keyboardSelection) {
                            self._raiseEvent('2', { index: self.selectedIndex, type: 'keyboard', item: self.getItem(self.selectedIndex) });
                        }

                        if (event.keyCode == '9') return true;
                        return false;
                    }
                }

                if (event.keyCode == 115) {
                    if (!self.isanimating) {
                        if (!self.isOpened()) {
                            self.showListBox('keyboard');
                        }
                        else if (self.isOpened()) {
                            self.hideListBox('keyboard');
                        }
                    }
                    return false;
                }

                if (event.altKey) {
                    if (self.host.css('display') == 'block') {
                        if (!self.isanimating) {
                            if (event.keyCode == 38) {
                                if (self.isOpened()) {
                                    self.hideListBox('altKey');
                                }
                            }
                            else if (event.keyCode == 40) {
                                if (!self.isOpened()) {
                                    self.showListBox('altKey');
                                }
                            }
                        }
                    }
                }

                if (event.keyCode == '27' || event.keyCode == '9') {
                    if (self.isOpened() && !self.isanimating) {
        
                        if (event.keyCode == '27') {
                            if (!self.multiSelect) {
                                var item = self.listBox.getVisibleItem(self._oldvalue);
                                if (item) {
                                    setTimeout(
                                        function () {
                                            if (self.autoComplete) {
                                                self._updateItemsVisibility("");
                                            }
                                            self.listBox.selectIndex(item.index);
                                            self.renderSelection('api');
                                        }, self.closeDelay);
                                }
                                else {
                                    self.clearSelection();
                                }
                            }
                            else {
                                self.listBox.selectedValue = null;
                                self.input.val("");
                            }
                        }
                        self.hideListBox('keyboard');


                        if (event.keyCode == '9')
                            return true;

                        self.renderSelection('api');
                        event.preventDefault();

                        return false;
                    }
                }

                var key = event.keyCode;

                if (isOpen && !self.disabled && key != 8) {
                    return self.listBox._handleKeyDown(event);
                }
                else if (!self.disabled && !isOpen) {
                    var key = event.keyCode;
                    // arrow keys.
                    if (key == 33 || key == 34 || key == 35 || key == 36 || key == 38 || key == 40) {
                        return self.listBox._handleKeyDown(event);
                    }
                }
                if (key === 8 && self.multiSelect) {
                    if (self.input.val().length === 0) {
                        var lastItem = self.selectedItems[self.selectedItems.length - 1];
                        self.selectedItems.pop();
                        self._selectedItems.pop();
                        if (lastItem) {
                            self._raiseEvent('3', { index: lastItem.index, type: 'keyboard', item: lastItem });
                            self._raiseEvent('4', { index: lastItem.index, type: 'keyboard', item: lastItem });
                        }

                        self.listBox.selectedValue = null;
                        self.doMultiSelect();
                        return false;
                    }
                }
            });

            this.addHandler(this.listBoxContainer, 'checkChange', function (event) {
                self.renderSelection('mouse');
                self._updateInputSelection();
                self._raiseEvent(5, { label: event.args.label, value: event.args.value, checked: event.args.checked, item: event.args.item });
            });

            this.addHandler(this.listBoxContainer, 'select', function (event) {
                if (!self.disabled) {
                    if (event.args.type != 'keyboard' || self.keyboardSelection) {
                        self.renderSelection(event.args.type);
                        if (!self.multiSelect) {
                            self._raiseEvent('2', { index: event.args.index, type: event.args.type, item: event.args.item });
                        }
                        if (event.args.type == 'mouse') {
                            self._oldvalue = self.listBox.selectedValue;

                            if (!self.checkboxes) {
                                self.hideListBox('mouse');
                                if (!self.touch) {
                                    self.input.focus();
                                }
                                else {
                                    return false;
                                }
                            }
                        }
                    }
                }
            });
            if (this.listBox != null && this.listBox.content != null) {
                this.addHandler(this.listBox.content, 'click', function (event) {
                    if (!self.disabled) {
                        if (self.listBox.itemswrapper) {
                            if (event.target === self.listBox.itemswrapper[0])
                                return true;
                        }

                        if (event.target && event.target.className) {
                            if (event.target.className.indexOf('jqx-fill-state-disabled') >= 0) {                             
                                return true;
                            }
                        }

                        self.renderSelection('mouse');
                        self._oldvalue = self.listBox.selectedValue;
                        if (!self.touch && !self.ishiding) {
                            if (!self.checkboxes) {
                                self.hideListBox('mouse');
                                self.input.focus();
                            }
                        }
                        if (self.touch === true) {
                            if (!self.checkboxes) {
                                self.hideListBox('mouse');
                            }
                        }
                    }
                });
            }
        },

        _selectOldValue: function()
        {
            var self = this;
            if (self.listBox.selectedIndex == -1) {
                if (!self.multiSelect) {
                    var item = self.listBox.getVisibleItem(self._oldvalue);
                    if (item) {
                        setTimeout(
                            function () {
                                if (self.autoComplete) {
                                    self._updateItemsVisibility("");
                                }
                                self.listBox.selectIndex(item.index);
                                self.renderSelection('api');
                            }, self.closeDelay);
                    }
                    else {
                        self.clearSelection();
                        self.listBox.selectIndex(0);
                        self.renderSelection('api');
                    }
                }
                else {
                    self.listBox.selectedValue = null;
                    self.input.val("");
                }
            }
            else {
                self.renderSelection('api');
            }
        },

        removeHandlers: function () {
            var self = this;
            if (this.dropdownlistWrapper != null) {
                this.removeHandler(this.dropdownlistWrapper, 'mousedown');
            }

            if (this.dropdownlistContent) {
                this.removeHandler(this.dropdownlistContent, 'click');
                this.removeHandler(this.dropdownlistContent, 'focus');
            }
            this.removeHandler(this.host, 'keydown');
            this.removeHandler(this.host, 'focus');
            if (this.input != null) {
                this.removeHandler(this.input, 'focus');
                this.removeHandler(this.input, 'blur');
            }
            this.removeHandler(this.host, 'mouseenter');
            this.removeHandler(this.host, 'mouseleave');
            this.removeHandler($(document), 'mousemove.' + self.id);
            if (this.listBoxContainer) {
                this.removeHandler(this.listBoxContainer, 'checkChange');
                this.removeHandler(this.listBoxContainer, 'select');
            }

            if (this.dropdownlistArrowIcon && this.dropdownlistArrow) {
                var eventName = 'mousedown';
                if (this.touch) eventName = $.jqx.mobile.getTouchEventName('touchstart');
                this.removeHandler(this.dropdownlistArrowIcon, eventName);
                this.removeHandler(this.dropdownlistArrow, eventName);
            }
        },

        // gets an item by index.
        getItem: function (index) {
            var item = this.listBox.getItem(index);
            return item;
        },

        getItemByValue: function (value) {
            var item = this.listBox.getItemByValue(value);
            return item;
        },

        getVisibleItem: function (index) {
            var item = this.listBox.getVisibleItem(index);
            return item;
        },

        // renders the selection.
        renderSelection: function (type) {
            if (type == undefined || type == 'none') {
                return;
            }

            if (this._disableSelection === true)
                return;

            if (this.listBox == null)
                return;

            if (this.multiSelect) {
                return;
            }
            var item = this.listBox.visibleItems[this.listBox.selectedIndex];

            if (this.autoComplete && !this.checkboxes) {
                if (this.listBox.selectedValue !== undefined) {
                    var item = this.getItemByValue(this.listBox.selectedValue);
                }
            }

            if (this.checkboxes) {
                var checkedItems = this.getCheckedItems();
                if (checkedItems != null && checkedItems.length > 0) {
                    item = checkedItems[0];
                }
                else item = null;
            }
            if (item == null) {
                var ie7 = $.jqx.browser.msie && $.jqx.browser.version < 8;
                this.input.val("");
                if (!ie7) {
                    this.input.attr('placeholder', this.placeHolder);
                }
                this._updateInputSelection();
                return;
            }

            this.selectedIndex = this.listBox.selectedIndex;
            var spanElement = $('<span></span>');

            if (item.label != undefined && item.label != null && item.label.toString().length > 0) {
                $.jqx.utilities.html(spanElement, item.label);
            }
            else if (item.value != undefined && item.value != null && item.value.toString().length > 0) {
                $.jqx.utilities.html(spanElement, item.value);
            }
            else if (item.title != undefined && item.title != null && item.title.toString().length > 0) {
                $.jqx.utilities.html(spanElement, item.title);
            }
            else {
                $.jqx.utilities.html(spanElement, this.emptyString);
            }
            var spanHeight = spanElement.outerHeight();
            if (this.checkboxes) {
                var items = this.getCheckedItems();
                var str = "";
                for (var i = 0; i < items.length; i++) {
                    if (i == items.length - 1) {
                        str += items[i].label;
                    }
                    else {
                        str += items[i].label + ", ";
                    }
                }
                this.input.val(str);
            }
            else {
                this.input.val(spanElement.text());
            }
            spanElement.remove();
            if (this.renderSelectedItem) {
                var result = this.renderSelectedItem(this.listBox.selectedIndex, item);
                if (result != undefined) {
                    this.input.val(result);
                }
            }
            this._updateInputSelection();
            if (this.listBox && this.listBox._activeElement) {
                $.jqx.aria(this, "aria-activedescendant", this.listBox._activeElement.id);
            }
        },

        dataBind: function () {
            this.listBoxContainer.jqxListBox({ source: this.source });
            this.renderSelection('mouse');
            if (this.source == null) {
                this.clearSelection();
            }
        },

        clear: function () {
            this.listBoxContainer.jqxListBox({ source: null });
            this.clearSelection();
        },

        // clears the selection.
        clearSelection: function (render) {
            this.selectedIndex = -1;
            this.listBox.clearSelection();
            this.input.val("");
            if (this.multiSelect) {
                this.listBox.selectedValue = "";
                this.selectedItems = new Array();
                this._selectedItems = new Array();
                this.doMultiSelect(false);
            }
        },

        // unselects an item at specific index.
        // @param Number
        unselectIndex: function (index, render) {
            if (isNaN(index))
                return;

            this.listBox.unselectIndex(index, render);
            this.renderSelection('mouse');
            if (this.multiSelect) {
                if (index >= 0) {
                    var multiItem = this.getItem(index);

                    var indx = this.selectedItems.indexOf(multiItem.value);
                    if (indx >= 0) {
                        if (multiItem.value === this.listBox.selectedValue) {
                            this.listBox.selectedValue = null;
                        }

                        this.selectedItems.splice(indx, 1);
                        this._selectedItems.splice(indx, 1);
                    }
                }
                this.doMultiSelect(false);
            }
        },

        // selects an item at specific index.
        // @param Number
        selectIndex: function (index, ensureVisible, render, forceSelect) {
            this.listBox.selectIndex(index, ensureVisible, render, forceSelect);
            this.renderSelection('mouse');
            this.selectedIndex = index;
            if (this.multiSelect) {
                this.doMultiSelect();
            }
        },

        selectItem: function (item) {
            if (this.listBox != undefined) {
                this.listBox.selectItem(item);
                this.selectedIndex = this.listBox.selectedIndex;
                this.renderSelection('mouse');
                if (this.multiSelect) {
                    this.doMultiSelect(false);
                }
            }
        },

        unselectItem: function (item) {
            if (this.listBox != undefined) {
                this.listBox.unselectItem(item);
                this.renderSelection('mouse');
                if (this.multiSelect) {
                    var multiItem = this.getItemByValue(item);
                    if (multiItem) {
                        var index = this.selectedItems.indexOf(multiItem.value);
                        if (index >= 0) {
                            if (multiItem.value === this.listBox.selectedValue) {
                                this.listBox.selectedValue = null;
                            }

                            this.selectedItems.splice(index, 1);
                            this._selectedItems.splice(index, 1);                           
                        }
                    }

                    this.doMultiSelect(false);
                }
            }
        },

        checkItem: function (item) {
            if (this.listBox != undefined) {
                this.listBox.checkItem(item);
            }
        },

        uncheckItem: function (item) {
            if (this.listBox != undefined) {
                this.listBox.uncheckItem(item);
            }
        },

        indeterminateItem: function (item) {
            if (this.listBox != undefined) {
                this.listBox.indeterminateItem(item);
            }
        },

        getSelectedValue: function () {
            return this.listBox.selectedValue;
        },

        // gets the selected index.
        getSelectedIndex: function () {
            return this.listBox.selectedIndex;
        },

        // gets the selected item.
        getSelectedItem: function () {
            return this.getVisibleItem(this.listBox.selectedIndex);
        },

        // gets the selected items when multiselect is enabled.
        getSelectedItems: function () {
            var array = new Array();
            var that = this;
            $.each(this.selectedItems, function () {
                var item = that.getItemByValue(this);
                if (item) {
                    array.push(item);
                }
                else {
                    var item = that._selectedItems[this];
                    if (item) {
                        array.push(item);
                    }
                }
            });
            return array;
        },

        getCheckedItems: function () {
            return this.listBox.getCheckedItems();
        },

        checkIndex: function (index) {
            this.listBox.checkIndex(index);
        },

        uncheckIndex: function (index) {
            this.listBox.uncheckIndex(index);
        },

        indeterminateIndex: function (index) {
            this.listBox.indeterminateIndex(index);
        },
        checkAll: function () {
            this.listBox.checkAll();
        },

        uncheckAll: function () {
            this.listBox.uncheckAll();
        },

        insertAt: function (item, index) {
            if (item == null)
                return false;

            return this.listBox.insertAt(item, index);
        },

        addItem: function (item) {
            return this.listBox.addItem(item);
        },

        removeAt: function (index) {
            var result = this.listBox.removeAt(index);
            this.renderSelection('mouse');
            return result;
        },

        removeItem: function (item) {
            var result = this.listBox.removeItem(item);
            this.renderSelection('mouse');
            return result;
        },

        updateItem: function (item, oldItem) {
            var result = this.listBox.updateItem(item, oldItem);
            this.renderSelection('mouse');
            return result;
        },

        updateAt: function (item, index) {
            var result = this.listBox.updateAt(item, index);
            this.renderSelection('mouse');
            return result;
        },

        ensureVisible: function (index) {
            return this.listBox.ensureVisible(index);
        },

        disableAt: function (index) {
            return this.listBox.disableAt(index);
        },

        enableAt: function (index) {
            return this.listBox.enableAt(index);
        },

        disableItem: function (item) {
            return this.listBox.disableItem(item);
        },

        enableItem: function (item) {
            return this.listBox.enableItem(item);
        },

        _findPos: function (obj) {
            while (obj && (obj.type == 'hidden' || obj.nodeType != 1 || $.expr.filters.hidden(obj))) {
                obj = obj['nextSibling'];
            }
            if (obj) {
                var position = $(obj).coord(true);
                return [position.left, position.top];
            }
        },

        testOffset: function (element, offset, inputHeight) {
            var dpWidth = element.outerWidth();
            var dpHeight = element.outerHeight();
            var viewWidth = $(window).width() + $(window).scrollLeft();
            var viewHeight = $(window).height() + $(window).scrollTop();

            if (offset.left + dpWidth > viewWidth) {
                if (dpWidth > this.host.width()) {
                    var hostLeft = this.host.coord().left;
                    var hOffset = dpWidth - this.host.width();
                    offset.left = hostLeft - hOffset + 2;
                }
            }
            if (offset.left < 0) {
                offset.left = parseInt(this.host.coord().left) + 'px'
            }

            offset.top -= Math.min(offset.top, (offset.top + dpHeight > viewHeight && viewHeight > dpHeight) ?
                Math.abs(dpHeight + inputHeight + 23) : 0);

            return offset;
        },

        open: function () {
            if (!this.isOpened() && !this.opening) {
                this.showListBox('api');
            }
        },

        close: function () {
            if (this.isOpened()) {
                this.hideListBox('api');
            }
        },

        _getBodyOffset: function () {
            var top = 0;
            var left = 0;
            if ($('body').css('border-top-width') != '0px') {
                top = parseInt($('body').css('border-top-width'));
                if (isNaN(top)) top = 0;
            }
            if ($('body').css('border-left-width') != '0px') {
                left = parseInt($('body').css('border-left-width'));
                if (isNaN(left)) left = 0;
            }
            return { left: left, top: top };
        },

        // shows the listbox.
        showListBox: function (mode) {
            if (this.listBox.items && this.listBox.items.length == 0)
                return;

            if (this.autoComplete || this.multiSelect && !this.remoteAutoComplete) {
                if (mode != 'search') {
                    this._updateItemsVisibility("");
                }
            }
            if (this.remoteAutoComplete) {
                this.listBox.clearSelection();
            }

            if (mode != 'search') {
                this._oldvalue = this.listBox.selectedValue;
            }

            $.jqx.aria(this, "aria-expanded", true);

            if (this.dropDownWidth == 'auto' && this.width != null && this.width.indexOf && this.width.indexOf('%') != -1) {
                if (this.listBox.host.width() != this.host.width()) {
                    var width = this.host.width();
                    this.listBoxContainer.jqxListBox({ width: width });
                    this.container.width(parseInt(width) + 25);
                }
            }

            var self = this;
            var listBox = this.listBoxContainer;
            var listBoxInstance = this.listBox;
            var scrollPosition = $(window).scrollTop();
            var scrollLeftPosition = $(window).scrollLeft();
            var top = parseInt(this._findPos(this.host[0])[1]) + parseInt(this.host.outerHeight()) - 1 + 'px';
            var left, leftPos = parseInt(Math.round(this.host.coord(true).left));
            left = leftPos + 'px';

            var isMobileBrowser = $.jqx.mobile.isSafariMobileBrowser() || $.jqx.mobile.isWindowsPhone();
            this.ishiding = false;

            var hasTransform = $.jqx.utilities.hasTransform(this.host);

            if (hasTransform || (isMobileBrowser != null && isMobileBrowser)) {
                left = $.jqx.mobile.getLeftPos(this.element);
                top = $.jqx.mobile.getTopPos(this.element) + parseInt(this.host.outerHeight());
                if ($('body').css('border-top-width') != '0px') {
                    top = parseInt(top) - this._getBodyOffset().top + 'px';
                }
                if ($('body').css('border-left-width') != '0px') {
                    left = parseInt(left) - this._getBodyOffset().left + 'px';
                }
            }

            this.host.addClass(this.toThemeProperty('jqx-combobox-state-selected'));
            this.dropdownlistArrowIcon.addClass(this.toThemeProperty('jqx-icon-arrow-down-selected'));
            this.dropdownlistArrow.addClass(this.toThemeProperty('jqx-combobox-arrow-selected'));
            this.dropdownlistArrow.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
            this.host.addClass(this.toThemeProperty('jqx-combobox-state-focus'));
            this.host.addClass(this.toThemeProperty('jqx-fill-state-focus'));
            this.dropdownlistContent.addClass(this.toThemeProperty('jqx-combobox-content-focus'));

            this.container.css('left', left);
            this.container.css('top', top);
            listBoxInstance._arrange();

            var closeAfterSelection = true;

            var positionChanged = false;

            if (this.dropDownHorizontalAlignment == 'right' || this.rtl) {
                var containerWidth = this.container.outerWidth();
                var containerLeftOffset = Math.abs(containerWidth - this.host.width());

                if (containerWidth > this.host.width()) {
                    this.container.css('left', 25 + parseInt(Math.round(leftPos)) - containerLeftOffset + "px");
                }
                else this.container.css('left', 25 + parseInt(Math.round(leftPos)) + containerLeftOffset + "px");
            }

            if (this.enableBrowserBoundsDetection) {
                var newOffset = this.testOffset(listBox, { left: parseInt(this.container.css('left')), top: parseInt(top) }, parseInt(this.host.outerHeight()));
                if (parseInt(this.container.css('top')) != newOffset.top) {
                    positionChanged = true;
                    listBox.css('top', 23);
                }
                else listBox.css('top', 0);

                this.container.css('top', newOffset.top);
                this.container.css('top', newOffset.top);
                if (parseInt(this.container.css('left')) != newOffset.left) {
                    this.container.css('left', newOffset.left);
                }
            }

            if (this.animationType == 'none') {
                this.container.css('display', 'block');
                $.data(document.body, "openedComboJQXListBoxParent", self);
                $.data(document.body, "openedComboJQXListBox" + self.element.id, listBox);
                listBox.css('margin-top', 0);
                listBox.css('opacity', 1);
            }
            else {
                this.container.css('display', 'block');
                var height = listBox.outerHeight();
                listBox.stop();
                if (this.animationType == 'fade') {
                    listBox.css('margin-top', 0);
                    listBox.css('opacity', 0);
                    listBox.animate({ 'opacity': 1 }, this.openDelay, function () {
                        self.isanimating = false;
                        self.opening = false;
                        $.data(document.body, "openedComboJQXListBoxParent", self);
                        $.data(document.body, "openedComboJQXListBox" + self.element.id, listBox);
                    });
                }
                else {
                    listBox.css('opacity', 1);
                    if (positionChanged) {
                        listBox.css('margin-top', height);
                    }
                    else {
                        listBox.css('margin-top', -height);
                    }
                    this.isanimating = true;
                    this.opening = true;
                    listBox.animate({ 'margin-top': 0 }, this.openDelay, function () {
                        self.isanimating = false;
                        self.opening = false;
                        $.data(document.body, "openedComboJQXListBoxParent", self);
                        $.data(document.body, "openedComboJQXListBox" + self.element.id, listBox);
                    });
                }
            }
            listBoxInstance._renderItems();
            if (!positionChanged) {
                this.host.addClass(this.toThemeProperty('jqx-rc-b-expanded'));
                listBox.addClass(this.toThemeProperty('jqx-rc-t-expanded'));
                this.dropdownlistArrow.addClass(this.toThemeProperty('jqx-rc-b-expanded'));
            }
            else {
                this.host.addClass(this.toThemeProperty('jqx-rc-t-expanded'));
                listBox.addClass(this.toThemeProperty('jqx-rc-b-expanded'));
                this.dropdownlistArrow.addClass(this.toThemeProperty('jqx-rc-t-expanded'));
            }
            listBox.addClass(this.toThemeProperty('jqx-fill-state-focus'));

            this._raiseEvent('0', listBoxInstance);
        },

        doMultiSelect: function(setFocus)
        {
            if (this.checkboxes) {
                this.multiSelect = false;
            }

            var that = this;
            if (!this.multiSelect) {
                var buttons = that.dropdownlistContent.find('.jqx-button');
                var eventName = 'mousedown';
                if (this.touch) {
                    eventName = $.jqx.mobile.getTouchEventName('touchstart');
                }
                this.removeHandler(buttons, eventName);
                this.removeHandler(buttons.find('.jqx-icon-close'), eventName);
                buttons.remove();
                this.selectedItems = new Array();
                this._selectedItems = new Array();
                return;
            }

            if (this.validateSelection) {
                var result = this.validateSelection(this.listBox.selectedValue);
                if (!result) {
                    return;
                }
            }

            var oldItems = this.selectedItems;
            if (this.listBox.selectedValue) {
                if (this.selectedItems.indexOf(this.listBox.selectedValue) === -1) {
                    this.selectedItems.push(this.listBox.selectedValue);
                    var item = this.getItemByValue(this.listBox.selectedValue);
                    if (item) {
                        this._selectedItems.push(item);
                        this._raiseEvent('2', { index: item.index, item: item });
                        this._raiseEvent('4', { index: item.index, item: item });
                    }
                }
                this.listBox.selectedIndex = 0;
            }
            
            var items = this.listBox.items;
            for (var i = 0; i < items.length; i++) {
                items[i].disabled = false;
                if (this.selectedItems.indexOf(items[i].value) >= 0) {
                    items[i].disabled = true;
                }
            }
            this.listBox._renderItems();

            this.searchString = "";
            this.input.val("");
            var items = "";
            var eventName = 'mousedown';

            var buttons = that.dropdownlistContent.find('.jqx-button');
            if (this.touch) {
                eventName = $.jqx.mobile.getTouchEventName('touchstart');
            }
            this.removeHandler(buttons, eventName);
            this.removeHandler(buttons.find('.jqx-icon-close'), eventName);
            buttons.remove();
       
            that.input.detach();
            that.input.css('width', '25px');
            $.each(this.selectedItems, function (index) {
                var item = that.getItemByValue(this);
                if (!item || that.remoteAutoComplete) {
                    item = that._selectedItems[index];
                }

                var group = $('<div style="overflow: hidden; float: left;"></div>');
                group.addClass(that.toThemeProperty('jqx-button'));
                group.addClass(that.toThemeProperty('jqx-combobox-multi-item'));
                group.addClass(that.toThemeProperty('jqx-fill-state-normal'));
                group.addClass(that.toThemeProperty('jqx-rc-all'));
                if (item) {
                    var text = item.label;
                   if (group[0].innerHTML == '') {
                        group[0].innerHTML = '<a data-value="' + item.value + '" style="float: left;" href="#">' + text + '</a>';
                    }
                    if (that.rtl) {
                        group[0].innerHTML = '<a data-value="' + item.value + '" style="float: right;" href="#">' + text + '</a>';
                    }
                    var fl = !that.rtl ? 'right' : 'left';

                    var closebutton = '<div style="position: relative; overflow: hidden; float: ' + fl + '; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 100%; top: 50%; margin-left: -18px; margin-top: -7px; float: none; width: 16px; height: 16px;" class="' + that.toThemeProperty('jqx-icon-close') + '"></div></div>';
                    if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                        closebutton = '<div style="position: relative; overflow: hidden; float: left; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 100%; top: 50%; margin-left: -18px; margin-top: -7px; float: none; width: 16px; height: 16px;" class="' + that.toThemeProperty('jqx-icon-close') + '"></div></div>';
                    }
                    if (that.rtl) {
                        var closebutton = '<div style="position: relative; overflow: hidden; float: ' + fl + '; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 0px; top: 50%; margin-top: -7px; float: none; width: 16px; height: 16px;" class="' + that.toThemeProperty('jqx-icon-close') + '"></div></div>';
                        if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                            closebutton = '<div style="position: relative; overflow: hidden; float: left; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 0px; top: 50%; margin-top: -7px; float: none; width: 16px; height: 16px;" class="' + that.toThemeProperty('jqx-icon-close') + '"></div></div>';
                        }
                    }

                    group[0].innerHTML += closebutton;
                }
                else {
                    if (group[0].innerHTML == '') {
                        group[0].innerHTML = '<a href="#"></a>';
                    }
                }
                that.dropdownlistContent.append(group);
            });
            that.dropdownlistContent.append(that.input);
            that.input.val("");
            if (setFocus !== false) {
                that.input.focus();
                setTimeout(function () {
                    that.input.focus();
                }, 10);
            }
            var buttons = that.dropdownlistContent.find('.jqx-button');
            
            if (this.touchMode === true) eventName = "mousedown";
            this.addHandler(buttons, eventName, function (event) {
                if (event.target.className.indexOf('jqx-icon-close') >= 0)
                    return true;

                var text = $(event.target).attr('data-value');
                var item = that.getItemByValue(text);
                if (item) {
                    that.listBox.selectedValue = null;
                    that.listBox.clearSelection();
                }
                that.listBox.scrollTo(0, 0);
                that.open();
                if (event.preventDefault) {
                    event.preventDefault();
                }
                if (event.stopPropagation) {
                    event.stopPropagation();
                }
                return false;
            });
            this.addHandler(buttons.find('.jqx-icon-close'), eventName, function (event) {
                var text = $(event.target).parent().parent().find('a').attr('data-value');
                var item = that.getItemByValue(text);
                if (item) {
                    that.listBox.selectedValue = null;
                    var index = that.selectedItems.indexOf(text);
                    if (index >= 0) {                  
                        that.selectedItems.splice(index, 1);
                        that._selectedItems.splice(index, 1);
                        that._raiseEvent('3', { index: item.index, type: 'mouse', item: item });
                        that._raiseEvent('4', { index: item.index, type: 'mouse', item: item });
                        that.doMultiSelect();
                    }
                }
            });
            that.dropdownlistArrow.height(this.host.height());
            that._updateInputSelection();
        },

        // hides the listbox.
        hideListBox: function (mode) {
            var listBox = this.listBoxContainer;
            var listBoxInstance = this.listBox;
            var container = this.container;
            if (this.container.css('display') == 'none')
                return;
      
            $.jqx.aria(this, "aria-expanded", false);

            if (mode == "keyboard" || mode == "mouse") {
                this.listBox.searchString = "";
            }

            if (mode == "keyboard" || mode == "mouse" && this.multiSelect) {
                this.doMultiSelect();
            }

            var me = this;
            $.data(document.body, "openedComboJQXListBox" + this.element.id, null);
            if (this.animationType == 'none') {
                this.opening = false;
                this.container.css('display', 'none');
            }
            else {
                if (!this.ishiding) {
                    var height = listBox.outerHeight();
                    listBox.css('margin-top', 0);
                    listBox.stop();
                    this.opening = false;
                    this.isanimating = true;
                    var animationValue = -height;
                    if (parseInt(this.container.coord().top) < parseInt(this.host.coord().top)) {
                        animationValue = height;
                    }
                    if (this.animationType == 'fade') {
                        listBox.css({ 'opacity': 1 });
                        listBox.animate({ 'opacity': 0 }, this.closeDelay, function () {
                            me.isanimating = false;
                            container.css('display', 'none');
                            me.ishiding = false;
                        });
                    }
                    else {
                        listBox.animate({ 'margin-top': animationValue }, this.closeDelay, function () {
                            me.isanimating = false;
                            container.css('display', 'none'); me.ishiding = false;
                        });
                    }
                }
            }

            this.ishiding = true;
            this.host.removeClass(this.toThemeProperty('jqx-combobox-state-selected'));
            this.dropdownlistArrowIcon.removeClass(this.toThemeProperty('jqx-icon-arrow-down-selected'));
            this.dropdownlistArrow.removeClass(this.toThemeProperty('jqx-combobox-arrow-selected'));
            this.dropdownlistArrow.removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
            if (!this.focused) {
                this.host.removeClass(this.toThemeProperty('jqx-combobox-state-focus'));
                this.host.removeClass(this.toThemeProperty('jqx-fill-state-focus'));
                this.dropdownlistContent.removeClass(this.toThemeProperty('jqx-combobox-content-focus'));
            }
            this.host.removeClass(this.toThemeProperty('jqx-rc-b-expanded'));
            listBox.removeClass(this.toThemeProperty('jqx-rc-t-expanded'));
            this.host.removeClass(this.toThemeProperty('jqx-rc-t-expanded'));
            listBox.removeClass(this.toThemeProperty('jqx-rc-b-expanded'));
            listBox.removeClass(this.toThemeProperty('jqx-fill-state-focus'));
            this.dropdownlistArrow.removeClass(this.toThemeProperty('jqx-rc-t-expanded'));
            this.dropdownlistArrow.removeClass(this.toThemeProperty('jqx-rc-b-expanded'));

            this._raiseEvent('1', listBoxInstance);
        },

        /* Close popup if clicked elsewhere. */
        closeOpenedListBox: function (event) {
            var self = event.data.me;
            var $target = $(event.target);
            var openedListBox = event.data.listbox;
            if (openedListBox == null)
                return true;

            if ($(event.target).ischildof(event.data.me.host)) {
                return;
            }

            var dropdownlistInstance = self;

            var isListBox = false;
            $.each($target.parents(), function () {
                if (this.className != 'undefined') {
                    if (this.className.indexOf) {
                        if (this.className.indexOf('jqx-listbox') != -1) {
                            isListBox = true;
                            return false;
                        }
                        if (this.className.indexOf('jqx-combobox') != -1) {
                            if (self.element.id == this.id) {
                                isListBox = true;
                            }
                            return false;
                        }
                    }
                }
            });

            if (openedListBox != null && !isListBox) {
                if (self.isOpened()) {
                    self.hideListBox('api');
                    self.input.blur();
                }
            }

            return true;
        },

        loadFromSelect: function (id) {
            this.listBox.loadFromSelect(id);
        },

        refresh: function (initialRefresh) {
            this._setSize();
            this._arrange();
            if (this.listBox) {
                this.renderSelection();
            }
        },

        _arrange: function () {
            var width = parseInt(this.host.width());
            var height = parseInt(this.host.height());

            var arrowHeight = this.arrowSize;
            var arrowWidth = this.arrowSize;
      
            var rightOffset = 1;
            if (!this.showArrow) {
                arrowWidth = 0;
                arrowHeight = 0;
                this.dropdownlistArrow.hide();
                rightOffset = 0;
                this.host.css('cursor', 'arrow');
            }

            var contentWidth = width - arrowWidth - 1 * rightOffset;
            if (contentWidth > 0) {
                this.dropdownlistContent.width(contentWidth + 'px');
            }
            if (this.rtl) {
                this.dropdownlistContent.width(-1+contentWidth + 'px');
            }

            this.dropdownlistContent.height(height);
            this.dropdownlistContent.css('left', 0);
            this.dropdownlistContent.css('top', 0);

            this.dropdownlistArrow.width(arrowWidth+1);
            this.dropdownlistArrow.height(height);
            this.dropdownlistArrow.css('left', 1 + contentWidth + 'px');
            this.input.css('width', '100%');
            var inputHeight = this.input.height();
            if (inputHeight == 0) {
                inputHeight = parseInt(this.input.css('font-size')) + 3;
            }

            this.input.addClass(this.toThemeProperty('jqx-rc-all'));
            var top = parseInt(height) / 2 - parseInt(inputHeight) / 2;
            if (top > 0) {
                this.input.css('margin-top', top);
            }

            if (this.rtl) {
                this.dropdownlistArrow.css('left', '0px');
                this.dropdownlistContent.css('left', this.dropdownlistArrow.width());
                if ($.jqx.browser.msie && $.jqx.browser.version <= 8) {
                    this.dropdownlistContent.css('left', 1 + this.dropdownlistArrow.width());
                }
            }
            if (this.multiSelect) {
                this.input.css('float', 'left');
                this.input.width(25);
                this.dropdownlistWrapper.parent().css('height', 'auto');
                this.dropdownlistContent.css('height', 'auto');
                this.dropdownlistWrapper.css('height', 'auto');
                this.dropdownlistContent.css('position', 'relative');
                this.dropdownlistContent.css('cursor', 'text');
                this.host.css('height', 'auto');
                this.host.css('min-height', this.height);
                this.dropdownlistContent.css('min-height', this.height);
                var height = parseInt(this.host.height());
                this.dropdownlistArrow.height(height);
                var initialHeight = parseInt(this.host.css('min-height'));
                var top = parseInt(initialHeight) / 2 - parseInt(inputHeight) / 2;
                if (top > 0) {
                    this.input.css('margin-top', top);
                }
            }
        },

        destroy: function () {
            if (this.source && this.source.unbindBindingUpdate) {
                this.source.unbindBindingUpdate(this.element.id);
                this.source.unbindBindingUpdate(this.listBoxContainer[0].id);
                this.source.unbindDownloadComplete(this.element.id);
                this.source.unbindDownloadComplete(this.listBoxContainer[0].id);
            }
            $.jqx.utilities.resize(this.host, null, true); 
            this.removeHandler(this.listBoxContainer, 'select');
            this.removeHandler(this.listBoxContainer, 'unselect');
            this.removeHandler(this.listBoxContainer, 'change');
            this.removeHandler(this.listBoxContainer, 'bindingComplete');
            this.removeHandler(this.dropdownlistWrapper, 'selectstart');
            this.removeHandler(this.dropdownlistWrapper, 'mousedown');
            this.removeHandler(this.host, 'keydown');
            this.removeHandler(this.listBoxContainer, 'select');
            this.removeHandler(this.listBox.content, 'click');
            this.removeHandlers();
            this.removeHandler(this.input, 'keyup.textchange');

            this.listBoxContainer.jqxListBox('destroy');
            this.listBoxContainer.remove();
            this.host.removeClass();
            this.removeHandler($(document), 'mousedown.' + this.id, this.closeOpenedListBox);
            if (this.touch) {
                this.removeHandler($(document), $.jqx.mobile.getTouchEventName('touchstart') + '.' + this.id);
            }
            this.cinput.remove();
            delete this.cinput;
            this.dropdownlistArrow.remove();
            delete this.dropdownlistArrow;
            this.dropdownlistArrowIcon.remove();
            delete this.dropdownlistArrowIcon;
            delete this.dropdownlistWrapper;
            delete this.listBoxContainer;
            delete this.input;
            delete this.dropdownlistContent;
            delete this.comboStructure;
            this.container.remove();
            delete this.listBox;
            delete this.container;
            var vars = $.data(this.element, "jqxComboBox");
            if (vars) {
                delete vars.instance;
            }
            this.host.removeData();
            this.host.remove();
            delete this.host;
            delete this.set;
            delete this.get;
            delete this.call;
            delete this.element;
        },

        //[optimize]
        _raiseEvent: function (id, arg) {
            if (arg == undefined)
                arg = { owner: null };

            var evt = this.events[id];
            args = arg;
            args.owner = this;

            var event = new jQuery.Event(evt);
            event.owner = this;
            if (id == 2 || id == 3 || id == 4 || id == 5) {
                event.args = arg;
            }

            var result = this.host.trigger(event);
            return result;
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (object.isInitialized == undefined || object.isInitialized == false)
                return;

            if (key === "touchMode") {
                object.listBoxContainer.jqxListBox({ touchMode: value });
                object.touch = $.jqx.mobile.isTouchDevice();
                if (object.touchMode === true) {
                    object.touch = true;
                }
                object._updateHandlers();
            }

            if (key == "multiSelect")
            {
                if (value) {
                    object.doMultiSelect(false);
                }
                else {
                    object.doMultiSelect(false);
                    object.dropdownlistWrapper.parent().css('height', '100%');
                    object.dropdownlistContent.css('height', '100');
                    object.dropdownlistWrapper.css('height', '100');
                    object.dropdownlistContent.css('position', 'relative');
                    object.host.css('min-height', null);
                    object._setSize();
                    object._arrange();
                }
            }

            if (key == "showArrow") {
                object._arrange();
                if (object.multiSelect) {
                    object.doMultiSelect(false);
                }
            }

            if (key == 'popupZIndex') {
                object.listBoxContainer.css({ zIndex: object.popupZIndex });
            }

            if (key == 'promptText') {
                object.placeHolder = value;
            }

            if (key == 'autoOpen') {
                object._updateHandlers();
            }

            if (key == 'renderer') {
                object.listBox.renderer = object.renderer;
            }
            if (key == 'itemHeight') {
                object.listBox.itemHeight = value;
            }

            if (key == 'source') {
                object.input.val("");
                object.listBoxContainer.jqxListBox({ source: object.source });
                object.renderSelection('mouse');
                if (object.source == null) {
                    object.clearSelection();
                }
                if (object.multiSelect) {
                    object.selectedItems = new Array();
                    object._selectedItems = new Array();
                    object.doMultiSelect(false);
                }
            }
            if (key == "rtl") {
                if (value) {
                    object.dropdownlistArrow.css('float', 'left');
                    object.dropdownlistContent.css('float', 'right');
                }
                else {
                    object.dropdownlistArrow.css('float', 'right');
                    object.dropdownlistContent.css('float', 'left');
                }
                object.listBoxContainer.jqxListBox({ rtl: object.rtl });
            }
            if (key == "displayMember" || key == "valueMember") {
                object.listBoxContainer.jqxListBox({ displayMember: object.displayMember, valueMember: object.valueMember });
                object.renderSelection('mouse');
            }

            if (key == "autoDropDownHeight") {
                object.listBoxContainer.jqxListBox({ autoHeight: object.autoDropDownHeight });
                if (object.autoDropDownHeight) {
                    object.container.height(object.listBoxContainer.height() + 25);
                }
                else {
                    object.listBoxContainer.jqxListBox({ height: object.dropDownHeight });
                    object.container.height(parseInt(object.dropDownHeight) + 25);
                }

                object.listBox._arrange();
                object.listBox._updatescrollbars();
            }

            if (key == "dropDownHeight") {
                if (!object.autoDropDownHeight) {
                    object.listBoxContainer.jqxListBox({ height: object.dropDownHeight });
                    object.container.height(parseInt(object.dropDownHeight) + 25);
                }
            }

            if (key == "dropDownWidth" || key == "scrollBarSize") {
                var width = object.width;
                if (object.dropDownWidth != 'auto') {
                    width = object.dropDownWidth;
                }

                object.listBoxContainer.jqxListBox({ width: width, scrollBarSize: object.scrollBarSize });
                object.container.width(parseInt(width) + 25);
            }

            if (key == 'autoComplete') {
                object._resetautocomplete();
            }

            if (key == "checkboxes") {
                object.listBoxContainer.jqxListBox({ checkboxes: object.checkboxes });
                if (object.checkboxes) {
                    object.input.attr('readonly', true);
                    $.jqx.aria(object, "aria-readonly", true);
                }
                else {
                    $.jqx.aria(object, "aria-readonly", false);
                }
            }

            if (key == 'theme' && value != null) {
                object.listBoxContainer.jqxListBox({ theme: value });
                object.listBoxContainer.addClass(object.toThemeProperty('jqx-popup'));
                if ($.jqx.browser.msie) {
                    object.listBoxContainer.addClass(object.toThemeProperty('jqx-noshadow'));
                }
                object.dropdownlistContent.removeClass();
                object.dropdownlistContent.addClass(object.toThemeProperty('jqx-combobox-content'));
                object.dropdownlistContent.addClass(object.toThemeProperty('jqx-widget-content'));
                object.input.removeClass();
                object.input.addClass(object.toThemeProperty('jqx-combobox-input'));
                object.input.addClass(this.toThemeProperty('jqx-widget-content'));
                object.host.removeClass();
                object.host.addClass(object.toThemeProperty('jqx-combobox-state-normal'));
                object.host.addClass(object.toThemeProperty('jqx-rc-all'));
                object.host.addClass(object.toThemeProperty('jqx-widget'));
                object.host.addClass(object.toThemeProperty('jqx-widget-content'));
                object.dropdownlistArrow.removeClass();
                object.dropdownlistArrowIcon.addClass(object.toThemeProperty('jqx-icon-arrow-down'));
                object.dropdownlistArrow.addClass(object.toThemeProperty('jqx-combobox-arrow-normal'));
                object.dropdownlistArrow.addClass(object.toThemeProperty('jqx-fill-state-normal'));
            }

            if (key == 'width' || key == 'height') {
                object._setSize();
                if (key == 'width') {
                    if (object.dropDownWidth == 'auto') {
                        var width = object.host.width();
                        object.listBoxContainer.jqxListBox({ width: width });
                        object.container.width(parseInt(width) + 25);
                    }
                }
                object._arrange();
            }

            if (key == 'selectedIndex') {
                object.listBox.selectIndex(value);
                object.renderSelection('mouse');
            }
        }
    });
})(jQuery);
(function ($) {

    $.jqx.jqxWidget("jqxDropDownList", "", {});

    $.extend($.jqx._jqxDropDownList.prototype, {
        defineInstance: function () {
            // enables/disables the dropdownlist.
            this.disabled = false;
            // gets or sets the listbox width.
            this.width = null;
            // gets or sets the listbox height.
            this.height = null;
            // Represents the collection of list items.
            this.items = new Array();
            // Gets or sets the selected index.
            this.selectedIndex = -1;
            // data source.
            this.source = null;
            // gets or sets the scrollbars size.
            this.scrollBarSize = 15;
            // gets or sets the scrollbars size.
            this.arrowSize = 19;
            // enables/disables the hover state.
            this.enableHover = true;
            // enables/disables the selection.
            this.enableSelection = true;
            // gets the visible items. // this property is internal for the dropdownlist.
            this.visualItems = new Array();
            // gets the groups. // this property is internal for the dropdownlist.
            this.groups = new Array();
            // gets or sets whether the items width should be equal to the dropdownlist's width.
            this.equalItemsWidth = true;
            // gets or sets the height of the ListBox Items. When the itemHeight == - 1, each item's height is equal to its desired height.
            this.itemHeight = -1;
            // represents the dropdownlist's events.
            this.visibleItems = new Array();
            // emptry group's text.
            this.emptyGroupText = 'Group';
            this.checkboxes = false;
            // Type: Number
            // Default: 100
            // Showing Popup Animation's delay.
            if (this.openDelay == undefined) {
                this.openDelay = 250;
            }
            // Type: Number
            // Default: 200
            // Hiding Popup Animation's delay.
            if (this.closeDelay == undefined) {
                this.closeDelay = 300;
            }
            // default, none
            // Type: String.
            // enables or disables the animation.
            this.animationType = 'default';
            this.autoOpen = false;
            // Type: String
            // Default: auto ( the drop down takes the dropdownlist's width.)
            // Sets the popup's width.
            this.dropDownWidth = 'auto';
            // Type: String
            // Default: 200px ( the height is 200px )
            // Sets the popup's height.
            this.dropDownHeight = '200px';
            // Type: Boolean
            // Default: false
            // Sets the popup's height to be equal to the items summary height;            
            this.autoDropDownHeight = false;
            this.keyboardSelection = true;

            // Type: Boolean
            // Default: false
            // Enables or disables the browser detection.
            this.enableBrowserBoundsDetection = false;
            this.dropDownHorizontalAlignment = 'left';
            this.displayMember = "";
            this.valueMember = "";
            this.searchMode = 'startswithignorecase';
            this.incrementalSearch = true;
            this.incrementalSearchDelay = 700;
            this.renderer = null;
            this.placeHolder = "Please Choose:";
            this.promptText = "Please Choose:";
            this.emptyString = "";
            this.rtl = false;
            this.selectionRenderer = null;
            this.listBox = null;
            this.popupZIndex = 9999999999999;
            this.renderMode = "default";
            this.touchMode = "auto";
            this.aria =
            {
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
            this.events =
	   	    [
            // occurs when the dropdownlist is opened.
		      'open',
            // occurs when the dropdownlist is closed.
              'close',
            // occurs when an item is selected.
              'select',
            // occurs when an item is unselected.
              'unselect',
            // occurs when the selection is changed.
              'change',
            // triggered when the user checks or unchecks an item. 
              'checkChange',
            // triggered when the binding operation is completed.
              'bindingComplete'
           ];
        },

        createInstance: function (args) {
            this.render();
        },

        render: function () {
            if (!this.width) this.width = 200;
            if (!this.height) this.height = 25;
            this.element.innerHTML = "";
            this.isanimating = false;
            this.id = this.element.id || $.jqx.utilities.createId();
            this.host.attr('role', 'combobox');
            $.jqx.aria(this, "aria-autocomplete", "both");
            $.jqx.aria(this, "aria-readonly", false);

            var comboStructure = $("<div tabIndex=0 style='background-color: transparent; -webkit-appearance: none; outline: none; width:100%; height: 100%; padding: 0px; margin: 0px; border: 0px; position: relative;'>" +
                "<div id='dropdownlistWrapper' style='outline: none; background-color: transparent; border: none; float: left; width:100%; height: 100%; position: relative;'>" +
                "<div id='dropdownlistContent' style='outline: none; background-color: transparent; border: none; float: left; position: relative;'/>" +
                "<div id='dropdownlistArrow' style='background-color: transparent; border: none; float: right; position: relative;'><div></div></div>" +
                "</div>" +
                "</div>");
            this._addInput();

            if ($.jqx._jqxListBox == null || $.jqx._jqxListBox == undefined) {
                throw new Error("jqxDropDownList: Missing reference to jqxlistbox.js.");
            }
            var me = this;

            this.touch = $.jqx.mobile.isTouchDevice();
            this.comboStructure = comboStructure;
            this.host.append(comboStructure);

            this.dropdownlistWrapper = this.host.find('#dropdownlistWrapper');
            this.dropdownlistArrow = this.host.find('#dropdownlistArrow');
            this.arrow = $(this.dropdownlistArrow.children()[0]);
            this.dropdownlistContent = this.host.find('#dropdownlistContent');
            this.dropdownlistContent.addClass(this.toThemeProperty('jqx-dropdownlist-content'));
            this.dropdownlistWrapper.addClass(this.toThemeProperty('jqx-disableselect'));
            if (this.rtl) {
                this.dropdownlistContent.addClass(this.toThemeProperty('jqx-rtl'));
                this.dropdownlistContent.addClass(this.toThemeProperty('jqx-dropdownlist-content-rtl'));
            }
            this.addHandler(this.dropdownlistWrapper, 'selectstart', function () { return false; });
            this.dropdownlistWrapper[0].id = "dropdownlistWrapper" + this.element.id;
            this.dropdownlistArrow[0].id = "dropdownlistArrow" + this.element.id;
            this.dropdownlistContent[0].id = "dropdownlistContent" + this.element.id;
            if (this.promptText != "Please Choose:") this.placeHolder = this.promptText;
            var hostClassName = this.toThemeProperty('jqx-widget') + " " + this.toThemeProperty('jqx-dropdownlist-state-normal') + " " + this.toThemeProperty('jqx-rc-all') + " " + this.toThemeProperty('jqx-fill-state-normal');
            this.element.className += " " + hostClassName;
            this._firstDiv = this.host.find('div:first');

            try {
                var listBoxID = 'listBox' + this.id;
                var oldContainer = $($.find('#' + listBoxID));
                if (oldContainer.length > 0) {
                    oldContainer.remove();
                }
                $.jqx.aria(this, "aria-owns", listBoxID);
                $.jqx.aria(this, "aria-haspopup", true);

                var container = $("<div style='overflow: hidden; background-color: transparent; border: none; position: absolute;' id='listBox" + this.id + "'><div id='innerListBox" + this.id + "'></div></div>");
                container.hide();

                container.appendTo(document.body);
                this.container = container;
                this.listBoxContainer = $($.find('#innerListBox' + this.id));

                var width = this.width;
                if (this.dropDownWidth != 'auto') {
                    width = this.dropDownWidth;
                }
                if (width == null) {
                    width = this.host.width();
                    if (width == 0) width = this.dropDownWidth;
                }

                if (this.dropDownHeight == null) {
                    this.dropDownHeight = 200;
                }
                var me = this;
                this.container.width(parseInt(width) + 25);
                this.container.height(parseInt(this.dropDownHeight) + 25);
                this.addHandler(this.listBoxContainer, 'bindingComplete', function (event) {
                    me._raiseEvent('6');
                });

                this.listBoxContainer.jqxListBox({_checkForHiddenParent: false,
                    touchMode: this.touchMode, checkboxes: this.checkboxes, rtl: this.rtl, emptyString: this.emptyString, itemHeight: this.itemHeight, width: width, searchMode: this.searchMode, incrementalSearch: this.incrementalSearch, incrementalSearchDelay: this.incrementalSearchDelay, displayMember: this.displayMember, valueMember: this.valueMember, height: this.dropDownHeight, autoHeight: this.autoDropDownHeight, scrollBarSize: this.scrollBarSize, selectedIndex: this.selectedIndex, source: this.source, theme: this.theme,
                    rendered: function () {
                        if (me.selectedIndex != me.listBoxContainer.jqxListBox('selectedIndex')) {
                            me.listBox = $.data(me.listBoxContainer[0], "jqxListBox").instance;
                            me.listBoxContainer.jqxListBox({ selectedIndex: me.selectedIndex });
                            me.renderSelection('mouse');
                        } else {
                            me.renderSelection('mouse');
                        }
                    }, renderer: this.renderer
                });
                this.listBoxContainer.css({ position: 'absolute', zIndex: this.popupZIndex, top: 0, left: 0 });
                this.listBox = $.data(this.listBoxContainer[0], "jqxListBox").instance;
                this.listBox.enableSelection = this.enableSelection;
                this.listBox.enableHover = this.enableHover;
                this.listBox.equalItemsWidth = this.equalItemsWidth;
                this.listBox.selectIndex(this.selectedIndex);
                this.listBox._arrange();
                this.listBoxContainer.addClass(this.toThemeProperty('jqx-popup'));
                if ($.jqx.browser.msie) {
                    this.listBoxContainer.addClass(this.toThemeProperty('jqx-noshadow'));
                }

                this.addHandler(this.listBoxContainer, 'unselect', function (event) {
                    me._raiseEvent('3', { index: event.args.index, type: event.args.type, item: event.args.item });
                });

                this.addHandler(this.listBoxContainer, 'change', function (event) {
                    me._raiseEvent('4', { index: event.args.index, type: event.args.type, item: event.args.item });
                });

                if (this.animationType == 'none') {
                    this.container.css('display', 'none');
                }
                else {
                    this.container.hide();
                }
            }
            catch (e) {

            }

            var self = this;
            this.propertyChangeMap['disabled'] = function (instance, key, oldVal, value) {
                if (value) {
                    instance.host.addClass(self.toThemeProperty('jqx-dropdownlist-state-disabled'));
                    instance.host.addClass(self.toThemeProperty('jqx-fill-state-disabled'));
                    instance.dropdownlistContent.addClass(self.toThemeProperty('jqx-dropdownlist-content-disabled'));
                }
                else {
                    instance.host.removeClass(self.toThemeProperty('jqx-dropdownlist-state-disabled'));
                    instance.host.removeClass(self.toThemeProperty('jqx-fill-state-disabled'));
                    instance.dropdownlistContent.removeClass(self.toThemeProperty('jqx-dropdownlist-content-disabled'));
                }
                $.jqx.aria(instance, "aria-disabled", instance.disabled);
            }

            if (this.disabled) {
                this.host.addClass(this.toThemeProperty('jqx-dropdownlist-state-disabled'));
                this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
                this.dropdownlistContent.addClass(this.toThemeProperty('jqx-dropdownlist-content-disabled'));
            }

            this.arrow.addClass(this.toThemeProperty('jqx-icon-arrow-down'));
            this.arrow.addClass(this.toThemeProperty('jqx-icon'));

            if (this.renderMode === "simple") {
                this.arrow.remove();
                this.host.removeClass(this.toThemeProperty('jqx-fill-state-normal'));
                this.host.removeClass(this.toThemeProperty('jqx-rc-all'));
            }

            this._updateHandlers();
            this._setSize();
            this._arrange();
            if (this.listBox) {
                this.renderSelection();
            }

            // fix for IE7
            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                if (this.host.parents('.jqx-window').length > 0) {
                    var zIndex = this.host.parents('.jqx-window').css('z-index');
                    container.css('z-index', zIndex + 10);
                    this.listBoxContainer.css('z-index', zIndex + 10);
                }
            }
        },

        val: function (value) {
            if (!this.dropdownlistContent) return "";
            if (this.input && arguments.length == 0) {
                return this.input.val();
            }

            var item = this.getItemByValue(value);
            if (item != null) {
                this.selectItem(item);
            }

            if (this.input) {
                return this.input.val();
            }
        },

        focus: function () {
            try
            {
                var me = this;
                var doFocus = function () {
                    me.host.focus();
                    if (me._firstDiv) {
                        me._firstDiv.focus();
                    }
                }
                doFocus();
                setTimeout(function () {
                    doFocus();
                }, 10);
            }
            catch (error) {
            }
        },

        _addInput: function () {
            var name = this.host.attr('name');
            if (!name) name = this.element.id;
            this.input = $("<input type='hidden'/>");
            this.host.append(this.input);
            this.input.attr('name', name);
        },

        getItems: function () {
            if (!this.listBox) {
                return new Array();
            }

            return this.listBox.items;
        },

        getVisibleItems: function () {
            return this.listBox.getVisibleItems();
        },

        _setSize: function () {
            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                this.host.width(this.width);
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    this.host.width(this.width);
                };

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                this.host.height(this.height);
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                this.host.height(this.height);
            };

            var isPercentage = false;
            if (this.width != null && this.width.toString().indexOf("%") != -1) {
                isPercentage = true;
                this.host.width(this.width);
            }

            if (this.height != null && this.height.toString().indexOf("%") != -1) {
                isPercentage = true;
                this.host.height(this.height);
            }

            var me = this;
            var resizeFunc = function () {
                me._arrange();
                if (me.dropDownWidth == 'auto') {
                    var width = me.host.width();
                    me.listBoxContainer.jqxListBox({ width: width });
                    me.container.width(parseInt(width) + 25);
                }
            }

            if (isPercentage) {
                var width = this.host.width();
                if (this.dropDownWidth != 'auto') {
                    width = this.dropDownWidth;
                }
                this.listBoxContainer.jqxListBox({ width: width });
                this.container.width(parseInt(width) + 25);
            }
            $.jqx.utilities.resize(this.host, function () {
                resizeFunc();
            });
        },

        // returns true when the listbox is opened, otherwise returns false.
        isOpened: function () {
            var me = this;
            var openedListBox = $.data(document.body, "openedJQXListBox" + this.id);
            if (openedListBox != null && openedListBox == me.listBoxContainer) {
                return true;
            }

            return false;
        },

        _updateHandlers: function () {
            var self = this;
            var hovered = false;
            this.removeHandlers();
            if (!this.touch) {
                this.addHandler(this.host, 'mouseenter', function () {
                    if (!self.disabled && self.enableHover && self.renderMode !== 'simple') {
                        hovered = true;
                        self.host.addClass(self.toThemeProperty('jqx-dropdownlist-state-hover'));
                        self.arrow.addClass(self.toThemeProperty('jqx-icon-arrow-down-hover'));
                        self.host.addClass(self.toThemeProperty('jqx-fill-state-hover'));
                    }
                });

                this.addHandler(this.host, 'mouseleave', function () {
                    if (!self.disabled && self.enableHover && self.renderMode !== 'simple') {
                        self.host.removeClass(self.toThemeProperty('jqx-dropdownlist-state-hover'));
                        self.host.removeClass(self.toThemeProperty('jqx-fill-state-hover'));
                        self.arrow.removeClass(self.toThemeProperty('jqx-icon-arrow-down-hover'));
                        hovered = false;
                    }
                });
            }

            if (this.host.parents()) {
                this.addHandler(this.host.parents(), 'scroll.dropdownlist' + this.element.id, function (event) {
                    var opened = self.isOpened();
                    if (opened) {
                        self.close();
                    }
                });
            }

            var eventName = 'mousedown';
            if (this.touch) eventName = $.jqx.mobile.getTouchEventName('touchstart');
            this.addHandler(this.dropdownlistWrapper, eventName,
            function (event) {
                if (!self.disabled) {
                    var isOpen = self.container.css('display') == 'block';
                    if (!self.isanimating) {
                        if (isOpen) {
                            self.hideListBox();
                            return false;
                        }
                        else {
                            self.showListBox();
                        }
                    }
                }
            });

            if (self.autoOpen) {
                this.addHandler(this.host, 'mouseenter', function () {
                    var isOpened = self.isOpened();
                    if (!isOpened && self.autoOpen) {
                        self.open();
                        self.host.focus();
                    }
                });

                $(document).on('mousemove.' + self.id, function (event) {
                    var isOpened = self.isOpened();
                    if (isOpened && self.autoOpen) {
                        var offset = self.host.coord();
                        var top = offset.top;
                        var left = offset.left;
                        var popupOffset = self.container.coord();
                        var popupLeft = popupOffset.left;
                        var popupTop = popupOffset.top;

                        canClose = true;

                        if (event.pageY >= top && event.pageY <= top + self.host.height()) {
                            if (event.pageX >= left && event.pageX < left + self.host.width())
                                canClose = false;
                        }
                        if (event.pageY >= popupTop && event.pageY <= popupTop + self.container.height()) {
                            if (event.pageX >= popupLeft && event.pageX < popupLeft + self.container.width())
                                canClose = false;
                        }

                        if (canClose) {
                            self.close();
                        }
                    }
                });
            }

            if (this.touch) {
                this.addHandler($(document), $.jqx.mobile.getTouchEventName('touchstart') + '.' + this.id, self.closeOpenedListBox, { me: this, listbox: this.listBox, id: this.id });
            }
            else this.addHandler($(document), 'mousedown.' + this.id, self.closeOpenedListBox, { me: this, listbox: this.listBox, id: this.id });

            this.addHandler(this.host, 'keydown', function (event) {
                var isOpen = self.container.css('display') == 'block';

                if (self.host.css('display') == 'none') {
                    return true;
                }

                if (event.keyCode == '13' || event.keyCode == '9') {
                    if (!self.isanimating) {
                        if (isOpen) {
                            self.renderSelection();
                            if (event.keyCode == '13') {
                                self._firstDiv.focus();
                            }
                            self.hideListBox();
                            if (!self.keyboardSelection) {
                                self._raiseEvent('2', { index: self.selectedIndex, type: 'keyboard', item: self.getItem(self.selectedIndex) });
                            }
                        }
                        if (isOpen && event.keyCode != '9') {
                            return false;
                        }
                        return true;
                    }
                }

                if (event.keyCode == 115) {
                    if (!self.isanimating) {
                        if (!self.isOpened()) {
                            self.showListBox();
                        }
                        else if (self.isOpened()) {
                            self.hideListBox();
                        }
                    }
                    return false;
                }

                if (event.altKey) {
                    if (self.host.css('display') == 'block') {
                        if (event.keyCode == 38) {
                            if (self.isOpened()) {
                                self.hideListBox();
                                return true;
                            }
                        }
                        else if (event.keyCode == 40) {
                            if (!self.isOpened()) {
                                self.showListBox();
                                return true;
                            }
                        }
                    }
                }

                if (event.keyCode == '27') {
                    if (!self.ishiding) {
                        self.hideListBox();
                        if (self.tempSelectedIndex != undefined) {
                            self.selectIndex(self.tempSelectedIndex);
                        }
                        return false;
                    }
                }

                if (!self.disabled) {
                    return self.listBox._handleKeyDown(event);
                }
            });
            this.addHandler(this.listBoxContainer, 'checkChange', function (event) {
                self.renderSelection();
                self._updateInputSelection();
                self._raiseEvent(5, { label: event.args.label, value: event.args.value, checked: event.args.checked, item: event.args.item });
            });

            this.addHandler(this.listBoxContainer, 'select', function (event) {
                if (!self.disabled) {
                    if (event.args.type == 'keyboard' && !self.isOpened()) {
                        self.renderSelection();
                    }

                    if (event.args.type != 'keyboard' || self.keyboardSelection) {
                        self.renderSelection();
                        self._raiseEvent('2', { index: event.args.index, type: event.args.type, item: event.args.item, originalEvent: event.args.originalEvent });
                        if (event.args.type == 'mouse') {
                            if (!self.checkboxes) {
                                self.hideListBox();
                                if (self._firstDiv) {
                                    self._firstDiv.focus();
                                }
                            }
                        }
                    }
                }
            });
            if (this.listBox) {
                if (this.listBox.content) {
                    this.addHandler(this.listBox.content, 'click', function (event) {
                        if (!self.disabled) {
                            if (self.listBox.itemswrapper && event.target === self.listBox.itemswrapper[0])
                                return true;

                            self.renderSelection('mouse');
                            if (!self.touch) {
                                if (!self.ishiding) {
                                    if (!self.checkboxes) {
                                        self.hideListBox();
                                        if (self._firstDiv) {
                                            self._firstDiv.focus();
                                        }
                                    }
                                }
                            }
                            if (!self.keyboardSelection) {
                                if (self._oldSelectedInd == undefined) self._oldSelectedIndx = self.selectedIndex;

                                if (self.selectedIndex != self._oldSelectedIndx) {
                                    self._raiseEvent('2', { index: self.selectedIndex, type: 'keyboard', item: self.getItem(self.selectedIndex) });
                                    self._oldSelectedIndx = self.selectedIndex;
                                }
                            }
                        }
                    });
                }
            }

            this.addHandler(this.host, 'focus', function (event) {
                if (self.renderMode !== 'simple') {
                    self.host.addClass(self.toThemeProperty('jqx-dropdownlist-state-focus'));
                    self.host.addClass(self.toThemeProperty('jqx-fill-state-focus'));
                }
            });
            this.addHandler(this.host, 'blur', function () {
                if (self.renderMode !== 'simple') {
                    self.host.removeClass(self.toThemeProperty('jqx-dropdownlist-state-focus'));
                    self.host.removeClass(self.toThemeProperty('jqx-fill-state-focus'));
                }
            });
            this.addHandler(this._firstDiv, 'focus', function (event) {
                if (self.renderMode !== 'simple') {
                    self.host.addClass(self.toThemeProperty('jqx-dropdownlist-state-focus'));
                    self.host.addClass(self.toThemeProperty('jqx-fill-state-focus'));
                }
            });
            this.addHandler(this._firstDiv, 'blur', function () {
                if (self.renderMode !== 'simple') {
                    self.host.removeClass(self.toThemeProperty('jqx-dropdownlist-state-focus'));
                    self.host.removeClass(self.toThemeProperty('jqx-fill-state-focus'));
                }
            });
        },

        removeHandlers: function () {
            var self = this;
            var eventName = 'mousedown';
            if (this.touch) eventName = $.jqx.mobile.getTouchEventName('touchstart');
            this.removeHandler(this.dropdownlistWrapper, eventName);
            if (this.listBox) {
                if (this.listBox.content) {
                    this.removeHandler(this.listBox.content, 'click');
                }
            }

            this.removeHandler(this.host, 'loadContent');
            this.removeHandler(this.listBoxContainer, 'checkChange');
            this.removeHandler(this.host, 'keydown');
            this.removeHandler(this.host, 'focus');
            this.removeHandler(this.host, 'blur');
            this.removeHandler(this._firstDiv, 'focus');
            this.removeHandler(this._firstDiv, 'blur');
            this.removeHandler(this.host, 'mouseenter');
            this.removeHandler(this.host, 'mouseleave');
            this.removeHandler($(document), 'mousemove.' + self.id);
        },

        // gets an item by index.
        getItem: function (index) {
            var item = this.listBox.getItem(index);
            return item;
        },

        getItemByValue: function (value) {
            var item = this.listBox.getItemByValue(value);
            return item;
        },

        selectItem: function (item) {
            if (this.listBox != undefined) {
                this.listBox.selectItem(item);
                this.selectedIndex = this.listBox.selectedIndex;
                this.renderSelection('mouse');
            }
        },

        unselectItem: function (item) {
            if (this.listBox != undefined) {
                this.listBox.unselectItem(item);
                this.renderSelection('mouse');
            }
        },

        checkItem: function (item) {
            if (this.listBox != undefined) {
                this.listBox.checkItem(item);
            }
        },

        uncheckItem: function (item) {
            if (this.listBox != undefined) {
                this.listBox.uncheckItem(item);
            }
        },

        indeteterminateItem: function (item) {
            if (this.listBox != undefined) {
                this.listBox.indeteterminateItem(item);
            }
        },


        // renders the selection.
        renderSelection: function () {
            if (this.listBox == null)
                return;

            if (this.height && this.height.toString().indexOf('%') != -1) {
                this._arrange();
            }

            var item = this.listBox.visibleItems[this.listBox.selectedIndex];
            var me = this;
            if (this.checkboxes) {
                var checkedItems = this.getCheckedItems();
                if (checkedItems != null && checkedItems.length > 0) {
                    item = checkedItems[0];
                }
                else item = null;
            }

            if (item == null) {
                var spanElement = $('<span style="color: inherit; border: none; background-color: transparent;"></span>');
                spanElement.appendTo($(document.body));
                spanElement.addClass(this.toThemeProperty('jqx-widget'));
                spanElement.addClass(this.toThemeProperty('jqx-listitem-state-normal'));
                spanElement.addClass(this.toThemeProperty('jqx-item'));

                $.jqx.utilities.html(spanElement, this.placeHolder);
                var topPadding = this.dropdownlistContent.css('padding-top');
                var bottomPadding = this.dropdownlistContent.css('padding-bottom');
                spanElement.css('padding-top', topPadding);
                spanElement.css('padding-bottom', bottomPadding);
                var spanHeight = spanElement.outerHeight();
                spanElement.remove();
                spanElement.removeClass();
                $.jqx.utilities.html(this.dropdownlistContent, spanElement);
                var height = this.host.height();
                if (this.height != null && this.height != undefined) {
                    if (this.height.toString().indexOf('%') === -1) {
                        height = parseInt(this.height);
                    }
                }

                var top = parseInt((parseInt(height) - parseInt(spanHeight)) / 2);

                if (top > 0) {
                    this.dropdownlistContent.css('margin-top', top + 'px');
                    this.dropdownlistContent.css('margin-bottom', top + 'px');
                }
                if (this.selectionRenderer) {
                    $.jqx.utilities.html(this.dropdownlistContent, this.selectionRenderer());
                    this._updateInputSelection();
                }
                this.selectedIndex = this.listBox.selectedIndex;
                if (this.width === "auto") {
                    this._arrange();
                }
                return;
            }

            this.selectedIndex = this.listBox.selectedIndex;
            var spanElement = $('<span style="color: inherit; border: none; background-color: transparent;"></span>');
            spanElement.appendTo($(document.body));
            spanElement.addClass(this.toThemeProperty('jqx-widget'));
            spanElement.addClass(this.toThemeProperty('jqx-listitem-state-normal'));
            spanElement.addClass(this.toThemeProperty('jqx-item'));

            var emptyItem = false;
            try {
                if (item.html != undefined && item.html != null && item.html.toString().length > 0) {
                    $.jqx.utilities.html(spanElement, item.html);
                }
                else if (item.label != undefined && item.label != null && item.label.toString().length > 0) {
                    $.jqx.utilities.html(spanElement, item.label);
                }
                else if (item.label === null) {
                    emptyItem = true;
                    $.jqx.utilities.html(spanElement, "");
                }
                else if (item.value != undefined && item.value != null && item.value.toString().length > 0) {
                    $.jqx.utilities.html(spanElement, item.value);

                }
                else if (item.title != undefined && item.title != null && item.title.toString().length > 0) {
                    $.jqx.utilities.html(spanElement, item.title);
                }
                else if (item.label == "" || item.label == null) {
                    emptyItem = true;
                    $.jqx.utilities.html(spanElement, "");
                }
            }
            catch (error) {
                var errorMessage = error;
            }

            var topPadding = this.dropdownlistContent.css('padding-top');
            var bottomPadding = this.dropdownlistContent.css('padding-bottom');

            spanElement.css('padding-top', topPadding);
            spanElement.css('padding-bottom', bottomPadding);

            var spanHeight = spanElement.outerHeight();
            if (spanHeight === 0) {
                spanHeight = 16;
            }

            if ((item.label == "" || item.label == null) && emptyItem) {
                $.jqx.utilities.html(spanElement, "");
            }
            var notPercentageWidth = this.width && this.width.toString().indexOf('%') <= 0;
              
            spanElement.remove();
            spanElement.removeClass();
            if (this.selectionRenderer) {
               $.jqx.utilities.html(this.dropdownlistContent, this.selectionRenderer(spanElement, item.index, item.label, item.value));
            }
            else {
                if (this.checkboxes) {
                    var items = this.getCheckedItems();
                    var str = "";
                    for (var i = 0; i < items.length; i++) {
                        if (i == items.length - 1) {
                            str += items[i].label;
                        }
                        else {
                            str += items[i].label + ",";
                        }
                    }
                    spanElement.text(str);
                    if (notPercentageWidth) {
                        spanElement.css('max-width', this.host.width() - 30);
                    }
                    spanElement.css('overflow', 'hidden');
                    spanElement.css('display', 'block');
                    if (!this.rtl) {
                        if (notPercentageWidth) {
                            spanElement.css('width', this.host.width() - 30);
                        }
                    }
                    spanElement.css('text-overflow', 'ellipsis');
                    this.dropdownlistContent.html(spanElement);
                }
                else {
                    if (this.width && this.width !== 'auto') {
                        if (notPercentageWidth) {
                            if (!this.rtl) {
                                spanElement.css('max-width', this.host.width() - 10);
                            }
                        }

                        spanElement.css('overflow', 'hidden');
                        spanElement.css('display', 'block');
                        if (!this.rtl) {
                            if (notPercentageWidth) {
                                spanElement.css('width', this.host.width() - 10);
                            }
                        }
                        spanElement.css('text-overflow', 'ellipsis');
                    }

                    this.dropdownlistContent.html(spanElement);
                }
            }

            var height = this.host.height();
            if (this.height != null && this.height != undefined) {
                if (this.height.toString().indexOf('%') === -1) {
                    height = parseInt(this.height);
                }
            }

            var top = parseInt((parseInt(height) - parseInt(spanHeight)) / 2);

            if (top > 0) {
                this.dropdownlistContent.css('margin-top', top + 'px');
                this.dropdownlistContent.css('margin-bottom', top + 'px');
            }
            if (this.dropdownlistContent && this.input) {
                this._updateInputSelection();
            }
            if (this.listBox && this.listBox._activeElement) {
                $.jqx.aria(this, "aria-activedescendant", this.listBox._activeElement.id);
            }
            if (this.width === "auto") {
                this._arrange();
            }
        },

        _updateInputSelection: function () {
            if (this.input) {
                if (this.selectedIndex == -1) {
                    this.input.val("");
                }
                else {
                    var selectedItem = this.getSelectedItem();
                    if (selectedItem != null) {
                        this.input.val(selectedItem.value);
                    }
                    else {
                        this.input.val(this.dropdownlistContent.text());
                    }
                }
                if (this.checkboxes) {
                    var items = this.getCheckedItems();
                    var str = "";
                    if (items != null) {
                        for (var i = 0; i < items.length; i++) {
                            var value = items[i].value;
                            if (value == undefined) continue;
                            if (i == items.length - 1) {
                                str += value;
                            }
                            else {
                                str += value + ",";
                            }
                        }
                    }
                    this.input.val(str);
                }
            }
        },

        setContent: function (content) {
            $.jqx.utilities.html(this.dropdownlistContent, content);
            this._updateInputSelection();
        },

        dataBind: function () {
            this.listBoxContainer.jqxListBox({ source: this.source });
            this.renderSelection('mouse');
            if (this.source == null) {
                this.clearSelection();
            }
        },

        clear: function () {
            this.listBoxContainer.jqxListBox({ source: null });
            this.clearSelection();
        },

        // clears the selection.
        clearSelection: function (render) {
            this.selectedIndex = -1;
            this._updateInputSelection();
            this.listBox.clearSelection();
            this.renderSelection();
            $.jqx.utilities.html(this.dropdownlistContent, this.placeHolder);
        },

        // unselects an item at specific index.
        // @param Number
        unselectIndex: function (index, render) {
            if (isNaN(index))
                return;

            this.listBox.unselectIndex(index, render);
            this.renderSelection();
        },

        // selects an item at specific index.
        // @param Number
        selectIndex: function (index, ensureVisible, render, forceSelect) {
            this.listBox.selectIndex(index, ensureVisible, render, forceSelect, 'api');
        },

        // gets the selected index.
        getSelectedIndex: function () {
            return this.selectedIndex;
        },

        // gets the selected item.
        getSelectedItem: function () {
            return this.getItem(this.selectedIndex);
        },

        getCheckedItems: function () {
            return this.listBox.getCheckedItems();
        },

        checkIndex: function (index) {
            this.listBox.checkIndex(index);
        },

        uncheckIndex: function (index) {
            this.listBox.uncheckIndex(index);
        },

        indeterminateIndex: function (index) {
            this.listBox.indeterminateIndex(index);
        },
        checkAll: function () {
            this.listBox.checkAll();
        },

        uncheckAll: function () {
            this.listBox.uncheckAll();
        },

        addItem: function (item) {
            return this.listBox.addItem(item);
        },
        
        insertAt: function (item, index) {
            if (item == null)
                return false;

            return this.listBox.insertAt(item, index);
        },

        removeAt: function (index) {
            var result = this.listBox.removeAt(index);
            this.renderSelection('mouse');
            return result;
        },

        removeItem: function (item) {
            var result = this.listBox.removeItem(item);
            this.renderSelection('mouse');
            return result;
        },

        updateItem: function (item, oldItem) {
            var result = this.listBox.updateItem(item, oldItem);
            this.renderSelection('mouse');
            return result;
        },

        updateAt: function (item, index) {
            var result = this.listBox.updateAt(item, index);
            this.renderSelection('mouse');
            return result;
        },

        ensureVisible: function (index) {
            return this.listBox.ensureVisible(index);
        },

        disableAt: function (index) {
            return this.listBox.disableAt(index);
        },

        enableAt: function (index) {
            return this.listBox.enableAt(index);
        },

        disableItem: function (item) {
            return this.listBox.disableItem(item);
        },

        enableItem: function (item) {
            return this.listBox.enableItem(item);
        },

        _findPos: function (obj) {
            while (obj && (obj.type == 'hidden' || obj.nodeType != 1 || $.expr.filters.hidden(obj))) {
                obj = obj['nextSibling'];
            }
            var position = $(obj).coord(true);
            return [position.left, position.top];
        },

        testOffset: function (element, offset, inputHeight) {
            var dpWidth = element.outerWidth();
            var dpHeight = element.outerHeight();
            var viewWidth = $(window).width() + $(window).scrollLeft();
            var viewHeight = $(window).height() + $(window).scrollTop();

            if (offset.left + dpWidth > viewWidth) {
                if (dpWidth > this.host.width()) {
                    var hostLeft = this.host.coord().left;
                    var hOffset = dpWidth - this.host.width();
                    offset.left = hostLeft - hOffset + 2;
                }
            }
            if (offset.left < 0) {
                offset.left = parseInt(this.host.coord().left) + 'px'
            }

            offset.top -= Math.min(offset.top, (offset.top + dpHeight > viewHeight && viewHeight > dpHeight) ?
                Math.abs(dpHeight + inputHeight + 22) : 0);

            return offset;
        },

        open: function () {
            this.showListBox();
        },

        close: function () {
            this.hideListBox();
        },

        _getBodyOffset: function () {
            var top = 0;
            var left = 0;
            if ($('body').css('border-top-width') != '0px') {
                top = parseInt($('body').css('border-top-width'));
                if (isNaN(top)) top = 0;
            }
            if ($('body').css('border-left-width') != '0px') {
                left = parseInt($('body').css('border-left-width'));
                if (isNaN(left)) left = 0;
            }
            return { left: left, top: top };
        },

        // shows the listbox.
        showListBox: function () {
            $.jqx.aria(this, "aria-expanded", true);

            if (this.dropDownWidth == 'auto' && this.width != null && this.width.indexOf && this.width.indexOf('%') != -1) {
                if (this.listBox.host.width() != this.host.width()) {
                    var width = this.host.width();
                    this.listBoxContainer.jqxListBox({ width: width });
                    this.container.width(parseInt(width) + 25);
                }
            }

            var self = this;
            var listBox = this.listBoxContainer;
            var listBoxInstance = this.listBox;
            var scrollPosition = $(window).scrollTop();
            var scrollLeftPosition = $(window).scrollLeft();
            var top = parseInt(this._findPos(this.host[0])[1]) + parseInt(this.host.outerHeight()) - 1 + 'px';
            //var left = parseInt(Math.round(this.host.coord(true).left)) + 'px';
            var left, leftPos = parseInt(Math.round(this.host.coord(true).left));
            left = leftPos + 'px';

            var isMobileBrowser = $.jqx.mobile.isSafariMobileBrowser() || $.jqx.mobile.isWindowsPhone();

            if (this.listBox == null)
                return;
         
            var hasTransform = $.jqx.utilities.hasTransform(this.host);
            this.ishiding = false;
            if (!this.keyboardSelection) {
                this.listBox.selectIndex(this.selectedIndex);
                this.listBox.ensureVisible(this.selectedIndex);
            }

            this.tempSelectedIndex = this.selectedIndex;

            if (this.autoDropDownHeight) {
                this.container.height(this.listBoxContainer.height() + 25);
            }

            if (hasTransform || (isMobileBrowser != null && isMobileBrowser)) {
                left = $.jqx.mobile.getLeftPos(this.element);
                top = $.jqx.mobile.getTopPos(this.element) + parseInt(this.host.outerHeight());
                if ($('body').css('border-top-width') != '0px') {
                    top = parseInt(top) - this._getBodyOffset().top + 'px';
                }
                if ($('body').css('border-left-width') != '0px') {
                    left = parseInt(left) - this._getBodyOffset().left + 'px';
                }
            }

            listBox.stop();
            if (this.renderMode !== 'simple') {
                this.host.addClass(this.toThemeProperty('jqx-dropdownlist-state-selected'));
                this.host.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
                this.arrow.addClass(this.toThemeProperty('jqx-icon-arrow-down-selected'));
            }

            this.container.css('left', left);
            this.container.css('top', top);
            listBoxInstance._arrange();

            var closeAfterSelection = true;
            var positionChanged = false;

            if (this.dropDownHorizontalAlignment == 'right' || this.rtl) {
                var containerWidth = this.container.outerWidth();
                var containerLeftOffset = Math.abs(containerWidth - this.host.width());

                if (containerWidth > this.host.width()) {
                    this.container.css('left', 25 + parseInt(Math.round(leftPos)) - containerLeftOffset + "px");
                }
                else this.container.css('left', 25 + parseInt(Math.round(leftPos)) + containerLeftOffset + "px");
            }

            if (this.enableBrowserBoundsDetection) {
                var newOffset = this.testOffset(listBox, { left: parseInt(this.container.css('left')), top: parseInt(top) }, parseInt(this.host.outerHeight()));
                if (parseInt(this.container.css('top')) != newOffset.top) {
                    positionChanged = true;
                    listBox.css('top', 23);
                }
                else listBox.css('top', 0);

                this.container.css('top', newOffset.top);
                if (parseInt(this.container.css('left')) != newOffset.left) {
                    this.container.css('left', newOffset.left);
                }
            }

            if (this.animationType == 'none') {
                this.container.css('display', 'block');
                $.data(document.body, "openedJQXListBoxParent", self);
                $.data(document.body, "openedJQXListBox" + this.id, listBox);
                listBox.css('margin-top', 0);
                listBox.css('opacity', 1);
            }
            else {
                this.container.css('display', 'block');
                self.isanimating = true;
                if (this.animationType == 'fade') {
                    listBox.css('margin-top', 0);
                    listBox.css('opacity', 0);
                    listBox.animate({ 'opacity': 1 }, this.openDelay, function () {
                        $.data(document.body, "openedJQXListBoxParent", self);
                        $.data(document.body, "openedJQXListBox" + self.id, listBox);
                        self.ishiding = false;
                        self.isanimating = false;
                    });
                }
                else {
                    listBox.css('opacity', 1);
                    var height = listBox.outerHeight();
                    if (positionChanged) {
                        listBox.css('margin-top', height);
                    }
                    else {
                        listBox.css('margin-top', -height);
                    }

                    listBox.animate({ 'margin-top': 0 }, this.openDelay, function () {
                        $.data(document.body, "openedJQXListBoxParent", self);
                        $.data(document.body, "openedJQXListBox" + self.id, listBox);
                        self.ishiding = false;
                        self.isanimating = false;
                    });
                }
            }
            if (!positionChanged) {
                this.host.addClass(this.toThemeProperty('jqx-rc-b-expanded'));
                listBox.addClass(this.toThemeProperty('jqx-rc-t-expanded'));
            }
            else {
                this.host.addClass(this.toThemeProperty('jqx-rc-t-expanded'));
                listBox.addClass(this.toThemeProperty('jqx-rc-b-expanded'));
            }
            if (this.renderMode !== 'simple') {
                listBox.addClass(this.toThemeProperty('jqx-fill-state-focus'));
                this.host.addClass(this.toThemeProperty('jqx-dropdownlist-state-focus'));
                this.host.addClass(this.toThemeProperty('jqx-fill-state-focus'));
            }

            this.host.focus();
            setTimeout(function () {
                self.host.focus();
            });

            listBoxInstance._renderItems();
            this._raiseEvent('0', listBoxInstance);
        },

        // hides the listbox.
        hideListBox: function () {
            $.jqx.aria(this, "aria-expanded", false);

            var listBox = this.listBoxContainer;
            var listBoxInstance = this.listBox;
            var container = this.container;
            var me = this;
            $.data(document.body, "openedJQXListBox" + this.id, null);
            if (this.animationType == 'none') {
                this.container.css('display', 'none');
            }
            else {
                if (!me.ishiding) {
                    listBox.stop();
                    var height = listBox.outerHeight();
                    listBox.css('margin-top', 0);
                    me.isanimating = true;

                    var animationValue = -height;
                    if (parseInt(this.container.coord().top) < parseInt(this.host.coord().top)) {
                        animationValue = height;
                    }

                    if (this.animationType == 'fade') {
                        listBox.css({ 'opacity': 1 });
                        listBox.animate({ 'opacity': 0 }, this.closeDelay, function () {
                            container.css('display', 'none');
                            me.isanimating = false;
                            me.ishiding = false;
                        });
                    }
                    else {
                        listBox.animate({ 'margin-top': animationValue }, this.closeDelay, function () {
                            container.css('display', 'none');
                            me.isanimating = false;
                            me.ishiding = false;
                        });
                    }
                }
            }

            this.ishiding = true;
            this.host.removeClass(this.toThemeProperty('jqx-dropdownlist-state-selected'));
            this.host.removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
            this.arrow.removeClass(this.toThemeProperty('jqx-icon-arrow-down-selected'));

            this.host.removeClass(this.toThemeProperty('jqx-rc-b-expanded'));
            listBox.removeClass(this.toThemeProperty('jqx-rc-t-expanded'));
            this.host.removeClass(this.toThemeProperty('jqx-rc-t-expanded'));
            listBox.removeClass(this.toThemeProperty('jqx-rc-b-expanded'));
            listBox.removeClass(this.toThemeProperty('jqx-fill-state-focus'));
      
            this._raiseEvent('1', listBoxInstance);
        },

        /* Close popup if clicked elsewhere. */
        closeOpenedListBox: function (event) {
            var self = event.data.me;
            var $target = $(event.target);
            var openedListBox = event.data.listbox;
            if (openedListBox == null)
                return true;

            if ($(event.target).ischildof(event.data.me.host)) {
                return true;
            }

            if (!self.isOpened()) {
                return true;
            }

            var dropdownlistInstance = self;

            var isListBox = false;
            $.each($target.parents(), function () {
                if (this.className != 'undefined') {
                    if (this.className.indexOf) {
                        if (this.className.indexOf('jqx-listbox') != -1) {
                            isListBox = true;
                            return false;
                        }
                        if (this.className.indexOf('jqx-dropdownlist') != -1) {
                            if (self.element.id == this.id) {
                                isListBox = true;
                            }
                            return false;
                        }
                    }
                }
            });

            if (openedListBox != null && !isListBox && self.isOpened()) {
                self.hideListBox();
            }

            return true;
        },

        loadFromSelect: function (id) {
            this.listBox.loadFromSelect(id);
        },

        refresh: function (initialRefresh) {
            if (initialRefresh !== true) {
                this._setSize();
                this._arrange();
                if (this.listBox) {
                    this.renderSelection();
                }
            }
        },

        _arrange: function () {
            var width = parseInt(this.host.width());
            var height = parseInt(this.host.height());
            var arrowHeight = this.arrowSize;
            var arrowWidth = this.arrowSize;
            var rightOffset = 3;
            var contentWidth = width - arrowWidth - 2 * rightOffset;
            if (contentWidth > 0 && this.width !== "auto") {
                this.dropdownlistContent.width(contentWidth + 'px');
            }
            if (this.width === "auto") {
                width = this.dropdownlistContent.width() + arrowWidth + 2 * rightOffset;
                this.host.width(width);
            }
            this.dropdownlistContent.height(height);
            this.dropdownlistContent.css('left', 0);
            this.dropdownlistContent.css('top', 0);

            this.dropdownlistArrow.width(arrowWidth);
            this.dropdownlistArrow.height(height);

            if (this.rtl) {
                this.dropdownlistArrow.css('float', 'left');
                this.dropdownlistContent.css('float', 'right');
            }
        },

        destroy: function () {
            $.jqx.utilities.resize(this.host, null, true);
            this.removeHandler(this.listBoxContainer, 'select');
            this.removeHandler(this.listBoxContainer, 'unselect');
            this.removeHandler(this.listBoxContainer, 'change');
            this.removeHandler(this.dropdownlistWrapper, 'selectstart');
            this.removeHandler(this.dropdownlistWrapper, 'mousedown');
            this.removeHandler(this.host, 'keydown');
            this.removeHandler(this.listBoxContainer, 'select');
            this.removeHandler(this.listBox.content, 'click');
            this.removeHandler(this.listBoxContainer, 'bindingComplete');
      
            if (this.host.parents()) {
                this.removeHandler(this.host.parents(), 'scroll.dropdownlist' + this.element.id);
            }

            this.removeHandlers();

            this.listBoxContainer.jqxListBox('destroy');
            this.listBoxContainer.remove();
            this.host.removeClass();
            this.removeHandler($(document), 'mousedown.' + this.id, this.closeOpenedListBox);
            if (this.touch) {
                this.removeHandler($(document), $.jqx.mobile.getTouchEventName('touchstart') + '.' + this.id);
            }

            this.dropdownlistArrow.remove();
            delete this.dropdownlistArrow;
            delete this.dropdownlistWrapper;
            delete this.listBoxContainer;
            delete this.input;
            delete this.arrow;
            delete this.dropdownlistContent;
            delete this.listBox;
            delete this._firstDiv;
            this.container.remove();
            delete this.container;
            var vars = $.data(this.element, "jqxDropDownList");
            if (vars) {
                delete vars.instance;
            }
            this.host.removeData();
            this.host.remove();
            delete this.comboStructure;
            delete this.host;
            delete this.set;
            delete this.get;
            delete this.call;
            delete this.element;
        },

        _raiseEvent: function (id, arg) {
            if (arg == undefined)
                arg = { owner: null };

            var evt = this.events[id];
            args = arg;
            args.owner = this;

            var event = new jQuery.Event(evt);
            event.owner = this;
            if (id == 2 || id == 3 || id == 4 || id == 5) {
                event.args = arg;
            }

            var result = this.host.trigger(event);
            return result;
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (object.isInitialized == undefined || object.isInitialized == false)
                return;

            if (key == 'autoOpen') {
                object._updateHandlers();
            }
            if (key == 'emptyString') {
                object.listBox.emptyString = object.emptyString;
            }
            if (key == 'renderer') {
                object.listBox.renderer = object.renderer;
            }
            if (key == 'itemHeight') {
                object.listBox.itemHeight = value;
            }
            if (key == "rtl") {
                if (value) {
                    object.dropdownlistArrow.css('float', 'left');
                    object.dropdownlistContent.css('float', 'right');
                }
                else {
                    object.dropdownlistArrow.css('float', 'right');
                    object.dropdownlistContent.css('float', 'left');
                }
                object.listBoxContainer.jqxListBox({ rtl: object.rtl });
            }
            if (key == 'source') {
                object.listBoxContainer.jqxListBox({ source: object.source });
                object.listBox.selectedIndex = -1;
                object.listBox.selectIndex(this.selectedIndex);
                object.renderSelection();
                if (value == null) {
                    object.clear();
                }
            }

            if (key == "displayMember" || key == "valueMember") {
                object.listBoxContainer.jqxListBox({ displayMember: object.displayMember, valueMember: object.valueMember });
                object.renderSelection();
            }
            if (key == "placeHolder") {
                object.renderSelection();
            }

            if (key == 'theme' && value != null) {
                object.listBoxContainer.jqxListBox({ theme: value });
                object.listBoxContainer.addClass(object.toThemeProperty('jqx-popup'));
                if ($.jqx.browser.msie) {
                    object.listBoxContainer.addClass(object.toThemeProperty('jqx-noshadow'));
                }
                object.dropdownlistContent.removeClass();
                object.dropdownlistContent.addClass(object.toThemeProperty('jqx-dropdownlist-content'));
                object.dropdownlistWrapper.removeClass();
                object.dropdownlistWrapper.addClass(object.toThemeProperty('jqx-disableselect'));
                object.host.removeClass();
                object.host.addClass(object.toThemeProperty('jqx-fill-state-normal'));
                object.host.addClass(object.toThemeProperty('jqx-dropdownlist-state-normal'));
                object.host.addClass(object.toThemeProperty('jqx-rc-all'));
                object.host.addClass(object.toThemeProperty('jqx-widget'));
                object.arrow.removeClass();
                object.arrow.addClass(object.toThemeProperty('jqx-icon-arrow-down'));
                object.arrow.addClass(object.toThemeProperty('jqx-icon'));
            }

            if (key == "autoDropDownHeight") {
                object.listBoxContainer.jqxListBox({ autoHeight: object.autoDropDownHeight });
                if (object.autoDropDownHeight) {
                    object.container.height(object.listBoxContainer.height() + 25);
                }
                else {
                    object.listBoxContainer.jqxListBox({ height: object.dropDownHeight });
                    object.container.height(parseInt(object.dropDownHeight) + 25);
                }

                object.listBox._arrange();
                object.listBox._updatescrollbars();
            }

            if (key == "searchMode") {
                object.listBoxContainer.jqxListBox({ searchMode: object.searchMode });
            }

            if (key == "incrementalSearch") {
                object.listBoxContainer.jqxListBox({ incrementalSearch: object.incrementalSearch });
            }

            if (key == "incrementalSearchDelay") {
                object.listBoxContainer.jqxListBox({ incrementalSearchDelay: object.incrementalSearchDelay });
            }

            if (key == "dropDownHeight") {
                if (!object.autoDropDownHeight) {
                    object.listBoxContainer.jqxListBox({ height: object.dropDownHeight });
                    object.container.height(parseInt(object.dropDownHeight) + 25);
                }
            }

            if (key == "dropDownWidth" || key == "scrollBarSize") {
                var width = object.width;
                if (object.dropDownWidth != 'auto') {
                    width = object.dropDownWidth;
                }

                object.listBoxContainer.jqxListBox({ width: width, scrollBarSize: object.scrollBarSize });
                object.container.width(parseInt(width) + 25);
            }

            if (key == 'width' || key == 'height') {
                if (value != oldvalue) {
                    this.refresh();
                    if (key == 'width') {
                        if (object.dropDownWidth == 'auto') {
                            var width = object.host.width();
                            object.listBoxContainer.jqxListBox({ width: width });
                            object.container.width(parseInt(width) + 25);
                        }
                    }
                }
            }

            if (key == "checkboxes") {
                object.listBoxContainer.jqxListBox({ checkboxes: object.checkboxes });
            }

            if (key == 'selectedIndex') {
                if (object.listBox != null) {
                    object.listBox.selectIndex(parseInt(value));
                    object.renderSelection();
                }
            }
        }
    });
})(jQuery);
(function ($) {

    $.jqx.jqxWidget('jqxWindow', '', {});

    $.extend($.jqx._jqxWindow.prototype, {

        defineInstance: function () {
            // Type: String, Number
            // Default: auto
            // Sets or gets window's height.
            this.height = 'auto';
            // Type: Number
            // Default: 200
            // Sets or gets window's width.
            this.width = 200;
            // Type: Number
            // Default: 50
            // Gets or sets window's minimum height.
            this.minHeight = 50;
            // Type: Number
            // Default: 600
            // Gets or sets window's maximum height.
            this.maxHeight = 600;
            // Type: Number
            // Default: 50
            // Gets or sets window's minimum height.
            this.minWidth = 50;
            // Type: Number
            // Default: 600
            // Gets or sets window's maximum width.
            this.maxWidth = 800;
            // Type: Bool
            // Default: true
            // Gets or sets whether the close button will be shown.
            this.showCloseButton = true;
            // Type: Bool
            // Default: false
            // Gets or sets whether the window is disabled.
            this.disabled = false;
            // Type: Bool
            // Default: true
            // Sets or gets whether the window will be shown after it's creation.
            this.autoOpen = true;
            // Type: Bool
            // Default: true
            // Sets or gets whether the window could be closed with Escape or another keyboard key.
            this.keyboardCloseKey = 'esc';
            // Type: String
            // Default: ''
            // Sets or gets window's title.
            this.title = '';
            // Type: String
            // Default: ''
            // Sets or gets window's content.
            this.content = '';
            // Type: Bool
            // Default: true
            // Sets or gets whether the window is draggale.
            this.draggable = true;
            // Type: Bool
            // Default: true
            // Sets or gets whether the window is resizable.
            this.resizable = true;
            // Type: Bool
            // Default: 'fade'
            // Sets or gets window's animation type. Possible values ['none', 'fade', 'slide', 'combined']
            this.animationType = 'fade';
            // Type: Number
            // Default: 250
            // Sets or gets window's hide animation duration.
            this.closeAnimationDuration = 250;
            // Type: Number
            // Default: 250
            // Sets or gets window's show animation duration.
            this.showAnimationDuration = 250;
            // Type: Bool
            // Default: false
            // Sets or gets whether the window is modal.
            this.isModal = false;
            // Type: String, Array, Object
            // Default: 'center'
            // Sets or gets window's position. Possible values - 'center', 'bottom, left', [232, 45], { x: 42, y: 34 }.
            this.position = 'center';
            // Type: Number
            // Default: 16
            // Sets or gets close button's size.
            this.closeButtonSize = 16;
            // Type: String
            // Default: hide
            // Sets or gets close button action. Possible values ['hide', 'close']. When closeButtonAction is close we are removing the widget.
            this.closeButtonAction = 'hide';
            // Type: Number
            // Default: 0.5
            // Sets or gets modal background's opacity
            this.modalOpacity = 0.3;
            // Type: Object
            // Default: null
            // Sets or gets the dragging area. Example { left: 300, top: 300, width: 600, height: 600 }
            this.dragArea = null;
            // Type: Object
            // Default: null
            // Sets or gets submit button
            this.okButton = null;
            // Type: Object
            // Default: null
            // Sets or gets the cancel button
            this.cancelButton = null;
            // Type: Object
            // Default: { OK: false, Cancel: false, None: true }
            // Sets or gets the dialog result
            this.dialogResult = { OK: false, Cancel: false, None: true };
            // Type: Bool
            // Default: false
            // Sets or gets whether the window is collapsed
            this.collapsed = false;
            // Type: Bool
            // Default: true
            // Sets or gets whether the collapse button is going to be shown
            this.showCollapseButton = false;
            // Type: Number
            // Default: 150
            // Sets or gets the collapse animation duration
            this.collapseAnimationDuration = 150;
            // Type: Number
            // Default: 16
            // Sets or gets the collapse button size
            this.collapseButtonSize = 16;
            this.rtl = false;
            this.keyboardNavigation = true;
            this.headerHeight = null;
            //To move show into 4th place into the array and to remove open
            this._events = ['created', 'closed', 'moving', 'moved', 'open', 'collapse', 'expand', 'open', 'close', 'resize'];
            this.initContent = null;
            this.enableResize = true;
            this.restricter = null;
            this.closing = null;
            this._invalidArgumentExceptions = {
                'invalidHeight': 'Invalid height!',
                'invalidWidth': 'Invalid width!',
                'invalidMinHeight': 'Invalid minHeight!',
                'invalidMaxHeight': 'Invalid maxHeight!',
                'invalidMinWidth': 'Invalid minWidth!',
                'invalidMaxWidth': 'Invalid maxWidth',
                'invalidKeyCode': 'Invalid keyCode!',
                'invalidAnimationType': 'Invalid animationType!',
                'invalidCloseAnimationDuration': 'Invalid closeAnimationDuration!',
                'invalidShowAnimationDuration': 'Invalid showAnimationDuration!',
                'invalidPosition': 'Invalid position!',
                'invalidCloseButtonSize': 'Invalid closeButtonSize!',
                'invalidCollapseButtonSize': 'Invalid collapseButtonSize!',
                'invalidCloseButtonAction': 'Invalid cluseButtonAction!',
                'invalidModalOpacity': 'Invalid modalOpacity!',
                'invalidDragArea': 'Invalid dragArea!',
                'invalidDialogResult': 'Invalid dialogResult!',
                'invalidIsModal': 'You can have just one modal window!'
            };

            this._enableResizeCollapseBackup;
            this._enableResizeBackup;
            this._heightBeforeCollapse;
            this._minHeightBeforeCollapse;
            this._mouseDown = false;
            this._isDragging = false;
            this._rightContentWrapper = null;
            this._leftContentWrapper = null;
            this._headerContentWrapper = null;
            this._closeButton = null;
            this._collapseButton = null;
            this._title = null;
            this._content = null;
            this._mousePosition = {};
            this._windowPosition = {}
            this._modalBackground = null;
            this._SCROLL_WIDTH = 21;
            this._visible = true;
            this.modalBackgroundZIndex = 12990;
            this.modalZIndex = 18000;
            this.zIndex = 9001;
            this._touchEvents = {
                'mousedown': $.jqx.mobile.getTouchEventName('touchstart'),
                'mouseup': $.jqx.mobile.getTouchEventName('touchend'),
                'mousemove': $.jqx.mobile.getTouchEventName('touchmove'),
                'mouseenter': 'mouseenter',
                'mouseleave': 'mouseleave',
                'click': $.jqx.mobile.getTouchEventName('touchstart')
            };
        },

        createInstance: function () {
            this.host.attr('role', 'dialog');
            this.host.detach();
            $(document.body).append(this.host);
            var that = this;

            var initRestricter = function () {
                var paddingTop = parseInt($(that.restricter).css('padding-top'));
                var paddingLeft = parseInt($(that.restricter).css('padding-left'));
                var paddingBottom = parseInt($(that.restricter).css('padding-bottom'));
                var paddingRight = parseInt($(that.restricter).css('padding-right'));

                var coord = $(that.restricter).coord();
                that.dragArea = { left: paddingLeft + coord.left, top: paddingTop + coord.top, width: 1+paddingRight + $(that.restricter).width(), height: 1+paddingBottom + $(that.restricter).height() };
            }

            if (this.restricter) {
                initRestricter();
            }

            if (this.restricter) {
                this.addHandler($(window), 'resize.' + this.element.id, function () {
                    initRestricter();
                });
                this.addHandler($(window), 'orientationchanged.' + this.element.id, function () {
                    initRestricter();
                });
                this.addHandler($(window), 'orientationchange.' + this.element.id, function () {
                    initRestricter();
                });
            }

            this._isTouchDevice = $.jqx.mobile.isTouchDevice();
            this._validateProperties();
            this._createStructure();
            this._refresh();
            if (!this.autoOpen) {
                this.host.css('display', 'none');
            }
            if ($.jqx.browser.msie) {
                this.host.addClass(this.toThemeProperty('jqx-noshadow'));
            }
            if (!this.isModal) {
                this._fixWindowZIndex();
            }

            this._setStartupSettings();
            this._positionWindow();
            this._raiseEvent(0);

            if (this.autoOpen) {
                this._performLayout();
                var self = this;
                if (self.initContent) {
                    self.initContent();
                    self._contentInitialized = true;
                }
                if (this.isModal) {
                    this._fixWindowZIndex('modal-show');
                }
            }
        },

        refresh: function () {
            this._performLayout();
        },

        _setStartupSettings: function () {
            if (this.disabled) {
                this.disable();
            }
            if (this.collapsed) {
                this.collapsed = false;
                this.collapse(0);
            }
            if (!this.autoOpen) {
                this.hide(null, 0.001, true);
                this._visible = false;
            }
            if (this.title !== null && this.title !== '') {
                this.setTitle(this.title);
            }
            if (this.content !== null && this.content !== '') {
                this.setContent(this.content);
            }
            this.title = this._headerContentWrapper.html();
            this.content = this._content.html();
        },

        //Fixing window's z-index and adding it to the collection of all windows
        //saved in $.data. In the end of the method we are sorting the window list in ascending z-index order.
        _fixWindowZIndex: function (type) {
            var windowsList = $.data(document.body, 'jqxwindows-list') || [], zIndex = this.zIndex, tempZIndex;
            if (!this.isModal) {
                if (this._indexOf(this.host, windowsList) < 0) {
                    windowsList.push(this.host);
                }
                $.data(document.body, 'jqxwindows-list', windowsList);
                if (windowsList.length > 1) {
                    var upperWindow = windowsList[windowsList.length - 2];
                    zIndex = parseInt(upperWindow.css('z-index'), 10) + 1;
                }
            } else {
                if (windowsList) {
                    windowsList = this._removeFromArray(this.host, windowsList);
                    $.data(document.body, 'jqxwindows-list', windowsList);
                }

                var modalWindows = $.data(document.body, 'jqxwindows-modallist');
                if (!modalWindows) {
                    if (type == 'modal-show') {
                        var list = new Array();
                        list.push(this.host);
                        $.data(document.body, 'jqxwindows-modallist', list);
                        modalWindows = list;
                    }
                    else {
                        $.data(document.body, 'jqxwindows-modallist', new Array());
                        modalWindows = new Array();
                    }
                }
                else {
                    if (type == 'modal-show') {
                        modalWindows.push(this.host);
                    }
                    else {
                        var index = modalWindows.indexOf(this.host);
                        if (index != -1) {
                            modalWindows.splice(index, 1);
                        }
                    }
                }


                zIndex = this.modalZIndex;;
             
                var me = this;
                $.each(modalWindows, function (p) {
                    if (this.data()) {
                        if (this.data().jqxWindow) {
                            var instance = this.data().jqxWindow.instance;
                            instance._modalBackground.css('z-index', zIndex);
                            instance.host.css('z-index', zIndex + 1);
                            zIndex += 2;
                        }
                    }
                });

                $.data(document.body, 'jqxwindow-modal', this.host);

                return;
            }
            this.host.css('z-index', zIndex);
            this._sortByStyle('z-index', windowsList);
        },

        _validateProperties: function () {
            try {
                this._validateSize();
                this._validateAnimationProperties();
                this._validateInteractionProperties();
                this._validateModalProperties();
                if (!this.position) {
                    throw new Error(this._invalidArgumentExceptions['invalidPosition']);
                }
                if (isNaN(this.closeButtonSize) || parseInt(this.closeButtonSize) < 0) {
                    throw new Error(this._invalidArgumentExceptions['invalidCloseButtonSize']);
                }
                if (isNaN(this.collapseButtonSize) || parseInt(this.collapseButtonSize) < 0) {
                    throw new Error(this._invalidArgumentExceptions['invalidCollapseButtonSize']);
                }
            } catch (exception) {
                alert(exception);
            }
        },

        _validateModalProperties: function () {
            if (this.modalOpacity < 0 || this.modalOpacity > 1) {
                throw new Error(this._invalidArgumentExceptions['invalidModalOpacity']);
            }
            if (this.isModal && !this._singleModalCheck()) {
                throw new Error(this._invalidArgumentExceptions['invalidIsModal']);
            }
        },

        //If window's height is less than minHeight we are stting height to minHeight the same when the width is less than minWidth.
        //If window's height is greater than maxHeight we are setting height to maxHeight the same with the width.
        _validateSize: function () {
            this._validateSizeLimits();
            if (this.height !== 'auto' && isNaN(parseInt(this.height))) {
                throw new Error(this._invalidArgumentExceptions['invalidHeight']);
            }
            if (this.width !== 'auto' && isNaN(parseInt(this.width))) {
                throw new Error(this._invalidArgumentExceptions['invalidWidth']);
            }
            if (this.height !== 'auto' && this.height < this.minHeight) {
                this.height = this.minHeight;
            }
            if (this.width < this.minWidth) {
                this.width = this.minWidth;
            }
            if (this.height !== 'auto' && this.height > this.maxHeight) {
                this.height = this.maxHeight;
            }
            if (this.width > this.maxWidth) {
                this.width = this.maxWidth;
            }
            if (this.dragArea === null) return;
            if (this.dragArea && ((this.dragArea.height !== null && this.host.height() > this.dragArea.height) ||
                (parseInt(this.height, 10) > this.dragArea.height)) ||
                (this.dragArea.width !== null && this.width > this.dragArea.width) ||
                (this.maxHeight > this.dragArea.height || this.maxWidth > this.dragArea.width)) {
                //throw new Error(this._invalidArgumentExceptions['invalidDragArea']);
            }
        },

        _validateSizeLimits: function () {
            if (isNaN(parseInt(this.minHeight))) {
                throw new Error(this._invalidArgumentExceptions['invalidMinHeight']);
            }
            if (isNaN(parseInt(this.maxHeight))) {
                throw new Error(this._invalidArgumentExceptions['invalidMaxHeight']);
            }
            if (isNaN(parseInt(this.minWidth))) {
                throw new Error(this._invalidArgumentExceptions['invalidMinWidth']);
            }
            if (isNaN(parseInt(this.maxWidth))) {
                throw new Error(this._invalidArgumentExceptions['invalidMaxWidth']);
            }
            if (this.minHeight > this.maxHeight) {
                throw new Error(this._invalidArgumentExceptions['invalidMinHeight']);
            }
            if (this.minWidth > this.maxWidth) {
                throw new Error(this._invalidArgumentExceptions['invalidMinWidth']);
            }
        },

        _validateAnimationProperties: function () {
            if (this.animationType !== 'fade' && this.animationType !== 'slide' && this.animationType !== 'combined' && this.animationType !== 'none') {
                throw new Error(this._invalidArgumentExceptions['invalidAnimationType']);
            }
            if (isNaN(parseInt(this.closeAnimationDuration), 10) || this.closeAnimationDuration < 0) {
                throw new Error(this._invalidArgumentExceptions['invalidCloseAnimationDuration']);
            }
            if (isNaN(parseInt(this.showAnimationDuration), 10) || this.showAnimationDuration < 0) {
                throw new Error(this._invalidArgumentExceptions['invalidShowAnimationDuration']);
            }
        },

        _validateInteractionProperties: function () {
            if (parseInt(this.keyCode, 10) < 0 || parseInt(this.keyCode, 10) > 130 && this.keyCode !== 'esc') {
                throw new Error(this._invalidArgumentExceptions['invalidKeyCode']);
            }
            if (this.dragArea !== null && (typeof this.dragArea.width === 'undefined' ||
                typeof this.dragArea.height === 'undefined' || typeof this.dragArea.left === 'undefined' || typeof this.dragArea.top === 'undefined')) {
                throw new Error(this._invalidArgumentExceptions['invalidDragArea']);
            }
            if (!this.dialogResult || (!this.dialogResult.OK && !this.dialogResult.Cancel && !this.dialogResult.None)) {
                throw new Error(this._invalidArgumentExceptions['invalidDialogResult']);
            }
            if (this.closeButtonAction !== 'hide' && this.closeButtonAction !== 'close') {
                throw new Error(this._invalidArgumentExceptions['invalidCloseButtonAction']);
            }
        },

        _singleModalCheck: function () {
            var windowsList = $.data(document.body, 'jqxwindows-list') || [],
                count = windowsList.length;
            while (count) {
                count -= 1;
                if ($(windowsList[count].attr('id')).length > 0) {
                    if ($(windowsList[count].attr('id')).jqxWindow('isModal')) {
                        return false;
                    }
                }
            }
            return true;
        },

        //This method is constructing the window from two type's of structures.
        //The first one is containing two divs. The first one is window's host and contain 'caption' attribute. The second
        //div is window's content.
        //The second one is containing three divs. The first one is representing the window. Second one (first inner)
        //window's header and the third one window's content.
        _createStructure: function () {
            var children = this.host.children('DIV');
            if (children.length === 1) {
                this._header = $('<div>' + this.host.attr('caption') + '</div>');
                this.host.prepend(this._header);
                this.host.attr('caption', '');
                this._content = $(children[0]);
            } else if (children.length === 2) {
                this._header = $(children[0]);
                this._content = $(children[1]);
            } else {
                throw new Error('Invalid structure!');
            }
        },

        _refresh: function () {
            this._render();
            this._addStyles();
            this._performLayout();
            this._removeEventHandlers();
            this._addEventHandlers();
            this._initializeResize();
        },

        _render: function () {
            this._addHeaderWrapper();
            this._addCloseButton();
            this._addCollapseButton();
            this._removeModal();
            this._makeModal();
        },

        _addHeaderWrapper: function () {
            if (!this._headerContentWrapper) {
                this._header.wrapInner('<div style="float:left;"></div>');
                this._headerContentWrapper = this._header.children(0);
                if (this.headerHeight !== null) {
                    this._header.height(this.headerHeight);
                }
            }
        },

        _addCloseButton: function () {
            if (!this._closeButton) {
                // the wrapper's purpose is to be a background of the close button's image.  
                this._closeButtonWrapper = $('<div class="' + this.toThemeProperty('jqx-window-close-button-background') + '"></div>');
                this._closeButton = $('<div style="width: 100%; height: 100%;" class="' + this.toThemeProperty('jqx-window-close-button') + '"></div>');
                this._closeButtonWrapper.append(this._closeButton);
                this._header.append(this._closeButtonWrapper);
            }
        },

        _addCollapseButton: function () {
            if (!this._collapseButton) {
                // the wrapper's purpose is to be a background of the close button's image.  
                this._collapseButtonWrapper = $('<div class="' + this.toThemeProperty('jqx-window-collapse-button-background') + '"></div>');
                this._collapseButton = $('<div style="width: 100%; height: 100%;" class="' + this.toThemeProperty('jqx-window-collapse-button') + '"></div>');
                this._collapseButtonWrapper.append(this._collapseButton);
                this._header.append(this._collapseButtonWrapper);
            }
        },

        _removeModal: function () {
            if (!this.isModal && typeof this._modalBackground === 'object' &&
                this._modalBackground !== null && this._modalBackground.length >= 1) {
                $('.' + this.toThemeProperty('jqx-window-modal')).remove();
                this._modalBackground = null;
            }
        },

        focus: function () {
            try {
                this.host.focus();
                var me = this;
                setTimeout(function () {
                    me.host.focus();
                }, 10);
            }
            catch (error) {
            }
        },

        _makeModal: function () {
            if (this.isModal && (!this._modalBackground || this._modalBackground.length < 1)) {
                var windows = $.data(document.body, 'jqxwindows-list');
                if (windows) {
                    this._removeFromArray(this.host, windows);
                    $.data(document.body, 'jqxwindows-list', windows);
                }
                this._modalBackground = $('<div></div>');
                this._modalBackground.addClass(this.toThemeProperty('jqx-window-modal'));
                this._setModalBackgroundStyles();
                $(document.body).append(this._modalBackground);
                this.addHandler(this._modalBackground, this._getEvent('click'), function () {
                    return false;
                });
                var me = this;
                var ischildof = function (element, filter_string) {
                    var parents = $(element).parents().get();

                    for (j = 0; j < parents.length; j++) {
                        if ($(parents[j]).is(filter_string)) {
                            return true;
                        }
                    }

                    return false;
                }

                this.addHandler(this._modalBackground, 'mouseup', function (event) {
                    me._stopResizing(me);
                    event.preventDefault();
                    //     return false;
                });
                this.addHandler(this._modalBackground, 'mousedown', function (event) {
                    var tabbables = me._getTabbables();
                    if (tabbables.length > 0) {
                        tabbables[0].focus(1);
                        setTimeout(function () {
                            tabbables[0].focus(1);
                        }, 100);
                    }

                    event.preventDefault();
                    return false;
                });

                this.addHandler($(document), 'keydown.window' + this.element.id, function (event) {
                    if (event.keyCode !== 9) {
                        return;
                    }

                    var tabbables = me._getTabbables();
                    var first = null;
                    var last = null;

                    if (tabbables.length > 0) {
                        first = tabbables[0];
                        last = tabbables[tabbables.length - 1];
                    }

                    if (event.target == me.element)
                        return;

                    if (first == null)
                        return;

                    if (!ischildof(event.target, me.host)) {
                        first.focus(1);
                        return false;
                    }

                    if (event.target === last && !event.shiftKey) {
                        first.focus(1);
                        return false;
                    } else if (event.target === first && event.shiftKey) {
                        last.focus(1);
                        return false;
                    }
                });
            }
        },

        _addStyles: function () {
            this.host.addClass(this.toThemeProperty('jqx-rc-all'));
            this.host.addClass(this.toThemeProperty('jqx-window'));
            this.host.addClass(this.toThemeProperty('jqx-popup'));
            if ($.jqx.browser.msie) {
                this.host.addClass(this.toThemeProperty('jqx-noshadow'));
            }
            this.host.addClass(this.toThemeProperty('jqx-widget'));
            this.host.addClass(this.toThemeProperty('jqx-widget-content'));
            this._header.addClass(this.toThemeProperty('jqx-window-header'));
            this._content.addClass(this.toThemeProperty('jqx-window-content'));
            this._header.addClass(this.toThemeProperty('jqx-widget-header'));
            this._content.addClass(this.toThemeProperty('jqx-widget-content'));
            this._header.addClass(this.toThemeProperty('jqx-disableselect'));
            this._header.addClass(this.toThemeProperty('jqx-rc-t'));
            this._content.addClass(this.toThemeProperty('jqx-rc-b'));
            this.element.tabIndex = 0;
            this.host.find('DIV').css('tab-index', 0);
            this.host.attr("hideFocus", "true").css("outline", "none");
        },

        _performHeaderLayout: function () {
            this._handleHeaderButtons();
            this._header.css('position', 'relative');
            if (this.rtl) {
                this._headerContentWrapper.css('direction', 'rtl');
                this._headerContentWrapper.css('float', 'right');
            }
            else {
                this._headerContentWrapper.css('direction', 'ltr');
                this._headerContentWrapper.css('float', 'left');
            }

            this._performHeaderCloseButtonLayout();
            this._performHeaderCollapseButtonLayout();

            this._centerElement(this._headerContentWrapper, this._header, 'y', 'margin');
            if (this.headerHeight) {
                this._centerElement(this._closeButtonWrapper, this._header, 'y', 'margin');
                this._centerElement(this._collapseButtonWrapper, this._header, 'y', 'margin');
            }
        },

        _handleHeaderButtons: function () {
            if (!this._closeButtonWrapper) return;

            if (!this.showCloseButton) {
                this._closeButtonWrapper.css('visibility', 'hidden');
            } else {
                this._closeButtonWrapper.css('visibility', 'visible');
                this._closeButtonWrapper.width(this.closeButtonSize);
                this._closeButtonWrapper.height(this.closeButtonSize);
            }
            if (!this.showCollapseButton) {
                this._collapseButtonWrapper.css('visibility', 'hidden');
            } else {
                this._collapseButtonWrapper.css('visibility', 'visible');
                this._collapseButtonWrapper.width(this.collapseButtonSize);
                this._collapseButtonWrapper.height(this.collapseButtonSize);
            }
        },

        _performHeaderCloseButtonLayout: function () {
            if (!this._closeButtonWrapper) return;

            var paddingRight = parseInt(this._header.css('padding-right'), 10);
            if (!isNaN(paddingRight)) {
                this._closeButtonWrapper.width(this._closeButton.width());
                if (!this.rtl) {
                    this._closeButtonWrapper.css('margin-right', paddingRight);
                    this._closeButtonWrapper.css('margin-left', '0px');
                }
                else {
                    this._closeButtonWrapper.css('margin-left', paddingRight);
                    this._closeButtonWrapper.css('margin-right', '0px');
                }
            }
            if (!this.rtl) {
                this._closeButtonWrapper.css({
                    'position': 'absolute',
                    'right': '0px',
                    'left': ''
                });
            }
            else {
                this._closeButtonWrapper.css({
                    'position': 'absolute',
                    'left': '0px',
                    'right': ''
                });
            }
        },

        _performHeaderCollapseButtonLayout: function () {
            if (!this._closeButtonWrapper) return;
            var paddingRight = parseInt(this._header.css('padding-right'), 10);
            if (!isNaN(paddingRight)) {
                this._collapseButtonWrapper.width(this.collapseButtonSize);
                this._collapseButtonWrapper.height(this.collapseButtonSize);
                if (!this.rtl) {
                    this._collapseButtonWrapper.css('margin-right', paddingRight);
                    this._collapseButtonWrapper.css('margin-left', '0px');
                }
                else {
                    this._collapseButtonWrapper.css('margin-left', paddingRight);
                    this._collapseButtonWrapper.css('margin-right', '0px');
                }
            }
            if (!this.rtl) {
                this._collapseButtonWrapper.css({
                    'position': 'absolute',
                    'right': (this.showCloseButton) ? this._closeButton.outerWidth(true) : 0,
                    'left': ''
                });
            }
            else {
                this._collapseButtonWrapper.css({
                    'position': 'absolute',
                    'left': (this.showCloseButton) ? this._closeButton.outerWidth(true) : 0,
                    'right': ''
                });
            }

            this._centerElement(this._collapseButton, this._collapseButton.parent(), 'y');
        },

        _performWidgetLayout: function () {
            var isValid;
            if (this.width !== 'auto') {
                this.host.css('width', this.width);
            }
            if (!this.collapsed) {
                if (this.height !== 'auto') {
                    this.host.height(this.height);
                } else {
                    this.host.height(this.host.height());
                }
                this.host.css('min-height', this.minHeight);
            }
            this._setChildrenLayout();
            isValid = this._validateMinSize();
            this.host.css({
                'max-height': this.maxHeight,
                'min-width': this.minWidth,
                'max-width': this.maxWidth
            });
            if (!isValid) {
                this._setChildrenLayout();
            }
        },

        _setChildrenLayout: function () {
            this._header.width(this.host.width() - (this._header.outerWidth(true) - this._header.width()));
            this._content.width(this.host.width() - (this._content.outerWidth(true) - this._content.width()));
            this._content.height(this.host.height() - this._header.outerHeight(true) - (this._content.outerHeight(true) - this._content.height()));
        },

        _validateMinSize: function () {
            var returnValue = true;
            if (this.minHeight < this._header.height()) {
                this.minHeight = this._header.height();
                returnValue = false;
            }
            var headerContentWidth = this._header.children(0).outerWidth(true),
                closeButtonWidth = this._header.children(1).outerWidth(true),
                headerInnerWidth = headerContentWidth + closeButtonWidth;
            if (this.minWidth < 100) {
                this.minWidth = Math.min(headerInnerWidth, 100);
                returnValue = false;
            }
            return returnValue;
        },

        _centerElement: function (child, parent, axis, attribute) {
            if (typeof parent.left === 'number' && typeof parent.top === 'number' &&
                typeof parent.height === 'number' && typeof parent.width === 'number') {
                this._centerElementInArea(child, parent, axis);
            } else {
                this._centerElementInParent(child, parent, axis, attribute);
            }
        },

        _centerElementInParent: function (child, parent, axis, attribute) {
            axis = axis.toLowerCase();
            if (attribute) {
                attribute += '-';
            } else {
                attribute = '';
            }
            if (axis.indexOf('y') >= 0) {
                var childHeight = child.outerHeight(true),
                    parentHeight = parent.height(),
                    verticalDisplacement = (Math.max(0, parentHeight - childHeight)) / 2;
                child.css(attribute + 'top', verticalDisplacement + 'px');
            }
            if (axis.indexOf('x') >= 0) {
                var childWidth = child.outerWidth(true);
                var parentWidth = parent.width();
                var horizontalDisplacement = (Math.max(0, parentWidth - childWidth)) / 2;
                child.css(attribute + 'left', horizontalDisplacement + 'px');
            }
        },

        _centerElementInArea: function (child, area, axis) {
            axis = axis.toLowerCase();
            if (axis.indexOf('y') >= 0) {
                var childHeight = child.outerHeight(true);
                var parentHeight = area.height;
                var verticalDisplacement = (parentHeight - childHeight) / 2;
                child.css('top', verticalDisplacement + area.top + 'px');
            }
            if (axis.indexOf('x') >= 0) {
                var childWidth = child.outerWidth(true);
                var parentWidth = area.width;
                var horizontalDisplacement = (parentWidth - childWidth) / 2;
                child.css('left', horizontalDisplacement + area.left + 'px');
            }
        },

        _removeEventHandlers: function () {
            this.removeHandler(this._header, this._getEvent('mousedown'));
            this.removeHandler(this._header, this._getEvent('mousemove'));
            this.removeHandler(this._header, 'focus');
            this.removeHandler($(document), this._getEvent('mousemove') + '.' + this.host.attr('id'));
            this.removeHandler($(document), this._getEvent('mouseup') + '.' + this.host.attr('id'));
            this.removeHandler(this.host, 'keydown');
            this.removeHandler(this._closeButton, this._getEvent('click'));
            this.removeHandler(this._closeButton, this._getEvent('mouseenter'));
            this.removeHandler(this._closeButton, this._getEvent('mouseleave'));
            this.removeHandler(this._collapseButton, this._getEvent('click'));
            this.removeHandler(this._collapseButton, this._getEvent('mouseenter'));
            this.removeHandler(this._collapseButton, this._getEvent('mouseleave'));
            this.removeHandler(this.host, this._getEvent('mousedown'));
            this.removeHandler($(this.okButton), this._getEvent('click'), this._setDialogResultHandler);
            this.removeHandler($(this.cancelButton), this._getEvent('click'), this._setDialogResultHandler);
            this.removeHandler(this._header, this._getEvent('mouseenter'));
            this.removeHandler(this._header, this._getEvent('mouseleave'));
            this.removeHandler(this.host, 'resizing', this._windowResizeHandler);
        },

        _removeFromArray: function (element, array) {
            var indexOfElement = this._indexOf(element, array);
            if (indexOfElement >= 0) {
                return array.splice(this._indexOf(element, array), 1);
            } else {
                return array;
            }
        },

        _sortByStyle: function (attr, collection) {
            for (var i = 0; i < collection.length; i++) {
                for (var j = collection.length - 1; j > i; j--) {
                    var itemOne = collection[j], itemTwo = collection[j - 1], tmp;
                    if (parseInt(itemOne.css(attr), 10) < parseInt(itemTwo.css(attr), 10)) {
                        tmp = itemOne;
                        collection[j] = itemTwo;
                        collection[j - 1] = tmp;
                    }
                }
            }
        },

        _initializeResize: function () {
            if (this.resizable) {
                var self = this;
                this.initResize({
                    target: this.host,
                    alsoResize: self._content,
                    maxWidth: self.maxWidth,
                    minWidth: self.minWidth,
                    maxHeight: self.maxHeight,
                    minHeight: self.minHeight,
                    indicatorSize: 10,
                    resizeParent: self.dragArea
                });
            }
        },

        _removeResize: function () {
            this.removeResize();
        },

        _getEvent: function (event) {
            if (this._isTouchDevice) {
                return this._touchEvents[event];
            } else {
                return event;
            }
        },

        _addEventHandlers: function () {
            this._addDragDropHandlers();
            this._addCloseHandlers();
            this._addCollapseHandlers();
            this._addFocusHandlers();
            this._documentResizeHandlers();
            this._closeButtonHover();
            this._collapseButtonHover();
            this._addDialogButtonsHandlers();
            this._addHeaderHoverEffect();
            this._addResizeHandlers();
            var me = this;
            this.addHandler(this._header, this._getEvent('mousemove'), function (event) {
                me._addHeaderCursorHandlers(me);
            }
            );
        },

        _addResizeHandlers: function () {
            var self = this;
            this.addHandler(this.host, 'resizing', this._windowResizeHandler, { self: this });
        },

        _windowResizeHandler: function (event) {
            var self = event.data.self;
            self._header.width(self.host.width() - (self._header.outerWidth(true) - self._header.width()));
            self.width = event.args.width;
            self.height = event.args.height;
        },

        _addHeaderHoverEffect: function () {
            var self = this;
            this.addHandler(this._header, this._getEvent('mouseenter'), function () {
                $(this).addClass(self.toThemeProperty('jqx-window-header-hover'));
            });
            this.addHandler(this._header, this._getEvent('mouseleave'), function () {
                $(this).removeClass(self.toThemeProperty('jqx-window-header-hover'));
            });
        },

        _addDialogButtonsHandlers: function () {
            if (this.okButton) {
                this.addHandler($(this.okButton), this._getEvent('click'), this._setDialogResultHandler, { self: this, result: 'ok' });
            }
            if (this.cancelButton) {
                this.addHandler($(this.cancelButton), this._getEvent('click'), this._setDialogResultHandler, { self: this, result: 'cancel' });
            }
        },

        _documentResizeHandlers: function () {
            var self = this;
            if (this.isModal) {
                $(window).resize(function () {
                    if (typeof self._modalBackground === 'object' && self._modalBackground !== null) {
                        if (self.isOpen()) {
                            self._modalBackground.hide();
                        }
                        if (!self.restricter) {
                            self._modalBackground.width(self._getDocumentSize().width);
                            self._modalBackground.height(self._getDocumentSize().height);
                        }
                        else {
                            self._modalBackground.css('left', self.dragArea.left);
                            self._modalBackground.css('top', self.dragArea.top);
                            self._modalBackground.width(self.dragArea.width);
                            self._modalBackground.height(self.dragArea.height);
                        }

                        if (self.isOpen()) {
                            self._modalBackground.show();
                        }
                    }
                });
            }
        },

        _setDialogResultHandler: function (event) {
            var self = event.data.self;
            self._setDialogResult(event.data.result);
            self.closeWindow();
        },

        _setDialogResult: function (result) {
            this.dialogResult.OK = false;
            this.dialogResult.None = false;
            this.dialogResult.Cancel = false;
            result = result.toLowerCase();
            switch (result) {
                case 'ok':
                    this.dialogResult.OK = true;
                    break;
                case 'cancel':
                    this.dialogResult.Cancel = true;
                    break;
                default:
                    this.dialogResult.None = true;
            }
        },

        _getDocumentSize: function () {
            var isIEBefore9 = $.jqx.browser.msie && $.jqx.browser.version < 9;
            var scrollTop = isIEBefore9 ? 4 : 0;
            var scrollLeft = scrollTop;
            if (document.body.scrollHeight > document.body.clientHeight && isIEBefore9) {
                scrollTop = this._SCROLL_WIDTH;
            }
            if (document.body.scrollWidth > document.body.clientWidth && isIEBefore9) {
                scrollLeft = this._SCROLL_WIDTH;
            }
            return { width: $(document).width() - scrollTop, height: $(document).height() - scrollLeft };
        },

        _closeButtonHover: function () {
            var self = this;
            this.addHandler(this._closeButton, this._getEvent('mouseenter'), function () {
                self._closeButton.addClass(self.toThemeProperty('jqx-window-close-button-hover'));
            });
            this.addHandler(this._closeButton, this._getEvent('mouseleave'), function () {
                self._closeButton.removeClass(self.toThemeProperty('jqx-window-close-button-hover'));
            });
        },

        _collapseButtonHover: function () {
            var self = this;
            this.addHandler(this._collapseButton, this._getEvent('mouseenter'), function () {
                self._collapseButton.addClass(self.toThemeProperty('jqx-window-collapse-button-hover'));
            });
            this.addHandler(this._collapseButton, this._getEvent('mouseleave'), function () {
                self._collapseButton.removeClass(self.toThemeProperty('jqx-window-collapse-button-hover'));
            });
        },

        _setModalBackgroundStyles: function () {
            if (this.isModal) {
                this._modalBackground.fadeTo(0, this.modalOpacity);
                this._modalBackground.css({
                    'position': 'absolute',
                    'top': '0px',
                    'left': '0px',
                    'width': this._getDocumentSize().width,
                    'height': this._getDocumentSize().height,
                    'z-index': this.modalBackgroundZIndex
                });
                if (!this.autoOpen) {
                    this._modalBackground.css('display', 'none');
                }
            }
        },

        _addFocusHandlers: function () {
            var self = this;
            this.addHandler(this.host, this._getEvent('mousedown'), function () {
                if (!self.isModal) {
                    self.bringToFront();
                }
            });
        },

        _indexOf: function (host, collection) {
            for (var i = 0; i < collection.length; i++) {
                if (collection[i][0] === host[0]) {
                    return i;
                }
            }
            return -1;
        },

        _addCloseHandlers: function () {
            var self = this;
            this.addHandler(this._closeButton, this._getEvent('click'), function (event) {
                return self._closeWindow(event);
            }
            );
            if (this.keyboardCloseKey !== 'none') {
                if (typeof this.keyboardCloseKey !== 'number' && this.keyboardCloseKey.toLowerCase() === 'esc') {
                    this.keyboardCloseKey = 27;
                }
            }
            this.addHandler(this.host, 'keydown', function (event) {
                if (event.keyCode === self.keyboardCloseKey && self.keyboardCloseKey != null && self.keyboardCloseKey != 'none') {
                    self._closeWindow(event);
                }
                else self._handleKeys(event);
            }, { self: this });

            this.addHandler(this.host, 'keyup', function (event) {
                if (!self.keyboardNavigation) return;

                if (self._moved) {
                    var offset = self.host.coord();
                    var left = offset.left;
                    var top = offset.top;
                    self._raiseEvent(3, left, top, left, top);
                    self._moved = false;
                }
            });
        },

        _handleKeys: function (event) {
            if (!this.keyboardNavigation) return;
            if (!this._headerFocused) return;

            var ctrl = event.ctrlKey;
            var key = event.keyCode;
            var offset = this.host.coord();
            var left = offset.left;
            var top = offset.top;
            var area = this._getDraggingArea();
            var width = this.host.width();
            var height = this.host.height();
            var result = true;
            var step = 10;

            switch (key) {
                case 37:
                    if (!ctrl) {
                        if (this.draggable) {
                            if (left - step >= 0) {
                                this.move(left - step, top);
                            }
                        }
                    }
                    else {
                        if (this.resizable) {
                            this.resize(width - step, height);
                        }
                    }
                    result = false;
                    break;
                case 38:
                    if (!ctrl) {
                        if (this.draggable) {
                            if (top - step >= 0) {
                                this.move(left, top - step);
                            }
                        }
                    }
                    else {
                        if (this.resizable) {
                            this.resize(width, height - step);
                        }
                    }
                    result = false;
                    break;
                case 39:
                    if (!ctrl) {
                        if (this.draggable) {
                            if (left + width + step <= area.width) {
                                this.move(left + step, top);
                            }
                        }
                    }
                    else {
                        if (this.resizable) {
                            this.resize(width + step, height);
                        }
                    }
                    result = false;
                    break;
                case 40:
                    if (!ctrl) {
                        if (this.draggable) {
                            if (top + height + step <= area.height) {
                                this.move(left, top + step);
                            }
                        }
                    }
                    else {
                        if (this.resizable) {
                            this.resize(width, height + step);
                        }
                    }
                    result = false;
                    break;
            }
            if (!result) {
                if (event.preventDefault) event.preventDefault();
                if (event.stopPropagation) event.stopPropagation();
            }

            return result;
        },

        _addCollapseHandlers: function () {
            var self = this;
            this.addHandler(this._collapseButton, this._getEvent('click'), function () {
                if (!self.collapsed) {
                    self.collapse();
                } else {
                    self.expand();
                }
            });
        },

        _closeWindow: function (event) {
            this.closeWindow();
            return false;
        },

        _addHeaderCursorHandlers: function (self) {
            if (self.resizeArea && self.resizable) {
                self._header.css('cursor', self._resizeWrapper.css('cursor'));
                return;
            } else if (self.draggable) {
                self._header.css('cursor', 'move');
                return;
            }
            self._header.css('cursor', 'default');
            if (self._resizeWrapper && self._resizeWrapper.length > 0) {
                self._resizeWrapper.css('cursor', 'default')
            }
        },

        _addDragDropHandlers: function () {
            if (this.draggable) {
                var self = this;
                this.addHandler(this.host, 'focus', function () {
                    self._headerFocused = true;
                });

                this.addHandler(this.host, 'blur', function () {
                    self._headerFocused = false;
                });

                this.addHandler(this._header, 'focus', function () {
                    self._headerFocused = true;
                    return false;
                });

                this.addHandler(this._header, this._getEvent('mousedown'), function (event) {
                    self._headerMouseDownHandler(self, event);
                    return true;
                });

                this.addHandler(this._header, 'dragstart', function (event) {
                    if (event.preventDefault) {
                        event.preventDefault();
                    }
                    return false;
                });

                this.addHandler(this._header, this._getEvent('mousemove'), function (event) {
                    return self._headerMouseMoveHandler(self, event);
                });

                this.addHandler($(document), this._getEvent('mousemove') + '.' + this.host.attr('id'), function (event) {
                    return self._dragHandler(self, event);
                });
                this.addHandler($(document), this._getEvent('mouseup') + '.' + this.host.attr('id'), function (event) {
                    return self._dropHandler(self, event);
                });

                try {
                    if (document.referrer != "" || window.frameElement) {
                        var parentLocation = null;
                        if (window.top != null && window.top != window.self) {
                            if (window.parent && document.referrer) {
                                parentLocation = document.referrer;
                            }
                        }

                        if (parentLocation && parentLocation.indexOf(document.location.host) != -1) {
                            var eventHandle = function (event) {
                                self._dropHandler(self, event);
                            };

                            if (window.top.document.addEventListener) {
                                window.top.document.addEventListener('mouseup', eventHandle, false);

                            } else if (window.top.document.attachEvent) {
                                window.top.document.attachEvent("on" + 'mouseup', eventHandle);
                            }
                        }
                    }
                }
                catch (error) {
                }
            }
        },

        _headerMouseDownHandler: function (self, event) {
            if (!self.isModal) {
                self.bringToFront();
            }
            if (self._resizeDirection == null) {
                var touches = $.jqx.mobile.getTouches(event);
                var touch = touches[0];
                var position = $.jqx.position(event);
                self._mousePosition.x = position.left;
                self._mousePosition.y = position.top;
                self._mouseDown = true;
                self._isDragging = false;
            }
        },

        _headerMouseMoveHandler: function (self, event) {
            if (self._mouseDown && !self._isDragging) {
                var touches = $.jqx.mobile.getTouches(event);
                var touch = touches[0];

                var pageX = touch.pageX,
                    pageY = touch.pageY;
                var position = $.jqx.position(event);
                pageX = position.left;
                pageY = position.top;

                if ((pageX + 3 < self._mousePosition.x || pageX - 3 > self._mousePosition.x) ||
                    (pageY + 3 < self._mousePosition.y || pageY - 3 > self._mousePosition.y)) {
                    self._isDragging = true;
                    self._mousePosition = { x: pageX, y: pageY };
                    //self._windowPosition = { x: parseInt(self.host.css('left'), 10), y: parseInt(self.host.css('top'), 10) };
                    self._windowPosition = { x: self.host.coord().left, y: self.host.coord().top };
                    $(document.body).addClass(self.toThemeProperty('jqx-disableselect'));
                }
                if (self._isTouchDevice) {
                    event.preventDefault();
                    return true;
                }
                return false;
            }
            if (self._isDragging) {
                if (self._isTouchDevice) {
                    event.preventDefault();
                    return true;
                }
                return false;
            }
            return true;
        },

        _dropHandler: function (self, event) {
            var result = true;
            if (self._isDragging && !self.isResizing && !self._resizeDirection) {
                var x = parseInt(self.host.css('left'), 10),
                    y = parseInt(self.host.css('top'), 10),
                    pageX = (self._isTouchDevice) ? 0 : event.pageX,
                    pageY = (self._isTouchDevice) ? 0 : event.pageY;
                self.enableResize = self._enableResizeBackup;
                self._enableResizeBackup = 'undefined';
                self._raiseEvent(3, x, y, pageX, pageY);
                result = false;

                if (event.preventDefault != 'undefined') {
                    event.preventDefault();
                }

                if (event.originalEvent != null) {
                    event.originalEvent.mouseHandled = true;
                }

                if (event.stopPropagation != 'undefined') {
                    event.stopPropagation();
                }
            }
            self._isDragging = false;
            self._mouseDown = false;
            $(document.body).removeClass(self.toThemeProperty('jqx-disableselect'));
            return result;
        },

        _dragHandler: function (self, event) {
            if (self._isDragging && !self.isResizing && !self._resizeDirection) {
                var eventWhich = (self._isTouchDevice) ? event.originalEvent.which : event.which;
                if (typeof self._enableResizeBackup === 'undefined') {
                    self._enableResizeBackup = self.enableResize;
                }
                self.enableResize = false;
                if (eventWhich === 0 && $.jqx.browser.msie && $.jqx.browser.version < 8) {
                    return self._dropHandler(self, event);
                }
                var touches = $.jqx.mobile.getTouches(event);
                var touch = touches[0];
                var position = $.jqx.position(event);

                var pageX = position.left,
                    pageY = position.top,
                    displacementX = pageX - self._mousePosition.x,
                    displacementY = pageY - self._mousePosition.y,
                    newX = self._windowPosition.x + displacementX,
                    newY = self._windowPosition.y + displacementY;
                self.move(newX, newY, event);
                event.preventDefault();
                return false;
            }
            return true;
        },

        _validateCoordinates: function (x, y, scrollTop, scrollLeft) {
            var dragArea = this._getDraggingArea();
            x = (x < dragArea.left) ? dragArea.left : x;
            y = (y < dragArea.top) ? dragArea.top : y;
            var hostwidth = this.host.outerWidth(true);
            var hostheight = this.host.outerHeight(true);
            if (x + hostwidth >= dragArea.width + dragArea.left - 2 * scrollLeft) {
                x = dragArea.width + dragArea.left - hostwidth - scrollLeft;
            }
            if (y + hostheight >= dragArea.height + dragArea.top - scrollTop) {
                y = dragArea.height + dragArea.top - hostheight - scrollTop;
            }
            return { x: x, y: y };
        },

        _performLayout: function () {
            this._performHeaderLayout();
            this._performWidgetLayout();
        },

        _parseDragAreaAttributes: function () {
            if (this.dragArea !== null) {
                this.dragArea.height = parseInt(this.dragArea.height, 10);
                this.dragArea.width = parseInt(this.dragArea.width, 10);
                this.dragArea.top = parseInt(this.dragArea.top, 10);
                this.dragArea.left = parseInt(this.dragArea.left, 10);
            }
        },

        _positionWindow: function () {
            this._parseDragAreaAttributes();
            if (this.position instanceof Array && this.position.length === 2 &&
                typeof this.position[0] === 'number' &&
                typeof this.position[1] === 'number') {
                this.host.css({
                    'left': this.position[0],
                    'top': this.position[1]
                });
            } else if (this.position instanceof Object && this.position.x !== 'undefined' && this.position.y != 'undefined') {
                if (this.position.left) {
                    this.host.offset(this.position);
                }
                else {
                    this.host.css({
                        'left': this.position.x,
                        'top': this.position.y
                    });
                }
            } else {
                this._positionFromLiteral();
            }
        },

        _getDraggingArea: function () {
            var draggingArea = {};
            draggingArea.left = ((this.dragArea && this.dragArea.left) ? this.dragArea.left : 0);
            draggingArea.top = ((this.dragArea && this.dragArea.top) ? this.dragArea.top : 0);
            draggingArea.width = ((this.dragArea && this.dragArea.width) ? this.dragArea.width : this._getDocumentSize().width);
            draggingArea.height = ((this.dragArea && this.dragArea.height) ? this.dragArea.height : this._getDocumentSize().height);
            return draggingArea;
        },

        _positionFromLiteral: function () {
            if (!(this.position instanceof Array)) {
                this.position = this.position.split(',');
            }
            var count = this.position.length, dragArea = this._getDraggingArea();
            while (count) {
                count -= 1;
                this.position[count] = this.position[count].replace(/ /g, '');
                switch (this.position[count]) {
                    case 'top':
                        this.host.css('top', dragArea.top);
                        break;
                    case 'left':
                        this.host.css('left', dragArea.left);
                        break;
                    case 'bottom':
                        this.host.css('top', dragArea.height - this.host.height() + dragArea.top);
                        break;
                    case 'right':
                        this.host.css('left', dragArea.left + dragArea.width - this.host.width());
                        break;
                    default:
                        if (!this.dragArea) dragArea = $(window);
                        this._centerElement(this.host, dragArea, 'xy');
                        break;
                }
            }
        },

        _raiseEvent: function (eventId) {
            var eventType = this._events[eventId], event = $.Event(eventType), args = {};
            if (eventId === 2 || eventId === 3) {
                args.x = arguments[1];
                args.y = arguments[2];
                args.pageX = arguments[3];
                args.pageY = arguments[4];
            }
            if (eventType === 'closed' || eventType === 'close') {
                args.dialogResult = this.dialogResult;
            }
            event.args = args;
            return this.host.trigger(event);
        },

        destroy: function () {
            this._removeEventHandlers();
            this._destroy();
        },

        _destroy: function () {
            if (this.restricter) {
                this.removeHandler($(window), 'resize.' + this.element.id);
                this.removeHandler($(window), 'orientationchanged.' + this.element.id);
                this.removeHandler($(window), 'orientationchange.' + this.element.id);
            }
            this.host.remove();
            if (this._modalBackground !== null) {
                this._modalBackground.remove();
            }
        },

        _toClose: function (closeCurrent, target) {
            return ((closeCurrent && target[0] === this.element) ||
                (target[0] !== this.element && typeof target[0] === 'object'));
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            this._validateProperties();
            switch (key) {
                case 'rtl':
                    this._performLayout();
                    break;
                case 'dragArea':
                    this._positionWindow();
                    break;
                case 'collapseButtonSize':
                    this._performLayout();
                    break;
                case 'closeButtonSize':
                    this._performLayout();
                    break;
                case 'isModal':
                    this._refresh();
                    this._fixWindowZIndex();
                    break;
                case 'keyboardCloseKey':
                    this._removeEventHandlers();
                    this._addEventHandlers();
                    break;
                case 'disabled':
                    if (value) {
                        this.disable();
                    } else {
                        this.disabled = true;
                        this.enable();
                    }
                    break;
                case 'showCloseButton':
                case 'showCollapseButton':
                    this._performLayout();
                    break;
                case 'height':
                    this._performLayout();
                    break;
                case 'width':
                    this._performLayout();
                    break;
                case 'title':
                    this.setTitle(value);
                    this.title = value;
                    break;
                case 'content':
                    this.setContent(value);
                    break;
                case 'draggable':
                    this._removeEventHandlers();
                    this._addEventHandlers();
                    this._initializeResize();
                    break;
                case 'resizable':
                    this.enableResize = value;
                    if (this.collapsed && value) {
                        this.resizable = oldvalue;
                    }
                    else {
                        if (value) {
                            this._initializeResize();
                        } else {
                            this._removeResize();
                        }
                    }
                    break;
                case 'position':
                    this._positionWindow();
                    break;
                case 'modalOpacity':
                    this._setModalBackgroundStyles();
                    break;
                case 'okButton':
                    if (value) {
                        this._addDialogButtonsHandlers();
                    } else {
                        this.removeHandler(this.okButton);
                    }
                    break;
                case 'cancelButton':
                    if (value) {
                        this._addDialogButtonsHandlers();
                    } else {
                        this.removeHandler(this.cancelButton);
                    }
                    break;
                case 'collapsed':
                    if (value) {
                        if (!oldvalue) {
                            this.collapsed = false;
                            this.collapse(0);
                        }
                    } else {
                        if (oldvalue) {
                            this.collapsed = true;
                            this.expand(0);
                        }
                    }
                case 'theme':
                    $.jqx.utilities.setTheme(oldvalue, value, this.host);
                    break;
                case 'enableResize':
                    return;
                default:
                    return;
            }
        },

        collapse: function (duration) {
            if (!this.collapsed && !this.host.is(':animated')) {
                if (this.host.css('display') == "none")
                    return;

                if (this.enableResize) {
                    this._enableResizeCollapseBackup = true;
                    this.enableResize = false;
                }

                var self = this,
                    collapseHeight = this._header.outerHeight(true),
                    bottomBorder = parseInt(this._header.css('border-bottom-width'), 10),
                    bottomMargin = parseInt(this._header.css('margin-bottom'), 10),
                    duration = !isNaN(parseInt(duration)) ? duration : this.collapseAnimationDuration;
                if (!isNaN(bottomBorder)) {
                    collapseHeight -= 2 * bottomBorder;
                }
                if (!isNaN(bottomMargin)) {
                    collapseHeight += bottomMargin;
                }
                this._heightBeforeCollapse = this.host.height();
                this._minHeightBeforeCollapse = this.host.css('min-height');
                this.host.css('min-height', collapseHeight);
                this.host.animate({ height: collapseHeight }, duration, function () {
                    self.collapsed = true;
                    self._collapseButton.addClass(self.toThemeProperty('jqx-window-collapse-button-collapsed'));
                    self._content.css('display', 'none');
                    self._raiseEvent(5);
                    self._raiseEvent(9);
                    $.jqx.aria(self, "aria-expanded", false);
                });
            }
        },

        expand: function (duration) {
            if (this.collapsed && !this.host.is(':animated')) {

                var self = this,
                    duration = !isNaN(parseInt(duration)) ? duration : this.collapseAnimationDuration;
                this.host.animate({ 'height': this._heightBeforeCollapse }, duration, function () {
                    self.collapsed = false;
                    self.host.css('min-height', self._minHeightBeforeCollapse);
                    self._collapseButton.removeClass(self.toThemeProperty('jqx-window-collapse-button-collapsed'));
                    if (self._enableResizeCollapseBackup) {
                        self.enableResize = true;
                    }
                    self._content.css('display', 'block');
                    self._raiseEvent(6);
                    self._performWidgetLayout();
                    self._raiseEvent(9);
                    $.jqx.aria(self, "aria-expanded", true);
                });
            }
        },

        //Closing all open windows which are not modal
        closeAll: function (closeCurrent) {
            var closeCurrent = true;
            var windows = $.data(document.body, 'jqxwindows-list'),
                count = windows.length, modal = $.data(document.body, 'jqxwindow-modal') || [];
            while (count) {
                count -= 1;
                if (this._toClose(closeCurrent, windows[count])) {
                    windows[count].jqxWindow('closeWindow', 'close');
                    windows.splice(count, 1);
                }
            }
            if (this._toClose(closeCurrent, modal)) {
                modal.jqxWindow('closeWindow', 'close');
                $.data(document.body, 'jqxwindow-modal', [])
            }
            $.data(document.body, 'jqxwindows-list', windows);
        },

        //Setting window's title
        setTitle: function (title) {
            $.jqx.utilities.html(this._headerContentWrapper, title);
            this.title = title;
            this._performLayout();
        },

        //Setting window's content
        setContent: function (content) {
            this._contentInitialized = false;

            var parent = this._content,
                finished = false;
            while (!finished) {
                parent.css('height', 'auto');
                parent.css('width', 'auto');
                if (parent.is('.jqx-window')) {
                    finished = true;
                } else {
                    parent = parent.parent();
                }
            }
            $.jqx.utilities.html(this._content, content);
            this._performLayout();
        },

        //Disabling the window
        disable: function () {
            this.disabled = true;
            this._removeEventHandlers();
            this._header.addClass(this.toThemeProperty('jqx-window-header-disabled'));
            this._closeButton.addClass(this.toThemeProperty('jqx-window-close-button-disabled'));
            this._collapseButton.addClass(this.toThemeProperty('jqx-window-collapse-button-disabled'));
            this._content.addClass(this.toThemeProperty('jqx-window-content-disabled'));
            this.host.addClass(this.toThemeProperty('jqx-window-disabled'));
            this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
            this._removeResize();
        },

        //Enabling the window
        enable: function () {
            if (this.disabled) {
                this._addEventHandlers();
                this._header.removeClass(this.toThemeProperty('jqx-window-header-disabled'));
                this._content.removeClass(this.toThemeProperty('jqx-window-content-disabled'));
                this._closeButton.removeClass(this.toThemeProperty('jqx-window-close-button-disabled'));
                this._collapseButton.removeClass(this.toThemeProperty('jqx-window-collapse-button-disabled'));
                this.host.removeClass(this.toThemeProperty('jqx-window-disabled'));
                this.host.removeClass(this.toThemeProperty('jqx-fill-state-disabled'));
                this.disabled = false;
                this._initializeResize();
            }
        },

        //Returning true if the window is open (not hidden) and false if it is closed (hidden)
        isOpen: function () {
            return this._visible;
        },

        //Closing the window
        closeWindow: function (action) {
            var self = this;
            action = (typeof action === 'undefined') ? this.closeButtonAction : action;
            this.hide(function () {
                if (action === 'close') {
                    self._destroy();
                }
            });
        },

        //Bringing the window to the front
        bringToFront: function () {
            var windows = $.data(document.body, 'jqxwindows-list');
            if (windows.length == 0) {
                if (this.isModal) {
                    windows = $.data(document.body, 'jqxwindows-modallist');
                }
                this._fixWindowZIndex('modal-hide');
                this._fixWindowZIndex('modal-show');
                return;
            }

            var upperWindow = windows[windows.length - 1],
            zIndex = parseInt(upperWindow.css('z-index'), 10),
            currentElementIndex = this._indexOf(this.host, windows);
            for (var i = windows.length - 1; i > currentElementIndex; i -= 1) {
                var currentZIndex = parseInt(windows[i].css('z-index'), 10) - 1;
                windows[i].css('z-index', currentZIndex);
            }
            this.host.css('z-index', zIndex);
            this._sortByStyle('z-index', windows);
        },

        //Hiding/closing the current window
        hide: function (callback, duration, notRaiseEvent) {
            if (this.closing) {
                var res = this.closing();
                if (res == false) return;
            }

            duration = duration || this.closeAnimationDuration;
            switch (this.animationType) {
                case 'none':
                    this.host.css('display', 'none');
                    break;
                case 'fade':
                    this.host.fadeOut(duration, function () {
                        if (callback instanceof Function) {
                            callback();
                        }
                    });
                case 'slide':
                    this.host.slideUp(duration, function () {
                        if (callback instanceof Function) {
                            callback();
                        }
                    });
                case 'combined':
                    this.host.hide(duration, function () {
                        if (callback instanceof Function) {
                            callback();
                        }
                    });
            }
            this._visible = false;
            if (this.isModal) {
                this._modalBackground.hide();
                this._fixWindowZIndex('modal-hide');
            }
            if (notRaiseEvent !== true) {
                this._raiseEvent(1);
                this._raiseEvent(8);
            }
        },

        open: function (callback, duration) {
            this.show(callback, duration);
        },

        close: function (callback, duration, notRaiseEvent) {
            this.hide(callback, duration, notRaiseEvent);
        },

        //Opening/showing the current window
        show: function (callback, duration) {
            this._setDialogResult('none');
            duration = duration || this.showAnimationDuration;
            switch (this.animationType) {
                case 'none':
                    this.host.css('display', 'block');
                    break;
                case 'fade':
                    this.host.fadeIn(duration, function () {
                        if (callback instanceof Function) {
                            callback();
                        }
                    });
                    break;
                case 'slide':
                    this.host.slideDown(duration, function () {
                        if (callback instanceof Function) {
                            callback();
                        }
                    });
                    break;
                case 'combined':
                    this.host.show(duration, function () {
                        if (callback instanceof Function) {
                            callback();
                        }
                    });
                    break;
            }
            if (this.isModal) {
                this._modalBackground.show();
                this._fixWindowZIndex('modal-show');
            }
            var me = this;
            if (!this._visible) {
                //To remove this._raiseEvent(4); in the next version
                //  this._raiseEvent(4);
                if (duration > 150 && this.animationType != 'none') {
                    setTimeout(function () {
                        if (!me._contentInitialized) {
                            if (me.initContent) {
                                me.initContent();
                                me._contentInitialized = true;
                            }
                        }
                        me._raiseEvent(7);
                        me._raiseEvent(9);
                    }, duration - 150);
                }
                else {
                    if (!me._contentInitialized) {
                        if (me.initContent) {
                            me.initContent();
                            me._contentInitialized = true;
                        }
                    }
                    this._raiseEvent(7);
                    me._raiseEvent(9);
                }
            }
            this._visible = true;
            this._performLayout();
            // focus the displayed window.
            var focusContent = function () {
                me._content.focus();
            }
            focusContent();
            setTimeout(function () {
                focusContent();
            }, 100);
        },

        _getTabbables: function () {
            var elements = this._content.find('*');
            var tabbables = new Array();
            $.each(elements, function () {
                if (tabbable(this)) {
                    tabbables[tabbables.length] = this;
                }
            });
            return tabbables;
        },

        //Moving the current window
        move: function (x, y, event, raiseEvent) {
            var scrollLeft = 0, scrollTop = 0, position, pageX, pageY, x = parseInt(x, 10), y = parseInt(y, 10);
            if ($.jqx.browser.msie) {
                if ($(window).width() > $(document).width() && !this.dragArea) {
                    scrollTop = this._SCROLL_WIDTH;
                }
                if ($(window).height() < $(document).height() &&
                 document.documentElement.clientWidth > document.documentElement.scrollWidth && !this.dragArea) {
                    scrollLeft = this._SCROLL_WIDTH;
                }
            }
            position = this._validateCoordinates(x, y, scrollTop, scrollLeft);
            if (parseInt(this.host.css('left'), 10) !== position.x || parseInt(this.host.css('top'), 10) !== position.y) {
                if (event) {
                    var touches = $.jqx.mobile.getTouches(event);
                    var touch = touches[0];
                    var pos = $.jqx.position(event);
               
                    pageX = pos.left;
                    pageY = pos.top;
                }

                if (pageX == undefined) pageX = x;
                if (pageY == undefined) pageY = y;
                if (raiseEvent !== false) {
                    this._raiseEvent(2, position.x, position.y, pageX, pageY);
                }
            }
            this.element.style.left = position.x + 'px';
            this.element.style.top = position.y + 'px';
            this._moved = true;
        }
    });

    function focusable(element, isTabIndexNotNaN) {
        var nodeName = element.nodeName.toLowerCase();
        if ("area" === nodeName) {
            var map = element.parentNode,
			mapName = map.name,
			img;
            if (!element.href || !mapName || map.nodeName.toLowerCase() !== "map") {
                return false;
            }
            img = $("img[usemap=#" + mapName + "]")[0];
            return !!img && visible(img);
        }
        return (/input|select|textarea|button|object/.test(nodeName)
		? !element.disabled
		: "a" == nodeName
			? element.href || isTabIndexNotNaN
			: isTabIndexNotNaN)
        // the element and all of its ancestors must be visible
		&& visible(element);
    }

    function visible(element) {
        return !$(element).parents().andSelf().filter(function () {
            return $.css(this, "visibility") === "hidden" ||
			$.expr.filters.hidden(this);
        }).length;
    }

    function tabbable(element) {
        var tabIndex = $.attr(element, "tabindex"),
			isTabIndexNaN = isNaN(tabIndex);
        return (isTabIndexNaN || tabIndex >= 0) && focusable(element, !isTabIndexNaN);
    }

} (jQuery));

(function ($) {
    var resizeModule = (function ($) {
        return {

            resizeConfig: function () {
                // Resize target
                this.resizeTarget = null;
                // Indicator's size
                this.resizeIndicatorSize = 5;
                // All children are saved here
                this.resizeTargetChildren = null;
                // Indicates if it's resizing
                this.isResizing = false;
                // Indicates if the cursor is in the resize area. It is usefull when you are using different cursors in your resize target
                this.resizeArea = false;
                // Setting target's minimal width
                this.minWidth = 1;
                // Setting target's max width
                this.maxWidth = 100;
                // Setting target's min height
                this.minHeight = 1;
                // Setting target's max height
                this.maxHeight = 100;
                // Setting target's parent
                this.resizeParent = null;
                // Setting whether the resize is disabled
                this.enableResize = true;

                this._cursorBackup;
                this._resizeEvents = ['resizing', 'resized', 'resize'];

                //Private variables
                this._resizeMouseDown = false;
                this._resizeCurrentMode = null;
                this._mouseResizePosition = {};
                this._resizeMethods = null;
                this._SCROLL_WIDTH = 21;
            },

            _resizeExceptions: {
                'invalidTarget': 'Invalid target!',
                'invalidMinHeight': 'Invalid minimal height!',
                'invalidMaxHeight': 'Invalid maximum height!',
                'invalidMinWidth': 'Invalid minimum width!',
                'invalidMaxWidth': 'Invalid maximum width!',
                'invalidIndicatorSize': 'Invalid indicator size!',
                'invalidSize': 'Invalid size!'
            },

            removeResize: function () {
                if (this.resizeTarget) {
                    var resizer = $(this.resizeTarget.children('.jqx-resize'));
                    resizer.detach();
                    var content = resizer.children();
                    this._removeResizeEventListeners();
                    for (var i = 0; i < content.length; i += 1) {
                        $(content[i]).detach();
                        this.resizeTarget.append(content[i]);
                    }
                    resizer.remove();
                }
                //resizer.remove();
            },

            //Initializing all variables
            initResize: function (config) {
                this.resizeConfig();
                this.resizeTarget = $(config.target);
                this.resizeIndicatorSize = config.indicatorSize || 10;
                this.maxWidth = config.maxWidth || 100;
                this.minWidth = config.minWidth || 1;
                this.maxHeight = config.maxHeight || 100;
                this.minHeight = config.minHeight || 1;
                this.resizeParent = config.resizeParent;
                this._parseResizeParentProperties();
                this._validateResizeProperties();
                this._validateResizeTargetDimensions();
                this._getChildren(this.resizeTarget.maxWidth, this.resizeTarget.minWidth,
                                  this.resizeTarget.maxHeight, this.resizeTarget.minHeight, config.alsoResize);
                this._refreshResize();
                this._cursorBackup = this.resizeTarget.css('cursor');
                if (this._cursorBackup === 'auto') {
                    this._cursorBackup = 'default';
                }
            },

            _validateResizeTargetDimensions: function () {
                this.resizeTarget.maxWidth = this.maxWidth;
                this.resizeTarget.minWidth = ((3 * this.resizeIndicatorSize > this.minWidth) ? 3 * this.resizeIndicatorSize : this.minWidth);
                this.resizeTarget.maxHeight = this.maxHeight;
                this.resizeTarget.minHeight = ((3 * this.resizeIndicatorSize > this.minHeight) ? 3 * this.resizeIndicatorSize : this.minHeight);
            },

            _parseResizeParentProperties: function () {
                if (this.resizeParent) {
                    this.resizeParent.left = parseInt(this.resizeParent.left, 10);
                    this.resizeParent.top = parseInt(this.resizeParent.top, 10);
                    this.resizeParent.width = parseInt(this.resizeParent.width, 10);
                    this.resizeParent.height = parseInt(this.resizeParent.height, 10);
                }
            },

            //Getting all children and setting their max and min height/width. First we are calculating their ratio
            //to the main container which we are going to modify to be resizable.
            _getChildren: function (maxWidth, minWidth, maxHeight, minHeight, selector) {
                this.resizeTargetChildren = $(selector);
                this.resizeTargetChildren.toArray();
                var count = this.resizeTargetChildren.length;
                while (count) {
                    count -= 1;
                    this.resizeTargetChildren[count] = $(this.resizeTargetChildren[count]);
                }
            },

            _refreshResize: function () {
                this._renderResize();
                this._performResizeLayout();
                this._removeResizeEventListeners();
                this._addResizeEventHandlers();
            },

            //Creating inner wrapper which is going to be our resize helper
            _renderResize: function () {
                this.resizeTarget.wrapInner($('<div></div>'));
                this._resizeWrapper = this.resizeTarget.children(0);
                this._resizeWrapper.addClass('jqx-resize');
                this._resizeWrapper.addClass('jqx-rc-all');
                this._resizeWrapper.css('z-index', 8000);
            },

            _performResizeLayout: function () {
                this._resizeWrapper.height(this.resizeTarget.height());
                this._resizeWrapper.width(this.resizeTarget.width());
            },

            _removeResizeEventListeners: function () {
                var resizetargetid = this.resizeTarget.attr('id');

                this.removeHandler(this._resizeWrapper, 'mousemove.resize' + resizetargetid);
                this.removeHandler(this._resizeWrapper, 'mousedown.resize' + resizetargetid);
                this.removeHandler($(document), 'mousemove.resize' + resizetargetid);
                this.removeHandler($(document), 'mouseup.resize' + resizetargetid);
            },

            _addResizeEventHandlers: function () {
                var resizetargetid = this.resizeTarget.attr('id');
                var self = this;
                this.addHandler(this._resizeWrapper, 'mousemove.resize.' + resizetargetid, function (event) {
                    self._resizeCursorChangeHandler(self, event);
                });
                this.addHandler(this._resizeWrapper, 'mousedown.resize.' + resizetargetid, function (event) {
                    self._resizeMouseDownHandler(self, event);
                });
                this.addHandler($(document), 'mousemove.resize.' + resizetargetid, function (event) {
                    return self._resizeHandler(self, event);
                });
                this.addHandler($(document), 'mouseup.resize.' + resizetargetid, function (event) {
                    self._stopResizing(self, event);
                });

                try {
                    if (document.referrer != "" || window.frameElement) {
                        var eventHandle = function (event) {
                            self._stopResizing(self, event);
                        };

                        if (window.top.document.addEventListener) {
                            window.top.document.addEventListener('mouseup', eventHandle, false);

                        } else if (window.top.document.attachEvent) {
                            window.top.document.attachEvent("on" + 'mouseup', eventHandle);
                        }
                    }
                }
                catch (error) {
                }
            },

            _stopResizing: function (self, event) {
                if (self.enableResize) {
                    if (self.isResizing) {
                        self._raiseResizeEvent(1);
                    }
                    self._resizeMouseDown = false;
                    self.isResizing = false;
                    self._resizeDirection = null;
                    if (self.resizeTarget) {
                        self.resizeTarget.removeClass('jqx-disableselect');
                    }
                }

                if (self._cursorBackup == 'undefined') {
                    self._cursorBackup = 'default';
                }

                if (self._resizeWrapper) {
                    self._resizeWrapper.css('cursor', self._cursorBackup);
                }
            },

            _resizeHandler: function (self, event) {
                if (self.enableResize) {
                    if (self.isResizing && self._resizeDirection) {
                        if (event.which === 0 && $.jqx.browser.msie && $.jqx.browser.version < 9) {
                            self._stopResizing(event);
                        }
                        self._performResize(event.pageX, event.pageY);
                        return false;
                    } else {
                        return self._resizeCaptureCursor(event.pageX, event.pageY);
                    }
                }
            },

            _resizeCaptureCursor: function (mouseX, mouseY) {
                if (this._resizeMouseDown && !this.isResizing && this._resizeDirection) {
                    if ((mouseX + 3 < this._mouseResizePosition.x || mouseX - 3 > this._mouseResizePosition.x) ||
                        (mouseY + 3 < this._mouseResizePosition.y || mouseY - 3 > this._mouseResizePosition.y)) {
                        this._changeCursor(mouseX - parseInt(this.resizeTarget.css('left')), mouseY - parseInt(this.resizeTarget.css('top')));
                        this._mouseResizePosition = { x: mouseX, y: mouseY };
                        this._prepareResizeMethods(this._resizeDirection);
                        this._resizeBackupData();
                        this.isResizing = true;
                        this.resizeTarget.addClass('jqx-disableselect');
                        return false;
                    }
                }
            },

            _resizeBackupData: function () {
                this.resizeTarget.lastWidth = this.resizeTarget.width();
                this.resizeTarget.lastHeight = this.resizeTarget.height();
                this.resizeTarget.x = parseInt(this.resizeTarget.css('left'), 10);
                this.resizeTarget.y = parseInt(this.resizeTarget.css('top'), 10);
                this._resizeBackupChildrenSize();
            },

            _resizeBackupChildrenSize: function () {
                var count = this.resizeTargetChildren.length, child;
                while (count) {
                    count -= 1;
                    child = this.resizeTargetChildren[count];
                    this.resizeTargetChildren[count].lastWidth = child.width();
                    this.resizeTargetChildren[count].lastHeight = child.height();
                }
            },

            _performResize: function (mouseX, mouseY) {
                var differenceX = mouseX - this._mouseResizePosition.x,
                    differenceY = mouseY - this._mouseResizePosition.y;
                if (this._resizeDirection) {
                    this._resize(this.resizeTarget, differenceX, differenceY);
                }
            },

            _resizeCursorChangeHandler: function (self, event) {
                if (self.enableResize) {
                    if (!self.isResizing) {
                        self._changeCursor(event.pageX - parseInt(self.resizeTarget.css('left')),
                                       event.pageY - parseInt(self.resizeTarget.css('top')));
                    }
                }
            },

            _resizeMouseDownHandler: function (self, event) {
                if (self.enableResize) {
                    if (self._resizeDirection !== null) {
                        self._resizeMouseDown = true;
                        self._mouseResizePosition.x = event.pageX;
                        self._mouseResizePosition.y = event.pageY;
                        event.preventDefault();
                    }
                }
            },

            _validateResizeProperties: function () {
                try {
                    if (!this.resizeTarget || this.resizeTarget.length !== 1) {
                        throw new Error(this._resizeExceptions['invalidTarget']);
                    }
                    if (this.minHeight < 0 || isNaN(parseInt(this.minHeight))) {
                        throw new Error(this._resizeExceptions['invalidMinHeight']);
                    }
                    if (this.maxHeight <= 0 || isNaN(parseInt(this.maxHeight))) {
                        throw new Error(this._resizeExceptions['invalidMaxHeight']);
                    }
                    if (this.minWidth < 0 || isNaN(parseInt(this.minWidth))) {
                        throw new Error(this._resizeExceptions['invalidMinWidth']);
                    }
                    if (this.maxWidth < 0 || isNaN(parseInt(this.maxWidth))) {
                        throw new Error(this._resizeExceptions['invalidMaxWidth']);
                    }
                    if (this.resizeIndicatorSize < 0 || isNaN(parseInt(this.resizeIndicatorSize))) {
                        throw new Error(this._resizeExceptions['invalidIndicatorSize']);
                    }
                    if (this.minHeight > this.maxHeight ||
                        this.minWidth > this.maxWidth) {
                        throw new Error(this._resizeExceptions['invalidSize']);
                    }
                    if (this.resizeParent && this.resizeParent.width && this.resizeParent.height && this.resizeParent.left &&
                        this.resizeParent.top && ((this.resizeParent.width < this.resizeTarget.width() || this.resizeParent.width < this.maxWidth) ||
                        (this.resizeParent.height < this.resizeTarget.height() || this.resizeParent.height < this.maxHeight))) {
                        throw new Error(this._resizeExceptions['invalidSize']);
                    }
                } catch (exception) {
                    alert(exception);
                }
            },

            //This method is checking cursor's position and setting specific pointer depending on mouse coordinates.
            //It's also detecting resize direction and creating string with it. For example for top-left resize the string is going to be 'topleft'.
            _changeCursor: function (x, y) {
                if (this.isResizing || this._resizeMouseDown) {
                    return;
                }
                this.resizeArea = true;
                if (x <= this.resizeIndicatorSize && x >= 0 && y <= this.resizeIndicatorSize && y > 0) {    //top left
                    this._resizeWrapper.css('cursor', 'nw-resize');
                    this._resizeDirection = 'topleft';
                } else if (y <= this.resizeIndicatorSize && y > 0 && x >= this.resizeTarget.width() - this.resizeIndicatorSize) { //top right
                    this._resizeWrapper.css('cursor', 'ne-resize');
                    this._resizeDirection = 'topright';
                } else if (y >= this.resizeTarget.height() - this.resizeIndicatorSize && //bottom left
                           y < this.resizeTarget.height() &&
                           x <= this.resizeIndicatorSize && x >= 0) {
                    this._resizeWrapper.css('cursor', 'sw-resize');
                    this._resizeDirection = 'bottomleft';
                } else if (y >= this.resizeTarget.height() - this.resizeIndicatorSize && //bottom right
                           y < this.resizeTarget.height() &&
                           x >= this.resizeTarget.width() - this.resizeIndicatorSize &&
                           x < this.resizeTarget.width()) {
                    this._resizeWrapper.css('cursor', 'se-resize');
                    this._resizeDirection = 'bottomright';
                } else if (x <= this.resizeIndicatorSize && x >= 0) { //left
                    this._resizeWrapper.css('cursor', 'e-resize');
                    this._resizeDirection = 'left';
                } else if (y <= this.resizeIndicatorSize && y > 0) { //top
                    this._resizeWrapper.css('cursor', 'n-resize');
                    this._resizeDirection = 'top';
                } else if (y >= this.resizeTarget.height() - this.resizeIndicatorSize && //bottom
                           y < this.resizeTarget.height()) {
                    this._resizeWrapper.css('cursor', 'n-resize');
                    this._resizeDirection = 'bottom';
                } else if (x >= this.resizeTarget.width() - this.resizeIndicatorSize &&  //right
                           x < this.resizeTarget.width()) {
                    this._resizeWrapper.css('cursor', 'e-resize');
                    this._resizeDirection = 'right';
                } else {
                    this._resizeWrapper.css('cursor', this._cursorBackup);
                    this._resizeDirection = null;
                    this.resizeArea = false;
                }
            },

            //Putting all methods which are going to be used along the resize action (for example _resizeRight, _resizeTop) into an array.
            //We are performing this because if we are checking and calling the right methods along the resizing (on mousemove)
            //we should make more checks.
            _prepareResizeMethods: function (direction) {
                this._resizeMethods = [];
                if (direction.indexOf('left') >= 0) { this._resizeMethods.push(this._resizeLeft); }
                if (direction.indexOf('top') >= 0) { this._resizeMethods.push(this._resizeTop); }
                if (direction.indexOf('right') >= 0) { this._resizeMethods.push(this._resizeRight); }
                if (direction.indexOf('bottom') >= 0) { this._resizeMethods.push(this._resizeBottom); }
            },

            _validateResize: function (newWidth, newHeight, direction, element, side) {
                if (direction === 'horizontal' || direction === 'both') {
                    return this._validateWidth(newWidth, element, side);
                } else if (direction === 'vertical' || direction === 'both') {
                    return this._validateHeight(newHeight, element, side);
                }
                return { result: false, fix: 0 };
            },

            _getParent: function () {
                if (this.resizeParent !== null && this.resizeParent !== 'undefined' && this.resizeParent.height && this.resizeParent.width &&
                    this.resizeParent.top && this.resizeParent.left) {
                    return this.resizeParent;
                }
                return {
                    left: 0, top: 0,
                    width: $(document).width(), height: $(document).height()
                };
            },

            _validateHeight: function (newHeight, element, side) {
                var scrollTop = 0,
                heightDisplacement = 2,
                result = false,
                size = newHeight,
                resizeParent = this._getParent();

                if ($(window).width() > $(document).width() && $.jqx.browser.msie && resizeParent.height === $(document).height()) {
                    scrollTop = this._SCROLL_WIDTH;
                }
                if (side === 'bottom' && (newHeight + element.position().top + scrollTop + heightDisplacement > resizeParent.height + resizeParent.top)) {   //fixing if user is trying to resize it more than the window
                    return { fix: resizeParent.height - element.position().top - scrollTop - heightDisplacement + resizeParent.top, result: false };
                }
                if (side === 'top' && element.lastHeight - newHeight + element.y < resizeParent.top) { //check if the user is trying to drag it in the window's top
                    return { fix: newHeight + (element.lastHeight - newHeight + element.y) - resizeParent.top, result: false };
                }
                if (newHeight < element.minHeight) {
                    return { fix: element.minHeight, result: false };
                }
                if (newHeight > element.maxHeight) {
                    return { fix: element.maxHeight, result: false };
                }
                return { result: true, fix: newHeight };
            },

            _validateWidth: function (newWidth, element, side) {
                var scrollLeft = 0, widthDisplacement = 2, result = false, size = newWidth, resizeParent = this._getParent();
                if ($(window).height() < $(document).height() && $.jqx.browser.msie &&
                    document.documentElement.clientWidth >= document.documentElement.scrollWidth &&
                    resizeParent.width === $(document).width()) {    //check if there is a right but there is not a bottom one 
                    scrollLeft = this._SCROLL_WIDTH;
                }
                if (side === 'right' && (newWidth + element.position().left + scrollLeft + widthDisplacement > resizeParent.width + resizeParent.left)) {
                    return { fix: resizeParent.width - element.position().left - scrollLeft - widthDisplacement + resizeParent.left, result: false };
                }
                if (side === 'left' && (element.lastWidth - newWidth + element.x < resizeParent.left)) { //check if the user is trying to drag it in the window's left
                    return { fix: newWidth + (element.lastWidth - newWidth + element.x) - resizeParent.left, result: false };
                }
                if (newWidth < element.minWidth) {
                    return { fix: element.minWidth, result: false };
                }
                if (newWidth > element.maxWidth) {
                    return { fix: element.maxWidth, result: false };
                }
                return { result: true, fix: newWidth };
            },

            _resize: function (element, differenceX, differenceY) {
                var direction = this._resizeDirection;
                var length = this._resizeMethods.length;
                for (var i = 0; i < length; i++) {
                    if (this._resizeMethods[i] instanceof Function) {
                        var properties = { element: element, x: differenceX, y: differenceY, self: this };
                        this._resizeMethods[i](properties);
                    }
                }
                this._performResizeLayout();
            },

            resize: function (width, height) {
                if (this.resizable) {
                    var differenceX = width - this.host.width();
                    var differenceY = height - this.host.height();
                    var direction = 'right';
                    if (differenceY != 0) {
                        direction = 'bottom';
                    }
                    this._resizeDirection = direction;
                    this._prepareResizeMethods(this._resizeDirection);
                    this._resizeBackupData();
                    this.isResizing = true;
                    this._resize(this.resizeTarget, differenceX, differenceY);
                    this.isResizing = false;
                }
            },

            _setResizeChildrenSize: function (size, dimention) {
                var count = this.resizeTargetChildren.length;
                while (count) {
                    count--;
                    if (dimention === 'width') {
                        var newWidth = this.resizeTargetChildren[count].lastWidth - (this.resizeTarget.lastWidth - size);
                        if (newWidth < this.resizeTarget.maxWidth && newWidth > 0) {
                            this.resizeTargetChildren[count].width(newWidth);
                        }
                    } else {
                        var newHeight = this.resizeTargetChildren[count].lastHeight - (this.resizeTarget.lastHeight - size);
                        if (newHeight < this.resizeTarget.maxHeight && newHeight > 0) {
                            this.resizeTargetChildren[count].height(newHeight);
                        }
                    }
                }
            },

            _resizeRight: function (properties) {
                var width = properties.element.lastWidth + properties.x,
                    result = properties.self._validateResize(width, 0, 'horizontal', properties.element, 'right');
                if (!result.result) {
                    width = result.fix;
                }
                if (properties.element.width() !== width) {
                    properties.self._setResizeChildrenSize(width, 'width');
                    properties.element.width(width);
                    properties.self._raiseResizeEvent(0);
                }
                return width;
            },

            _resizeLeft: function (properties) {
                var width = properties.element.lastWidth - properties.x,
                    result = properties.self._validateResize(width, 0, 'horizontal', properties.element, 'left'),
                    x = properties.element.x + properties.x;
                if (!result.result) {
                    x = properties.element.x + (properties.element.lastWidth - result.fix);
                    width = result.fix;
                    return;
                }
                if (properties.element.width() !== width) {
                    properties.self._setResizeChildrenSize(width, 'width');
                    properties.element.width(width);
                    properties.element.css('left', x);
                    properties.self._raiseResizeEvent(0);
                }
                return width;
            },

            _resizeBottom: function (properties) {
                var height = properties.element.lastHeight + properties.y,
                    result = properties.self._validateResize(0, height, 'vertical', properties.element, 'bottom');
                if (!result.result) {
                    height = result.fix;
                }
                if (properties.element.height() !== height) {
                    properties.self._setResizeChildrenSize(height, 'height');
                    properties.element.height(height);
                    properties.self._raiseResizeEvent(0);
                }
                return height;
            },

            _resizeTop: function (properties) {
                var height = properties.element.lastHeight - properties.y,
                    result = properties.self._validateResize(0, height, 'vertical', properties.element, 'top'),
                    y = properties.element.y + properties.y;
                if (!result.result) {
                    y = properties.element.y + (properties.element.lastHeight - result.fix);
                    height = result.fix;
                    return;
                }
                if (properties.element.height() !== height) {
                    properties.self._setResizeChildrenSize(height, 'height');
                    properties.element.height(height);
                    properties.element.css('top', y);
                    properties.self._raiseResizeEvent(0);
                }
                return height;
            },

            _raiseResizeEvent: function (eventId) {
                var eventType = this._resizeEvents[eventId],
                    event = $.Event(eventType),
                    args = {};
                args.width = parseInt(this.resizeTarget[0].style.width);
                args.height = parseInt(this.resizeTarget[0].style.height);
                event.args = args;
                if (eventId == 0) {
                    var eventType = this._resizeEvents[2],
                    resizeEvent = $.Event(eventType);
                    resizeEvent.args = args;
                    this.resizeTarget.trigger(resizeEvent);
                }

                return this.resizeTarget.trigger(event);
            }
        };
    }(jQuery));
    $.extend($.jqx._jqxWindow.prototype, resizeModule);
}(jQuery));
(function ($) {

    $.jqx.jqxWidget("jqxDocking", "", {});

    $.extend($.jqx._jqxDocking.prototype, {

        defineInstance: function () {
            // Type: String
            // Default: 'horizontal'
            // Sets or gets docking's orientation
            this.orientation = 'horizontal';
            // Type: String
            // Default: default
            // Sets or gets docking's mode. Possible values - default, floating, docked
            this.mode = 'default';
            // Type: Number
            // Default: 0.3
            // Sets or gets docking's floating window's opacity
            this.floatingWindowOpacity = 0.3;
            // Type: Bool
            // Default: true
            // Sets or gets whether the panel's corners are rounded
            this.panelsRoundedCorners = true;
            // Type: Bool
            // Default: false
            // Sets or gets whether the dicking is disabled
            this.disabled = false;
            // Type: String/Number
            // Default: auto
            // Sets or gets docking's width
            this.width = 'auto';
            // Type: String/Number
            // Default: auto
            // Sets or gets docking's height
            this.height = 'auto';
            // Type: Object
            // Default: null
            // Sets or gets docking window's modes (each one could be in floating or default mode)
            this.windowsMode = null;
            // Type: Bool
            // Default: true
            // Sets or gets whether the current layout would be saved into cookies
            this.cookies = false;
            // Type: Object
            // Default: {}
            // Sets or gets cookie options
            this.cookieOptions = {};
            // Type: Number
            // Default: 5
            // Sets or gets window's offset
            this.windowsOffset = 5;
            this.rtl = false;
            this._windowOptions = {};
            this._draggedFired = false;
            this._dragging = false;
            this._draggingItem = null;
            this._panels = [];
            this._windows = [];
            this._indicator = null;
            this._events = ['dragEnd', 'dragStart'];
        },

        createInstance: function () {
            if (!this.host.jqxWindow) {
                throw new Error("jqxDocking: Missing reference to jqxwindow.js.");
            }

            this._refresh(true);
            if (this.disabled) {
                this.disabled = false;
                this.disable();
            }
        },

        refresh: function (initialRefresh) {
            if (!initialRefresh) {
                this._performLayout();
            }
        },

        _refresh: function (startup) {
            this._render();
            this._removeClasses();
            this._addClasses();
            this._setWindowsOptions(true);
            this._performLayout();
            this._cookieHandler();
            this._cookieExporter();
            this._removeEventListeners();
            this._addEventListeners();
            var event = $.Event('resize');
            this.host.trigger(event);
        },

        _addClasses: function () {
            this.host.addClass('jqx-docking');
            for (var i = 0; i < this._panels.length; i += 1) {
                this._panels[i].addClass(this.toThemeProperty('jqx-docking-panel'));
                if (this.panelsRoundedCorners) {
                    this._panels[i].addClass(this.toThemeProperty('jqx-rc-all'));
                }
            }
            for (var i = 0; i < this._windows.length; i += 1) {
                this._windows[i].addClass(this.toThemeProperty('jqx-docking-window'));
            }
        },

        _removeClasses: function () {
            this.host.removeClass('jqx-docking');
            for (var i = 0; i < this._panels.length; i += 1) {
                this._panels[i].removeClass(this.toThemeProperty('jqx-docking-panel'));
                this._panels[i].removeClass(this.toThemeProperty('jqx-rc-all'));
            }
            for (var i = 0; i < this._windows.length; i += 1) {
                this._windows[i].removeClass(this.toThemeProperty('jqx-docking-window'));
            }
        },

        _render: function () {
            var panels = this.host.children('div'), windows;
            for (var i = 0; i < panels.length; i += 1) {
                this._panels.push($(panels[i]));
                this._renderWindows($(panels[i]));
            }
        },

        _renderWindows: function (panel) {
            var windows = panel.children('div');
            for (var j = 0; j < windows.length; j += 1) {
                this._windows.push($(windows[j]));
                $(windows[j]).jqxWindow({ keyboardNavigation: false, rtl: this.rtl, theme: this.theme, enableResize: false, width: $(windows[j]).css('width'), maxWidth: Number.MAX_VALUE });
                $(windows[j]).detach();
                panel.append($(windows[j]));
            }
            panel.append('<div class="spacer" style="clear: both;"></div>');
        },

        _performLayout: function () {
            this.host.css('width', this.width);
            this.host.css('height', this.height);
            this._performWindowsLayout();
            this._performPanelsLayout();
            this._performWindowsLayout();
        },

        _performPanelsLayout: function () {
            var panel, hostWidth = this.host.width(), sizeSum = 0;
            for (var i = 0; i < this._panels.length; i += 1) {
                panel = this._panels[i];
                panel.css('height', 'auto');
                panel.css('min-width', 'auto');
                if (this.orientation === 'vertical') {
                    panel.css('width', 'auto');
                    panel.css('float', 'none');
                } else {
                    sizeSum += this._handleHorizontalSize(panel, sizeSum, hostWidth);
                    if (i > 0)
                        panel.css('margin-left', -this.windowsOffset);
                }
                panel.css('min-width', panel.width());
            }
            if (this.orientation === 'horizontal') {
                if (sizeSum < hostWidth) {
                    this._fillContainer(hostWidth, sizeSum);
                }
            }
        },

        _handleHorizontalSize: function (panel, sizeSum, hostWidth) {
            var midWidth = hostWidth / this._panels.length,
                size,
                difference = (panel.outerWidth() - panel.width());
            panel.css('float', 'left');
            if (panel.css('width') === 'auto' || parseInt(panel.css('width'), 10) === 0) {
                panel.width(midWidth - difference);
            }
            if (sizeSum + panel.outerWidth() >= hostWidth) {
                if (sizeSum + midWidth < hostWidth) {
                    size = midWidth - difference;
                    panel.css('min-width', size);
                    panel.width(size);
                } else {
                    size = panel.width() - ((sizeSum + panel.outerWidth()) - hostWidth);
                    panel.css('min-width', size);
                    panel.width(size);
                }
            }
            return panel.outerWidth();
        },

        _fillContainer: function (hostWidth, sizeSum) {
            var count = this._panels.length, lastPanel = this._panels[count - 1],
                size = hostWidth - sizeSum + lastPanel.width();
            if ($.jqx.browser.msie && $.jqx.browser.version < 9) {
                size -= this._panels.length;
            }
            lastPanel.width(size);
        },

        _performWindowsLayout: function () {
            var options;
            for (var i = 0; i < this._windows.length; i += 1) {
                options = this._getWindowOptions(this._windows[i]);
                if (this._windows[i].ischildof(this.host)) {
                    if (options) {
                        if (options.mode !== 'floating') {
                            this._windows[i].css('margin', this.windowsOffset);
                            this._windows[i].css('position', 'static');
                        }
                    } else {
                        if (this.mode !== 'floating') {
                            this._windows[i].css('position', 'static');
                            this._windows[i].css('margin', this.windowsOffset);
                        }
                    }
                }
                this._setWindowSize(this._windows[i], options);
            }
        },

        _setWindowSize: function (window, options) {
            if (options.mode !== 'floating') {
                if (window.ischildof(this.host)) {
                    var newSize = window.parent().width() - (window.outerWidth() - window.width()) - 2 * this.windowsOffset;
                    if (this.orientation === 'vertical') {
                        window.jqxWindow('width', newSize);
                    } else {
                        window.jqxWindow('width', newSize);
                    }
                }
            }
            this._setWindowOption(window, 'size', {
                width: window.width(),
                height: window.height()
            });
        },

        _setWindowsOptions: function (fullOptions) {
            for (var i = 0; i < this._windows.length; i += 1) {
                var mode,
                    windowId = this._windows[i].attr('id'),
                    options = this._getWindowOptions(windowId);
                if (!fullOptions) {
                    var t = 'TEDX';
                }

                mode = null;
                if (this.windowsMode && this.windowsMode.hasOwnProperty(windowId)) {
                    mode = this.windowsMode[windowId];
                    this._setWindowOption(this._windows[i], 'mode', mode);
                } else if (typeof options !== 'undefined' && typeof options['mode'] === 'undefined') {
                    mode = this.mode;
                    this._setWindowOption(this._windows[i], 'mode', mode);
                }
                if (fullOptions) {
                    this._setWindowOption(this._windows[i], 'resizable', true);
                    if (mode == 'floating') {
                        this._windows[i].jqxWindow({ enableResize: true });
                    }
                    else {
                        this._windows[i].jqxWindow({ enableResize: false });
                    }

                    this._setWindowOption(this._windows[i], 'size', { height: this._windows[i].height(), width: this._windows[i].width() });
                }
            }
        },

        _removeEventListeners: function () {
            for (var i = 0; i < this._windows.length; i += 1) {
                this.removeHandler(this._windows[i], 'moving', this._itemDragging);
                this.removeHandler(this._windows[i], 'moved', this._itemDrop);
                this.removeHandler(this._windows[i], 'resized', this._itemResized);
                this.removeHandler(this._windows[i], 'collapse', this._collapsed);
                this.removeHandler(this._windows[i], 'expand', this._expanded);
            }
        },

        _addEventListeners: function () {
            for (var i = 0; i < this._windows.length; i += 1) {
                this._addEventListenersTo(this._windows[i]);
            }

            var me = this;
            $.jqx.utilities.resize(this.host, function () {
                me._performLayout();
            });
        },

        _addEventListenersTo: function (window) {
            this.addHandler(window, 'moving', this._itemDragging, { self: this });
            this.addHandler(window, 'moved', this._itemDrop, { self: this });
            this.addHandler(window, 'resized', this._itemResized, { self: this });
            this.addHandler(window, 'collapse', this._collapsed, { self: this });
            this.addHandler(window, 'expand', this._expanded, { self: this });
        },

        _itemDragging: function (event) {
            var self = event.data.self,
                window = $(event.target),
                options = self._getWindowOptions(window);
            window.removeClass(self.toThemeProperty('jqx-docking-window'));
            window.css('margin', '0px');
            if (!self._dragging) {
                self._prepareForDragging(window);
            }
            if (options.mode === 'floating') {
                return;
            }
            var position = { x: event.args.pageX, y: event.args.pageY },
                panel = self._getMouseOverPanel(position);
            if (panel) {
                self._mouseOverPanel(panel, position);
            } else {
                self._mouseLeavePanel();
            }
            if (!self._draggedFired) {
                self._raiseEvent(1, { window: $(window).attr('id') });
                self._draggedFired = true;
            }
          //  window.focus();
            return true;
        },

        _prepareForDragging: function (window) {
            this._dragging = true;
            var lastPosition = {
                parent: window.parent(),
                next: window.next(),
                prev: window.prev()
            };
            this._setWindowOption(window, 'lastPosition', lastPosition);
            window.detach();
            $(document.body).append(window);
            this._setDraggingStyles(window);
            this._draggingItem = window;
        },

        _setDraggingStyles: function (window) {
            window.css({
                'position': 'absolute',
                'left': window.offset().left,
                'top': window.offset().top
            });
            window.fadeTo(0, this.floatingWindowOpacity);
        },

        _getMouseOverPanel: function (cursorPosition) {
            var width, height, top, left;
            for (var i = 0; i < this._panels.length; i += 1) {
                if (this._isMouseOverItem(this._panels[i], cursorPosition, false)) {
                    return this._panels[i];
                }
            }
            return null;
        },

        _mouseOverPanel: function (panel, position) {
            if (this._dragging) {
                var windows = panel.children('div'),
                    window = this._getHoverWindow(position, windows);
                if (window === 'indicator') {
                    return;
                }
                var indicatorPosition = this._centerOffset(window, position);
                this._handleIndicator(panel, window, indicatorPosition);
            }
        },

        _getHoverWindow: function (position, windows) {
            var width, height, left, top;
            if (this._isMouseOverItem(this._indicator, position, true)) {
                return 'indicator';
            }
            for (var i = 0; i < windows.length; i += 1) {
                if (this._isMouseOverItem($(windows[i]), position, true)) {
                    return $(windows[i]);
                }
            }
            return null;
        },

        _centerOffset: function (window, position) {
            if (window) {
                var windowPosition = { x: window.offset().left, y: window.offset().top },
                    windowHeight = window.height(),
                    windowWidth = window.width(), middle;
                middle = windowPosition.y + windowHeight / 2;
                if (position.y > middle) {
                    return 'next';
                }
                return 'prev';
            }
            return 'all';
        },

        _handleIndicator: function (panel, window, indicatorPosition) {
            var indicator = this._getIndicator(window);
            if (indicatorPosition === 'all') {
                if (this.orientation === 'vertical') {
                    indicator.insertBefore(panel.children('.spacer'));
                } else {
                    panel.append(indicator);
                }
            } else {
                if (indicatorPosition === 'prev') {
                    indicator.insertBefore(window);
                } else {
                    indicator.insertAfter(window);
                }
            }
            this._resizeIndicator(indicator, panel);
        },

        _getIndicator: function () {
            var indicator = this._indicator;
            if (!indicator) {
                indicator = $('<div class="' + this.toThemeProperty('jqx-docking-drop-indicator') + '"></div>');
            }
            this._indicator = indicator;
            this._indicator.css('margin', this.windowsOffset);
            if (this.orientation === 'vertical') {
                this._indicator.css('float', 'left');
            }
            return indicator;
        },

        _resizeIndicator: function (indicator, panel) {
            if (this.orientation === 'horizontal') {
                indicator.width(panel.width() - (indicator.outerWidth(true) - indicator.width()));
                indicator.height(this._draggingItem.height());
            } else {
                indicator.width(this._draggingItem.width());
                indicator.height(this._draggingItem.height());
            }
        },

        _mouseLeavePanel: function (event) {
            if (this._indicator) {
                this._indicator.remove();
                this._indicator = null;
            }
        },

        _itemDrop: function (event) {
            var self = event.data.self,
                window = $(event.currentTarget);
            self._dragging = false;
            if (self._indicator) {
                window.detach();
                window.insertAfter(self._indicator);
                self._indicator.remove();
                self._dropFixer(window);
            } else {
                self._dropHandler(window);
            }
            window.fadeTo(0, 1);
            window.focus();
            self._indicator = null;
            self._cookieExporter();
            self._draggedFired = false;
            self._raiseEvent(0, { window: window.attr('id') });
        },

        _dropFixer: function (window) {
            window.css('position', 'static');
            window.addClass(this.toThemeProperty('jqx-docking-window'));
            window.css('margin', this.windowsOffset);
            window.jqxWindow('enableResize', false);
            if (this.orientation === 'horizontal') {
                this._fixWindowSize(window);
            }
        },

        _dropHandler: function (window) {
            var options = this._getWindowOptions(window);
            if (this.mode === 'docked') {
                this._dropDocked(window);
            } else {
                this._dropFloating(window);
            }
        },

        _dropDocked: function (window) {
            var options = this._getWindowOptions(window),
                lastPosition = options.lastPosition;
            window.detach();
            if (lastPosition.next[0]) {
                window.insertBefore(lastPosition.next);
            } else if (lastPosition.prev[0]) {
                window.insertAfter(lastPosition.prev);
            } else {
                lastPosition.parent.append(window);
            }
            this._dropFixer(window);
        },

        _fixWindowSize: function (window) {
            $(window).jqxWindow({
                width: window.parent().width() - (window.outerWidth() - window.width()) - 2 * parseInt(this.windowsOffset, 10)
            });
        },

        _itemResized: function (event) {
            var self = event.data.self,
                window = $(event.currentTarget);
            self._setWindowOption(window, 'size', { width: event.args.width, height: event.args.height });
            self._cookieExporter();
        },

        _dropFloating: function (window) {
            var options;
            if (!$(window).jqxWindow('collapsed')) {
                options = this._getWindowOptions(window);
                $(window).jqxWindow('enableResize', options.resizable);
            }
            $(document.body).append(window);
            this._restoreWindowSize(window);
        },

        _restoreWindowSize: function (window) {
            var options = this._getWindowOptions(window);
            $(window).jqxWindow({ width: options.size.width });
        },

        _isMouseOverItem: function (item, position, outerSize) {
            if (!item) {
                return false;
            }
            var outerWidth = item.outerWidth(true), outerHeight = item.outerHeight(true),
                width = item.width(), height = item.height(),
                top = item.offset().top, left = item.offset().left;
            if (outerSize) {
                top -= (outerHeight - height) / 2;
                left -= (outerWidth - width) / 2;
                width = outerWidth;
                height = outerHeight;
            }
            if ((left <= position.x && left + width >= position.x) &&
                (top <= position.y && top + height + 2 * this._draggingItem.height() / 3 >= position.y)) {
                return true;
            }
            return false;
        },

        _cookieHandler: function () {
            if (this.cookies) {
                var layout = $.jqx.cookie.cookie("jqxDocking" + this.element.id);
                if (layout !== null) {
                    this.importLayout(layout);
                    layoutImported = true;
                }
            }
        },

        _cookieExporter: function () {
            if (this.cookies) {
                $.jqx.cookie.cookie("jqxDocking" + this.element.id, this.exportLayout(), this.cookieOptions);
            }
        },

        _indexOf: function (item, collection) {
            for (var i = 0; i < collection.length; i += 1) {
                if (item[0] === collection[i][0]) {
                    return i;
                }
            }
            return -1;
        },

        _exportFixed: function () {
            var children = [], JSON = '', currentChildren, currentChild;
            for (var i = 0; i < this._panels.length; i += 1) {
                JSON += '"panel' + i + '": {';
                currentChildren = this._panels[i].children();
                for (var j = 0; j < currentChildren.length; j += 1) {
                    currentChild = $(currentChildren[j]);
                    if (currentChild.attr('id')) {
                        children.push(currentChild);
                        JSON += '"' + currentChild.attr('id') + '":{"collapsed":' + currentChild.jqxWindow('collapsed') + '},';
                    }
                }
                if (currentChildren.length > 1) {
                    JSON = JSON.substring(0, JSON.length - 1);
                }
                JSON += '},';
            }
            JSON = JSON.substring(0, JSON.length - 1);
            return { JSON: JSON, children: children };
        },

        _exportFloating: function (children) {
            var JSON = '', currentWindow;
            JSON += '"floating":{'
            for (var i = 0; i < this._windows.length; i += 1) {
                currentWindow = $(this._windows[i]);
                if (this._indexOf(currentWindow, children) === -1) {
                    JSON += '"' + currentWindow.attr('id') +
                        '":{"x":"' + currentWindow.css('left') + '","y":"' + currentWindow.css('top') + '",' +
                        '"width":"' + currentWindow.jqxWindow('width') + '","height":' + '"' + currentWindow.jqxWindow('height') + '",' +
                        '"collapsed":' + currentWindow.jqxWindow('collapsed') + '},';
                }
            }
            if (JSON.substring(JSON.length - 1, JSON.length) === ',') {
                JSON = JSON.substring(0, JSON.length - 1);
            }
            JSON += '}';
            return JSON;
        },

        _importFixed: function (imported) {
            for (var child in imported) {
                if (child !== 'orientation' && child !== 'floating' && imported.hasOwnProperty(child)) {
                    order = child.substring(child.length - 1, child.length);
                    order = parseInt(order, 10);
                    children = imported[child];
                    for (var child in children) {
                        $('#' + child).css('position', 'static');
                        if (children[child].collapsed) {
                            (function (child) {
                                setTimeout(function () {
                                    $('#' + child).jqxWindow('collapsed', true);
                                }, 0);
                            } (child));
                        }
                        this._panels[order].append($('#' + child));
                        if (this.orientation === 'horizontal') {
                            this._fixWindowSize($('#' + child));
                        }
                    }
                }
            }
        },

        _importFloating: function (imported) {
            var floating = imported['floating'],
                currentWindow,
                temp;
            for (var id in floating) {
                if (floating.hasOwnProperty(id)) {
                    $('#' + id).css('position', 'absolute');
                    $(document.body).append($('#' + id));
                    temp = this._dragging;
                    $('#' + id).jqxWindow('move', floating[id].x, floating[id].y);
                    this._dragging = temp;
                    $('#' + id).jqxWindow('width', floating[id].width);
                    $('#' + id).jqxWindow('height', floating[id].height);
                    $('#' + id).jqxWindow('enableResize', true);
                    this._setWindowsOptions(true);
                    (function (id) {
                        setTimeout(function () {
                            $('#' + id).jqxWindow('collapsed', floating[id].collapsed);
                        }, 0);
                    } (id));
                    $('#' + id).fadeTo(0, 1);
                }
            }
        },

        _getWindowOptions: function (window) {
            if (typeof window === 'object' && window !== null) {
                if (window.length > 0) {
                    window = window.attr('id');
                } else {
                    window = window.id;
                }
            }
            return this._windowOptions[window];
        },

        _setWindowOption: function (window, option, value) {
            if (typeof window === 'object' && window !== null) {
                if (window.length > 0) {
                    window = window.attr('id');
                } else {
                    window = window.id;
                }
            }
            if (typeof this._windowOptions[window] === 'undefined') {
                this._windowOptions[window] = {};
            }
            this._windowOptions[window][option] = value;
            if (option === 'mode') {
                this.setWindowMode(window, value);
            }
        },

        _expanded: function (event) {
            var self = event.data.self;
            self._cookieExporter();
        },

        _collapsed: function (event) {
            var self = event.data.self;
            self._cookieExporter();
        },

        _raiseEvent: function (eventId) {
            var event = $.Event(this._events[eventId]);
            event.args = arguments[1];
            return this.host.trigger(event);
        },

        _moveWindow: function (window, panel, position) {
            var children = panel.children();
            var child = null;
            var pos = 0;
            $.each(children, function (i) {
                if ($(this).css('position') == 'static') {
                    if (pos == position && this != window[0]) {
                        child = this;
                    }
                    pos++;
                }
            });

            if (pos <= position) {
                window.appendTo(panel);
            }
            else if (child != null) {
                window.insertBefore(child);
            }

            window.css('position', 'static');
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            switch (key) {
                case 'rtl':
                    $.each(object._windows, function () {
                        this.jqxWindow({ rtl: value });
                    });
                    break;
                case 'theme':
                    $.each(object._windows, function () {
                        this.jqxWindow({ theme: value });
                    });
                    break;
                case 'orientation':
                case 'height':
                case 'width':
                    object._performLayout();
                    object._cookieExporter();
                    break;
                case 'panelsRoundedCorners':
                    object._removeClasses();
                    object._addClasses();
                    break;
                case 'disabled':
                    if (value) {
                        object.disabled = false;
                        object.disable();
                    } else {
                        object.disabled = true;
                        object.enable();
                    }
                    break;
                case 'windowsMode':
                case 'mode':
                    object._setWindowsOptions(false);
                    break;
                case 'cookies':
                    object._cookieExporter();
                    break;
                case 'windowsOffset':
                    object._performLayout();
                    break;
            }
        },

        destroy: function () {
            this._removeEventListeners();
            this.host.remove();
            this.windowsMode = null;
            this.cookieOptions = null;
            this._windowOptions = null;
            this._panels = null;
            this._windows = null;
            this._events = null;
        },

        disable: function () {
            if (!this.disabled) {
                this.disabled = true;
                this._removeEventListeners();
                for (var i = 0; i < this._windows.length; i += 1) {
                    this._windows[i][0].style.opacity = "";
                    $(this._windows[i]).jqxWindow('disable');
                }
            }
        },

        enable: function () {
            if (this.disabled) {
                this.disabled = false;
                this._addEventListeners();
                for (var i = 0; i < this._windows.length; i += 1) {
                    $(this._windows[i]).jqxWindow('enable');
                }
            }
        },

        move: function (window, panel, position) {
            var panel = this._panels[panel];
            if (!panel) {
                return;
            }
            var spacer = $(panel.children('.spacer')), options;
            spacer.detach();
            window = $('#' + window);
            options = this._getWindowOptions(window);
            if (options.mode === 'floating') {
                return;
            } else {
                this._moveWindow(window, panel, position);
            }
            panel.append(spacer);
            this._cookieExporter();
            this._dropFixer(window);
        },

        exportLayout: function () {
            var JSON = '{', fixed = this._exportFixed();
            JSON += fixed.JSON + ',' + this._exportFloating(fixed.children) + ',' + '"orientation": ' + '"' + this.orientation + '"';
            JSON += '}';
            return JSON;
        },

        importLayout: function (JSON) {
            try {
                var imported = $.parseJSON(JSON), order, children;
                this.orientation = imported['orientation'];
                this._performLayout();
                this._importFixed(imported);
                this._importFloating(imported);
            } catch (e) {
                alert('Invalid JSON string.');
            }
        },

        setWindowMode: function (window, mode) {
            var window = $('#' + window),
                options = this._getWindowOptions(window);
            if (mode === 'floating') {
                window.css('position', 'absolute');
                this._windowOptions[window.attr('id')]['mode'] = mode;
            } else {
                if (options.mode === 'floating' &&
                window.css('position') === 'absolute') {
                    if (options.lastPosition) {
                        this._dropDocked(window);
                    } else {
                        this._panels[0].append(window);
                        this._dropFixer(window);
                    }
                }
            }
            this._windowOptions[window.attr('id')]['mode'] = mode;
        },

        hideCloseButton: function (window) {
            $('#' + window).jqxWindow('showCloseButton', false);
        },

        showCloseButton: function (window) {
            $('#' + window).jqxWindow('showCloseButton', true);
        },

        hideCollapseButton: function (window) {
            $('#' + window).jqxWindow('showCollapseButton', false);
        },

        showCollapseButton: function (window) {
            $('#' + window).jqxWindow('showCollapseButton', true);
        },

        expandWindow: function (window, duration) {
            $('#' + window).jqxWindow('expand', duration);
        },

        collapseWindow: function (window, duration) {
            $('#' + window).jqxWindow('collapse', duration);
        },

        setWindowProperty: function (window, propertyName, value) {
            $('#' + window).jqxWindow(propertyName, value);
        },

        getWindowProperty: function (window, propertyName) {
            return $('#' + window).jqxWindow(propertyName);
        },

        setWindowPosition: function (window, x, y) {
            var window = $('#' + window),
                options = this._getWindowOptions(window);
            if (options.mode === 'floating') {
                window.css('position', 'absolute');
                $(window).jqxWindow('move', x, y, null, false);
            }
        },

        hideAllCloseButtons: function () {
            for (var i = 0; i < this._windows.length; i += 1) {
                this._windows[i].jqxWindow('showCloseButton', false);
            }
        },

        hideAllCollapseButtons: function () {
            for (var i = 0; i < this._windows.length; i += 1) {
                this._windows[i].jqxWindow('showCollapseButton', false);
            }
        },

        showAllCloseButtons: function () {
            for (var i = 0; i < this._windows.length; i += 1) {
                this._windows[i].jqxWindow('showCloseButton', true);
            }
        },

        showAllCollapseButtons: function () {
            for (var i = 0; i < this._windows.length; i += 1) {
                this._windows[i].jqxWindow('showCollapseButton', true);
            }
        },

        pinWindow: function (window) {
            $('#' + window).jqxWindow('draggable', false);
        },

        unpinWindow: function (window) {
            $('#' + window).jqxWindow('draggable', true);
        },

        setDraggingMode: function (window) {
            var dockingWindow = $('#' + window);
            this._prepareForDragging(dockingWindow);
            dockingWindow.fadeTo(0, 1);
        },

        enableWindowResize: function (window) {
            window = $('#' + window);
            if (window.css('position') === 'absolute') {
                this._setWindowOption(window, 'resizable', true);
                window.jqxWindow('enableResize', true);
            }
        },

        disableWindowResize: function (window) {
            window = $('#' + window);
            this._setWindowOption(window, 'resizable', false);
            window.jqxWindow('enableResize', false);
        },

        addWindow: function (window, mode, panel, position) {
            var selector = '#' + window;
            $(selector).jqxWindow({ keyboardNavigation: false, rtl: this.rtl, theme: this.theme, enableResize: false, width: $(selector).css('width'), maxWidth: Number.MAX_VALUE });
            this._panels[0].append($(selector));
            this._windows.push($(selector));
            if (mode) {
                this._setWindowOption($(selector), 'mode', mode);
            } else {
                this._setWindowOption($(selector), 'mode', this.mode);
            }
            this._setWindowOption($(selector), 'resizable', true);
            this._setWindowOption($(selector), 'size', { width: $(selector).width(), height: $(selector).height() });
            if (mode == 'floating') {
                $(selector).jqxWindow({ enableResize: true });
            }
            else {
                $(selector).jqxWindow({ enableResize: false });
            }
            if (this._panels[panel] != null) {
                this._setWindowOption($(selector), 'size', { width: this._panels[panel].width(), height: this._panels[panel].height() });
            }

            this._addEventListenersTo($(selector));
            if (typeof panel !== 'undefined' && typeof position !== 'undefined') {
                this.move(window, panel, position);
            }
            this._dropFixer($(selector));
        },

        closeWindow: function (window) {
            $('#' + window).jqxWindow('closeWindow');
        }
    });
})(jQuery);(function ($) {

    $.jqx.jqxWidget("jqxDockPanel", "", {});

    $.extend($.jqx._jqxDockPanel.prototype, {

        defineInstance: function () {
            //Type: String.
            //Default: null.
            //Sets the dockpanel width.
            this.width = null;
            //Type: String.
            //Default: null.
            //Sets the dockpanel height.
            this.height = null;
            //Type: Boolean.
            //Default: true.
            this.lastchildfill = true;
            // gets or sets whether the progress bar is disabled.
            this.disabled = false;
            //  events.
            this.events =
			[
            // occurs when the layout is performed.
		  	   'layout'
     		];
        },

        // creates a new jqxDockPanel instance.
        createInstance: function (args) {
            var self = this;
            this.host
			.addClass(this.toThemeProperty("jqx-dockpanel"));
            this.host
            .addClass(this.toThemeProperty("jqx-rc-all"));

            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                this.host.width(this.width);
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    this.host.width(this.width);
                };

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                this.host.height(this.height);
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                this.host.height(this.height);
            };

            this.childrenCount = $(this.host).children().length;
            this.host.wrapInner('<div style="overflow: hidden; width: 100%; height: 100%;" class="innerContainer"></div>');
            this.$wrapper = this.host.find('.innerContainer');
            this.$wrapper.css('position', 'relative');
            this.sizeCache = new Array();

            this.performLayout();
            $(window).resize(function () {
                self.refresh();
            });
        },

        // clears cache and performs layout.
        render: function () {
            this.sizeCache = new Array();
            this.performLayout();
        },

        performLayout: function () {
            if (this.disabled) return;
            var childrenCount = this.childrenCount;
            var num5 = 0;
            var num6 = 0;
            var x = 0;
            var y = 0;
            var me = this;
            var arrangeSize = { width: this.host.width(), height: this.host.height() };

            if (this.sizeCache.length < this.$wrapper.children().length) {
                $.each(this.$wrapper.children(), function (index) {
                    var element = $(this);
                    element.css('position', 'absolute');
                    var size = { width: element.css('width'), height: element.css('height') };
                    me.sizeCache[index] = size;
                });
            }

            $.each(this.$wrapper.children(), function (index) {
                var dock = this.getAttribute('dock');
                if (dock == undefined) dock = 'left';
                if (index == childrenCount - 1 && me.lastchildfill) dock = 'fill';
                var element = $(this);
                element.css('position', 'absolute');
                element.css('width', me.sizeCache[index].width);
                element.css('height', me.sizeCache[index].height);
                var desiredSize = { width: element.outerWidth(), height: element.outerHeight() };
                var finalRect = { x: x, y: y, width: Math.max(0, arrangeSize.width - (x + num5)), height: Math.max(0, arrangeSize.height - (y + num6)) };
                if (index < childrenCount) {
                    switch (dock) {
                        case 'left':
                            x += desiredSize.width;
                            finalRect.width = desiredSize.width;
                            break;
                        case 'top':
                            y += desiredSize.height;
                            finalRect.height = desiredSize.height;
                            break;
                        case 'right':
                            num5 += desiredSize.width;
                            finalRect.x = Math.max(0, (arrangeSize.width - num5));
                            finalRect.width = desiredSize.width;
                            break;
                        case 'bottom':
                            num6 += desiredSize.height;
                            finalRect.y = Math.max(0, (arrangeSize.height - num6));
                            finalRect.height = desiredSize.height;
                            break;
                    }
                }

                element.css('left', finalRect.x);
                element.css('top', finalRect.y);
                element.css('width', finalRect.width);
                element.css('height', finalRect.height);
            });

            this._raiseevent(0);
        },

        destroy: function () {
            this.host.remove();
        },

        _raiseevent: function (id, oldValue, newValue) {
            if (this.isInitialized != undefined && this.isInitialized == true) {
                var evt = this.events[id];
                var event = new jQuery.Event(evt);
                event.previousValue = oldValue;
                event.currentValue = newValue;
                event.owner = this;
                var result = this.host.trigger(event);
                return result;
            }
        },

        propertyChangedHandler: function (object, key, oldValue, value) {
            if (!this.isInitialized)
                return;
        },

        refresh: function () {
            this.performLayout();
        }
    });
})(jQuery);

(function ($) {

    $.jqx.jqxWidget("jqxMaskedInput", "", {});

    $.extend($.jqx._jqxMaskedInput.prototype, {

        defineInstance: function () {
            //Type: String
            //Default: null
            //Sets the masked input's value.
            this.value = null;
            //Type: String.
            //Default: null.
            //Sets the masked input's mask.
            this.mask = "99999";
            //Type: Number.
            //Default: 0.
            //Sets width of the masked input in pixels. Only positive values have effect.
            this.width = null;
            //Type: Number.
            //Default: 0.
            //Sets height of the masked input in pixels. 
            this.height = 25;
            // Type: String
            // Sets the text alignment.
            this.textAlign = "left";
            // Type: Bool
            // Default: false
            // Sets the readOnly state of the input.
            this.readOnly = false,
            this.cookies = false;
            // Type: Char
            // Default: "_"
            // Sets the prompt char displayed when an editable char is empty.
            this.promptChar = "_";
            // Type: String
            // Default: advanced
            // Gets or sets the input mode. When the mode is simple, the text is formatted after editing. When the mode is advanced, the text is formatted while the user is in edit mode.
            // Available values: [simple, advanced]
            this.inputMode = 'advanced';
            this.rtl = false;
            this.disabled = false;
            this.events =
			[
		  	   'valuechanged', 'textchanged', 'mousedown', 'mouseup', 'keydown', 'keyup', 'keypress', 'change'
			];
            this.aria =
            {
                "aria-valuenow": { name: "value", type: "string" },
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
        },

        // creates the masked input's instance. 
        createInstance: function (args) {
            this.render();
        },

        render: function () {
            this.host
	        .attr({
	            role: "textbox"
	        });
            this.host.attr('data-role', 'input');
            var _val = this.host.attr('value');
            if (_val != undefined && _val != "") {
                this.value = _val;
            }

            $.jqx.aria(this);
            $.jqx.aria(this, "aria-multiline", false);
            $.jqx.aria(this, "aria-readonly", this.readOnly);

            this.host.addClass(this.toThemeProperty('jqx-input'));
            this.host.addClass(this.toThemeProperty('jqx-rc-all'));
            this.host.addClass(this.toThemeProperty('jqx-widget'));
            this.host.addClass(this.toThemeProperty('jqx-widget-content'));

            maskEditor = this;
            if (this.element.nodeName.toLowerCase() == "div") {
                this.element.innerHTML = "";
                this.maskbox = $("<input autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false' type='textarea'/>").appendTo(this.host);
            }
            else {
                this.maskbox = this.host;
                this.maskbox.attr('autocomplete', 'off');
                this.maskbox.attr('autocorrect', 'off');
                this.maskbox.attr('autocapitalize', 'off');
                this.maskbox.attr('spellcheck', false);
            }
            this.maskbox.addClass(this.toThemeProperty('jqx-reset'));
            this.maskbox.addClass(this.toThemeProperty('jqx-input-content'));
            this.maskbox.addClass(this.toThemeProperty('jqx-widget-content'));

            var name = this.host.attr('name');
            if (!name) name = this.element.id;
            this.maskbox.attr('name', name);
            if (this.rtl) {
                this.maskbox.addClass(this.toThemeProperty('jqx-rtl'));
            }

            var me = this;
            this.propertyChangeMap['disabled'] = function (instance, key, oldVal, value) {
                if (value) {
                    instance.maskbox.addClass(me.toThemeProperty('jqx-input-disabled'));
                }
                else {
                    instance.maskbox.removeClass(me.toThemeProperty('jqx-input-disabled'));
                }
            }

            if (this.disabled) {
                this.maskbox.addClass(this.toThemeProperty('jqx-input-disabled'));
                this.maskbox.attr("disabled", true);
                this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
            }

            this.selectedText = "";
            this.self = this;
            this.oldValue = this._value();
            this.items = new Array();
            this._initializeLiterals();
            this._render();

            if (this.value != null) {
                this.inputValue(this.value.toString());
            }

            var me = this;
            if (this.host.parents('form').length > 0) {
                this.host.parents('form').on('reset', function () {
                    setTimeout(function () {
                        me.clearValue();
                    }, 10);
                });
            }

            this.addHandlers();

            if (this.cookies) {
                var cookieResult = $.jqx.cookie.cookie("maskedInput." + this.element.id);
                if (cookieResult) {
                    this.val(cookieResult);
                }
            }
        },

        addHandlers: function()
        {
            var me = this;

            if ($.jqx.mobile.isTouchDevice()) {
                this.inputMode = "simple";
            }
            var oldVal = "";
            var doSimpleInput = function (event, key) {
                var letter = String.fromCharCode(key);
                var digit = parseInt(letter);
                var allowInput = true;

                if (!isNaN(digit)) {
                    allowInput = true;
                    var maxLength = this.maskbox.val().toString().length;
                    if (maxLength >= this._getEditStringLength() && this._selection().length == 0) {
                        allowInput = false;
                    }
                }

                if (!event.ctrlKey && !event.shiftKey) {
                    if (key >= 65 && key <= 90) {
                        allowInput = false;
                    }
                }

                return allowInput;
            }
        
            this.addHandler(this.maskbox, 'blur',
            function (event) {
                if (me.inputMode == 'simple') {
                    me._exitSimpleInputMode(event, me, false, oldVal);
                    return false;
                }
                if (me.rtl) {
                    me.maskbox.css('direction', 'ltr');
                }
                me.host.removeClass(me.toThemeProperty('jqx-fill-state-focus'));
                if (me.maskbox.val() != oldVal) {
                    me._raiseEvent(7, event);
                    if (me.cookies) {
                        $.jqx.cookie.cookie("maskedInput." + me.element.id, me.maskbox.val());
                    }
                }
            });

            this.addHandler(this.maskbox, 'focus',
            function (event) {
                oldVal = me.maskbox.val();
                if (me.inputMode == 'simple') {
                    me.maskbox[0].value = me._getEditValue();
                    $.data(me.maskbox, "simpleInputMode", true);
                    return false;
                }
                if (me.rtl) {
                    me.maskbox.css('direction', 'rtl');
                }

                me.host.addClass(me.toThemeProperty('jqx-fill-state-focus'));
            });

            this.addHandler(this.host, 'keydown', function (event) {
                var isreadOnly = me.readOnly;
                var key = event.charCode ? event.charCode : event.keyCode ? event.keyCode : 0;
                if (isreadOnly || me.disabled) {
                    return false;
                }
                if (me.inputMode != 'simple') {
                    var result = me._handleKeyDown(event, key);
                    if (!result) {
                        if (event.preventDefault) {
                            event.preventDefault();
                        }
                        if (event.stopPropagation) {
                            event.stopPropagation();
                        }
                    }
                    return result;
                }
                else {
                    return doSimpleInput.call(me, event, key);
                }
            });

            this.addHandler(this.host, 'keyup', function (event) {
                var isreadOnly = me.readOnly;
                var key = event.charCode ? event.charCode : event.keyCode ? event.keyCode : 0;
                if (isreadOnly || me.disabled) {
                    return true;
                }
                if (me.inputMode == 'simple') {
                    return doSimpleInput.call(me, event, key);
                }
                else {
                    if (event.preventDefault) {
                        event.preventDefault();
                    }
                    if (event.stopPropagation) {
                        event.stopPropagation();
                    }

                    return false;
                }
            });

            this.addHandler(this.host, 'keypress', function (event) {
                var isreadOnly = me.readOnly;
                var key = event.charCode ? event.charCode : event.keyCode ? event.keyCode : 0;
                if (isreadOnly || me.disabled) {
                    return true;
                }
                if (me.inputMode == 'simple') {
                    return doSimpleInput.call(me, event, key);
                }
                else {
                    var result = me._handleKeyPress(event, key);
                    if (!result) {
                        if (event.preventDefault) {
                            event.preventDefault();
                        }
                        if (event.stopPropagation) {
                            event.stopPropagation();
                        }
                    }
                    return result;
                }
            });      
        },

        focus: function () {
            try {
                this.maskbox.focus();
            }
            catch (error) {
            }
        },

        _exitSimpleInputMode: function (event, self, checkbounds, oldvalue) {
            if (self == undefined) {
                self = event.data;
            }

            if (self == null) return;

            if (checkbounds == undefined) {
                if (event.target != null && self.element != null) {
                    if ((event.target.id != undefined && event.target.id.toString().length > 0 && self.host.find('#' + event.target.id).length > 0) || event.target == self.element) {
                        return;
                    }
                }

                var offset = self.host.offset();
                var left = offset.left;
                var top = offset.top;
                var width = self.host.width();
                var height = self.host.height();

                var targetOffset = $(event.target).offset();
                if (targetOffset.left >= left && targetOffset.left <= left + width)
                    if (targetOffset.top >= top && targetOffset.top <= top + height) {
                        return;
                    }
            }

            if (self.disabled || self.readOnly)
                return;

            var enteredMode = $.data(self.maskbox, "simpleInputMode");
            if (enteredMode == null) return;

            var currentValue = self.maskbox.val();
            var data = currentValue.toString();
            var k = 0;
            for (var i = 0; i < this.items.length; i++) {
                if (this.items[i].canEdit) {
                    if (this._match(data.substring(k, k + 1), this.items[i].regex) || data.substring(k, k + 1) === "") {
                        k++;
                    }
                    else {
                        self.maskbox[0].value = oldvalue;
                        $.data(self.maskbox, "simpleInputMode", null);
                        return false;
                    }
                }
            }
        

            self.inputValue(currentValue, true);

            $.data(self.maskbox, "simpleInputMode", null);
            return false;
        },

        _getString: function () {
            var s = "";
            for (var i = 0; i < this.items.length; i++) {
                var character = this.items[i].character;
                if ((this.items[i].character == this.promptChar) && (this.promptChar != this.items[i].defaultCharacter)) {
                    s += this.items[i].defaultCharacter;
                }
                else {
                    s += character;
                }
            }

            return s;
        },

        _initializeLiterals: function () {
            if (this.mask == undefined || this.mask == null) {
                this.items = new Array();
                return;
            }

            this.mask = this.mask.toString();
            var length = this.mask.length;
            for (var i = 0; i < length; i++) {
                var character = this.mask.substring(i, i + 1);
                var regex = "";
                var canEdit = false;

                if (character == "[")
                {
                    for (var j = i; j < length; j++) {
                        var closingCharacter = this.mask.substring(j, j + 1);
                        if (closingCharacter == "]") {
                            break;
                        }
                    }
                    regex = "(" + this.mask.substring(i, j+1) + ")";
                    i = j;
                    canEdit = true;
                }

                if (character == "#") {
                    regex = "(\\d|[+]|[-])";
                    canEdit = true;
                }
                else if (character == "9" || character == "0") {
                    regex = "\\d";
                    canEdit = true;
                }
                else if (character == "$") {
                    canEdit = false;
                }
                else if (character == "/" || character == ":") {
                    canEdit = false;
                }
                else if (character == "A" || character == "a") {
                    regex = "\\w";
                    canEdit = true;
                }
                else if (character == "c" || character == "C") {
                    regex = ".";
                    canEdit = true;
                }
                else if (character == "L" || character == "l") {
                    regex = "\\p{L}";
                    canEdit = true;
                }

                var self = this;
                var literal = function (character, regex, canEdit) {
                    literal.character = character;
                    literal.regex = regex;
                    literal.canEdit = canEdit;
                    literal.defaultCharacter = self.promptChar;
                }

                if (canEdit) {
                    literal(this.promptChar, regex, canEdit);
                }
                else {
                    literal(character, regex, canEdit);
                }

                this.items.push(literal);
            }
        },

        setRegex: function (index, regex, canEdit, defaultCharacter) {
            if ((index == null || index == undefined) || (regex == null || regex == undefined))
                return;

            if (index < this.items.length) {
                this.items[index].regex = regex;
                if (canEdit != null && canEdit != undefined) {
                    this.items[index].canEdit = canEdit;
                }

                if (defaultCharacter != null && defaultCharacter != undefined) {
                    this.items[index].defaultCharacter = defaultCharacter;
                }
            }
        },

        _match: function (character, regex) {
            var regExpr = new RegExp(regex, "i");
            return regExpr.test(character);
        },

        _raiseEvent: function (id, arg) {
            var evt = this.events[id];
            var args = {};
            args.owner = this;

            var key = arg.charCode ? arg.charCode : arg.keyCode ? arg.keyCode : 0;
            var result = true;
            var isreadOnly = this.readOnly;
            var event = new jQuery.Event(evt);
            event.owner = this;
            args.value = this.inputValue();
            args.text = this.maskedValue();
            event.args = args;

            if (id < 2 || id > 6) {
                result = this.host.trigger(event);
            }

            return result;
        },

        
        _handleKeyPress: function (e, key) {
            var specialKey = this._isSpecialKey(key, e);
            return specialKey;
        },

        
        _insertKey: function (key) {
            var selection = this._selection();
            var rootElement = this;

            if (selection.start >= 0 && selection.start < this.items.length) {
                var letter = String.fromCharCode(key);
                var selectedTextDeleted = false
                $.each(this.items, function (i, value) {
                    if (i < selection.start) {
                        return;
                    }

                    var item = rootElement.items[i];
                    if (!item.canEdit) {
                        return;
                    }

                    if (rootElement._match(letter, item.regex)) {
                        if (!selectedTextDeleted && selection.length > 0) {
                            for (var j = selection.start; j < selection.end; j++) {
                                if (rootElement.items[j].canEdit) {
                                    rootElement.items[j].character = rootElement.promptChar;
                                }
                            }

                            var text = rootElement._getString();
                            rootElement.maskedValue(text);
                            selectedTextDeleted = true;
                        }

                        item.character = letter;
                        var text = rootElement._getString();
                        rootElement.maskedValue(text);

                        if (selection.start < rootElement.items.length) {
                            rootElement._setSelectionStart(i + 1);
                        }

                        return false;
                    }
                    else return false;
                });
            }
        },

        
        _deleteSelectedText: function () {
            var selection = this._selection();
            var deleted = false;

            if (selection.start > 0 || selection.length > 0) {
                for (i = selection.start; i < selection.end; i++) {
                    if (i < this.items.length && this.items[i].canEdit && this.items[i].character != this.promptChar) {
                        this.items[i].character = this.promptChar;
                        deleted = true;
                    }
                }

                var text = this._getString();
                this.maskedValue(text);
                return deleted;
            }
        },

        
        _saveSelectedText: function () {
            var selection = this._selection();
            var text = "";
            if (selection.start > 0 || selection.length > 0) {
                for (i = selection.start; i < selection.end; i++) {
                    if (this.items[i].canEdit) {
                        text += this.items[i].character;
                    }
                }
            }
            window.clipboardData.setData("Text", text);
            return text;
        },

        
        _pasteSelectedText: function () {
            var selection = this._selection();
            var text = "";
            var k = 0;
            var newSelection = selection.start;
            var clipboardText = window.clipboardData.getData("Text");
            if (clipboardText != this.selectedText && clipboardText.length > 0) {
                this.selectedText = clipboardText;
                if (this.selectedText == null || this.selectedText == undefined)
                    return;
            }

            if (selection.start >= 0 || selection.length > 0) {
                for (i = selection.start; i < this.items.length; i++) {
                    if (this.items[i].canEdit) {
                        if (k < this.selectedText.length) {
                            this.items[i].character = this.selectedText[k];
                            k++;
                            newSelection = 1 + i;
                        }
                    }
                }
            }

            var text = this._getString();
            this.maskedValue(text);

            if (newSelection < this.items.length) {
                this._setSelectionStart(newSelection);
            }
            else this._setSelectionStart(this.items.length);

        },

        _handleKeyDown: function (e, key) {
            var selection = this._selection();
            if (key >= 96 && key <= 105) {
                key = key - 48;
            }

            if ((e.ctrlKey && key == 97 /* firefox */) || (e.ctrlKey && key == 65) /* opera */) {
                return true;
            } // allow Ctrl+X (cut)
            if ((e.ctrlKey && key == 120 /* firefox */) || (e.ctrlKey && key == 88) /* opera */) {
                this.selectedText = this._saveSelectedText(e);
                this._deleteSelectedText(e);
                return false;
            }
            // allow Ctrl+C (copy)
            if ((e.ctrlKey && key == 99 /* firefox */) || (e.ctrlKey && key == 67) /* opera */) {
                this.selectedText = this._saveSelectedText(e);
                return false;
            }
            // allow Ctrl+Z (undo)
            if ((e.ctrlKey && key == 122 /* firefox */) || (e.ctrlKey && key == 90) /* opera */) return false;
            // allow or deny Ctrl+V (paste), Shift+Ins
            if ((e.ctrlKey && key == 118 /* firefox */) || (e.ctrlKey && key == 86) /* opera */
            || (e.shiftKey && key == 45)) {
                this._pasteSelectedText();
                return false;
            }
            if (selection.start >= 0 && selection.start < this.items.length) {
                var letter = String.fromCharCode(key);
                var item = this.items[selection.start];
            }

            // handle backspace.
            if (key == 8) {
                if (selection.length == 0) {
                    for (i = this.items.length - 1; i >= 0; i--) {
                        if (this.items[i].canEdit && i < selection.end && this.items[i].character != this.promptChar) {
                            this._setSelection(i, i + 1);
                            break;
                        }
                    }
                }

                selection = this._selection();
                var deletedText = this._deleteSelectedText();

                if (selection.start > 0 || selection.length > 0) {
                    if (selection.start <= this.items.length) {
                        if (deletedText) {
                            this._setSelectionStart(selection.start);
                        }
                        else this._setSelectionStart(selection.start - 1);
                    }
                }
                return false;
            }

            if (key == 190) {
                var start = selection.start;
                for (var i = start; i < this.items.length; i++) {
                    if (this.items[i].character == '.') {
                        this._setSelectionStart(i + 1);
                        break;
                    }
                }
            }
            if (key == 191) {
                var start = selection.start;
                for (var i = start; i < this.items.length; i++) {
                    if (this.items[i].character == '/') {
                        this._setSelectionStart(i + 1);
                        break;
                    }
                }
            }
            if (key == 189) {
                var start = selection.start;
                for (var i = start; i < this.items.length; i++) {
                    if (this.items[i].character == '-') {
                        this._setSelectionStart(i + 1);
                        break;
                    }
                }
            }
            // handle del.
            if (key == 46) {
                if (selection.length == 0) {
                    for (var i = 0; i < this.items.length; i++) {
                        if (this.items[i].canEdit && i >= selection.start && this.items[i].character != this.promptChar) {
                            this._setSelection(i, i + 1);
                            break;
                        }
                    }
                }

                var oldSelection = selection;
                selection = this._selection();
                var deleted = this._deleteSelectedText();
                if (selection.start >= 0 || selection.length >= 0) {
                    if (selection.start < this.items.length) {
                        if (selection.length <= 1) {
                            if (oldSelection.end != selection.end) {
                                this._setSelectionStart(selection.end);
                            }
                            else this._setSelectionStart(selection.end + 1);
                        }
                        else this._setSelectionStart(selection.start)
                    }
                }
                return false;
            }

            this._insertKey(key);

            var specialKey = this._isSpecialKey(key, e);

            return specialKey;
        },

        _isSpecialKey: function (key, event) {
            if (key == 189 /* dot */ ||
			key == 9 /* tab */ ||
			key == 13 /* enter */ ||
			key == 35 /* end */ ||
			key == 36 /* home */ ||
			key == 37 /* left */ ||
			key == 39 /* right */ ||
        	key == 46 /* del */
		    ) {
                return true;
            }
            if ((key === 16 && event.shiftKey) || event.ctrlKey) {
                return true;
            }
            return false;
        },

        _selection: function () {
            if ('selectionStart' in this.maskbox[0]) {
                var e = this.maskbox[0];
                var selectionLength = e.selectionEnd - e.selectionStart;
                return { start: e.selectionStart, end: e.selectionEnd, length: selectionLength, text: e.value };
            }
            else {
                var r = document.selection.createRange();
                if (r == null) {
                    return { start: 0, end: e.value.length, length: 0 }
                }

                var re = this.maskbox[0].createTextRange();
                var rc = re.duplicate();
                re.moveToBookmark(r.getBookmark());
                rc.setEndPoint('EndToStart', re);
                var selectionLength = r.text.length;

                return { start: rc.text.length, end: rc.text.length + r.text.length, length: selectionLength, text: r.text };
            }
        },

        _setSelection: function (start, end) {
            if ('selectionStart' in this.maskbox[0]) {
                this.maskbox[0].focus();
                this.maskbox[0].setSelectionRange(start, end);
            }
            else {
                var range = this.maskbox[0].createTextRange();
                range.collapse(true);
                range.moveEnd('character', end);
                range.moveStart('character', start);
                range.select();
            }
        },

        _setSelectionStart: function (start) {
            this._setSelection(start, start);
        },

        refresh: function (internalRefresh) {
            if (!internalRefresh) {
                this._render();
            }
        },

        _render: function () {
            var leftBorder = parseInt(this.host.css("border-left-width"));
            var rightBorder = parseInt(this.host.css("border-left-width"));
            var topBorder = parseInt(this.host.css("border-left-width"));
            var bottomBorder = parseInt(this.host.css("border-left-width"));

            var height = parseInt(this.host.css("height")) - topBorder - bottomBorder;
            var width = parseInt(this.host.css("width")) - leftBorder - rightBorder;
            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                width = this.width;
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    width = this.width;
                };

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                height = this.height;
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                height = this.height;
            };

            width = parseInt(width);
            height = parseInt(height);

            if (this.maskbox[0] != this.element) {
                this.maskbox.css({
                    "border-left-width": 0,
                    "border-right-width": 0,
                    "border-bottom-width": 0,
                    "border-top-width": 0
                });
            }

            this.maskbox.css("text-align", this.textAlign);
            var fontSize = this.maskbox.css("font-size");

            if (!isNaN(height)) {
                this.maskbox.css('height', parseInt(fontSize) + 4 + 'px');
            }

            if (!isNaN(width)) {
                this.maskbox.css('width', width - 2);
            }

            var top = parseInt(height) - 2 * parseInt(topBorder) - 2 * parseInt(bottomBorder) - parseInt(fontSize);
            if (isNaN(top)) top = 0;

            if (!isNaN(height)) {
                this.host.height(height);
            }
            if (!isNaN(width)) {
                this.host.width(width);
            }
            if (this.maskbox[0] != this.element) {

                var topPadding = top / 2;

                // fix for MSIE 6 and 7. These browsers double the top padding for some reason...
                if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                    topPadding = top / 4;
                }

                this.maskbox.css("padding-right", '0px');
                this.maskbox.css("padding-left", '0px');
                this.maskbox.css("padding-top", topPadding);
                this.maskbox.css("padding-bottom", top / 2);
            }
            this.maskbox[0].value = this._getString();

            if (this.width) {
                if (this.width.toString().indexOf('%') >= 0) {
                    this.element.style.width = this.width;
                }
                if (this.height.toString().indexOf('%') >= 0) {
                    this.element.style.height = this.height;
                }
            }
        },

        destroy: function () {
            this.host.remove();
        },

        // gets or sets the input's value.
        maskedValue: function (newValue) {
            if (newValue === undefined) {
                return this._value();
            }

            this.value = newValue;
            this._refreshValue();

            if (this.oldValue !== newValue) {
                this._raiseEvent(1, newValue);
                this.oldValue = newValue;
                this._raiseEvent(0, newValue);
            }

            return this;
        },

        // sets the input's value.
        _value: function () {
            var value = this.maskbox.val();
            return value;
        },

        // sets a property.
        propertyChangedHandler: function (object, key, oldValue, value) {
            if (this.isInitialized == undefined || this.isInitialized == false)
                return;

            if (key == "rtl") {
                if (object.rtl) {
                    object.maskbox.addClass(object.toThemeProperty('jqx-rtl'));
                }
                else {
                    object.maskbox.removeClass(object.toThemeProperty('jqx-rtl'));
                }
            }

            if (key === "value") {
                if (value == undefined || value == null) value = '';
                if (value === "") {
                    this.clear();
                }
                else {
                    value = value.toString();
                    this.inputValue(value);
                }
            }

            if (key === 'theme') {
                $.jqx.utilities.setTheme(oldValue, value, this.host);
            }

            if (key == 'disabled') {
                if (value) {
                    object.maskbox.addClass(object.toThemeProperty('jqx-input-disabled'));
                    object.host.addClass(object.toThemeProperty('jqx-fill-state-disabled'));
                    object.maskbox.attr("disabled", true);
                }
                else {
                    object.host.removeClass(this.toThemeProperty('jqx-fill-state-disabled'));
                    object.host.removeClass(this.toThemeProperty('jqx-input-disabled'));
                    object.maskbox.attr("disabled", false);
                }
                $.jqx.aria(object, "aria-disabled", value);
            }

            if (key == "readOnly") {
                this.readOnly = value;
            }

            if (key == "promptChar") {
                for (i = 0; i < object.items.length; i++) {
                    if (object.items[i].character == object.promptChar) {
                        object.items[i].character = value;
                        object.items[i].defaultCharacter = value;
                    }
                }

                object.promptChar = value;
            }

            if (key == "textAlign") {
                object.maskbox.css("text-align", value);
                object.textAlign = value;
            }

            if (key == "mask") {
                object.mask = value;
                object.items = new Array();
                object._initializeLiterals();
                object.value = object._getString();
                object._refreshValue();
            }
            if (key == "width") {
                object.width = value;
                object._render();
            }
            else if (key == "height") {
                object.height = value;
                object._render();
            }
        },

        // gets the input's value.
        _value: function () {
            var val = this.value;
            return val;
        },
      
        _getEditStringLength: function () {
            var value = '';
            for (i = 0; i < this.items.length; i++) {
                if (this.items[i].canEdit) {
                    value += this.items[i].character;
                }
            }

            return value.length;
        },
     
        _getEditValue: function () {
            var value = '';
            for (i = 0; i < this.items.length; i++) {
                if (this.items[i].canEdit && this.items[i].character != this.promptChar) {
                    value += this.items[i].character;
                }
            }

            return value;
        },
       
        parseValue: function (value) {
            if (value == undefined || value == null)
                return null;

            var input = value.toString();
            var newValue = '';
            var x = 0;
            for (m = 0; m < input.length; m++) {
                var data = input.substring(m, m + 1);

                for (i = x; i < this.items.length; i++) {
                    if (this.items[i].canEdit && this._match(data, this.items[i].regex)) {
                        newValue += data;
                        x = i;
                        break;
                    }
                }
            }

            return newValue;
        },

        clear: function () {
            this.clearValue();
        },

        // deprecated. to be removed in the next version.
        clearValue: function () {
            this.inputValue("", true);
        },

        val: function (data) {
            if (data != undefined && typeof data != 'object') {
                this.maskedValue(data);
            }

            return this.maskbox[0].value;
        },

        // gets or sets the editable input value.
        inputValue: function (data, fullRefresh) {
            if (data == undefined || data == null) {
                var value = "";
                for (var i = 0; i < this.items.length; i++) {
                    if (this.items[i].canEdit) {
                        value += this.items[i].character;
                    }
                }

                return value;
            }
            else {
                var k = 0;
                data = data.toString();

                for (var i = 0; i < this.items.length; i++) {
                    if (this.items[i].canEdit) {
                        if (this._match(data.substring(k, k + 1), this.items[i].regex)) {
                            this.items[i].character = data.substring(k, k + 1);
                            k++;
                        }
                        else if (fullRefresh) {
                            this.items[i].character = this.promptChar;
                        }
                    }
                }

                var newString = this._getString();
                this.maskedValue(newString);

                return this.inputValue();
            }
        },

        // applies the value to the input.
        _refreshValue: function () {
            var value = this.maskedValue();
            var k = 0;
            for (var i = 0; i < this.items.length; i++) {
                if (value.length > k) {
                    if (this.items[i].canEdit && this.items[i].character != value[k]) {
                        if (this._match(value[k], this.items[i].regex) && value[k].length == 1) {
                            this.items[i].character = value[k];
                        }
                    }
                    k++;
                }
            }

            this.value = this._getString();
            value = this.value;
            this.maskbox[0].value = value;
            $.jqx.aria(this, "aria-valuenow", value);
        }
    });
})(jQuery);
﻿
(function ($) {

    $.jqx.jqxWidget("jqxMenu", "", {});

    $.extend($.jqx._jqxMenu.prototype, {
        defineInstance: function () {
            //Type: Array
            //Gets the menu's items.
            this.items = new Array();
            //Type: String.
            //Default: 'horizontal'.
            //Gets or sets the menu's display mode. 
            //Possible Values: 'horizontal', 'vertical', 'popup' 
            this.mode = 'horizontal';
            //Type: Number.
            //Default: null.
            //Sets the width.
            this.width = null;
            //Type: Number.
            //Default: null.
            //Sets the height.
            this.height = null;
            //Type: String.
            //Default: easeInOutSine.
            //Gets or sets the animation's easing to one of the JQuery's supported easings.         
            this.easing = 'easeInOutSine';
            //Type: Number.
            //Default: 500.
            //Gets or sets the duration of the show animation.         
            this.animationShowDuration = 200;
            //Type: Number.
            //Default: 'fast'.
            //Gets or sets the duration of the hide animation.
            this.animationHideDuration = 200;
            // Type: Number
            // Default: 0
            // Gets or sets whether the menu is automatically closed after a period of time.
            this.autoCloseInterval = 0;
            //Type: Number.
            //Default: 500.
            //Gets or sets the delay before the start of the hide animation.
            this.animationHideDelay = 100;
            //Type: Number.
            //Default: 200.
            //Gets or sets the delay before the start of the show animation.            
            this.animationShowDelay = 100;
            //Type: Array.
            this.menuElements = new Array();
            //Type: Boolean.
            //Default: true.
            //Auto-Sizes the Menu's main items when the menu's mode is 'horizontal'.
            this.autoSizeMainItems = false;
            //Type: Boolean.
            //Default: true.
            //Automatically closes the opened popups after a click.
            this.autoCloseOnClick = true;
            //Type: Boolean.
            //Default: true.
            //Automatically closes the opened popups after mouse leave.
            this.autoCloseOnMouseLeave = true;
            //Type: Boolean.
            //Default: true.
            //Enables or disables the rounded corners.
            this.enableRoundedCorners = true;
            //Type: Boolean.
            //Default: true.
            //Enables or disables the Menu.
            this.disabled = false;
            //Type: Boolean.
            //Default: true.
            //Opens the Context Menu when the right-mouse button is pressed.
            //When this property is set to false, the Open and Close functions can be used to open and close 
            //the Context Menu.
            this.autoOpenPopup = true;
            // Type: Boolean
            // Default: true
            // enables or disables the hover state.
            this.enableHover = true;
            // Type: Boolean
            // Default: true
            // opens the top level menu items when the user hovers them.
            this.autoOpen = true;
            // Type: Boolean
            // Default: false
            // When this property is true, the menu is auto generated using all of ul and li tags inside the host.
            this.autoGenerate = true;
            // Type: Boolean
            // Default: false
            // opens an item after a click by the user.
            this.clickToOpen = false;
            // Type: Boolean
            // Default: false
            // shows the top-level item arrows in the default horizontal menu mode.
            this.showTopLevelArrows = false;
            // Sets whether the menu is on touch device.
            this.touchMode = 'auto';
            // Sets menu's source.
            this.source = null;
            this.popupZIndex = 20000;
            this.rtl = false;
            // Menu events.
            this.events =
		    [
                'shown', 'closed', 'itemclick', 'initialized'
            ];
        },

        createInstance: function (args) {
            var self = this;
            //    this.host.css('visibility', 'hidden');
            this.host.css('display', 'block');
            this.host.attr('role', 'menubar');
            this.propertyChangeMap['disabled'] = function (instance, key, oldVal, value) {
                if (self.disabled) {
                    self.host.addClass(self.toThemeProperty('jqx-fill-state-disabled'));
                    self.host.addClass(self.toThemeProperty('jqx-menu-disabled'));
                }
                else {
                    self.host.removeClass(self.toThemeProperty('jqx-fill-state-disabled'));
                    self.host.removeClass(self.toThemeProperty('jqx-menu-disabled'));
                }
            }

            var percentageSize = false;
            var me = this;
            if (me.width != null && me.width.toString().indexOf("%") != -1) {
                percentageSize = true;
            }

            if (me.height != null && me.height.toString().indexOf("%") != -1) {
                percentageSize = true;
            }

            $.jqx.utilities.resize(this.host, function () {
                me.refresh();
            });

            if (this.disabled) {
                this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
                this.host.addClass(this.toThemeProperty('jqx-menu-disabled'));
            }

            this.host.css('outline', 'none');

            if (this.source) {
                if (this.source != null) {
                    var html = this.loadItems(this.source);
                    this.element.innerHTML = html;
                }
            }

            if (this.element.innerHTML.indexOf('UL')) {
                var innerElement = this.host.find('ul:first');
                if (innerElement.length > 0) {
                    this._createMenu(innerElement[0]);
                }
            }

            this.host.data('autoclose', {});

            this._render();
            this.setSize();
            var me = this;
            //   this.host.css('visibility', 'visible');
            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                this.host.attr('hideFocus', true);
            }
        },

        focus: function()
        {
            try
            {
                this.host.focus();
            }
            catch (error) {
            }
        },

        loadItems: function (items, subMenuWidth) {
            if (items == null) {
                return;
            }
            if (items.length == 0) return "";

            var self = this;
            this.items = new Array();
            var html = '<ul>';
            if (subMenuWidth) {
                html = '<ul style="width:' + subMenuWidth + ';">';
            }

            $.map(items, function (item) {
                if (item == undefined)
                    return null;

                html += self._parseItem(item);
            });

            html += '</ul>';
            return html;
        },

        _parseItem: function (item) {
            var html = "";

            if (item == undefined)
                return null;

            var label = item.label;
            if (!item.label && item.html) {
                label = item.html;
            }
            if (!label) {
                label = "Item";
            }

            if (typeof item === 'string') {
                label = item;
            }

            var selected = false;
            if (item.selected != undefined && item.selected) {
                selected = true;
            }

            var disabled = false;
            if (item.disabled != undefined && item.disabled) {
                disabled = true;
            }

            html += '<li';

            if (disabled) {
                html += ' item-disabled="true" ';
            }

            if (item.label && !item.html) {
                html += ' item-label="' + label + '" ';
            }

            if (item.value != null) {
                html += ' item-value="' + item.value + '" ';
            }

            if (item.id != undefined) {
                html += ' id="' + item.id + '" ';
            }

            html += '>' + label;

            if (item.items) {
                if (item.subMenuWidth) {
                    html += this.loadItems(item.items, item.subMenuWidth);
                }
                else {
                    html += this.loadItems(item.items);
                }
            }

            html += '</li>';
            return html;
        },

        setSize: function () {
            if (this.width != null && this.width.toString().indexOf("%") != -1) {
                this.host.width(this.width);
            }
            else if (this.width != null && this.width.toString().indexOf("px") != -1) {
                this.host.width(this.width);
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    this.host.width(this.width);
                };

            if (this.height != null && this.height.toString().indexOf("%") != -1) {
                this.host.height(this.height);
            }
            else if (this.height != null && this.height.toString().indexOf("px") != -1) {
                this.host.height(this.height);
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                this.host.height(this.height);
            };
            if (this.height === null) {
                this.host.height('auto');
            }
        },

        isTouchDevice: function () {
            if (this._isTouchDevice != undefined) return this._isTouchDevice;
            var isTouchDevice = $.jqx.mobile.isTouchDevice();
            if (this.touchMode == true) {
                isTouchDevice = true;
            }
            else if (this.touchMode == false) {
                isTouchDevice = false;
            }
            if (isTouchDevice) {
                this.host.addClass(this.toThemeProperty('jqx-touch'));
                $(".jqx-menu-item").addClass(this.toThemeProperty('jqx-touch'));
            }
            this._isTouchDevice = isTouchDevice;
            return isTouchDevice;
        },

        refresh: function (initialRefresh) {
            if (!initialRefresh) {
                this.setSize();
            }
        },

        _closeAll: function (e) {
            var me = e != null ? e.data : this;
            var items = me.items;
            $.each(items, function () {
                var item = this;
                if (item.hasItems == true) {
                    if (item.isOpen) {
                        me._closeItem(me, item);
                    }
                }
            });

            if (me.mode == 'popup') {
                if (e != null) {
                    var rightclick = me._isRightClick(e);
                    if (!rightclick) {
                        me.close();
                    }
                }
            }
        },

        // @param id
        // closes a menu item by id.
        closeItem: function (id) {
            if (id == null)
                return false;
            var theId = id;
            var element = document.getElementById(theId);
            var me = this;

            $.each(me.items, function () {
                var item = this;
                if (item.isOpen == true && item.element == element) {
                    me._closeItem(me, item);
                    if (item.parentId) {
                        me.closeItem(item.parentId);
                    }
                }
            });

            return true;
        },

        // @param id
        // opens a menu item by id.
        openItem: function (id) {
            if (id == null)
                return false;

            var theId = id;
            var element = document.getElementById(theId);
            var me = this;
            $.each(me.items, function () {
                var item = this;
                if (item.isOpen == false && item.element == element) {
                    me._openItem(me, item);
                    if (item.parentId) {
                        me.openItem(item.parentId);
                    }
                }
            });

            return true;
        },

        _getClosedSubMenuOffset: function (item) {
            var $submenu = $(item.subMenuElement);
            var top = -$submenu.outerHeight();
            var left = -$submenu.outerWidth();
            var isTopItem = item.level == 0 && this.mode == 'horizontal';
            if (isTopItem) {
                left = 0;
            }
            else {
                top = 0;
            }

            switch (item['openVerticalDirection']) {
                case 'up':
                case 'center':
                    top = $submenu.outerHeight();
                    break;
            }

            switch (item['openHorizontalDirection']) {
                case this._getDir('left'):
                    if (isTopItem) {
                        left = 0;
                    }
                    else {
                        left = $submenu.outerWidth();
                    }
                    break;
                case 'center':
                    if (isTopItem) {
                        left = 0;
                    }
                    else {
                        left = $submenu.outerWidth();
                    }
                    break;
            }
            return { left: left, top: top };
        },

        //[optimize]
        _closeItem: function (me, item, subs, force) {
            if (me == null || item == null)
                return false;

            var $submenu = $(item.subMenuElement);
          
            var isTopItem = item.level == 0 && this.mode == 'horizontal';
            var subMenuOffset = this._getClosedSubMenuOffset(item);
            var top = subMenuOffset.top;
            var left = subMenuOffset.left;

            $menuElement = $(item.element);
            var $popupElement = $submenu.closest('div.jqx-menu-popup');
            if ($popupElement != null) {
                var delay = me.animationHideDelay;
                if (force == true) {
                    //     clearTimeout($submenu.data('timer').hide);
                    delay = 0;
                }

                if ($submenu.data('timer').show != null) {
                    clearTimeout($submenu.data('timer').show);
                    $submenu.data('timer').show = null;
                }

                var hideFunc = function () {
                    item.isOpen = false;
                    if (!$.jqx.browser.msie && this.animationtype == 'fade') {
                        //         $popupElement.css('opacity', 1.0);
                    }

                    if (isTopItem) {
                        if (!$.jqx.browser.msie) {
                            //           $popupElement.stop().animate({ opacity: 0 }, me.animationHideDuration, function () {
                            //         });
                        }

                        $submenu.stop().animate({ top: top }, me.animationHideDuration, function () {
                            $(item.element).removeClass(me.toThemeProperty('jqx-fill-state-pressed'));
                            $(item.element).removeClass(me.toThemeProperty('jqx-menu-item-top-selected'));
                            var $arrowSpan = $(item.arrow);
                            if ($arrowSpan.length > 0 && me.showTopLevelArrows) {
                                $arrowSpan.removeClass();
                                if (item.openVerticalDirection == 'down') {
                                    $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-down'));
                                }
                                else {
                                    $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-up'));
                                }
                            }
                            $.jqx.aria($(item.element), 'aria-expanded', false);

                            $popupElement.css({ display: 'none' });
                            if (me.animationHideDuration == 0) {
                                $submenu.css({ top: top });
                            }
                            me._raiseEvent('1', item);
                        })
                    }
                    else {
                        if (!$.jqx.browser.msie) {
                            //       $popupElement.stop().animate({ opacity: 0 }, me.animationHideDuration, function () {
                            //         });
                        }

                        $submenu.stop().animate({ left: left }, me.animationHideDuration, function () {
                            if (me.animationHideDuration == 0) {
                                $submenu.css({ left: left });
                            }

                            if (item.level > 0) {
                                $(item.element).removeClass(me.toThemeProperty('jqx-fill-state-pressed'));
                                $(item.element).removeClass(me.toThemeProperty('jqx-menu-item-selected'));
                                var $arrowSpan = $(item.arrow);
                                if ($arrowSpan.length > 0) {
                                    $arrowSpan.removeClass();
                                    if (item.openHorizontalDirection != 'left') {
                                        $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-' + me._getDir('right')));
                                    }
                                    else {
                                        $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-' + me._getDir('left')));
                                    }
                                }
                            }
                            else {
                                $(item.element).removeClass(me.toThemeProperty('jqx-fill-state-pressed'));
                                $(item.element).removeClass(me.toThemeProperty('jqx-menu-item-top-selected'));
                                var $arrowSpan = $(item.arrow);
                                if ($arrowSpan.length > 0) {
                                    $arrowSpan.removeClass();
                                    if (item.openHorizontalDirection != 'left') {
                                        $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-top-' + me._getDir('right')));
                                    }
                                    else {
                                        $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-top-' + me._getDir('left')));
                                    }
                                }
                            }
                            $.jqx.aria($(item.element), 'aria-expanded', false);
                            $popupElement.css({ display: 'none' })
                            me._raiseEvent('1', item);
                        })
                    }
                }

                if (delay > 0) {
                    $submenu.data('timer').hide = setTimeout(function () {
                        hideFunc();
                    }, delay);
                }
                else {
                    hideFunc();
                }

                if (subs != undefined && subs) {
                    var children = $submenu.children();// find('.' + me.toThemeProperty('jqx-menu-item'));
                    $.each(children, function () {
                        if (me.menuElements[this.id] && me.menuElements[this.id].isOpen) {
                            var $submenu = $(me.menuElements[this.id].subMenuElement);
                            me._closeItem(me, me.menuElements[this.id], true, true);
                        }
                    });
                }
            }
        },

        // @param id
        // @param array.
        // get menu item's sub items.
        getSubItems: function (id, array) {
            if (id == null)
                return false;

            var me = this;
            var subItems = new Array();
            if (array != null) {
                $.extend(subItems, array);
            }

            var theId = id;
            var item = this.menuElements[theId];
            var $submenu = $(item.subMenuElement);
            var children = $submenu.find('.jqx-menu-item');
            $.each(children, function () {
                subItems[this.id] = me.menuElements[this.id];
                var innerArray = me.getSubItems(this.id, subItems);
                $.extend(subItems, innerArray);
            });

            return subItems;
        },

        // disables a menu item.
        // @param id
        // @param Boolean
        disable: function (id, disable) {
            if (id == null)
                return;
            var theId = id;
            var me = this;
            if (this.menuElements[theId]) {
                var item = this.menuElements[theId];
                item.disabled = disable;
                var $element = $(item.element);
                item.element.disabled = disable;
                $.each($element.children(), function () {
                    this.disabled = disable;
                });

                if (disable) {
                    $element.addClass(me.toThemeProperty('jqx-menu-item-disabled'));
                    $element.addClass(me.toThemeProperty('jqx-fill-state-disabled'));
                }
                else {
                    $element.removeClass(me.toThemeProperty('jqx-menu-item-disabled'));
                    $element.removeClass(me.toThemeProperty('jqx-fill-state-disabled'));
                }
            }
        },

        _setItemProperty: function (id, propertyname, value) {
            if (id == null)
                return;

            var theId = id;
            var me = this;

            if (this.menuElements[theId]) {
                var item = this.menuElements[theId];
                if (item[propertyname]) {
                    item[propertyname] = value;
                }
            }
        },

        // sets the open direction of an item.
        // @param id
        // @param String
        // @param String
        setItemOpenDirection: function (id, horizontal, vertical) {
            if (id == null)
                return;
            var theId = id;
            var me = this;
            var ie7 = $.jqx.browser.msie && $.jqx.browser.version < 8;

            if (this.menuElements[theId]) {
                var item = this.menuElements[theId];
                if (horizontal != null) {
                    item['openHorizontalDirection'] = horizontal;
                    if (item.hasItems && item.level > 0) {
                        var $element = $(item.element);
                        if ($element != undefined) {
                            var $arrowSpan = $(item.arrow);
                            if (item.arrow == null) {
                                $arrowSpan = $('<span id="arrow' + $element[0].id + '"></span>');
                                if (!ie7) {
                                    $arrowSpan.prependTo($element);
                                }
                                else {
                                    $arrowSpan.appendTo($element);
                                }
                                item.arrow = $arrowSpan[0];
                            }
                            $arrowSpan.removeClass();
                            if (item.openHorizontalDirection == 'left') {
                                $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-' + me._getDir('left')));
                            }
                            else {
                                $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-' + me._getDir('right')));
                            }
                            $arrowSpan.css('visibility', 'visible');

                            if (!ie7) {
                                $arrowSpan.css('display', 'block');
                                $arrowSpan.css('float', 'right');
                            }
                            else {
                                $arrowSpan.css('display', 'inline-block');
                                $arrowSpan.css('float', 'none');
                            }
                        }
                    }
                }
                if (vertical != null) {
                    item['openVerticalDirection'] = vertical;
                    var $arrowSpan = $(item.arrow);
                    var $element = $(item.element);
                    if (!me.showTopLevelArrows) {
                        return;
                    }

                    if ($element != undefined) {
                        if (item.arrow == null) {
                            $arrowSpan = $('<span id="arrow' + $element[0].id + '"></span>');
                            if (!ie7) {
                                $arrowSpan.prependTo($element);
                            }
                            else {
                                $arrowSpan.appendTo($element);
                            }
                            item.arrow = $arrowSpan[0];
                        }
                        $arrowSpan.removeClass();
                        if (item.openVerticalDirection == 'down') {
                            $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-down'));
                        }
                        else {
                            $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-up'));
                        }
                        $arrowSpan.css('visibility', 'visible');
                        if (!ie7) {
                            $arrowSpan.css('display', 'block');
                            $arrowSpan.css('float', 'right');
                        }
                        else {
                            $arrowSpan.css('display', 'inline-block');
                            $arrowSpan.css('float', 'none');

                        }
                    }
                }
            }
        },

        //[optimize]
        _getSiblings: function (item) {
            var siblings = new Array();
            var index = 0;
            for (i = 0; i < this.items.length; i++) {
                if (this.items[i] == item)
                    continue;

                if (this.items[i].parentId == item.parentId && this.items[i].hasItems) {
                    siblings[index++] = this.items[i];
                }
            }
            return siblings;
        },

        //[optimize]
        _openItem: function (me, item, zIndex) {
            if (me == null || item == null)
                return false;

            if (item.isOpen)
                return false;

            if (item.disabled)
                return false;

            if (me.disabled)
                return false;
            var zIndx = me.popupZIndex;
            if (zIndex != undefined) {
                zIndx = zIndex;
            }

            var hideDuration = me.animationHideDuration;
            me.animationHideDuration = 0;
            me._closeItem(me, item, true, true);
            me.animationHideDuration = hideDuration;

            this.host.focus();

            var popupElementoffset = [5, 5];
            var $submenu = $(item.subMenuElement);
            if ($submenu != null) {
                $submenu.stop();
            }
            // stop hiding process.
            if ($submenu.data('timer').hide != null) {
                clearTimeout($submenu.data('timer').hide);
                //      $submenu.data('timer').hide = null;
            }
            var $popupElement = $submenu.closest('div.jqx-menu-popup');
            var $menuElement = $(item.element);
            var offset = item.level == 0 ? this._getOffset(item.element) : $menuElement.position()

            if (item.level > 0 && this.hasTransform) {
                var topTransform = parseInt($menuElement.coord().top) - parseInt(this._getOffset(item.element).top);
                offset.top += topTransform;
            }

            if (item.level == 0 && this.mode == 'popup') {
                offset = $menuElement.coord();
            }

            var isTopItem = item.level == 0 && this.mode == 'horizontal';

            var menuItemLeftOffset = isTopItem ? offset.left : this.menuElements[item.parentId] != null && this.menuElements[item.parentId].subMenuElement != null ? parseInt($($(this.menuElements[item.parentId].subMenuElement).closest('div.jqx-menu-popup')).outerWidth()) - popupElementoffset[0]
            : parseInt($submenu.outerWidth());

            $popupElement.css({ visibility: 'visible', display: 'block', left: menuItemLeftOffset, top: isTopItem ? offset.top + $menuElement.outerHeight() : offset.top, zIndex: zIndx })
            $submenu.css('display', 'block');

            if (this.mode != 'horizontal' && item.level == 0) {
                var hostOffset = this._getOffset(this.element)
                $popupElement.css('left', -1 + hostOffset.left + this.host.outerWidth());

                //          $popupElement.css('left', -2 + offset.left + this.host.width() - popupElementoffset[0]);
                $submenu.css('left', -$submenu.outerWidth());
            }
            else {
                var subMenuOffset = this._getClosedSubMenuOffset(item);
                $submenu.css('left', subMenuOffset.left);
                $submenu.css('top', subMenuOffset.top);
            }

            $popupElement.css({ height: parseInt($submenu.outerHeight()) + parseInt(popupElementoffset[1]) + 'px' });

            var top = 0;
            var left = 0;

            switch (item['openVerticalDirection']) {
                case 'up':
                    if (isTopItem) {
                        $submenu.css('top', $submenu.outerHeight());
                        top = popupElementoffset[1];
                        var paddingBottom = parseInt($submenu.parent().css('padding-bottom'));
                        if (isNaN(paddingBottom)) paddingBottom = 0;
                        if (paddingBottom > 0) {
                            $popupElement.addClass(this.toThemeProperty('jqx-menu-popup-clear'));
                        }

                        $submenu.css('top', $submenu.outerHeight() - paddingBottom);
                        $popupElement.css({ display: 'block', top: offset.top - $popupElement.outerHeight(), zIndex: zIndx })
                    }
                    else {
                        top = popupElementoffset[1];
                        $submenu.css('top', $submenu.outerHeight());
                        $popupElement.css({ display: 'block', top: offset.top - $popupElement.outerHeight() + popupElementoffset[1] + $menuElement.outerHeight(), zIndex: zIndx })
                    }
                    break;
                case 'center':
                    if (isTopItem) {
                        $submenu.css('top', 0);
                        $popupElement.css({ display: 'block', top: offset.top - $popupElement.outerHeight() / 2 + popupElementoffset[1], zIndex: zIndx })
                    }
                    else {
                        $submenu.css('top', 0);
                        $popupElement.css({ display: 'block', top: offset.top + $menuElement.outerHeight() / 2 - $popupElement.outerHeight() / 2 + popupElementoffset[1], zIndex: zIndx })
                    }

                    break;
            }

            switch (item['openHorizontalDirection']) {
                case this._getDir('left'):
                    if (isTopItem) {
                        $popupElement.css({ left: offset.left - ($popupElement.outerWidth() - $menuElement.outerWidth() - popupElementoffset[0]) });
                    }
                    else {
                        left = 0;
                        $submenu.css('left', $popupElement.outerWidth());
                        $popupElement.css({ left: offset.left - ($popupElement.outerWidth()) + 2*item.level });
                    }
                    break;
                case 'center':
                    if (isTopItem) {
                        $popupElement.css({ left: offset.left - ($popupElement.outerWidth() / 2 - $menuElement.outerWidth() / 2 - popupElementoffset[0] / 2) });
                    }
                    else {
                        $popupElement.css({ left: offset.left - ($popupElement.outerWidth() / 2 - $menuElement.outerWidth() / 2 - popupElementoffset[0] / 2) });
                        $submenu.css('left', $popupElement.outerWidth());
                    }
                    break;
            }

            if (isTopItem) {
                if (parseInt($submenu.css('top')) == top) {
                    item.isOpen = true;
                    return;
                }
            }
            else if (parseInt($submenu.css('left')) == left) {
                item.isOpen == true;
                return;
            }

            $.each(me._getSiblings(item), function () {
                me._closeItem(me, this, true, true);
            });
            var hideDelay = $.data(me.element, 'animationHideDelay');
            me.animationHideDelay = hideDelay;


            if (this.autoCloseInterval > 0) {
                if (this.host.data('autoclose') != null && this.host.data('autoclose').close != null) {
                    clearTimeout(this.host.data('autoclose').close);
                }

                if (this.host.data('autoclose') != null) {
                    this.host.data('autoclose').close = setTimeout(function () {
                        me._closeAll();
                    }, this.autoCloseInterval);
                }
            }

            $submenu.data('timer').show = setTimeout(function () {
                if ($popupElement != null) {
                    if (isTopItem) {
                        $submenu.stop();
                        $submenu.css('left', left);
                        if (!$.jqx.browser.msie) {
                            //      $popupElement.css('opacity', 0.0);
                        }

                        $menuElement.addClass(me.toThemeProperty('jqx-fill-state-pressed'));
                        $menuElement.addClass(me.toThemeProperty('jqx-menu-item-top-selected'));
                        var $arrowSpan = $(item.arrow);
                        if ($arrowSpan.length > 0 && me.showTopLevelArrows) {
                            $arrowSpan.removeClass();
                            if (item.openVerticalDirection == 'down') {
                                $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-down-selected'));
                            }
                            else {
                                $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-up-selected'));
                            }
                        }

                        if (me.animationShowDuration == 0) {
                            $submenu.css({ top: top });
                            item.isOpen = true;
                            me._raiseEvent('0', item);
                            $.jqx.aria($(item.element), 'aria-expanded', true);
                        }
                        else {
                            $submenu.animate({ top: top }, me.animationShowDuration, me.easing,
                            function () {
                                item.isOpen = true;
                                $.jqx.aria($(item.element), 'aria-expanded', true);
                                me._raiseEvent('0', item);
                            }) //animate submenu into view
                        }
                    }
                    else {
                        $submenu.stop();
                        $submenu.css('top', top);
                        if (!$.jqx.browser.msie) {
                            //     $popupElement.css('opacity', 0.0);
                        }

                        if (item.level > 0) {
                            $menuElement.addClass(me.toThemeProperty('jqx-fill-state-pressed'));
                            $menuElement.addClass(me.toThemeProperty('jqx-menu-item-selected'));
                            var $arrowSpan = $(item.arrow);
                            if ($arrowSpan.length > 0) {
                                $arrowSpan.removeClass();
                                if (item.openHorizontalDirection != 'left') {
                                    $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-' + me._getDir('right') + '-selected'));
                                }
                                else {
                                    $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-' + me._getDir('left') + '-selected'));
                                }
                            }
                        }
                        else {
                            $menuElement.addClass(me.toThemeProperty('jqx-fill-state-pressed'));
                            $menuElement.addClass(me.toThemeProperty('jqx-menu-item-top-selected'));
                            var $arrowSpan = $(item.arrow);
                            if ($arrowSpan.length > 0) {
                                $arrowSpan.removeClass();
                                if (item.openHorizontalDirection != 'left') {
                                    $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-' + me._getDir('right') + '-selected'));
                                }
                                else {
                                    $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-' + me._getDir('left') + '-selected'));
                                }
                            }
                        }
                        if (!$.jqx.browser.msie) {
                            //      $popupElement.animate({ opacity: 1 }, 2 * me.animationShowDuration, me.easing,
                            //   function () {

                            // })
                        }
                        if (me.animationShowDuration == 0) {
                            $submenu.css({ left: left });
                            me._raiseEvent('0', item);
                            item.isOpen = true;
                            $.jqx.aria($(item.element), 'aria-expanded', true);
                        }
                        else {
                            $submenu.animate({ left: left }, me.animationShowDuration, me.easing, function () {
                                me._raiseEvent('0', item);
                                item.isOpen = true;
                                $.jqx.aria($(item.element), 'aria-expanded', true);
                            }) //animate submenu into view
                        }
                    }
                }
            }, this.animationShowDelay);
        },

        _getDir: function(dir)
        {
            switch (dir) {
                case 'left':
                    return !this.rtl ? 'left' : 'right';
                case 'right':
                    return this.rtl ? 'left' : 'right';
            }
            return 'left';
        },

        //[optimize]
        _applyOrientation: function (mode, oldmode) {
            var me = this;
            var maxHeight = 0;
            this.host.removeClass(me.toThemeProperty('jqx-menu-horizontal'));
            this.host.removeClass(me.toThemeProperty('jqx-menu-vertical'));
            this.host.removeClass(me.toThemeProperty('jqx-menu'));
            this.host.removeClass(me.toThemeProperty('jqx-widget'));
            this.host.addClass(me.toThemeProperty('jqx-widget'));
            this.host.addClass(me.toThemeProperty('jqx-menu'));

            if (mode != undefined && oldmode != undefined && oldmode == 'popup') {
                if (this.host.parent().length > 0 && this.host.parent().parent().length > 0 && this.host.parent().parent()[0] == document.body) {
                    var oldHost = $.data(document.body, 'jqxMenuOldHost' + this.element.id);
                    if (oldHost != null) {
                        var $popupElementparent = this.host.closest('div.jqx-menu-wrapper')
                        $popupElementparent.remove();
                        $popupElementparent.appendTo(oldHost);
                        this.host.css('display', 'block');
                        this.host.css('visibility', 'visible');
                        $popupElementparent.css('display', 'block');
                        $popupElementparent.css('visibility', 'visible');
                    }
                }
            }
            else if (mode == undefined && oldmode == undefined) {
                $.data(document.body, 'jqxMenuOldHost' + this.element.id, this.host.parent()[0]);
            }

            if (this.autoOpenPopup) {
                if (this.mode == 'popup') {
                    this.addHandler($(document),'contextmenu.' + this.element.id, function (e) {
                        return false;
                    });

                    this.addHandler($(document), 'mousedown.menu' + this.element.id, function(event)
                    {
                        me._openContextMenu(event);
                    });
                }
                else {
                    this.removeHandler($(document), 'contextmenu.' + this.element.id);
                    this.removeHandler($(document), 'mousedown.menu' + this.element.id);
                }
            }
            else {
                this.removeHandler($(document), 'contextmenu.' + this.element.id);
                this.removeHandler($(document), 'mousedown.menu' + this.element.id);
            }

            if (this.rtl) {
                this.host.addClass(this.toThemeProperty('jqx-rtl'));
            }

            switch (this.mode) {
                case 'horizontal':
                    this.host.addClass(me.toThemeProperty('jqx-widget-header'));
                    this.host.addClass(me.toThemeProperty('jqx-menu-horizontal'));

                    $.each(this.items, function () {
                        var item = this;
                        $element = $(item.element);

                        var $arrowSpan = $(item.arrow);
                        $arrowSpan.removeClass();

                        if (item.hasItems && item.level > 0) {
                            var $arrowSpan = $('<span style="border: none; background-color: transparent;" id="arrow' + $element[0].id + '"></span>');
                            $arrowSpan.prependTo($element);
                            $arrowSpan.css('float', me._getDir('right'));
                            $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-' + me._getDir('right')));
                            item.arrow = $arrowSpan[0];
                        }

                        if (item.level == 0) {
                            $(item.element).css('float', me._getDir('left'));
                            if (!item.ignoretheme && item.hasItems && me.showTopLevelArrows) {
                                var $arrowSpan = $('<span style="border: none; background-color: transparent;" id="arrow' + $element[0].id + '"></span>');
                                var ie7 = $.jqx.browser.msie && $.jqx.browser.version < 8;

                                if (item.arrow == null) {
                                    if (!ie7) {
                                        $arrowSpan.prependTo($element);
                                    }
                                    else {
                                        $arrowSpan.appendTo($element);
                                    }
                                } else {
                                    $arrowSpan = $(item.arrow);
                                }
                                if (item.openVerticalDirection == 'down') {
                                    $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-down'));
                                }
                                else {
                                    $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-up'));
                                }

                                $arrowSpan.css('visibility', 'visible');

                                if (!ie7) {
                                    $arrowSpan.css('display', 'block');
                                    $arrowSpan.css('float', 'right');
                                }
                                else {
                                    $arrowSpan.css('display', 'inline-block');
                                }

                                item.arrow = $arrowSpan[0];
                            }
                            else if (!item.ignoretheme && item.hasItems && !me.showTopLevelArrows) {
                                if (item.arrow != null) {
                                    var $arrowSpan = $(item.arrow);
                                    $arrowSpan.remove();
                                    item.arrow = null;
                                }
                            }
                            maxHeight = Math.max(maxHeight, $element.height());
                        }
                    });
                    break;
                case 'vertical':
                case 'popup':
                    this.host.addClass(me.toThemeProperty('jqx-menu-vertical'));

                    $.each(this.items, function () {
                        var item = this;
                        $element = $(item.element);
                        if (item.hasItems && !item.ignoretheme) {
                            if (item.arrow) {
                                $(item.arrow).remove();
                            }

                            var $arrowSpan = $('<span style="border: none; background-color: transparent;" id="arrow' + $element[0].id + '"></span>');

                            $arrowSpan.prependTo($element);
                            $arrowSpan.css('float', 'right');

                            if (item.level == 0) {
                                $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-top-' + me._getDir('right')));
                            }
                            else {
                                $arrowSpan.addClass(me.toThemeProperty('jqx-menu-item-arrow-' + me._getDir('right')));
                            }
                            item.arrow = $arrowSpan[0];
                        }
                        $element.css('float', 'none');
                    });

                    if (this.mode == 'popup') {
                        this.host.addClass(me.toThemeProperty('jqx-widget-content'));
                        this.host.wrap('<div class="jqx-menu-wrapper" style="z-index:' + this.popupZIndex + '; border: none; background-color: transparent; padding: 0px; margin: 0px; position: absolute; top: 0; left: 0; display: block; visibility: visible;"></div>')
                        var $popupElementparent = this.host.closest('div.jqx-menu-wrapper')
                        this.host.addClass(me.toThemeProperty('jqx-popup'));
                        $popupElementparent[0].id = "menuWrapper" + this.element.id;
                        $popupElementparent.appendTo($(document.body));
                    }
                    else {
                        this.host.addClass(me.toThemeProperty('jqx-widget-header'));
                    }

                    if (this.mode == 'popup') {
                        var height = this.host.height();
                        this.host.css('position', 'absolute');
                        this.host.css('top', '0');
                        this.host.css('left', '0');
                        this.host.height(height);
                        this.host.css('display', 'none');
                        //    this.host.css('visibility', 'hidden');
                    }
                    break;
            }
            var isTouchDevice = this.isTouchDevice();
            if (this.autoCloseOnClick) {
                this.removeHandler($(document), 'mousedown.menu' + this.element.id, me._closeAfterClick);
                this.addHandler($(document), 'mousedown.menu' + this.element.id, me._closeAfterClick, me);
                if (isTouchDevice) {
                    this.removeHandler($(document), $.jqx.mobile.getTouchEventName('touchstart') + '.menu' + this.element.id, me._closeAfterClick, me);
                    this.addHandler($(document), $.jqx.mobile.getTouchEventName('touchstart') + '.menu' + this.element.id, me._closeAfterClick, me);
                }
            }
        },

        _getBodyOffset: function () {
            var top = 0;
            var left = 0;
            if ($('body').css('border-top-width') != '0px') {
                top = parseInt($('body').css('border-top-width'));
                if (isNaN(top)) top = 0;
            }
            if ($('body').css('border-left-width') != '0px') {
                left = parseInt($('body').css('border-left-width'));
                if (isNaN(left)) left = 0;
            }
            return { left: left, top: top };
        },

        _getOffset: function (object) {
     //       var scrollTop = $(window).scrollTop();
     //       var scrollLeft = $(window).scrollLeft();
            var isSafari = $.jqx.mobile.isSafariMobileBrowser();

            var offset = $(object).coord(true);
            var top = offset.top;
            var left = offset.left;

            if ($('body').css('border-top-width') != '0px') {
                top = parseInt(top) + this._getBodyOffset().top;
            }
            if ($('body').css('border-left-width') != '0px') {
                left = parseInt(left) + this._getBodyOffset().left;
            }

            var windowsPhone = $.jqx.mobile.isWindowsPhone();
            if (this.hasTransform || (isSafari != null && isSafari) || windowsPhone) {
                var point = { left: $.jqx.mobile.getLeftPos(object), top: $.jqx.mobile.getTopPos(object) };
                return point;
            }
            else return { left: left, top: top };
        },

        _isRightClick: function (e) {
            var rightclick;
            if (!e) var e = window.event;
            if (e.which) rightclick = (e.which == 3);
            else if (e.button) rightclick = (e.button == 2);
            return rightclick;
        },

        _openContextMenu: function (e) {
            var me = this;
            var rightclick = me._isRightClick(e);

            if (rightclick) {
                me.open(parseInt(e.clientX) + 5, parseInt(e.clientY) + 5);
            }
        },

        // closes a context menu.
        close: function () {
            var me = this;
            var opened = $.data(this.element, 'contextMenuOpened' + this.element.id);
            if (opened) {
                var host = this.host;
                $.each(me.items, function () {
                    var item = this;
                    if (item.hasItems) {
                        me._closeItem(me, item);
                    }
                });

                $.each(me.items, function () {
                    var item = this;
                    if (item.isOpen == true) {
                        $submenu = $(item.subMenuElement);
                        var $popupElement = $submenu.closest('div.jqx-menu-popup')
                        $popupElement.hide(this.animationHideDuration);

                    }
                });

                this.host.hide(this.animationHideDuration);
                $.data(me.element, 'contextMenuOpened' + this.element.id, false);
                me._raiseEvent('1', me);
            }
        },

        // @param String. Horizontal offset
        // @param String. Vertical Offset
        // opens a context menu.
        open: function (left, top) {
            if (this.mode == 'popup') {
                var duration = 0;
                if (this.host.css('display') == 'block') {
                    this.close();
                    duration = this.animationHideDuration;
                }

                var me = this;

                if (left == undefined || left == null) left = 0;
                if (top == undefined || top == null) top = 0;

                setTimeout(function () {
                    me.host.show(me.animationShowDuration);
                    me.host.css('visibility', 'visible');
                    $.data(me.element, 'contextMenuOpened' + me.element.id, true);
                    me._raiseEvent('0', me);
                    me.host.css('z-index', 9999);

                    if (left != undefined && top != undefined) {
                        me.host.css({ 'left': left, 'top': top });
                    }
                }, duration);
            }
        },

        _renderHover: function ($menuElement, item, isTouchDevice) {
            var me = this;
            if (!item.ignoretheme) {
                this.addHandler($menuElement, 'mouseenter', function () {
                    if (!item.disabled && !item.separator && me.enableHover && !me.disabled) {
                        if (item.level > 0) {
                            $menuElement.addClass(me.toThemeProperty('jqx-fill-state-hover'));
                            $menuElement.addClass(me.toThemeProperty('jqx-menu-item-hover'));
                        }
                        else {
                            $menuElement.addClass(me.toThemeProperty('jqx-fill-state-hover'));
                            $menuElement.addClass(me.toThemeProperty('jqx-menu-item-top-hover'));
                        }
                    }
                });
                this.addHandler($menuElement, 'mouseleave', function () {            
                if (!item.disabled && !item.separator && me.enableHover && !me.disabled) {
                    if (item.level > 0) {
                        $menuElement.removeClass(me.toThemeProperty('jqx-fill-state-hover'));
                        $menuElement.removeClass(me.toThemeProperty('jqx-menu-item-hover'));
                    }
                    else {
                        $menuElement.removeClass(me.toThemeProperty('jqx-fill-state-hover'));
                        $menuElement.removeClass(me.toThemeProperty('jqx-menu-item-top-hover'));
                    }
                }
            });
            }            
        },

        _closeAfterClick: function (event) {
            var me = event != null ? event.data : this;
            var matches = false;
            if (me.autoCloseOnClick) {
                $.each($(event.target).parents(), function () {
                    if (this.className.indexOf) {
                        if (this.className.indexOf('jqx-menu') != -1) {
                            matches = true;
                            return false;
                        }
                    }
                });

                if (!matches) {
                    event.data = me;
                    me._closeAll(event);
                }
            }
        },

        _autoSizeHorizontalMenuItems: function () {
            var me = this;
            if (me.autoSizeMainItems && this.mode == "horizontal") {
                var maxHeight = this.maxHeight;
                if (parseInt(maxHeight) > parseInt(this.host.height())) {
                    maxHeight = parseInt(this.host.height());
                }
                maxHeight = parseInt(this.host.height());

                // align vertically the items.
                $.each(this.items, function () {
                    var item = this;
                    $element = $(item.element);
                    if (item.level == 0 && maxHeight > 0) {
                        var childrenHeight = $element.children().length > 0 ? parseInt($element.children().height()) : $element.height();
                        // vertically align content.
                        var $ul = me.host.find('ul:first');
                        var paddingOffset = parseInt($ul.css('padding-top'));
                        var marginOffset = parseInt($ul.css('margin-top'));
                        //   var borderOffset = parseInt(me.host.css('border-top-width'));
                        var height = maxHeight - 2 * (marginOffset + paddingOffset);
                        var newPadding = parseInt(height) / 2 - childrenHeight / 2;
                        var topPadding = parseInt(newPadding);
                        var bottomPadding = parseInt(newPadding);
                        $element.css('padding-top', topPadding);
                        $element.css('padding-bottom', bottomPadding);

                        if (parseInt($element.outerHeight()) > height) {
                            var offset = 1;
                            $element.css('padding-top', topPadding - offset);
                            topPadding = topPadding - offset;
                        }
                    }
                });
            }
            $.each(this.items, function () {
                var item = this;
                $element = $(item.element);
                if (item.hasItems && item.level > 0) {
                    if (item.arrow)
                    {
                        var $arrowSpan = $(item.arrow);
                        var height = $(item.element).height();
                        if (height > 15) {
                            $arrowSpan.css('margin-top', (height - 15) / 2);
                        }
                    }
                }
            });
        },

        _render: function (mode, oldMode) {
            var zIndex = this.popupZIndex;
            var popupElementoffset = [5, 5];
            var me = this;
            $.data(me.element, 'animationHideDelay', me.animationHideDelay);
            var isTouchDevice = this.isTouchDevice();
            var WP = isTouchDevice && $.jqx.mobile.isWindowsPhone();

            $.data(document.body, 'menuel', this);

            this.hasTransform = $.jqx.utilities.hasTransform(this.host);

            this._applyOrientation(mode, oldMode);

            if (me.enableRoundedCorners) {
                this.host.addClass(me.toThemeProperty('jqx-rc-all'));
            }

            $.each(this.items, function () {
                var item = this;
                var $menuElement = $(item.element);
                $menuElement.attr('role', 'menuitem');
                if (me.enableRoundedCorners) {
                    $menuElement.addClass(me.toThemeProperty('jqx-rc-all'));
                }

                me.removeHandler($menuElement, 'click');
                me.addHandler($menuElement, 'click', function (e) {
                    if (item.disabled)
                        return;

                    me._raiseEvent('2', { item: item.element, event: e });

                    if (!me.autoOpen) {
                        if (item.level > 0) {
                            if (me.autoCloseOnClick && !isTouchDevice && !me.clickToOpen) {
                                e.data = me;
                                me._closeAll(e);
                            }
                        }
                    }
                    else if (me.autoCloseOnClick && !isTouchDevice && !me.clickToOpen) {
                        if (item.closeOnClick) {
                            e.data = me;
                            me._closeAll(e);
                        }
                    }
                    if (isTouchDevice && me.autoCloseOnClick) {
                        e.data = me;
                        if (!item.hasItems) {
                            me._closeAll(e);
                        }
                    }

                    if (e.target.tagName != 'A' && e.target.tagName != 'a') {
                        var anchor = item.anchor != null ? $(item.anchor) : null;

                        if (anchor != null && anchor.length > 0) {
                            var href = anchor.attr('href');
                            var target = anchor.attr('target');
                            if (href != null) {
                                if (target != null) {
                                    window.open(href, target);
                                }
                                else {
                                    window.location = href;
                                }
                                //if (target != null && target == "_blank") {
                                //    window.open(href, target);
                                //}
                                //else {
                                //   window.location = href;
                                //    window.open(href, target);

                                //}
                            }
                        }
                    }
                });

                me.removeHandler($menuElement, 'mouseenter');
                me.removeHandler($menuElement, 'mouseleave');
                if (!WP) {
                    me._renderHover($menuElement, item, isTouchDevice);
                }
                if (item.subMenuElement != null) {
                    var $submenu = $(item.subMenuElement);

                    $submenu.wrap('<div class="jqx-menu-popup ' + me.toThemeProperty('jqx-menu-popup') + '" style="border: none; background-color: transparent; z-index:' + zIndex + '; padding: 0px; margin: 0px; position: absolute; top: 0; left: 0; display: block; visibility: hidden;"><div style="background-color: transparent; border: none; position:absolute; overflow:hidden; left: 0; top: 0; right: 0; width: 100%; height: 100%;"></div></div>')
                    $submenu.css({ overflow: 'hidden', position: 'absolute', left: 0, display: 'inherit', top: -$submenu.outerHeight() })
                    $submenu.data('timer', {});
                    if (item.level > 0) {
                        $submenu.css('left', -$submenu.outerWidth());
                    }
                    else if (me.mode == 'horizontal') {
                        $submenu.css('left', 0);
                    }

                    zIndex++;
                    var $popupElement = $(item.subMenuElement).closest('div.jqx-menu-popup').css({ width: parseInt($(item.subMenuElement).outerWidth()) + parseInt(popupElementoffset[0]) + 'px', height: parseInt($(item.subMenuElement).outerHeight()) + parseInt(popupElementoffset[1]) + 'px' })
                    var $popupElementparent = $menuElement.closest('div.jqx-menu-popup')

                    if ($popupElementparent.length > 0) {
                        var oldsubleftmargin = $submenu.css('margin-left');
                        var oldsubrightmargin = $submenu.css('margin-right');
                        var oldsubleftpadding = $submenu.css('padding-left');
                        var oldsubrightpadding = $submenu.css('padding-right');

                        $popupElement.appendTo($popupElementparent)

                        $submenu.css('margin-left', oldsubleftmargin);
                        $submenu.css('margin-right', oldsubrightmargin);
                        $submenu.css('padding-left', oldsubleftpadding);
                        $submenu.css('padding-right', oldsubrightpadding);
                    }
                    else {
                        var oldsubleftmargin = $submenu.css('margin-left');
                        var oldsubrightmargin = $submenu.css('margin-right');
                        var oldsubleftpadding = $submenu.css('padding-left');
                        var oldsubrightpadding = $submenu.css('padding-right');

                        $popupElement.appendTo($(document.body));
                        $submenu.css('margin-left', oldsubleftmargin);
                        $submenu.css('margin-right', oldsubrightmargin);
                        $submenu.css('padding-left', oldsubleftpadding);
                        $submenu.css('padding-right', oldsubrightpadding);
                    }

                    if (!me.clickToOpen) {
                        if (isTouchDevice) {
                            me.removeHandler($menuElement, $.jqx.mobile.getTouchEventName('touchstart'));
                            me.addHandler($menuElement, $.jqx.mobile.getTouchEventName('touchstart'), function (event) {
                                clearTimeout($submenu.data('timer').hide)
                                if ($submenu != null) {
                                    $submenu.stop();
                                }

                                if (item.level == 0 && !item.isOpen) {
                                    event.data = me;
                                    me._closeAll(event);
                                }

                                if (!item.isOpen) {
                                    me._openItem(me, item);
                                }
                                else {
                                    me._closeItem(me, item, true);
                                }
                                return false;
                            });
                        }

                        if (!WP) {
                            me.addHandler($menuElement, 'mouseenter', function () {
                                if (me.autoOpen || (item.level > 0 && !me.autoOpen)) {
                                    clearTimeout($submenu.data('timer').hide)
                                }

                                if (item.parentId && item.parentId != 0) {
                                    if (me.menuElements[item.parentId]) {
                                        var openedStateOfParent = me.menuElements[item.parentId].isOpen;
                                        if (!openedStateOfParent) {
                                            return;
                                        }
                                    }
                                }

                                if (me.autoOpen || (item.level > 0 && !me.autoOpen)) {
                                    me._openItem(me, item);
                                }
                                return false;
                            });

                            me.addHandler($menuElement, 'mousedown', function () {
                                if (!me.autoOpen && item.level == 0) {
                                    clearTimeout($submenu.data('timer').hide)
                                    if ($submenu != null) {
                                        $submenu.stop();
                                    }

                                    if (!item.isOpen) {
                                        me._openItem(me, item);
                                    }
                                    else {
                                        me._closeItem(me, item, true);
                                    }
                                }
                            });

                            me.addHandler($menuElement, 'mouseleave', function (event) {
                                if (me.autoCloseOnMouseLeave) {
                                    clearTimeout($submenu.data('timer').hide)
                                    var $subMenu = $(item.subMenuElement);
                                    var position = { left: parseInt(event.pageX), top: parseInt(event.pageY) };
                                    var subMenuBounds = {
                                        left: parseInt($subMenu.coord().left), top: parseInt($subMenu.coord().top),
                                        width: parseInt($subMenu.outerWidth()), height: parseInt($subMenu.outerHeight())
                                    };

                                    var closeItem = true;
                                    if (subMenuBounds.left - 5 <= position.left && position.left <= subMenuBounds.left + subMenuBounds.width + 5) {
                                        if (subMenuBounds.top <= position.top && position.top <= subMenuBounds.top + subMenuBounds.height) {
                                            closeItem = false;
                                        }
                                    }

                                    if (closeItem) {
                                        me._closeItem(me, item, true);
                                    }
                                }
                            });

                            me.removeHandler($popupElement, 'mouseenter');
                            me.addHandler($popupElement, 'mouseenter', function () {
                                clearTimeout($submenu.data('timer').hide)
                            });

                            me.removeHandler($popupElement, 'mouseleave');
                            me.addHandler($popupElement, 'mouseleave', function (e) {
                                if (me.autoCloseOnMouseLeave) {
                                    clearTimeout($submenu.data('timer').hide)
                                    clearTimeout($submenu.data('timer').show);
                                    if ($submenu != null) {
                                        $submenu.stop();
                                    }
                                    me._closeItem(me, item, true);
                                }
                            });
                        }
                    }
                    else {
                        me.removeHandler($menuElement, 'mousedown');
                        me.addHandler($menuElement, 'mousedown', function (event) {

                            clearTimeout($submenu.data('timer').hide)
                            if ($submenu != null) {
                                $submenu.stop();
                            }

                            if (item.level == 0 && !item.isOpen) {
                                event.data = me;
                                me._closeAll(event);
                            }

                            if (!item.isOpen) {
                                me._openItem(me, item);
                            }
                            else {
                                me._closeItem(me, item, true);
                            }
                        });
                    }
                }
            });

            this._autoSizeHorizontalMenuItems();
            this._raiseEvent('3', this);
        },

        createID: function () {
            var id = Math.random() + '';
            id = id.replace('.', '');
            id = '99' + id;
            id = id / 1;
            while (this.items[id]) {
                id = Math.random() + '';
                id = id.replace('.', '');
                id = id / 1;
            }
            return 'menuItem' + id;
        },

        _createMenu: function (uiObject, refresh) {
            if (uiObject == null)
                return;

            if (refresh == undefined) {
                refresh = true;
            }
            if (refresh == null) {
                refresh = true;
            }

            var self = this;
            var liTags = $(uiObject).find('li');
            var k = 0;
            for (var index = 0; index < liTags.length; index++) {
                var listItem = liTags[index];
                var $listItem = $(listItem);

                if (listItem.className.indexOf('jqx-menu') == -1 && this.autoGenerate == false)
                    continue;

                var id = listItem.id;
                if (!id) {
                    id = this.createID();
                }

                if (refresh) {
                    listItem.id = id;
                    this.items[k] = new $.jqx._jqxMenu.jqxMenuItem();
                    this.menuElements[id] = this.items[k];
                }

                k += 1;
                var parentId = 0;
                var me = this;
                var children = $listItem.children();
                children.each(function () {
                    if (!refresh) {
                        this.className = "";

                        if (me.autoGenerate) {
                            $(me.items[k - 1].subMenuElement)[0].className = "";
                            $(me.items[k - 1].subMenuElement).addClass(me.toThemeProperty('jqx-widget-content'));
                            $(me.items[k - 1].subMenuElement).addClass(me.toThemeProperty('jqx-menu-dropdown'));
                            $(me.items[k - 1].subMenuElement).addClass(me.toThemeProperty('jqx-popup'));
                        }
                    }

                    if (this.className.indexOf('jqx-menu-dropdown') != -1) {
                        if (refresh) {
                            me.items[k - 1].subMenuElement = this;
                        }
                        return false;
                    }
                    else if (me.autoGenerate && (this.tagName == 'ul' || this.tagName == 'UL')) {
                        if (refresh) {
                            me.items[k - 1].subMenuElement = this;
                        }
                        this.className = "";
                        $(this).addClass(me.toThemeProperty('jqx-widget-content'));
                        $(this).addClass(me.toThemeProperty('jqx-menu-dropdown'));
                        $(this).addClass(me.toThemeProperty('jqx-popup'));
                        $(this).attr('role', 'menu');
                        if (me.rtl) {
                            $(this).addClass(me.toThemeProperty('jqx-rc-l'));
                        }
                        else {
                            $(this).addClass(me.toThemeProperty('jqx-rc-r'));
                        }
                        $(this).addClass(me.toThemeProperty('jqx-rc-b'));

                        return false;
                    }
                });

                var parents = $listItem.parents();
                parents.each(function () {
                    if (this.className.indexOf('jqx-menu-item') != -1) {
                        parentId = this.id;
                        return false;
                    }
                    else if (me.autoGenerate && (this.tagName == 'li' || this.tagName == 'LI')) {
                        parentId = this.id;
                        return false;
                    }

                });

                var separator = false;
                var type = listItem.getAttribute('type');
                var ignoretheme = listItem.getAttribute('ignoretheme');

                if (ignoretheme) {
                    if (ignoretheme == 'true' || ignoretheme == true) {
                        ignoretheme = true;
                    }
                }
                else ignoretheme = false;

                if (!type) {
                    type = listItem.type;
                }
                else {
                    if (type == 'separator') {
                        var separator = true;
                    }
                }

                if (!separator) {
                    if (parentId) {
                        type = 'sub';
                    }
                    else type = 'top';
                }

                var menuItem = this.items[k - 1];
                if (refresh) {
                    menuItem.id = id;
                    menuItem.parentId = parentId;
                    menuItem.type = type;
                    menuItem.separator = separator;
                    menuItem.element = liTags[index];
                    var anchor = $listItem.children('a');
                    menuItem.level = $listItem.parents('li').length;
                    menuItem.anchor = anchor.length > 0 ? anchor : null;
                }
                menuItem.ignoretheme = ignoretheme;

                var parentItem = this.menuElements[parentId];
                if (parentItem != null) {
                    if (parentItem.ignoretheme) {
                        menuItem.ignoretheme = parentItem.ignoretheme;
                        ignoretheme = parentItem.ignoretheme;
                    }
                }

                if (this.autoGenerate) {
                    if (type == 'separator') {
                        $listItem.removeClass();
                        $listItem.addClass(this.toThemeProperty('jqx-menu-item-separator'));
                        $listItem.attr('role', 'separator');
                    }
                    else {
                        if (!ignoretheme) {
                            $listItem[0].className = "";
                            if (this.rtl) {
                                $listItem.addClass(this.toThemeProperty('jqx-rtl'));
                            }
                            if (menuItem.level > 0) {
                                $listItem.addClass(this.toThemeProperty('jqx-item'));
                                $listItem.addClass(this.toThemeProperty('jqx-menu-item'));
                            }
                            else {
                                $listItem.addClass(this.toThemeProperty('jqx-item'));
                                $listItem.addClass(this.toThemeProperty('jqx-menu-item-top'));
                            }
                        }
                    }
                }

                if (refresh && !ignoretheme) {
                    menuItem.hasItems = $listItem.find('li').length > 0;
                    if (menuItem.hasItems) {
                        if (menuItem.element) {
                            $.jqx.aria($(menuItem.element), "aria-haspopup", true);
                            if (!menuItem.subMenuElement.id) menuItem.subMenuElement.id = $.jqx.utilities.createId();
                            $.jqx.aria($(menuItem.element), "aria-owns", menuItem.subMenuElement.id);
                        }
                    }
                }
            }
        },

        destroy: function () {
            $.jqx.utilities.resize(this.host, null, true);
            var wrapper = this.host.closest('div.jqx-menu-wrapper');
            wrapper.remove();
            $("#menuWrapper" + this.element.id).remove();
            var me = this;
            this.removeHandler($(document), 'mousedown.menu' + this.element.id, me._closeAfterClick);
            this.removeHandler($(document), 'mouseup.menu' + this.element.id, me._closeAfterClick);
            $.data(document.body, 'jqxMenuOldHost' + this.element.id, null);

            if ($(window).off) {
                $(window).off('resize.menu' + me.element.id);
            }
            $.each(this.items, function () {
                var item = this;
                var $menuElement = $(item.element);
                me.removeHandler($menuElement, 'click');
                me.removeHandler($menuElement, 'selectstart');
                me.removeHandler($menuElement, 'mouseenter');
                me.removeHandler($menuElement, 'mouseleave');
                me.removeHandler($menuElement, 'mousedown');
                me.removeHandler($menuElement, 'mouseleave');
                var $submenu = $(item.subMenuElement);
                var $popupElement = $submenu.closest('div.jqx-menu-popup');
                $popupElement.remove();
                delete this.subMenuElement;
                delete this.element;
            });
            $.data(document.body, 'menuel', null);
            delete this.menuElements;
            this.items = new Array();
            delete this.items;
            var vars = $.data(this.element, "jqxMenu");
            if (vars) {
                delete vars.instance;
            }

            this.host.removeClass();
            this.host.remove();
            delete this.host;
            delete this.element;
        },

        _raiseEvent: function (id, arg) {
            if (arg == undefined)
                arg = { owner: null };

            var evt = this.events[id];
            args = arg;
            args.owner = this;

            var event = new jQuery.Event(evt);
            if (id == '2') {
                args = arg.item;
                args.owner = this;
                $.extend(event, arg.event);
                event.type = 'itemclick';
            }

            event.owner = this;
            event.args = args;
            var result = this.host.trigger(event);
            return result;
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (this.isInitialized == undefined || this.isInitialized == false)
                return;

            if (value == oldvalue)
                return;

            if (key == 'touchMode') {
                this._isTouchDevice = null;
                object._render(value, oldvalue);
            }

            if (key == 'source') {
                if (object.source != null) {
                    var html = object.loadItems(object.source);
                    object.element.innerHTML = html;
                    var innerElement = object.host.find('ul:first');
                    if (innerElement.length > 0) {
                        object.refresh();
                        object._createMenu(innerElement[0]);
                        object._render();
                    }
                }
            }

            if (key == 'autoCloseOnClick') {
                if (value == false) {
                    object.removeHandler($(document), 'mousedown.menu' + this.element.id, object._closeAll);
                }
                else {
                    object.addHandler($(document), 'mousedown.menu' + this.element.id, object, object._closeAll);
                }
            }
            else if (key == 'mode' || key == 'width' || key == 'height' || key == 'showTopLevelArrows') {
                object.refresh();

                if (key == 'mode') {
                    object._render(value, oldvalue);
                }
                else object._applyOrientation();
            }
            else if (key == 'theme') {
                $.jqx.utilities.setTheme(oldvalue, value, object.host);
            }
        }
    });
})(jQuery);

(function ($) {
    $.jqx._jqxMenu.jqxMenuItem = function(id, parentId, type) {
        var menuItem =
        {
            // gets the id.
    	    id: id,
            // gets the parent id.
            parentId: parentId,
            // gets the parent item instance.
            parentItem: null,
            // gets the anchor element.
            anchor: null,
            // gets the type
            type: type,
            // gets whether the item is disabled.
            disabled: false,
            // gets the item's level.
            level: 0,
            // gets a value whether the item is opened.
            isOpen: false,
            // has sub elements.
            hasItems: false,
            // li element
            element: null,
            subMenuElement: null,
            // arrow element.
            arrow: null,
            // left, right, center
            openHorizontalDirection: 'right',
            // up, down, center
            openVerticalDirection: 'down',
            closeOnClick: true
         }
        return menuItem;
    }; // 
})(jQuery);
﻿
(function ($) {

    $.jqx.jqxWidget("jqxExpander", "", {});

    $.extend($.jqx._jqxExpander.prototype, {

        defineInstance: function () {
            //// properties
            this.width = 'auto';
            this.height = 'auto';
            this.expanded = true; // possible values: true, false
            this.expandAnimationDuration = 259;
            this.collapseAnimationDuration = 250;
            this.animationType = 'slide'; // possible values: 'slide', 'fade', 'none'
            this.toggleMode = 'click'; //possible values: 'click', 'dblclick', 'none'
            this.showArrow = true; // possible values: true, false
            this.arrowPosition = 'right'; // possible values: 'left', 'right'
            this.headerPosition = 'top'; // possible values: 'top', 'bottom'
            this.disabled = false; // possible values: true, false
            this.initContent = null; // callback function
            this.rtl = false; // possible values: true, false
            this.easing = 'easeInOutSine'; // possible values: easeOutBack, easeInQuad, easeInOutCirc, easeInOutSine, easeInCubic, easeOutCubic, easeInOutCubic, easeInSine, easeOutSine, easeInOutSine
            this.aria =
             {
                 "aria-disabled": { name: "disabled", type: "boolean" }
             };
            //// events
            this.events = ['expanding', 'expanded', 'collapsing', 'collapsed', 'resize'];
        },

        createInstance: function (args) {
            this._isTouchDevice = $.jqx.mobile.isTouchDevice();
            $.jqx.aria(this);
            // saves the initial HTML structure in a variable
            this._cachedHTMLStructure = this.host.html();

            // renders the widget
            this.render();
        },

        //// methods

        //// public methods

        // expands the content
        expand: function () {
            if (this.disabled == false && this.expanded == false && this._expandChecker == 1) {
                var me = this;
                this._expandChecker = 0;
                this._raiseEvent('0');
                this._header.removeClass(this.toThemeProperty("jqx-fill-state-normal"));
                this._header.addClass(this.toThemeProperty("jqx-fill-state-pressed"));
                this._header.addClass(this.toThemeProperty("jqx-expander-header-expanded"));
                if (this.headerPosition == 'top') {
                    this._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-down"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-down-hover"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-up-hover"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-down-selected"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-expander-arrow-top"));
                    this._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-up"));
                    this._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-up-selected"));
                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-bottom"));
                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-expanded"));
                } else if (this.headerPosition == 'bottom') {
                    this._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-up"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-up-selected"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-down-hover"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-up-hover"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-expander-arrow-bottom"));
                    this._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-down"));
                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-top"));
                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-expanded-top"));
                };
                switch (this.animationType) {
                    case 'slide':
                        if (this.headerPosition == 'top') {
                            this._content.slideDown(this.expandAnimationDuration, this.easing, function () {
                                me.expanded = true;
                                $.jqx.aria(me._header, "aria-expanded", true);
                                $.jqx.aria(me._content, "aria-hidden", false);

                                me._raiseEvent('1');
                                if (me.initContent && me._initialized == false) {
                                    me.initContent();
                                    me._initialized = true;
                                };
                            });
                        } else if (this.headerPosition == 'bottom') {
                            this._content.css({ "display": "inherit", "height": 0 });
                            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                                this._content.css('display', 'block');
                            }

                            if (this._cntntEmpty == true) {
                                this._content.animate({
                                    height: 0
                                }, this.expandAnimationDuration, this.easing, function () {
                                    me.expanded = true;
                                    $.jqx.aria(me._header, "aria-expanded", true);
                                    $.jqx.aria(me._content, "aria-hidden", false);
                                    me._raiseEvent('1');
                                    if (me.initContent && me._initialized == false) {
                                        me.initContent();
                                        me._initialized = true;
                                    };
                                });
                            } else {
                                this._content.animate({
                                    height: this._contentHeight
                                }, this.expandAnimationDuration, this.easing, function () {
                                    me.expanded = true;
                                    $.jqx.aria(me._header, "aria-expanded", true);
                                    $.jqx.aria(me._content, "aria-hidden", false);
                                    me._raiseEvent('1');
                                    if (me.initContent && me._initialized == false) {
                                        me.initContent();
                                        me._initialized = true;
                                    };
                                });
                            };
                        };
                        break;
                    case 'fade':
                        this._content.fadeIn(this.expandAnimationDuration, this.easing, function () {
                            me.expanded = true;
                            $.jqx.aria(me._header, "aria-expanded", true);
                            $.jqx.aria(me._content, "aria-hidden", false);
                            me._raiseEvent('1');
                            if (me.initContent && me._initialized == false) {
                                me.initContent();
                                me._initialized = true;
                            };
                        });
                        break;
                    case 'none':
                        this._content.css("display", "inherit");
                        this.expanded = true;
                        $.jqx.aria(me._header, "aria-expanded", true);
                        $.jqx.aria(me._content, "aria-hidden", false);
                        this._raiseEvent('1');
                        if (this.initContent && this._initialized == false) {
                            this.initContent();
                            this._initialized = true;
                        };
                        break;
                };
            };
        },

        // collapses the content
        collapse: function () {
            if (this.disabled == false && this.expanded == true && this._expandChecker == 0) {
                var me = this;
                this._expandChecker = 1;
                this._raiseEvent('2');
                this._header.removeClass(this.toThemeProperty("jqx-fill-state-pressed"));
                this._header.removeClass(this.toThemeProperty("jqx-expander-header-expanded"));
                this._header.addClass(this.toThemeProperty("jqx-fill-state-normal"));
                if (this.headerPosition == 'top') {
                    this._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-up"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-up-selected"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-expander-arrow-bottom"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-expander-arrow-expanded"));
                    this._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-down"));
                    if (me._hovered) {
                        this._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-down-hover"));
                    }

                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-top"));
                } else if (this.headerPosition == 'bottom') {
                    this._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-down"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-down-selected"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-expander-arrow-top"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-expander-arrow-expanded-top"));
                    this._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-up"));
                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-bottom"));
                    if (me._hovered) {
                        this._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-up-hover"));
                    }
                };
                switch (this.animationType) {
                    case 'slide':
                        if (this.headerPosition == 'top') {
                            this._content.slideUp(this.collapseAnimationDuration, this.easing, function () {
                                me.expanded = false;
                                $.jqx.aria(me._header, "aria-expanded", false);
                                $.jqx.aria(me._content, "aria-hidden", true);
                                me._raiseEvent('3');
                            });
                        } else if (this.headerPosition == 'bottom') {
                            this._content.animate({
                                height: 0
                            }, this.expandAnimationDuration, function () {
                                me._content.css("display", "none");
                                me.expanded = false;
                                $.jqx.aria(me._header, "aria-expanded", false);
                                $.jqx.aria(me._content, "aria-hidden", true);
                                me._raiseEvent('3');
                            });
                        };
                        break;
                    case 'fade':
                        this._content.fadeOut(this.collapseAnimationDuration, this.easing, function () {
                            me.expanded = false;
                            $.jqx.aria(me._header, "aria-expanded", false);
                            $.jqx.aria(me._content, "aria-hidden", true);
                            me._raiseEvent('3');
                        });
                        break;
                    case 'none':
                        this._content.css("display", "none");
                        this.expanded = false;
                        $.jqx.aria(me._header, "aria-expanded", false);
                        $.jqx.aria(me._content, "aria-hidden", true);
                        this._raiseEvent('3');
                        break;
                };
            };
        },

        // sets the header's content
        setHeaderContent: function (headerContent) {
            this._header_text.html(headerContent);
            this.invalidate();
        },

        // gets the header's content
        getHeaderContent: function () {
            return this._header_text.html();
        },

        // sets the content
        setContent: function (content) {
            this._content.html(content);
            this._checkContent();
            this.invalidate();
        },

        // gets the content
        getContent: function () {
            return this._content.html();
        },

        // enables the widget
        enable: function () {
            this.disabled = false;
            this.refresh();
            $.jqx.aria(this, "aria-disabled", false);
        },

        // disables the widget
        disable: function () {
            this.disabled = true;
            this.refresh();
            $.jqx.aria(this, "aria-disabled", true);
        },

        // refreshes the widget
        invalidate: function () {
            if ($.jqx.isHidden(this.host))
                return;

            this._setSize();
        },

        // refreshes the widget
        refresh: function (initialRefresh) {
            if (initialRefresh == true) {
                return;
            };

            this._removeHandlers();
            if (this.showArrow == true) {
                this._arrow.css("display", "inherit");
            } else {
                this._arrow.css("display", "none");
            };
            this._setTheme();
            this._setSize();
            if (this.disabled == false) {
                this._toggle();
            };
            this._keyBoard();
        },

        // renders the widget
        render: function () {
            this.widgetID = this.element.id;

            if (this._header) {
                this._header.removeClass(this.toThemeProperty('jqx-expander-header-content'));
                this._header.removeClass(this.toThemeProperty('jqx-expander-header'));
                this._header.removeClass(this.toThemeProperty('jqx-expander-header-expanded'));
                this._header.removeClass(this.toThemeProperty('jqx-widget-header'));
                this._header_text.removeClass(this.toThemeProperty('jqx-expander-header-content'));
                this._header_text.removeClass(this.toThemeProperty('jqx-expander-header'));
                this._header_text.removeClass(this.toThemeProperty('jqx-widget-header'));
                this._header_text.removeClass(this.toThemeProperty('jqx-expander-header-expanded'));

                this._header.attr("tabindex", null);
                this._content.attr("tabindex", null);
                this._header.css("margin-top", 0);
                this._header[0].innerHTML = this._header_text[0].innerHTML;
                if (this.headerPosition == "bottom") {
                    this._header.detach();
                    this.host.prepend(this._header);
                }
            }
            // selects the initial header and creates a header wrapper
            this._header_temp = this.host.children("div:eq(0)");
            this._header_temp.wrap("<div></div>");

            // defines which div element is the header and which - the content
            this._header = this.host.children("div:eq(0)");
            this._content = this.host.children("div:eq(1)");
            if (this.headerPosition == "bottom") {
                this._header.detach();
                this.host.append(this._header);
            }

            // defines the header text section
            this._header_text = this._header.children("div:eq(0)");
            var className = this._header_text[0].className;
            this._header.addClass(className);
            this._header_text.removeClass();
            if (!this.rtl) {
                this._header_text.addClass(this.toThemeProperty('jqx-expander-header-content'));
            }
            else {
                this._header_text.addClass(this.toThemeProperty('jqx-expander-header-content-rtl'));
            }

            // appends an arrow to the header
            this._header.append("<div></div>");
            this._arrow = this._header.children("div:eq(1)");
            if (this.showArrow == true) {
                this._arrow.css("display", "inherit");
            } else {
                this._arrow.css("display", "none");
            };

            // sets the tabindex attribute of the header and conten if it is not already set
            this.tI = -1;
            if (this._header.attr("tabindex") == undefined) {
                this.tI++;
                this._header.attr("tabindex", this.tI);
            };
            if (this._content.attr("tabindex") == undefined) {
                this.tI++;
                this._content.attr("tabindex", this.tI);
            };

            // sets the expander's theme and classes
            this._setTheme();

            // checks if the content is empty
            this._checkContent();

            // checks whether the HTML structure of the widget is valid and alerts the user if not
            var exceptionMessage = "Invalid jqxExpander structure. Please add only two child div elements to your jqxExpander div that will represent the expander's header and content.";
            try {
                if (this._header.length == 0 || this._content.length == 0 || this.host.children().length < 2 || this.host.children().length > 2) {
                    throw exceptionMessage;
                };
            } catch (exception) {
                alert(exception);
            };

            // checks if content is expanded initially
            this._expandChecker;
            this._initialized;
            if (this.expanded == true) {
                if (this.headerPosition == "top") {
                    this._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-up"));
                    this._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-up-selected"));
                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-bottom"));
                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-expanded"));
                } else if (this.headerPosition == "bottom") {
                    this._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-down"));
                    this._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-down-selected"));
                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-top"));
                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-expanded-top"));
                };
                if (this.initContent) {
                    this._setSize();
                    this.initContent();
                };
                this._initialized = true;
                this._expandChecker = 0;
            } else if (this.expanded == false) {
                this._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-down-selected"));
                this._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-up-selected"));
                if (this.headerPosition == "top") {
                    this._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-down"));
                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-top"));
                } else if (this.headerPosition == "bottom") {
                    this._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-up"));
                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-bottom"));
                };
                this._initialized = false;
                this._expandChecker = 1;
                this._content.css("display", "none");
            };

            // sets the width and height of the widget
            this._setSize();

            // toggles the widget
            if (this.disabled == false) {
                this._toggle();
            };

            // adds keyboard interaction
            this._keyBoard();
            var that = this;

            $.jqx.utilities.resize(this.host, function () {
                that.invalidate();
            });
        },

        // removes the widget
        destroy: function () {
            this.removeHandler($(window), 'resize.expander' + this.widgetID);
            this.host.remove();
            $(this.element).removeData('jqxExpander');
        },

        // focuses on the widget
        focus: function () {
            try {
                if (this.disabled == false) {
                    this._header.focus();
                };
            }
            catch (error) {
            }
        },

        //// private methods

        // called when a property is changed
        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (key == "expanded") {
                if (value == true && oldvalue == false) {
                    this.expanded = false;
                    this.expand();
                } else if (value == false && oldvalue == true) {
                    this.expanded = true;
                    this.collapse();
                };
            } else {
                this.refresh();
            };
        },

        // raises an event
        _raiseEvent: function (id, args) {
            var evt = this.events[id];
            var event = new jQuery.Event(evt);
            event.owner = this;
            event.args = args;

            try {
                var result = this.host.trigger(event);
            }
            catch (error) {
            }

            return result;
        },

        // sets the width and height of the widget
        _setSize: function () {
            this.host.width(this.width);
            this.host.height(this.height);

            this._header.height("auto");
            this._header.css("min-height", this._arrow.height());

            // sets the arrow position
            //    this._arrow.css("top", "50%");
            //  this._arrow.css("margin-top", -this._arrow.height() / 2);
            var arrowPosition = this.arrowPosition;
            if (this.rtl) {
                switch (arrowPosition) {
                    case 'left':
                        arrowPosition = 'right';
                        break;
                    case 'right':
                        arrowPosition = 'left';
                        break;
                }
            }
            if (arrowPosition == "right") {
                this._header_text.css({ "float": "left", "margin-left": "0px" });
                this._arrow.css({ "float": "right", "position": "relative" });
            } else if (arrowPosition == "left") {
                if (this.width == "auto") {
                    this._header_text.css({ "float": "left", "margin-left": "17px" });
                    this._arrow.css({ "float": "left", "position": "absolute" });
                } else {
                    this._header_text.css({ "float": "right", "margin-left": "0px" });
                    this._arrow.css({ "float": "left", "position": "relative" });
                };
            };
            this._arrow.css("margin-top", this._header_text.height() / 2 - this._arrow.height() / 2);

            if (this.height == "auto") {
                this._content.height("auto");
                this._contentHeight = this._content.height();
            } else {
                this._content.height("auto");
                var newHeight = Math.round(this.host.height()) - Math.round(this._header.outerHeight()) - 1;
                if (newHeight < 0) newHeight = 0;
                if (!this._contentHeight) {
                    this._contentHeight = this._content.height();
                }
                if (newHeight != this._contentHeight) {
                    this._content.height(newHeight);
                    this._contentHeight = Math.round(this._content.outerHeight());
                }
                else this._content.height(this._contentHeight);
                
            };
        },

        // toggles the expander
        _toggle: function () {
            var me = this;
            if (this._isTouchDevice == false) {
                this._header.removeClass(this.toThemeProperty("jqx-expander-header-disabled"));
                switch (this.toggleMode) {
                    case 'click':
                        this.addHandler(this._header, 'click.expander' + this.widgetID, function () {
                            me._animate();
                        });
                        break;
                    case 'dblclick':
                        this.addHandler(this._header, 'dblclick.expander' + this.widgetID, function () {
                            me._animate();
                        });
                        break;
                    case 'none':
                        this._header.addClass(this.toThemeProperty("jqx-expander-header-disabled"));
                        break;
                };
            } else {
                if (this.toggleMode != "none") {
                    this.addHandler(this._header, $.jqx.mobile.getTouchEventName('touchstart') + "." + this.widgetID, function () {
                        me._animate();
                    });
                } else {
                    return;
                };
            };
        },

        // calls for either expand() or collapse()
        _animate: function () {
            if (this.expanded == true) {
                this.collapse();
                this._header.addClass(this.toThemeProperty("jqx-fill-state-hover"));
                this._header.addClass(this.toThemeProperty("jqx-expander-header-hover"));
                if (this.headerPosition == "top") {
                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-top-hover"));
                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-down-hover"));
                } else if (this.headerPosition == "bottom") {
                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-bottom-hover"));
                    this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-up-hover"));
                };
            } else {
                this.expand();
                this._header.removeClass(this.toThemeProperty("jqx-fill-state-hover"));
                this._header.removeClass(this.toThemeProperty("jqx-expander-header-hover"));
                if (this.headerPosition == "top") {
                    this._arrow.removeClass(this.toThemeProperty("jqx-expander-arrow-top-hover"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-expander-arrow-down-hover"));
                } else if (this.headerPosition == "bottom") {
                    this._arrow.removeClass(this.toThemeProperty("jqx-expander-arrow-bottom-hover"));
                    this._arrow.removeClass(this.toThemeProperty("jqx-expander-arrow-up-hover"));
                };
            };
        },

        // removes event handlers
        _removeHandlers: function () {
            this.removeHandler(this._header, 'click.expander' + this.widgetID);
            this.removeHandler(this._header, 'dblclick.expander' + this.widgetID);
            this.removeHandler(this._header, 'mouseenter.expander' + this.widgetID);
            this.removeHandler(this._header, 'mouseleave.expander' + this.widgetID);
        },

        // sets the expander's theme and classes
        _setTheme: function () {
            var me = this;
            this.host.addClass(this.toThemeProperty("jqx-widget"));
            this._header.addClass(this.toThemeProperty("jqx-widget-header"));
            this._content.addClass(this.toThemeProperty("jqx-widget-content"));
            if (this.rtl == true) {
                this.host.addClass(this.toThemeProperty("jqx-rtl"));
            };

            if (this.disabled == false) {
                this._header.removeClass(this.toThemeProperty("jqx-expander-header-disabled"));
                this.host.removeClass(this.toThemeProperty("jqx-fill-state-disabled"));
                if (this.expanded == true) {
                    this._header.addClass(this.toThemeProperty("jqx-fill-state-pressed"));
                    this._header.addClass(this.toThemeProperty("jqx-expander-header-expanded"));
                } else {
                    this._header.addClass(this.toThemeProperty("jqx-fill-state-normal"));
                    this._header.removeClass(this.toThemeProperty("jqx-expander-header-expanded"));
                };

                this._hovered = false;
                if (!me._isTouchDevice) {
                    // adds events on hover over header
                    this.addHandler(this._header, 'mouseenter.expander' + this.widgetID, function () {
                        me._hovered = true;
                        if (me._expandChecker == 1) {
                            me._header.removeClass(me.toThemeProperty("jqx-fill-state-normal"));
                            me._header.removeClass(me.toThemeProperty("jqx-fill-state-pressed"));
                            me._header.addClass(me.toThemeProperty("jqx-fill-state-hover"));
                            me._header.addClass(me.toThemeProperty("jqx-expander-header-hover"));
                            if (me.headerPosition == "top") {
                                if (me.expanded) {
                                    me._arrow.addClass(me.toThemeProperty("jqx-icon-arrow-up-hover"));
                                }
                                else {
                                    me._arrow.addClass(me.toThemeProperty("jqx-icon-arrow-down-hover"));
                                }

                                me._arrow.addClass(me.toThemeProperty("jqx-expander-arrow-top-hover"));
                                me._arrow.addClass(me.toThemeProperty("jqx-expander-arrow-down-hover"));
                            } else if (me.headerPosition == "bottom") {
                                if (me.expanded) {
                                    me._arrow.addClass(me.toThemeProperty("jqx-icon-arrow-down-hover"));
                                }
                                me._arrow.addClass(me.toThemeProperty("jqx-expander-arrow-bottom-hover"));
                                me._arrow.addClass(me.toThemeProperty("jqx-expander-arrow-up-hover"));
                            };
                        };
                    });
                    this.addHandler(this._header, 'mouseleave.expander' + this.widgetID, function () {
                        me._hovered = false;
                        me._header.removeClass(me.toThemeProperty("jqx-fill-state-hover"));
                        me._arrow.removeClass(me.toThemeProperty("jqx-icon-arrow-up-hover"));
                        me._arrow.removeClass(me.toThemeProperty("jqx-icon-arrow-down-hover"));

                        me._header.removeClass(me.toThemeProperty("jqx-expander-header-hover"));
                        if (me.headerPosition == "top") {
                            me._arrow.removeClass(me.toThemeProperty("jqx-expander-arrow-top-hover"));
                            me._arrow.removeClass(me.toThemeProperty("jqx-expander-arrow-down-hover"));
                        } else if (me.headerPosition == "bottom") {
                            me._arrow.removeClass(me.toThemeProperty("jqx-expander-arrow-bottom-hover"));
                            me._arrow.removeClass(me.toThemeProperty("jqx-expander-arrow-up-hover"));
                        };
                        if (me._expandChecker == 1) {
                            me._header.addClass(me.toThemeProperty("jqx-fill-state-normal"));
                        } else {
                            me._header.addClass(me.toThemeProperty("jqx-fill-state-pressed"));
                        };
                    });
                }
            } else {
                this.host.addClass(this.toThemeProperty("jqx-fill-state-disabled"));
                this._header.addClass(this.toThemeProperty("jqx-expander-header-disabled"));
            };

            this.host.addClass(this.toThemeProperty("jqx-expander"));
            this._header.addClass(this.toThemeProperty("jqx-expander-header"));
            this._content.addClass(this.toThemeProperty("jqx-expander-content"));
            if (this.headerPosition == "top") {
                this._content.addClass(this.toThemeProperty("jqx-expander-content-bottom"));
            } else if (this.headerPosition == "bottom") {
                this._content.addClass(this.toThemeProperty("jqx-expander-content-top"));
            };
            this._arrow.addClass(this.toThemeProperty("jqx-expander-arrow"));
        },

        // checks if the content is empty
        _checkContent: function () {
            this._cntntEmpty = /^\s*$/.test(this._content.html());
            if (this._cntntEmpty == true) {
                this._content.height(0);
                this._content.addClass(this.toThemeProperty("jqx-expander-content-empty"));
            } else {
                this._content.height(this._contentHeight);
                this._content.removeClass(this.toThemeProperty("jqx-expander-content-empty"));
            };
        },

        // adds keyboard interaction
        _keyBoard: function () {
            var me = this;
            this._focus();

            this.addHandler(this.host, 'keydown.expander' + this.widgetID, function (event) {
                var handled = false;
                if ((me.focusedH == true || me.focusedC == true) && me.disabled == false) {

                    // functionality for different keys
                    switch (event.keyCode) {
                        case 13:
                        case 32:
                            if (me.toggleMode != 'none') {
                                if (me.focusedH == true) {
                                    me._animate();
                                };
                                handled = true;
                            }
                            break;
                        case 38:
                            if (event.ctrlKey == true && me.focusedC == true) {
                                me._header.focus();
                            };
                            handled = true;
                            break;
                        case 40:
                            if (event.ctrlKey == true && me.focusedH == true) {
                                me._content.focus();
                            };
                            handled = true;
                            break;
                        //                        case 9:                         
                        //                            me._header.focus();                         
                        //                            handled = true;                         
                        //                            break;                         
                    };
                    return true;
                };

                if (handled && event.preventDefault) {
                    event.preventDefault();
                };

                return !handled;
            });
        },

        // focuses/blurs the headers and contents
        _focus: function () {
            var me = this;
            this.addHandler(this._header, 'focus.expander' + this.widgetID, function () {
                me.focusedH = true;
                $.jqx.aria(me._header, "aria-selected", true);
                me._header.addClass(me.toThemeProperty("jqx-fill-state-focus"));
            });
            this.addHandler(this._header, 'blur.expander' + this.widgetID, function () {
                me.focusedH = false;
                $.jqx.aria(me._header, "aria-selected", false);
                me._header.removeClass(me.toThemeProperty("jqx-fill-state-focus"));
            });
            this.addHandler(this._header_text, 'focus.expander' + this.widgetID, function () {
                me._header.focus();
            });
            this.addHandler(this._arrow, 'focus.expander' + this.widgetID, function () {
                me._header.focus();
            });
            this.addHandler(this._content, 'focus.expander' + this.widgetID, function () {
                me.focusedC = true;
                me._content.addClass(me.toThemeProperty("jqx-fill-state-focus"));
            });
            this.addHandler(this._content, 'blur.expander' + this.widgetID, function () {
                me.focusedC = false;
                me._content.removeClass(me.toThemeProperty("jqx-fill-state-focus"));
            });
        }
    });
})(jQuery);﻿/*
* Depends:
*   jqxcore.js
*/

(function ($) {

    $.jqx.jqxWidget("jqxNavigationBar", "", {});

    $.extend($.jqx._jqxNavigationBar.prototype, {

        defineInstance: function () {
            //// properties common for both jqxExpander and jqxNavigationBar
            this.width = 'auto';
            this.height = 'auto';
            this.expandAnimationDuration = 250;
            this.collapseAnimationDuration = 250;
            this.animationType = 'slide'; // possible values: 'slide', 'fade', 'none'
            this.toggleMode = 'click'; //possible values: 'click', 'dblclick', 'none'
            this.showArrow = true; // possible values: true, false
            this.arrowPosition = 'right'; // possible values: 'left', 'right'
            this.disabled = false; // possible values: true, false
            this.initContent = null; // callback function
            this.rtl = false; // possible values: true, false
            this.easing = 'easeInOutSine'; // possible values: easeOutBack, easeInQuad, easeInOutCirc, easeInOutSine, easeInCubic, easeOutCubic, easeInOutCubic, easeInSine, easeOutSine, easeInOutSine
            //// jqxNavigationBar-specific properties
            this.expandMode = 'singleFitHeight'; // possible values: 'single', 'singleFitHeight', 'multiple', 'toggle', 'none'
            this.expandedIndexes = []; // possible values: empty array (no expanded items) or an array of positive integers
            this._expandModes = ['singleFitHeight', 'single', 'multiple', 'toggle', 'none'];
            this.aria =
                 {
                     "aria-disabled": { name: "disabled", type: "boolean" }
                 };

            //// events
            this.events = ['expandingItem', 'expandedItem', 'collapsingItem', 'collapsedItem'];
        },

        createInstance: function (args) {
            this._isTouchDevice = $.jqx.mobile.isTouchDevice();
            // renders the widget
            $.jqx.aria(this);
            this.render();
        },

        //// methods

        val: function (value) {
            if (arguments.length == 0 || typeof (value) == "object") {
                return this.expandedIndexes;
            }

            if (typeof value == "string") {
                this.expandedIndexes.push(parseInt(value));
                this._applyExpandedIndexes();
            }
            else {
                if ($.isArray(value)) {
                    this.expandedIndexes = value;
                }
                else {
                    this.expandedIndexes = new Array();
                    this.expandedIndexes.push(value);
                }
                this._applyExpandedIndexes();
            }
            return this.expandedIndexes;
        },

        //// public methods

        // expands the content
        expandAt: function (index) {
            var me = this;
            if (this.expandMode == 'single' || this.expandMode == 'singleFitHeight' || this.expandMode == 'toggle') {
                $.each(this.items, function (itemIndex, value) {
                    if (itemIndex != index) {
                        me.collapseAt(itemIndex);
                    };
                });
            };

            var selectedItem = this.items[index];
            if (selectedItem.disabled == false && selectedItem.expanded == false && selectedItem._expandChecker == 1) {
                var me = this;
                selectedItem._expandChecker = 0;
                this._raiseEvent('0', { item: index });
                selectedItem._header.removeClass(this.toThemeProperty("jqx-fill-state-normal"));
                selectedItem._header.addClass(this.toThemeProperty("jqx-fill-state-pressed"));
                selectedItem._header.addClass(this.toThemeProperty("jqx-expander-header-expanded"));
                selectedItem._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-down"));
                selectedItem._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-down-hover"));
                selectedItem._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-up-hover"));
                selectedItem._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-down-selected"));
                selectedItem._arrow.removeClass(this.toThemeProperty("jqx-expander-arrow-top"));
                selectedItem._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-up"));
                selectedItem._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-up-selected"));
                selectedItem._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-bottom"));
                selectedItem._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-expanded"));

                if (this.heightFlag == false) {
                    this.host.css({ "overflow-x": "hidden", "overflow-y": "hidden" });
                };

                this.eCFlag = 1;

                switch (this.animationType) {
                    case 'slide':
                        var content = selectedItem._content;
                        var height = content.height();
                        var showProps = {};
                        showProps.height = showProps.paddingTop = showProps.paddingBottom =
                            showProps.borderTopWidth = showProps.borderBottomWidth = "show";
                        var adjust = 0;
                        var total = content.outerHeight();

                        if ($.jqx.browser.msie && $.jqx.browser.version < 9) {
                            var showProps = {};
                            showProps.height = showProps.paddingTop = showProps.paddingBottom =
                                "show";
                        }

                        content.animate(showProps,
                            {
                                duration: this.expandAnimationDuration,
                                easing: this.easing,
                                step: function (now, fx) {
                                    fx.now = Math.round(now);
                                    if (fx.prop !== "height") {
                                        adjust += fx.now;
                                    } else {
                                        if (me._collapseContent) {
                                            fx.now = Math.round(total - me._collapseContent.outerHeight() - adjust);
                                            adjust = 0;
                                        }
                                        else {
                                            fx.now = Math.round(now);
                                        }
                                    }
                                },
                                complete: function () {
                                    selectedItem.expanded = true;
                                    $.jqx.aria(selectedItem._header, "aria-expanded", true);
                                    $.jqx.aria(selectedItem._content, "aria-hidden", false);

                                    me._updateExpandedIndexes();
                                    me._raiseEvent('1', { item: index });
                                    me._checkHeight();
                                    if (me.heightFlag == true) {
                                        me.host.css({ "overflow-x": "hidden", "overflow-y": "auto" });
                                    };
                                    if (me.initContent && selectedItem._initialized == false) {
                                        me.initContent(index);
                                        selectedItem._initialized = true;
                                    };
                                    me.eCFlag = 0;
                                }
                            });
                        break;
                    case 'fade':
                        setTimeout(function () {
                            selectedItem._content.fadeIn(this.expandAnimationDuration, function () {
                                selectedItem.expanded = true;
                                $.jqx.aria(selectedItem._header, "aria-expanded", true);
                                $.jqx.aria(selectedItem._content, "aria-hidden", false);
                                me._updateExpandedIndexes();
                                me._raiseEvent('1', { item: index });
                                me._checkHeight();
                                if (me.heightFlag == true) {
                                    me.host.css({ "overflow-x": "hidden", "overflow-y": "auto" });
                                };
                                if (me.initContent && selectedItem._initialized == false) {
                                    me.initContent(index);
                                    selectedItem._initialized = true;
                                };
                                me.eCFlag = 0;
                            });
                        }, this.collapseAnimationDuration);
                        break;
                    case 'none':
                        selectedItem._content.css("display", "inherit");
                        selectedItem.expanded = true;
                        $.jqx.aria(selectedItem._header, "aria-expanded", true);
                        $.jqx.aria(selectedItem._content, "aria-hidden", false);
                        this._updateExpandedIndexes();
                        this._raiseEvent('1', { item: index });
                        this._checkHeight();
                        if (this.heightFlag == true) {
                            this.host.css({ "overflow-x": "hidden", "overflow-y": "auto" });
                        };
                        if (this.initContent && selectedItem._initialized == false) {
                            this.initContent(index);
                            selectedItem._initialized = true;
                        };
                        this.eCFlag = 0;
                        break;
                };
            };
        },

        // collapses the content
        collapseAt: function (index) {
            var selectedItem = this.items[index];
            if (selectedItem.disabled == false && selectedItem.expanded == true && selectedItem._expandChecker == 0) {
                var me = this;
                selectedItem._expandChecker = 1;
                this._raiseEvent('2', { item: index });
                selectedItem._header.removeClass(this.toThemeProperty("jqx-fill-state-pressed"));
                selectedItem._header.removeClass(this.toThemeProperty("jqx-expander-header-expanded"));
                selectedItem._header.addClass(this.toThemeProperty("jqx-fill-state-normal"));
                selectedItem._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-up"));
                selectedItem._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-up-selected"));
                selectedItem._arrow.removeClass(this.toThemeProperty("jqx-icon-arrow-down-selected"));
                selectedItem._arrow.removeClass(this.toThemeProperty("jqx-expander-arrow-bottom"));
                selectedItem._arrow.removeClass(this.toThemeProperty("jqx-expander-arrow-expanded"));

                selectedItem._arrow.addClass(this.toThemeProperty("jqx-icon-arrow-down"));
                selectedItem._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-top"));

                if (this.heightFlag == false) {
                    this.host.css({ "overflow-x": "hidden", "overflow-y": "hidden" });
                };

                this.eCFlag = 1;
                this._collapseContent = selectedItem._content;

                switch (this.animationType) {
                    case 'slide':
                        var hideProps = {};
                        hideProps.height = hideProps.paddingTop = hideProps.paddingBottom =
                    	hideProps.borderTopWidth = hideProps.borderBottomWidth = "hide";

                        if ($.jqx.browser.msie && $.jqx.browser.version < 9) {
                            var hideProps = {};
                            hideProps.height = hideProps.paddingTop = hideProps.paddingBottom =
                            "hide";
                        }

                        var content = selectedItem._content;
                        content.animate(hideProps, {
                            duration: this.collapseAnimationDuration,
                            step: function (now, fx) {
                                fx.now = Math.round(now);
                            },
                            easing: this.easing,
                            complete: function () {
                                selectedItem.expanded = false;
                                content.hide();

                                $.jqx.aria(selectedItem._header, "aria-expanded", false);
                                $.jqx.aria(selectedItem._content, "aria-hidden", true);

                                me._updateExpandedIndexes();
                                me._raiseEvent('3', { item: index });
                                me._checkHeight();
                                if (me.heightFlag == true) {
                                    me.host.css({ "overflow-x": "hidden", "overflow-y": "auto" });
                                };
                                me.eCFlag = 0;
                                me._collapseContent = null;
                            }
                        });
                        break;
                    case 'fade':
                        selectedItem._content.fadeOut(this.collapseAnimationDuration, function () {
                            selectedItem.expanded = false;
                            $.jqx.aria(selectedItem._header, "aria-expanded", false);
                            $.jqx.aria(selectedItem._content, "aria-hidden", true);
                            me._updateExpandedIndexes();
                            me._raiseEvent('3', { item: index });
                            me._checkHeight();
                            if (me.heightFlag == true) {
                                me.host.css({ "overflow-x": "hidden", "overflow-y": "auto" });
                            };
                            me.eCFlag = 0;
                        });
                        break;
                    case 'none':
                        selectedItem._content.css("display", "none");
                        selectedItem.expanded = false;
                        $.jqx.aria(selectedItem._header, "aria-expanded", false);
                        $.jqx.aria(selectedItem._content, "aria-hidden", true);

                        this._updateExpandedIndexes();
                        this._raiseEvent('3', { item: index });
                        this._checkHeight();
                        if (this.heightFlag == true) {
                            this.host.css({ "overflow-x": "hidden", "overflow-y": "auto" });
                        };
                        this.eCFlag = 0;
                        break;
                };
            };
        },

        // sets the header content of a specific item
        setHeaderContentAt: function (index, headerContent) {
            this.items[index]._header_text.html(headerContent);
        },

        // gets the header content of a specific item
        getHeaderContentAt: function (index) {
            return this.items[index]._header_text.html();
        },

        // sets the content of a specific item
        setContentAt: function (index, content) {
            this.items[index]._content.html(content);
            this._checkContent(index);
        },

        // gets the content of a specific item
        getContentAt: function (index) {
            return this.items[index]._content.html();
        },

        // shows the arrow at a specific position
        showArrowAt: function (index) {
            this.items[index]._arrow.css("display", "block");
        },

        // hides the arrow at a specific position
        hideArrowAt: function (index) {
            this.items[index]._arrow.css("display", "none");
        },

        // enables the widget
        enable: function () {
            this.disabled = false;
            $.each(this.items, function (index, value) {
                this.disabled = false;
            });
            this._enabledDisabledCheck();
            this.refresh();
            $.jqx.aria(this, "aria-disabled", false);
        },

        // disables the widget
        disable: function () {
            this.disabled = true;
            $.each(this.items, function (index, value) {
                this.disabled = true;
            });
            this._enabledDisabledCheck();
            this.refresh();
            $.jqx.aria(this, "aria-disabled", true);
        },

        // enables a specific item
        enableAt: function (index) {
            this.items[index].disabled = false;
            this.refresh();
        },

        // disables a specific item
        disableAt: function (index) {
            this.items[index].disabled = true;
            this.refresh();
        },

        // refreshes the widget
        invalidate: function () {
            this.refresh();
        },

        // refreshes the widget
        refresh: function (initialRefresh) {
            if (initialRefresh == true) {
                return;
            };

            this._removeHandlers();
            if (this.showArrow == true) {
                $.each(this.items, function (index, value) {
                    var item = this;
                    item._arrow.css("display", "block");
                });
            } else {
                $.each(this.items, function (index, value) {
                    var item = this;
                    item._arrow.css("display", "none");
                });
            };
            this._updateExpandedIndexes();
            this._setTheme();
            this._setSize();
            this._toggle();
            this._keyBoard();
        },

        // renders the widget
        render: function () {
            this.widgetID = this.element.id;
            var me = this;
            if (this._expandModes.indexOf(this.expandMode) == -1) {
                this.expandMode = "singleFitHeight";
            }

            $.jqx.utilities.resize(this.host, function () {
                me._setSize();
            });
  
            this.host.attr("role", "tablist");
            // creates an array containing all items.
            if (this.items) {
                this._removeHandlers();
                $.each(this.items, function () {
                    this._header.removeClass();
                    this._header.attr("tabindex", null);
                    this._content.attr("tabindex", null);
                    this._header[0].className = "";
                    this._header_text.removeClass();
                    this._header_text[0].className = "";
                    this._header.css("margin-top", 0);
                    this._header[0].innerHTML = this._header_text[0].innerHTML;
                });
            }
            this.items = new Array();

            var childrenCount = this.host.children().length;

            // checks whether the HTML structure of the widget is valid and alerts the user if not
            var childrenCountExceptionMessage = "Invalid jqxNavigationBar structure. Please add an even number of child div elements that will represent each item's header and content.";
            try {
                if (childrenCount % 2 != 0) {
                    throw childrenCountExceptionMessage;
                };
            } catch (exception) {
                alert(exception);
            };

            var childrenTypeExceptionMessage = "Invalid jqxNavigationBar structure. Please make sure all the children elements of the navigationbar are divs.";
            try {
                var children = this.host.children();
                for (var i = 0; i < childrenCount; i++) {
                    if (children[i].tagName.toLowerCase() != "div") {
                        throw childrenTypeExceptionMessage;
                    };
                };
            } catch (exception) {
                alert(exception);
            };

            // selects each initial header and creates a header wrapper
            var _header_temp;
            for (var item = 0; item < childrenCount; item += 2) {
                _header_temp = this.host.children("div:eq(" + item + ")");
                _header_temp.wrap("<div></div>");
            };

            // populates the items array
            var i = 0;
            var k;
            for (var j = 0; j < childrenCount / 2; j++) {
                k = i + 1;
                this.items[j] = new Object();
                this.items[j]._header = this.host.children("div:eq(" + i + ")");
                this.items[j]._header.attr("role", "tab")

                this.items[j]._content = this.host.children("div:eq(" + k + ")");
                this.items[j]._content.attr("role", "tabpanel");
                i += 2;
            };

            // sets which items are expanded
            var expandedIndexesLength = this.expandedIndexes.length;
            $.each(this.items, function (index, value) {
                this.expandedFlag = false;
                this.focusedH = false;
                this.focusedC = false;
            });
            if (this.items && this.items.length == 0) return;
            if (this.expandMode == "single" || this.expandMode == "singleFitHeight" || this.expandMode == "toggle" || this.expandMode == "none") {
                $.each(this.items, function (index, value) {
                    var item = this;
                    item.expanded = false;
                });
                if (expandedIndexesLength != 0) {
                    this.items[this.expandedIndexes[0]].expanded = true;
                } else if (expandedIndexesLength == 0 && (this.expandMode == "single" || this.expandMode == "singleFitHeight")) {
                    this.items[0].expanded = true;
                };
            } else if (this.expandMode == "multiple") {
                if (expandedIndexesLength != 0) {
                    $.each(this.items, function (index, value) {
                        var item = this;
                        for (var i = 0; i < expandedIndexesLength; i++) {
                            if (me.expandedIndexes[i] == index) {
                                item.expanded = true;
                                break;
                            } else {
                                item.expanded = false;
                            };
                        };
                    });
                } else {
                    $.each(this.items, function (index, value) {
                        var item = this;
                        item.expanded = false;
                    });
                };
            } else if (this.expandMode == "none") {
                $.each(this.items, function (index, value) {
                    var item = this;
                    item.expanded = false;
                });
            };

            this._enabledDisabledCheck();

            $.each(this.items, function (index, value) {
                var item = this;
                // defines the header text section
                item._header_text = item._header.children("div:eq(0)");
                if (!me.rtl) {
                    item._header_text.addClass(me.toThemeProperty('jqx-expander-header-content'));
                }
                else {
                    item._header_text.addClass(me.toThemeProperty('jqx-expander-header-content-rtl'));
                }

                // appends an arrow to the header
                item._header.append("<div></div>");
                item._arrow = item._header.children("div:eq(1)");
                if (me.showArrow == true) {
                    item._arrow.css("display", "block");
                } else {
                    item._arrow.css("display", "none");
                };
            });

            // checks if content is expanded initially
            $.each(this.items, function (index, value) {
                var item = this;
                if (item.expanded == true) {
                    item._arrow.addClass(me.toThemeProperty("jqx-icon-arrow-up"));
                    item._arrow.addClass(me.toThemeProperty("jqx-icon-arrow-up-selected"));
                    item._arrow.addClass(me.toThemeProperty("jqx-expander-arrow-bottom"));
                    item._arrow.addClass(me.toThemeProperty("jqx-expander-arrow-expanded"));
                    if (me.initContent) {
                        me.initContent(index);
                    };
                    item._initialized = true;
                    item._expandChecker = 0;
                    $.jqx.aria(item._header, "aria-expanded", true);
                    $.jqx.aria(item._content, "aria-hidden", false);
                } else if (item.expanded == false) {
                    item._arrow.addClass(me.toThemeProperty("jqx-icon-arrow-down"));
                    item._arrow.addClass(me.toThemeProperty("jqx-expander-arrow-top"));
                    item._initialized = false;
                    item._expandChecker = 1;
                    item._content.css("display", "none");
                    $.jqx.aria(item._header, "aria-expanded", false);
                    $.jqx.aria(item._content, "aria-hidden", true);
                };
            });

            // sets the tabindex attribute of headers and content if it is not already set
            this.tI = 0;
            $.each(this.items, function (index, value) {
                var item = this;
                if (item._header.attr("tabindex") == undefined) {
                    me.tI++;
                    item._header.attr("tabindex", me.tI);
                };
                if (item._content.attr("tabindex") == undefined) {
                    me.tI++;
                    item._content.attr("tabindex", me.tI);
                };
            });

            // sets the expander's theme and classes
            this._setTheme();

            // checks if the content is empty
            $.each(this.items, function (index, value) {
                var item = this;
                me._checkContent(index);
            });

            // sets the width and height of the widget
            this._setSize();

            // toggles the widget
            this._toggle();

            // adds keyboard interaction
            this._keyBoard();
        },

        // inserts an item at a specific index
        insert: function (index, header, content) {
            var newItemHTML = "<div>" + header + "</div><div>" + content + "</div>";
            if (index != -1) {
                $(newItemHTML).insertBefore(this.items[index]._header);
            } else {
                var lastIndex = this.items.length - 1;
                $(newItemHTML).insertAfter(this.items[lastIndex]._content);
            };

            this.render();
        },

        // inserts an item at the bottom of the navigationbar
        add: function (header, content) {
            this.insert(-1, header, content);
        },

        // updates the header and content of an item at a specific index
        update: function (index, header, content) {
            this.setHeaderContentAt(index, header);
            this.setContentAt(index, content);
        },

        // removes an item at a specific index
        remove: function (index) {
            if (isNaN(index)) {
                index = this.items.length - 1;
            };
            if (!this.items[index]) {
                return;
            }

            this.items[index]._header.remove();
            this.items[index]._content.remove();
            this.items.splice(index, 1);
            var expandedIndex = this.expandedIndexes.indexOf(index);
            if (expandedIndex > -1) {
                this.expandedIndexes.splice(expandedIndex, 1);
            }
            this.render();
        },

        // removes the widget
        destroy: function () {
            this._removeHandlers();
            this.host.remove();
        },

        // focuses on the widget
        focus: function () {
            try {
                $.each(this.items, function (index, value) {
                    var item = this;
                    if (item.disabled == false) {
                        item._header.focus();
                        return false;
                    };
                });
            }
            catch (error) {
            }
        },

        //// private methods

        _applyExpandedIndexes: function()
        {
            var me = this;
            var expandedIndexesCount = this.expandedIndexes.length;
            for (var i = 0; i < expandedIndexesCount; i++) {
                var eIndex = me.expandedIndexes[i];
                $.each(this.items, function (index, value) {
                    var item = this;
                    if (index == eIndex) {
                        item.expandedFlag = true;
                        if (item.expanded == false) {
                            me.expandAt(index);
                        };
                        if (me.expandMode == "single" || me.expandMode == "singleFitHeight" || me.expandMode == "toggle" || me.expandMode == "none") {
                            return false;
                        };
                    };
                });
                $.each(this.items, function (index, value) {
                    var item = this;
                    if (index != eIndex && item.expandedFlag == false) {
                        me.collapseAt(index);
                    };
                });
            };
            $.each(this.items, function (index, value) {
                this.expandedFlag = false;
            });
        },

        // called when a property is changed
        propertyChangedHandler: function (object, key, oldvalue, value) {
            var me = object;
            var newvalue = value;
            if (key == "disabled") {
                object._enabledDisabledCheck();
            } else if (key == "expandedIndexes") {
                object._applyExpandedIndexes();
            } else {
                object.refresh();
            };
        },

        // raises an event
        _raiseEvent: function (id, args) {
            var evt = this.events[id];
            var event = new jQuery.Event(evt);
            event.owner = this;
            event.args = args;
            event.item = event.args.item;

            try {
                var result = this.host.trigger(event);
            }
            catch (error) {
            }

            return result;
        },

        // sets the width and height of the widget and the position of the arrow
        _setSize: function () {
            var me = this;
            this.headersHeight = 0;

            var paddingLeft = this.items && this.items.length > 0 ? parseInt(this.items[0]._header.css('padding-left')) : 0;
            var paddingRight = this.items && this.items.length > 0 ? parseInt(this.items[0]._header.css('padding-right')) : 0;
            var borderOffset = 2;
            var totalOffset = paddingLeft + paddingRight + borderOffset;
            if (isNaN(totalOffset)) totalOffset = 12;

            // sets the size of the widget
            if (this.width == "auto") {
                this.host.width(this.width);
            } else {
                if (this.width != null && this.width.toString().indexOf('%') != -1) {
                    this.host.width(this.width);
                }
                else {
                    this.host.width(this.width + totalOffset);
                };
            }
            this.host.height(this.height);

            // sets the size of each item
            $.each(this.items, function (index, value) {
                var item = this;

                var arrowPosition = me.arrowPosition;
                if (me.rtl) {
                    switch (arrowPosition) {
                        case 'left':
                            arrowPosition = 'right';
                            break;
                        case 'right':
                            arrowPosition = 'left';
                            break;
                    }
                }

                // sets the arrow position
                if (arrowPosition == "right") {
                    item._header_text.css({ "float": "left", "margin-left": "0px" });
                    item._arrow.css({ "float": "right", "position": "relative" });
                } else if (arrowPosition == "left") {
                    if (me.width == "auto") {
                        item._header_text.css({ "float": "left", "margin-left": "17px" });
                        item._arrow.css({ "float": "left", "position": "absolute" });
                    } else {
                        item._header_text.css({ "float": "right", "margin-left": "0px" });
                        item._arrow.css({ "float": "left", "position": "relative" });
                    };
                };

                // sets the height of the header
                item._header.height("auto");
                item._header_text.css("min-height", item._arrow.height());
                me.headersHeight += item._header.outerHeight();

                item._arrow.css("margin-top", item._header_text.height() / 2 - item._arrow.height() / 2);
            });

            // sets the height of the content
            $.each(this.items, function (index, value) {
                var item = this;

                if (me.height != "auto") {
                    if (me.expandMode == "single" || me.expandMode == "toggle" || me.expandMode == "multiple") {
                        me.host.css({ "overflow-x": "hidden", "overflow-y": "auto" });
                    } else if (me.expandMode == "singleFitHeight") {
                  //      item._content.css("overflow", "auto");

                        var padding = parseInt(item._content.css("padding-top")) + parseInt(item._content.css("padding-bottom"));
                        if (me.height && me.height.toString().indexOf("%") >= 0) {
                            item._content.height(me.host.height() - me.headersHeight - padding+2);
                        }
                        else {
                            item._content.height(me.host.height() - me.headersHeight - padding);
                        }
                    };
                };
            });

            me._checkHeight();
        },

        // toggles the expander
        _toggle: function () {
            var me = this;
            if (this._isTouchDevice == false) {
                switch (this.toggleMode) {
                    case 'click':
                        $.each(this.items, function (index, value) {
                            var item = this;
                            if (item.disabled == false) {
                                me.addHandler(item._header, 'click.navigationbar' + this.widgetID, function () {
                                    me.focusedH = true;
                                    me._animate(index);
                                });
                            };
                        });
                        break;
                    case 'dblclick':
                        $.each(this.items, function (index, value) {
                            var item = this;
                            if (item.disabled == false) {
                                me.addHandler(item._header, 'dblclick.navigationbar' + this.widgetID, function () {
                                    me.focusedH = true;
                                    me._animate(index);
                                });
                            };
                        });
                        break;
                    case 'none':
                        break;
                };
            } else {
                if (this.toggleMode != "none") {
                    $.each(this.items, function (index, value) {
                        var item = this;
                        if (item.disabled == false) {
                            me.addHandler(item._header, $.jqx.mobile.getTouchEventName('touchstart') + "." + this.widgetID, function () {
                                me._animate(index);
                            });
                        };
                    });
                } else {
                    return;
                };
            };
        },

        // calls for either expand() or collapse()
        _animate: function (index, keyboard) {
            var me = this;
            this.eCFlag;
            var selectedItem = this.items[index];
            if (this.expandMode != 'none' && this.eCFlag != 1) {
                if (this.items[index].expanded == true) {
                    if (this.expandMode == 'multiple' || this.expandMode == 'toggle') {
                        this.collapseAt(index);
                    };
                } else {
                    this.expandAt(index);
                };
                if (!me._isTouchDevice) {
                    if (keyboard != true) {
                        selectedItem._header.addClass(this.toThemeProperty("jqx-fill-state-hover"));
                        selectedItem._header.addClass(this.toThemeProperty("jqx-expander-header-hover"));
                        selectedItem._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-top-hover"));
                        selectedItem._arrow.addClass(this.toThemeProperty("jqx-expander-arrow-down-hover"));
                    }
                    else {
                        selectedItem._header.removeClass(this.toThemeProperty("jqx-fill-state-hover"));
                        selectedItem._header.removeClass(this.toThemeProperty("jqx-expander-header-hover"));
                        selectedItem._arrow.removeClass(this.toThemeProperty("jqx-expander-arrow-top-hover"));
                        selectedItem._arrow.removeClass(this.toThemeProperty("jqx-expander-arrow-down-hover"));
                    }
                }
            };
        },

        // removes event handlers
        _removeHandlers: function () {
            var me = this;
            this.removeHandler(this.host, 'keydown.navigationbar' + this.widgetID);

            $.each(this.items, function (index, value) {
                var item = this;
                me.removeHandler(item._header, 'click.navigationbar' + me.widgetID);
                me.removeHandler(item._header, 'dblclick.navigationbar' + me.widgetID);
                me.removeHandler(item._header, 'mouseenter.navigationbar' + me.widgetID);
                me.removeHandler(item._header, 'mouseleave.navigationbar' + me.widgetID);
                me.removeHandler(item._header, 'focus.navigationbar' + me.widgetID);
                me.removeHandler(item._header, 'blur.navigationbar' + me.widgetID);
                me.removeHandler(item._content, 'focus.navigationbar' + me.widgetID);
                me.removeHandler(item._content, 'blur.navigationbar' + me.widgetID);
                me.removeHandler(item._header_text, 'focus.navigationbar' + me.widgetID);
                me.removeHandler(item._arrow, 'focus.navigationbar' + me.widgetID);
            });
        },

        // sets the expander's theme and classes
        _setTheme: function () {
            var me = this;
            this.host.addClass(this.toThemeProperty('jqx-reset'));
            this.host.addClass(this.toThemeProperty("jqx-widget"));
            if (this.rtl == true) {
                this.host.addClass(this.toThemeProperty("jqx-rtl"));
            };

            $.each(this.items, function (index, value) {
                var item = this;
                item._header.css("position", "relative");
                item._content.css("position", "relative");
                item._header.addClass(me.toThemeProperty("jqx-widget-header"));
                item._content.addClass(me.toThemeProperty("jqx-widget-content"));

                if (item.disabled == false) {
                    item._header.removeClass(me.toThemeProperty("jqx-fill-state-disabled"));
                    item._content.removeClass(me.toThemeProperty("jqx-fill-state-disabled"));
                    if (item.expanded == true) {
                        item._header.addClass(me.toThemeProperty("jqx-fill-state-pressed"));
                        item._header.addClass(me.toThemeProperty("jqx-expander-header-expanded"));
                    } else {
                        item._header.addClass(me.toThemeProperty("jqx-fill-state-normal"));
                        item._header.removeClass(me.toThemeProperty("jqx-expander-header-expanded"));
                    };

                    if (!me._isTouchDevice) {
                        // adds events on hover over header
                        me.addHandler(item._header, 'mouseenter.navigationbar' + me.widgetID, function () {
                            if (item._expandChecker == 1) {
                                if (!item.focusedH) {
                                    item._header.css("z-index", 5);
                                }
                                item._header.removeClass(me.toThemeProperty("jqx-fill-state-normal"));
                                item._header.removeClass(me.toThemeProperty("jqx-fill-state-pressed"));
                                item._header.addClass(me.toThemeProperty("jqx-fill-state-hover"));
                                item._header.addClass(me.toThemeProperty("jqx-expander-header-hover"));
                                item._arrow.addClass(me.toThemeProperty("jqx-expander-arrow-top-hover"));
                                item._arrow.addClass(me.toThemeProperty("jqx-expander-arrow-down-hover"));
                                if (item.expanded) {
                                    item._arrow.addClass(me.toThemeProperty("jqx-icon-arrow-up-hover"));
                                }
                                else {
                                    item._arrow.addClass(me.toThemeProperty("jqx-icon-arrow-down-hover"));
                                }
                            };
                        });
                        me.addHandler(item._header, 'mouseleave.navigationbar' + me.widgetID, function () {
                            if (!item.focusedH) {
                                item._header.css("z-index", 0);
                            }
                            item._header.removeClass(me.toThemeProperty("jqx-fill-state-hover"));
                            item._header.removeClass(me.toThemeProperty("jqx-expander-header-hover"));
                            item._arrow.removeClass(me.toThemeProperty("jqx-expander-arrow-top-hover"));
                            item._arrow.removeClass(me.toThemeProperty("jqx-expander-arrow-down-hover"));
                            if (item._expandChecker == 1) {
                                item._header.addClass(me.toThemeProperty("jqx-fill-state-normal"));
                            } else {
                                item._header.addClass(me.toThemeProperty("jqx-fill-state-pressed"));
                            };
                            item._arrow.removeClass(me.toThemeProperty("jqx-icon-arrow-up-hover"));
                            item._arrow.removeClass(me.toThemeProperty("jqx-icon-arrow-down-hover"));
                        });
                    }
                } else {
                    item._header.addClass(me.toThemeProperty("jqx-fill-state-disabled"));
                    item._content.addClass(me.toThemeProperty("jqx-fill-state-disabled"));
                };

                me.host.addClass(me.toThemeProperty("jqx-navigationbar"));
                item._header.addClass(me.toThemeProperty("jqx-expander-header"));
                item._content.addClass(me.toThemeProperty("jqx-expander-content"));
                item._content.addClass(me.toThemeProperty("jqx-expander-content-bottom"));
                if (index != 0) {
                    item._header.css("margin-top", -1);
                };
                item._arrow.addClass(me.toThemeProperty("jqx-expander-arrow"));
            });
        },

        // checks if the content is empty
        _checkContent: function (index) {
            var item = this.items[index];
            var content = item._content;
            this._cntntEmpty = /^\s*$/.test(this.items[index]._content.html());
            if (this._cntntEmpty == true) {
                content.css("display", "none");
                content.height(0);
                content.addClass(this.toThemeProperty("jqx-expander-content-empty"));
            } else {
                if (item.expanded) {
                    content.css("display", "block");
                }
                if (this.expandMode == "singleFitHeight") {
                    var plus = 1;
                    if (index != 0) {
                        plus = 2;
                    };
                    content.height(this.host.height() - this.headersHeight + plus);
                } else {
                    content.height("auto");
                };
                content.removeClass(this.toThemeProperty("jqx-expander-content-empty"));
            };
        },

        // checks if the expanded widget's height is greater than the host element's
        _checkHeight: function () {
            var me = this;
            this.totalHeight = 0;
            this.heightFlag;
            var paddingLeft = this.items && this.items.length > 0 ? parseInt(this.items[0]._header.css('padding-left')) : 0;
            var paddingRight = this.items && this.items.length > 0 ? parseInt(this.items[0]._header.css('padding-right')) : 0;
            var borderOffset = 2;
            var totalOffset = paddingLeft + paddingRight + borderOffset;
            if (isNaN(totalOffset)) totalOffset = 12;
            var scrollWidth = 17;

            $.each(this.items, function (index, value) {
                var item = this;
                me.totalHeight += (item.expanded ? item._content.outerHeight() : 0) + item._header.outerHeight();
            });
            if (this.width != "auto" && this.height != "auto" && this.expandMode != "singleFitHeight") {
                if (this.totalHeight > this.host.height()) {
                    this.host.width(this.width + totalOffset + scrollWidth);
                    this.heightFlag = true;
                } else {
                    this.host.width(this.width + totalOffset);
                    this.heightFlag = false;
                };
            };
        },

        // checks whether the widget is disabled or enabled
        _enabledDisabledCheck: function () {
            var me = this;
            if (this.disabled == true) {
                $.each(this.items, function (index, value) {
                    var item = this;
                    item.disabled = true;
                });
            } else {
                $.each(this.items, function (index, value) {
                    var item = this;
                    item.disabled = false;
                });
            };
        },

        // updates the array of expanded indexes
        _updateExpandedIndexes: function () {
            var me = this;
            this.expandedIndexes = [];
            $.each(this.items, function (index, value) {
                var item = this;
                if (item.expanded == true) {
                    me.expandedIndexes.push(index);
                    if (me.expandMode == "single" || me.expandMode == "singleFitHeight" || me.expandMode == "toggle" || me.expandMode == "none") {
                        return false;
                    };
                };
            });
        },

        // adds keyboard interaction
        _keyBoard: function () {
            var me = this;
            this._focus();

            this.addHandler(this.host, 'keydown.navigationbar' + this.widgetID, function (event) {
                var handled = false;
                $.each(me.items, function (index, value) {
                    var item = this;
                    var length = me.items.length;
                    if ((item.focusedH == true || item.focusedC == true) && item.disabled == false) {

                        // functionality for different keys
                        switch (event.keyCode) {
                            case 13:
                            case 32:
                                if (me.toggleMode != 'none') {
                                    if (item.focusedH == true) {
                                        me._animate(index, true);
                                    };
                                    handled = true;
                                }
                                break;
                            case 37:
                                if (index != 0) {
                                    me.items[index - 1]._header.focus();
                                } else {
                                    var length = me.items.length;
                                    me.items[length - 1]._header.focus();
                                };
                                handled = true;
                                break;
                            case 38:
                                if (event.ctrlKey == false) {
                                    if (index != 0) {
                                        me.items[index - 1]._header.focus();
                                    } else {
                                        var length = me.items.length;
                                        me.items[length - 1]._header.focus();
                                    };
                                } else {
                                    if (item.focusedC == true) {
                                        item._header.focus();
                                    };
                                };
                                handled = true;
                                break;
                            case 39:
                                if (index != length - 1) {
                                    me.items[index + 1]._header.focus();
                                } else {
                                    me.items[0]._header.focus();
                                };
                                handled = true;
                                break;
                            case 40:
                                if (event.ctrlKey == false) {
                                    if (index != length - 1) {
                                        me.items[index + 1]._header.focus();
                                    } else {
                                        me.items[0]._header.focus();
                                    };
                                } else {
                                    if (item.expanded == true) {
                                        item._content.focus();
                                    };
                                };
                                handled = true;
                                break;
                            case 35:
                                if (index != length - 1) {
                                    me.items[length - 1]._header.focus();
                                };
                                handled = true;
                                break;
                            case 36:
                                if (index != 0) {
                                    me.items[0]._header.focus();
                                };
                                handled = true;
                                break;
                            //                            case 9:     
                            //                                $.each(me.items, function (index, value) {     
                            //                                    var item = this;     
                            //                                    if (item.disabled == false) {     
                            //                                        item._header.focus();     
                            //                                        return false;     
                            //                                    };     
                            //                                });     
                            //                                handled = true;     
                            //                                break;     
                        };
                        return false;
                    };
                });

                if (handled && event.preventDefault) {
                    event.preventDefault();
                };

                return !handled;
            });
        },

        // focuses/blurs the headers and contents of the items
        _focus: function () {
            var me = this;
            if (this.disabled) return;

            $.each(this.items, function (index, value) {
                var item = this;
                me.addHandler(item._header, 'focus.navigationbar' + this.widgetID, function () {
                    item.focusedH = true;
                    $.jqx.aria(item._header, "aria-selected", true);

                    item._header.addClass(me.toThemeProperty("jqx-fill-state-focus"));
                    item._header.css("z-index", 10);
                });
                me.addHandler(item._header, 'blur.navigationbar' + this.widgetID, function () {
                    item.focusedH = false;
                    $.jqx.aria(item._header, "aria-selected", false);
                    if (item._header.hasClass("jqx-expander-header-hover")) {
                        item._header.css("z-index", 5);
                    } else {
                        item._header.css("z-index", 0);
                    };
                    item._header.removeClass(me.toThemeProperty("jqx-fill-state-focus"));
                });
                me.addHandler(item._header_text, 'focus.navigationbar' + this.widgetID, function () {
                    item._header.focus();
                });
                me.addHandler(item._arrow, 'focus.navigationbar' + this.widgetID, function () {
                    item._header.focus();
                });
                me.addHandler(item._content, 'focus.navigationbar' + this.widgetID, function () {
                    item.focusedC = true;
                    item._content.addClass(me.toThemeProperty("jqx-fill-state-focus"));
                });
                me.addHandler(item._content, 'blur.navigationbar' + this.widgetID, function () {
                    item.focusedC = false;
                    item._content.removeClass(me.toThemeProperty("jqx-fill-state-focus"));
                });
            });
        }
    });
})(jQuery);(function ($) {

    $.jqx.jqxWidget("jqxNumberInput", "", {});

    $.extend($.jqx._jqxNumberInput.prototype, {

        defineInstance: function () {
            // Type: Number
            // Default: 0
            // Gets or sets the input's value.
            this.value = null;
            // Type: Number
            // Default: 0
            // Gets or sets the input's number.
            this.decimal = 0;
            // Type: Number
            // Default= 0
            // Gets or sets the input's minimum value.
            this.min = -99999999;
            // Type: Number
            // Default: 0
            // Gets or sets the input's maximum value.
            this.max = 99999999;
            //Type: Number.
            //Default: 0.
            //Sets width of the input in pixels. Only positive values have effect.
            this.width = null;
            //Type: String;
            //Default: Invalid value.
            this.validationMessage = "Invalid value";
            //Type: Number.
            //Default: 0.
            //Sets height of the input in pixels. 
            this.height = 50;
            // Sets the alignment.
            this.textAlign = "right";
            // Type: Bool
            // Default: false
            // Sets the readOnly state of the input.
            this.readOnly = false;
            // Type: Char
            // Default: "_"
            // Sets the prompt char displayed when an editable char is empty.
            // Possible Values: "_"; "?"; "#".
            this.promptChar = "_";
            // Type: Number
            // Default: 2
            // Indicates the number of decimal places to use in numeric values.
            this.decimalDigits = 2;
            // Type= Char
            // Default: '.'
            // Gets or sets the char to use as the decimal separator in numeric values.
            this.decimalSeparator = ".";
            // Type= Char
            // Default: ";"
            // Gets or sets the string that separates groups of digits to the left of the
            // decimal in numeric values.
            this.groupSeparator = ",";
            // Type: Number
            // Default: '3'
            // Gets or sets the number of digits in each group to the left of the decimal in numeric values.
            this.groupSize = 3;
            // Type: String
            // Default: empty
            // Gets or sets the string to use as currency or percentage symbol.
            this.symbol = '';
            // Type: Bool
            // Default: "left"
            // Gets or sets the position of the symbol in the input.
            this.symbolPosition = "left";
            // Type: Number
            // Default: 8
            // Gets or sets the digits in the input
            this.digits = 8;
            // Type: Bool
            // Default: false
            // Gets or sets whether the decimal is negative.
            this.negative = false;
            // Type: Bool
            // Default: false
            // Gets or sets the string to use as negative symbol.
            this.negativeSymbol = '-';
            // Type: Bool
            // Default: false
            // Gets or sets whether the widget is disabled.
            this.disabled = false;
            // Type: String
            // Default: advanced
            // Gets or sets the input mode. When the mode is simple, the text is formatted after editing. When the mode is advanced, the text is formatted while the user is in edit mode.
            // Available values: [simple, advanced]
            this.inputMode = 'advanced';
            // Type: Boolean
            // Default: false
            // shows the spin buttons. 
            this.spinButtons = false;
            // Type: Number
            // Default: 18
            // Sets the spin buttons width
            this.spinButtonsWidth = 18;
            // Type: Number
            // Default: 1
            // sets the spin button step.
            this.spinButtonsStep = 1;
            // validates the value to be in the min-max range when the user leaves the input.
            this.autoValidate = true;
            // none, advanced or simple
            this.spinMode = 'advanced';
            this.touchMode = "auto";
            this.rtl = false;
            // NumberInput events.
            this.events =
			[
		  	   'valuechanged',
               'textchanged',
               'mousedown',
               'mouseup',
               'keydown',
               'keyup',
               'keypress',
               'change'
			];
            this.aria =
            {
                "aria-valuenow": { name: "decimal", type: "number" },
                "aria-valuemin": { name: "min", type: "number" },
                "aria-valuemax": { name: "max", type: "number" },
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
            this.invalidArgumentExceptions =
            [
                'invalid argument exception'
            ];
        },

        // creates the number input's instance. 
        createInstance: function (args) {
            var _val = this.host.attr('value');
            if (_val != undefined) {
                this.decimal = _val;
            }
            if (this.value != null) this.decimal = this.value;
            this.render();
        },

        _doTouchHandling: function()
        {
            var me = this;
            var savedValue = me.savedValue;
            if (!me.parsing) me.parsing = true;
            if (me.parsing) {
                if (me.numberInput.val() && me.numberInput.val().indexOf('-') == 0) {
                    me.setvalue('negative', true);
                }
                else {
                    me.setvalue('negative', false);
                }
                var value = me.numberInput.val();
                for (var i = 0; i < value.length - 1; i++) {
                    var ch = value.substring(i, i + 1);
                    if (isNaN(parseFloat(ch)) && ch != me.symbol && ch != "%" && ch != "$" && ch != '.' && ch != ',' && ch != '-') {
                        me.numberInput[0].value = savedValue;
                        me.parsing = false;
                        return;
                    }
                }

                me.ValueString = me.GetValueString(me.numberInput.val(), me.decimalSeparator, me.decimalSeparator != '');
                me.ValueString = new Number(me.ValueString).toFixed(me.decimalDigits);
                me._parseDecimalInSimpleMode();
                me.decimal = me.ValueString;
                var isNegative = me.getvalue('negative');
                if (isNegative) {
                    me.decimal = "-" + me.ValueString;
                }

                me.parsing = false;
            }
        },

        render: function () {
            this.host
             .attr({
                 role: "spinbutton"
             });
            this.host.attr('data-role', 'input');
            $.jqx.aria(this);
            $.jqx.aria(this, "aria-multiline", false);

            var me = this;

            $.jqx.utilities.resize(this.host, function () {
                me._render();
            });

            if (this.officeMode || (this.theme && this.theme.indexOf('office') != -1)) {
                if (this.spinButtonsWidth == 18) this.spinButtonsWidth = 15;
            }

            if ($.jqx.mobile.isTouchDevice() || this.touchMode === true) {
                this.inputMode = 'textbox';
                this.spinMode = 'simple';
            }

            if (this.decimalSeparator == '') this.decimalSeparator = ' ';
            this.host.addClass(this.toThemeProperty('jqx-input'));
            this.host.addClass(this.toThemeProperty('jqx-rc-all'));
            this.host.addClass(this.toThemeProperty('jqx-widget'));
            this.host.addClass(this.toThemeProperty('jqx-widget-content'));
            this.host.addClass(this.toThemeProperty('jqx-numberinput'));

            if (this.spinButtons) {
                this._spinButtons();
            }
            else {
                this.numberInput = $("<input autocomplete='off' type='textarea'/>").appendTo(this.host);
                this.numberInput.addClass(this.toThemeProperty('jqx-input-content'));
                this.numberInput.addClass(this.toThemeProperty('jqx-widget-content'));
            }

            var name = this.host.attr('name');
            if (!name) name = this.element.id;
            this.numberInput.attr('name', name);

            if ($.jqx.mobile.isTouchDevice() || this.touchMode === true || this.inputMode == 'textbox') {
                var me = this;
                me.savedValue = "";
                this.addHandler(this.numberInput, 'focus', function () {
                    me.savedValue = me.numberInput[0].value;
                });

                this.addHandler(this.numberInput, 'change', function () {
                    me._doTouchHandling();
                });
            }

            var vars = $.data(this.host[0], 'jqxNumberInput');
            vars.jqxNumberInput = this;
            var me = this;
            this.removeHandler(this.host, 'loadContent');
            this.addHandler(this.host, 'loadContent', function (event) {
                me._render();
            });

            if (this.host.parents('form').length > 0) {
                this.removeHandler(this.host.parents('form'), 'loadContent');
                this.addHandler(this.host.parents('form'), 'reset', function () {
                    setTimeout(function () {
                        me.setDecimal(0);
                    }, 10);
                });
            }

            this.propertyChangeMap['disabled'] = function (instance, key, oldVal, value) {
                if (value) {
                    instance.numberInput.addClass(self.toThemeProperty('jqx-input-disabled'));
                    instance.numberInput.attr("disabled", true);
                }
                else {
                    instance.host.removeClass(self.toThemeProperty('jqx-input-disabled'));
                    instance.numberInput.attr("disabled", false);
                }

                if (instance.spinButtons && instance.host.jqxRepeatButton) {
                    instance.upbutton.jqxRepeatButton({ disabled: value });
                    instance.downbutton.jqxRepeatButton({ disabled: value });
                }
            }

            if (this.disabled) {
                this.numberInput.addClass(this.toThemeProperty('jqx-input-disabled'));
                this.numberInput.attr("disabled", true);
                this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
            }

            this.selectedText = "";
            this.decimalSeparatorPosition = -1;

            var id = this.element.id;
            var el = this.element;
            var self = this;

            this.oldValue = this._value();

            this.items = new Array();
            var value = this.value;
            var decimal = this.decimal;
            this._initializeLiterals();
            this._render();

            this.setDecimal(decimal);
            var me = this;
            setTimeout(function () {
                me._render(false);
            }
           , 100);

            this._addHandlers();
        },

        refresh: function (initialRefresh) {
            if (!initialRefresh) {
                this._render();
            }
        },

        wheel: function (event, self) {
            var delta = 0;
            if (!event) /* For IE. */
                event = window.event;

            if (event.originalEvent && event.originalEvent.wheelDelta) {
                event.wheelDelta = event.originalEvent.wheelDelta;
            }

            if (event.wheelDelta) { /* IE/Opera. */
                delta = event.wheelDelta / 120;
            } else if (event.detail) { /** Mozilla case. */
                delta = -event.detail / 3;
            }

            if (delta) {
                var result = self._handleDelta(delta);
                if (event.preventDefault)
                    event.preventDefault();

                if (event.originalEvent != null) {
                    event.originalEvent.mouseHandled = true;
                }

                if (event.stopPropagation != undefined) {
                    event.stopPropagation();
                }

                if (result) {
                    result = false;
                    event.returnValue = result;
                    return result;
                }
                else {
                    return false;
                }
            }

            if (event.preventDefault)
                event.preventDefault();
            event.returnValue = false;
        },

        _handleDelta: function (delta) {
            if (delta < 0) {
                this.spinDown();
            }
            else this.spinUp();
            return true;
        },

        _addHandlers: function () {
            var self = this;
            this.addHandler(this.numberInput, 'mousedown',
            function (event) {
                return self._raiseEvent(2, event)
            });

            this._mousewheelfunc = this._mousewheelfunc || function (event) {
                if (!self.editcell) {
                    self.wheel(event, self);
                    return false;
                }
            };

            this.removeHandler(this.host, 'mousewheel', this._mousewheelfunc);
            this.addHandler(this.host, 'mousewheel', this._mousewheelfunc);
            var oldval = "";
   
            this.addHandler(this.numberInput, 'focus',
            function (event) {                
                $.data(self.numberInput, "selectionstart", self._selection().start);
                self.host.addClass(self.toThemeProperty('jqx-fill-state-focus'));
                if (self.spincontainer) {
                    self.spincontainer.addClass(self.toThemeProperty('jqx-numberinput-focus'));
                }
                oldval = self.numberInput.val();
            });

            this.addHandler(this.numberInput, 'blur',
            function (event) {
                if (self.inputMode == 'simple') {
                    self._exitSimpleInputMode(event, self, false, oldval);
                }
                if (self.autoValidate) {
                    var val = parseFloat(self.decimal);
                    var isNegative = self.getvalue('negative');
                    if (isNegative && self.decimal > 0) {
                        val = -parseFloat(self.decimal);
                    }

                    if (val > self.max) {
                        self._disableSetSelection = true;
                        self.setDecimal(self.max);
                        self._disableSetSelection = false;
                    }
                    if (val < self.min) {
                        self._disableSetSelection = true;
                        self.setDecimal(self.min);
                        self._disableSetSelection = false;
                    }
                }

                self.host.removeClass(self.toThemeProperty('jqx-fill-state-focus'));
                if (self.spincontainer) {
                    self.spincontainer.removeClass(self.toThemeProperty('jqx-numberinput-focus'));
                }
                if (self.numberInput.val() != oldval) {
                    self._raiseEvent(7, event);
                    $.jqx.aria(self, "aria-valuenow", self.decimal);
                    self.element.value = self.decimal;
                }
                return true;
            });

            this.addHandler(this.numberInput, 'mouseup',
            function (event) {
                return self._raiseEvent(3, event)
            });

            this.addHandler(this.numberInput, 'keydown',
            function (event) {
                return self._raiseEvent(4, event)
            });

            this.addHandler(this.numberInput, 'keyup',
            function (event) {
                return self._raiseEvent(5, event)
            });

            this.addHandler(this.numberInput, 'keypress',
            function (event) {
                return self._raiseEvent(6, event)
            });
        },

        focus: function () {
            try {
                this.numberInput.focus();
            }
            catch (error) {
            }
        },

        _removeHandlers: function () {
            var self = this;
            this.removeHandler(this.numberInput, 'mousedown');
            var isOperaMini = $.jqx.mobile.isOperaMiniMobileBrowser();
            if (isOperaMini) {
                this.removeHandler($(document), 'click.' + this.element.id, self._exitSimpleInputMode, self);
            }

            this.removeHandler(this.numberInput, 'focus');
            this.removeHandler(this.numberInput, 'blur');
            this.removeHandler(this.numberInput, 'mouseup');
            this.removeHandler(this.numberInput, 'keydown');
            this.removeHandler(this.numberInput, 'keyup');
            this.removeHandler(this.numberInput, 'keypress');
        },

        //[optimize]
        _spinButtons: function () {
            if (this.host.jqxRepeatButton) {
                if (!this.numberInput) {
                    this.numberInput = $("<input autocomplete='off' style='position: relative; float: left;' type='textarea'/>");
                    this.numberInput.appendTo(this.host);
                    this.numberInput.addClass(this.toThemeProperty('jqx-input-content'));
                    this.numberInput.addClass(this.toThemeProperty('jqx-widget-content'));
                }
                else {
                    this.numberInput.css('float', 'left');
                }

                if (this.spincontainer) {
                    if (this.upbutton) {
                        this.upbutton.jqxRepeatButton('destroy');
                    }
                    if (this.downbutton) {
                        this.downbutton.jqxRepeatButton('destroy');
                    }

                    this.spincontainer.remove();
                }

                this.spincontainer = $('<div style="float: right; height: 100%; overflow: hidden; position: relative;"></div>');
                if (this.rtl) {
                    this.spincontainer.css('float', 'right');
                    this.numberInput.css('float', 'right');
                }
                this.host.append(this.spincontainer);
                this.upbutton = $('<div style="overflow: hidden; padding: 0px; margin-left: -1px; position: relative;"><div></div></div>');
                this.spincontainer.append(this.upbutton);
                this.upbutton.jqxRepeatButton({ overrideTheme: true, disabled: this.disabled, roundedCorners: 'top-right' });
                this.downbutton = $('<div style="overflow: hidden; padding: 0px; margin-left: -1px; position: relative;"><div></div></div>');
                this.spincontainer.append(this.downbutton);
                this.downbutton.jqxRepeatButton({ overrideTheme: true, disabled: this.disabled, roundedCorners: 'bottom-right' });

                var me = this;

                this.downbutton.addClass(this.toThemeProperty('jqx-fill-state-normal'));
                this.upbutton.addClass(this.toThemeProperty('jqx-fill-state-normal'));
                this.upbutton.addClass(this.toThemeProperty('jqx-rc-tr'));
                this.downbutton.addClass(this.toThemeProperty('jqx-rc-br'));

                this.addHandler(this.downbutton, 'mouseup', function (event) {
                    if (!me.disabled) {
                        me.downbutton.removeClass(me.toThemeProperty('jqx-fill-state-pressed'));
                        me._downArrow.removeClass(me.toThemeProperty('jqx-icon-arrow-down-selected'));
                    }
                });

                this.addHandler(this.upbutton, 'mouseup', function (event) {
                    if (!me.disabled) {
                        me.upbutton.removeClass(me.toThemeProperty('jqx-fill-state-pressed'));
                        me._upArrow.removeClass(me.toThemeProperty('jqx-icon-arrow-up-selected'));
                    }
                });

                this.removeHandler($(document), 'mouseup.' + this.element.id);
                this.addHandler($(document), 'mouseup.' + this.element.id, function (event) {
                    me.upbutton.removeClass(me.toThemeProperty('jqx-fill-state-pressed'));
                    me._upArrow.removeClass(me.toThemeProperty('jqx-icon-arrow-up-selected'));
                    me.downbutton.removeClass(me.toThemeProperty('jqx-fill-state-pressed'));
                    me._downArrow.removeClass(me.toThemeProperty('jqx-icon-arrow-down-selected'));
                });

                this.addHandler(this.downbutton, 'mousedown', function (event) {
                    if (!me.disabled) {
                        if ($.jqx.browser.msie && $.jqx.browser.version < 9) {
                            me._inputSelection = me._selection();
                        }

                        me.downbutton.addClass(me.toThemeProperty('jqx-fill-state-pressed'));
                        me._downArrow.addClass(me.toThemeProperty('jqx-icon-arrow-down-selected'));
                        event.preventDefault();
                        event.stopPropagation();
                        return false;
                    }
                });

                this.addHandler(this.upbutton, 'mousedown', function (event) {
                    if (!me.disabled) {
                        if ($.jqx.browser.msie && $.jqx.browser.version < 9) {
                            me._inputSelection = me._selection();
                        }

                        me.upbutton.addClass(me.toThemeProperty('jqx-fill-state-pressed'));
                        me._upArrow.addClass(me.toThemeProperty('jqx-icon-arrow-up-selected'));
                        event.preventDefault();
                        event.stopPropagation();
                        return false;
                    }
                });

                this.addHandler(this.upbutton, 'mouseenter', function (event) {
                    me.upbutton.addClass(me.toThemeProperty('jqx-fill-state-hover'));
                    me._upArrow.addClass(me.toThemeProperty('jqx-icon-arrow-up-hover'));
                });
                this.addHandler(this.upbutton, 'mouseleave', function (event) {
                    me.upbutton.removeClass(me.toThemeProperty('jqx-fill-state-hover'));
                    me._upArrow.removeClass(me.toThemeProperty('jqx-icon-arrow-up-hover'));
                });

                this.addHandler(this.downbutton, 'mouseenter', function (event) {
                    me.downbutton.addClass(me.toThemeProperty('jqx-fill-state-hover'));
                    me._downArrow.addClass(me.toThemeProperty('jqx-icon-arrow-down-hover'));
                });
                this.addHandler(this.downbutton, 'mouseleave', function (event) {
                    me.downbutton.removeClass(me.toThemeProperty('jqx-fill-state-hover'));
                    me._downArrow.removeClass(me.toThemeProperty('jqx-icon-arrow-down-hover'));
                });

                this.upbutton.css('border-width', '0px');
                this.downbutton.css('border-width', '0px');

                if (this.disabled) {
                    this.upbutton[0].disabled = true;
                    this.downbutton[0].disabled = true;
                }
                else {
                    this.upbutton[0].disabled = false;
                    this.downbutton[0].disabled = false;
                }

                this.spincontainer.addClass(this.toThemeProperty('jqx-input'));
                this.spincontainer.addClass(this.toThemeProperty('jqx-rc-r'));
                this.spincontainer.css('border-width', '0px');
                if (!this.rtl) {
                    this.spincontainer.css('border-left-width', '1px');
                }
                else {
                    this.spincontainer.css('border-right-width', '1px');
                }

                this._upArrow = this.upbutton.find('div');
                this._downArrow = this.downbutton.find('div');

                this._upArrow.addClass(this.toThemeProperty('jqx-icon-arrow-up'));
                this._downArrow.addClass(this.toThemeProperty('jqx-icon-arrow-down'));
                this._upArrow.addClass(this.toThemeProperty('jqx-input-icon'));
                this._downArrow.addClass(this.toThemeProperty('jqx-input-icon'));
                var me = this;
                this._upArrow.hover(function () {
                    if (!me.disabled) {
                        me._upArrow.addClass(me.toThemeProperty('jqx-icon-arrow-up-hover'));
                    }
                }, function () {
                    me._upArrow.removeClass(me.toThemeProperty('jqx-icon-arrow-up-hover'));
                });
                this._downArrow.hover(function () {
                    if (!me.disabled) {
                        me._downArrow.addClass(me.toThemeProperty('jqx-icon-arrow-down-hover'));
                    }
                }, function () {
                    me._downArrow.removeClass(me.toThemeProperty('jqx-icon-arrow-down-hover'));
                });


                var isTouchDevice = $.jqx.mobile.isTouchDevice();
                var eventname = 'click';
                if (isTouchDevice) {
                    eventname = $.jqx.mobile.getTouchEventName('touchstart');
                }

                this.addHandler(this.downbutton, eventname, function (event) {
                    if (!isTouchDevice) {
                        if (me._selection().start == 0) {
                            me._setSelectionStart(me.numberInput.val().length);
                        }

                        if ($.jqx.browser.msie && $.jqx.browser.version < 9) {
                            me._setSelectionStart(me._inputSelection.start);
                        }
                    }
                    else {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    
                    me.spinDown();
                    return false;
                });
                this.addHandler(this.upbutton, eventname, function (event) {
                    if (!isTouchDevice) {
                        if (me._selection().start == 0) {
                            me._setSelectionStart(me.numberInput.val().length);
                        }
                        if ($.jqx.browser.msie && $.jqx.browser.version < 9) {
                            me._setSelectionStart(me._inputSelection.start);
                        }
                    }
                    else {
                        event.preventDefault();
                        event.stopPropagation();
                    }

                    me.spinUp();
                    return false;
                });
            } else {
                throw new Error("jqxNumberInput: Missing reference to jqxbuttons.js.");
            }
        },

        spinDown: function () {
            var me = this;

            if (me.spinMode == 'none')
                return;
            var isNegative = this.getvalue('negative');
            var negativeOffset = isNegative ? -1 : 0;

            if ($.jqx.mobile.isTouchDevice() || this.inputMode == 'textbox') {
                me._doTouchHandling();
            }

            if (!me.disabled) {
                var selection = this._selection();
                var olddecimal = this.decimal;
               
                var decimal = this.getDecimal();
                if (decimal < this.min)
                {
                    decimal = this.min;
                    this.setDecimal(this.min);
                    this._setSelectionStart(selection.start);
                    this.spinDown();
                    return;
                }
                else if (decimal > this.max) {
                    decimal = this.max;
                    this.setDecimal(this.max);
                    this._setSelectionStart(selection.start);
                    this.spinDown();
                    return;
                }

                if (me.spinButtonsStep < 0) me.spinButtonsStep = 1;

                var dec = parseInt(me.decimal) + me.spinButtonsStep;
                dec = dec.toString().length;
                var validvalue = negativeOffset + dec <= me.digits;

                if (me.spinMode != 'advanced') {
                    if (decimal - me.spinButtonsStep >= me.min && validvalue) {
                        var multiple = 1;
                        for (i = 0; i < me.decimalDigits; i++) {
                            multiple = multiple * 10;
                        }

                        var newvalue = (multiple * decimal) - (multiple * me.spinButtonsStep);
                        newvalue = newvalue / multiple;
                        newvalue = this._parseDecimalValueToEditorValue(newvalue);
                        me.setDecimal(newvalue);
                    }
                }
                else {
                    var values = this._getspindecimal();
                    var separator = this._getSeparatorPosition();

                    var decimal = parseFloat(values.decimal);
                    if (me.spinButtonsStep < 0) me.spinButtonsStep = 1;

                    var dec = parseInt(decimal) + me.spinButtonsStep;
                    dec = dec.toString().length;
                    var validvalue = negativeOffset + dec <= me.digits;
                    var multiple = 1;

                    var separatorindex = values.decimal.indexOf(".");
                    if (separatorindex != -1) {
                        var divide = values.decimal.length - separatorindex - 1;
                        var multiple = 1;
                        for (var i = 0; i < divide; i++) {
                            multiple = multiple * 10;
                        }
                        decimal -= new Number(me.spinButtonsStep / multiple);
                        decimal = decimal.toFixed(divide);
                        var separatorindex = decimal.toString().indexOf(".");
                        if (separatorindex == -1) {
                            decimal = decimal.toString() + '.';
                        }
                        var result = decimal.toString() + values.afterdecimal;
                        result = new Number(result);
                        result = result.toFixed(me.decimalDigits);
                        if (result >= me.min) {
                            result = this._parseDecimalValueToEditorValue(result);
                            me.setDecimal(result);
                        }
                    }
                    else {
                        if (decimal - me.spinButtonsStep >= me.min && validvalue) {
                            var newvalue = (multiple * decimal) - (multiple * me.spinButtonsStep);
                            newvalue = newvalue / multiple;
                            var result = newvalue.toString() + values.afterdecimal;
                            if (result >= me.min) {
                                result = this._parseDecimalValueToEditorValue(result);
                                me.setDecimal(result);
                            }
                        }
                    }
                }

                if (result == undefined || this.inputMode != 'simple') {
                    this._setSelectionStart(selection.start);
                    me.savedValue = me.numberInput[0].value;
                    return;
                }
                
                result = this.decimal.toString();
                var isNegative = this.getvalue('negative');
                if (negativeOffset == 0 && isNegative)
                {
                    this._setSelectionStart(selection.start + 1);
                }
                else
                {
                    if ((result != undefined && (olddecimal == undefined || olddecimal.toString().length == result.length))) {
                        this._setSelectionStart(selection.start);
                    }
                    else {
                        if (isNegative) {
                            this._setSelectionStart(selection.start + 1);
                        }
                        else {
                            this._setSelectionStart(selection.start-1);
                        }
                    }
                }
            }
        },

        _getspindecimal: function () {
            var selection = this._selection();
            var decimalString = "";
            var separatorPosition = this._getSeparatorPosition();
            var visibleItems = this._getVisibleItems();
            var prefix = this._getHiddenPrefixCount();
            var text = this.numberInput.val();

            if (this.numberInput.val().length == selection.start && selection.length == 0) {
                this._setSelection(selection.start, selection.start + 1);
                selection = this._selection();
            }

            var issimple = this.inputMode != 'advanced';

            for (var i = 0; i < selection.start; i++) {
                if (issimple) {
                    var literal = text.substring(i, i + 1);
                    var isDigit = (!isNaN(parseInt(literal)));
                    if (isDigit) {
                        decimalString += literal;
                    }
                    if (literal == this.decimalSeparator) {
                        decimalString += literal;
                    }
                    continue;
                }

                if (visibleItems[i].canEdit && visibleItems[i].character != this.promptChar) {
                    decimalString += visibleItems[i].character;
                }
                else if (!visibleItems[i].canEdit && this.decimalSeparatorPosition != -1 && visibleItems[i] == visibleItems[this.decimalSeparatorPosition - prefix]) {
                    if (decimalString.length == 0) {
                        decimalString = "0";
                    }

                    decimalString += visibleItems[i].character;
                }

            }

            var afterdecimal = "";
            for (var i = selection.start; i < visibleItems.length; i++) {
                if (issimple) {
                    var literal = text.substring(i, i + 1);
                    var isDigit = (!isNaN(parseInt(literal)));
                    if (isDigit) {
                        afterdecimal += literal;
                    }
                    if (literal == this.decimalSeparator) {
                        afterdecimal += literal;
                    }
                    continue;
                }

                if (visibleItems[i].canEdit && visibleItems[i].character != this.promptChar) {
                    afterdecimal += visibleItems[i].character;
                }
                else if (!visibleItems[i].canEdit && this.decimalSeparatorPosition != -1 && visibleItems[i] == visibleItems[this.decimalSeparatorPosition - prefix]) {
                    afterdecimal += visibleItems[i].character;
                }
            }
            var isNegative = this.getvalue('negative');
            var d = isNegative ? "-" + this._parseDecimalValue(decimalString).toString() : this._parseDecimalValue(decimalString).toString();
            return { decimal: d, afterdecimal: this._parseDecimalValue(afterdecimal) };
        },

        _parseDecimalValue: function (number) {
            if (this.decimalSeparator != '.') {
                var start = number.toString().indexOf(this.decimalSeparator);
                if (start >= 0) {
                    var result = number.toString().substring(0, start) + '.' + number.toString().substring(start + 1);
                    return result;
                }
            }
            return number;
        },

        _parseDecimalValueToEditorValue: function (number) {
            if (this.decimalSeparator != '.') {
                var start = number.toString().indexOf(".");
                if (start >= 0) {
                    var result = number.toString().substring(0, start) + this.decimalSeparator + number.toString().substring(start + 1);
                    return result;
                }
            }
            return number;
        },

        spinUp: function () {
            var me = this;

            if (me.spinMode == 'none')
                return;

            if ($.jqx.mobile.isTouchDevice() || this.inputMode == 'textbox') {
               me._doTouchHandling();
            }

            var isNegative = this.getvalue('negative');
            var negativeOffset = isNegative ? -1 : 0;

            if (!me.disabled) {
                var selection = this._selection();
                var olddecimal = me.decimal;
                var decimal = me.getDecimal();
                if (decimal < this.min) {
                    decimal = this.min;
                    this.setDecimal(this.min);
                    this._setSelectionStart(selection.start);
                    this.spinUp();
                    return;
                }
                else if (decimal > this.max) {
                    decimal = this.max;
                    this.setDecimal(this.max);
                    this._setSelectionStart(selection.start);
                    this.spinUp();
                    return;
                }
                if (me.spinButtonsStep < 0) me.spinButtonsStep = 1;

                var dec = parseInt(me.decimal) + me.spinButtonsStep;
                dec = dec.toString().length;
                var validvalue = negativeOffset + dec <= me.digits;

                if (me.spinMode != 'advanced') {
                    if (decimal + me.spinButtonsStep <= me.max && validvalue) {
                        var multiple = 1;
                        for (var i = 0; i < me.decimalDigits; i++) {
                            multiple = multiple * 10;
                        }

                        var newvalue = (multiple * decimal) + (multiple * me.spinButtonsStep);
                        newvalue = newvalue / multiple;
                        newvalue = this._parseDecimalValueToEditorValue(newvalue);
                        me.setDecimal(newvalue);
                    }
                }
                else {
                    var values = this._getspindecimal();
                    var separator = this._getSeparatorPosition();

                    var decimal = parseFloat(values.decimal);
                    if (me.spinButtonsStep < 0) me.spinButtonsStep = 1;

                    var dec = parseInt(decimal) + me.spinButtonsStep;
                    dec = dec.toString().length;
                    var validvalue = negativeOffset + dec <= me.digits;
                    var multiple = 1;

                    var separatorindex = values.decimal.indexOf(".");
                    if (separatorindex != -1) {
                        var divide = values.decimal.length - separatorindex - 1;
                        var multiple = 1;
                        for (var i = 0; i < divide; i++) {
                            multiple = multiple * 10;
                        }
                        decimal += new Number(me.spinButtonsStep / multiple);
                        decimal = decimal.toFixed(divide);
                        var separatorindex = decimal.toString().indexOf(".");
                        if (separatorindex == -1) {
                            decimal = decimal.toString() + '.';
                        }
                        var result = decimal.toString() + values.afterdecimal;
                        result = new Number(result);
                        result = result.toFixed(me.decimalDigits);
                        var number = new Number(result).toFixed(me.decimalDigits);

                        if (number <= me.max) {
                            result = this._parseDecimalValueToEditorValue(result);
                            me.setDecimal(result);
                        }
                        else result = undefined;
                    }
                    else {
                        if (decimal + me.spinButtonsStep <= me.max && validvalue) {
                            var newvalue = (multiple * decimal) + (multiple * me.spinButtonsStep);

                            newvalue = newvalue / multiple;
                            var result = newvalue.toString() + values.afterdecimal;
                            var number = new Number(result).toFixed(me.decimalDigits);
                            if (number <= me.max) {
                                result = this._parseDecimalValueToEditorValue(result);
                                if (isNegative && result.indexOf('-') == -1) {
                                    if (values.decimal != '-0') {
                                        result = '-' + result;
                                    }
                                }
                                me.setDecimal(result);
                            }
                            else {
                                result = undefined;
                            }
                        }
                    }
                }

                if (result == undefined || this.inputMode != 'simple') {
                    this._setSelectionStart(selection.start);
                    me.savedValue = me.numberInput[0].value;
                    return;
                }

                result = this.decimal.toString();
                var isNegative = this.getvalue('negative');
                if (negativeOffset == -1 && !isNegative) {
                    this._setSelectionStart(-1 + selection.start);
                }
                else {
                    if ((result != undefined && (olddecimal == undefined || olddecimal.toString().length == result.length))) {
                        this._setSelectionStart(selection.start);
                    }
                    else {
                        if (isNegative) {
                            this._setSelectionStart(-1+selection.start);
                        }
                        else {
                            this._setSelectionStart(1 + selection.start);
                        }
                    }
                }
            }
        },

        _exitSimpleInputMode: function (event, self, checkbounds, oldvalue) {
            if (self == undefined) {
                self = event.data;
            }

            if (self == null) return;

            if (checkbounds == undefined) {
                if (event.target != null && self.element != null) {
                    if ((event.target.id != undefined && event.target.id.toString().length > 0 && self.host.find('#' + event.target.id).length > 0) || event.target == self.element) {
                        return;
                    }
                }

                var offset = self.host.offset();
                var left = offset.left;
                var top = offset.top;
                var width = self.host.width();
                var height = self.host.height();

                var targetOffset = $(event.target).offset();
                if (targetOffset.left >= left && targetOffset.left <= left + width)
                    if (targetOffset.top >= top && targetOffset.top <= top + height) {
                        return;
                    }
            }

            if ($.jqx.mobile.isOperaMiniBrowser()) {
                self.numberInput.attr("readonly", true);
            }

            if (self.disabled || self.readOnly)
                return;

            var enteredMode = $.data(self.numberInput, "simpleInputMode");
            if (enteredMode == null) return;

            $.data(self.numberInput, "simpleInputMode", null);
            this._parseDecimalInSimpleMode();
            return false;
        },
        
        _getDecimalInSimpleMode: function()
        {
            var val = this.decimal;
            if (this.decimalSeparator != '.') {
                var indx = val.toString().indexOf(this.decimalSeparator);
                if (indx > 0) {
                    var prefix = val.toString().substring(0, indx);
                    var val = prefix + "." + val.toString().substring(indx + 1);
                }
            }
            return val;
        },

        _parseDecimalInSimpleMode: function (refreshValue) {
            var self = this;
            var isNegative = self.getvalue('negative');
            var decimal = this.ValueString;
            if (decimal == undefined) {
                decimal = this.GetValueString(this.numberInput.val(), this.decimalSeparator, this.decimalSeparator != "");
            }
            if (this.decimalSeparator != '.') {
                var indx = decimal.toString().indexOf(".");
                if (indx > 0) {
                    var prefix = decimal.toString().substring(0, indx);
                    var val = prefix + this.decimalSeparator + decimal.toString().substring(indx + 1);
                    decimal = val;
                }
            }

            var string = isNegative ? "-" : '';
            if (this.symbolPosition == 'left') {
                string += this.symbol;
            }
            var leadingDigitsCount = this.digits % this.groupSize;
            if (leadingDigitsCount == 0) {
                leadingDigitsCount = this.groupSize;
            }

            var decimalString = decimal.toString();
            if (decimalString.indexOf('-') >= 0) {
                decimalString = decimalString.substring(decimalString.indexOf('-') + 1);
            }

            string += decimalString;

            if (this.symbolPosition == 'right') {
                string += this.symbol;
            }

            if (refreshValue != false) {
                self.numberInput.val(string);
            }
        },

        //[optimize]
        _enterSimpleInputMode: function (event, self) {
            if (self == undefined) {
                self = event.data;
            }

            var selection = this._selection();

            if (self == null) return;
            var isNegative = self.getvalue('negative');

            var decimal = self.decimal;
            if (isNegative) {
                if (decimal > 0)
                    decimal = -decimal;
            }

            self.numberInput.val(decimal);
            $.data(self.numberInput, "simpleInputMode", true);

            if ($.jqx.mobile.isOperaMiniBrowser()) {
                self.numberInput.attr("readonly", false);
            }
            this._parseDecimalInSimpleMode();
            this._setSelectionStart(selection.start);
        },

        setvalue: function (name, value) {
            if (this[name] != undefined) {
                if (name == 'decimal') {
                    this._setDecimal(value);
                }
                else {
                    this[name] = value;
                    this.propertyChangedHandler(this, name, value, value);
                }
            }
        },

        getvalue: function (name) {
            if (name == 'decimal') {
                if (this.negative != undefined && this.negative == true) {
                    return -Math.abs(this[name]);
                }
            }

            if (name in this) {
                return this[name]
            }

            return null;
        },

        // gets the intput's value.
        _getString: function () {
            var s = "";
            for (var i = 0; i < this.items.length; i++) {
                var character = this.items[i].character;
                s += character;
            }

            return s;
        },

        //[optimize]
        _literal: function (letter, regExpression, editable, separator) {
            return { character: letter, regex: regExpression, canEdit: editable, isSeparator: separator };
        },

        //[optimize]
        _initializeLiterals: function () {
            if (this.inputMode == 'textbox') return;
            // add the negative symbol.
            var index = 0;
            var negativeSymbolLength = this.negativeSymbol.length;
            for (var i = 0; i < negativeSymbolLength; i++) {
                var character = this.negativeSymbol.substring(i, i + 1);
                var regex = "";
                var canEdit = false;
                var literal = null;
                if (this.negative) {
                    literal = this._literal(character, regex, canEdit, false);
                }
                else {
                    literal = this._literal('', regex, canEdit, false);
                }

                this.items[index] = literal;
                index++;
            }

            // add the currency or percentage symbol.
            var symbolLength = this.symbol.length;
            if (this.symbolPosition == 'left') {
                for (i = 0; i < symbolLength; i++) {
                    var character = this.symbol.substring(i, i + 1);
                    var regex = "";
                    var canEdit = false;
                    var literal = this._literal(character, regex, canEdit, false);
                    this.items[index] = literal;
                    index++;
                }
            }

            var leadingDigitsCount = this.digits % this.groupSize;
            if (leadingDigitsCount == 0) {
                leadingDigitsCount = this.groupSize;
            }

            // add the digits and group separators.
            for (var i = 0; i < this.digits; i++) {
                var character = this.promptChar;
                var regex = "\\d";
                var canEdit = true;

                var literal = this._literal(character, regex, canEdit, false);
                this.items[index] = literal;
                index++;

                if (i < this.digits - 1 && this.groupSeparator != undefined && this.groupSeparator.length > 0) {
                    leadingDigitsCount--;
                    if (leadingDigitsCount == 0) {
                        leadingDigitsCount = this.groupSize;
                        var separatorLiteral = this._literal(this.groupSeparator, "", false, false);
                        this.items[index] = separatorLiteral;
                        index++;
                    }
                }
                else if (i == this.digits - 1) {
                    literal.character = 0;
                }
            }
            this.decimalSeparatorPosition = -1;

            // add the digits decimal separator and the decimal digits.
            if (this.decimalDigits != undefined && this.decimalDigits > 0) {
                var character = this.decimalSeparator;
                if (character.length == 0) {
                    character = ".";
                }

                var literal = this._literal(character, "", false, true);
                this.items[index] = literal;
                this.decimalSeparatorPosition = index;
                index++;

                for (var i = 0; i < this.decimalDigits; i++) {
                    var decimalCharacter = 0;
                    var regex = "\\d";
                    var decimalDigit = this._literal(decimalCharacter, regex, true, false);
                    this.items[index] = decimalDigit;
                    index++;
                }
            }

            // add the currency or percentage symbol.
            if (this.symbolPosition == 'right') {
                for (var i = 0; i < symbolLength; i++) {
                    var character = this.symbol.substring(i, i + 1);
                    var regex = "";
                    var canEdit = false;
                    var literal = this._literal(character, regex, canEdit);
                    this.items[index] = literal;
                    index++;
                }
            }
        },

        //[optimize]
        _match: function (character, regex) {
            var regExpr = new RegExp(regex, "i");
            return regExpr.test(character);
        },

        //[optimize]
        _raiseEvent: function (id, arg) {
            var evt = this.events[id];
            var args = {};
            args.owner = this;
            if (this.host.css('display') == 'none') {
                return true;
            }

            var key = arg.charCode ? arg.charCode : arg.keyCode ? arg.keyCode : 0;
            var result = true;
            var isreadOnly = this.readOnly;
            var me = this;

            if (id == 3 || id == 2) {
                if (!this.disabled) {
                    if (this.inputMode != 'simple' && this.inputMode != 'textbox') {
                        this._handleMouse(arg);
                    }
                    else {
                        //       this._enterSimpleInputMode(null, me);
                        return true;
                    }
                }
            }

            if (id == 0) {
                var decimalValue = this.getvalue('decimal');
                if ((this.max < decimalValue) || (this.min > decimalValue)) {
                    this.host.addClass(this.toThemeProperty("jqx-input-invalid"));
                }
                else {
                    this.host.removeClass(this.toThemeProperty("jqx-input-invalid"));
                    this.host.addClass(this.toThemeProperty("jqx-input"));
                    this.host.addClass(this.toThemeProperty("jqx-rc-all"));
                }
            }

            var event = new jQuery.Event(evt);
            event.owner = this;
            args.value = this.getvalue('decimal');
            args.text = this.numberInput.val();

            event.args = args;
            result = this.host.trigger(event);
            var me = this;
            // key down
            if (this.inputMode == 'textbox')
                return result;

            if (this.inputMode != 'simple') {
                if (id == 4) {
                    if (isreadOnly || this.disabled) {
                        return false;
                    }

                    result = me._handleKeyDown(arg, key);
                }
                // key up
                else if (id == 5) {
                    if (isreadOnly || this.disabled) {
                        result = false;
                    }
                }
                else if (id == 6) {
                    if (isreadOnly || this.disabled) {
                        return false;
                    }
                    result = me._handleKeyPress(arg, key);
                }
            }
            else {
                if (id == 4 || id == 5 || id == 6) {
                    if ($.jqx.mobile.isTouchDevice() || this.touchMode === true) {
                        return true;
                    }

                    if (isreadOnly || this.disabled) {
                        return false;
                    }

                    var letter = String.fromCharCode(key);
                    var digit = parseInt(letter);
                    var allowInput = true;
                    if (!arg.ctrlKey && !arg.shiftKey) {
                        if (key >= 65 && key <= 90) {
                            allowInput = false;
                        }
                    }

                    if (id == 6 && $.jqx.browser.opera != undefined) {
                        if (key == 8)
                            return false;
                    }
                    if (allowInput) {
                        if (id == 4) {
                            allowInput = me._handleSimpleKeyDown(arg, key);
                        }
                        if (key == 189 || key == 45 || key == 109 || key == 173) {
                            var selection = me._selection();
                            if (id == 4) {
                                var isNegative = me.getvalue('negative');
                                if (isNegative == false) {
                                    me.setvalue('negative', true);
                                }
                                else {
                                    me.setvalue('negative', false);
                                }
                                me._parseDecimalInSimpleMode();
                                me._setSelectionStart(selection.start);
                                allowInput = false;
                            }
                        }

                        if (!$.jqx.browser.msie) {
                            var e = arg;
                            if ((e.ctrlKey && key == 99 /* firefox */) || (e.ctrlKey && key == 67) /* opera */ ||
                                  (e.ctrlKey && key == 122 /* firefox */) || (e.ctrlKey && key == 90) /* opera */ ||
                                  (e.ctrlKey && key == 118 /* firefox */) || (e.ctrlKey && key == 86) /* opera */ || (e.shiftKey && key == 45)) {
                                if (id == 6 && $.jqx.browser.webkit) {
                                    me._handleSimpleKeyDown(arg, key);
                                }
                                return false;
                            }
                        }

                        if ((arg.ctrlKey && key == 97 /* firefox */) || (arg.ctrlKey && key == 65) /* opera */) {
                            return true;
                        }

                        if (id == 6 && allowInput) {
                            var specialKey = this._isSpecialKey(key);
                            return specialKey;
                        }
                    }

                    return allowInput;
                }
            }

            return result;
        },

        GetSelectionInValue: function (selectionPosition, text, separator, hasSeparator) {
            var selectionInValue = 0;

            for (i = 0; i < text.length; i++) {
                if (i >= selectionPosition)
                    break;

                var literal = text.substring(i, i + 1);
                var isDigit = (!isNaN(parseInt(literal)));

                if (isDigit || (hasSeparator && text.substring(i, i + 1) == separator)) {
                    selectionInValue++;
                }
            }

            return selectionInValue;
        },

        GetSelectionLengthInValue: function (selectionPosition, selectionLength, text, separator) {
            var selectionInValue = 0;

            for (i = 0; i < text.length; i++) {
                if (i >= selectionPosition + selectionLength)
                    break;

                var literal = text.substring(i, i + 1);
                var isDigit = (!isNaN(parseInt(literal)));

                if (selectionLength > 0 && i >= selectionPosition && isDigit || (i >= selectionPosition && text[i].toString() == separator)) {
                    selectionInValue++;
                }
            }

            return selectionInValue;
        },

        GetInsertTypeByPositionInValue: function (positionInValue, separator, text, hasSeparator) {
            var insertType = "before";
            var valueString = this.GetValueString(text, separator, hasSeparator);
            var digitsToSeparator = this.GetDigitsToSeparator(0, valueString, separator);

            if (positionInValue > digitsToSeparator) {
                insertType = 'after';
            }

            return insertType;
        },

        RemoveRange: function (start, length, text, separatorChar, updateText, insert) {
            var decimalPossibleChars = this.digits;
            var selectionStart = start;
            var selectionLength = length;
            var removedDigits = 0;
            var value = this.decimal;
            var selection = this._selection();
            var text = this.numberInput.val();
            var separatorChar = this.decimalSeparator;
            var hasSeparator = separatorChar != '';

            if (selectionLength == 0 && this.ValueString.length < this.decimalPossibleChars - 1)
                return removedDigits;

            var separatorPosition = this.GetSeparatorPositionInText(separatorChar, text);

            if (!updateText) {
                separatorPosition = this.GetSeparatorPositionInText(separatorChar, text);
            }

            if (separatorPosition < 0 && !hasSeparator && text.length > 1) {
                separatorPosition = text.length;
            }

            if (separatorPosition == -1)
                separatorPosition = text.length;

            var separatorOffset = hasSeparator ? 1 : 0;

            if (length < 2 && insert == true) {
                var valueDigits = this.ValueString.length - this.decimalDigits - separatorOffset;
                if ((valueDigits) == decimalPossibleChars && start + length < separatorPosition) {
                    selectionLength++;
                }
            }


            var newTextString = "";
            for (var i = 0; i < text.length; i++) {
                if (i < selectionStart || i >= selectionStart + selectionLength) {
                    newTextString += text.substring(i, i + 1);
                    continue;
                }
                else {
                    var literal = text.substring(i, i + 1);
                    if (literal == separatorChar) {
                        newTextString += separatorChar;
                        continue;
                    }
                    else {
                        var literal = text.substring(i, i + 1);
                        if (i > separatorPosition) {
                            newTextString += "0";
                            continue;
                        }
                    }
                }

                var literal = text.substring(i, i + 1);
                var isDigit = (!isNaN(parseInt(literal)));

                if (isDigit) {
                    removedDigits++;
                }
            }

            if (newTextString.length == 0) {
                newTextString = "0";
            }

            if (updateText) {
                this.numberInput.val(newTextString);
            }
            else {
                this.ValueString = newTextString;
            }

            var ch = newTextString.substring(0, 1);
            if (ch == separatorChar && isNaN(parseInt(ch))) {
                var res = '0' + newTextString;
                newTextString = res;
            }

            this.ValueString = this.GetValueString(newTextString, separatorChar, hasSeparator);

            this.decimal = this.ValueString;
            this._parseDecimalInSimpleMode();

            this._setSelectionStart(selectionStart);
            return removedDigits;
        },

        InsertDigit: function (digit, position) {
            if (typeof this.digits != 'number') {
                this.digits = parseInt(this.digits);
            }

            if (typeof this.decimalDigits != 'number') {
                this.decimalDigits = parseInt(this.decimalDigits);
            }

            var decimalPossibleChars = 1 + this.digits;

            var selection = this._selection();
            var isNegative = this.getvalue('negative');
            var increased = false;

            if (selection.start == 0 && this.symbol != '' && this.symbolPosition == 'left') {
                this._setSelectionStart(selection.start + 1);
                selection = this._selection();
                increased = true;
            }

            if ((isNegative && increased) || (isNegative && !increased && selection.start == 0)) {
                this._setSelectionStart(selection.start + 1);
                selection = this._selection();
            }

            var selectionChar = this.numberInput.val().substring(selection.start, selection.start + 1);
            var text = this.numberInput.val();
            var separatorChar = this.decimalSeparator;
            var hasSeparator = separatorChar != '' && this.decimalDigits > 0;

            if (selectionChar == this.symbol && this.symbolPosition == 'right') {
                if (this.decimalDigits == 0) {
                    this.ValueString = this.GetValueString(text, separatorChar, hasSeparator);
                    if (this.ValueString.length >= decimalPossibleChars)
                        return;
                }
                else {
                    return;
                }
            }

            this.ValueString = this.GetValueString(text, separatorChar, hasSeparator);
            var value = this.ValueString;

            if (this.decimalDigits > 0 && position >= value.length) {
                position = value.length - 1;
            }

            var valueChar = '';
            if (position < value.length) {
                valueChar = value.substring(position, position + 1);
            }

            var shouldReplace = false;
            var decrementedPosition = false;

            var type = this.GetInsertTypeByPositionInValue(position, separatorChar, text, hasSeparator);

            if (type == 'after') {
                shouldReplace = true;
            }

            var separatorOffset = hasSeparator ? 1 : 0;

            if (valueChar != separatorChar && (this.ValueString.length - this.decimalDigits - separatorOffset) >= decimalPossibleChars - 1) {
                shouldReplace = true;
            }

            var isdecimal = false;

            var separatoroffset = hasSeparator ? 1 : 0;

            if (!shouldReplace && this.ValueString && this.ValueString.length >= this.digits + this.decimalDigits + separatoroffset) {
                return;
            }

            if (shouldReplace && valueChar != separatorChar) {
                if (isdecimal)
                    position++;

                var before = value.substring(0, position);
                if (before.length == value.length) {
                    if (this.ValueString.length >= this.digits + this.decimalDigits + separatoroffset)
                        return;
                }

                var current = digit;
                var after = "";

                if (position + 1 < value.length) {
                    after = value.substring(position + 1);
                }

                var result = before + current + after;
                this.ValueString = result;
            }
            else {
                var before = value.substring(0, position);
                var current = digit;
                var after = value.substring(position);
                var result = before + current + after;

                if (value.substring(0, 1) == '0') {
                    result = current + value.substring(1);
                    if (valueChar == separatorChar) {
                        this._setSelectionStart(selection.start - 1);
                        selection = this._selection();
                    }
                }
                this.ValueString = result;
            }

            if (isNegative) {
                this.decimal = -this.ValueString;
            }
            else this.decimal = this.ValueString;

            this._parseDecimalInSimpleMode();
            var start = selection.start;
            start += 1;

            this._setSelectionStart(start);

            this.value = this.decimal;

            this._raiseEvent(0, this.value);
            this._raiseEvent(1, this.numberInput.val());
        },

        GetStringToSeparator: function (text, separator, hasSeparator) {
            var res = "";
            var pointSeparator = separator;
            var separatorInText = this.GetSeparatorPositionInText(separator, text);
            var newString = text.subString(0, separatorInText);
            res = this.GetValueString(newString, separator, hasSeparator);

            return res;
        },

        GetSeparatorPositionInText: function (separator, text) {
            var decimalPointPos = -1;

            for (i = 0; i < text.length; i++) {
                if (text.substring(i, i + 1) == separator) {
                    decimalPointPos = i;
                    break;
                }
            }
            return decimalPointPos;
        },

        GetValueString: function (text, separator, hasSeparator) {
            var res = "";

            for (var i = 0; i < text.length; i++) {
                var literal = text.substring(i, i + 1);
                var isDigit = (!isNaN(parseInt(literal)));
                if (isDigit) {
                    res += literal;
                }
                if (literal == separator) {
                    res += separator;
                }
            }

            return res;
        },

        Backspace: function () {
            var selection = this._selection();
            var initialselection = this._selection();
            var text = this.numberInput.val();

            if (selection.start == 0 && selection.length == 0)
                return;

            this.isBackSpace = true;

            var literal = text.substring[selection.start, selection.start + 1];
            var isDigit = (!isNaN(parseInt(literal)));
            if (selection.start > 0 && selection.length == 0) {
                this._setSelectionStart(selection.start - 1);
                var selection = this._selection();
            }

            this.Delete();
            this._setSelectionStart(initialselection.start - 1);
            this.isBackSpace = false;
        },

        Delete: function (deleteWithoutSelection) {
            var selection = this._selection();
            var text = this.numberInput.val();

            var selectionStart = selection.start;
            var selectionLength = selection.length;
            selectionLength = Math.max(selectionLength, 1);

            this.ValueString = this.GetValueString(text, this.decimalSeparator, this.decimalSeparator != '');

            this.RemoveRange(selection.start, selectionLength, this.ValueString, ".", false);
            var literal = this.ValueString.substring(0, 1);
            var isDigit = (!isNaN(parseInt(literal)));
            if (!isDigit) {
                this.ValueString = '0' + this.ValueString;
            }
            this.decimal = this.ValueString;
            this._parseDecimalInSimpleMode();
            this._setSelectionStart(selectionStart);
            this.value = this.decimal;
            this._raiseEvent(0, this.value);
            this._raiseEvent(1, this.numberInput.val());
        },

        insertsimple: function (insertion) {
            var selection = this._selection();
            var text = this.numberInput.val();

            if (selection.start == text.length && this.decimalDigits > 0)
                return;

            var oldValue = this.decimal;

            var separatorChar = this.decimalSeparator;
            this.ValueString = this.GetValueString(text, separatorChar, separatorChar != '');
            var positionInValue = this.GetSelectionInValue(selection.start, text, separatorChar, separatorChar != '');
            var lengthInValue = this.GetSelectionLengthInValue(selection.start, selection.length, text, separatorChar);

            var digitsToSeparator = this.GetDigitsToSeparator(0, this.ValueString, separatorChar);
            var decrementPositionInValue = false;

            if (this.decimalDigits > 0 && positionInValue >= this.ValueString.length) {
                positionInValue--;
            }

            this.RemoveRange(selection.start, lengthInValue, this.ValueString, separatorChar, false, true);
            this.InsertDigit(insertion, positionInValue, selection);
        },

        GetDigitsToSeparator: function (digitsToSeparator, valueString, separator) {
            if (separator == undefined) separator = '.';

            if (valueString.indexOf(separator) < 0) {
                return valueString.length;
            }

            for (i = 0; i < valueString.length; i++) {
                if (valueString.substring(i, i + 1) == separator) {
                    digitsToSeparator = i;
                    break;
                }
            }
            return digitsToSeparator;
        },

        _handleSimpleKeyDown: function (e, key) {
            var selection = this._selection();

            if (selection.start >= 0 && selection.start < this.items.length) {
                var letter = String.fromCharCode(key);
            }

            if (this.rtl && key == 37) {
                var shift = e.shiftKey;
                var offset = shift ? 1 : 0;
                if (shift) {
                    this._setSelection(selection.start + 1 - offset, selection.start + selection.length + 1);
                }
                else {
                    this._setSelection(selection.start + 1 - offset, selection.start + 1);
                }

                return false;
            }
            else if (this.rtl && key == 39) {
                var shift = e.shiftKey;
                var offset = shift ? 1 : 0;
                if (shift) {
                    this._setSelection(selection.start - 1, selection.length + offset + selection.start - 1);
                }
                else {
                    this._setSelection(selection.start - 1, selection.start - 1);
                }
                return false;
            }

            // handle backspace.
            if (key == 8) {
                this.Backspace();
                return false;
            }

            if (key == 190 || key == 110) {
                var position = this.GetSeparatorPositionInText(this.decimalSeparator, this.numberInput.val());
                if (position != -1) {
                    this._setSelectionStart(position + 1);
                }
                return false;
            }

            if (key == 188) {
                var value = this.numberInput.val();
                for (i = selection.start; i < value.length; i++) {
                    if (value[i] == this.groupSeparator) {
                        this._setSelectionStart(1 + i);
                        break;
                    }
                }

                return false;
            }

            // allow Ctrl+C (copy)
            if ((e.ctrlKey && key == 99 /* firefox */) || (e.ctrlKey && key == 67) /* opera */) {
                var selection = this._selection();
                var text = "";
                var input = this.numberInput.val();
                if (selection.start > 0 || selection.length > 0) {
                    for (var i = selection.start; i < selection.end; i++) {
                        text += input.substring(i, i + 1);
                    }
                }
                if ($.jqx.browser.msie) {
                    window.clipboardData.setData("Text", text);
                }
                this.savedText = text;
                return false;
            }
            // allow Ctrl+Z (undo)
            if ((e.ctrlKey && key == 122 /* firefox */) || (e.ctrlKey && key == 90) /* opera */) return false;
            // allow or deny Ctrl+V (paste), Shift+Ins
            if ((e.ctrlKey && key == 118 /* firefox */) || (e.ctrlKey && key == 86) /* opera */
            || (e.shiftKey && key == 45)) {
                if (this.savedText != null && this.savedText.length > 0) {
                    this.val(this.savedText);
                    //for (var i = 0; i < this.savedText.length; i++) {
                    //    var digit = parseInt(this.savedText.substring(i, i + 1));
                    //    if (!isNaN(digit)) {
                    //        this.insertsimple(digit);
                    //    }
                    //}
                }
                return false;
            }

            var letter = String.fromCharCode(key);
            var digit = parseInt(letter);
            if (key >= 96 && key <= 105) {
                digit = key - 96;
                key = key - 48;
            }

            if (!isNaN(digit)) {
                var me = this;
                this.insertsimple(digit);

                return false;
            }


            // handle del.
            if (key == 46) {
                this.Delete();
                return false;
            }

            if (key == 38) {
                this.spinUp();
                return false;
            }
            else if (key == 40) {
                this.spinDown();
                return false;
            }

            var specialKey = this._isSpecialKey(key);

            if (!$.jqx.browser.mozilla)
                return true;

            return specialKey;
        },

        //[optimize]
        _getEditRange: function () {
            var start = 0;
            var end = 0;

            for (i = 0; i < this.items.length; i++) {
                if (this.items[i].canEdit) {
                    start = i;
                    break;
                }
            }

            for (i = this.items.length - 1; i >= 0; i--) {
                if (this.items[i].canEdit) {
                    end = i;
                    break;
                }
            }

            return { start: start, end: end }
        },

        //[optimize]
        _getVisibleItems: function () {
            var visibleItems = new Array();
            var k = 0;
            for (i = 0; i < this.items.length; i++) {
                if (this.items[i].character.toString().length > 0) {
                    visibleItems[k] = this.items[i];
                    k++;
                }
            }

            return visibleItems;
        },

        //[optimize]
        _hasEmptyVisibleItems: function () {
            var visibleItems = this._getVisibleItems();
            for (i = 0; i < visibleItems.length; i++) {
                if (visibleItems[i].canEdit && visibleItems[i].character == this.promptChar) {
                    return true;
                }
            }

            return false;
        },

        //[optimize]
        _getFirstVisibleNonEmptyIndex: function () {
            var visibleItems = this._getVisibleItems();
            for (i = 0; i < visibleItems.length; i++) {
                if (visibleItems[i].canEdit && visibleItems[i].character != this.promptChar) {
                    return i;
                }
            }
        },

        //[optimize]
        _handleMouse: function (e, args) {
            var selection = this._selection();
            if (selection.length <= 1) {
                var firstItemIndex = this._getFirstVisibleNonEmptyIndex();
                if (selection.start < firstItemIndex) {
                    this._setSelectionStart(firstItemIndex);
                }
            }
        },

        _insertKey: function (key) {
            this.numberInput[0].focus();
            var letter = String.fromCharCode(key);
            var charDigit = parseInt(letter);
            if (isNaN(charDigit))
                return;

            var emptyDigits = 0;
            for (i = 0; i < this.items.length; i++) {
                if (this.items[i].character.length == 0) {
                    emptyDigits++;
                }
            }

            var selection = this._selection();

            var rootElement = this;
            if (selection.start >= 0 && selection.start <= this.items.length) {
                var selectedTextDeleted = false
                var firstItemIndex = this._getFirstVisibleNonEmptyIndex();
                if (selection.start < firstItemIndex && selection.length == 0) {
                    if (!isNaN(letter) || letter == ' ') {
                        this._setSelectionStart(firstItemIndex);
                        selection = this._selection();
                    }
                }

                var firstEditableIndex = this._getFirstEditableItemIndex();
                var lastEditableIndex = this._getLastEditableItemIndex();
                var visibleItems = this._getVisibleItems();
                $.each(visibleItems, function (i, value) {
                    if (selection.start > i && i != visibleItems.length - 1)
                        return;

                    var item = visibleItems[i];
                    if (i > lastEditableIndex) {
                        item = visibleItems[lastEditableIndex];
                    }

                    if (isNaN(letter) || letter == ' ')
                        return;

                    if (!item.canEdit) {
                        return;
                    }
                    var separatorPosition = rootElement._getSeparatorPosition();

                    if (rootElement._match(letter, item.regex)) {
                        if (!selectedTextDeleted && selection.length > 0) {
                            for (j = selection.start + emptyDigits; j < selection.end + emptyDigits; j++) {
                                if (rootElement.items[j].canEdit) {
                                    if (j > separatorPosition) {
                                        rootElement.items[j].character = '0';
                                    }
                                    else {
                                        rootElement.items[j].character = rootElement.promptChar;
                                    }
                                }
                            }

                            var text = rootElement._getString();
                            //           rootElement.inputValue(text);
                            selectedTextDeleted = true;
                        }

                        var separatorPosition = rootElement._getSeparatorPosition();
                        var hasEmptyItems = rootElement._hasEmptyVisibleItems();

                        if (selection.start <= separatorPosition && hasEmptyItems) {
                            var limit = i;
                            if (rootElement.decimalSeparatorPosition == -1 && selection.start == separatorPosition) {
                                limit = i + 1;
                            }

                            var numberString = "";
                            for (p = 0; p < limit; p++) {
                                if (visibleItems[p].canEdit && visibleItems[p].character != rootElement.promptChar) {
                                    numberString += visibleItems[p].character;
                                }
                            }

                            numberString += letter;
                            var offset = rootElement.decimal < 1 ? 1 : 0;

                            if (selection.start == separatorPosition && rootElement.decimalSeparatorPosition != -1) {
                                numberString += rootElement.decimalSeparator;
                                offset = 0;
                            }


                            for (p = limit + offset; p < visibleItems.length; p++) {
                                if (visibleItems[p].character == rootElement.decimalSeparator && visibleItems[p].isSeparator) {
                                    numberString += visibleItems[p].character;
                                }
                                else if (visibleItems[p].canEdit && visibleItems[p].character != rootElement.promptChar) {
                                    numberString += visibleItems[p].character;
                                }
                            }

                            if (rootElement.decimalSeparator != '.') {
                                numberString = rootElement._parseDecimalValue(numberString);
                            }

                            numberString = parseFloat(numberString).toString();
                            numberString = new Number(numberString);
                            numberString = numberString.toFixed(rootElement.decimalDigits);
                            if (rootElement.decimalSeparator != '.') {
                                numberString = rootElement._parseDecimalValueToEditorValue(numberString);
                            }

                            rootElement.setvalue('decimal', numberString);

                            var text = rootElement._getString();

                            if (selection.end < separatorPosition) {
                                rootElement._setSelectionStart(selection.end + offset);
                            }
                            else {
                                rootElement._setSelectionStart(selection.end);
                            }

                            if (selection.length >= 1) {
                                rootElement._setSelectionStart(selection.end);
                            }

                            if (selection.length == rootElement.numberInput.val().length) {
                                var selectBeforeSeparator = rootElement._moveCaretToDecimalSeparator();
                                var separatorOffset = rootElement.decimalSeparatorPosition >= 0 ? 1 : 0;
                                rootElement._setSelectionStart(selectBeforeSeparator - separatorOffset);
                            }
                        }
                        else {
                            if (selection.start < separatorPosition || selection.start > separatorPosition) {
                                if (rootElement.numberInput.val().length == selection.start && rootElement.decimalSeparatorPosition != -1) {
                                    return false;
                                }
                                else if (rootElement.numberInput.val().length == selection.start && rootElement.decimalSeparatorPosition == -1 && !hasEmptyItems) {
                                    return false;
                                }

                                var numberString = "";
                                var addedSeparator = false;
                                for (p = 0; p < i; p++) {
                                    if (visibleItems[p].canEdit && visibleItems[p].character != rootElement.promptChar) {
                                        numberString += visibleItems[p].character;
                                    }
                                    if (visibleItems[p].character == rootElement.decimalSeparator && visibleItems[p].isSeparator) {
                                        numberString += visibleItems[p].character;
                                        addedSeparator = true;
                                    }
                                }

                                numberString += letter;
                                var offset = rootElement.decimal < 1 ? 1 : 0;

                                if (!addedSeparator && selection.start == separatorPosition - 1) {
                                    numberString += rootElement.decimalSeparator;
                                    addedSeparator = true;
                                }

                                for (p = i + 1; p < visibleItems.length; p++) {
                                    if (!addedSeparator && visibleItems[p].character == rootElement.decimalSeparator && visibleItems[p].isSeparator) {
                                        numberString += visibleItems[p].character;
                                    }
                                    else if (visibleItems[p].canEdit && visibleItems[p].character != rootElement.promptChar) {
                                        numberString += visibleItems[p].character;
                                    }
                                }

                                rootElement.setvalue('decimal', numberString);

                                var text = rootElement._getString();

                                if (rootElement.decimalSeparatorPosition < 0 && item == visibleItems[lastEditableIndex]) {
                                    rootElement._setSelectionStart(i);

                                    return false;
                                }

                                var symbolstartposition = text.indexOf(rootElement.symbol);
                                var sel = !rootElement.getvalue('negative') ? 0 : 1;
                                if (symbolstartposition <= sel) symbolstartposition = text.length;

                                // Do not move caret, if it's after the symbol.
                                if (selection.start < symbolstartposition) {
                                    rootElement._setSelectionStart(i + 1);
                                }
                                else rootElement._setSelectionStart(i);

                                if (selection.length >= 1) {
                                    //             rootElement._setSelectionStart(selection.end);
                                }

                                if (selection.length == rootElement.numberInput.val().length) {
                                    var selectBeforeSeparator = rootElement._moveCaretToDecimalSeparator();
                                    rootElement._setSelectionStart(selectBeforeSeparator - 1);
                                }
                            }
                        }
                        return false;
                    }
                });
            }
        },

        //[optimize]
        _handleKeyPress: function (e, key) {
            var selection = this._selection();
            var rootElement = this;
            if ((e.ctrlKey && key == 97 /* firefox */) || (e.ctrlKey && key == 65) /* opera */) {
                return true;
            }

            if (key == 8) {
                if (selection.start > 0) {
                    rootElement._setSelectionStart(selection.start);
                }
                return false;
            }

            if (key == 46) {
                if (selection.start < this.items.length) {
                    rootElement._setSelectionStart(selection.start);
                }

                return false;
            }

            if (key == 45 || key == 173 || key == 109 || key == 189) {
                var isNegative = this.getvalue('negative');
                if (isNegative == false) {
                    this.setvalue('negative', true);
                }
                else {
                    this.setvalue('negative', false);
                }
            }

            if ($.jqx.browser.msie) {
                this._insertKey(key);
            }

            var specialKey = this._isSpecialKey(key);
            return specialKey;
        },

        //[optimize]
        _deleteSelectedText: function () {
            var selection = this._selection();
            var decimalString = "";
            var separatorPosition = this._getSeparatorPosition();
            var visibleItems = this._getVisibleItems();
            var prefix = this._getHiddenPrefixCount();

            if (this.numberInput.val().length == selection.start && selection.length == 0) {
                this._setSelection(selection.start, selection.start + 1);
                selection = this._selection();
            }

            for (i = 0; i < selection.start; i++) {
                if (visibleItems[i].canEdit && visibleItems[i].character != this.promptChar) {
                    decimalString += visibleItems[i].character;
                }
                else if (!visibleItems[i].canEdit && this.decimalSeparatorPosition != -1 && visibleItems[i] == visibleItems[this.decimalSeparatorPosition - prefix]) {
                    if (decimalString.length == 0) {
                        decimalString = "0";
                    }

                    decimalString += visibleItems[i].character;
                }
            }

            for (i = selection.start; i < selection.end; i++) {
                if (i > separatorPosition && this.decimalSeparatorPosition != -1) {
                    if (visibleItems[i].canEdit && visibleItems[i].character != this.promptChar) {
                        decimalString += "0";
                    }
                }
                else if (!visibleItems[i].canEdit && this.decimalSeparatorPosition != -1 && visibleItems[i] == visibleItems[this.decimalSeparatorPosition - prefix]) {
                    if (decimalString.length == 0) {
                        decimalString = "0";
                    }

                    decimalString += visibleItems[i].character;
                }
            }

            for (i = selection.end; i < visibleItems.length; i++) {
                if (visibleItems[i].canEdit && visibleItems[i].character != this.promptChar) {
                    decimalString += visibleItems[i].character;
                }
                else if (!visibleItems[i].canEdit && this.decimalSeparatorPosition != -1 && visibleItems[i] == visibleItems[this.decimalSeparatorPosition - prefix]) {
                    if (decimalString.length == 0) {
                        decimalString = "0";
                    }

                    decimalString += visibleItems[i].character;
                }
            }

            this.setvalue('decimal', decimalString);
            return selection.length > 0;
        },

        _restoreInitialState: function () {
            var suffix = parseInt(this.decimalDigits);

            // add the first digit + the decimal separator.           
            if (suffix > 0) {
                suffix += 2;
            }

            for (k = this.items.length - 1; k > this.items.length - 1 - suffix; k--) {
                if (this.items[k].canEdit && this.items[k].character == this.promptChar) {
                    this.items[k].character = 0;
                }
            }
        },

        clear: function () {
            this.setDecimal(0);
        },

        // clears the decimal value.
        clearDecimal: function () {
            if (this.inputMode == 'textbox') {
                this.numberInput.val();
                return;
            }

            for (var i = 0; i < this.items.length; i++) {
                if (this.items[i].canEdit) {
                    this.items[i].character = this.promptChar;
                }
            }

            this._restoreInitialState();
        },

        //[optimize]
        _saveSelectedText: function () {
            var selection = this._selection();
            var text = "";
            var visibleItems = this._getVisibleItems();

            if (selection.start > 0 || selection.length > 0) {
                for (i = selection.start; i < selection.end; i++) {
                    if (visibleItems[i].canEdit && visibleItems[i].character != this.promptChar) {
                        text += visibleItems[i].character;
                    }
                    else if (visibleItems[i].isSeparator) {
                        text += visibleItems[i].character;
                    }
                }
            }
            if ($.jqx.browser.msie) {
                window.clipboardData.setData("Text", text);
            }

            return text;
        },

        _pasteSelectedText: function () {
            var selection = this._selection();
            var text = "";
            var k = 0;

            this.selectedText = $.data(document.body, "jqxSelection");
            if (window.clipboardData) {
                var clipboardText = window.clipboardData.getData("Text");
                if (clipboardText != this.selectedText && clipboardText.length > 0) {
                    this.selectedText = window.clipboardData.getData("Text");
                    if (this.selectedText == null || this.selectedText == undefined)
                        return;
                }
            }
            var newSelection = selection.start;
            var visibleItems = this._getVisibleItems();
            if (this.selectedText != null) {
                for (var t = 0; t < this.selectedText.length; t++) {
                    var number = parseInt(this.selectedText[t]);
                    if (!isNaN(number)) {
                        var numberCode = 48 + number;
                        this._insertKey(numberCode);
                    }
                }
            }
        },

        _getHiddenPrefixCount: function () {
            var length = 0;

            if (!this.negative) {
                length++;
            }

            if (this.symbolPosition == "left") {
                for (i = 0; i < this.symbol.length; i++) {
                    if (this.symbol.substring(i, i + 1) == '') {
                        length++;
                    }
                }
            }
            return length;
        },

        //[optimize]
        _getEditableItem: function () {
            var selection = this._selection();

            for (i = 0; i < this.items.length; i++) {
                if (i < selection.start) {
                    if (this.items[i].canEdit && this.items[i].character != this.promptChar) {
                        return this.items[i];
                    }
                }
            }

            return null;
        },

        //[optimize]
        _getEditableItems: function () {
            var editableItems = new Array();
            var k = 0;

            for (i = 0; i < this.items.length; i++) {
                if (this.items[i].canEdit) {
                    editableItems[k] = this.items[i];
                    k++;
                }
            }

            return editableItems;
        },

        //[optimize]
        _getValidSelectionStart: function (selectionStart) {
            for (i = this.items.length - 1; i >= 0; i--) {
                if (this.items[i].canEdit && this.items[i].character != this.promptChar) {
                    return i;
                }
            }

            return -1;
        },

        //[optimize]
        _getEditableItemIndex: function (afterCaret) {
            var selection = this._selection();
            var prefix = this._getHiddenPrefixCount();
            var visibleItems = this._getVisibleItems();

            var index = selection.start;
            var editableIndex = -1;
            for (i = 0; i < index; i++) {
                if (i < visibleItems.length && visibleItems[i].canEdit) {
                    editableIndex = i + prefix;
                }
            }

            if (editableIndex == -1 && selection.length > 0) {
                index = selection.end;
                for (i = 0; i < index; i++) {
                    if (i < visibleItems.length && visibleItems[i].canEdit) {
                        editableIndex = i + prefix;
                        break;
                    }
                }
            }

            return editableIndex;
        },

        //[optimize]
        _getEditableItemByIndex: function (index) {
            for (k = 0; k < this.items.length; k++) {
                if (k > index) {
                    if (this.items[k].canEdit && this.items[k].character != this.promptChar) {
                        return k;
                    }
                }
            }

            return -1;
        },

        //[optimize]
        _getFirstEditableItemIndex: function () {
            var visibleItems = this._getVisibleItems();
            for (m = 0; m < visibleItems.length; m++) {
                if (visibleItems[m].character != this.promptChar && visibleItems[m].canEdit && visibleItems[m].character != '0')
                    return m;
            }

            return -1;
        },

        //[optimize]
        _getLastEditableItemIndex: function () {
            var visibleItems = this._getVisibleItems();
            for (m = visibleItems.length - 1; m >= 0; m--) {
                if (visibleItems[m].character != this.promptChar && visibleItems[m].canEdit)
                    return m;
            }

            return -1;
        },

        //[optimize]
        _moveCaretToDecimalSeparator: function () {
            for (i = this.items.length - 1; i >= 0; i--) {
                if (this.items[i].character == this.decimalSeparator && this.items[i].isSeparator) {
                    if (!this.negative) {
                        this._setSelectionStart(i);
                        return i;
                    }
                    else {
                        this._setSelectionStart(i + 1);
                        return i;
                    }
                    break;
                }
            }

            return this.numberInput.val().length;
        },

        //[optimize]
        _handleBackspace: function () {
            var selection = this._selection();
            var prefix = this._getHiddenPrefixCount();
            var editableItemIndex = this._getEditableItemIndex() - prefix;

            if (editableItemIndex >= 0) {
                if (selection.length == 0 && editableItemIndex != -1) {
                    this._setSelection(editableItemIndex, editableItemIndex + 1);
                }

                var deleteAfterSeparator = selection.start > this._getSeparatorPosition() + 1 && this.decimalSeparatorPosition > 0;
                if (deleteAfterSeparator) {
                    selection = this._selection();
                }

                var deletedText = this._deleteSelectedText();
                if (selection.length < 1 || deleteAfterSeparator) {
                    this._setSelectionStart(selection.start);
                }
                else if (selection.length >= 1) {
                    this._setSelectionStart(selection.end);
                }

                if (selection.length == this.numberInput.val().length) {
                    var selectBeforeSeparator = this._moveCaretToDecimalSeparator();
                    this._setSelectionStart(selectBeforeSeparator - 1);
                }
            }
            else {
                this._setSelectionStart(selection.start);
            }
        },

        //[optimize]
        _handleKeyDown: function (e, key) {
            var selection = this._selection();

            if (this.rtl && key == 37) {
                var shift = e.shiftKey;
                var offset = shift ? 1 : 0;
                if (shift) {
                    this._setSelection(selection.start + 1 - offset, selection.start + selection.length + 1);
                }
                else {
                    this._setSelection(selection.start + 1 - offset, selection.start + 1);
                }

                return false;
            }
            else if (this.rtl && key == 39) {
                var shift = e.shiftKey;
                var offset = shift ? 1 : 0;
                if (shift) {
                    this._setSelection(selection.start - 1, selection.length + offset + selection.start - 1);
                }
                else {
                    this._setSelection(selection.start - 1, selection.start - 1);
                }
                return false;
            }

            if ((e.ctrlKey && key == 97 /* firefox */) || (e.ctrlKey && key == 65) /* opera */) {
                return true;
            } // allow Ctrl+X (cut)
            if ((e.ctrlKey && key == 120 /* firefox */) || (e.ctrlKey && key == 88) /* opera */) {
                this.selectedText = this._saveSelectedText(e);
                $.data(document.body, "jqxSelection", this.selectedText);
                this._handleBackspace();
                return false;
            }
            // allow Ctrl+C (copy)
            if ((e.ctrlKey && key == 99 /* firefox */) || (e.ctrlKey && key == 67) /* opera */) {
                this.selectedText = this._saveSelectedText(e);
                $.data(document.body, "jqxSelection", this.selectedText);
                return false;
            }
            // allow Ctrl+Z (undo)
            if ((e.ctrlKey && key == 122 /* firefox */) || (e.ctrlKey && key == 90) /* opera */) return false;
            // allow or deny Ctrl+V (paste), Shift+Ins
            if ((e.ctrlKey && key == 118 /* firefox */) || (e.ctrlKey && key == 86) /* opera */
            || (e.shiftKey && key == 45)) {
                this._pasteSelectedText();
                return false;
            }
            if (selection.start >= 0 && selection.start < this.items.length) {
                var letter = String.fromCharCode(key);
                var item = this.items[selection.start];
            }

            // handle backspace.
            if (key == 8) {
                this._handleBackspace();
                return false;
            }

            if (key == 190 || key == 110) {
                this._moveCaretToDecimalSeparator();
                return false;
            }

            if (key == 188) {
                var value = this.numberInput.val();
                for (i = selection.start; i < value.length; i++) {
                    if (value[i] == this.groupSeparator) {
                        this._setSelectionStart(1 + i);
                        break;
                    }
                }

                return false;
            }

            if ($.jqx.browser.msie == null) {
                var letter = String.fromCharCode(key);
                var digit = parseInt(letter);
                if (key >= 96 && key <= 105) {
                    digit = key - 96;
                    key = key - 48;
                }

                if (!isNaN(digit)) {
                    var me = this;
                    me._insertKey(key);
                    return false;
                }
            }

            // handle del.
            if (key == 46) {
                var visibleItems = this._getVisibleItems();
                if (selection.start < visibleItems.length) {
                    var offset = visibleItems[selection.start].canEdit == false ? 2 : 1;
                    if (selection.length == 0) {
                        this._setSelection(selection.start + offset, selection.start + offset + selection.length);
                    }

                    this._handleBackspace();

                    if (new Number(this.decimal) < 1 || selection.start > this._getSeparatorPosition()) {
                        this._setSelectionStart(selection.end + offset);
                    }
                    else if (selection.start + 1 < this.decimalSeparatorPosition) {
                        this._setSelectionStart(selection.end + offset);
                    }
                }
                return false;
            }

            if (key == 38) {
                this.spinUp();
                return false;
            }
            else if (key == 40) {
                this.spinDown();
                return false;
            }

            var specialKey = this._isSpecialKey(key);

            if (!$.jqx.browser.mozilla)
                return true;

            return specialKey;
        },

        _isSpecialKey: function (key) {
            if (key != 8 /* backspace */ &&
			key != 9 /* tab */ &&
			key != 13 /* enter */ &&
			key != 35 /* end */ &&
			key != 36 /* home */ &&
			key != 37 /* left */ &&
			key != 39 /* right */ &&
			key != 27 /* right */ &&
		    key != 46 /* del */
		    ) {
                return false;
            }

            return true;
        },

        //[optimize]
        _selection: function () {
            try
            {
                if ('selectionStart' in this.numberInput[0]) {
                    var e = this.numberInput[0];
                    var selectionLength = e.selectionEnd - e.selectionStart;
                    return { start: e.selectionStart, end: e.selectionEnd, length: selectionLength, text: e.value };
                }
                else {
                    var r = document.selection.createRange();
                    if (r == null) {
                        return { start: 0, end: e.value.length, length: 0 }
                    }

                    var re = this.numberInput[0].createTextRange();
                    var rc = re.duplicate();
                    re.moveToBookmark(r.getBookmark());
                    rc.setEndPoint('EndToStart', re);
                    var selectionLength = r.text.length;

                    return { start: rc.text.length, end: rc.text.length + r.text.length, length: selectionLength, text: r.text };
                }
            }
            catch (error) {
                return { start: 0, end: 0, length: 0 };
            }
        },

        _setSelection: function (start, end) {
            if (this._disableSetSelection == true) return;
            var isTouchDevice = $.jqx.mobile.isTouchDevice();
            if (isTouchDevice || this.touchMode == true)
                return;

            try {
                if ('selectionStart' in this.numberInput[0]) {
                    this.numberInput[0].focus();
                    this.numberInput[0].setSelectionRange(start, end);
                }
                else {
                    var range = this.numberInput[0].createTextRange();
                    range.collapse(true);
                    range.moveEnd('character', end);
                    range.moveStart('character', start);
                    range.select();
                }
            }
            catch (error) {
            }
        },

        _setSelectionStart: function (start) {
            this._setSelection(start, start);
            $.data(this.numberInput, "selectionstart", start);
        },

        _render: function (refreshValue) {
            var leftBorder = parseInt(this.host.css("border-left-width"));
            var rightBorder = parseInt(this.host.css("border-left-width"));
            var topBorder = parseInt(this.host.css("border-left-width"));
            var bottomBorder = parseInt(this.host.css("border-left-width"));
            this.numberInput.css("padding-top", '0px');
            this.numberInput.css("padding-bottom", '0px');

            this.host.height(this.height);
            this.host.width(this.width);

            var width = this.host.width();
            var height = this.host.height();

            this.numberInput.css({
                "border-left-width": 0,
                "border-right-width": 0,
                "border-bottom-width": 0,
                "border-top-width": 0
            });

            this.numberInput.css("text-align", this.textAlign);
            var fontSize = this.numberInput.css("font-size");

            this.numberInput.css('height', parseInt(fontSize) + 4 + 'px');
            this.numberInput.css('width', width - 2);

            var top = height - 2 * topBorder - parseInt(fontSize) - 2;
            if (isNaN(top)) top = 0;
            if (top < 0) top = 0;
            if (this.spinButtons && this.spincontainer) {
                width -= parseInt(this.spinButtonsWidth - 2);
                var touchDevice = $.jqx.mobile.isTouchDevice();
                if (!touchDevice && this.touchMode !== true) {
                    this.spincontainer.width(this.spinButtonsWidth);
                    this.upbutton.width(this.spinButtonsWidth + 2);
                    this.downbutton.width(this.spinButtonsWidth + 2);
                    this.upbutton.height('50%');
                    this.downbutton.height('50%');
                    this.spincontainer.width(this.spinButtonsWidth);
                }
                else {
                    this.spincontainer.width(2 * (this.spinButtonsWidth));
                    width -= this.spinButtonsWidth;
                    this.upbutton.height('100%');
                    this.downbutton.height('100%');
                    this.downbutton.css('float', 'left');
                    this.upbutton.css('float', 'right');
                    this.upbutton.width(this.spinButtonsWidth);
                    this.downbutton.width(1+this.spinButtonsWidth);
                }

                this._upArrow.height('100%');
                this._downArrow.height('100%');
                this.numberInput.css('width', width - 6);
                this.numberInput.css('margin-right', '2px');
            }

            var topPadding = top / 2;

            // fix for MSIE 6 and 7. These browsers double the top padding for some reason...
            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                topPadding = top / 4;
            }

            this.numberInput.css("padding-left", '0px');
            this.numberInput.css("padding-right", '0px');
            this.numberInput.css("padding-top", Math.round(topPadding) + 'px');
            this.numberInput.css("padding-bottom", Math.round(topPadding) + 'px');

            if (refreshValue == undefined || refreshValue == true) {
                this.numberInput.val(this._getString())
                if (this.inputMode != 'advanced') {
                    this._parseDecimalInSimpleMode();
                }
            }
        },

        destroy: function () {
            this._removeHandlers();
            this.host.remove();
        },

        // gets or sets the input's text value including the formatting characters.
        inputValue: function (newValue) {
            if (newValue === undefined) {
                return this._value();
            }

            this.propertyChangedHandler(this, "value", this._value, newValue);
            this._refreshValue();
            return this;
        },

        // gets the input's value.
        _value: function () {
            var value = this.numberInput.val();
            return value;
        },

        val: function (decimal) {
            if (decimal != undefined && typeof decimal != 'object') {
                if (decimal === null) {
                    this.element.value = "";
                }
                else {
                    var value = decimal;
                    value = value.toString();
                    if (value.indexOf(this.symbol) > -1) {
                        // remove currency symbol
                        value = value.replace(this.symbol, "");
                    }

                    var replaceAll = function (text, stringToFind, stringToReplace) {
                        var temp = text;
                        if (stringToFind == stringToReplace) return text;

                        var index = temp.indexOf(stringToFind);
                        while (index != -1) {
                            temp = temp.replace(stringToFind, stringToReplace);
                            index = temp.indexOf(stringToFind)
                        }

                        return temp;
                    }

                    value = replaceAll(value, this.groupSeparator, "");
                    value = value.replace(this.decimalSeparator, ".");

                    var val = "";
                    for (var t = 0; t < value.length; t++) {
                        var ch = value.substring(t, t + 1);
                        if (ch === "-") val += "-";
                        if (ch === ".") val += ".";
                        if (ch.match(/^[0-9]+$/) != null) {
                            val += ch;
                        }
                    }

                    value = val;
                    value = value.replace(/ /g, "");
                    value = new Number(value);

                    this.setDecimal(value);
                }
            }
            else return this.getDecimal();
        },

        getDecimal: function () {
            if (this.inputMode == 'simple') {
                this._parseDecimalInSimpleMode(false);
                this.decimal = this._getDecimalInSimpleMode(this.decimal);
            }

            if (this.decimal == "") return 0;

            var isNegative = this.getvalue('negative');
            if (isNegative && this.decimal > 0) {
                return -parseFloat(this.decimal);
            }

            return parseFloat(this.decimal);
        },

        setDecimal: function (value) {
            var currentValue = value;
            if (this.decimalSeparator != '.') {
                value = value.toString();
                var separatorIndex = value.indexOf('.');
                if (separatorIndex != -1) {
                    var prefix = value.substring(0, separatorIndex);
                    var suffix = value.substring(separatorIndex + 1);
                    value = prefix + this.decimalSeparator + suffix;
                }
                if (value < 0)
                    this.setvalue('negative', true);
                else {
                    this.setvalue('negative', false);
                }
                this._setDecimal(value);
            }
            else {
                if (value < 0)
                    this.setvalue('negative', true);
                else {
                    this.setvalue('negative', false);
                }
                this._setDecimal(Math.abs(value));
            }

            if (currentValue == null) {
                this.numberInput.val("");
            }
        },

        // sets the input's decimal value.
        _setDecimal: function (value) {
            if (value == null || value == undefined) {
                value = 0;
            }

            if (value.toString().indexOf('e') != -1) {
                value = 0;
            }

            this.clearDecimal();
            var decimalString = value.toString();
            var numberPartString = "";
            var decimalPartString = "";
            var addToNumberPart = true;

            if (decimalString.length == 0) {
                decimalString = "0";
            }

            for (var i = 0; i < decimalString.length; i++) {
                if (decimalString.substring(i, i + 1) == this.decimalSeparator) {
                    addToNumberPart = false;
                    continue;
                }

                if (addToNumberPart) {
                    numberPartString += decimalString.substring(i, i + 1);
                }
                else {
                    decimalPartString += decimalString.substring(i, i + 1);
                }
            }

            if (numberPartString.length > 0) {
                numberPartString = parseFloat(numberPartString).toString();
            }

            var digitsBeforeSeparator = this.digits;
            if (digitsBeforeSeparator < numberPartString.length) {
                numberPartString = numberPartString.substr(0, digitsBeforeSeparator);
            }

            var k = 0;
            var separatorPosition = this._getSeparatorPosition();
            var hiddenTextLength = this._getHiddenPrefixCount();
            separatorPosition = separatorPosition + hiddenTextLength;

            for (var i = separatorPosition; i >= 0; i--) {
                if (i < this.items.length && this.items[i].canEdit) {
                    if (k < numberPartString.length) {
                        this.items[i].character = numberPartString.substring(numberPartString.length - k - 1, numberPartString.length - k);
                        k++;
                    }
                }
            }

            k = 0;
            for (var i = separatorPosition; i < this.items.length; i++) {
                if (this.items[i].canEdit) {
                    if (k < decimalPartString.length) {
                        this.items[i].character = decimalPartString.substring(k, k + 1);
                        k++;
                    }
                }
            }

            this._refreshValue();

            if (this.decimalSeparator == '.') {
                this.ValueString = new Number(value).toFixed(this.decimalDigits);
            }
            else {
                var indx = value.toString().indexOf(this.decimalSeparator);
                if (indx > 0) {
                    var prefix = value.toString().substring(0, indx);
                    var val = prefix + "." + value.toString().substring(indx + 1);
                    this.ValueString = new Number(val).toFixed(this.decimalDigits);
                }
                else {
                    this.ValueString = new Number(value).toFixed(this.decimalDigits);
                }
            }

            if (this.inputMode != 'advanced') {
                this._parseDecimalInSimpleMode();
                this._raiseEvent(1, this.ValueString);
            }
            if (this.inputMode == 'textbox') {
                this.decimal = this.ValueString;
                var isNegative = this.getvalue('negative');
                if (isNegative) {
                    this.decimal = "-" + this.ValueString;
                }
            }

            var value = this.val();
            if (value < this.min || value > this.max) {
                this.host.addClass('jqx-input-invalid');
            }
            else
            {
                this.host.removeClass('jqx-input-invalid');
            }
        },

        //[optimize]
        _getSeparatorPosition: function () {
            var hiddenTextLength = this._getHiddenPrefixCount();
            if (this.decimalSeparatorPosition > 0)
                return this.decimalSeparatorPosition - hiddenTextLength;

            return this.items.length - hiddenTextLength;
        },

        _setTheme: function () {
            this.host.removeClass();
            this.host.addClass(this.toThemeProperty('jqx-input'));
            this.host.addClass(this.toThemeProperty('jqx-rc-all'));
            this.host.addClass(this.toThemeProperty('jqx-widget'));
            this.host.addClass(this.toThemeProperty('jqx-widget-content'));
            this.host.addClass(this.toThemeProperty('jqx-numberinput'));

            if (this.spinButtons) {
                this.downbutton.removeClass();
                this.upbutton.removeClass();
                this.downbutton.addClass(this.toThemeProperty('jqx-scrollbar-button-state-normal'));
                this.upbutton.addClass(this.toThemeProperty('jqx-scrollbar-button-state-normal'));
                this._upArrow.removeClass();
                this._downArrow.removeClass();
                this._upArrow.addClass(this.toThemeProperty('jqx-icon-arrow-up'));
                this._downArrow.addClass(this.toThemeProperty('jqx-icon-arrow-down'));

            }
            this.numberInput.removeClass();
            this.numberInput.addClass(this.toThemeProperty('jqx-input-content'));
        },

        // sets a property.
        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (key == 'digits' || key == 'groupSize' || key == 'decimalDigits') {
                if (value < 0) {
                    throw new Exception(this.invalidArgumentExceptions[0]);
                }
            }

            if (key === 'theme') {
                $.jqx.utilities.setTheme(oldvalue, value, object.host);
            }

            if (key == "digits") {
                if (value != oldvalue) {
                    object.digits = parseInt(value);
                }
            }

            if (key == "min" || key == "max") {
                $.jqx.aria(object, "aria-value" + key, value.toString());
                object._refreshValue();
            }

            if (key == "decimalDigits") {
                if (value != oldvalue) {
                    object.decimalDigits = parseInt(value);
                }
            }

            if (key == "decimalSeparator" || key == "digits" || key == "symbol" || key == "symbolPosition" || key == "groupSize" || key == "groupSeparator" || key == "decimalDigits" || key == "negativeSymbol") {
                var decimal = object.decimal;

                if (key == 'decimalSeparator' && value == '') {
                    value = ' ';
                }

                if (oldvalue != value) {
                    var selection = object._selection();
                    object.items = new Array();
                    object._initializeLiterals();
                    object.value = object._getString();
                    object._refreshValue();
                    object._setDecimal(decimal);
                }
            }
            if (key == "rtl") {
                if (object.rtl) {
                    if (object.spincontainer) {
                        object.spincontainer.css('float', 'right');
                        object.spincontainer.css('border-right-width', '1px');
                    }
                    object.numberInput.css('float', 'right');
                }
                else {
                    if (object.spincontainer) {
                        object.spincontainer.css('float', 'right');
                        object.spincontainer.css('border-right-width', '1px');
                    }
                    object.numberInput.css('float', 'left');
                }
            }
            if (key == "spinButtons") {
                if (object.spincontainer) {
                    if (!value) {
                        object.spincontainer.css('display', 'none');
                    }
                    else {
                        object.spincontainer.css('display', 'block');
                    }
                    object._render();
                }
                else {
                    object._spinButtons();
                }
            }
            if (key === "touchMode") {
                object.inputMode = 'textbox';
                object.spinMode = 'simple';

                object.render();
            }
            if (key == "negative" && object.inputMode == 'advanced') {
                var selection = object._selection();
                var offset = 0;

                if (value) {
                    object.items[0].character = object.negativeSymbol[0];
                    offset = 1;
                }
                else {
                    object.items[0].character = "";
                    offset = -1;
                }

                object._refreshValue();
                if (object.isInitialized) {
                    object._setSelection(selection.start + offset, selection.end + offset);
                }
            }

            if (key == "decimal") {
                object.value = value;
                object.setDecimal(value);
            }

            if (key === "value") {
                object.value = value;
                object.setDecimal(value);
                object._raiseEvent(1, value);
            }

            if (key == "textAlign") {
                object.textAlign = value;
                object._render();
            }

            if (key == "disabled") {
                object.numberInput.attr("disabled", value);
                if (object.disabled) {
                    object.host.addClass(object.toThemeProperty('jqx-fill-state-disabled'));
                }
                else {
                    object.host.removeClass(object.toThemeProperty('jqx-fill-state-disabled'));
                }
                $.jqx.aria(object, "aria-disabled", value.toString());
            }

            if (key == "readOnly") {
                object.readOnly = value;
            }

            if (key == "promptChar") {
                for (i = 0; i < object.items.length; i++) {
                    if (object.items[i].character == object.promptChar) {
                        object.items[i].character = value;
                    }
                }

                object.promptChar = value;
            }

            if (key == "width") {
                object.width = value;
                object._render();
            }
            else if (key == "height") {
                object.height = value;
                object._render();
            }
        },

        _value: function () {
            var val = this.value;
            return val;
        },

        _refreshValue: function () {
            var value = this.value;
            var k = 0;
           
            if (this.inputMode === 'textbox') {
                return;
            }

            this.value = this._getString();
            value = this.value;

            var decimalValue = "";
            for (var i = 0; i < this.items.length; i++) {
                var item = this.items[i];

                if (item.canEdit && item.character != this.promptChar) {
                    decimalValue += item.character;
                }

                if (i == this.decimalSeparatorPosition) {
                    decimalValue += ".";
                }
            }

            this.decimal = decimalValue;

            var hasChange = false;

            if (this.oldValue !== value) {
                this.oldValue = value;
                this._raiseEvent(0, value);
                hasChange = true;
            }

            if (this.inputMode != 'simple') {
                this.numberInput.val(value);
                if (hasChange) {
                    this._raiseEvent(1, value);
                }
            }

            if (value == null) {
                this.numberInput.val("");
            }
        }
    });
})(jQuery);
(function ($) {

    $.jqx.jqxWidget("jqxProgressBar", "", {});

    $.extend($.jqx._jqxProgressBar.prototype, {

        defineInstance: function () {
            //Type: Number.
            //Default: 0.
            //Sets the progress value.
            this.value = 0;
            //Type: Number.
            //Default: null.
            //Sets the progress value.            
            this.oldValue = null;
            //Type: Number.
            //Default: 100.
            //Sets the progress max value.
            this.max = 100;
            //Type: Number.
            //Default: 0.
            //Sets the progress min value.
            this.min = 0;
            //Type: String.
            //Default: 'horizontal'.
            //Sets the orientation.
            this.orientation = 'horizontal';
            //Type: String.
            //Default: 'normal'. Values: 'normal' or 'reverse'
            //Sets the layout.
            this.layout = 'normal';
            //Type: String.
            //Default: null.
            //Sets the progress bar width.
            this.width = null;
            //Type: String.
            //Default: null.
            //Sets the progress height width.
            this.height = null;
            //Type: Boolean.
            //Default: false.
            //Sets the visibility of the progress bar's text.
            this.showText = false;
            //Type: Number.
            //Default: 300
            //Sets the duration of the progress bar's animation.
            this.animationDuration = 300;
            // gets or sets whether the progress bar is disabled.
            this.disabled = false;
            this.rtl = false;
            this.renderText = null;
            this.aria =
            {
                "aria-valuenow": { name: "value", type: "number" },
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
            // Progress Bar events.
            this.events =
			[
            // occurs when the value is changed.
		  	   'valuechanged',
            // occurs when the value is invalid.
               'invalidvalue',
            // occurs when the value becomes equal to the maximum value.
               'complete'
			];
        },

        // creates a new jqxProgressBar instance.
        createInstance: function (args) {

            var self = this;

            this.host.addClass(this.toThemeProperty("jqx-progressbar"));
            this.host.addClass(this.toThemeProperty("jqx-widget"));
            this.host.addClass(this.toThemeProperty("jqx-widget-content"));
            this.host.addClass(this.toThemeProperty("jqx-rc-all"));
            $.jqx.aria(this);

            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                this.host.width(this.width);
            }
            else if (this.width != undefined && !isNaN(this.width)) {
                this.host.width(this.width);
            }
            else this.host.width(this.width);

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                this.host.height(this.height);
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                this.host.height(this.height);
            }
            else this.host.height(this.height);

            this.valueDiv = $("<div></div>").appendTo(this.element);

            if (this.orientation == 'horizontal') {
                this.valueDiv.width(0);
                this.valueDiv.addClass(this.toThemeProperty("jqx-progressbar-value"));
            }
            else {
                this.valueDiv.height(0);
                this.valueDiv.addClass(this.toThemeProperty("jqx-progressbar-value-vertical"));
            }

            this.valueDiv.addClass(this.toThemeProperty("jqx-fill-state-pressed"));

            this.feedbackElementHost = $("<div style='width: 100%; height: 100%; position: relative;'></div>").appendTo(this.host);

            this.feedbackElement = $("<span class='text'></span>").appendTo(this.feedbackElementHost);
            this.feedbackElement.addClass(this.toThemeProperty('jqx-progressbar-text'));
            this.oldValue = this._value();
            this.refresh();

            $.jqx.utilities.resize(this.host, function () {
                self.refresh();
            });
        },

        destroy: function () {
            this.host.removeClass();
            this.valueDiv.removeClass();
            this.valueDiv.remove();
            this.feedbackElement.remove();
        },

        _raiseevent: function (id, oldValue, newValue) {
            if (this.isInitialized != undefined && this.isInitialized == true) {
                var evt = this.events[id];
                var event = new jQuery.Event(evt);
                event.previousValue = oldValue;
                event.currentValue = newValue;
                event.owner = this;
                var result = this.host.trigger(event);
                return result;
            }
        },

        // gets or sets the progress bar value.
        // @param Number. Represents the new value
        actualValue: function (newValue) {
            if (newValue === undefined) {
                return this._value();
            }

            $.jqx.aria(this, "aria-valuenow", newValue);
            $.jqx.setvalueraiseevent(this, 'value', newValue);

            return this._value();
        },

        val: function (value) {
            if (arguments.length == 0 || typeof (value) == "object") {
                return this.actualValue();
            }

            return this.actualValue(value);
        },

        propertyChangedHandler: function (object, key, oldValue, value) {
            if (!this.isInitialized)
                return;

            var widget = this;

            if (key == "min" && object.value < value) {
                object.value = value;
            }
            else if (key == "max" && object.value > value) {
                object.value = value;
            }

            if (key === "value" && widget.value != undefined) {
                widget.value = value;
                widget.oldValue = oldValue;
                $.jqx.aria(object, "aria-valuenow", value);

                if (value < widget.min || value > widget.max) {
                    widget._raiseevent(1, oldValue, value);
                }

                widget.refresh();
            }
            if (key == 'theme') {
                $.jqx.utilities.setTheme(oldValue, value, object.host);
            }
            if (key == "renderText" || key == "orientation" || key == 'layout' || key == "showText" || key == "min" || key == "max") {
                widget.refresh();
            }
            else if (key == "width" && widget.width != undefined) {
                if (widget.width != undefined && !isNaN(widget.width)) {
                    widget.host.width(widget.width);
                    widget.refresh();
                }
            }
            else if (key == "height" && widget.height != undefined) {
                if (widget.height != undefined && !isNaN(widget.height)) {
                    widget.host.height(widget.height);
                    widget.refresh();
                }
            }
            if (key == "disabled") 
				widget.refresh();
        },

        _value: function () {
            var val = this.value;
            // normalize invalid value
            if (typeof val !== "number") {
                var result = parseInt(val);
                if (isNaN(result)) {
                    val = 0;
                }
                else val = result;
            }
            return Math.min(this.max, Math.max(this.min, val));
        },

        _percentage: function () {
            return 100 * this._value() / this.max;
        },

        _textwidth: function (text) {
            var measureElement = $('<span>' + text + '</span>');
            $(this.host).append(measureElement);
            var width = measureElement.width();
            measureElement.remove();
            return width;
        },

        _textheight: function (text) {
            var measureElement = $('<span>' + text + '</span>');
            $(this.host).append(measureElement);
            var height = measureElement.height();
            measureElement.remove();
            return height;
        },

        _initialRender: true,

        refresh: function () {
            var value = this.actualValue();
            var percentage = this._percentage();

            if (this.disabled) {
                this.host.addClass(this.toThemeProperty('jqx-progressbar-disabled'));
                this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
                return;
            }
            else {
                this.host.removeClass(this.toThemeProperty('jqx-progressbar-disabled'));
                this.host.removeClass(this.toThemeProperty('jqx-fill-state-disabled'));
                $(this.element.children[0]).show();
            }

            if (isNaN(value)) {
                return;
            }

            if (isNaN(percentage)) {
                return;
            }

            if (this.oldValue !== value) {
                this._raiseevent(0, this.oldValue, value);
                this.oldValue = value;
            }
            var oldValue = this.oldValue;
            var height = this.host.outerHeight();
            var width = this.host.outerWidth();

            if (this.width != null) {
                width = parseInt(this.width);
            }
            if (this.height != null) {
                height = parseInt(this.height);
            }

            var halfWidth = parseInt(this.host.outerWidth()) / 2;
            var halfHeight = parseInt(this.host.outerHeight()) / 2;

            if (isNaN(percentage))
                percentage = 0;


            var me = this;
            try {
                var valueElement = this.element.children[0];
                $(valueElement)[0].style.position = 'relative';

                if (this.orientation == "horizontal") {
                    $(valueElement).toggle(value >= this.min)

                    var width = this.host.outerWidth() * percentage / 100;
                    var offsetLeft = 0;
                    if (this.layout == 'reverse' || this.rtl) {
                        if (this._initialRender) {
                            $(valueElement)[0].style.left = this.host.width() + 'px';
                            $(valueElement)[0].style.width = 0;
                        }
                        offsetLeft = this.host.outerWidth() - width;
                    }

                    $(valueElement).animate({ width: width, left: offsetLeft + 'px' }, this.animationDuration, function () {
                        if (me._value() === me.max) {
                            me._raiseevent(2, oldValue, me.max);
                        }
                    }
                    );

                    this.feedbackElementHost.css('margin-top', -this.host.height());
                }
                else {
                    $(valueElement).toggle(value >= this.min)
                    var height = this.host.height() * percentage / 100;
                    var offsetTop = 0;
                    if (this.layout == 'reverse') {
                        if (this._initialRender) {
                            $(valueElement)[0].style.top = this.host.height() + 'px';
                            $(valueElement)[0].style.height = 0;
                        }
                        offsetTop = this.host.height() - height;
                    }

                    this.feedbackElementHost.animate({ 'margin-top': -(percentage.toFixed(0) * me.host.height()) / 100 }, this.animationDuration, function () { });

                    $(valueElement).animate({ height: height, top: offsetTop + 'px' }, this.animationDuration, function () {
                        var percentage = me._percentage();
                        if (isNaN(percentage))
                            percentage = 0;

                        if (percentage.toFixed(0) == me.min) {
                            $(valueElement).hide();
                            if (me._value() === me.max) {
                                me._raiseevent(2, oldValue, me.max);
                            }
                        }
                    });

                }
            }
            catch (ex) {
            }

            this._initialRender = false;

            this.feedbackElement
			    .html(percentage.toFixed(0) + "%")
                .toggle(this.showText == true);

            if (this.renderText)
                this.feedbackElement.html(this.renderText(percentage.toFixed(0) + "%"));

            this.feedbackElement.css('position', 'absolute');
            this.feedbackElement.css('top', '50%');
            this.feedbackElement.css('left', '0');

            var textHeight = this.feedbackElement.height();
            var textWidth = this.feedbackElement.width();
            var centerWidth = Math.floor(halfWidth - (parseInt(textWidth) / 2));

            this.feedbackElement.css({ "left": (centerWidth), "margin-top": -parseInt(textHeight) / 2 + 'px' });
        }
    });
})(jQuery);

(function ($) {

    $.jqx.jqxWidget("jqxRadioButton", "", {});

    $.extend($.jqx._jqxRadioButton.prototype, {
        defineInstance: function () {
            // Type: Number
            // Default: 250
            // Gets or sets the delay of the fade animation when the RadioButton is going to be opened.
            this.animationShowDelay = 300,
            // Type: Number
            // Default: 300
            // Gets or sets the delay of the fade animation when the RadioButton is going to be closed. 
             this.animationHideDelay = 300,
            // Type: Number.
            // Default: null.
            // Sets the width.
            this.width = null;
            // Type: Number.
            // Default: null.
            // Sets the height.
            this.height = null;
            // Type: String
            // Default: '13px'
            // Gets or sets the radiobutton's size.
            this.boxSize = '13px';
            // Type: Bool and Null
            // Default: false
            // Gets or sets the ckeck state.
            // Possible Values: true, false and null.
            this.checked = false;
            // Type: Bool
            // Default: false
            // Gets or sets whether the radiobutton has 3 states - checked, unchecked and indeterminate.
            this.hasThreeStates = false;
            // Type: Bool
            // Default: false
            // Gets whether the CheckBox is disabled.
            this.disabled = false;
            // Type: Bool
            // Default: true
            // Gets or sets whether the clicks on the container are handled as clicks on the check box.
            this.enableContainerClick = true;
            // Type: Bool
            // Default: true
            // Gets or sets whether the checkbox is locked. In this mode the user is not allowed to check/uncheck the radio button.
            this.locked = false;
            // Type: String
            // Default: ''
            // Gets or sets the group name. When this property is set, the checkboxes in the same group behave as radio buttons.
            this.groupName = '';
            this.rtl = false;
            this.aria =
            {
                "aria-checked": { name: "checked", type: "boolean" },
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
            // 'checked' is triggered when the radiobutton is checked.
            // 'unchecked' is triggered when the radiobutton is unchecked.
            // 'indeterminate' is triggered when the radiobutton's ckecked property is going to be null.
            // 'change' is triggered when the radiobutton's state is changed.
            this.events =
			 [
			    'checked', 'unchecked', 'indeterminate', 'change'
             ];
        },

        createInstance: function (args) {
            this.render();        
        },

        render: function()
        {
            this.setSize();
            var me = this;
            this.propertyChangeMap['width'] = function (instance, key, oldVal, value) {
                me.setSize();
            };

            this.propertyChangeMap['height'] = function (instance, key, oldVal, value) {
                me.setSize();
            };
            if (this.radiobutton) {
                this.radiobutton.remove();
            }

            this.radiobutton = $('<div><div><span></span></div></div>');
            this.host.attr('role', 'radio');
            if (!this.host.attr('tabIndex')) {
                this.host.attr('tabIndex', 0);
            }
            this.host.prepend(this.radiobutton);
            this.host.append($('<div style="clear: both;"></div>'));
            this.checkMark = $(this.radiobutton).find('span');
            this.box = $(this.radiobutton).find('div');

            this._supportsRC = true;
            if ($.jqx.browser.msie && $.jqx.browser.version < 9) {
                this._supportsRC = false;
            }

            this.box.addClass(this.toThemeProperty('jqx-fill-state-normal'));
            this.box.addClass(this.toThemeProperty('jqx-radiobutton-default'));
            this.host.addClass(this.toThemeProperty('jqx-widget'));

            if (this.disabled) {
                this.disable();
            }

            this.host.addClass(this.toThemeProperty('jqx-radiobutton'));

            if (this.locked) {
                this.host.css('cursor', 'auto');
            }

            var checked = this.element.getAttribute('checked');
            if (checked == 'checked' || checked == 'true' || checked == true) {
                this.checked = true;
            }

            this._addInput();
            this._render();
            this._addHandlers();
            $.jqx.aria(this);
        },

        _addInput: function () {
            var name = this.host.attr('name');
            if (!name) name = this.element.id;
            this.input = $("<input type='hidden'/>");
            this.host.append(this.input);
            this.input.attr('name', name);
        },

        refresh: function (initialRefresh) {
            if (!initialRefresh) {
                this.setSize();
                this._render();
            }
        },

        setSize: function () {
            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                this.host.width(this.width);
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    this.host.width(this.width);
                };

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                this.host.height(this.height);
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                this.host.height(this.height);
            };
        },

        _addHandlers: function () {
            var me = this;
            this.addHandler(this.box, 'click', function (event) {
                if (!me.disabled && !me.enableContainerClick) {
                    me.toggle();
                    event.preventDefault();
                    return false;
                }
            });

            this.addHandler(this.host, 'keydown', function (event) {
                if (!me.disabled && !me.locked) {
                    if (event.keyCode == 32) {
                        me.toggle();
                        event.preventDefault();
                        return false;
                    }
                }
            });

            this.addHandler(this.host, 'click', function (event) {
                if (!me.disabled && me.enableContainerClick) {
                    me.toggle();
                    event.preventDefault();
                    return false;
                }
            });

            this.addHandler(this.host, 'selectstart', function (event) {
                if (!me.disabled && me.enableContainerClick) {
                    event.preventDefault();
                }
            });

            this.addHandler(this.host, 'mouseup', function (event) {
                if (!me.disabled && me.enableContainerClick) {
                    event.preventDefault();
                }
            });

            this.addHandler(this.host, 'focus', function (event) {
                if (!me.disabled && me.enableContainerClick && !me.locked) {
                    me.box.addClass(me.toThemeProperty('jqx-radiobutton-hover'));
                    me.box.addClass(me.toThemeProperty('jqx-fill-state-focus'));
                    event.preventDefault();
                    return false;
                }
            });

            this.addHandler(this.host, 'blur', function (event) {
                if (!me.disabled && me.enableContainerClick && !me.locked) {
                    me.box.removeClass(me.toThemeProperty('jqx-radiobutton-hover'));
                    me.box.removeClass(me.toThemeProperty('jqx-fill-state-focus'));
                    event.preventDefault();
                    return false;
                }
            });

            this.addHandler(this.host, 'mouseenter', function (event) {
                if (!me.disabled && me.enableContainerClick && !me.locked) {
                    me.box.addClass(me.toThemeProperty('jqx-radiobutton-hover'));
                    me.box.addClass(me.toThemeProperty('jqx-fill-state-hover'));

                    event.preventDefault();
                    return false;
                }
            });

            this.addHandler(this.host, 'mouseleave', function (event) {
                if (!me.disabled && me.enableContainerClick && !me.locked) {
                    me.box.removeClass(me.toThemeProperty('jqx-radiobutton-hover'));
                    me.box.removeClass(me.toThemeProperty('jqx-fill-state-hover'));
                    event.preventDefault();
                    return false;
                }
            });

            this.addHandler(this.box, 'mouseenter', function () {
                if (!me.disabled && !me.enableContainerClick) {
                    me.box.addClass(me.toThemeProperty('jqx-radiobutton-hover'));
                    me.box.addClass(me.toThemeProperty('jqx-fill-state-hover'));
                }
            });

            this.addHandler(this.box, 'mouseleave', function () {
                if (!me.disabled && !me.enableContainerClick) {
                    me.box.removeClass(me.toThemeProperty('jqx-radiobutton-hover'));
                    me.box.removeClass(me.toThemeProperty('jqx-fill-state-hover'));
                }
            });
        },

        focus: function()
        {
            try
            {
                this.host.focus();
            }
            catch (error) {
            }
        },

        _removeHandlers: function () {
            this.removeHandler(this.box, 'click');
            this.removeHandler(this.box, 'mouseenter');
            this.removeHandler(this.box, 'mouseleave');
            this.removeHandler(this.host, 'click');
            this.removeHandler(this.host, 'mouseup');
            this.removeHandler(this.host, 'mousedown');
            this.removeHandler(this.host, 'selectstart');
            this.removeHandler(this.host, 'mouseenter');
            this.removeHandler(this.host, 'mouseleave');
            this.removeHandler(this.host, 'keydown');
            this.removeHandler(this.host, 'focus');
            this.removeHandler(this.host, 'blur');
        },

        _render: function () {
            if (this.boxSize == null) this.boxSize = 13;

            this.box.width(this.boxSize);
            this.box.height(this.boxSize);

            if (!this.disabled) {
                if (this.enableContainerClick) {
                    this.host.css('cursor', 'pointer');
                }
                else this.host.css('cursor', 'auto');
            }
            else {
                this.disable();
            }
            if (this.rtl) {
                this.box.addClass(this.toThemeProperty('jqx-radiobutton-rtl'));
                this.host.addClass(this.toThemeProperty('jqx-rtl'));
            }
            this.updateStates();
        },

        val: function (value) {
            if (arguments.length == 0 || typeof (value) == "object") {
                return this.checked;
            }

            if (typeof value == "string") {
                if (value == "true") this.check();
                if (value == "false") this.uncheck();
                if (value == "") this.indeterminate();
            }
            else {
                if (value == true) this.check();
                if (value == false) this.uncheck();
                if (value == null) this.indeterminate();
            }
            return this.checked;
        },

        // checks the ckeckbox.
        check: function () {
            this.checked = true;
            var me = this;
            this.checkMark.removeClass();

            this.checkMark.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
            if ($.jqx.browser.msie) {
                if (!this.disabled) {
                    this.checkMark.addClass(this.toThemeProperty('jqx-radiobutton-check-checked'));
                }
                else {
                    this.checkMark.addClass(this.toThemeProperty('jqx-radiobutton-check-disabled'));
                    this.checkMark.addClass(this.toThemeProperty('jqx-radiobutton-check-checked'));
                }
            }
            else {
                if (!this.disabled) {
                    this.checkMark.addClass(this.toThemeProperty('jqx-radiobutton-check-checked'));
                }
                else {
                    this.checkMark.addClass(this.toThemeProperty('jqx-radiobutton-check-disabled'));
                    this.checkMark.addClass(this.toThemeProperty('jqx-radiobutton-check-checked'));
                }

                this.checkMark.css('opacity', 0);
                this.checkMark.stop().animate({ opacity: 1 }, this.animationShowDelay, function () {
                });
            }

            var checkboxes = $.find('.jqx-radiobutton');

            if (this.groupName == null) this.groupName = '';
            $.each(checkboxes, function () {
                var groupName = $(this).jqxRadioButton('groupName');
                if (groupName == me.groupName && this != me.element) {
                    $(this).jqxRadioButton('uncheck')
                }
            });

            this._raiseEvent('0');
            this._raiseEvent('3', { checked: true });

            if (this.checkMark.height() == 0) {
                this.checkMark.height(this.boxSize);
                this.checkMark.width(this.boxSize);
            }
            else if (this.boxSize != '13px') {
                var size = parseInt(this.boxSize) / 2;
                this.checkMark.height(size);
                this.checkMark.width(size);
                this.checkMark.css('margin-left', 1+(size / 4));
                this.checkMark.css('margin-top', 1+(size / 4));
            }

            this.input.val(this.checked);
            $.jqx.aria(this, "aria-checked", this.checked);
        },

        // unchecks the radiobutton.
        uncheck: function () {
            var oldCheck = this.checked;
            this.checked = false;
            var me = this;

            if ($.jqx.browser.msie) {
                me.checkMark.removeClass();
            }
            else {
                this.checkMark.css('opacity', 1);
                this.checkMark.stop().animate({ opacity: 0 }, this.animationHideDelay, function () {
                    me.checkMark.removeClass();
                });
            }

            if (oldCheck) {
                this._raiseEvent('1');
                this._raiseEvent('3', { checked: false });
            }
            this.input.val(this.checked);
            $.jqx.aria(this, "aria-checked", this.checked);
        },

        // sets the indeterminate state.
        indeterminate: function () {
            var oldCheck = this.checked;
            this.checked = null;
            this.checkMark.removeClass();

            if ($.jqx.browser.msie) {
                this.checkMark.addClass(this.toThemeProperty('jqx-radiobutton-check-indeterminate'));
            }
            else {
                this.checkMark.addClass(this.toThemeProperty('jqx-radiobutton-check-indeterminate'));
                this.checkMark.css('opacity', 0);
                this.checkMark.stop().animate({ opacity: 1 }, this.animationShowDelay, function () {
                });
            }

            if (oldCheck != null) {
                this._raiseEvent('2');
                this._raiseEvent('3', { checked: null });
            }
            this.input.val(this.checked);
            $.jqx.aria(this, "aria-checked", "undefined");
        },

        // toggles the check state.
        toggle: function () {
            if (this.disabled)
                return;

            if (this.locked)
                return;

            var oldChecked = this.checked;

            if (this.checked == true) {
                this.checked = this.hasTreeStates ? null : true;
            }
            else {
                this.checked = true;
            }

            if (oldChecked != this.checked) {
                this.updateStates();
            }
            this.input.val(this.checked);
        },

        // updates check states depending on the value of the 'checked' property.
        updateStates: function () {
            if (this.checked) {
                this.check();
            }
            else if (this.checked == false) {
                this.uncheck();
            }
            else if (this.checked == null) {
                this.indeterminate();
            }
        },

        // disables the radiobutton.
        disable: function () {
            this.disabled = true;

            if (this.checked == true) {
                this.checkMark.addClass(this.toThemeProperty('jqx-radiobutton-check-disabled'));
            }
            else if (this.checked == null) {
                this.checkMark.addClass(this.toThemeProperty('jqx-radiobutton-check-indeterminate-disabled'));
            }
            this.box.addClass(this.toThemeProperty('jqx-radiobutton-disabled'));
            this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
            $.jqx.aria(this, "aria-disabled", this.disabled);
        },

        // enables the radiobutton.
        enable: function () {
            this.host.removeClass(this.toThemeProperty('jqx-fill-state-disabled'));
            if (this.checked == true) {
                this.checkMark.removeClass(this.toThemeProperty('jqx-radiobutton-check-disabled'));
            }
            else if (this.checked == null) {
                this.checkMark.removeClass(this.toThemeProperty('jqx-radiobutton-check-indeterminate-disabled'));
            }
            this.box.removeClass(this.toThemeProperty('jqx-radiobutton-disabled'));
         
            this.disabled = false;
            $.jqx.aria(this, "aria-disabled", this.disabled);
        },

        destroy: function () {
            this._removeHandlers();
            this.host.remove();
        },

        _raiseEvent: function (id, args) {
            var evt = this.events[id];
            var event = new jQuery.Event(evt);
            event.owner = this;
            event.args = args;

            try {
                var result = this.host.trigger(event);
            }
            catch (error) {
            }

            return result;
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (this.isInitialized == undefined || this.isInitialized == false)
                return;

            if (key == this.enableContainerClick && !this.disabled && !this.locked) {
                if (value) {
                    this.host.css('cursor', 'pointer');
                }
                else this.host.css('cursor', 'auto');
            }

            if (key == "rtl") {
                if (value) {
                    object.box.addClass(object.toThemeProperty('jqx-radiobutton-rtl'));
                    object.host.addClass(object.toThemeProperty('jqx-rtl'));
                }
                else {
                    object.box.removeClass(object.toThemeProperty('jqx-radiobutton-rtl'));
                    object.host.removeClass(object.toThemeProperty('jqx-rtl'));
                }
            }

            if (key == 'checked') {
                switch (value) {
                    case true:
                        this.check();
                        break;
                    case false:
                        this.uncheck();
                        break;
                    case null:
                        this.indeterminate();
                        break;
                }
            }

            if (key == 'theme') {
                $.jqx.utilities.setTheme(oldvalue, value, this.host);
            }

            if (key == 'disabled') {
                if (value) {
                    this.disable();
                } else this.enable();
            }
        }
    });
})(jQuery);

(function ($) {

    $.jqx.jqxWidget('jqxRating', '', {});

    $.extend($.jqx._jqxRating.prototype, {
        defineInstance: function () {
            // Type: Number
            // Default: 5
            // Sets or gets images count.
            this.count = 5;
            // Type: Bool
            // Default: false
            // Sets or gets whether the rating widget is disabled.
            this.disabled = false;
            // Type: Number
            // Default: 0
            // Gets or sets current rating.
            this.value = 0;
            // Type: Number or String
            // Default: auto
            // Gets or sets widget's height.
            this.height = 'auto';
            // Type: Number or String
            // Default: auto
            // Gets or sets widget's width.
            this.width = 'auto';
            // Type: Number
            // Default: 1
            // Gets or sets vote precision.
            this.precision = 1;
            // Type: Bool
            // Default: false
            // Gets or sets whether the user can vote single or multiple times.
            this.singleVote = false;
            // Type: Number or String
            // Default: auto
            // Gets or sets rating item's height
            this.itemHeight = '20';
            // Type: Number or String
            // Default: auto
            // Gets or sets rating item's width.
            this.itemWidth = '20';

            //Private varables
            this._itemHeight;
            this._itemWidth;
            this._images = [];
            this.aria =
            {
                "aria-valuenow": { name: "value", type: "number" },
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
            // the change event is triggered when the rating is changed.
            this._events = [
                'change'
            ];
            this._invalidArgumentExceptions = {
                'invalidPrecision': 'The value of the precision property is invalid!',
                'invalidWidth': 'Width you\'ve entered is invalid!',
                'invalidHeight': 'Height you\'ve entered is invalid!',
                'invalidCount': 'You\'ve entered invalid value for the count property!',
                'invalidValue': 'You\'ve entered invalid value property!'
            };
        },

        createInstance: function (args) {
            $.jqx.aria(this);
            this._createRating();
        },

        destroy: function()
        {
            this.host.remove();
        },

        val: function (value) {
            if (arguments.length == 0 || typeof (value) == "object") {
                return this.value;
            }

            if (typeof value == "string") {
                this.value = parseInt(value);
            }
            else {
                this.value = value;
            }
            this.setValue(this.value);
            return this.value;
        },

        _createRating: function () {
            this.host.css('display', 'none');
            this.host.empty();
            this._addInput();
            this._validateProperties();
            this._render();
            this._performLayout();
            this._removeEventHandlers();
            this._addEventHandlers();
            this.host.css('display', 'block');
        },

        _addInput: function () {
            var name = this.host.attr('name');
            if (!name) name = this.element.id;
            this.input = $("<input type='hidden'/>");
            this.host.append(this.input);
            this.input.attr('name', name);
            this.input.val(this.value.toString());
        },

        _render: function () {
            for (var i = 1; i <= this.count; i++) {
                this._images[i - 1] = $('<div style="float:left;width:auto;height:auto;">' +
                                            '<div style="position:absolute;width:auto;height:auto;visibility:hidden;" class="jqx-rating-hoverWrapper">' +
                                                '<div style="width:auto;height:auto;float:left;" class="' + this.toThemeProperty('jqx-rating-image-hover') + '"></div>' +
                                                '<div style="visibility:hidden;width:auto;height:auto;" class="' + this.toThemeProperty('jqx-rating-image-backward') + '"></div>' +
                                            '</div>' +
                                            '<div style="position:absolute;width:auto;height:auto;" class="jqx-rating-voteWrapper">' +
                                                '<div style="width:auto;height:auto;float:left;" class="' + this.toThemeProperty('jqx-rating-image-default') + '"></div>' +
                                                '<div style="width:0;height:auto;float:left;" class="' + this.toThemeProperty('jqx-rating-image-backward') + '"></div>' +
                                            '</div>' +
                                        '</div>');
                this.host.append(this._images[i - 1]);
            }
        },

        _performLayout: function () {
            for (var i = 1; i <= this.count; i++) {
                var backwardImageDiv = this._images[i - 1].find(this.toThemeProperty('.jqx-rating-image-backward', true)),
                    defaultImageDiv = this._images[i - 1].find(this.toThemeProperty('.jqx-rating-image-default', true)),
                    hoverImageDiv = this._images[i - 1].find(this.toThemeProperty('.jqx-rating-image-hover', true)),
                    defaultImageUrl = this._getImageName(defaultImageDiv), 
                    hoverImageUrl = this._getImageName(hoverImageDiv),
                    backwardImageUrl = this._getImageName(backwardImageDiv);
                defaultImageDiv.css('background-image', 'none');
                hoverImageDiv.css('background-image', 'none');
                backwardImageDiv.css('background-image', 'none');
                this._appendImage(hoverImageDiv, hoverImageUrl, i - 1);
                this._appendImage(backwardImageDiv, backwardImageUrl, i - 1);
                this._appendImage(defaultImageDiv, defaultImageUrl, i - 1);
            }
        },

        _setControlSize: function (width, height) {
            this.host.css('height', this.height);
            this.host.css('width', this.width);
            if (this.itemHeight && this.itemHeight !== 'auto') {
                this._itemHeight = parseInt(this.itemHeight);
            } else {
                this._itemHeight = height;
            }
            if (this.itemWidth && this.itemWidth !== 'auto') {
                this._itemWidth = parseInt(this.itemWidth);
            } else {
                this._itemWidth = width;
            }
        },

        _appendImage: function (container, imageUrl, imageId) {
            var self = this;
            var image = $('<img style="-moz-user-select:-moz-none;-khtml-user-select: ' +
                        'none;-webkit-user-select:none;user-select:none;" class="' + this.toThemeProperty('jqx-rating-image') + '" src="' + imageUrl + '" />');
            container.append(image);
            image.load(function () {
                if (!self._initialized) {
                    self._setControlSize($(this).width(), $(this).height());
                    self._setValue(self.value, '.jqx-rating-voteWrapper', '.jqx-rating-image-default', '.jqx-rating-image-backward');
                    self._initialized = true;
                }
                self._images[imageId].height(self._itemHeight);
                $(this).height(self._itemHeight);
                self._images[imageId].width(self._itemWidth);
                $(this).width(self._itemWidth);
            });
            return image;
        },

        _validateProperties: function () {
            try {
                if (this.precision < 0.001 || this.precision > 1) {
                    throw this._invalidArgumentExceptions['invalidPrecision'];
                }
                if (this.height !== 'auto' && parseInt(this.height) < 0) {
                    throw this._invalidArgumentExceptions['invalidHeight'];
                }
                if (this.width !== 'auto' && parseInt(this.width) < 0) {
                    throw this._invalidArgumentExceptions['invalidWidth'];
                }
                if (this.count <= 0) {
                    throw this._invalidArgumentExceptions['invalidCount'];
                }
                if (this.value > this.count || this.value < 0) {
                    throw this._invalidArgumentExceptions['invalidValue'];
                }
            } catch (exception) {
                alert(exception);
            }
        },

        _getImageIndex: function (image) {
            var index = 0;
            while (image !== this._images[index][0]) {
                index++;
            }
            return ++index;
        },

        _getRating: function (image, pageCoordinate) {
            var imageRate = this._getImageIndex(image);
            if (this.precision < 1) {
                var leftOffet = parseInt(pageCoordinate) - parseInt($(image).position().left),
                    sectorSize = this._itemWidth * this.precision, size = 0;
                while (size < leftOffet) {
                    size += sectorSize;
                }
                if (size > parseInt(this._itemWidth) - sectorSize) {
                    size = parseInt(this._itemWidth);
                }
                var percents = size / $(image).width();
                imageRate -= 1 - percents;
            }
            return imageRate;
        },

        _addEventHandlers: function () {
            var self = this;
            for (var i = 0; i < this.count; i++) {
                if (!$.jqx.mobile.isTouchDevice()) {
                    this.addHandler(this._images[i], 'mousemove', function (event) {
                        var imageRate = self._getRating(this, event.pageX);
                        self._setValue(imageRate, '.jqx-rating-hoverWrapper', '.jqx-rating-image-hover', '.jqx-rating-image-backward');
                    });
                    this.addHandler(this._images[i], 'mouseenter', function (event) {
                        var imageRate = self._getImageIndex(this);
                        for (var j = 0; j < imageRate; j++) {
                            self._images[j].children('.jqx-rating-hoverWrapper').css('z-index', '10');
                            self._images[j].children('.jqx-rating-voteWrapper').css('z-index', '1');
                            self._images[j].children('.jqx-rating-hoverWrapper').css('visibility', 'visible');
                        }
                    });
                    this.addHandler(this._images[i], 'mouseleave', function (event) {
                        var imageRate = self._getImageIndex(this);
                        for (var j = 0; j < imageRate; j++) {
                            self._images[j].children('.jqx-rating-voteWrapper').css('z-index', '10');
                            self._images[j].children('.jqx-rating-hoverWrapper').css('z-index', '1');
                            self._images[j].children('.jqx-rating-hoverWrapper').css('visibility', 'hidden');
                        }
                    });
                }
                this.addHandler(this._images[i], 'click', function (event) {
                    var imageRate = self._getRating(this, event.pageX);
                    self._raiseEvent(0, imageRate);
                    self._setValue(imageRate, '.jqx-rating-voteWrapper', '.jqx-rating-image-default', '.jqx-rating-image-backward');
                    if (self.singleVote) {
                        self.disable();
                    }
                    event.stopPropagation();
                });
                this.addHandler(this._images[i], 'dragstart', function (event) {
                    return false;
                });
            }
        },

        _removeEventHandlers: function () {
            for (var i = 0; i < this.count; i++) {
                this.removeHandler(this._images[i], 'mousemove');
                this.removeHandler(this._images[i], 'mouseenter');
                this.removeHandler(this._images[i], 'mouseleave');
                this.removeHandler(this._images[i], 'click');
                this.removeHandler(this._images[i], 'dragstart');
            }
        },

        _getImageName: function (image) {
            var imageUrl = image.css('background-image')
            imageUrl = imageUrl.replace('url("', '');
            imageUrl = imageUrl.replace('")', '');
            imageUrl = imageUrl.replace('url(', '');
            imageUrl = imageUrl.replace(')', '');
            return imageUrl;
        },

        _setValue: function (rating, parent, rated, nonRated) {
            for (var i = 1; i <= this.count; i++) {
                var percent = 1,
                    parentNode = this._images[i - 1].children(parent),
                    rateDiv = parentNode.children(rated),
                    nonRatedDiv = parentNode.children(nonRated);
                if (i > rating) {
                    if (Math.abs(i - rating) < 1) {
                        percent = 1 - Math.abs(i - rating);
                    } else {
                        percent = 0;
                    }
                }
                rateDiv.width(this._itemWidth * percent);
                nonRatedDiv.width(this._itemWidth - parseInt(rateDiv.width()));
                parentNode.children(this.toThemeProperty(nonRated)).children(0).css('margin-left', -this._itemWidth * percent + 'px');
            }
            $.jqx.aria(this, 'aria-valuenow', rating);
        },

        _raiseEvent: function (id, newValue) {
            var event = new $.Event(this._events[id]);
            event.owner = this;
            event.value = newValue;
            event.oldvalue = this.value;
            this.value = newValue;
            if (this.input) {
                this.input.val(this.value.toString());
            }
            return this.host.trigger(event);
        },

        //Setting value to the rating widget
        setValue: function (value) {
            this._setValue(value, '.jqx-rating-voteWrapper', '.jqx-rating-image-default', '.jqx-rating-image-backward');
            this.value = value;
        },

        //Getting current rating value
        getValue: function () {
            return this.value;
        },

        //Disabling the widget
        disable: function () {
            this._removeEventHandlers();
            this.disabled = true;
            $.jqx.aria(this, 'aria-disabled', true);
        },

        //Enabling the widget
        enable: function () {
            this._removeEventHandlers();
            this._addEventHandlers();
            this.disabled = false;
            $.jqx.aria(this, 'aria-disabled', false);
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            this._validateProperties();
            if (key === 'disabled') {
                if (value) {
                    this.disable();
                } else {
                    this.enable();
                }
                return;
            } else if (key === 'precision') {
                this.precision = value;
                return;
            } else {
                this._createRating();
            }
        }
    });
})(jQuery);
(function ($) {

    $.jqx.jqxWidget("jqxSlider", "", {});

    $.extend($.jqx._jqxSlider.prototype, {
        defineInstance: function () {
            // Type: Bool
            // Default: false
            // Sets or gets whether the slider is disabled.
            this.disabled = false;
            // Type: Number/String
            // Default: 300
            // Sets or gets slider's width.
            this.width = 300;
            // Type: Number/String
            // Default: 30
            // Sets or gets slider's height.
            this.height = 30;
            // Type: Number
            // Default: 2
            // Sets or gets slide step when the user is using the arrows or the mouse wheel for changing slider's value.
            this.step = 1;
            // Type: Number
            // Default: 10
            // Sets or gets slider's maximum value.
            this.max = 10;
            // Type: Number
            // Default: 0
            // Sets or gets slider's minimum value.
            this.min = 0;
            // Type: String
            // Default: horizontal
            // Sets or gets slider's orientation.
            this.orientation = 'horizontal';
            // Type: Bool
            // Default: true
            // Sets or gets whether ticks will be shown.
            this.showTicks = true;
            // Type: Number
            // Default: both
            // Sets or gets slider's ticks position. Possible values - 'top', 'bottom', 'both'.
            this.ticksPosition = 'both';
            // Type: Number
            // Default: 2
            // Sets or gets slider's ticks frequency.
            this.ticksFrequency = 2;
            // Type: Bool
            // Default: true
            // Sets or gets whether the scroll buttons will be shown.
            this.showButtons = true;
            // Type: String
            // Default: both
            // Sets or gets scroll buttons position. Possible values 'both', 'left', 'right'.
            this.buttonsPosition = 'both';
            // Type: String
            // Default: default
            // Sets or gets slider's mode. If the mode is default then the user can use floating values.
            this.mode = 'default';
            // Type: Bool
            // Default: true
            // Sets or gets whether the slide range is going to be shown.
            this.showRange = true;
            // Type: Bool
            // Default: false
            // Sets or gets whether the slider is a range slider.
            this.rangeSlider = false;
            // Type: Number
            // Default: 0
            // Sets or gets slider's value. This poperty will be an object with the following structure { rangeStart: range_start, rangeEnd: range_end } if the
            // slider is range slider otherwise it's going to be a number.
            this.value = 0;
            // Type: Array
            // Default: [0, 10]
            // Sets or gets range slider's values.
            this.values = [0, 10];
            // Type: Bool
            // Default: true
            // Sets or gets whether the slider title will be shown.
            this.tooltip = true;
            // Type: Number/String
            // Default: 11
            // Sets or gets whether the slider buttons size.
            this.sliderButtonSize = 14;
            // Type: Number/String
            // Default: 5
            // Sets or gets the tick size.
            this.tickSize = 7;
            // mirror
            this.layout = "normal";
            this.rtl = false;
            // Private properties
            this._settings = {
                'vertical': {
                    'size': 'height',
                    'oSize': 'width',
                    'outerOSize': 'outerWidth',
                    'outerSize': 'outerHeight',
                    'left': 'top',
                    'top': 'left',
                    'start': '_startY',
                    'mouse': '_mouseStartY',
                    'page': 'pageY',
                    'opposite': 'horizontal'
                },
                'horizontal': {
                    'size': 'width',
                    'oSize': 'height',
                    'outerOSize': 'outerHeight',
                    'outerSize': 'outerWidth',
                    'left': 'left',
                    'top': 'top',
                    'start': '_startX',
                    'mouse': '_mouseStartX',
                    'page': 'pageX',
                    'opposite': 'vertical'
                }
            };
            this._touchEvents = {
                'mousedown': $.jqx.mobile.getTouchEventName('touchstart'),
                'click': $.jqx.mobile.getTouchEventName('touchstart'),
                'mouseup': $.jqx.mobile.getTouchEventName('touchend'),
                'mousemove': $.jqx.mobile.getTouchEventName('touchmove'),
                'mouseenter': 'mouseenter',
                'mouseleave': 'mouseleave'
            };
            this._events = ['change', 'slide', 'slideEnd', 'slideStart', 'created'];
            this._invalidArgumentExceptions = {
                'invalidWidth': 'Invalid width.',
                'invalidHeight': 'Invalid height.',
                'invalidStep': 'Invalid step.',
                'invalidMaxValue': 'Invalid maximum value.',
                'invalidMinValue': 'Invalid minimum value.',
                'invalidTickFrequency': 'Invalid tick frequency.',
                'invalidValue': 'Invalid value.',
                'invalidValues': 'Invalid values.',
                'invalidTicksPosition': 'Invalid ticksPosition',
                'invalidButtonsPosition': 'Invalid buttonsPosition'
            };
            //Containing the last value. This varialbe is used in the _raiseEvent method and it's our criteria for checking
            //whether we need to trigger event.
            this._lastValue = [];
            this._track = null;
            this._leftButton = null;
            this._rightButton = null;
            this._slider = null;
            this._rangeBar = null;
            this._slideEvent = null;
            this._capturedElement = null;
            this._slideStarted = false;
            this.aria =
            {
                "aria-valuenow": { name: "value", type: "number" },
                "aria-valuemin": { name: "min", type: "number" },
                "aria-valuemax": { name: "max", type: "number" },
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
        },

        createInstance: function (args) {
            this.render();
        },

        render: function () {
            this.element.innerHTML = "";
            this.host.attr('role', 'slider');
            this.host.addClass(this.toThemeProperty('jqx-slider'));
            this.host.addClass(this.toThemeProperty('jqx-widget'));

            $.jqx.aria(this);
            this._isTouchDevice = $.jqx.mobile.isTouchDevice();
            this.host.width(this.width);
            this.host.height(this.height);
            this._refresh();
            this._raiseEvent(4, { value: this.getValue() });
            this._addInput();
            var me = this;
            var autoTabIndex = me.host.attr("tabindex") == null;
            if (autoTabIndex) {
                me.host.attr("tabindex", 0);
            }
            $.jqx.utilities.resize(this.host, function () {
                me.host.width(me.width);
                me.host.height(me.height);
                me._performLayout();
                me._initialSettings();
            });
        },

        focus: function () {
            try {
                this.host.focus();
            }
            catch (error) {
            }
        },

        destroy: function () {
            this.host.remove();
        },

        _addInput: function () {
            var name = this.host.attr('name');
            if (!name) name = this.element.id;
            this.input = $("<input type='hidden'/>");
            this.host.append(this.input);
            this.input.attr('name', name);
            if (!this.rangeSlider) {
                this.input.val(this.value.toString());
            }
            else {
                if (this.values) {
                    this.input.val(this.value.rangeStart.toString() + "-" + this.value.rangeEnd.toString());
                }
            }
        },

        _getSetting: function (setting) {
            return this._settings[this.orientation][setting];
        },

        _getEvent: function (event) {
            if (this._isTouchDevice) {
                return this._touchEvents[event];
            } else {
                return event;
            }
        },

        refresh: function (initialRefresh) {
            if (!initialRefresh) {
                this._refresh();
            }
        },

        _refresh: function () {
            this._render();
            this._performLayout();
            this._removeEventHandlers();
            this._addEventHandlers();
            this._initialSettings();
        },

        _render: function () {
            this._addTrack();
            this._addSliders();
            this._addTickContainers();
            this._addContentWrapper();
            this._addButtons();
            this._addRangeBar();
        },

        _addTrack: function () {
            if (this._track === null || this._track.length < 1) {
                this._track = $('<div class="' + this.toThemeProperty('jqx-slider-track') + '"></div>');
                this.host.append(this._track);
            }
            this._track.attr('style', '');
            this._track.removeClass(this.toThemeProperty('jqx-slider-track-' + this._getSetting('opposite')));
            this._track.addClass(this.toThemeProperty('jqx-slider-track-' + this.orientation));
            this._track.addClass(this.toThemeProperty('jqx-fill-state-normal'));
            this._track.addClass(this.toThemeProperty('jqx-rc-all'));
        },

        _addSliders: function () {
            if (this._slider === null || this._slider.length < 1) {
                this._slider = {};
                this._slider.left = $('<div class="' + this.toThemeProperty('jqx-slider-slider') + '"></div>');
                this._track.append(this._slider.left);
                this._slider.right = $('<div class="' + this.toThemeProperty('jqx-slider-slider') + '"></div>');
                this._track.append(this._slider.right);
            }
            this._slider.left.removeClass(this.toThemeProperty('jqx-slider-slider-' + this._getSetting('opposite')));
            this._slider.left.addClass(this.toThemeProperty('jqx-slider-slider-' + this.orientation));
            this._slider.right.removeClass(this.toThemeProperty('jqx-slider-slider-' + this._getSetting('opposite')));
            this._slider.right.addClass(this.toThemeProperty('jqx-slider-slider-' + this.orientation));
            this._slider.right.addClass(this.toThemeProperty('jqx-fill-state-normal'));
            this._slider.left.addClass(this.toThemeProperty('jqx-fill-state-normal'));
        },

        _addTickContainers: function () {
            if (this._bottomTicks !== null || this._bottomTicks.length < 1 ||
                this._topTicks !== null || this._topTicks.length < 1) {
                this._addTickContainers();
            }
            var type = 'visible';
            if (!this.showTicks) {
                type = 'hidden';
            }
            this._bottomTicks.css('visibility', type);
            this._topTicks.css('visibility', type);
        },

        _addTickContainers: function () {
            if (typeof this._bottomTicks === 'undefined' || this._bottomTicks.length < 1) {
                this._bottomTicks = $('<div class="' + this.toThemeProperty('jqx-slider-tickscontainer') + '" style=""></div>');
                this.host.prepend(this._bottomTicks);
            }
            if (typeof this._topTicks === 'undefined' || this._topTicks.length < 1) {
                this._topTicks = $('<div class="' + this.toThemeProperty('jqx-slider-tickscontainer') + '" style=""></div>');
                this.host.append(this._topTicks);
            }
        },

        _addButtons: function () {
            if (this._leftButton === null || this._leftButton.length < 1 ||
                this._rightButton === null || this._rightButton.length < 1) {
                this._createButtons();
            }
            var type = 'block';
            if (!this.showButtons || this.rangeSlider) {
                type = 'none';
            }
            this._rightButton.css('display', type);
            this._leftButton.css('display', type);
        },

        _createButtons: function () {
            this._leftButton = $('<div class="jqx-slider-left"><div style="width: 100%; height: 100%;"></div></div>');
            this._rightButton = $('<div class="jqx-slider-right"><div style="width: 100%; height: 100%;"></div></div>');
            this.host.prepend(this._rightButton);
            this.host.prepend(this._leftButton);
            if (!this.host.jqxRepeatButton) {
                throw new Error("jqxSlider: Missing reference to jqxbuttons.js.");
            }
            this._leftButton.jqxRepeatButton({ theme: this.theme, delay: 50, width: this.sliderButtonSize, height: this.sliderButtonSize });
            this._rightButton.jqxRepeatButton({ theme: this.theme, delay: 50, width: this.sliderButtonSize, height: this.sliderButtonSize });
        },

        _addContentWrapper: function () {
            if (this._contentWrapper === undefined || this._contentWrapper.length === 0) {
                this.host.wrapInner('<div></div>');
                this._contentWrapper = this.host.children(0);
            }
            if (this.orientation === 'horizontal') {
                this._contentWrapper.css('float', 'left');
            } else {
                this._contentWrapper.css('float', 'none');
            }
        },

        _addTicks: function (container) {
            if (!this.showTicks)
                return;

            var count = this.max - this.min,
                width = container[this._getSetting('size')](),
                tickscount = Math.round(count / this.ticksFrequency),
                distance = width / tickscount;
            container.empty();
            var ticks = "";
            var size = container[this._getSetting('oSize')]();
            ticks += this._addTick(container, 0, this.min, size);
            for (var i = 1; i < tickscount; i++) {
                var number = i * distance;
                number = Math.floor(number);
                ticks += this._addTick(container, number, i, size);
            }
            ticks += this._addTick(container, tickscount * distance, this.max, size);
            container.append($(ticks));
        },

        _addTick: function (container, position, value, size) {
            var cssClass = "";
            cssClass = this.toThemeProperty('jqx-slider-tick');
            cssClass += " " + this.toThemeProperty('jqx-fill-state-pressed');
            var currentTick;
            var top = this._getSetting('top');
            var topValue = '2px';

            if (container[0] !== this._topTicks[0]) {
                topValue = size - this.tickSize - 2 + 'px';
            }

            if (this.orientation === 'horizontal') {
                currentTick = '<div style="' + top + ': ' + topValue + '; ' + this._getSetting('oSize') + ':  ' + this.tickSize + 'px; float: left; position:absolute; left:' + position +
                                'px;" class="' + this.toThemeProperty('jqx-slider-tick-horizontal') + ' ' + cssClass + '"></div>';
            } else {
                currentTick = '<div style="' + top + ': ' + topValue + '; ' + this._getSetting('oSize') + ':  ' + this.tickSize + 'px; float: none; position:absolute; top:' + position +
                                'px;" class="' + this.toThemeProperty('jqx-slider-tick-vertical') + ' ' + cssClass + '"></div>';
            }
            return currentTick;
        },

        _addRangeBar: function () {
            if (this._rangeBar === null || this._rangeBar.length < 1) {
                this._rangeBar = $('<div class="' + this.toThemeProperty('jqx-slider-rangebar') + '"></div>');
                this._rangeBar.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
                this._rangeBar.addClass(this.toThemeProperty('jqx-rc-all'));
                this._track.append(this._rangeBar);
            }
            if (!this.showRange) {
                this._rangeBar.css('display', 'none');
            } else {
                this._rangeBar.css('display', 'block');
            }
        },

        _getLeftDisplacement: function () {
            if (!this.showButtons) {
                return 0;
            }
            if (this.rangeSlider) {
                return 0;
            }
            switch (this.buttonsPosition) {
                case 'left':
                    return this._leftButton[this._getSetting('outerSize')](true) + this._rightButton[this._getSetting('outerSize')](true);
                case 'right':
                    return 0;
                default:
                    return this._leftButton[this._getSetting('outerSize')](true);
            }
            return 0;
        },

        _performLayout: function () {
            this.host.width(this.width);
            this.host.height(this.height);
            var size = this.host.height();
            if (this._getSetting('size') == 'width') {
                size = this.host.width();
            }

            this._performButtonsLayout();
            this._performTrackLayout(size-1);
            this._contentWrapper[this._getSetting('size')](this._track[this._getSetting('size')]());
            this._contentWrapper[this._getSetting('oSize')](this[this._getSetting('oSize')]);
            this._performTicksLayout();
            this._performRangeBarLayout();
            if (this.rangeSlider) {
                this._slider.left.css('visibility', 'visible');
            } else {
                this._slider.left.css('visibility', 'hidden');
            }
            this._refreshRangeBar();
            if (this.orientation == 'vertical') {
                if (this.showButtons) {
                    //   var leftMargin = parseInt(this._leftButton.css('margin-left'));
                    var centerLeft = parseInt((this._leftButton.width() - this._track.width()) / 2);

                    this._track.css('margin-left', -2 + centerLeft + 'px');
                }
            }
        },

        _performTrackLayout: function (size) {
            this._track[this._getSetting('size')](size - ((this.showButtons && !this.rangeSlider) ?
                        this._leftButton[this._getSetting('outerSize')](true) + this._rightButton[this._getSetting('outerSize')](true) : 0));
            this._slider.left.css('left', 0);
            this._slider.left.css('top', 0);
            this._slider.right.css('left', 0);
            this._slider.right.css('top', 0);
        },

        _performTicksLayout: function () {
            this._performTicksContainerLayout();
            this._addTicks(this._topTicks);
            this._addTicks(this._bottomTicks);
            this._topTicks.css('visibility', 'hidden');
            this._bottomTicks.css('visibility', 'hidden');
            if ((this.ticksPosition === 'top' || this.ticksPosition === 'both') && this.showTicks) {
                this._bottomTicks.css('visibility', 'visible');
            }
            if ((this.ticksPosition === 'bottom' || this.ticksPosition === 'both') && this.showTicks) {
                this._topTicks.css('visibility', 'visible');
            }
        },

        _performTicksContainerLayout: function () {
            var sizeDimension = this._getSetting('size');
            var oSizeDimension = this._getSetting('oSize');
            var outerSizeDimension = this._getSetting('outerOSize');

            this._topTicks[sizeDimension](this._track[sizeDimension]());
            this._bottomTicks[sizeDimension](this._track[sizeDimension]());
            var topTicksSize = -2 + (this[oSizeDimension] - this._track[outerSizeDimension](true)) / 2;
            this._topTicks[oSizeDimension](parseInt(topTicksSize));
            var bottomTicksSize = -2 + (this[oSizeDimension] - this._track[outerSizeDimension](true)) / 2;
            this._bottomTicks[oSizeDimension](parseInt(bottomTicksSize));

            if (this.orientation === 'vertical') {
                this._topTicks.css('float', 'left');
                this._track.css('float', 'left');
                this._bottomTicks.css('float', 'left');
            } else {
                this._topTicks.css('float', 'none');
                this._track.css('float', 'none');
                this._bottomTicks.css('float', 'none');
            }
        },

        _performButtonsLayout: function () {
            this._addButtonsStyles();
            this._addButtonsClasses();
            this._addButtonsHover();
            this._orderButtons();
            this._centerElement(this._rightButton);
            this._centerElement(this._leftButton);
            this._layoutButtons();
        },

        _addButtonsStyles: function () {
            this._leftButton.css('background-position', 'center');
            this._rightButton.css('background-position', 'center');
            if (this.orientation === 'vertical') {
                this._leftButton.css('float', 'none');
                this._rightButton.css('float', 'none');
            } else {
                this._leftButton.css('float', 'left');
                this._rightButton.css('float', 'left');
            }
        },

        _addButtonsClasses: function () {
            var icons = { prev: 'left', next: 'right' };
            if (this.orientation === 'vertical') {
                icons = { prev: 'up', next: 'down' };
            }
            this._leftButton.addClass(this.toThemeProperty('jqx-rc-all'));
            this._rightButton.addClass(this.toThemeProperty('jqx-rc-all'));
            this._leftButton.addClass(this.toThemeProperty('jqx-slider-button'));
            this._rightButton.addClass(this.toThemeProperty('jqx-slider-button'));
            this._leftArrow = this._leftButton.find('div');
            this._rightArrow = this._rightButton.find('div');
            this._leftArrow.removeClass(this.toThemeProperty('jqx-icon-arrow-left'));
            this._rightArrow.removeClass(this.toThemeProperty('jqx-icon-arrow-right'));
            this._leftArrow.removeClass(this.toThemeProperty('jqx-icon-arrow-up'));
            this._rightArrow.removeClass(this.toThemeProperty('jqx-icon-arrow-down'));
            this._leftArrow.addClass(this.toThemeProperty('jqx-icon-arrow-' + icons.prev));
            this._rightArrow.addClass(this.toThemeProperty('jqx-icon-arrow-' + icons.next));
        },

        _addButtonsHover: function () {
            var me = this, icons = { prev: 'left', next: 'right' };
            if (this.orientation === 'vertical') {
                icons = { prev: 'up', next: 'down' };
            }

            this.addHandler($(document), 'mouseup.arrow' + this.element.id, function () {
                me._leftArrow.removeClass(me.toThemeProperty('jqx-icon-arrow-' + icons.prev + '-selected'));
                me._rightArrow.removeClass(me.toThemeProperty('jqx-icon-arrow-' + icons.next + '-selected'));
            });

            this.addHandler(this._leftButton, 'mousedown', function () {
                if (!me.disabled)
                    me._leftArrow.addClass(me.toThemeProperty('jqx-icon-arrow-' + icons.prev + '-selected'));
            });
            this.addHandler(this._leftButton, 'mouseup', function () {
                if (!me.disabled)
                    me._leftArrow.removeClass(me.toThemeProperty('jqx-icon-arrow-' + icons.prev + '-selected'));
            });
            this.addHandler(this._rightButton, 'mousedown', function () {
                if (!me.disabled)
                    me._rightArrow.addClass(me.toThemeProperty('jqx-icon-arrow-' + icons.next + '-selected'));
            });
            this.addHandler(this._rightButton, 'mouseup', function () {
                if (!me.disabled)
                    me._rightArrow.removeClass(me.toThemeProperty('jqx-icon-arrow-' + icons.next + '-selected'));
            });

            this._leftButton.hover(function () {
                if (!me.disabled)
                    me._leftArrow.addClass(me.toThemeProperty('jqx-icon-arrow-' + icons.prev + '-hover'));
            }, function () {
                if (!me.disabled)
                    me._leftArrow.removeClass(me.toThemeProperty('jqx-icon-arrow-' + icons.prev + '-hover'));
            });
            this._rightButton.hover(function () {
                if (!me.disabled)
                    me._rightArrow.addClass(me.toThemeProperty('jqx-icon-arrow-' + icons.next + '-hover'));
            }, function () {
                if (!me.disabled)
                    me._rightArrow.removeClass(me.toThemeProperty('jqx-icon-arrow-' + icons.next + '-hover'));
            });
        },

        _layoutButtons: function () {
            if (this.orientation === 'horizontal') {
                this._horizontalButtonsLayout();
            } else {
                this._verticalButtonsLayout();
            }
        },

        _horizontalButtonsLayout: function () {
            var offset = (2 + Math.ceil(this.sliderButtonSize / 2));
            if (this.buttonsPosition == 'left') {
                this._leftButton.css('margin-right', '0px');
                this._rightButton.css('margin-right', offset);
            } else if (this.buttonsPosition == 'right') {
                this._leftButton.css('margin-left', 2 + offset);
                this._rightButton.css('margin-right', '0px');
            } else {
                this._leftButton.css('margin-right', offset);
                this._rightButton.css('margin-left', 2 + offset);
            }
        },

        _verticalButtonsLayout: function () {
            var offset = (2 + Math.ceil(this.sliderButtonSize / 2));
            if (this.buttonsPosition == 'left') {
                this._leftButton.css('margin-bottom', '0px');
                this._rightButton.css('margin-bottom', offset);
            } else if (this.buttonsPosition == 'right') {
                this._leftButton.css('margin-top', 2 + offset);
                this._rightButton.css('margin-bottom', '0px');
            } else {
                this._leftButton.css('margin-bottom', offset);
                this._rightButton.css('margin-top', 2 + offset);
            }
            var leftMargin = this._leftButton.css('margin-left');
            this._leftButton.css('margin-left', parseInt(leftMargin) - 1);
            this._rightButton.css('margin-left', parseInt(leftMargin) - 1);
        },

        _orderButtons: function () {
            this._rightButton.detach();
            this._leftButton.detach();
            switch (this.buttonsPosition) {
                case 'left':
                    this.host.prepend(this._rightButton);
                    this.host.prepend(this._leftButton);
                    break;
                case 'right':
                    this.host.append(this._leftButton);
                    this.host.append(this._rightButton);
                    break;
                case 'both':
                    this.host.prepend(this._leftButton);
                    this.host.append(this._rightButton);
                    break;
            }
        },

        _performRangeBarLayout: function () {
            this._rangeBar[this._getSetting('oSize')](this._track[this._getSetting('oSize')]());
            this._rangeBar[this._getSetting('size')](this._track[this._getSetting('size')]());
            this._rangeBar.css('position', 'absolute');
            this._rangeBar.css('left', 0);
            this._rangeBar.css('top', 0);
        },

        _centerElement: function (element) {
            var displacement = ($(element.parent())[this._getSetting('oSize')]() - element[this._getSetting('outerOSize')]()) / 2;
            element.css('margin-' + [this._getSetting('left')], 0);
            element.css('margin-' + [this._getSetting('top')], displacement);
            return element;
        },

        _raiseEvent: function (id, arg) {
            var evt = this._events[id];
            var event = new jQuery.Event(evt);

            event.args = arg;
            if (id === 1) {
                event.args.cancel = false;
                this._slideEvent = event;
            }
            this._lastValue[id] = arg.value;
            event.owner = this;
            var result = this.host.trigger(event);
            return result;
        },

        //Initializing the slider - setting it's values, disabling it if
        //disabled is true and setting tab-indexes for the keyboard navigation
        _initialSettings: function () {
            if (this.rangeSlider) {
                if (typeof this.value !== 'number') {
                    this.setValue(this.value);
                } else {
                    this.setValue(this.values);
                }
            } else {
                if (this.value == undefined) this.value = 0;
                this.setValue(this.value);
            }
            if (this.disabled) {
                this.disable();
            }
        },

        _addEventHandlers: function () {
            var self = this;
            this.addHandler(this._slider.right, this._getEvent('mousedown'), this._startDrag, { self: this });
            this.addHandler(this._slider.left, this._getEvent('mousedown'), this._startDrag, { self: this });
            this.addHandler($(document), this._getEvent('mouseup') + '.' + this.element.id, function () {
                self._stopDrag();
            });

            try
            {
                if (document.referrer != "" || window.frameElement) {
                    if (window.top != null && window.top != window.self) {
                        var eventHandle = function (event) {
                            self._stopDrag();
                        };
                        var parentLocation = null;
                        if (window.parent && document.referrer) {
                            parentLocation = document.referrer;
                        }

                        if (parentLocation && parentLocation.indexOf(document.location.host) != -1) {
                            if (window.top.document) {
                                if (window.top.document.addEventListener) {
                                    window.top.document.addEventListener('mouseup', eventHandle, false);

                                } else if (window.top.document.attachEvent) {
                                    window.top.document.attachEvent("on" + 'mouseup', eventHandle);
                                }
                            }
                        }
                    }
                }
            }
            catch (error) {
            }

            this.addHandler($(document), this._getEvent('mousemove') + '.' + this.element.id, this._performDrag, { self: this });
            var me = this;
            this.addHandler(this._slider.left, 'mouseenter', function () {
                if (!me.disabled)
                    self._slider.left.addClass(self.toThemeProperty('jqx-fill-state-hover'));
            });

            this.addHandler(this._slider.right, 'mouseenter', function () {
                if (!me.disabled)
                    self._slider.right.addClass(self.toThemeProperty('jqx-fill-state-hover'));
            });

            this.addHandler(this._slider.left, 'mouseleave', function () {
                if (!me.disabled)
                    self._slider.left.removeClass(self.toThemeProperty('jqx-fill-state-hover'));
            });

            this.addHandler(this._slider.right, 'mouseleave', function () {
                if (!me.disabled)
                    self._slider.right.removeClass(self.toThemeProperty('jqx-fill-state-hover'));
            });

            this.addHandler(this._slider.left, 'mousedown', function () {
                if (!me.disabled)
                    self._slider.left.addClass(self.toThemeProperty('jqx-fill-state-pressed'));
            });

            this.addHandler(this._slider.right, 'mousedown', function () {
                if (!me.disabled)
                    self._slider.right.addClass(self.toThemeProperty('jqx-fill-state-pressed'));
            });

            this.addHandler(this._slider.left, 'mouseup', function () {
                if (!me.disabled)
                    self._slider.left.removeClass(self.toThemeProperty('jqx-fill-state-pressed'));
            });

            this.addHandler(this._slider.right, 'mouseup', function () {
                if (!me.disabled)
                    self._slider.right.removeClass(self.toThemeProperty('jqx-fill-state-pressed'));
            });

            this.addHandler(this._leftButton, this._getEvent('click'), this._leftButtonHandler, { self: this });
            this.addHandler(this._rightButton, this._getEvent('click'), this._rightButtonHandler, { self: this });
            this.addHandler(this._track, this._getEvent('mousedown'), this._trackMouseDownHandler, { self: this });
            this.addHandler(this.host, 'focus', function () {
                self._track.addClass(self.toThemeProperty('jqx-fill-state-focus'));
                self._leftButton.addClass(self.toThemeProperty('jqx-fill-state-focus'));
                self._rightButton.addClass(self.toThemeProperty('jqx-fill-state-focus'));
                self._slider.right.addClass(self.toThemeProperty('jqx-fill-state-focus'));
                self._slider.left.addClass(self.toThemeProperty('jqx-fill-state-focus'));
            });
            this.addHandler(this.host, 'blur', function () {
                self._leftButton.removeClass(self.toThemeProperty('jqx-fill-state-focus'));
                self._rightButton.removeClass(self.toThemeProperty('jqx-fill-state-focus'));
                self._track.removeClass(self.toThemeProperty('jqx-fill-state-focus'));
                self._slider.right.removeClass(self.toThemeProperty('jqx-fill-state-focus'));
                self._slider.left.removeClass(self.toThemeProperty('jqx-fill-state-focus'));
            });

            this.element.onselectstart = function () { return false; }
            this._addMouseWheelListeners();
            this._addKeyboardListeners();
        },

        _addMouseWheelListeners: function () {
            var self = this;
            this.addHandler(this.host, 'mousewheel', function (event) {
                var scroll = event.wheelDelta;
                if (event.originalEvent && event.originalEvent.wheelDelta) {
                    event.wheelDelta = event.originalEvent.wheelDelta;
                }

                if (!('wheelDelta' in event)) {
                    scroll = event.detail * -40;
                }
                if (scroll > 0) {
                    self.incrementValue();
                } else {
                    self.decrementValue();
                }
                event.preventDefault();
            });
        },

        _addKeyboardListeners: function () {
            var self = this;
            this.addHandler(this.host, 'keydown', function (event) {
                switch (event.keyCode) {
                    case 40:
                    case 37:    //left arrow
                        if (self.layout == 'normal' && !self.rtl) {
                            self.decrementValue();
                        }
                        else self.incrementValue();

                        return false;
                    case 38:
                    case 39:    //right arrow
                        if (self.layout == 'normal' && !self.rtl) {
                            self.incrementValue();
                        }
                        else self.decrementValue();
                        return false;
                    case 36:    //home
                        if (self.rangeSlider) {
                            self.setValue([self.values[0], self.max]);
                        } else {
                            self.setValue(self.min);
                        }
                        return false;
                    case 35:    //end
                        if (self.rangeSlider) {
                            self.setValue([self.min, self.values[1]]);
                        } else {
                            self.setValue(self.max);
                        }
                        return false;
                }
            });
        },

        _trackMouseDownHandler: function (event) {
            var touches = $.jqx.mobile.getTouches(event);
            var touch = touches[0];
            var self = event.data.self,
                event = (self._isTouchDevice) ? touch : event,
                position = self._track.coord()[self._getSetting('left')],
                pagePos = event[self._getSetting('page')] - self._slider.left[self._getSetting('size')]() / 2,
                slider = self._getClosest(pagePos),
                size = parseInt(self._track[self._getSetting('size')]());
            var value = self._getValueByPosition(pagePos);
            self._setValue(value, slider);
            if (self.input) {
                $.jqx.aria(self, 'aria-valuenow', self.input.val());
            }
        },

        _getClosest: function (position) {
            if (!this.rangeSlider) {
                return this._slider.right;
            } else {
                position = position - this._track.coord()[this._getSetting('left')] - this._slider.left[this._getSetting('size')]() / 2;
                if (Math.abs(parseInt(this._slider.left.css(this._getSetting('left')), 10) - position) <
                Math.abs(parseInt(this._slider.right.css(this._getSetting('left')), 10) - position)) {
                    return this._slider.left;
                } else {
                    return this._slider.right;
                }
            }
        },

        _removeEventHandlers: function () {
            this.removeHandler(this._slider.right, this._getEvent('mousedown'), this._startDrag);
            this.removeHandler(this._slider.left, this._getEvent('mousedown'), this._startDrag);
            this.removeHandler($(document), this._getEvent('mouseup') + '.' + this.host.attr('id'), this._stopDrag);
            this.removeHandler($(document), this._getEvent('mousemove') + '.' + this.host.attr('id'), this._performDrag);
            this.removeHandler(this._leftButton, this._getEvent('click'), this._leftButtonHandler);
            this.removeHandler(this._rightButton, this._getEvent('click'), this._rightButtonHandler);
            this.removeHandler(this._track, this._getEvent('mousedown'), this._trackMouseDownHandler);
            this.element.onselectstart = null;
            this.removeHandler(this.host, this._getEvent('mousewheel'));
            this.removeHandler(this.host, this._getEvent('keydown'));
        },

        _rightButtonClick: function () {
            if (this.orientation == 'horizontal' && !this.rtl) {
                this.incrementValue();
            }
            else {
                this.decrementValue();
            }
        },

        _leftButtonClick: function () {
            if (this.orientation == 'horizontal' && !this.rtl) {
                this.decrementValue();
            }
            else this.incrementValue();
        },

        _rightButtonHandler: function (event) {
            var self = event.data.self;
            if (self.layout == 'normal') {
                self._rightButtonClick();
            } else self._leftButtonClick();
            return false;
        },

        _leftButtonHandler: function (event) {
            var self = event.data.self;
            if (self.layout == 'normal') {
                self._leftButtonClick();
            }
            else self._rightButtonClick();
            return false;
        },

        _startDrag: function (event) {
            var touches = $.jqx.mobile.getTouches(event);
            var touch = touches[0];

            var self = event.data.self;
            self._capturedElement = $(event.target);
            self._startX = $(event.target).coord().left;
            self._startY = $(event.target).coord().top;

            var position = $.jqx.position(event);
            self._mouseStartX = position.left;
            self._mouseStartY = position.top;
            self.focus();
            return false;
        },

        _stopDrag: function () {
            var self = this;
            if (self._slideStarted) {   //if the slideStart event have been triggered and the user is dropping the thumb we are firing a slideStop event
                self._raiseEvent(2, { value: self.getValue() });
            }
            if (!self._slideStarted || self._capturedElement == null) {
                self._capturedElement = null;
                return;
            }

            if (this.input) {
                $.jqx.aria(this, 'aria-valuenow', this.input.val()); 
            }
            self._slider.left.removeClass(self.toThemeProperty('jqx-fill-state-pressed'));
            self._slider.right.removeClass(self.toThemeProperty('jqx-fill-state-pressed'));

            self._slideStarted = false;
            self._capturedElement = null;
        },

        _performDrag: function (event) {
            var self = event.data.self;
            if (self._capturedElement !== null) {
                var touches = $.jqx.mobile.getTouches(event);
                var touch = touches[0];

                if (event.which === 0 && $.jqx.browser.msie && $.jqx.browser.version < 9) {
                    self._stopDrag();
                    return false;
                }
                var position = $.jqx.position(event);
                var p = self.orientation == "horizontal" ? position.left : position.top;
                //if the thumb is dragged more than 3 pixels we are firing an event
                self._isDragged(p)
                if (self._slideStarted || self._isTouchDevice) {
                    return self._dragHandler(p);
                }
            }
        },

        _isDragged: function (position) {
            if (Math.abs(position - this[this._getSetting('mouse')]) > 2 && !this._slideStarted) {
                this._slideStarted = true;
                if (this._valueChanged(3)) {
                    this._raiseEvent(3, { value: this.getValue() });
                }
            } else {
                if (this._capturedElement === null) {
                    this._slideStarted = false;
                }
            }
        },

        _dragHandler: function (position) {
            position = (position - this[this._getSetting('mouse')]) + this[this._getSetting('start')];
            var newvalue = this._getValueByPosition(position);
            if (this.rangeSlider) {
                var second = this._slider.right,
                     first = this._slider.left;
                var dimension = this._getSetting('left');

                if (this._capturedElement[0] === first[0]) {
                    if (parseFloat(position) > second.coord()[dimension]) {
                        position = second.coord()[dimension];
                    }
                } else {
                    if (parseFloat(position) < first.coord()[dimension]) {
                        position = first.coord()[dimension];
                    }
                }
            }
            this._setValue(newvalue, this._capturedElement, position);
            return false;
        },

        _getValueByPosition: function (position) {
            if (this.mode === 'default') {
                return this._getFloatingValueByPosition(position);
            } else {
                return this._getFixedValueByPosition(position);
            }
        },

        _getFloatingValueByPosition: function (position) {
            var relativePosition = position - this._track.coord()[this._getSetting('left')] + this._slider.left.width() / 2,
                ratio = relativePosition / this._track[this._getSetting('size')](),
                value = (this.max - this.min) * ratio + this.min;

            if (this.layout == 'normal') {
                if (this.orientation === 'horizontal' && !this.rtl) {
                    return value;
                } else {
                    return (this.max + this.min) - value;
                }
            }
            else {
                if (this.orientation === 'horizontal' && !this.rtl) {
                    return (this.max + this.min) - value;
                } else {
                    return value;
                }
            }
        },

        _getFixedValueByPosition: function (position) {
            var step = this.step,
                count = (this.max - this.min) / step, sectorSize = (this._track[this._getSetting('size')]()) / count,
                currentSectorPosition = this._track.coord()[this._getSetting('left')] - this._slider.left[this._getSetting('size')]() / 2,
                closestSector = { number: -1, distance: Number.MAX_VALUE };
            //position -= this._track.coord()[this._getSetting('left')];
            for (var sector = this.min; sector <= this.max + this.step; sector += this.step) {
                if (Math.abs(closestSector.distance - position) > Math.abs(currentSectorPosition - position)) {
                    closestSector.distance = currentSectorPosition;
                    closestSector.number = sector;
                }
                currentSectorPosition += sectorSize;
            }

            if (this.layout == "normal") {
                if (this.orientation === 'horizontal' && !this.rtl) {
                    return closestSector.number;
                } else {
                    return (this.max + this.min) - closestSector.number;
                }
            }
            else {
                if (this.orientation === 'horizontal' && !this.rtl) {
                    return (this.max + this.min) - closestSector.number;
                } else {
                    return closestSector.number;
                }
            }
        },

        _setValue: function (value, slider, position) {
            if (!this._slideEvent || !this._slideEvent.args.cancel) {
                value = this._handleValue(value, slider);
                this._setSliderPosition(value, slider, position);
                this._fixZIndexes();
                if (this._valueChanged(1)) {
                    var event = this._raiseEvent(1, { value: this.getValue() });
                }
                if (this._valueChanged(0)) {
                    this._raiseEvent(0, { value: this.getValue() });
                }
                if (this.tooltip) {
                    slider.attr('title', value);
                }
                if (this.input) {
                    if (!this.rangeSlider) {
                        this.input.val(this.value.toString());
                    }
                    else {
                        if (this.values) {
                            if (this.value.rangeEnd != undefined && this.value.rangeStart != undefined) {
                                this.input.val(this.value.rangeStart.toString() + "-" + this.value.rangeEnd.toString());
                            }
                        }
                    }
                }
            }
        },

        _valueChanged: function (id) {
            var value = this.getValue();
            return (!this.rangeSlider && this._lastValue[id] !== value) ||
                    (this.rangeSlider && (typeof this._lastValue[id] !== 'object' ||
                     Math.round(this._lastValue[id].rangeEnd) !== Math.round(value.rangeEnd) || Math.round(this._lastValue[id].rangeStart) !== Math.round(value.rangeStart)));
        },

        _handleValue: function (value, slider) {
            value = this._validateValue(value, slider);
            if (slider[0] === this._slider.left[0]) {
                this.values[0] = value;
            }
            if (slider[0] === this._slider.right[0]) {
                this.values[1] = value;
            }
            if (this.rangeSlider) {
                this.value = { rangeStart: this.values[0], rangeEnd: this.values[1] };
            } else {
                this.value = value;
            }
            return value;
        },

        _fixZIndexes: function () {
            if (this.values[1] - this.values[0] < 0.5 && this.max - this.values[0] < 0.5) {
                this._slider.left.css('z-index', 20);
                this._slider.right.css('z-index', 15);
            } else {
                this._slider.left.css('z-index', 15);
                this._slider.right.css('z-index', 20);
            }
        },

        _refreshRangeBar: function () {
            var _left = this._getSetting('left');
            var _size = this._getSetting('size');

            var isRTL = this.rtl && this.orientation == 'horizontal';

            if (this.layout == "normal") {
                var position = this._slider.left.position()[_left];
                if (this.orientation === 'vertical' || isRTL) {
                    position = this._slider.right.position()[_left];
                }
            }
            else {
                var position = this._slider.right.position()[_left];
                if (this.orientation === 'vertical' || isRTL) {
                    var position = this._slider.left.position()[_left];
                }
            }

            this._rangeBar.css(_left, position + this._slider.left[_size]() / 2);

            this._rangeBar[_size](Math.abs(
                this._slider.right.position()[_left] - this._slider.left.position()[_left]));
        },

        _validateValue: function (value, slider) {
            if (value > this.max) {
                value = this.max;
            }
            if (value < this.min) {
                value = this.min;
            }

            if (this.rangeSlider) {
                if (slider[0] === this._slider.left[0]) {
                    if (value >= this.values[1]) {
                        value = this.values[1];
                    }
                } else {
                    if (value <= this.values[0]) {
                        value = this.values[0];
                    }
                }
            }

            return value;
        },

        _setSliderPosition: function (value, thumb, position) {
            var trackSize = this._track[this._getSetting('size')](), ratio, distance;
            if (position) {
                position -= this._track.coord()[this._getSetting('left')];
            }

            if (this.layout == "normal") {
                var ratio = (value - this.min) / (this.max - this.min);
                if (this.orientation != 'horizontal' || (this.orientation == 'horizontal' && this.rtl)) {
                    ratio = 1 - ((value - this.min) / (this.max - this.min));
                }
            }
            else {
                var ratio = 1 - ((value - this.min) / (this.max - this.min));
                if (this.orientation != 'horizontal' || (this.orientation == 'horizontal' && this.rtl)) {
                    ratio = (value - this.min) / (this.max - this.min);
                }
            }

            distance = trackSize * ratio - this._slider.left[this._getSetting('size')]() / 2;
            thumb.css(this._getSetting('left'), distance);

            this._refreshRangeBar();
        },

        _validateDropPosition: function (distance, thumb) {
            var trackSize = this._track[this._getSetting('size')](),
                sliderWidth = thumb[this._getSetting('size')]();
            if (distance < -sliderWidth / 2) {
                distance = -sliderWidth / 2;
            }
            if (distance > trackSize - sliderWidth / 2) {
                distance = trackSize - sliderWidth / 2;
            }
            return Math.floor(distance);
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            switch (key) {
                case 'theme':
                    $.jqx.utilities.setTheme(oldvalue, value, object.host);
                    object._leftButton.jqxRepeatButton({ theme: value });
                    object._rightButton.jqxRepeatButton({ theme: value });
                    break;
                case 'disabled':
                    if (value) {
                        object.disabled = true;
                        object.disable();
                    } else {
                        object.disabled = false;
                        object.enable();
                    }
                    break;
                case 'width':
                case 'height':
                    object._performLayout();
                    object._initialSettings();
                    break;
                case 'min':
                case 'max':
                    if (!object.rangeSlider) {
                        object._setValue(value, object._slider.left);
                    }
                    object._initialSettings();
                    break;
                case 'showTicks':
                case 'ticksPosition':
                case 'ticksFrequency':
                case 'tickSize':
                    object._performLayout();
                    object._initialSettings();
                    break;
                case 'showRange':
                case 'showButtons':
                case 'orientation':
                case 'rtl':
                    object._render();
                    object._performLayout();
                    object._initialSettings();
                    break;
                case 'buttonsPosition':
                    object._refresh();
                    break;
                case 'rangeSlider':
                    if (!value) {
                        object.value = object.value.rangeEnd;
                    } else {
                        object.value = { rangeEnd: object.value, rangeStart: object.value };
                    }
                    object._render();
                    object._performLayout();
                    object._initialSettings();
                    break;
                case 'value':
                    if (!object.rangeSlider) {
                        object.value = parseFloat(value);
                    }
                    object.setValue(value);
                    break;
                case 'values':
                    object.setValue(value);
                    break;
                case 'tooltip':
                    if (!value) {
                        object._slider.left.removeAttr('title');
                        object._slider.right.removeAttr('title');
                    }
                    break;
                default: object._refresh();
            }
        },

        //Increment slider's value. If it's a range slider it's increment it's end range.
        incrementValue: function (step) {
            if (step == undefined || isNaN(parseFloat(step))) {
                step = this.step;
            }
            if (this.rangeSlider) {
                if (this.values[1] < this.max) {
                    this._setValue(this.values[1] + step, this._slider.right);
                }
            } else {
                if (this.values[1] >= this.min && this.values[1] < this.max) {
                    this._setValue(this.values[1] + step, this._slider.right);
                }
            }
            if (this.input) {
                $.jqx.aria(this, 'aria-valuenow', this.input.val());
            }
        },

        //Decrementing slider's value. If it's range slider it's decrement it's start range.
        decrementValue: function (step) {
            if (step == undefined || isNaN(parseFloat(step))) {
                step = this.step;
            }
            if (this.rangeSlider) {
                if (this.values[0] > this.min) {
                    this._setValue(this.values[0] - step, this._slider.left);
                }
            } else {
                if (this.values[1] <= this.max && this.values[1] > this.min) {
                    this._setValue(this.values[1] - step, this._slider.right);
                }
            }
            if (this.input) {
                $.jqx.aria(this, 'aria-valuenow', this.input.val());
            }
        },

        val: function(value)
        {
            if (arguments.length == 0 || typeof (value) == "object") {
                return this.getValue();
            }
            this.setValue(value);
        },

        //Setting slider's value. Possible value types - array, one or two numbers.
        setValue: function (value) {
            if (this.rangeSlider) {
                var rangeLeft, rangeRight;
                if (arguments.length < 2) {
                    if (value instanceof Array) {
                        rangeLeft = value[0];
                        rangeRight = value[1];
                    } else if (typeof value === 'object' && typeof value.rangeStart !== 'undefined' && typeof value.rangeEnd !== 'undefined') {
                        rangeLeft = value.rangeStart;
                        rangeRight = value.rangeEnd;
                    }
                } else {
                    rangeLeft = arguments[0];
                    rangeRight = arguments[1];
                }
                this._setValue(rangeRight, this._slider.right);
                this._setValue(rangeLeft, this._slider.left);
            } else {
                this._setValue(this.min, this._slider.left);
                this._setValue(value, this._slider.right);
            }
            if (this.input) {
                $.jqx.aria(this, 'aria-valuenow', this.input.val());
            }
        },

        getValue: function () {
            return this.value;
        },

        _enable: function (state) {
            if (state) {
                this._addEventHandlers();
                this.disabled = false;
                this.host.removeClass(this.toThemeProperty('jqx-fill-state-disabled'));
            }
            else {
                this._removeEventHandlers();
                this.disabled = true;
                this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
            }
            this._leftButton.jqxRepeatButton({ disabled: this.disabled });
            this._rightButton.jqxRepeatButton({ disabled: this.disabled });
        },

        disable: function () {
            this._enable(false);
            $.jqx.aria(this, 'aria-disabled', true);
        },

        enable: function () {
            this._enable(true);
            $.jqx.aria(this, 'aria-disabled', false);
        }
    });
})(jQuery);(function ($) {

    $.jqx.jqxWidget('jqxSplitter', '', {});

    $.extend($.jqx._jqxSplitter.prototype, {

        defineInstance: function () {
            // Type: Number
            // Default: null
            // Gets or sets the splitter's width.
            this.width = 300;
            // Type: height
            // Default: null
            // Gets or sets the splitter's height.
            this.height = 300;
            // Type: Array
            // Default: []
            // Sets or gets properties for all the panels
            this.panels = [];
            // Type: String
            // Default: vertical
            // Sets or gets splitter's orientation
            this.orientation = 'vertical';
            // Type: Bool
            // Default: false
            // Sets or gets whether the splitter is disabled
            this.disabled = false;
            // Type: Number/String
            // Default: 5
            // Sets or gets splitbar's size
            this.splitBarSize = 5;
            // Type: Number
            // Default: 15
            // Sets or gets splitter's split bar size when a touch device is used
            this.touchSplitBarSize = 15;
            this.panel1 = null;
            this.panel2 = null;
            this._eventsMap = {
                'mousedown': $.jqx.mobile.getTouchEventName('touchstart'),
                'mouseup': $.jqx.mobile.getTouchEventName('touchend'),
                'mousemove': $.jqx.mobile.getTouchEventName('touchmove'),
                'mouseenter': 'mouseenter',
                'mouseleave': 'mouseleave'
            };
            this._isTouchDevice = false;
            this._isNested = false;
            this.resizable = true;
            this.touchMode = 'auto';
            this.showSplitBar = true;
            this.initContent = null;
            this._events = ['resize', 'expanded', 'collapsed', 'resizeStart', 'layout'];
        },

        createInstance: function () {
            this.render();
        },

        _initOverlay: function (create) {
            if (this.overlay || create == 'undefined') {
                this.overlay.remove();
                this.overlay = null;
            }
            else if (create == true) {
                this.overlay = $("<div style='z-index: 100; background: #fff;'></div>");
                this.overlay.css('opacity', 0.01);
                this.overlay.css('position', 'absolute');
                this.overlay.appendTo($(document.body));
                var offset = this.host.coord();
                this.overlay.css('left', "0px");
                this.overlay.css('top', "0px");
                this.overlay.width($(window).width());
                this.overlay.height($(window).height());

                this.overlay.addClass('jqx-disableselect');
                if (this.orientation == "horizontal") {
                    this.overlay.css('cursor', 'row-resize');
                }
                else {
                    this.overlay.css('cursor', 'col-resize');
                }
            }
        },

        _startDrag: function (event) {
            if (event.target == this.splitBarButton[0] || this.disabled)
                return true;

            if (this.panels[0].collapsed || this.panels[1].collapsed || !this.resizable)
                return true;

            if (this.overlay == null) {
                this._dragging = true;
                this._initOverlay(true);
                this._dragStart = $.jqx.position(event);
                return false;
            }
            return true;
        },

        _drag: function (event) {
            if (this.panels[0].collapsed || this.panels[1].collapsed || this.disabled)
                return true;

            if (!this._dragging)
                return true;

            var positionProperty = this.orientation == "horizontal" ? "top" : "left";
            var sizeProperty = this.orientation == "vertical" ? "width" : "height";
            this._position = $.jqx.position(event);

            if (this.overlay && !this._splitBarClone) {
                if (Math.abs(this._position[positionProperty] - this._dragStart[positionProperty]) >= 3) {
                    var cloneOffset = this.splitBar.coord();
                    this._cloneStart = { left: cloneOffset.left, top: cloneOffset.top };
                    this._splitBarClone = this._createSplitBarClone();
                    this._raiseEvent(3, { panels: this.panels });
                    return;
                }
            }
            if (this._splitBarClone) {
                var firstMin, secondMin;
                var hostSize = this.host[sizeProperty]();
                var onePercent = hostSize / 100;
                var onePixelToPercentage = 1 / onePercent; // one pixel is equal to this amount of percentages.
                var hostPosition = 0;
                var splitterSize = this._splitBarClone[sizeProperty]() + 2;
                var hostOffset = parseInt(this.host.coord()[positionProperty]);

                var position = this._position[positionProperty] - this._dragStart[positionProperty] + this._cloneStart[positionProperty] - hostOffset;

                if (hostPosition > position) {
                    position = hostPosition;
                }
                if (position > hostSize + hostPosition - splitterSize) {
                    position = hostSize + hostPosition - splitterSize;
                }

                firstMin = this.panels[0].min;
                secondMin = this.panels[1].min;

                if (secondMin.toString().indexOf("%") != -1) {
                    secondMin = parseFloat(secondMin) * onePercent;
                }
                if (firstMin.toString().indexOf("%") != -1) {
                    firstMin = parseFloat(firstMin) * onePercent;
                }

                this._splitBarClone.removeClass(this.toThemeProperty("jqx-splitter-splitbar-invalid"));

                if (position < firstMin) {
                    this._splitBarClone.addClass(this.toThemeProperty("jqx-splitter-splitbar-invalid"));
                    position = firstMin;
                }

                if (position > hostSize + hostPosition - splitterSize - secondMin) {
                    this._splitBarClone.addClass(this.toThemeProperty("jqx-splitter-splitbar-invalid"));
                    position = hostSize + hostPosition - splitterSize - secondMin;
                }

                this._splitBarClone.css(positionProperty, position);

                if (event.preventDefault) {
                    event.preventDefault();
                }
                if (event.stopPropagation) {
                    event.stopPropagation();
                }
                return false;
            }
            return true;
        },

        _resize: function () {
            var sizeProperty = this.orientation == "horizontal" ? "height" : "width";
            var positionProperty = this.orientation == "horizontal" ? "top" : "left";
            var splitBarPosition = this._splitBarClone.css(positionProperty);
            var hostSize = this.host[sizeProperty]();
            var onePercent = hostSize / 100;
            var onePixelToPercentage = 1 / onePercent; // one pixel is equal to this amount of percentages.
            var size = this.panels[0].size;

            if (size.toString().indexOf('%') != -1) {
                this.panels[0].size = parseFloat(splitBarPosition) * onePixelToPercentage + '%';
            }
            else {
                this.panels[0].size = parseFloat(splitBarPosition);
            }
            this._layoutPanels();
            this._raiseEvent(0, { panels: this.panels });
        },

        _stopDrag: function () {
            if (this._dragging) {
                this._initOverlay();
            }
            this._dragging = false;
            if (this._splitBarClone) {
                if (this.panels[0].collapsed || this.panels[1].collapsed || this.disabled)
                    return true;

                this._resize();
                this._splitBarClone.remove();
                this._splitBarClone = null;
            }
        },

        _createSplitBarClone: function () {
            var clone = this.splitBar.clone();

            clone.fadeTo(0, 0.7);
            clone.css('z-index', 99999);
            if (this.orientation == "vertical") {
                clone.css('cursor', 'col-resize');
            }
            else {
                clone.css('cursor', 'row-resize');
            }

            this.host.append(clone);
            return clone;
        },

        _eventName: function (name) {
            if (this._isTouchDevice) {
                return this._eventsMap[name];
            } else {
                return name;
            }
        },

        _addHandlers: function () {
            var that = this;
            $.jqx.utilities.resize(this.host, function () {
                 that._layoutPanels();
            });

            this.addHandler(this.splitBar, 'dragstart.' + this.element.id, function (event) {
                return false;
            });

            if (this.splitBarButton) {
                this.addHandler(this.splitBarButton, 'click.' + this.element.id, function () {
                    var toggle = function (panel) {
                        if (!panel.collapsed) {
                            that.collapse();
                        }
                        else {
                            that.expand();
                        }
                    }

                    if (that.panels[0].collapsible) {
                        toggle(that.panels[0]);
                    }
                    else if (that.panels[1].collapsible) {
                        toggle(that.panels[1]);
                    }
                });
                this.addHandler(this.splitBarButton, this._eventName('mouseenter'), function () {
                    that.splitBarButton.addClass(that.toThemeProperty('jqx-splitter-collapse-button-hover'));
                    that.splitBarButton.addClass(that.toThemeProperty('jqx-fill-state-hover'));
                });
                this.addHandler(this.splitBarButton, this._eventName('mouseleave'), function () {
                    that.splitBarButton.removeClass(that.toThemeProperty('jqx-splitter-collapse-button-hover'));
                    that.splitBarButton.removeClass(that.toThemeProperty('jqx-fill-state-hover'));
                });
            }

            this.addHandler($(document), this._eventName('mousemove') + '.' + this.element.id, function (event) {
                return that._drag(event);
            });

            this.addHandler($(document), this._eventName('mouseup') + '.' + this.element.id, function () {
                return that._stopDrag();
            });

            this.addHandler(this.splitBar, this._eventName('mousedown'), function (event) {
                return that._startDrag(event);
            });

            this.addHandler(this.splitBar, this._eventName('mouseenter'), function () {
                if (that.resizable && !that.disabled) {
                    that.splitBar.addClass(that.toThemeProperty('jqx-splitter-splitbar-hover'));
                    that.splitBar.addClass(that.toThemeProperty('jqx-fill-state-hover'));
                }
            });
            this.addHandler(this.splitBar, this._eventName('mouseleave'), function () {
                if (that.resizable && !that.disabled) {
                    that.splitBar.removeClass(that.toThemeProperty('jqx-splitter-splitbar-hover'));
                    that.splitBar.removeClass(that.toThemeProperty('jqx-fill-state-hover'));
                }
            });

            if (document.referrer != "" || window.frameElement) {
                if (window.top != null && window.top != window.self) {
                    var parentLocation = null;
                    if (window.parent && document.referrer) {
                        parentLocation = document.referrer;
                    }

                    if (parentLocation && parentLocation.indexOf(document.location.host) != -1) {
                        var eventHandle = function (event) {
                            that._stopDrag();
                        };

                        if (window.top.document.addEventListener) {
                            window.top.document.addEventListener('mouseup', eventHandle, false);

                        } else if (window.top.document.attachEvent) {
                            window.top.document.attachEvent("on" + 'mouseup', eventHandle);
                        }
                    }
                }
            }
        },

        _removeHandlers: function () {
            this.removeHandler($(window), 'resize.' + this.element.id);
            if (this.splitBarButton) {
                this.removeHandler(this.splitBarButton, 'click.' + this.element.id);
                this.removeHandler(this.splitBarButton, this._eventName('mouseenter'));
                this.removeHandler(this.splitBarButton, this._eventName('mouseleave'));
            }
            this.removeHandler($(document), this._eventName('mousemove') + '.' + this.element.id);
            this.removeHandler($(document), this._eventName('mouseup') + '.' + this.element.id);
            if (this.splitBar) {
                this.removeHandler(this.splitBar, 'dragstart.' + this.element.id);
                this.removeHandler(this.splitBar, this._eventName('mousedown'));
                this.removeHandler(this.splitBar, this._eventName('mouseenter'));
                this.removeHandler(this.splitBar, this._eventName('mouseleave'));
            }
        },

        render: function () {
            if (this.splitBar) {
                this.splitBar.remove();
            }

            var children = this.host.children();
            if (children.length != 2) {
                throw "Invalid HTML Structure! jqxSplitter requires 1 container DIV tag and 2 nested DIV tags.";
            }

            if (children.length == 2) {
                var classNames = children[0].className.split(' ');
                var classNames2 = children[1].className.split(' ');
                if (classNames.indexOf('jqx-reset') != -1 && classNames.indexOf('jqx-splitter') != -1 && classNames.indexOf('jqx-widget') != -1) {
                    throw "Invalid HTML Structure! Nested jqxSplitter cannot be initialized from a Splitter Panel. You need to add a new DIV tag inside the Splitter Panel and initialize the nested jqxSplitter from it!";
                }
                if (classNames2.indexOf('jqx-reset') != -1 && classNames2.indexOf('jqx-splitter') != -1 && classNames2.indexOf('jqx-widget') != -1) {
                    throw "Invalid HTML Structure! Nested jqxSplitter cannot be initialized from a Splitter Panel. You need to add a new DIV tag inside the Splitter Panel and initialize the nested jqxSplitter from it!";
                }
            }

            if (this.host.parent().length > 0 && this.host.parent()[0].className.indexOf('jqx-splitter') != -1) {
                if (this.element.className.indexOf('jqx-splitter-panel') != -1) {
                    throw "Invalid HTML Structure! Nested jqxSplitter cannot be initialized from a Splitter Panel. You need to add a new DIV tag inside the Splitter Panel and initialize the nested jqxSplitter from it!";
                }
                this._isNested = true;
                if (this.width == 300) this.width = "100%";
                if (this.height == 300) this.height = "100%";
                if (this.width == '100%' && this.height == '100%') {
                    this.host.addClass('jqx-splitter-nested');
                    if (this.host.parent()[0].className.indexOf('jqx-splitter-panel') != -1) {
                        this.host.parent().addClass('jqx-splitter-panel-nested');
                    }
                }
            }

            this._hasBorder = (this.host.hasClass('jqx-hideborder') == false) || this.element.style.borderTopWidth != "";
            this._removeHandlers();
            this._isTouchDevice = $.jqx.mobile.isTouchDevice();

            this._validate();

            this.panel1.css('left', '0px');
            this.panel1.css('top', '0px');
            this.panel2.css('left', '0px');
            this.panel2.css('top', '0px');

            this.splitBar = $("<div><div></div></div>");
            if (!this.resizable) {
                this.splitBar.css('cursor', 'default');
            }
            this.splitBarButton = this.splitBar.find('div:last');
            this._setTheme();
            this.splitBar.insertAfter(this.panel1);
            this._arrange();

            if (this.panels[0].collapsible == false && this.panels[1].collapsible == false) {
                this.splitBarButton.hide();
            }

            var that = this;
            this._addHandlers();

            if (this.initContent) {
                this.initContent();
            }
            if (this.disabled) {
                this.disable();
            }
        },

        _hiddenParent: function () {
            return $.jqx.isHidden(this.host);
        },

        _setTheme: function () {
            this.panel1.addClass(this.toThemeProperty('jqx-widget-content'));
            this.panel2.addClass(this.toThemeProperty('jqx-widget-content'));
            this.panel1.addClass(this.toThemeProperty('jqx-splitter-panel'));
            this.panel2.addClass(this.toThemeProperty('jqx-splitter-panel'));
            this.panel1.addClass(this.toThemeProperty('jqx-reset'));
            this.panel2.addClass(this.toThemeProperty('jqx-reset'));
            this.host.addClass(this.toThemeProperty('jqx-reset'));
            this.host.addClass(this.toThemeProperty('jqx-splitter'));
            this.host.addClass(this.toThemeProperty('jqx-widget'));
            this.host.addClass(this.toThemeProperty('jqx-widget-content'));
            this.splitBar.addClass(this.toThemeProperty('jqx-splitter-splitbar-' + this.orientation));
            this.splitBar.addClass(this.toThemeProperty('jqx-fill-state-normal'));
            this.splitBarButton.addClass(this.toThemeProperty('jqx-splitter-collapse-button-' + this.orientation));
            this.splitBarButton.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
        },

        _validate: function () {
            var children = this.host.children();
            if (children.length != 2) {
                throw "Invalid HTML Structure! jqxSplitter requires two nested DIV tags!";
            }

            if (this.panels && !this.panels[1]) {
                if (!this.panels[0]) {
                    this.panels = [{ size: '50%' }, { size: '50%' }];
                }
                else {
                    this.panels[1] = {};
                }
            }
            else if (this.panels == undefined) {
                this.panels = [{ size: '50%' }, { size: '50%'}];
            }

            var children = this.host.children();
            this.panel1 = this.panels[0].element = $(children[0]);
            this.panel2 = this.panels[1].element = $(children[1]);
            this.panel1[0].style.minWidth = "";
            this.panel1[0].style.maxWidth = "";
            this.panel2[0].style.minWidth = "";
            this.panel2[0].style.maxWidth = "";

            $.each(this.panels, function () {
                if (this.min == undefined) this.min = 0;
                if (this.size == undefined) this.size = 0;
                if (this.size < 0) this.size = 0;
                if (this.min < 0) this.min = 0;
                if (this.collapsible == undefined) this.collapsible = true;
                if (this.collapsed == undefined) this.collapsed = false;

                if (this.size != 0) {
                    if (this.size.toString().indexOf('%') == -1) {
                        if (parseInt(this.min) > parseInt(this.size)) {
                            this.min = this.size;
                        }
                    }
                    else if (this.min.toString().indexOf('%') != -1) {
                        if (parseInt(this.min) > parseInt(this.size)) {
                            this.min = this.size;
                        }
                    }
                }
            });
        },

        _arrange: function () {
            if (this.width != null) {
                var width = this.width;
                if (typeof width != "string") width = parseInt(this.width) + 'px';
                this.host.css('width', width);
            }
            if (this.height != null) {
                var height = this.height;
                if (typeof height != "string") height = parseInt(this.height) + 'px';
                this.host.css('height', height);
            }
            this._splitBarSize = !this._isTouchDevice ? this.splitBarSize : this.touchSplitBarSize;
            if (!this.showSplitBar) {
                this._splitBarSize = 0;
                this.splitBar.hide();
            }
            var sizeProperty = this.orientation == "horizontal" ? "width" : "height";

            this.splitBar.css(sizeProperty, '100%');
            this.panel1.css(sizeProperty, '100%');
            this.panel2.css(sizeProperty, '100%');

            if (this.orientation == "horizontal") {
                this.splitBar.height(this._splitBarSize);
            }
            else {
                this.splitBar.width(this._splitBarSize);
            }

            if (this.orientation === 'vertical') {
                this.splitBarButton.width(this._splitBarSize);
                this.splitBarButton.height(45);
            }
            else {
                this.splitBarButton.height(this._splitBarSize);
                this.splitBarButton.width(45);
            }

            this.splitBarButton.css('position', 'relative');
            if (this.orientation === 'vertical') {
                this.splitBarButton.css('top', '50%');
                this.splitBarButton.css('left', '0');
                this.splitBarButton.css('margin-top', '-23px');
                this.splitBarButton.css('margin-left', '-0px');
            }
            else {
                this.splitBarButton.css('left', '50%');
                this.splitBarButton.css('top', '0');
                this.splitBarButton.css('margin-left', '-23px');
                this.splitBarButton.css('margin-top', '-0px');
            }

            this._layoutPanels();
        },

        collapse: function () {
            if (this.disabled) return;

            var index = -1;
            this.panels[0].collapsed = this.panels[1].collapsed = false;
            this.panels[0].element[0].style.visibility = "inherit";
            this.panels[1].element[0].style.visibility = "inherit";

            if (this.panels[0].collapsible) {
                index = 0;
            }
            else if (this.panels[1].collapsible) {
                index = 1;
            }

            if (index != -1) {
                this.panels[index].collapsed = true;
                this.panels[index].element[0].style.visibility = "hidden";
                this.splitBar.addClass(this.toThemeProperty('jqx-splitter-splitbar-collapsed'));
                this._layoutPanels();
                this._raiseEvent(2, { index: index, panels: this.panels });
                this._raiseEvent(0, { panels: this.panels });
            }
        },

        expand: function () {
            if (this.disabled) return;

            var index = -1;
            this.panels[0].collapsed = this.panels[1].collapsed = false;
            this.panels[0].element[0].style.visibility = "inherit";
            this.panels[1].element[0].style.visibility = "inherit";

            if (this.panels[0].collapsible) {
                index = 0;
            }
            else if (this.panels[1].collapsible) {
                index = 1;
            }

            if (index != -1) {
                this.panels[index].collapsed = false;
                this.panels[index].element[0].style.visibility = "inherit";
                this.splitBar.removeClass(this.toThemeProperty('jqx-splitter-splitbar-collapsed'));
                this._layoutPanels();
                this._raiseEvent(1, { index: index, panels: this.panels });
                this._raiseEvent(0, { panels: this.panels });
            }
        },

        disable: function () {
            this.disabled = true;
            this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
            this.splitBar.addClass(this.toThemeProperty('jqx-splitter-splitbar-collapsed'));
            this.splitBarButton.addClass(this.toThemeProperty('jqx-splitter-splitbar-collapsed'));
        },

        enable: function () {
            this.disabled = false;
            this.host.removeClass(this.toThemeProperty('jqx-fill-state-disabled'));
            this.splitBar.removeClass(this.toThemeProperty('jqx-splitter-splitbar-collapsed'));
            this.splitBarButton.removeClass(this.toThemeProperty('jqx-splitter-splitbar-collapsed'));
        },

        refresh: function (initialRefresh) {
            if (initialRefresh != true) {
                this._arrange();
            }
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (key === 'panels' || key === "orientation" || key === "showSplitBar") {
                object.render();
                return;
            }
            if (key === 'touchMode') {
                object._isTouchDevice = value;
            }
            if (key === 'disabled') {
                if (value) {
                    object.disable();
                } else {
                    object.enable();
                }
            } else if (key === 'theme') {
                $.jqx.utilities.setTheme(oldvalue, value, object.host);
            } else {
                object.refresh();
            }
        },

        _layoutPanels: function () {
            var that = this;
            var sizeProperty = this.orientation == "horizontal" ? "height" : "width";
            var positionProperty = this.orientation == "horizontal" ? "top" : "left";
            var firstMin, secondMin, firstCollapsed, secondCollapsed;
            var splitBarSize = parseInt(this._splitBarSize) + 2;
            if (!this.showSplitBar) {
                splitBarSize = 0;
            }
            var hostSize = this.host[sizeProperty]();
            var onePercent = hostSize / 100;
            var onePixelToPercentage = 1 / onePercent; // one pixel is equal to this amount of percentages.
            var splitBarSizeToPercentages = onePixelToPercentage * splitBarSize;

            var firstPanel = this.panel1;
            var secondPanel = this.panel2;
            var size = this.panels[0].size;
            if (this.panels[0].collapsed) {
                firstCollapsed = true;
            }
            if (this.panels[1].collapsed) {
                secondCollapsed = true;
            }
            firstMin = this.panels[0].min;
            secondMin = this.panels[1].min;

            if (secondMin.toString().indexOf("%") != -1) {
                secondMin = parseFloat(secondMin) * onePercent;
            }
            if (firstMin.toString().indexOf("%") != -1) {
                firstMin = parseFloat(firstMin) * onePercent;
            }

            if (this._isNested && this._isTouchDevice) {
                if (this.orientation == "horizontal") {
                    firstPanel.width(this.host.width());
                    secondPanel.width(this.host.width());
                }
                else {
                    firstPanel.height(this.host.height());
                    secondPanel.height(this.host.height());
                }
            }

            var positionPanels = function () {
                var position = that.panel1[sizeProperty]();
                if (that.splitBar[0].style[positionProperty] != position + 'px') {
                    var splitBarPosition = position;
                    if (that.orientation == "vertical") {
                        that.splitBar[0].style.borderLeftColor = "";
                        that.splitBar[0].style.borderRightColor = "";
                        that.splitBarButton.width(that._splitBarSize);
                        that.splitBarButton.css('left', '0px');
                    }
                    else {
                        that.splitBar[0].style.borderTopColor = "";
                        that.splitBar[0].style.borderBottomColor = "";
                        that.splitBarButton.height(that._splitBarSize);
                        that.splitBarButton.css('top', '0px');
                    }
                    if (that._hasBorder) {
                        if (hostSize - splitBarSize == position) {
                            if (that.orientation == "vertical") {
                                that.splitBar[0].style.borderRightColor = "transparent";
                                that.splitBarButton.width(that._splitBarSize + 1);
                            }
                            else {
                                that.splitBar[0].style.borderBottomColor = "transparent";
                                that.splitBarButton.height(that._splitBarSize + 1);
                            }
                        }
                        else if (position == 0) {
                            if (that.orientation == "vertical") {
                                that.splitBar[0].style.borderLeftColor = "transparent";
                                that.splitBarButton.width(that._splitBarSize + 1);
                                that.splitBarButton.css('left', '-1px');
                            }
                            else {
                                that.splitBar[0].style.borderTopColor = "transparent";
                                that.splitBarButton.height(that._splitBarSize + 1);
                                that.splitBarButton.css('top', '-1px');
                            }
                        }
                    }

                    that.splitBar.css(positionProperty, splitBarPosition + 'px');
                }
                if (that.panel2[0].style[positionProperty] != position + splitBarSize + 'px') {
                    that.panel2.css(positionProperty, position + splitBarSize + 'px');
                }
            }

            if (firstCollapsed) {
                var newSize = Math.max(secondMin, hostSize - splitBarSize);
                firstPanel[sizeProperty](0);
                secondPanel[sizeProperty](newSize);
            }
            else if (secondCollapsed) {
                var newSize = Math.max(firstMin, hostSize - splitBarSize);
                secondPanel[sizeProperty](0);
                firstPanel[sizeProperty](newSize);
            }
            else {
                if (size.toString().indexOf('%') != -1) {
                    var totalPercentages = 100 - parseFloat(size);
                    firstPanel.css(sizeProperty, parseFloat(size) + '%');
                    totalPercentages -= splitBarSizeToPercentages;
                    secondPanel.css(sizeProperty, totalPercentages + "%");

                    var secondPanelSize = secondPanel[sizeProperty]();

                    if (secondPanelSize < secondMin) {
                        var newSize = secondPanelSize - secondMin;
                        var newSizeInPercentages = newSize * onePixelToPercentage;
                        size = parseFloat(size) + parseFloat(newSizeInPercentages);
                        var totalPercentages = 100 - parseFloat(size);
                        firstPanel.css(sizeProperty, parseFloat(size) + '%');
                        totalPercentages -= splitBarSizeToPercentages;
                        secondPanel.css(sizeProperty, totalPercentages + "%");
                    }
                    var firstPanelSize = firstPanel[sizeProperty]();
                    if (firstPanelSize < firstMin) {
                        var newSizeInPercentages = firstMin * onePixelToPercentage;
                        firstPanel.css(sizeProperty, parseFloat(newSizeInPercentages) + '%');
                    }
                }
                else {
                    var secondPanelSize = hostSize - size - splitBarSize;
                    if (firstPanel[0].style[sizeProperty] != size + "px") {
                        firstPanel[sizeProperty](size);
                    }
                    if (secondPanel[0].style[sizeProperty] != secondPanelSize + "px") {
                        secondPanel[sizeProperty](secondPanelSize);
                    }

                    if (secondPanelSize < secondMin) {
                        size += secondPanelSize - secondMin;
                        secondPanel[sizeProperty](secondMin);
                        firstPanel[sizeProperty](size);
                    }
                    if (size < firstMin) {
                        firstPanel[sizeProperty](firstMin);
                    }
                }
            }

            positionPanels();
            this._raiseEvent(4, { panels: this.panels });
        },

        destroy: function () {
            this._removeHandlers();
            this.host.remove();
        },

        _raiseEvent: function (eventId, data) {
            var event = new $.Event(this._events[eventId]);
            event.owner = this;
            event.args = data;
            var sizeProperty = this.orientation == "vertical" ? "width" : "height";
            var panels = new Array();
            panels[0] = {};
            panels[1] = {};
            panels[0].size = this.panel1[sizeProperty]();
            panels[1].size = this.panel2[sizeProperty]();
            panels[0].min = this.panels[0].min;
            panels[1].min = this.panels[1].min;
            panels[0].collapsible = this.panels[0].collapsible;
            panels[1].collapsible = this.panels[1].collapsible;
            panels[0].collapsed = this.panels[0].collapsed;
            panels[1].collapsed = this.panels[1].collapsed;
            event.args.panels = panels;

            return this.host.trigger(event);
        }
    });
} (jQuery));
(function ($) {

    $.jqx.jqxWidget('jqxTabs', '', {});

    $.extend($.jqx._jqxTabs.prototype, {

        defineInstance: function () {
            // Type: Number
            // Default: 250
            // Gets or sets the duration of the scroll animation.
            this.scrollAnimationDuration = 200;
            // Type: Bool
            // Default: true
            // Gets or sets whether the hover effect is active.
            this.enabledHover = true;
            // Type: Bool
            // Default: false
            // Gets or sets whether the tab view is disabled.
            this.disabled = false;
            // Type: Bool
            // Default: false
            // Gets or sets whether the tab view is collapsible.
            this.collapsible = false;
            // Type: String
            // Default: none
            // Gets or sets the animation type of switching tabs. Possible values ['none', 'fade'].
            this.animationType = 'none';
            // Type: Bool
            // Default: true
            // Gets or sets whether the scroll animation is enabled.
            this.enableScrollAnimation = true;
            // Type: Number
            // Default: 450
            // Gets or sets animation duration of showing animation.
            this.contentTransitionDuration = 450;
            // Type: String
            // Default: click
            // Gets or sets user interaction used for switching the different tabs. Possible values ['click', 'dblclick', 'mouseenter', 'none'].
            this.toggleMode = 'click';
            // Type: Number
            // Default: 0
            // Gets or sets current selected item.
            this.selectedItem = 0;
            // Type: Number or String
            // Default: auto
            // Gets or sets widget's height.
            this.height = 'auto';
            // Type: Number or String
            // Default: auto
            // Gets or sets widget's width.
            this.width = 'auto';
            // Type: String
            // Default: top
            // Gets or sets widget's navigation location. Possible values ['top', 'bottom'].
            this.position = 'top';
            // Type: Bool
            // Default: false
            // Gets or sets whether the selection tracker is enabled.
            this.selectionTracker = false;
            // Type: Bool
            // Default: true
            // Gets or sets whether the scrolling is enabled.
            this.scrollable = true;
            // Type: String
            // Default: both
            // Gets or sets the position of the scroll arrows. Possible values ['left', 'right', 'both'].
            this.scrollPosition = 'right'
            // Type: Number
            // Default: 70
            // Gets or sets the scrolling step.
            this.scrollStep = 70;
            // Type: Bool
            // Default: true
            // Gets or sets whether the tab view's header is with the height equals to the height of it's biggest item.
            this.autoHeight = true;
            // sets a height of the header
            this.headerHeight = null;
            // Type: Bool
            // Default: false
            // Gets or sets whether tabs will have close buttons.
            this.showCloseButtons = false;
            // Type: Bool
            // Default: true
            // Gets or sets whether all tabs can be closed with the 'close' button or with the 'removeAt' function.
            this.canCloseAllTabs = true;
            // Type: Number
            // Default: 16
            // Gets or sets the close button size.
            this.closeButtonSize = 16;
            // Type: Number
            // Default: 16
            // Gets or sets the arrow buttons size.
            this.arrowButtonSize = 16;
            // Type: Bool
            // Default: true
            // Gets or sets whether the keyboard navigation is activated.
            this.keyboardNavigation = true;
            // Type: Bool
            // Default: false
            // Gets or sets whether the tab view's elements could be reordered.
            this.reorder = false;
            // Type: Number
            // Default: 300
            // Gets or sets whether the selection tracker animation duration.
            this.selectionTrackerAnimationDuration = 300;
            //Private variables
            this._isTouchDevice = false;
            this.roundedCorners = true;
            //This variable is used in the expanding and collapsing. Onece when the tab have been collapsed bottom or top (depending ot
            //header's position) border is added to the titles and _headerWrapper's height is increasing with 1px. When the header increase
            //its size with one pixel _headerExpandingBalance is increasing with one, when it's decreased it's decreasing with one.
            this._headerExpandingBalance = 0;
            this._dragStarted = false;
            this._tabCaptured = false;
            //Used in scrolling when the user is dragging any item
            this._lastUnorderedListPosition = 0;
            this._selectedItem = 0;
            this._titleList = [];
            this._contentList = [];
            this._contentWrapper = null;
            this._unorderedList = null;
            this._scrollTimeout = null;
            this.isCollapsed = false;
            this.touchMode = false;
            this.initTabContent = null;
            this.enableDropAnimation = false;

            //This property is used to cancel selecting and unselecting events. It is keeping reference to these events.
            this._currentEvent = null;
            //This property indicates is the unordered list wide enough to add scroll arrows
            this._needScroll = true;
            //This variable is used for not allowing to the user to perform any action when there is an active animation.
            //Before the animation start we are adding property (with the name of the animated object) to the _isAnimated object and setting it's value to true.
            //When the animation ends we are setting this property to false.
            //In the method which is checking is there an active animation we are checking is there any property with value true.
            this._isAnimated = {};
            this._events = [
                'created', 'selected', 'add', 'removed', 'enabled', 'disabled', 'selecting', 'unselecting',
                'unselected', 'dragStart', 'dragEnd', 'locked', 'unlocked', 'collapsed', 'expanded', 'tabclick'
            ];
            this._initTabContentList = [];
            this._invalidArgumentExceptions = {
                'invalidScrollAnimationDuration': 'The scroll animation duration is not valid!',
                'invalidWidth': 'Width you\'ve entered is invalid!',
                'invalidHeight': 'Height you\'ve entered is invalid!',
                'invalidAnimationType': 'You\'ve entered invalid animation type!',
                'invalidcontentTransitionDuration': 'You\'ve entered invalid value for contentTransitionDuration!',
                'invalidToggleMode': 'You\'ve entered invalid value for toggleMode!',
                'invalidPosition': 'You\'ve entered invalid position!',
                'invalidScrollPosition': 'You\'ve entered invalid scroll position!',
                'invalidScrollStep': 'You\'ve entered invalid scroll step!',
                'invalidStructure': 'Invalid structure!',
                'invalidArrowSize': 'Invalid scroll button size!',
                'invalidCloseSize': 'Invalid close button size!'
            };
            this.aria =
                 {
                     "aria-disabled": { name: "disabled", type: "boolean" }
                 };

            this.rtl = false;
        },

        createInstance: function () {
            $.jqx.aria(this);
            this.host.addClass(this.toThemeProperty('jqx-tabs'));
            this.host.addClass(this.toThemeProperty('jqx-widget'));
            this.host.addClass(this.toThemeProperty('jqx-widget-content'));
            this.host.attr('role', 'tablist');
            this._unorderedList = this.host.children('ul');

            this._titleList = this.host.children('ul').children('li');
            this._contentList = this.host.children('div');
            this._selectedItem = this.selectedItem;
            this._isTouchDevice = $.jqx.mobile.isTouchDevice();
            this._needScroll = this.scrollable;
            if (this.selectionTracker) {
                this.selectionTracker = this._seletionTrackerBrowserCheck();
            }
            if (this._isTouchDevice) {
                this.reorder = false;
                this.keyboardNavigation = false;
            }
            //Saving all titles and contents into collections
            var count = this.length();
            while (count) {
                count--;
                this._titleList[count] = $(this._titleList[count]);
                this._titleList[count].attr('role', 'tab');
                this._contentList[count] = $(this._contentList[count]);
                this._contentList[count].attr('role', 'tabpanel');
            }
            this._validateProperties();
            this._refresh();
            this._moveSelectionTrack(this._selectedItem, 0);
            if (this.disabled) {
                this.disable();
            }
            this.element.tabIndex = 0;
            this._raiseEvent(0);
            this._enableWindowResize();
        },

        _hiddenParent: function () {
            var me = this;
            if (me.host.css('display') == 'none')
                return true;
            var hiddenParent = false;
            $.each(me.host.parents(), function () {
                if ($(this).css('display') == 'none') {
                    hiddenParent = true;
                    return false;
                }
            });
            return hiddenParent;
        },

        _enableWindowResize: function () {
            var me = this;

            $.jqx.utilities.resize(this.host, function () {
                me.refresh();
            });
        },

        refresh: function (initialRefresh) {
            if (true != initialRefresh || initialRefresh == undefined) {
                this._performResize();
            }
        },

        _seletionTrackerBrowserCheck: function () {
            var txt = "Browser CodeName: " + navigator.appCodeName + "";
            txt += "Browser Name: " + navigator.appName + "";
            txt += "Browser Version: " + navigator.appVersion + "";
            // txt += "Cookies Enabled: " + navigator.cookieEnabled + "";
            txt += "Platform: " + navigator.platform + "";
            txt += "User-agent header: " + navigator.userAgent + "";

            if (txt.indexOf('IEMobile') != -1) {
                return false;
            }
            if (txt.indexOf('Windows Phone OS') != -1) {
                return false;
            }
            if ($.jqx.browser.msie && $.jqx.browser.version <= 7) {
                return false;
            }
            return true;
        },

        render: function () {
            this._refresh();
        },

        _uiRefresh: function (render) {
            //Using this backup variable because after refresh the scroll position should be recovered
            this._unorderedListLeftBackup = this._unorderedList.css('left');

            if (render) {
                this._render();
            }
            this._addStyles();
            this._performLayout();
            this._prepareTabs();
            this._removeEventHandlers();
            this._addEventHandlers();
            if (this._unorderedListLeftBackup === 'auto') {
                this._unorderedListLeftBackup = this._getArrowsDisplacement();
            }
            this._unorderedList.css('left', this._unorderedListLeftBackup);
            if (this.rtl) {
                if (this.scrollable && this._rightArrow && this._rightArrow.css('visibility') != 'hidden') {
                    var buttonsSize = 2 * this.arrowButtonSize;
                    var left = this.host.width() - parseInt(this._unorderedList.width() + buttonsSize + +parseInt(this._unorderedList.css('margin-left')), 10);
                    this._unorderedList.css('left', left + 'px');
                }
            }
        },

        _refresh: function () {
            this._uiRefresh(true);
        },

        _addStyles: function () {
            this._unorderedList.addClass(this.toThemeProperty('jqx-tabs-title-container'));

            this._unorderedList.css({
                'outline': 'none', 'white-space': 'nowrap',
                'margin-top': '0px', 'margin-bottom': '0px', padding: '0px', background: 'transparent', border: 'none', 'border-style': 'none', 'text-indent': '0px'
            });

            var count = this.length();
            while (count) {
                count--;
                this._titleList[count].removeClass();
                this._titleList[count].css('padding', '');
                this._titleList[count].addClass('jqx-reset');
                this._titleList[count].addClass('jqx-disableselect');
                this._titleList[count].addClass(this.toThemeProperty('jqx-tabs-title'));
                this._titleList[count].addClass(this.toThemeProperty('jqx-item'));
                if (this.position == 'bottom') {
                    this._titleList[count].addClass(this.toThemeProperty('jqx-tabs-title-bottom'));
                }

                if (this._titleList[count].disabled) {
                    this._titleList[count].addClass(this.toThemeProperty('jqx-tabs-title-disable'));
                    this._titleList[count].addClass(this.toThemeProperty('jqx-fill-state-disabled'));
                }

                this._titleList[count].removeClass(this.toThemeProperty('jqx-rc-b'));
                this._titleList[count].removeClass(this.toThemeProperty('jqx-rc-t'));
                this._contentList[count].removeClass(this.toThemeProperty('jqx-rc-b'));
                this._contentList[count].removeClass(this.toThemeProperty('jqx-rc-t'));
                switch (this.position) {
                    case 'top':
                        this._titleList[count].addClass(this.toThemeProperty('jqx-rc-t'));
                        this._contentList[count].addClass(this.toThemeProperty('jqx-rc-b'));
                        break;
                    case 'bottom':
                        this._titleList[count].addClass(this.toThemeProperty('jqx-rc-b'));
                        this._contentList[count].addClass(this.toThemeProperty('jqx-rc-t'));
                        break;
                }
            }
            if (this.selectionTracker) {
                this._selectionTracker.removeClass(this.toThemeProperty('jqx-rc-b'));
                this._selectionTracker.removeClass(this.toThemeProperty('jqx-rc-t'));
                switch (this.position) {
                    case 'top':
                        this._selectionTracker.addClass(this.toThemeProperty('jqx-rc-t'));
                        break;
                    case 'bottom':
                        this._selectionTracker.addClass(this.toThemeProperty('jqx-rc-b'));
                        break;
                }
            }
        },

        _raiseEvent: function (eventId, data) {
            var event = new $.Event(this._events[eventId]);
            event.owner = this;
            event.args = data;
            if (eventId === 6 || eventId === 7) {
                event.cancel = false;
                this._currentEvent = event;
            }
            var result = '';
            try {
                result = this.host.trigger(event);
                if (eventId == 1) {
                    var me = this;
                    if (this.selectionTracker || this.animationType != 'none') {
                        setTimeout(function () {
                            if (!me._initTabContentList[me.selectedItem]) {
                                if (me.initTabContent) {
                                    me.initTabContent(me.selectedItem);
                                    me._initTabContentList[me.selectedItem] = true;
                                }
                            }
                            var event = new $.Event('loadContent');
                            event.owner = this;
                            if (me._contentList.length > 0 && me._contentList[me.selectedItem]) {
                                me._contentList[me.selectedItem].find('div').trigger(event);
                            }
                        }, 50 + me.selectionTrackerAnimationDuration);
                    }
                    else {
                        var event = new $.Event('loadContent');
                        if (!me._initTabContentList[me.selectedItem]) {
                            if (me.initTabContent) {
                                me.initTabContent(me.selectedItem);
                                me._initTabContentList[me.selectedItem] = true;
                            }
                        }
                        event.owner = this;
                        if (this._contentList.length > 0 && this._contentList[this.selectedItem]) {
                            this._contentList[this.selectedItem].find('div').trigger(event);
                        }
                    }
                }
            }
            catch (error) {
            }

            return result;
        },

        _getArrowsDisplacement: function () {
            if (!this._needScroll) {
                return 0;
            }
            var trackerDisplacement;
            var leftArrowWidth = this.arrowButtonSize;
            var rightArrowWidth = this.arrowButtonSize;
            if (this.scrollPosition === 'left') {
                trackerDisplacement = leftArrowWidth + rightArrowWidth;
            } else if (this.scrollPosition === 'both') {
                trackerDisplacement = leftArrowWidth;
            } else {
                trackerDisplacement = 0;
            }
            return trackerDisplacement;
        },

        _scrollRight: function (duration, callback) {
            this._unorderedList.stop();
            this._unlockAnimation('unorderedList');
            var scrollWidth = parseInt(this._unorderedList.width() + parseInt(this._unorderedList.css('margin-left')), 10),
                hostWidth = parseInt(this.host.width(), 10),
                leftArrowWidth, rightArrowWidth,
                unorderedListLeft = parseInt(this._unorderedList.css('left'), 10),
                trackerDisplacement = this._getArrowsDisplacement(),
                left = 0,
                selectionTrackerLeft = undefined;
            if (this.scrollable) {
                leftArrowWidth = parseInt(this._leftArrow.outerWidth(), 10);
                rightArrowWidth = parseInt(this._rightArrow.outerWidth(), 10);
            } else {
                leftArrowWidth = 0;
                rightArrowWidth = 0;
            }
            duration = (this.enableScrollAnimation) ? duration : 0;
            if (parseInt(this._headerWrapper.width(), 10) > parseInt(this._unorderedList.css('margin-left')) + parseInt(this._unorderedList.width(), 10)) {
                left = trackerDisplacement;
            } else if (Math.abs(unorderedListLeft) + this.scrollStep <
                Math.abs(hostWidth - scrollWidth) + leftArrowWidth + rightArrowWidth + trackerDisplacement) {
                left = unorderedListLeft - this.scrollStep;
                selectionTrackerLeft = unorderedListLeft - this.scrollStep + parseInt(this._titleList[this._selectedItem].position().left);
            } else {
                left = hostWidth - scrollWidth - (2 * this.arrowButtonSize - trackerDisplacement);
                //Making this check because jQuery(selector).position().left is giving different results
                if (left < parseInt(this._unorderedList.css('left'), 10) - 4 &&
                    left > parseInt(this._unorderedList.css('left'), 10) + 4) {
                    selectionTrackerLeft = hostWidth - scrollWidth - leftArrowWidth - rightArrowWidth + parseInt(this._titleList[this._selectedItem].position().left);
                }
            }
            this._performScrollAnimation(left, selectionTrackerLeft, duration);
        },

        _scrollLeft: function (duration, callback) {
            this._unorderedList.stop();
            this._unlockAnimation('unorderedList')
            var unorderedListLeft = parseInt(this._unorderedList.css('left')),
                trackerDisplacement = this._getArrowsDisplacement(),
                left = 0,
                selectionTrackerLeft = undefined;
            //Calculating animation's parameters
            duration = (this.enableScrollAnimation) ? duration : 0;
            if (parseInt(this._headerWrapper.width()) >= parseInt(this._unorderedList.width())) {
                left = trackerDisplacement;
            } else if (unorderedListLeft + this.scrollStep < trackerDisplacement) {
                left = unorderedListLeft + this.scrollStep;
                selectionTrackerLeft = unorderedListLeft + this.scrollStep + parseInt(this._titleList[this._selectedItem].position().left);
            } else {
                left = trackerDisplacement;
                //Making this check because jQuery(selector).position().left is giving different results
                if (left < parseInt(this._unorderedList.css('left')) - 4 &&
                    left > parseInt(this._unorderedList.css('left')) + 4) {
                    selectionTrackerLeft = parseInt(this._titleList[this._selectedItem].position().left);
                }
            }
            this._performScrollAnimation(left, selectionTrackerLeft, duration);
        },

        _performScrollAnimation: function (left, selectionTrackerLeft, duration) {
            var self = this;
            if (selectionTrackerLeft !== undefined) {
                this._moveSelectionTrack(this._selectedItem, 0, selectionTrackerLeft);
            }
            this._lockAnimation('unorderedList');

            this._unorderedList.animate({ 'left': left }, duration, function () {
                self._moveSelectionTrack(self.selectedItem, 0);
                self._unlockAnimation('unorderedList');
            });
        },

        _addKeyboardHandlers: function () {
            var self = this;
            if (this.keyboardNavigation) {
                this.addHandler(this.host, 'keydown', function (event) {
                    if (!self._activeAnimation()) {
                        var selectedItem = self._selectedItem;
                        var tracker = self.selectionTracker;
                        //     self.selectionTracker = false;
                        var content = self.getContentAt(selectedItem);
                        if ($(event.target).ischildof(content)) {
                            return true;
                        }

                        switch (event.keyCode) {
                            case 37:    //left arrow
                                if (self.rtl) self.next();
                                else {
                                    self.previous();
                                }
                                return false;
                            case 39:    //right arrow
                                if (self.rtl) self.previous();
                                else {
                                    self.next();
                                }
                                return false;
                            case 36:    //home
                                self.first();
                                return false;
                            case 35:    //end
                                self.last();
                                return false;
                            case 27:
                                if (self._tabCaptured) {
                                    self._cancelClick = true;
                                    self._uncapture(null, self.selectedItem);
                                    self._tabCaptured = false;
                                }
                                break;
                        }
                        self.selectionTracker = tracker;
                    }
                    return true;
                });
            }
        },

        _addScrollHandlers: function () {
            var self = this;
            this.addHandler(this._leftArrow, 'mousedown', function () {
                self._startScrollRepeat(true, self.scrollAnimationDuration);
            });
            this.addHandler(this._rightArrow, 'mousedown', function () {
                self._startScrollRepeat(false, self.scrollAnimationDuration);
            });
            this.addHandler(this._rightArrow, 'mouseleave', function () {
                clearTimeout(self._scrollTimeout);
            });
            this.addHandler(this._leftArrow, 'mouseleave', function () {
                clearTimeout(self._scrollTimeout);
            });
            this.addHandler($(document), 'mouseup.tab' + this.element.id, this._mouseUpScrollDocumentHandler, this);
            this.addHandler($(document), 'mouseleave.tab' + this.element.id, this._mouseLeaveScrollDocumentHandler, this);
        },

        _mouseLeaveScrollDocumentHandler: function (event) {
            var self = event.data;
            clearTimeout(self._scrollTimeout);
        },

        _mouseUpScrollDocumentHandler: function (event) {
            var self = event.data;
            clearTimeout(self._scrollTimeout);
        },

        _mouseUpDragDocumentHandler: function (event) {
            var self = event.data;
            if (self._tabCaptured && self._dragStarted) {
                self._uncapture(event);
            }
            self._tabCaptured = false;
        },

        _addReorderHandlers: function () {
            var self = this;
            this.addHandler($(document), 'mousemove.tab' + this.element.id, this._moveElement, this);
            this.addHandler($(document), 'mouseup.tab' + this.element.id, this._mouseUpDragDocumentHandler, this);
        },

        _addEventHandlers: function () {
            var count = this.length();
            while (count) {
                count--;
                this._addEventListenerAt(count);
            }

            if (this.keyboardNavigation) {
                this._addKeyboardHandlers();
            }
            if (this.scrollable) {
                this._addScrollHandlers();
            }
            if (this.reorder && !this._isTouchDevice) {
                this._addReorderHandlers();
            }
            var me = this;
            try
            {
                if (document.referrer != "" || window.frameElement) {
                    if (window.top != null && window.top != window.self) {
                        var eventHandle = function (event) {
                            if (me._tabCaptured) {
                                me._cancelClick = true;
                                me._uncapture(null, me.selectedItem);
                                me._tabCaptured = false;
                            }
                        };
                        var parentLocation = null;
                        if (window.parent && document.referrer) {
                            parentLocation = document.referrer;
                        }

                        if (parentLocation && parentLocation.indexOf(document.location.host) != -1) {
                            if (window.top.document) {
                                this.addHandler($(window.top.document), 'mouseup', eventHandle);
                            }
                        }
                    }
                }
            }
            catch (error) {
            }
        },

        focus: function () {
            try {
                this.host.focus();
            }
            catch (error) {
            }
        },

        _getFocusedItem: function (mouseX, mouseY) {
            var count = this.length();
            while (count) {
                count--;
                var currentElement = this._titleList[count],
                    currentElementWidth = parseInt(currentElement.outerWidth(true)),
                    currentElementX = parseInt(currentElement.offset().left),
                    unorderedListX = parseInt(this._unorderedList.offset().left),
                    hostX = parseInt(this.host.offset().left),
                    currentElementAbsoluteX = currentElementX;
                if ((currentElementAbsoluteX <= mouseX &&
                    currentElementAbsoluteX + currentElementWidth >= mouseX) &&
                    (currentElement !== this._capturedElement) &&
                    (!this._titleList[count].locked) &&
                    (this._titleList[count].disabled !== true)) {
                    return count;
                }
            }

            return -1;
        },

        _uncapture: function (event) {
            var trackerBackup = this.selectionTracker;
            this._unorderedListLeftBackup = this._unorderedList.css('left');
            this._dragStarted = false;
            this._tabCaptured = false;
            var capturedIndex = this._indexOf(this._capturedElement);
            if (!this._capturedElement) return;
            switch (this.position) {
                case 'top':
                    this._capturedElement.css('bottom', 0);
                    break;
                case 'bottom':
                    this._capturedElement.css('top', 0);
                    break;
            }
            if (event) {
                var mouseOverElementIndex = this._getFocusedItem(event.clientX, event.clientY);
            }
            if (mouseOverElementIndex === -1 || !event) {
                this._capturedElement.css('left', 0);
            } else {
                this._raiseEvent(10, { item: capturedIndex, dropIndex: mouseOverElementIndex });
                this._reorderItems(mouseOverElementIndex, capturedIndex);
            }

            $.each(this._titleList, function () {
                this.css('position', 'static');
            });

            this._reorderHeaderElements();
            this._unorderedList.css({
                'position': 'relative',
                'top': '0px'
            });

            this._prepareTabs();

            if (mouseOverElementIndex === -1 || !event) {
                this._selectedItem = capturedIndex;
                this._moveSelectionTrack(capturedIndex, 0);
                this._addSelectStyle(this._selectedItem, true);
            }
            else {
                this._moveSelectionTrack(this._selectedItem, 0);
                this._addSelectStyle(this._selectedItem, true);
            }

            if (document.selection) {
                document.selection.clear();
            }
            this._unorderedList.css('left', this._unorderedListLeftBackup);
            this.selectionTracker = trackerBackup;
        },

        _reorderItems: function (mouseOverElementIndex, capturedIndex) {
            var selectedItem = this._titleList[this.selectedItem];
            var capturedContent = this._contentList[capturedIndex];
            if (typeof this._capturedElement === 'undefined') {
                this._capturedElement = this._titleList[capturedIndex];
            }
            //Visible reorder
            this._titleList[capturedIndex].remove();
            if (capturedIndex < mouseOverElementIndex) {
                this._titleList[capturedIndex].insertAfter(this._titleList[mouseOverElementIndex]);
            } else {
                this._titleList[capturedIndex].insertBefore(this._titleList[mouseOverElementIndex]);
            }
            this._reorderElementArrays(mouseOverElementIndex, capturedIndex);
            this._getSelectedItem(selectedItem);
            this._removeEventHandlers();
            this._addEventHandlers();
        },

        _reorderElementArrays: function (mouseOverElementIndex, capturedIndex) {
            //Reordering in the collections and correcting the event handlers
            var selectedItem = this._titleList[this.selectedItem];
            var capturedContent = this._contentList[capturedIndex];
            if (capturedIndex < mouseOverElementIndex) {
                for (var i = capturedIndex; i <= mouseOverElementIndex; i++) {
                    this._titleList[i] = this._titleList[i + 1];
                    this._contentList[i] = this._contentList[i + 1];
                }
                this._contentList[mouseOverElementIndex] = capturedContent;
                this._titleList[mouseOverElementIndex] = this._capturedElement;
            } else {
                for (var i = capturedIndex; i >= mouseOverElementIndex; i--) {
                    this._titleList[i] = this._titleList[i - 1];
                    this._contentList[i] = this._contentList[i - 1];
                }
                this._contentList[mouseOverElementIndex] = capturedContent;
                this._titleList[mouseOverElementIndex] = this._capturedElement;
            }
        },

        getSelectedItem: function () {
            return this.selectedItem;
        },

        _getSelectedItem: function (selectedItem) {
            //Getting selected item
            var count = this.length();
            while (count) {
                count--;
                if (this._titleList[count] === selectedItem) {
                    this._selectedItem = this.selectedItem = count;
                    break;
                }
            }
        },

        _moveElement: function (event, self) {
            var self = event.data;
            if (self._tabCaptured) {
                if (document.selection) {
                    document.selection.clear();
                }
                if (!self._dragStarted) {
                    unorderedListLeft = -parseInt(self._unorderedList.css('left'), 10);

                    if (event.clientX + unorderedListLeft > self._startX + 3 || event.clientX + unorderedListLeft < self._startX - 3) {
                        self._prepareTabForDragging();
                        self._dragStarted = true;
                    }
                } else {
                    self._performDrag(event);
                    clearTimeout(self._scrollTimeout);
           //         self._dragScroll(event);
                }
            }
        },

        _performDrag: function (event) {
            var zoomFactor = this.getZoomFactor();
            unorderedListLeft = -parseInt(this._unorderedList.css('left'), 10);

            this._capturedElement.css('left', unorderedListLeft + event.clientX / zoomFactor - this._startX / zoomFactor);
            this._lastX = event.clientX / zoomFactor;
            this._moveSelectionTrack(this.selectedItem, 0);
        },

        getZoomFactor: function () {
            var factor = 1;
            if (document.body.getBoundingClientRect) {
                // rect is only in physical pixel size in IE before version 8 
                var rect = document.body.getBoundingClientRect();
                var physicalW = rect.right - rect.left;
                var logicalW = document.body.offsetWidth;

                // the zoom level is always an integer percent value
                factor = Math.round((physicalW / logicalW) * 100) / 100;
            }
            return factor;
        },

        _prepareTabForDragging: function () {
            this._capturedElement.css({
                position: 'relative',
                left: '0px',
                top: '0px',
                'z-index': '300'
            });
            this.selectedItem = this._indexOf(this._capturedElement);

            switch (this.position) {
                case 'top':
                    this._capturedElement.css('bottom', parseInt(this._capturedElement.css('top')));
                    break;
                case 'bottom':
                    this._capturedElement.css('top', parseInt(this._capturedElement.css('top')));
                    break;
            }
            this._raiseEvent(9, { item: this._indexOf(this._capturedElement) });
        },

        _dragScroll: function (event) {
            var lastUnorderedListPosition = parseInt(this._unorderedList.css('left'));
            var self = this;
            var capturedElementLeft = parseInt(this._capturedElement.css('left'));
            if (event.clientX <= this._headerWrapper.offset().left) {
                this._scrollLeft(this.scrollAnimationDuration);
                this._capturedElement.css('left',
                    parseInt(this._capturedElement.css('left')) +
                    this._lastUnorderedListPosition - lastUnorderedListPosition);
            } else if (event.clientX > this._headerWrapper.offset().left + parseInt(this._headerWrapper.width(), 10)) {
                this._scrollRight(this.scrollAnimationDuration);
                this._capturedElement.css('left',
                    parseInt(this._capturedElement.css('left')) +
                    this._lastUnorderedListPosition - lastUnorderedListPosition);
            } else {
                this._unorderedList.stop();
                this._unlockAnimation('unorderedList');
                clearTimeout(this._scrollTimeout);
            }
            var self = this;
            this._scrollTimeout = setTimeout(function () {
                self._dragScroll(event);
            }, this.scrollAnimationDuration);
            this._lastUnorderedListPosition = lastUnorderedListPosition;
        },

        _captureElement: function (event, index) {
            if (!this._tabCaptured &&
                !this._titleList[index].locked &&
                 this._titleList[index].disabled !== true &&
                 !this._activeAnimation()) {
                unorderedListLeft = -parseInt(this._unorderedList.css('left'), 10);

                this._startX = unorderedListLeft + event.clientX;
                this._startY = event.clientY;
                this._lastX = event.clientX;
                this._lastY = event.clientY;
                this._tabCaptured = true;
                this._capturedElement = this._titleList[index];
            }
        },

        _titleInteractionTrigger: function (index) {
            //Used for removing expand/collapse border fix
            if (this._headerExpandingBalance > 0) {
                this._removeOppositeBorder();
            }
            /////////////////////////////////////////////
            if (this._selectedItem !== index) {
                this.select(this._titleList[index], 'toggle');
                //If an item have been collapsed and we want to select it
                //before the selection we are uncollapsing the item
                this._titleList[index].collapsed = false;
                if (!this.collapsible) {
                    if (this.height !== 'auto') {
                        this._contentWrapper.css('visibility', 'visible');
                    } else {
                        this._contentWrapper.css('display', 'block');
                    }
                }
            } else if (this.collapsible) {
                if (this.isCollapsed) {
                    this.expand();
                } else {
                    this.collapse();
                }
            }
        },

        //Collapsing the current selected item.
        collapse: function () {
            var index = this._selectedItem,
                self = this;
            this.isCollapsed = true;
            // if (!this._titleList[index].collapsed) {
            //     this._titleList[index].collapsed = true;
            if (self.height !== 'auto') {
                self._contentWrapper.css('visibility', 'hidden');
            } else {
                self._contentWrapper.hide();
            }
            self._raiseEvent(13, { item: index });
            if (this.position == 'top') {
                self._headerWrapper.addClass(this.toThemeProperty('jqx-tabs-header-collapsed'));
                self.host.addClass(this.toThemeProperty('jqx-tabs-collapsed'));
            }
            else {
                self._headerWrapper.addClass(this.toThemeProperty('jqx-tabs-header-collapsed-bottom'));
                self.host.addClass(this.toThemeProperty('jqx-tabs-collapsed-bottom'));
            }
        },

        //Expanding the current selected item.
        expand: function () {
            var index = this._selectedItem,
                self = this;
            this.isCollapsed = false;
            //     if (this._titleList[index].collapsed) {
            //       this._titleList[index].collapsed = false;
            this._select(index, self.contentTransitionDuration, null, false, true);
            //Depend on the widget's height we are changing the display or visibility property
            if (self.height !== 'auto') {
                self._contentWrapper.css('visibility', 'visible');
            } else {
                self._contentWrapper.show();
            }
            self._raiseEvent(14, { item: index });
            if (this.position == 'top') {
                self._headerWrapper.removeClass(this.toThemeProperty('jqx-tabs-header-collapsed'));
                self.host.removeClass(this.toThemeProperty('jqx-tabs-collapsed'));
            }
            else {
                self._headerWrapper.removeClass(this.toThemeProperty('jqx-tabs-header-collapsed-bottom'));
                self.host.removeClass(this.toThemeProperty('jqx-tabs-collapsed-bottom'));
            }
        },

        _addSelectHandler: function (index) {
            var self = this;
            this.addHandler(this._titleList[index], 'selectstart', function (index) {
                return false;
            });

            this.addHandler(this._titleList[index], this.toggleMode, function (index) {
                return function () {
                    self._raiseEvent('15', { item: index });
                    if (!self._tabCaptured && !self._cancelClick) {
                        self._titleInteractionTrigger(index);
                    }
                    return true;
                }

            } (index));
        },

        _addDragDropHandlers: function (index) {
            var self = this;
            this.addHandler(this._titleList[index], 'mousedown', function (event) {
                self._captureElement(event, index);
                return false;
            });

            this.addHandler(this._titleList[index], 'mouseup', function (event) {
                if (self._tabCaptured && self._dragStarted) {
                    self._cancelClick = true;
                    self._uncapture(event, index);
                } else {
                    self._cancelClick = false;
                }
                self._tabCaptured = false;
                return false;
            });
        },

        _removeHoverStates: function () {
            var self = this;
            $.each(this._titleList, function () {
                this.removeClass(self.toThemeProperty('jqx-tabs-title-hover-top'));
                this.removeClass(self.toThemeProperty('jqx-tabs-title-hover-bottom'));
            });
        },

        _addHoverHandlers: function (index) {
            var self = this;
            var item = this._titleList[index];

            this.addHandler(item, 'mouseenter', function (event) {
                if (index != self._selectedItem) {
                    if (self.position == 'top') {
                        item.addClass(self.toThemeProperty('jqx-tabs-title-hover-top'));
                    }
                    else {
                        item.addClass(self.toThemeProperty('jqx-tabs-title-hover-bottom'));
                    }
                    item.addClass(self.toThemeProperty('jqx-fill-state-hover'));

                    if (self.showCloseButtons) {
                        var closeButton = item.children(0).children(self.toThemeProperty('.jqx-tabs-close-button', true));
                        closeButton.addClass(self.toThemeProperty('jqx-tabs-close-button-hover', true));
                    }
                }
            });

            this.addHandler(item, 'mouseleave', function (event) {
                if (index != self._selectedItem) {
                    if (self.position == 'top') {
                        item.removeClass(self.toThemeProperty('jqx-tabs-title-hover-top'));
                    }
                    else {
                        item.removeClass(self.toThemeProperty('jqx-tabs-title-hover-bottom'));
                    }
                    item.removeClass(self.toThemeProperty('jqx-fill-state-hover'));
                    if (self.showCloseButtons) {
                        var closeButton = item.children(0).children(self.toThemeProperty('.jqx-tabs-close-button', true));
                        closeButton.removeClass(self.toThemeProperty('jqx-tabs-close-button-hover', true));
                    }
                }
            });
        },

        _addEventListenerAt: function (index) {
            var self = this;
            if (this._titleList[index].disabled) return;
            if (this.reorder && !this._isTouchDevice) {
                this._addDragDropHandlers(index);
            }
            this._addSelectHandler(index);
            if (this.enabledHover) {
                this._addHoverHandlers(index);
            }
            var closeButton = this._titleList[index].find(this.toThemeProperty('.jqx-tabs-close-button', true));
            this.removeHandler(closeButton, 'click');
            this.addHandler(closeButton, 'click', function (event) {
                self.removeAt(index);
                return false;
            });
        },

        _removeEventHandlers: function () {
            var self = this;
            var count = this.length();
            while (count) {
                count--;
                this._removeEventListenerAt(count);
            }
            if (this.scrollable) {
                this.removeHandler(this._leftArrow, 'mousedown');
                this.removeHandler(this._rightArrow, 'mousedown');
            }
            this.removeHandler($(document), 'mousemove.tab' + this.element.id, this._moveElement);
            this.removeHandler($(document), 'mouseup.tab' + this.element.id, this._mouseUpScrollDocumentHandler);
            this.removeHandler($(document), 'mouseup.tab' + this.element.id, this._mouseUpDragDocumentHandler);
            this.removeHandler(this.host, 'keydown');
        },

        _removeEventListenerAt: function (index) {
            var self = this;
            this.removeHandler(this._titleList[index], this.toggleMode);
            this.removeHandler(this._titleList[index], 'mouseenter');
            this.removeHandler(this._titleList[index], 'mouseleave');
            this.removeHandler(this._titleList[index], 'mousedown');
            this.removeHandler(this._titleList[index], 'mouseup');
            var closeButton = this._titleList[index].children(0).children(this.toThemeProperty('.jqx-tabs-close-button', true));
            this.removeHandler(closeButton, 'click');
        },

        _moveSelectionTrack: function (item, duration, left) {
            var self = this;
            if (item == -1)
                return;

            if (this._titleList.length == 0)
                return;

            if (item >= this._titleList.length)
                return;

            if (this.selectionTracker) {
                this._selectionTracker.stop();
                this._unlockAnimation('selectionTracker');
                if (left === undefined) {
                    var leftDisplacement = parseInt(this._titleList[item].position().left);
                    if (!isNaN(parseInt(this._unorderedList.css('left')))) {
                        leftDisplacement += parseInt(this._unorderedList.css('left'));
                    }
                    if (!isNaN(parseInt(this._unorderedList.css('margin-left')))) {
                        leftDisplacement += parseInt(this._unorderedList.css('margin-left'));
                    }
                    if (!isNaN(parseInt(this._titleList[item].css('margin-left')))) {
                        leftDisplacement += parseInt(this._titleList[item].css('margin-left'));
                    }
                    if (!isNaN(parseInt(this._titleList[item].css('margin-right')))) {
                        //        leftDisplacement += parseInt(this._titleList[item].css('margin-right'));
                    }
                } else {
                    var leftDisplacement = left;
                }
                var topDisplacement = 0;
                var heightDifference = 0;
                if (this.position === 'top') {
                    topDisplacement = parseInt(this._headerWrapper.height()) - parseInt(this._titleList[item].outerHeight())
                    if (!this.autoHeight) {
                        heightDifference += parseInt(this._titleList[item].css('margin-top'));
                    }
                }
                this._lockAnimation('selectionTracker');

                // outerWidth includes the margin-right for some reason.
                // Use this instead: this._titleList[item].width() + this._titleList[item].css('padding-left') + this._titleList[item].css('padding-right');

                var horizontalPadding = parseInt(this._titleList[item].css('padding-left')) + parseInt(this._titleList[item].css('padding-right'));

                // the selected item's bottom border should be 0.
                var topOffset = this.position == 'top' ? 0 : 1;
                var headerPadding = parseInt(this._headerWrapper.css('padding-top')); // -parseInt(this._headerWrapper.css('padding-bottom'));
                var itemPadding = parseInt(this._titleList[item].css('padding-top')) + parseInt(this._titleList[item].css('padding-bottom'));
                this._selectionTracker.css('visibility', 'visible');
                this._moveSelectionTrackerContainer.css('visibility', 'visible');
                var topMargin = parseInt(this._titleList[item].css('margin-top'));
                if (isNaN(topMargin))
                    topMargin = 0;

                this._selectionTracker.animate({
                    'top': headerPadding + topMargin - topOffset, 'left': leftDisplacement + 'px',
                    'height': parseInt(this._titleList[item].height() + itemPadding), 'width': this._titleList[item].width() + horizontalPadding
                }, duration, function () {
                    self._unlockAnimation('selectionTracker');
                    self._selectionTracker.css('visibility', 'hidden');
                    self._addSelectStyle(item, true);
                    self._moveSelectionTrackerContainer.css('visibility', 'hidden');
                });
            }
        },

        destroy: function () {
            this.host.remove();
        },

        _switchTabs: function (selectIndex, unselectIndex) {
            if (selectIndex !== unselectIndex && !this._activeAnimation() && !this._tabCaptured) {
                var self = this;
                //Triggering unselecting and selecting events first because they could be canceled by the user
                this._raiseEvent(7, { item: unselectIndex });
                this._raiseEvent(6, { item: selectIndex });
                //Check if the event is canceled
                if (this._currentEvent) {
                    if (this._currentEvent.cancel) {
                        this._currentEvent = null;
                        return;
                    }
                }

                this._unselect(unselectIndex, null, true);
                this._select(selectIndex, self.contentTransitionDuration, null, true);
                return true;
            }
            return false;
        },

        _activeAnimation: function () {

            for (child in this._isAnimated) {
                if (this._isAnimated.hasOwnProperty(child)) {
                    if (this._isAnimated[child]) {
                        return true;
                    }
                }
            }
            return false;
        },

        _indexOf: function (item) {
            var count = this.length();
            while (count) {
                count--;
                if (this._titleList[count][0] === item[0] ||
                    this._contentList[count][0] === item[0]) {
                    return count;
                }
            }
            return -1;
        },

        _validateProperties: function () {
            try {
                if (this.scrollAnimationDuration < 0 || isNaN(this.scrollAnimationDuration)) {
                    throw new Error(this._invalidArgumentExceptions['invalidScrollAnimationDuration']);
                }
                if (parseInt(this.width) < 0 && this.width !== 'auto') {
                    throw new Error(this._invalidArgumentExceptions['invalidWidth']);
                }
                if (parseInt(this.height) < 0 && this.height !== 'auto') {
                    throw new Error(this._invalidArgumentExceptions['invalidHeight']);
                }
                if (this.animationType !== 'none' && this.animationType !== 'fade') {
                    throw new Error(this._invalidArgumentExceptions['invalidAnimationType']);
                }
                if (this.contentTransitionDuration < 0 || isNaN(this.contentTransitionDuration)) {
                    throw new Error(this._invalidArgumentExceptions['invalidcontentTransitionDuration']);
                }
                if (this.toggleMode !== 'click' && this.toggleMode !== 'dblclick' &&
                this.toggleMode !== 'mouseenter' && this.toggleMode !== 'none') {
                    throw new Error(this._invalidArgumentExceptions['invalidToggleMode']);
                }
                if (this.position !== 'top' && this.position !== 'bottom') {
                    throw new Error(this._invalidArgumentExceptions['invalidPosition']);
                }
                if (this.scrollPosition !== 'left' && this.scrollPosition !== 'right' && this.scrollPosition !== 'both') {
                    throw new Error(this._invalidArgumentExceptions['invalidScrollPosition']);
                }
                if (this.scrollStep < 0 || isNaN(this.scrollStep)) {
                    throw new Error(this._invalidArgumentExceptions['invalidScrollStep']);
                }
                if (this._titleList.length !== this._contentList.length || this._titleList.length == 0) {
                    throw new Error(this._invalidArgumentExceptions['invalidStructure']);
                }
                if (this.arrowButtonSize < 0 || isNaN(this.arrowButtonSize)) {
                    throw new Error(this._invalidArgumentExceptions['invalidArrowSize']);
                }
                if (this.closeButtonSize < 0 || isNaN(this.closeButtonSize)) {
                    throw new Error(this._invalidArgumentExceptions['invalidCloseSize']);
                }
            } catch (exception) {
                alert(exception);
            }
        },

        _startScrollRepeat: function (isLeft, timeout) {
            var self = this;

            if (isLeft) {
                this._scrollLeft(timeout);
            }
            else {
                this._scrollRight(timeout);
            }

            if (this._scrollTimeout) clearTimeout(this._scrollTimeout);
            this._scrollTimeout = setTimeout(function () {
                self._startScrollRepeat(isLeft, self.scrollAnimationDuration)
            }, timeout);
        },

        _performLayout: function () {
            var count = this.length();
            while (count) {
                count--;
                if (this.position === 'top' ||
                    this.position === 'bottom') {
                    if (this.rtl) {
                        this._titleList[count].css('float', 'right');
                    }
                    else {
                        this._titleList[count].css('float', 'left');
                    }
                }
            }

            this._fitToSize();
            this._performHeaderLayout();
            this._fitToSize();
        },

        updatetabsheader: function () {
            this._performHeaderLayout();
        },

        _performResize: function () {
            var me = this;
            this._fitToSize();
            this._positionArrows(this._totalItemsWidth);
            if (this._totalItemsWidth > this.host.width()) {
                this._unorderedList.width(this._totalItemsWidth);
            }
            else {
                this._unorderedList.width(this.host.width() - 2);
            }
            this._fitToSize();
        },

        _addArrows: function () {
            if (this._leftArrow && this._rightArrow) {
                this._leftArrow.remove();
                this._rightArrow.remove();
            }
            this._leftArrow = $('<div><span style="display: block; width: 16px; height: 16px;" class="' + this.toThemeProperty('jqx-tabs-arrow-left') + '"></span></div>');
            this._rightArrow = $('<div><span style="display: block; width: 16px; height: 16px;" class="' + this.toThemeProperty('jqx-tabs-arrow-right') + '"></span></div>');
            this._leftArrow.addClass(this.toThemeProperty('jqx-tabs-arrow-background'));
            this._rightArrow.addClass(this.toThemeProperty('jqx-tabs-arrow-background'));
            this._leftArrow.addClass(this.toThemeProperty('jqx-widget-header'));
            this._rightArrow.addClass(this.toThemeProperty('jqx-widget-header'));

            this._headerWrapper.append(this._leftArrow);
            this._headerWrapper.append(this._rightArrow);
            this._leftArrow.width(this.arrowButtonSize);
            this._leftArrow.height('100%');
            this._rightArrow.width(this.arrowButtonSize);
            this._rightArrow.height('100%');

            //     this._leftArrow.append('<img style="border: 0; margin: 0; pading: 0; outline: 0; with: ' + this.arrowButtonSize + 'px; height: ' + this.arrowButtonSize + 'px;" src="' + this._getImageUrl(this._leftArrow) + '" />');
            //   this._rightArrow.append('<img style="border: 0; margin: 0; pading: 0; outline: 0; with: ' + this.arrowButtonSize + 'px; height: ' + this.arrowButtonSize + 'px;" src="' + this._getImageUrl(this._rightArrow) + '" />');
            this._leftArrow.css({
                //             'background-image': 'none',
                'z-index': '30'
            });
            this._rightArrow.css({
                //               'background-image': 'none',
                'z-index': '30'
            });

            this._leftArrow.css('display', 'none');
            this._rightArrow.css('display', 'none');
        },

        _tabsWithVisibleCloseButtons: function () {
            if (!this.showCloseButtons)
                return 0;

            var count = this.length();

            var me = this;
            $.each(this._titleList, function () {
                var hasCloseButton = this.attr('hasclosebutton');
                if (hasCloseButton != undefined && hasCloseButton != null) {
                    if (hasCloseButton == 'false' || hasCloseButton == false) {
                        count--;
                    }
                }
            });

            return count;
        },

        _calculateTitlesSize: function () {
            var maxItemHeight = 0;
            var totalItemsWidth = 0;
            var count = this.length();

            if (this.rtl && $.jqx.browser.msie && $.jqx.browser.version < 8) {
                this._measureItem = $("<span style='position: relative; visibility: hidden;'></span>");
                $(document.body).append(this._measureItem);
            }

            while (count) {
                count--;
                //To calculate unordered list's children width sum correctly (to prevent from differences in the MSIE and other browsers
                //because of the image size) firstly we are hiding the close button, calculating the width and after that showing it if necessary
                if (this._measureItem) {
                    this._measureItem.html(this._titleList[count].html());
                    this._titleList[count].width(this._measureItem.width());
                }

                this._titleList[count].css('position', 'static');

                this._titleList[count].find(this.toThemeProperty('.jqx-tabs-close-button', true)).css('display', 'none');
                totalItemsWidth += parseInt(this._titleList[count].outerWidth(true));

                if (maxItemHeight < this._titleList[count].outerHeight(true)) {
                    maxItemHeight = Math.round(parseInt(this._titleList[count].outerHeight(true)));
                }
                if (this._titleList[count].height() == 0) {
                    var clone = this._titleList[count].clone();
                    $(document.body).append(clone);
                    maxItemHeight = Math.round(parseInt(clone.outerHeight(true)));
                    clone.remove();
                }

                var hasCloseButton = this._titleList[count].attr('hasCloseButton');
                if (hasCloseButton != undefined && hasCloseButton != null) {
                    var processed = false;
                    if (this.hiddenCloseButtons) {
                        if (this.hiddenCloseButtons[count] == 1) {
                            this._titleList[count].find(this.toThemeProperty('.jqx-tabs-close-button', true)).css('display', 'none');
                            processed = true;
                        }
                    }
                    if (!processed) {
                        if (hasCloseButton == 'true' || hasCloseButton == true) {
                            totalItemsWidth += this.closeButtonSize;
                            this._titleList[count].find(this.toThemeProperty('.jqx-tabs-close-button', true)).css('display', 'block');
                        }
                        else if (hasCloseButton == 'false' || hasCloseButton == false) {
                            this._titleList[count].find(this.toThemeProperty('.jqx-tabs-close-button', true)).css('display', 'none');
                        }
                    }
                }
                else {
                    if (this.showCloseButtons && (this.canCloseAllTabs || this._tabsWithVisibleCloseButtons() > 1)) {
                        var processed = false;
                        if (this.hiddenCloseButtons) {
                            if (this.hiddenCloseButtons[count] == 1) {
                                this._titleList[count].find(this.toThemeProperty('.jqx-tabs-close-button', true)).css('display', 'none');
                                processed = true;
                            }
                        }
                        if (!processed) {
                            totalItemsWidth += this.closeButtonSize;
                            this._titleList[count].find(this.toThemeProperty('.jqx-tabs-close-button', true)).css('display', 'block');
                        }
                    }
                }

                this._titleList[count].height(this._titleList[count].height());
            }

            if (this._measureItem) {
                this._measureItem.remove();
            }

            return { height: maxItemHeight, width: 10 + totalItemsWidth };
        },

        _reorderHeaderElements: function () {
            if (this.selectionTracker) {
                this._moveSelectionTrackerContainer.css({
                    'position': 'absolute',
                    'height': '100%', //this._headerWrapper.outerHeight(true),
                    'top': '0px',
                    'left': '0px',
                    'width': '100%'
                });
            }
            this._headerWrapper.css({
                'position': 'relative',
                'left': '0px',
                'top': '0px'
            });

            if (this.scrollable) {
                this._rightArrow.css({
                    'width': this.arrowButtonSize,
                    'position': 'absolute',
                    'top': '0px'
                });
                this._leftArrow.css({
                    'width': this.arrowButtonSize,
                    'position': 'absolute',
                    'top': '0px'
                });
                var _margin = this.theme && this.theme.indexOf('ui-') != -1 ? 3 : 0;
                if (_margin > 0) {
                    this._rightArrow.addClass(this.toThemeProperty('jqx-rc-r'));
                    this._leftArrow.addClass(this.toThemeProperty('jqx-rc-l'));
                }
                var position = this.scrollPosition;
                if (this.rtl) {
                    if (position == 'left') position = 'right';
                    if (position == 'right') position = 'left';
                }

                switch (position) {
                    case 'both':
                        this._rightArrow.css('right', '0px');
                        this._leftArrow.css('left', '0px');
                        break;
                    case 'left':
                        this._rightArrow.css('left', this.arrowButtonSize + 'px');
                        this._leftArrow.css('left', '0px');
                        break;
                    case 'right':
                        this._rightArrow.css('right', -_margin + 'px');
                        this._leftArrow.css('right', (this.arrowButtonSize - _margin) + 'px');
                        break;
                }
            }
        },

        _positionArrows: function (totalItemsWidth) {
            if (totalItemsWidth >= parseInt(this._headerWrapper.width()) && this.scrollable) {
                this._needScroll = true;
                //When the arrows are invisible and after that they become visible
                if (this._unorderedList.position().left === 0) {
                    this._unorderedListLeftBackup = this._getArrowsDisplacement() + 'px';
                }
                this._leftArrow.css('display', 'block');
                this._rightArrow.css('display', 'block');
            } else {
                this._needScroll = false;
                this._leftArrow.css('display', 'none');
                this._rightArrow.css('display', 'none');
                this._unorderedList.css('left', 0);
            }
        },

        _performHeaderLayout: function () {
            this._removeSelectStyle();
            var size = this._calculateTitlesSize();
            var maxItemHeight = size.height;
            var totalItemsWidth = size.width;
            this._headerWrapper.height(maxItemHeight);
            this._unorderedList.height(maxItemHeight);
            if (this.headerHeight != null && this.headerHeight != 'auto') {
                this._headerWrapper.height(this.headerHeight);
                this._unorderedList.height(this.headerHeight);
            }
            if (totalItemsWidth > this.host.width()) {
                this._unorderedList.width(totalItemsWidth);
            }
            else {
                this._unorderedList.width(this.host.width());
            }
            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                this._unorderedList.css('position', 'relative');
                this._headerWrapper.css('overflow', 'hidden');
            }

            this._reorderHeaderElements();
            totalItemsWidth = totalItemsWidth + parseInt(this._unorderedList.css('margin-left'));
            this._totalItemsWidth = totalItemsWidth;
            this._positionArrows(totalItemsWidth);
            this._unorderedList.css({
                'position': 'relative',
                'top': '0px'
            });
            this._verticalAlignElements();
            this._moveSelectionTrack(this._selectedItem, 0);
            this._addSelectStyle(this.selectedItem);
        },

        _verticalAlignElements: function () {
            var count = this.length();
            var maxHeightTab = this._maxHeightTab();
            while (count) {
                count--;
                var textWrapper = this._titleList[count].find('.jqx-tabs-titleContentWrapper'),
                                textWrapperHeight = textWrapper.height(),
                                closeButtonWrapper = this._titleList[count].find(this.toThemeProperty('.jqx-tabs-close-button', true)),
                                padding = parseInt(this._titleList[count].css('padding-top'));
                if (!padding) {
                    padding = 0;
                }
                if (this.autoHeight) {
                    var difference = this._titleList[count].outerHeight(true) - this._titleList[count].height();
                    //          this._titleList[count].height(parseInt(this._titleList[maxHeightTab].height()));
                    var topPadding = parseInt(this._titleList[count].css('padding-top'));
                    var bottomPadding = parseInt(this._titleList[count].css('padding-bottom'));
                    var topBorder = parseInt(this._titleList[count].css('border-top-width'));
                    var bottomBorder = parseInt(this._titleList[count].css('border-bottom-width'));
                    //      this._titleList[count].height('100%');
                    this._titleList[count].height(this._unorderedList.outerHeight() - topPadding - bottomPadding - topBorder - bottomBorder);
                    //           this._titleList[count].css('margin-top', 0);
                } else {
                    if (this.position === 'top') {
                        var margin = parseInt(this._unorderedList.height()) - parseInt(this._titleList[count].outerHeight(true));
                        if (parseInt(this._titleList[count].css('margin-top')) !== margin && margin !== 0) {
                            this._titleList[count].css('margin-top', margin);
                        }
                    } else {
                        this._titleList[count].height(this._titleList[count].height());
                    }
                }
                this._titleList[count].children(0).height('100%');

                //  this._titleList[count].children(0).height(this._titleList[count].height());
                var visibleHeight = parseInt(this._titleList[count].height());
                var closeButtonWrapperMiddle = parseInt(visibleHeight) / 2 - parseInt(closeButtonWrapper.height()) / 2;
                closeButtonWrapper.css('margin-top', 1 + closeButtonWrapperMiddle);
                var textWrapperMiddle = parseInt(visibleHeight) / 2 - parseInt(textWrapper.height()) / 2;
                textWrapper.css('margin-top', textWrapperMiddle);
            }
            //Align arrow
            if (this.scrollable) {
                var difference = parseInt(this._headerWrapper.outerHeight()) - this.arrowButtonSize;
                var halfDifference = difference / 2;
                this._rightArrow.children(0).css('margin-top', halfDifference);
                this._rightArrow.height('100%');
                this._leftArrow.height('100%');
                //      this._leftArrow.height(this._leftArrow.height() - 1);
                //        this._rightArrow.height(this._rightArrow.height() - 1);

                this._leftArrow.children(0).css('margin-top', halfDifference);
            }
        },

        _getImageUrl: function (arrowContainer) {
            var imageUrl = arrowContainer.css('background-image');
            imageUrl = imageUrl.replace('url("', '');
            imageUrl = imageUrl.replace('")', '');
            imageUrl = imageUrl.replace('url(', '');
            imageUrl = imageUrl.replace(')', '');
            return imageUrl;
        },

        _fitToSize: function () {
            var percentageWidth = false;
            var percentageHeight = false;
            var me = this;
            if (me.width != null && me.width.toString().indexOf("%") != -1) {
                percentageWidth = true;
            }

            if (me.height != null && me.height.toString().indexOf("%") != -1) {
                percentageHeight = true;
            }

            if (percentageWidth) {
                this.host.css('width', this.width);
                this._contentWrapper.css('width', '100%');
            }

            if (percentageHeight) {
                this.host.css('height', this.height);
                this._contentWrapper.css('width', '100%');
                this._contentWrapper.css('height', 'auto');
                var height = this.host.height() - this._headerWrapper.outerHeight();
                this._contentWrapper.height(height); 
            }


            if (!percentageWidth) {
                //Resizing the host and content container if height or width are set
                this.host.width(this.width);

                if (this.width != 'auto') {
                    this._contentWrapper.css('width', '100%');
                }
            }
            if (!percentageHeight) {
                if (this.height !== 'auto') {
                    this.host.height(this.height);
                    var height = this.host.height() - this._headerWrapper.outerHeight(); // -parseInt(this._titleList[this._maxHeightTab()].outerHeight(true));
                    this._contentWrapper.height(height); //borderOffset
                } else {
                    this._contentWrapper.css('height', 'auto');
                }
            }
        },

        _maxHeightTab: function () {
            var count = this.length();
            var maxSize = -1;
            var returnIndex = -1;
            while (count) {
                count--;
                if (maxSize < parseInt(this._titleList[count].outerHeight(true))) {
                    returnIndex = count;
                }
            }
            return returnIndex;
        },

        _addSelectionTracker: function () {
            if (this._moveSelectionTrackerContainer) {
                this._moveSelectionTrackerContainer.remove();
            }
            this._moveSelectionTrackerContainer = $('<div class="' + this.toThemeProperty('jqx-tabs-selection-tracker-container') + '">');
            var selectionTrackerClass = this.toThemeProperty('jqx-tabs-selection-tracker-' + this.position);
            this._selectionTracker = $('<div class="' + selectionTrackerClass + '">');
            this._selectionTracker.css('color', 'inherit');
            this._moveSelectionTrackerContainer.append(this._selectionTracker);
            this._headerWrapper.append(this._moveSelectionTrackerContainer);
            this._selectionTracker.css({
                'position': 'absolute',
                'z-index': '10',
                'left': '0px',
                'top': '0px',
                'display': 'inline-block'
            });
        },

        _addContentWrapper: function () {
            //Adding content wrapper
            var floating = 'none';
            //Content wrapper

            var addWrapper = this._contentWrapper == undefined;
            this._contentWrapper = this._contentWrapper || $('<div class="' + this.toThemeProperty('jqx-tabs-content') + '" style="float:' + floating + ';">');
            this._contentWrapper.addClass(this.toThemeProperty('jqx-widget-content'));
            var count = this.length();
            while (count) {
                count--;
                this._contentList[count].addClass(this.toThemeProperty('jqx-tabs-content-element'));
            }
            if (addWrapper) {
                this.host.find('.jqx-tabs-content-element').wrapAll(this._contentWrapper);
                this._contentWrapper = this.host.find('.jqx-tabs-content');
            }
            if (this.roundedCorners) {
                if (this.position == 'top') {
                    this._contentWrapper.addClass(this.toThemeProperty('jqx-rc-b'));
                }
                else {
                    this._contentWrapper.addClass(this.toThemeProperty('jqx-rc-t'));
                }

                this.host.addClass(this.toThemeProperty('jqx-rc-all'));
            }
        },

        _addHeaderWrappers: function () {
            var count = this.length();
            this._unorderedList.remove();
            this._headerWrapper = this._headerWrapper || $('<div class="jqx-tabs-headerWrapper" style="outline: none;">');
            this._headerWrapper.remove();
            if (this.position == 'top') {
                this._headerWrapper.prependTo(this.host);
            }
            else {
                this._headerWrapper.appendTo(this.host);
            }
            this._unorderedList.appendTo(this._headerWrapper);

            this._headerWrapper.addClass(this.toThemeProperty('jqx-tabs-header'));
            this._headerWrapper.addClass(this.toThemeProperty('jqx-widget-header'));
            if (this.position == 'bottom') {
                this._headerWrapper.addClass(this.toThemeProperty('jqx-tabs-header-bottom'));
            }
            else {
                this._headerWrapper.removeClass(this.toThemeProperty('jqx-tabs-header-bottom'));
            }

            if (this.roundedCorners) {
                if (this.position == 'top') {
                    this._headerWrapper.addClass(this.toThemeProperty('jqx-rc-t'));
                    this._headerWrapper.removeClass(this.toThemeProperty('jqx-rc-b'));
                }
                else {
                    this._headerWrapper.removeClass(this.toThemeProperty('jqx-rc-t'));
                    this._headerWrapper.addClass(this.toThemeProperty('jqx-rc-b'));
                }
            }

            while (count) {
                count--;
                if (this._titleList[count].children('.jqx-tabs-titleWrapper').length <= 0) {
                    var tabWrapper = $('<div class="jqx-tabs-titleWrapper" style="outline: none; position: relative;">');
                    tabWrapper.append(this._titleList[count].html());
                    this._titleList[count].empty();
                    tabWrapper.appendTo(this._titleList[count]);
                }
                this._titleList[count].children('.jqx-tabs-titleWrapper').css('z-index', '15');
            }
        },

        _render: function () {
            this._addCloseButtons();
            this._addHeaderWrappers();
            this._addContentWrapper();

            if (this.selectionTracker) {
                this._addSelectionTracker();
            }
            this._addArrows();
        },

        _addCloseButton: function (index) {
            var count = index;
            if (this._titleList[count].find(this.toThemeProperty('.jqx-tabs-close-button', true)).length <= 0 &&
                    this._titleList[count].find('.jqx-tabs-titleContentWrapper').length <= 0) {
                var titleWrapper = $('<div class="jqx-tabs-titleContentWrapper"></div>');
                var fl = 'left';
                if (this.rtl) fl = 'right';
                titleWrapper.css('float', fl);
                titleWrapper.addClass('jqx-disableselect');
                titleWrapper.append(this._titleList[count].html());
                this._titleList[count].html('');
                var closeButton = $('<div class="' + this.toThemeProperty('jqx-tabs-close-button') + '"></div>');
                closeButton.css({
                    'height': this.closeButtonSize,
                    'width': this.closeButtonSize,
                    'float': fl,
                    'font-size': '1px'
                });

                var me = this;
                this._titleList[count].append(titleWrapper);
                this._titleList[count].append(closeButton);
                //       closeButton.append('<img src="' + this._getImageUrl(closeButton) + '" style="width:' + this.closeButtonSize + 'px; height:' + this.closeButtonSize + 'px;" />');
                //       closeButton.css('background', 'transperent');
                if (!this.showCloseButtons) {
                    closeButton.css('display', 'none');
                }
                else if (this.hiddenCloseButtons) {
                    if (this.hiddenCloseButtons[index] == 1) {
                        closeButton.css('display', 'none');
                    }
                }
            }
        },

        _addCloseButtons: function () {
            var count = this.length();
            while (count) {
                count--;
                this._addCloseButton(count);
            }
        },

        //Unselecting all items which are not equal to selectedItem property
        _prepareTabs: function () {
            var count = this.length();
            var tracker = this.selectionTracker;
            this.selectionTracker = false;
            while (count) {
                count--;
                if (this._selectedItem !== count) {
                    this._unselect(count, null, false);
                }
            }
            this._select(this._selectedItem, 0, null, false);
            this.selectionTracker = tracker;
            if (this.initTabContent) {
                if (!this._initTabContentList[this.selectedItem]) {
                    if (!this._hiddenParent()) {
                        this.initTabContent(this.selectedItem);
                        this._initTabContentList[this.selectedItem] = true;
                    }
                }
            }
        },

        _isValidIndex: function (index) {
            return (index >= 0 && index < this.length());
        },

        _removeSelectStyle: function () {
            var count = this.length();
            while (count) {
                count--;
                var closeButton = null;
                if (this.showCloseButtons) {
                    var closeButton = this._titleList[count].children(0).children(this.toThemeProperty('.jqx-tabs-close-button', true));
                    closeButton.removeClass(this.toThemeProperty('jqx-tabs-close-button-selected'));
                }

                if (this.position == 'top') {
                    this._titleList[count].removeClass(this.toThemeProperty('jqx-tabs-title-selected-top'));
                }
                else {
                    this._titleList[count].removeClass(this.toThemeProperty('jqx-tabs-title-selected-bottom'));
                }
                this._titleList[count].removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
            }
        },

        _addSelectStyle: function (index, force) {
            var count = this.length();
            this._removeSelectStyle();
            if (!this.selectionTracker || (force != undefined && force)) {
                if (index >= 0 && this._titleList[index] != undefined) {
                    var closeButton = null;
                    if (this.showCloseButtons) {
                        var closeButton = this._titleList[index].children(0).children(this.toThemeProperty('.jqx-tabs-close-button', true));
                        if (this.hiddenCloseButtons) {
                            if (this.hiddenCloseButtons[index] == 1) {
                                closeButton = null;
                            }
                        }
                    }

                    this._titleList[index].removeClass(this.toThemeProperty('jqx-fill-state-hover'));
                    if (this.position == 'top') {
                        this._titleList[index].removeClass(this.toThemeProperty('jqx-tabs-title-hover-top'));
                        this._titleList[index].addClass(this.toThemeProperty('jqx-tabs-title-selected-top'));
                    }
                    else {
                        this._titleList[index].removeClass(this.toThemeProperty('jqx-tabs-title-hover-bottom'));
                        this._titleList[index].addClass(this.toThemeProperty('jqx-tabs-title-selected-bottom'));
                    }
                    this._titleList[index].addClass(this.toThemeProperty('jqx-fill-state-pressed'));
                    if (closeButton != null) {
                        closeButton.addClass(this.toThemeProperty('jqx-tabs-close-button-selected'));
                    }
                }
            }
        },

        _addItemTo: function (collection, index, item) {
            if (index < collection.length) {
                var temp = undefined,
                    swap = undefined;
                for (var i = index; i + 1 < collection.length; i++) {
                    if (temp === undefined) {
                        temp = collection[i + 1];
                        collection[i + 1] = collection[i];
                    }
                    else {
                        swap = collection[i + 1];
                        collection[i + 1] = temp;
                        temp = swap;
                    }
                }
                if (temp === undefined) {
                    temp = collection[index];
                }
                collection[index] = item;
                collection.push(temp);
            } else {
                collection.push(item);
            }
        },

        _select: function (index, duration, callback, toTrigger, force) {
            if (!this._tabCaptured) {
                this.host.attr("hideFocus", "true");
                var self = this;
                if (force == undefined) {
                    this._addSelectStyle(index);
                }
                else {
                    this._addSelectStyle(index, force);
                }

                if (this.isCollapsed && this.collapsible) {
                    this._contentList[index].css('display', 'none');
                    this._selectCallback(index, callback, toTrigger);
                    return;
                }

                switch (this.animationType) {
                    case 'none':
                        if (!self.selectionTracker) {
                            for (var i = 0; i < this._contentList.length; i++) {
                                if (index != i && this._contentList[i].css('display') == 'block') {
                                    this._contentList[i].css('display', 'none');
                                    $.jqx.aria(this._titleList[i], "aria-selected", false);
                                    $.jqx.aria(this._contentList[i], "aria-hidden", true);
                                }
                            }
                            this._contentList[index].css('display', 'block');
                            $.jqx.aria(this._titleList[index], "aria-selected", true);
                            $.jqx.aria(this._contentList[index], "aria-hidden", false);
                            $.jqx.aria(this, 'aria-activedescendant', this._titleList[index][0].id);
                        }
                        else {
                            setTimeout(function () {
                                self._contentList[index].css('display', 'block');
                                $.jqx.aria(self._titleList[index], "aria-selected", true);
                                $.jqx.aria(self._contentList[index], "aria-hidden", false);
                                $.jqx.aria(self, 'aria-activedescendant', self._titleList[index][0].id);
                            }, this.selectionTrackerAnimationDuration);
                        }

                        this._selectCallback(index, callback, toTrigger);
                        break;
                    case 'fade':
                        this._lockAnimation('contentListSelect');
                        self._selectCallback(index, callback, toTrigger);
                        this._contentList[index].fadeIn(duration,
                            function () {
                                self._unlockAnimation('contentListSelect');
                                $.jqx.aria(self._titleList[index], "aria-selected", true);
                                $.jqx.aria(self._contentList[index], "aria-hidden", false);
                                $.jqx.aria(self, 'aria-activedescendant', self._titleList[index][0].id);
                            });
                        break;
                }
            }
        },

        _selectCallback: function (index, callback, toTrigger) {
            this._selectedItem = index;
            this.selectedItem = this._selectedItem;
            if (callback) {
                callback();
            }
            if (toTrigger) {
                this._raiseEvent(1, { item: index });
            }
        },

        _unselect: function (index, callback, toTrigger) {
            if (index >= 0) {
                if (!this._tabCaptured) {
                    var self = this;
                    this._contentList[index].stop();

                    if (this.animationType == 'fade') {
                        this._contentList[index].css('display', 'none');
                        $.jqx.aria(self._titleList[index], "aria-selected", false);
                        $.jqx.aria(self._contentList[index], "aria-hidden", true);
                    }
                    else {
                        if (this.selectionTracker) {
                            setTimeout(function () {
                                self._contentList[index].css('display', 'none');
                                $.jqx.aria(self._titleList[index], "aria-selected", false);
                                $.jqx.aria(self._contentList[index], "aria-hidden", true);
                            }, this.selectionTrackerAnimationDuration);
                        }
                        else {
                            this._contentList[index].css('display', 'none');
                            $.jqx.aria(self._titleList[index], "aria-selected", false);
                            $.jqx.aria(self._contentList[index], "aria-hidden", true);
                        }
                    }

                    this._unselectCallback(index, callback, toTrigger);

                    if (!this.selectionTracker) {
                        this._titleList[index].removeClass(this.toThemeProperty('jqx-tabs-title-selected'));
                        this._titleList[index].removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
                    }
                }
            }
        },


        _unselectCallback: function (index, callback, toTrigger) {
            if (toTrigger) {
                this._raiseEvent(8, { item: index });
            }

            if (callback) {
                callback();
            }
        },

        //Disabling the widget
        disable: function () {
            var count = this.length();
            while (count) {
                count--;
                this.disableAt(count);
            }
        },

        //Enabling the widget
        enable: function () {
            var count = this.length();
            while (count) {
                count--;
                this.enableAt(count);
            }
        },

        // gets the count of the enabled items.
        getEnabledTabsCount: function () {
            var length = 0;
            $.each(this._titleList, function () {
                if (!this.disabled) {
                    length++;
                }
            });

            return length;
        },

        // gets the count of the disabled items.
        getDisabledTabsCount: function () {
            var length = 0;
            $.each(this._titleList, function () {
                if (this.disabled) {
                    length++;
                }
            });

            return length;
        },

        //Removing tab with indicated index
        removeAt: function (index) {
            if (this._isValidIndex(index) && (this.canCloseAllTabs || this.length() > 1)) {
                this._removeHoverStates();
                var self = this,
                    selectedObject = this._titleList[this._selectedItem],
                    closeItemWidth = parseInt(this._titleList[index].outerWidth(true)),
                    title = this.getTitleAt(index);
                this._unorderedList.width(parseInt(this._unorderedList.width()) - closeItemWidth);
                this._titleList[index].remove();
                this._contentList[index].remove();

                var ensureVisibleIndex = 0;
                this._titleList.splice(index, 1);
                this._contentList.splice(index, 1);

                this._addStyles();
                this._performHeaderLayout();
                this._removeEventHandlers();
                this._addEventHandlers();
                this._raiseEvent(3, { item: index, title: title });
                this._isAnimated = {};

                if (this.selectedItem > 0) {
                    this._selectedItem = -1;
                    var current = this._getPreviousIndex(this.selectedItem);
                    this.select(current);
                }
                else {
                    this._selectedItem = -1;
                    var current = this._getNextIndex(this.selectedItem);
                    this.select(current);
                }

                //Fixing some issues with the scrolling
                if (parseInt(this._unorderedList.css('left')) > this._getArrowsDisplacement()) {
                    this._unorderedList.css('left', this._getArrowsDisplacement());
                }
                if (parseInt(this._unorderedList.width()) <= parseInt(this._headerWrapper.width())) {
                    var duration = (this.enableScrollAnimation) ? this.scrollAnimationDuration : 0;
                    this._lockAnimation('unorderedList');
                    this._unorderedList.animate({ 'left': 0 }, duration, function () {
                        self._unlockAnimation('unorderedList');
                    });
                }
            }
        },

        //Removing the first tab
        removeFirst: function () {
            this.removeAt(0);
        },

        //Removing the last tab
        removeLast: function () {
            this.removeAt(this.length() - 1);
        },

        //Disabling tab with indicated index
        disableAt: function (index) {
            if (!this._titleList[index].disabled ||
            this._titleList[index].disabled === undefined) {
                if (this.selectedItem == index) {
                    var selectedNext = this.next();
                    if (!selectedNext) {
                        selectedNext = this.previous();
                    }
                }

                this._titleList[index].disabled = true;
                this.removeHandler(this._titleList[index], this.toggleMode);
                if (this.enabledHover) {
                    this._titleList[index].off('mouseenter').off('mouseleave');
                }
                this._removeEventListenerAt(index);
                this._titleList[index].addClass(this.toThemeProperty('jqx-tabs-title-disable'));
                this._titleList[index].addClass(this.toThemeProperty('jqx-fill-state-disabled'));
                this._raiseEvent(5, { item: index });
            }
        },

        //Enabling tab in indicated position
        enableAt: function (index) {
            if (this._titleList[index].disabled) {
                this._titleList[index].disabled = false;
                this._addEventListenerAt(index);
                this._titleList[index].removeClass(this.toThemeProperty('jqx-tabs-title-disable'));
                this._titleList[index].removeClass(this.toThemeProperty('jqx-fill-state-disabled'));
                this._raiseEvent(4, { item: index });
            }
        },

        //Adding tab in indicated position
        addAt: function (index, title, content) {
            if (index >= 0 || index <= this.length()) {
                this._removeHoverStates();
                var titleContainer = $('<li>' + title + '</li>');
                var contentContainer = $('<div>' + content + '</div>');
                titleContainer.addClass(this.toThemeProperty('jqx-tabs-title'));
                titleContainer.addClass(this.toThemeProperty('jqx-item'));
                contentContainer.addClass(this.toThemeProperty('jqx-tabs-content-element'));

                if (this.position == 'bottom') {
                    titleContainer.addClass(this.toThemeProperty('jqx-tabs-title-bottom'));
                }
                var fullRefresh = false;

                if (this._titleList.length == 0) {
                    this._unorderedList.append(titleContainer);
                }
                else {
                    if (index < this.length() && index >= 0) {
                        this._titleList[index].before(titleContainer);
                    } else {
                        this._titleList[this.length() - 1].after(titleContainer);
                    }
                }

                contentContainer.appendTo(this._contentWrapper);
                this._addItemTo(this._titleList, index, titleContainer);
                this._addItemTo(this._contentList, index, contentContainer);
                if (this._selectedItem > index) {
                    this._selectedItem++;
                }
                this._switchTabs(index, this._selectedItem);
                this._selectedItem = index;
                if (this.showCloseButtons && this._titleList.length > 0) {
                    this._addCloseButton(index);
                }

                this._uiRefresh(fullRefresh);
                this._raiseEvent(2, { item: index });
                this._moveSelectionTrack(this._selectedItem, 0);
            }
        },

        //Adding tab in the beginning
        addFirst: function (title, content) {
            this.addAt(0, title, content);
        },

        //Adding tab in the end
        addLast: function (title, content) {
            this.addAt(this.length(), title, content);
        },

        val: function (value) {
            if (arguments.length == 0 || typeof (value) == "object") {
                return this._selectedItem;
            }

            this.select(value);
            return this._selectedItem;
        },

        //Selecting tab with indicated index
        select: function (index, toggle) {
            if (typeof (index) === 'object') {
                index = this._indexOf(index);
            }

            var canSelect = index >= 0 && index < this._titleList.length ? this._titleList[index].attr('canselect') : true;
            if (canSelect == undefined || canSelect == 'true' || canSelect == true) {
                if (index !== this._selectedItem && this._isValidIndex(index)) {
                    if (!this._activeAnimation() && !this._titleList[index].disabled) {
                        var res = this._switchTabs(index, this._selectedItem);
                        if (res) {
                            this.ensureVisible(index);
                        }
                    }
                }
            }
        },

        //Selecting the previous item
        previous: function (item) {
            var index = this._selectedItem;
            if (item != undefined && !isNaN(item)) index = item;

            while (index > 0 && index < this._titleList.length) {
                index--;
                if (!this._titleList[index].disabled) {
                    this.select(index);
                    return true;
                }
            }
            return false;
        },


        _getPreviousIndex: function (index) {
            if (index != undefined && !isNaN(index)) {
                var savedIndex = index;
                while (index > 0 && index <= this._titleList.length) {
                    index--;
                    if (!this._titleList[index].disabled) {
                        return index;
                        break;
                    }
                }

                return savedIndex;
            }
            else return 0;
        },


        _getNextIndex: function (index) {
            if (index != undefined && !isNaN(index)) {
                var savedIndex = index;

                while (index >= 0 && index < this._titleList.length) {
                    if (!this._titleList[index].disabled) {
                        return index;
                        break;
                    }
                    index++;
                }

                return savedIndex;
            }
            else return 0;
        },

        //Selecting the next item
        next: function (item) {
            var index = this._selectedItem;
            if (item != undefined && !isNaN(item)) index = item;

            while (index >= 0 && index < this._titleList.length - 1) {
                index++;
                if (!this._titleList[index].disabled) {
                    this.select(index);
                    return true;
                }
            }

            return false;
        },

        //Selecting the first item
        first: function () {
            var index = 0;
            if (this._titleList[index].disabled) {
                this.next(index);
            }
            else {
                this.select(index);
            }
        },

        //Selecting the first item
        last: function () {
            var index = this._titleList.length - 1;
            if (this._titleList[index].disabled) {
                this.previous(index);
            }
            else {
                this.select(index);
            }
        },

        //Returning the tabs count
        length: function () {
            return this._titleList.length;
        },

        //Locking tab with specific index
        lockAt: function (index) {
            if (this._isValidIndex(index) &&
                (!this._titleList[index].locked ||
                 this._titleList[index].locked === undefined)) {
                this._titleList[index].locked = true;
                this._raiseEvent(11, { item: index });
            }
        },

        //Unlocing a tab with specific index
        unlockAt: function (index) {
            if (this._isValidIndex(index) &&
                this._titleList[index].locked) {
                this._titleList[index].locked = false;
                this._raiseEvent(12, { item: index });
            }
        },

        //Locing all tabs
        lockAll: function () {
            var count = this.length();
            while (count) {
                count--;
                this.lockAt(count);
            }
        },

        //Unlocking all tabs
        unlockAll: function () {
            var count = this.length();
            while (count) {
                count--;
                this.unlockAt(count);
            }
        },

        //Showing close button in a specific position
        showCloseButtonAt: function (index) {
            if (this._isValidIndex(index)) {
                if (!this.showCloseButtons) {
                    this.showCloseButtons = true;
                    this.updatetabsheader();
                }

                var closeButton = this._titleList[index].find(this.toThemeProperty('.jqx-tabs-close-button', true));
                closeButton.css('display', 'block');
                if (!this.hiddenCloseButtons) this.hiddenCloseButtons = new Array();
                this.hiddenCloseButtons[index] = 0;
            }
        },

        //Hiding a close button in a specific position
        hideCloseButtonAt: function (index) {
            if (this._isValidIndex(index)) {
                var closeButton = this._titleList[index].find(this.toThemeProperty('.jqx-tabs-close-button', true));
                closeButton.css('display', 'none');
                if (!this.hiddenCloseButtons) this.hiddenCloseButtons = new Array();
                this.hiddenCloseButtons[index] = 1;
            }
        },

        //Hiding all close buttons
        hideAllCloseButtons: function () {
            var count = this.length();
            while (count) {
                count--;
                this.hideCloseButtonAt(count);
            }
        },

        //Showing all close buttons.
        showAllCloseButtons: function () {
            var count = this.length();
            while (count) {
                count--;
                this.showCloseButtonAt(count);
            }
        },

        //Getting the title of specified tab.
        getTitleAt: function (index) {
            if (this._titleList[index]) {
                return this._titleList[index].text();
            }
            return null;
        },

        //Getting the content of specified tab.
        getContentAt: function (index) {
            if (this._contentList[index]) {
                return this._contentList[index];
            }
            return null;
        },

        setTitleAt: function (index, text) {
            if (this._titleList[index]) {
                this._titleList[index].text(text);
                if (this.showCloseButtons) {
                    this._addCloseButton(index);
                    this._removeEventHandlers();
                    this._addEventHandlers();

                }
                this.render();
            }
        },

        setContentAt: function (index, html) {
            if (this._contentList[index]) {
                this._contentList[index].html(html);
            }
        },

        //This method is ensuring the visibility of item with indicated index.
        //If the item is currently not visible the method is scrolling to it.
        ensureVisible: function (index) {
            var self = this;
            if (index == undefined || index == -1 || index == null)
                index = this.selectedItem;
            if (!this._isValidIndex(index)) {
                return false;
            }
            var itemRelativePosition = parseInt(this._titleList[index].position().left) + parseInt(this._unorderedList.css('margin-left'));
            var unorderedListPosition = parseInt(this._unorderedList.css('left'));
            var headerWrapperWidth = parseInt(this._headerWrapper.outerWidth(true));
            var itemWidth = parseInt(this._titleList[index].outerWidth(true));
            var visibleAreaLeftEnd = unorderedListPosition - this._getArrowsDisplacement();
            var visibleAreaRightEnd = headerWrapperWidth - this._getArrowsDisplacement() - visibleAreaLeftEnd;
            var scrollPosition, trackerPosition;
            if (itemRelativePosition < -visibleAreaLeftEnd) {
                scrollPosition = -itemRelativePosition + this._getArrowsDisplacement();
                trackerPosition = this._getArrowsDisplacement();
            } else if (itemRelativePosition + itemWidth > visibleAreaRightEnd - this._getArrowsDisplacement()) {
                scrollPosition = -itemRelativePosition + headerWrapperWidth - itemWidth -
                ((this.scrollable) ? (2 * this.arrowButtonSize - this._getArrowsDisplacement()) : 0);
                trackerPosition = headerWrapperWidth - itemWidth - this._getArrowsDisplacement();
            } else {
                this._moveSelectionTrack(index, this.selectionTrackerAnimationDuration);
                return true;
            }
            this._lockAnimation('unorderedList');
            this._unorderedList.animate({ 'left': scrollPosition }, this.scrollAnimationDuration, function () {
                self._unlockAnimation('unorderedList');
                self._moveSelectionTrack(self._selectedItem, 0);
                return true;
            });
            this._moveSelectionTrack(index, this.selectionTrackerAnimationDuration, trackerPosition);
            return true;
        },

        // gets whether an item is visible.
        isVisibleAt: function (index) {
            var self = this;
            if (index == undefined || index == -1 || index == null)
                index = this.selectedItem;
            if (!this._isValidIndex(index)) {
                return false;
            }
            var itemRelativePosition = parseInt(this._titleList[index].position().left) + parseInt(this._unorderedList.css('margin-left'));
            var unorderedListPosition = parseInt(this._unorderedList.css('left'));
            var headerWrapperWidth = parseInt(this._headerWrapper.outerWidth(true));
            var itemWidth = parseInt(this._titleList[index].outerWidth(true));
            var visibleAreaLeftEnd = unorderedListPosition - this._getArrowsDisplacement();
            var visibleAreaRightEnd = headerWrapperWidth - this._getArrowsDisplacement() - visibleAreaLeftEnd;
            var scrollPosition, trackerPosition;
            if (itemRelativePosition < -visibleAreaLeftEnd) {
                return false;
            } else if (itemRelativePosition + itemWidth > visibleAreaRightEnd) {
                return false;
            } else {
                return true;
            }
            return true;
        },

        //Return true if the tab is disabled and false if it is not
        isDisabled: function (index) {
            return this._titleList[index].disabled;
        },

        _lockAnimation: function (type) {
            if (this._isAnimated) {
                this._isAnimated[type] = true;
            }
        },

        _unlockAnimation: function (type) {
            if (this._isAnimated) {
                this._isAnimated[type] = false;
            }
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            this._validateProperties();
            switch (key) {
                case "touchMode":
                    if (value) {
                        object.enabledHover = false;
                        object.keyboardNavigation = false;
                    }
                    break;
                case "width":
                case "height":
                    object._performResize();
                    return;
                case 'disabled':
                    if (value) {
                        this.disable();
                    } else {
                        this.enable();
                    }
                    return;
                case 'showCloseButtons':
                    if (value) {
                        this.showAllCloseButtons();
                    } else {
                        this.hideAllCloseButtons();
                    }
                    this._moveSelectionTrack(this._selectedItem, this.selectionTrackerAnimationDuration);
                    return;
                case 'selectedItem':
                    if (this._isValidIndex(value)) {
                        this.select(value);
                    }
                    return;
                case 'scrollStep':
                case 'contentTransitionDuration':
                case 'scrollAnimationDuration':
                case 'enableScrollAnimation':
                    return;
                case 'selectionTracker':
                    if (value) {
                        this._refresh();
                        this.select(this._selectedItem);
                    } else {
                        if (this._selectionTracker != null) {
                            this._selectionTracker.remove();
                        }
                    }
                    return;
                case 'scrollable':
                    if (value) {
                        this._refresh();
                        this.select(this._selectedItem);
                    } else {
                        this._leftArrow.remove();
                        this._rightArrow.remove();
                        this._performHeaderLayout();
                    }
                    return;
                case 'autoHeight':
                    this._performHeaderLayout();
                    return;
                case 'theme':
                    $.jqx.utilities.setTheme(oldvalue, value, this.host);
                    return;
            }
            this._unorderedList.css('left', '0px');
            this._refresh();
            this.select(this._selectedItem);
            this._addSelectStyle(this._selectedItem, true);
        }
    });
} (jQuery));
(function ($) {

    $.jqx.jqxWidget("jqxGrid", "", {});

    $.extend($.jqx._jqxGrid.prototype, {
        defineInstance: function () {
            // enables or disables the grid.
            this.disabled = false;
            // sets the width.
            this.width = 600;
            // sets the height.
            this.height = 400;
            // sets the pager's height.
            this.pagerheight = 28;
            // sets the group header's height.
            this.groupsheaderheight = 34;
            // sets the default page size.
            this.pagesize = 10;
            // sets the available page sizes.
            this.pagesizeoptions = ['5', '10', '20'];
            // sets the rows height.
            this.rowsheight = 25;
            // sets the columns height.
            this.columnsheight = 25;
            // sets the columns height.
            this.filterrowheight = 30;
            // sets the group indent size. This size is used when the grid is grouped.
            this.groupindentwidth = 30;
            // enables or disables row details.
            this.rowdetails = false;
            // indents the row's details with the sum of the grouping columns and row details column indents.
            this.enablerowdetailsindent = true;
            // enables or disables the built-in mouse-wheel behavior.
            this.enablemousewheel = true;
            // renders the row details.
            this.initrowdetails = null;
            // updates the row details layout.
            this.layoutrowdetails = null;
            // enables or disables editing.
            this.editable = false;
            // sets the edit mode. - click, dblclick, selectedcell, selectedrow or programmatic.
            this.editmode = 'selectedcell';
            // enables or disables paging.
            this.pageable = false;
            this.pagermode = "default";
            this.pagerbuttonscount = 5;
            // enables or disables grouping.
            this.groupable = false;
            // enables or disables sorting.
            this.sortable = false;
            // enables or disables filtering.
            this.filterable = false;
            this.filtermode = "default";
            // displays the filter icon only when the column is filtered.
            this.autoshowfiltericon = true;
            // displays a background for the filtered column.
            this.showfiltercolumnbackground = true;
            // displays a background for the pinned column.
            this.showpinnedcolumnbackground = true;
            // displays a background for the sort column.
            this.showsortcolumnbackground = true;
            // enables or disables alternating rows.
            this.altrows = false;
            // sets the alternating rows start.
            this.altstart = 1;
            // sets the alternating rows step.
            this.altstep = 1;
            // shows or hides the details column.
            this.showrowdetailscolumn = true;
            // shows or hides the grid's toolbar.
            this.showtoolbar = false;
            this.toolbarheight = 34;
            this.showstatusbar = false;
            this.statusbarheight = 34;
            this.enableellipsis = true;
            // adds groups.
            this.groups = [];
            // custom groups renderer.
            this.groupsrenderer = null;
            // custom renderer for the grouping columns displayed in the grouping header.
            this.groupcolumnrenderer = null;
            // groups default expand state.
            this.groupsexpandedbydefault = false;
            // sets the pager renderer.
            this.pagerrenderer = null;
            this.touchmode = 'auto';
            // sets the grid columns.
            this.columns = [];
            // selected row index.
            this.selectedrowindex = -1;
            this.selectedrowindexes = new Array();
            this.selectedcells = new Array();
            this.selectedcell = null;
            this.tableZIndex = 799;
            this.headerZIndex = 499;
            this.updatefilterconditions = null;
            this.showaggregates = false;
            this.showfilterrow = false;
            this.autorowheight = false;
            this.autokoupdates = true;
            this.handlekeyboardnavigation = null;
            this.showsortmenuitems = true;
            this.showfiltermenuitems = true;
            this.showgroupmenuitems = true;
            this.enablebrowserselection = false;
            this.enablekeyboarddelete = true;
            this.clipboard = true;
            this.ready = null;
            this.updatefilterpanel = null;
            this.autogeneratecolumns = false;
            this.rowdetailstemplate = null;
            this.scrollfeedback = null;
            this.rendertoolbar = null;
            this.renderstatusbar = null;
            this.rendered = null;
            this.multipleselectionbegins = null;
            this.columngroups = null;
            this.cellhover = null;
            // sets the grid source.
            this.source =
            {
                beforeprocessing: null,
                beforesend: null,
                loaderror: null,
                localdata: null,
                data: null,
                datatype: 'array',
                // {name: name, map: map}
                datafields: [],
                url: "",
                root: '',
                record: '',
                id: '',
                totalrecords: 0,
                recordstartindex: 0,
                recordendindex: 0,
                loadallrecords: true,
                sortcolumn: null,
                sortdirection: null,
                sort: null,
                filter: null,
                sortcomparer: null
            };
            // sets the grid data view.
            this.dataview = null;
            // sets the rendering delay. 
            this.updatedelay = 0;
            // sets the auto height option. This option is appropriate when the grid's paging is enables or when the grid has quite a few rows.
            this.autoheight = false;
            this.autowidth = false;
            // shows or hides the grid's columns header.
            this.showheader = true;
            // shows or hides the grid's grouping header.
            this.showgroupsheader = true;
            // enables or disables the grouping closing buttons.
            this.closeablegroups = true;
            // sets the scrollbars size.
            this.scrollbarsize = $.jqx.utilities.scrollBarSize;
            this.touchscrollbarsize = $.jqx.utilities.touchScrollBarSize;
            // enables or disables the virtual scrolling.
            this.virtualmode = false;
            // sets a custom sorting behavior.
            this.sort = null;
            // displays a dropdown button in each column.
            this.columnsmenu = true;
            // enables the resizing of grid columns.
            this.columnsresize = false;
            this.columnsreorder = false;
            // sets the width of the columns menu in each column.
            this.columnsmenuwidth = 15;
            this.autoshowcolumnsmenubutton = true;
            this.popupwidth = 'auto';
            // changes the sort state when the user clickes a column header.
            // 0 - disables toggling.
            // 1 - enables togging. Click on a column toggles the sort direction.
            // 2 - enables remove sorting option.
            this.sorttogglestates = 2;
            // callback function invoked when the rows are rendered.
            this.rendergridrows = null;
            // enables or disables the grid animations - slide and fade effects.
            this.enableanimations = true;
            // enables or disables the grid tooltips.
            this.enabletooltips = false;
            // enables or disables the selection.
            // possible values: 'none', 'singlerow', 'multiplerows, 'multiplerowsextended, 'singlecell, 'multiplecells, 'multiplecellsextended', 'multiplecellsadvanced'
            this.selectionmode = 'singlerow';
            // enables or disables the rows hover state.
            this.enablehover = true;
            // this message is displayed when the user tries to call a method before the binding complete.
            this.loadingerrormessage = "The data is still loading. When the data binding is completed, the Grid raises the 'bindingcomplete' event. Call this function in the 'bindingcomplete' event handler.";
            // vertical scroll step.
            this.verticalscrollbarstep = 25;
            // vertical large step.
            this.verticalscrollbarlargestep = 400;
            // horizontal step.
            this.horizontalscrollbarstep = 10;
            // horizontal large step.
            this.horizontalscrollbarlargestep = 50;
            this.keyboardnavigation = true;
            this.touchModeStyle = 'auto';
            this.autoshowloadelement = true;
            this.showdefaultloadelement = true;
            this.showemptyrow = true;
            this.autosavestate = false;
            this.autoloadstate = false;
            // private members
            this._updating = false;
            this._pagescache = new Array();
            this._pageviews = new Array();
            this._cellscache = new Array();
            this._rowdetailscache = new Array();
            this._rowdetailselementscache = new Array();
            this._requiresupdate = false;
            this._hasOpenedMenu = false;
            this.scrollmode = 'physical';
            this.deferreddatafields = null;
            this.localization = null;
            this.rtl = false;
            this.menuitemsarray = [];
            this.events =
	   	    [
            /*0*/'initialized',
            /*1*/'rowClick',
            /*2*/'rowSelect',
            /*3*/'rowUnselect',
            /*4*/'groupExpand',
            /*5*/'groupCollapse',
            /*6*/'sort',
            /*7*/'columnClick',
            /*8*/'cellClick',
            /*9*/'pageChanged',
            /*10*/'pageSizeChanged',
            /*11*/'bindingComplete',
            /*12*/'groupsChanged',
            /*13*/'filter',
            /*14*/'columnResized',
            /*15*/'cellSelect',
            /*16*/'cellUnselect',
            /*17*/'cellBeginEdit',
            /*18*/'cellEndEdit',
            /*19*/'cellValueChanged',
            /*20*/'rowExpand',
            /*21*/'rowCollapse',
            /*22*/'rowDoubleClick',
            /*23*/'cellDoubleClick',
            /*24*/'columnReordered',
            /*25*/'pageChanging'
	   	    ];
        },

        createInstance: function (args) {
            this.that = this;
            var gridStructure = "<div style='overflow: hidden; -webkit-appearance: none; outline: none; width:100%; height: 100%; align:left; border: 0px; padding: 0px; margin: 0px; left: 0px; top: 0px; valign:top; position: relative;'>" +
                "<div id='wrapper" + this.element.id + "' style='overflow: hidden; -webkit-appearance: none; border: none; background: transparent; outline: none; width:100%; height: 100%; padding: 0px; margin: 0px; align:left; left: 0px; top: 0px; valign:top; position: relative;'>" +
                "<div id='toolbar' style='visibility: hidden; align:left; valign:top; left: 0px; top: 0px; position: absolute;'></div>" +
                "<div id='groupsheader' style='visibility: hidden; align:left; valign:top; left: 0px; top: 0px; position: absolute;'></div>" +
                "<div id='content" + this.element.id + "' style='overflow: hidden; -webkit-appearance: none; border: none; background: transparent; outline: none; border: none; padding: 0px; margin-left: 0px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; align:left; valign:top; left: 0px; top: 0px; position: absolute;'></div>" +
                "<div id='verticalScrollBar" + this.element.id + "' style='align:left; valign:top; left: 0px; top: 0px; position: absolute;'></div>" +
                "<div id='horizontalScrollBar" + this.element.id + "' style='align:left; valign:top; left: 0px; top: 0px; position: absolute;'></div>" +
                "<div id='bottomRight' style='align:left; valign:top; left: 0px; top: 0px; border: none; position: absolute;'></div>" +
                "<div id='statusbar' style='align:left; valign:top; left: 0px; top: 0px; position: absolute;'></div>" +
                "<div id='pager' style='z-index: 20; align:left; valign:top; left: 0px; top: 0px; position: absolute;'></div>" +
                "</div>" +
                "</div>";

            this.element.innerText = '';
            this.element.innerHTML = '';

            if (this.source) {
                if (!this.source.dataBind) {
                    this.source = new $.jqx.dataAdapter(this.source);
                }
                var datafields = this.source._source.datafields;
                if (datafields && datafields.length > 0) {
                    this._camelCase = this.source._source.dataFields !== undefined;
                    this.editmode = this.editmode.toLowerCase();
                    this.selectionmode = this.selectionmode.toLowerCase();
                }
            }

            this.host.attr('role', 'grid');
            this.host.attr('align', 'left');
            //    this.host.append(gridStructure);
            this.element.innerHTML = gridStructure;
            this.host.addClass(this.toTP('jqx-grid'));
            this.host.addClass(this.toTP('jqx-reset'));
            this.host.addClass(this.toTP('jqx-rc-all'));
            this.host.addClass(this.toTP('jqx-widget'));
            this.host.addClass(this.toTP('jqx-widget-content'));

            this.wrapper = this.host.find("#wrapper" + this.element.id);
            this.content = this.host.find("#content" + this.element.id);
            this.content.addClass(this.toTP('jqx-reset'));

            var verticalScrollBar = this.host.find("#verticalScrollBar" + this.element.id);
            var horizontalScrollBar = this.host.find("#horizontalScrollBar" + this.element.id);
            this.bottomRight = this.host.find("#bottomRight").addClass(this.toTP('jqx-grid-bottomright'));

            if (!verticalScrollBar.jqxScrollBar) {
                throw new Error('jqxGrid: Missing reference to jqxscrollbar.js');
                return;
            }

            this.editors = new Array();

            this.vScrollBar = verticalScrollBar.jqxScrollBar({ 'vertical': true, rtl: this.rtl, touchMode: this.touchmode, step: this.verticalscrollbarstep, largestep: this.verticalscrollbarlargestep, theme: this.theme, _triggervaluechanged: false });
            this.hScrollBar = horizontalScrollBar.jqxScrollBar({ 'vertical': false, rtl: this.rtl, touchMode: this.touchmode, step: this.horizontalscrollbarstep, largestep: this.horizontalscrollbarlargestep, theme: this.theme, _triggervaluechanged: false });

            this.pager = this.host.find("#pager");
            this.pager[0].id = "pager" + this.element.id;
            this.toolbar = this.host.find("#toolbar");
            this.toolbar[0].id = "toolbar" + this.element.id;
            this.toolbar.addClass(this.toTP('jqx-grid-toolbar'));
            this.toolbar.addClass(this.toTP('jqx-widget-header'));

            this.statusbar = this.host.find("#statusbar");
            this.statusbar[0].id = "statusbar" + this.element.id;
            this.statusbar.addClass(this.toTP('jqx-grid-statusbar'));
            this.statusbar.addClass(this.toTP('jqx-widget-header'));

            this.pager.addClass(this.toTP('jqx-grid-pager'));
            this.pager.addClass(this.toTP('jqx-widget-header'));

            this.groupsheader = this.host.find("#groupsheader");
            this.groupsheader.addClass(this.toTP('jqx-grid-groups-header'));
            this.groupsheader.addClass(this.toTP('jqx-widget-header'));

            this.vScrollBar.css('visibility', 'hidden');
            this.hScrollBar.css('visibility', 'hidden');

            this.vScrollInstance = $.data(this.vScrollBar[0], 'jqxScrollBar').instance;
            this.hScrollInstance = $.data(this.hScrollBar[0], 'jqxScrollBar').instance;
            this.gridtable = null;

            this.isNestedGrid = this.host.parent() ? this.host.parent().css('z-index') == 2000 : false;
            this.touchdevice = this.isTouchDevice();

            if (this.localizestrings) {
                this.localizestrings();
                if (this.localization != null) {
                    this.localizestrings(this.localization, false);
                }
            }
         
            if (this.rowdetailstemplate) {
                if (undefined == this.rowdetailstemplate.rowdetails) this.rowdetailstemplate.rowdetails = '<div></div>';
                if (undefined == this.rowdetailstemplate.rowdetailsheight) this.rowdetailstemplate.rowdetailsheight = 200;
                if (undefined == this.rowdetailstemplate.rowdetailshidden) this.rowdetailstemplate.rowdetailshidden = true;
            }

            if (this.showfilterrow && !this.filterable) {
                throw new Error('jqxGrid: "showfilterrow" requires setting the "filterable" property to true!');
                this.host.remove();
                return;
            }
            if (this.autorowheight && !this.autoheight && !this.pageable) {
                throw new Error('jqxGrid: "autorowheight" requires setting the "autoheight" or "pageable" property to true!');
                this.host.remove();
                return;
            }
            if (this.virtualmode && this.rendergridrows == null) {
                throw new Error('jqxGrid: "virtualmode" requires setting the "rendergridrows"!');
                this.host.remove();
                return;
            }

            if (this.virtualmode && !this.pageable && this.groupable) {
                throw new Error('jqxGrid: "grouping" in "virtualmode" without paging is not supported!');
                this.host.remove();
                return;
            }

            // check for missing modules.
            if (this._testmodules()) {
                return;
            }

            this._builddataloadelement();
            this._cachedcolumns = this.columns;
            if (this.rowsheight != 25) {
                this._measureElement('cell');
            }
            if (this.columnsheight != 25 || this.columngroups) {
                this._measureElement('column');
            }

            if (this.source) {
                var datafields = this.source.datafields;
                if (datafields == null && this.source._source) {
                    datafields = this.source._source.datafields;
                }

                if (datafields) {
                    for (var m = 0; m < this.columns.length; m++) {
                        var column = this.columns[m];
                        if (column && column.cellsformat && column.cellsformat.length > 2) {
                            for (var t = 0; t < datafields.length; t++) {
                                if (datafields[t].name == column.datafield && !datafields[t].format) {
                                    datafields[t].format = column.cellsformat;
                                    break;
                                }
                            }
                        }
                    }
                }
            }

            this.databind(this.source);

            if (this.showtoolbar) {
                this.toolbar.css('visibility', 'visible');
            }
            if (this.showstatusbar) {
                this.statusbar.css('visibility', 'visible');
            }
      
            this._arrange();
            if (this.pageable && this._initpager) {
                this._initpager();
            }
            this.tableheight = null;
            var me = this.that;
            var clearoffset = function () {
                if (me.content) {
                    me.content[0].scrollTop = 0;
                    me.content[0].scrollLeft = 0;
                }
                if (me.gridcontent) {
                    me.gridcontent[0].scrollLeft = 0;
                    me.gridcontent[0].scrollTop = 0;
                }
            }

            this.addHandler(this.content, 'mousedown',
            function () {
                clearoffset();
            });

            this.addHandler(this.content, 'scroll',
            function (event) {
                clearoffset();
                return false;
            });

            if (!this.showfilterrow) {
                if (!this.showstatusbar && !this.showtoolbar) {
                    this.host.addClass('jqx-disableselect');
                }
                this.content.addClass('jqx-disableselect');
            }

            if (this.enablebrowserselection) {
                this.content.removeClass('jqx-disableselect');
                this.host.removeClass('jqx-disableselect');
            }

            this._resizeWindow();

            if (this.renderstatusbar) {
                this.renderstatusbar(this.statusbar);
            }
            if (this.rendertoolbar) {
                this.rendertoolbar(this.toolbar);
            }
            if (this.disabled) {
                this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
            }
            this.hasTransform = $.jqx.utilities.hasTransform(this.host);
            if (this.scrollmode == 'logical') {
                this.vScrollInstance.thumbStep = this.rowsheight;
                this.vScrollInstance.step = this.rowsheight;
            }
            if (!$.jqx.isHidden(this.host)) {
                if (this.filterable || this.groupable || this.sortable) {
                    this._initmenu();
                }
            }
        },

        _resizeWindow: function()
        {
            var me = this.that;
            if ((this.width != null && this.width.toString().indexOf('%') != -1) || (this.height != null && this.height.toString().indexOf('%') != -1)) {
                this._updatesizeonwindowresize = true;
                $.jqx.utilities.resize(this.host, function (type) {
                    var width = $(window).width();
                    var height = $(window).height();
                    var hostwidth = me.host.width();
                    var hostheight = me.host.height();

                    if (me.autoheight) me._lastHostWidth = height;
                    if (me._lastHostWidth != hostwidth || me._lastHostHeight != hostheight) {
                        if (me.touchdevice && me.editcell && type !== "orientationchange")
                            return;

                        me._updatesize(me._lastHostWidth != hostwidth, me._lastHostHeight != hostheight);
                    }

                    me._lastWidth = width;
                    me._lastHeight = height;
                    me._lastHostWidth = hostwidth;
                    me._lastHostHeight = hostheight;
                });
            }
        },

        _builddataloadelement: function () {
            if (this.dataloadelement) {
                this.dataloadelement.remove();
            }

            this.dataloadelement = $('<div style="overflow: hidden; position: absolute;"></div>');
            if (this.showdefaultloadelement) {
                var table = $('<div style="z-index: 99999; margin-left: -66px; left: 50%; top: 50%; margin-top: -24px; position: relative; width: 100px; height: 33px; padding: 5px; font-family: verdana; font-size: 12px; color: #767676; border-color: #898989; border-width: 1px; border-style: solid; background: #f6f6f6; border-collapse: collapse;"><div style="float: left;"><div style="float: left; overflow: hidden; width: 32px; height: 32px;" class="jqx-grid-load"/><span style="margin-top: 10px; float: left; display: block; margin-left: 5px;" >' + this.gridlocalization.loadtext + '</span></div></div>');
                table.addClass(this.toTP('jqx-rc-all'));
                this.dataloadelement.addClass(this.toTP('jqx-rc-all'));
                table.addClass(this.toTP('jqx-fill-state-normal'));
                this.dataloadelement.append(table);
            }
            else {
                this.dataloadelement.addClass(this.toTP('jqx-grid-load'));
            }
            this.dataloadelement.width(this.width);
            this.dataloadelement.height(this.height);

            this.host.prepend(this.dataloadelement);
        },

        _measureElement: function (type) {
            var span = $("<span style='visibility: hidden; white-space: nowrap;'>measure Text</span>");
            span.addClass(this.toTP('jqx-widget'));
            $(document.body).append(span);
            if (type == 'cell') {
                this._cellheight = span.height();
            }
            else this._columnheight = span.height();
            span.remove();
        },

        _measureMenuElement: function () {
            var span = $("<span style='visibility: hidden; white-space: nowrap;'>measure Text</span>");
            span.addClass(this.toTP('jqx-widget'));
            span.addClass(this.toTP('jqx-menu'));
            span.addClass(this.toTP('jqx-menu-item-top'));
            span.addClass(this.toTP('jqx-fill-state-normal'));
            $(document.body).append(span);
            var height = span.outerHeight();
            span.remove();
            return height;
        },

        _measureElementWidth: function (text) {
            var span = $("<span style='visibility: hidden; white-space: nowrap;'>" + text + "</span>");
            span.addClass(this.toTP('jqx-widget'));
            span.addClass(this.toTP('jqx-grid'));
            span.addClass(this.toTP('jqx-grid-column-header'));
            span.addClass(this.toTP('jqx-widget-header'));
            $(document.body).append(span);
            var w = span.outerWidth() + 20;
            span.remove();
            return w;
        },

        _getBodyOffset: function () {
            var top = 0;
            var left = 0;
            if ($('body').css('border-top-width') != '0px') {
                top = parseInt($('body').css('border-top-width'));
                if (isNaN(top)) top = 0;
            }
            if ($('body').css('border-left-width') != '0px') {
                left = parseInt($('body').css('border-left-width'));
                if (isNaN(left)) left = 0;
            }
            return { left: left, top: top };
        },

        _testmodules: function () {
            var missingModules = "";
            var me = this.that;
            var addComma = function () {
                if (missingModules.length != "") missingModules += ",";
            }

            if (this.columnsmenu && !this.host.jqxMenu && (this.sortable || this.groupable || this.filterable)) {
                addComma();
                missingModules += " jqxmenu.js";
            }
            if (!this.host.jqxScrollBar) {
                addComma();
                missingModules += " jqxscrollbar.js";
            }
            if (!this.host.jqxButton) {
                addComma();
                missingModules += " jqxbuttons.js";
            }
            if (!$.jqx.dataAdapter) {
                addComma();
                missingModules += " jqxdata.js";
            }
            if (this.pageable && !this.gotopage) {
                addComma();
                missingModules += "jqxgrid.pager.js";
            }
            if (this.filterable && !this.applyfilters) {
                addComma();
                missingModules += " jqxgrid.filter.js";
            }
            if (this.groupable && !this._initgroupsheader) {
                addComma();
                missingModules += " jqxgrid.grouping.js";
            }
            if (this.columnsresize && !this.autoresizecolumns) {
                addComma();
                missingModules += " jqxgrid.columnsresize.js";
            }
            if (this.columnsreorder && !this.setcolumnindex) {
                addComma();
                missingModules += " jqxgrid.columnsreorder.js";
            }
            if (this.sortable && !this.sortby) {
                addComma();
                missingModules += " jqxgrid.sort.js";
            }
            if (this.editable && !this.begincelledit) {
                addComma();
                missingModules += " jqxgrid.edit.js";
            }
            if (this.showaggregates && !this.getcolumnaggregateddata) {
                addComma();
                missingModules += " jqxgrid.aggregates.js";
            }
            if (this.keyboardnavigation && !this.selectrow) {
                addComma();
                missingModules += " jqxgrid.selection.js";
            }
            if (missingModules != "" || this.editable || this.filterable || this.pageable) {
                var missingTypes = [];

                var addMissing = function (type) {
                    switch (type) {
                        case "checkbox":
                            if (!me.host.jqxCheckBox && !missingTypes['checkbox']) {
                                missingTypes['checkbox'] = true;
                                addComma();
                                missingModules += ' jqxcheckbox.js';
                            }
                            break;
                        case "numberinput":
                            if (!me.host.jqxNumberInput && !missingTypes['numberinput']) {
                                missingTypes['numberinput'] = true;
                                addComma();
                                missingModules += ' jqxnumberinput.js';
                            }
                            break;
                        case "datetimeinput":
                            if (!me.host.jqxDateTimeInput && !missingTypes['datetimeinput']) {
                                addComma();
                                missingTypes['datetimeinput'] = true;
                                missingModules += ' jqxdatetimeinput.js(requires: jqxcalendar.js)';
                            }
                            else if (!me.host.jqxCalendar && !missingTypes['calendar']) {
                                addComma();
                                missingModules += ' jqxcalendar.js';
                            }
                            break;
                        case "combobox":
                            if (!me.host.jqxComboBox && !missingTypes['combobox']) {
                                addComma();
                                missingTypes['combobox'] = true;
                                missingModules += ' jqxcombobox.js(requires: jqxlistbox.js)';
                            }
                            else if (!me.host.jqxListBox && !missingTypes['listbox']) {
                                addComma();
                                missingTypes['listbox'] = true;
                                missingModules += ' jqxlistbox.js';
                            }
                            break;
                        case "dropdownlist":
                            if (!me.host.jqxDropDownList && !missingTypes['dropdownlist']) {
                                addComma();
                                missingTypes['dropdownlist'] = true;
                                missingModules += ' jqxdropdownlist.js(requires: jqxlistbox.js)';
                            }
                            else if (!me.host.jqxListBox && !missingTypes['listbox']) {
                                addComma();
                                missingTypes['listbox'] = true;
                                missingModules += ' jqxlistbox.js';
                            }
                            break;
                    }
                }

                if (this.filterable || this.pageable) {
                    addMissing('dropdownlist');
                }

                for (var i = 0; i < this.columns.length; i++) {
                    if (this.columns[i] == undefined)
                        continue;

                    var type = this.columns[i].columntype;
                    addMissing(type);
                    if (this.filterable && this.showfilterrow) {
                        var type = this.columns[i].filtertype;
                        if (type == 'checkedlist' || type == 'bool') {
                            addMissing('checkbox');
                        }
                        if (type == 'date') {
                            addMissing('datetimeinput');
                        }
                    }
                }
                if (missingModules != "") {
                    throw new Error("jqxGrid: Missing references to the following module(s): " + missingModules);
                    this.host.remove();
                    return true;
                }
            }
            return false;
        },

        focus: function () {
            try
            {
                this.wrapper.focus();
                var me = this.that;
                setTimeout(function () {
                    me.wrapper.focus();
                }, 10);
                this.focused = true;
            }
            catch (error) {
            }
        },

        hiddenParent: function () {
            return $.jqx.isHidden(this.host);
        },

        _updatesize: function (updateWidth, updateHeight) {
            if (this._loading) {
                return;
            }

            var me = this.that;

            var hostWidth = me.host.width();
            var hostHeight = me.host.height();

            if (!me._oldWidth) {
                me._oldWidth = hostWidth;
            }

            if (!me._oldHeight) {
                me._oldHeight = hostHeight;
            }

            if (me._resizeTimer) {
                clearTimeout(me._resizeTimer);
            }

            var delay = 5;

            me._resizeTimer = setTimeout(function () {
                me.resizingGrid = true;
                if ($.jqx.isHidden(me.host))
                    return;

                if (hostHeight != me._oldHeight || updateHeight == true) {
                    var hasgroups = me.groupable && me.groups.length > 0;
                    var isVScrollHidden = me.vScrollBar.css('visibility');

                    if (!me.autoheight) {
                        if (me.virtualmode) {
                            me._pageviews = new Array();
                        }
                        if (!hasgroups && !me.rowdetails && !me.pageable) {
                            me._arrange();
                            me.virtualsizeinfo = me._calculatevirtualheight();
                            var hostHeight = Math.round(me.host.height()) + 2 * me.rowsheight;
                            if (parseInt(hostHeight) >= parseInt(me._oldHeight)) {
                                me.prerenderrequired = true;
                            }
                            me._renderrows(me.virtualsizeinfo);
                        }
                        else {
                            me._arrange();
                            me.prerenderrequired = true;
                            var hostHeight = Math.round(me.host.height()) + 2 * me.rowsheight;
                            realheight = me._gettableheight();
                            var visiblerecords = Math.round(hostHeight / me.rowsheight);
                            var totalrows = Math.max(me.dataview.totalrows, me.dataview.totalrecords);
                            if (me.pageable) {
                                totalrows = me.pagesize;
                                if (me.pagesize > Math.max(me.dataview.totalrows, me.dataview.totalrecords) && me.autoheight) {
                                    totalrows = Math.max(me.dataview.totalrows, me.dataview.totalrecords);
                                }
                                else if (!me.autoheight) {
                                    if (me.dataview.totalrows < me.pagesize) {
                                        totalrows = Math.max(me.dataview.totalrows, me.dataview.totalrecords);
                                    }
                                }
                            }

                            var virtualheight = totalrows * me.rowsheight;
                            var pagesize = me._getpagesize();
                            if (!me.pageable && me.autoheight) {
                                visiblerecords = totalrows;
                            }
                            if (me.virtualsizeinfo) {
                                me.virtualsizeinfo.visiblerecords = visiblerecords;
                            }
                            me.rendergridcontent(true, false);
                            me._renderrows(me.virtualsizeinfo);
                        }

                        if (isVScrollHidden != me.vScrollBar.css('visibility')) {
                            me.vScrollInstance.setPosition(0);
                            me._arrange();
                            me._updatecolumnwidths();
                            if (me.table) {
                                me.table.width(me.columnsheader.width());
                            }
                            me._updatecellwidths();
                        }
                    }
                }

                if (hostWidth != me._oldWidth || updateWidth == true) {
                    var openedEditor = false;
                    if (me.editcell && me.editcell.editor) {
                        switch (me.editcell.columntype) {
                            case "dropdownlist":
                                openedEditor = me.editcell.editor.jqxDropDownList('isOpened') || (me.editcell.editor.jqxDropDownList('isanimating') && !me.editcell.editor.jqxDropDownList('ishiding'));
                                if (openedEditor) {
                                    me.editcell.editor.jqxDropDownList({ openDelay: 0 });
                                    me.editcell.editor.jqxDropDownList('open');
                                    me.editcell.editor.jqxDropDownList({ openDelay: 250 });
                                    return;
                                }
                                break;
                            case "combobox":
                                openedEditor = me.editcell.editor.jqxComboBox('isOpened') || (me.editcell.editor.jqxComboBox('isanimating') && !me.editcell.editor.jqxComboBox('ishiding'));
                                if (openedEditor) {
                                    me.editcell.editor.jqxComboBox({ openDelay: 0 });
                                    me.editcell.editor.jqxComboBox('open');
                                    me.editcell.editor.jqxComboBox({ openDelay: 250 });
                                    return;
                                }
                            break;
                            case "datetimeinput":
                                if (openedEditor) {
                                    openedEditor = me.editcell.editor.jqxDateTimeInput('isOpened') || (me.editcell.editor.jqxDateTimeInput('isanimating') && !me.editcell.editor.jqxDateTimeInput('ishiding'));
                                    me.editcell.editor.jqxDateTimeInput({ openDelay: 0 });
                                    me.editcell.editor.jqxDateTimeInput('open');
                                    me.editcell.editor.jqxDateTimeInput({ openDelay: 250 });
                                    return;
                                }
                            break;
                        }
                    }

                    var isHScrollHidden = me.hScrollBar.css('visibility');
                    me._arrange();
                    me._updatecolumnwidths();
                    if (me.table) {
                        me.table.width(me.columnsheader.width());
                    }
                    me._updatecellwidths();
                    if (!(updateWidth == false && me._oldWidth > hostWidth)) {
                        if (!updateHeight) {
                            me._renderrows(me.virtualsizeinfo);
                        }
                    }
                    if (isHScrollHidden != me.hScrollBar.css('visibility')) {
                        me.hScrollInstance.setPosition(0);
                    }                  
                }
                me._oldWidth = hostWidth;
                me._oldHeight = hostHeight;
                me.resizingGrid = false;
            }, delay);
        },

        getTouches: function (e) {
            return $.jqx.mobile.getTouches(e);
        },

        _updateTouchScrolling: function () {
            var me = this.that;
            if (me.isTouchDevice()) {
                if (me.autoheight) return;

                me.scrollmode = 'logical';
                me.vScrollInstance.thumbStep = me.rowsheight
                var touchstart = $.jqx.mobile.getTouchEventName('touchstart');
                var touchend = $.jqx.mobile.getTouchEventName('touchend');
                var touchmove = $.jqx.mobile.getTouchEventName('touchmove');

                me.enablehover = false;
                if (me.gridcontent) {
                    me.removeHandler(me.gridcontent, touchstart + '.touchScroll');
                    me.removeHandler(me.gridcontent, touchmove + '.touchScroll');
                    me.removeHandler(me.gridcontent, touchend + '.touchScroll');
                    me.removeHandler(me.gridcontent, 'touchcancel.touchScroll');

                    $.jqx.mobile.touchScroll(me.gridcontent[0], me.vScrollInstance.max, function (left, top) {
                        if (me.vScrollBar.css('visibility') == 'visible') {
                            var oldValue = me.vScrollInstance.value;
                            me.vScrollInstance.setPosition(oldValue + top);
                        }
                        if (me.hScrollBar.css('visibility') == 'visible') {
                            var oldValue = me.hScrollInstance.value;
                            me.hScrollInstance.setPosition(oldValue + left);
                        }
                        me.vScrollInstance.thumbCapture = true;

                        me._lastScroll = new Date();
                    }, this.element.id, this.hScrollBar, this.vScrollBar);
                    if (me._overlayElement) {
                        me.removeHandler(me._overlayElement, touchstart + '.touchScroll');
                        me.removeHandler(me._overlayElement, touchmove + '.touchScroll');
                        me.removeHandler(me._overlayElement, touchend + '.touchScroll');
                        me.removeHandler(me._overlayElement, 'touchcancel.touchScroll');

                        $.jqx.mobile.touchScroll(me._overlayElement[0], me.vScrollInstance.max, function (left, top) {
                            if (me.vScrollBar.css('visibility') == 'visible') {
                                var oldValue = me.vScrollInstance.value;
                                me.vScrollInstance.setPosition(oldValue + top);
                            }
                            if (me.hScrollBar.css('visibility') == 'visible') {
                                var oldValue = me.hScrollInstance.value;
                                me.hScrollInstance.setPosition(oldValue + left);
                            }
                            me.vScrollInstance.thumbCapture = true;

                            me._lastScroll = new Date();
                        }, this.element.id, this.hScrollBar, this.vScrollBar);
                        this.addHandler(this.host, touchstart, function () {
                            if (!me.editcell)
                                me._overlayElement.css('visibility', 'visible');
                            else {
                                me._overlayElement.css('visibility', 'hidden');
                            }
                        });
                        this.addHandler(this.host, touchend, function () {
                            if (!me.editcell)
                                me._overlayElement.css('visibility', 'visible');
                            else {
                                me._overlayElement.css('visibility', 'hidden');
                            }
                        });
                    }
                }
            }
        },

        isTouchDevice: function () {
            if (this.touchDevice != undefined)
                return this.touchDevice;

            var isTouchDevice = $.jqx.mobile.isTouchDevice();
            this.touchDevice = isTouchDevice;
            if (this.touchmode == true) {
                if ($.jqx.browser.msie && $.jqx.browser.version < 9) {
                    this.enablehover = false;
                    return false;
                }

                isTouchDevice = true;
                $.jqx.mobile.setMobileSimulator(this.element);
                this.touchDevice = isTouchDevice;
            }
            else if (this.touchmode == false) {
                isTouchDevice = false;
            }
            if (isTouchDevice && this.touchModeStyle != false) {
                this.touchDevice = true;
                this.host.addClass(this.toThemeProperty('jqx-touch'));
                this.host.find('jqx-widget-content').addClass(this.toThemeProperty('jqx-touch'));
                this.host.find('jqx-widget-header').addClass(this.toThemeProperty('jqx-touch'));
                this.scrollbarsize = this.touchscrollbarsize;
            }
            return isTouchDevice;
        },

        toTP: function (name) {
            return this.toThemeProperty(name);
        },

        localizestrings: function (localizationobj, refresh) {
            this._cellscache = new Array();
            if ($.jqx.dataFormat) {
                $.jqx.dataFormat.cleardatescache();
            }

            if (this._loading) {
                throw new Error('jqxGrid: ' + this.loadingerrormessage);
                return false;
            }

            if (localizationobj != null) {
                for (var obj in localizationobj) {
                    if (obj.toLowerCase() !== obj) {
                        localizationobj[obj.toLowerCase()] = localizationobj[obj];
                    }
                }

                if (localizationobj.pagergotopagestring) {
                    this.gridlocalization.pagergotopagestring = localizationobj.pagergotopagestring;
                }
                if (localizationobj.pagershowrowsstring) {
                    this.gridlocalization.pagershowrowsstring = localizationobj.pagershowrowsstring;
                }
                if (localizationobj.pagerrangestring) {
                    this.gridlocalization.pagerrangestring = localizationobj.pagerrangestring;
                }
                if (localizationobj.pagernextbuttonstring) {
                    this.gridlocalization.pagernextbuttonstring = localizationobj.pagernextbuttonstring;
                }
                if (localizationobj.pagerpreviousbuttonstring) {
                    this.gridlocalization.pagerpreviousbuttonstring = localizationobj.pagerpreviousbuttonstring;
                }
                if (localizationobj.pagerfirstbuttonstring) {
                    this.gridlocalization.pagerfirstbuttonstring = localizationobj.pagerfirstbuttonstring;
                }
                if (localizationobj.pagerlastbuttonstring) {
                    this.gridlocalization.pagerlastbuttonstring = localizationobj.pagerlastbuttonstring;
                }
                if (localizationobj.groupsheaderstring) {
                    this.gridlocalization.groupsheaderstring = localizationobj.groupsheaderstring;
                }
                if (localizationobj.sortascendingstring) {
                    this.gridlocalization.sortascendingstring = localizationobj.sortascendingstring;
                }
                if (localizationobj.sortdescendingstring) {
                    this.gridlocalization.sortdescendingstring = localizationobj.sortdescendingstring;
                }
                if (localizationobj.sortremovestring) {
                    this.gridlocalization.sortremovestring = localizationobj.sortremovestring;
                }
                if (localizationobj.groupbystring) {
                    this.gridlocalization.groupbystring = localizationobj.groupbystring;
                }
                if (localizationobj.groupremovestring) {
                    this.gridlocalization.groupremovestring = localizationobj.groupremovestring;
                }
                if (localizationobj.firstDay) {
                    this.gridlocalization.firstDay = localizationobj.firstDay;
                }
                if (localizationobj.days) {
                    this.gridlocalization.days = localizationobj.days;
                }
                if (localizationobj.months) {
                    this.gridlocalization.months = localizationobj.months;
                }
                if (localizationobj.AM) {
                    this.gridlocalization.AM = localizationobj.AM;
                }
                if (localizationobj.PM) {
                    this.gridlocalization.PM = localizationobj.PM;
                }
                if (localizationobj.patterns) {
                    this.gridlocalization.patterns = localizationobj.patterns;
                }
                if (localizationobj.percentsymbol) {
                    this.gridlocalization.percentsymbol = localizationobj.percentsymbol;
                }
                if (localizationobj.currencysymbol) {
                    this.gridlocalization.currencysymbol = localizationobj.currencysymbol;
                }
                if (localizationobj.currencysymbolposition) {
                    this.gridlocalization.currencysymbolposition = localizationobj.currencysymbolposition;
                }
                if (localizationobj.decimalseparator) {
                    this.gridlocalization.decimalseparator = localizationobj.decimalseparator;
                }
                if (localizationobj.thousandsseparator) {
                    this.gridlocalization.thousandsseparator = localizationobj.thousandsseparator;
                }
                if (localizationobj.filterclearstring) {
                    this.gridlocalization.filterclearstring = localizationobj.filterclearstring;
                }
                if (localizationobj.filterstring) {
                    this.gridlocalization.filterstring = localizationobj.filterstring;
                }
                if (localizationobj.filtershowrowstring) {
                    this.gridlocalization.filtershowrowstring = localizationobj.filtershowrowstring;
                }
                if (localizationobj.filterselectallstring) {
                    this.gridlocalization.filterselectallstring = localizationobj.filterselectallstring;
                }
                if (localizationobj.filterchoosestring) {
                    this.gridlocalization.filterchoosestring = localizationobj.filterchoosestring;
                }
                if (localizationobj.filterorconditionstring) {
                    this.gridlocalization.filterorconditionstring = localizationobj.filterorconditionstring;
                }
                if (localizationobj.filterandconditionstring) {
                    this.gridlocalization.filterandconditionstring = localizationobj.filterandconditionstring;
                }
                if (localizationobj.filterstringcomparisonoperators) {
                    this.gridlocalization.filterstringcomparisonoperators = localizationobj.filterstringcomparisonoperators;
                }
                if (localizationobj.filternumericcomparisonoperators) {
                    this.gridlocalization.filternumericcomparisonoperators = localizationobj.filternumericcomparisonoperators;
                }
                if (localizationobj.filterdatecomparisonoperators) {
                    this.gridlocalization.filterdatecomparisonoperators = localizationobj.filterdatecomparisonoperators;
                }
                if (localizationobj.filterbooleancomparisonoperators) {
                    this.gridlocalization.filterbooleancomparisonoperators = localizationobj.filterbooleancomparisonoperators;
                }
                if (localizationobj.emptydatastring) {
                    this.gridlocalization.emptydatastring = localizationobj.emptydatastring;
                }
                if (localizationobj.filterselectstring) {
                    this.gridlocalization.filterselectstring = localizationobj.filterselectstring;
                }
                if (localizationobj.todaystring) {
                    this.gridlocalization.todaystring = localizationobj.todaystring;
                }
                if (localizationobj.clearstring) {
                    this.gridlocalization.clearstring = localizationobj.clearstring;
                }
                if (localizationobj.validationstring) {
                    this.gridlocalization.validationstring = localizationobj.validationstring;
                }
                if (localizationobj.loadtext) {
                    this.gridlocalization.loadtext = localizationobj.loadtext;
                }

                if (refresh !== false) {
                    if (this._initpager) {
                        this._initpager();
                    }
                    if (this._initgroupsheader) {
                        this._initgroupsheader();
                    }
                    if (this._initmenu) {
                        this._initmenu();
                    }
                    this._builddataloadelement();
                    $(this.dataloadelement).css('visibility', 'hidden');
                    $(this.dataloadelement).css('display', 'none');

                    if (this.filterable && this.showfilterrow) {
                        if (this._updatefilterrow) {
                            for (var obj in this._filterrowcache) {
                                $(this._filterrowcache[obj]).remove();
                            }

                            this._filterrowcache = [];
                            this._updatefilterrow();
                        }
                    }
                    if (this.showaggregates && this.refresheaggregates) {
                        this.refresheaggregates();
                    }
                    this._renderrows(this.virtualsizeinfo);
                }
            }
            else {
                this.gridlocalization = {
                    // separator of parts of a date (e.g. '/' in 11/05/1955)
                    '/': "/",
                    // separator of parts of a time (e.g. ':' in 05:44 PM)
                    ':': ":",
                    // the first day of the week (0 = Sunday, 1 = Monday, etc)
                    firstDay: 0,
                    days: {
                        // full day names
                        names: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
                        // abbreviated day names
                        namesAbbr: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
                        // shortest day names
                        namesShort: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"]
                    },
                    months: {
                        // full month names (13 months for lunar calendards -- 13th month should be "" if not lunar)
                        names: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December", ""],
                        // abbreviated month names
                        namesAbbr: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", ""]
                    },
                    // AM and PM designators in one of these forms:
                    // The usual view, and the upper and lower case versions
                    //      [standard,lowercase,uppercase]
                    // The culture does not use AM or PM (likely all standard date formats use 24 hour time)
                    //      null
                    AM: ["AM", "am", "AM"],
                    PM: ["PM", "pm", "PM"],
                    eras: [
                    // eras in reverse chronological order.
                    // name: the name of the era in this culture (e.g. A.D., C.E.)
                    // start: when the era starts in ticks (gregorian, gmt), null if it is the earliest supported era.
                    // offset: offset in years from gregorian calendar
                    {"name": "A.D.", "start": null, "offset": 0 }
                    ],
                    twoDigitYearMax: 2029,
                    patterns: {
                        // short date pattern
                        d: "M/d/yyyy",
                        // long date pattern
                        D: "dddd, MMMM dd, yyyy",
                        // short time pattern
                        t: "h:mm tt",
                        // long time pattern
                        T: "h:mm:ss tt",
                        // long date, short time pattern
                        f: "dddd, MMMM dd, yyyy h:mm tt",
                        // long date, long time pattern
                        F: "dddd, MMMM dd, yyyy h:mm:ss tt",
                        // month/day pattern
                        M: "MMMM dd",
                        // month/year pattern
                        Y: "yyyy MMMM",
                        // S is a sortable format that does not vary by culture
                        S: "yyyy\u0027-\u0027MM\u0027-\u0027dd\u0027T\u0027HH\u0027:\u0027mm\u0027:\u0027ss",
                        // formatting of dates in MySQL DataBases
                        ISO: "yyyy-MM-dd hh:mm:ss",
                        ISO2: "yyyy-MM-dd HH:mm:ss",
                        d1: "dd.MM.yyyy",
                        d2: "dd-MM-yyyy",
                        d3: "dd-MMMM-yyyy",
                        d4: "dd-MM-yy",
                        d5: "H:mm",
                        d6: "HH:mm",
                        d7: "HH:mm tt",
                        d8: "dd/MMMM/yyyy",
                        d9: "MMMM-dd",
                        d10: "MM-dd",
                        d11: "MM-dd-yyyy"
                    },
                    percentsymbol: "%",
                    currencysymbol: "$",
                    currencysymbolposition: "before",
                    decimalseparator: '.',
                    thousandsseparator: ',',
                    pagergotopagestring: "Go to page:",
                    pagershowrowsstring: "Show rows:",
                    pagerrangestring: " of ",
                    pagerpreviousbuttonstring: "previous",
                    pagernextbuttonstring: "next",
                    pagerfirstbuttonstring: "first",
                    pagerlastbuttonstring: "last",
                    groupsheaderstring: "Drag a column and drop it here to group by that column",
                    sortascendingstring: "Sort Ascending",
                    sortdescendingstring: "Sort Descending",
                    sortremovestring: "Remove Sort",
                    groupbystring: "Group By this column",
                    groupremovestring: "Remove from groups",
                    filterclearstring: "Clear",
                    filterstring: "Filter",
                    filtershowrowstring: "Show rows where:",
                    filterorconditionstring: "Or",
                    filterandconditionstring: "And",
                    filterselectallstring: "(Select All)",
                    filterchoosestring: "Please Choose:",
                    filterstringcomparisonoperators: ['empty', 'not empty', 'contains', 'contains(match case)',
                       'does not contain', 'does not contain(match case)', 'starts with', 'starts with(match case)',
                       'ends with', 'ends with(match case)', 'equal', 'equal(match case)', 'null', 'not null'],
                    filternumericcomparisonoperators: ['equal', 'not equal', 'less than', 'less than or equal', 'greater than', 'greater than or equal', 'null', 'not null'],
                    filterdatecomparisonoperators: ['equal', 'not equal', 'less than', 'less than or equal', 'greater than', 'greater than or equal', 'null', 'not null'],
                    filterbooleancomparisonoperators: ['equal', 'not equal'],
                    validationstring: "Entered value is not valid",
                    emptydatastring: "No data to display",
                    filterselectstring: "Select Filter",
                    loadtext: "Loading...",
                    clearstring: "Clear",
                    todaystring: "Today"
                };
            }
        },

        _initmenu: function () {
            var self = this.that;

            if (this.host.jqxMenu) {
                if (this.gridmenu) {
                    if (this.filterable) {
                        if (this._destroyfilterpanel) {
                            this._destroyfilterpanel();
                        }
                    }
                    this.removeHandler(this.gridmenu, 'keydown');
                    this.removeHandler(this.gridmenu, 'closed');
                    this.removeHandler(this.gridmenu, 'itemclick');
                    this.gridmenu.jqxMenu('destroy');
                    this.gridmenu.removeData();
                    this.gridmenu.remove();
                }
                this.menuitemsarray = new Array();
                this.gridmenu = $('<div id="gridmenu' + this.element.id + '" style="z-index: 9999999999999;"></div>');
                this.host.append(this.gridmenu);
                var menuitems = $('<ul></ul>');
                var imgsortasc = '<div class="jqx-grid-sortasc-icon"></div>';
                var sortascendingitem = $('<li>' + imgsortasc + this.gridlocalization.sortascendingstring + '</li>');
                var imgsortdesc = '<div class="jqx-grid-sortdesc-icon"></div>';
                var sortdescendingitem = $('<li>' + imgsortdesc + this.gridlocalization.sortdescendingstring + '</li>');
                var imgsortclear = '<div class="jqx-grid-sortremove-icon"></div>';
                var sortremoveitem = $('<li>' + imgsortclear + this.gridlocalization.sortremovestring + '</li>');
                var imggroupby = '<div class="jqx-grid-groupby-icon"></div>';
                var groupbyitem = $('<li>' + imggroupby + this.gridlocalization.groupbystring + '</li>');
                var groupremoveitem = $('<li>' + imggroupby + this.gridlocalization.groupremovestring + '</li>');
                var separatoritem = $('<li type="separator"></li>');
                var filteritem = $('<li class="filter" style="height: 175px;" ignoretheme="true">' + '<div class="filter"></div>' + '</li>');

                var maxstringlength = this.gridlocalization.sortascendingstring.length;
                var maxstring = this.gridlocalization.sortascendingstring;
                if (this.gridlocalization.sortdescendingstring.length > maxstringlength) {
                    maxstringlength = this.gridlocalization.sortdescendingstring.length;
                    maxstring = this.gridlocalization.sortdescendingstring;
                }
                if (this.gridlocalization.sortremovestring.length > maxstringlength) {
                    maxstringlength = this.gridlocalization.sortremovestring.length;
                    maxstring = this.gridlocalization.sortremovestring;
                }
                if (this.groupable && this._initgroupsheader && this.showgroupmenuitems) {
                    if (this.gridlocalization.groupbystring.length > maxstringlength) {
                        maxstringlength = this.gridlocalization.groupbystring.length;
                        maxstring = this.gridlocalization.groupbystring;
                    }
                    if (this.gridlocalization.groupremovestring.length > maxstringlength) {
                        maxstringlength = this.gridlocalization.groupremovestring.length;
                        maxstring = this.gridlocalization.groupremovestring;
                    }
                }
                var stringwidth = 200;
                maxstring = $.trim(maxstring).replace(/\&nbsp\;/ig, '').replace(/\&#160\;/ig, '');
                var measurestring = $('<span>' + maxstring + '</span>');
                measurestring.addClass(this.toThemeProperty('jqx-menu-item'));
                this.host.append(measurestring);
                stringwidth = measurestring.outerWidth() + 60;
                measurestring.remove();
                var itemscount = 0;
                if (this.sortable && this._togglesort && this.showsortmenuitems) {
                    menuitems.append(sortascendingitem);
                    this.menuitemsarray[0] = sortascendingitem[0];

                    menuitems.append(sortdescendingitem);
                    this.menuitemsarray[1] = sortdescendingitem[0];

                    menuitems.append(sortremoveitem);
                    this.menuitemsarray[2] = sortremoveitem[0];
                    itemscount = 3;
                }

                if (this.groupable && this._initgroupsheader && this.showgroupmenuitems) {
                    menuitems.append(groupbyitem);
                    this.menuitemsarray[3] = groupbyitem[0];

                    menuitems.append(groupremoveitem);
                    this.menuitemsarray[4] = groupremoveitem[0];
                    itemscount += 2;
                }

                var measureHeight = this._measureMenuElement();
                var itemsheight = itemscount * measureHeight + 9;
                var closeonclick = true;
                if (this.filterable && !this.showfilterrow && this.showfiltermenuitems) {
                    if (this._initfilterpanel) {
                        this.menuitemsarray[5] = filteritem[0];
                        this.menuitemsarray[6] = filteritem[0];
                        menuitems.append(separatoritem);
                        menuitems.append(filteritem);
                        itemsheight += 180;
                        if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                            itemsheight += 20;
                        }

                        var filterpanel = $(filteritem).find('div:first');
                        stringwidth += 20;
                        this._initfilterpanel(this, filterpanel, "", stringwidth);
                        closeonclick = false;

                        this.removeHandler($(document), 'click.menu' + self.element.id, self._closemenuafterclick, self);
                        this.addHandler($(document), 'click.menu' + self.element.id, self._closemenuafterclick, self);
                    }
                    else {
                        throw new Error('jqxGrid: Missing reference to jqxgrid.filter.js.');
                    }
                }

                this.gridmenu.append(menuitems);

                if ($.jqx.browser.msie && $.jqx.browser.version < 8 && this.filterable) {
                    $("#listBoxfilter1" + this.element.id).css('z-index', 4990);
                    $("#listBoxfilter2" + this.element.id).css('z-index', 4990);
                    $("#listBoxfilter3" + this.element.id).css('z-index', 4990);
                    $('#gridmenu' + this.element.id).css('z-index', 5000);
                    this.addHandler($('#gridmenu' + this.element.id), 'initialized', function () {
                        $('#menuWrappergridmenu' + self.element.id).css('z-index', 4980);
                    });
                }

                if (this.menuitemsarray[0] == undefined) {
                    itemsheight = 65;
                }

                this.removeHandler(this.gridmenu, 'keydown');
                this.addHandler(this.gridmenu, 'keydown', function (event) {
                    if (event.keyCode == 27) {
                        self.gridmenu.jqxMenu('close');
                    }
                    else if (event.keyCode == 13 && self.filterable) {
                        if (self._buildfilter) {
                            var filter1 = $($.find('#filter1' + self.element.id)).jqxDropDownList('container').css('display') == 'block';
                            var filter2 = $($.find('#filter2' + self.element.id)).jqxDropDownList('container').css('display') == 'block';
                            var filter3 = $($.find('#filter3' + self.element.id)).jqxDropDownList('container').css('display') == 'block';
                            var clearButton = $($.find('#filterclearbutton' + self.element.id)).hasClass('jqx-fill-state-focus');
                            if (clearButton) {
                                var column = $.data(document.body, "contextmenu" + self.element.id).column;
                                self._clearfilter(self, self.element, column);
                                self.gridmenu.jqxMenu('close');
                            }
                            else {
                                if (!filter1 && !filter2 && !filter3) {
                                    var column = $.data(document.body, "contextmenu" + self.element.id).column;
                                    self.gridmenu.jqxMenu('close');
                                    self._buildfilter(self, filteritem, column);
                                }
                            }
                        }
                    }
                });
                if (this.popupwidth != 'auto') {
                    stringwidth = this.popupwidth;
                }

                this.gridmenu.jqxMenu({ width: stringwidth, height: itemsheight, autoCloseOnClick: closeonclick, autoOpenPopup: false, mode: 'popup', theme: this.theme, animationShowDuration: 0, animationHideDuration: 0, animationShowDelay: 0 });
                if (this.filterable) {
                    this.gridmenu.jqxMenu('_setItemProperty', filteritem[0].id, 'closeOnClick', false);
                }
                if (this.rtl) {
                    var me = this.that;
                    $.each(menuitems.find('li'), function () {
                        $(this).addClass(me.toTP('jqx-rtl'));
                    });
                    var func = function (element) {
                        var el = element.find('div');
                        el.css('float', 'right');
                        el.css('margin-left', '4px');
                        el.css('margin-right', '-4px');
                    }
                    func(sortremoveitem);
                    func(sortdescendingitem);
                    func(sortascendingitem);
                    func(groupbyitem);
                    func(groupremoveitem);
                }
                this._handlemenueevents();
            }
            else {
                this.columnsmenu = false;
            }
            //this._appendmenu();
        },

        _arrangemenu: function () {
            if (!this.gridmenu) {
                this._initmenu();
            }

            var maxstringlength = this.gridlocalization.sortascendingstring.length;
            var maxstring = this.gridlocalization.sortascendingstring;
            if (this.gridlocalization.sortdescendingstring.length > maxstringlength) {
                maxstringlength = this.gridlocalization.sortdescendingstring.length;
                maxstring = this.gridlocalization.sortdescendingstring;
            }
            if (this.gridlocalization.sortremovestring.length > maxstringlength) {
                maxstringlength = this.gridlocalization.sortremovestring.length;
                maxstring = this.gridlocalization.sortremovestring;
            }
            if (this.groupable && this._initgroupsheader) {
                if (this.gridlocalization.groupbystring.length > maxstringlength) {
                    maxstringlength = this.gridlocalization.groupbystring.length;
                    maxstring = this.gridlocalization.groupbystring;
                }
                if (this.gridlocalization.groupremovestring.length > maxstringlength) {
                    maxstringlength = this.gridlocalization.groupremovestring.length;
                    maxstring = this.gridlocalization.groupremovestring;
                }
            }
            var stringwidth = 200;
            maxstring = $.trim(maxstring).replace(/\&nbsp\;/ig, '').replace(/\&#160\;/ig, '');
            var measurestring = $('<span>' + maxstring + '</span>');
            measurestring.addClass(this.toThemeProperty('jqx-menu-item'));
            this.host.append(measurestring);
            stringwidth = measurestring.outerWidth() + 60;
            measurestring.remove();
            var itemscount = 0;
            if (this.sortable && this._togglesort && this.showsortmenuitems) {
                itemscount = 3;
            }

            if (this.groupable && this._initgroupsheader && this.showgroupmenuitems) {
                itemscount += 2;
            }

            var itemsheight = itemscount * 27 + 3;
            if (this.filterable && this.showfiltermenuitems) {
                if (this._initfilterpanel) {
                    itemsheight += 180;
                    stringwidth += 20;
                    if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                        itemsheight += 20;
                    }
                }
            }

            if (this.menuitemsarray[0] == undefined) {
                itemsheight = 65;
            }

            if (this.popupwidth != 'auto') {
                stringwidth = this.popupwidth;
            }

            this.gridmenu.jqxMenu({ width: stringwidth, height: itemsheight });
        },

        //_appendmenu: function () {
        //    var el = $.jqx.dataFormat._getmenuelement();
        //    var me = this.that;
        //    if (el != "") {
        //        setTimeout(function () {
        //            var e = $(el);
        //            e.css('position', 'absolute');
        //            var offset = me.host.offset();
        //            e.css('left', offset.left + me.content.width() - 60);
        //            var height = me.table.height();
        //            e.css('top', offset.top);
        //            me.host.append(e);
        //        }, 100);
        //    }
        //},

        _closemenuafterclick: function (event) {
            var me = event != null ? event.data : this;
            var matches = false;

            if (event.target == undefined || (event.target != undefined && event.target.className.indexOf == undefined))
            {
                me.gridmenu.jqxMenu('close');
                return;
            }
            
            if (event.target.className.indexOf('filter') != -1 && event.target.className.indexOf('jqx-grid-cell-filter') == -1) {
                return;
            }

            if (event.target.className.indexOf('jqx-grid-cell') != -1) {
                me.gridmenu.jqxMenu('close');
                return;
            }

            if (me._hasOpenedMenu) {
                if ($(event.target).ischildof(me.gridmenu)) {
                    return;
                }
            }

            var gridbounds = me.host.coord();
            var menubounds = me.gridmenu.coord();
            var x = event.pageX;
            var y = event.pageY;

            $.each($(event.target).parents(), function () {
                if (this.id != null && this.id.indexOf('filter') != -1) {
                    matches = true;
                    return false;
                }

                if (this.className.indexOf('filter') != -1 && this.className.indexOf('jqx-grid-cell-filter') == -1) {
                    matches = true;
                    return false;
                }

                if (this.className.indexOf('jqx-grid-cell') != -1) {
                    me.gridmenu.jqxMenu('close');
                    return false;
                }
                if (this.className.indexOf('jqx-grid-column') != -1) {
                    me.gridmenu.jqxMenu('close');
                    return false;
                }
            });

            if (matches) {
                return;
            }

            try {
                if (this.filtermode === "default") {
                    var date1 = $($.find('#filter1' + me.element.id)).jqxDropDownList('listBox').vScrollInstance._mouseup;
                    var newDate = new Date();
                    if (newDate - date1 < 100)
                        return;

                    var date2 = $($.find('#filter3' + me.element.id)).jqxDropDownList('listBox').vScrollInstance._mouseup;
                    if (newDate - date2 < 100)
                        return;

                    if (($($.find('#filter3' + me.element.id)).jqxDropDownList('container')).css('display') == 'block')
                        return;
                    if (($($.find('#filter1' + me.element.id)).jqxDropDownList('container')).css('display') == 'block')
                        return;
                    if (($($.find('#filter2' + me.element.id)).jqxDropDownList('container')).css('display') == 'block')
                        return;
                }
                else {
                    var date1 = $($.find('#filter1' + me.element.id)).data().jqxListBox.instance.vScrollInstance._mouseup;
                    var newDate = new Date();
                    if (newDate - date1 < 100)
                        return;
                    var date2 = $($.find('#filter1' + me.element.id)).data().jqxListBox.instance.hScrollInstance._mouseup;
                    if (newDate - date2 < 100)
                        return;
                }
            }
            catch (error) {
            }

            if (x >= menubounds.left && x <= menubounds.left + me.gridmenu.width()) {
                if (y >= menubounds.top && y <= menubounds.top + me.gridmenu.height()) {
                    return;
                }
            }

            me.gridmenu.jqxMenu('close');

            //if (x < gridbounds.left || x > gridbounds.left + me.host.width()) {
            //    me.gridmenu.jqxMenu('close');
            //    return;
            //}

            //if (y < gridbounds.top || y > gridbounds.top + me.host.height()) {
            //    me.gridmenu.jqxMenu('close');
            //    return;
            //}
        },

        _handlemenueevents: function () {
            var self = this.that;
            this.removeHandler(this.gridmenu, 'closed');
            this.addHandler(this.gridmenu, 'closed', function (event) {
                self._closemenu();
            });

            this.removeHandler(this.gridmenu, 'itemclick');
            this.addHandler(this.gridmenu, 'itemclick', function (event) {
                var clickeditem = event.args;

                for (var i = 0; i < self.menuitemsarray.length; i++) {
                    var currentitem = self.menuitemsarray[i];
                    if (clickeditem == currentitem) {
                        if ($(clickeditem).attr('ignoretheme') != undefined) {
                            return;
                        }

                        var menu = $.data(document.body, "contextmenu" + self.element.id);
                        var column = menu.column;
                        if (self.filterable) {
                            self.gridmenu.jqxMenu('close');
                        }
                        var displayfield = column.displayfield;
                        if (displayfield == null) displayfield = column.datafield;

                        if (menu != null) {
                            switch (i) {
                                case 0:
                                    self.sortby(displayfield, 'ascending', null);
                                    break;
                                case 1:
                                    self.sortby(displayfield, 'descending', null);
                                    break;
                                case 2:
                                    self.sortby(displayfield, null, null);
                                    break;
                                case 3:
                                    self.addgroup(column.datafield);
                                    break;
                                case 4:
                                    self.removegroup(column.datafield);
                                    break;
                                case 5:
                                    var filteritem = $(self.menuitemsarray[6]);
                                    $(filteritem).css('display', 'block');
                                    break;
                                case 7:
                                    break;
                            }
                        }
                        break;
                    }
                }
            });
        },

        // get information about the data records.
        getdatainformation: function () {
            var totalrecords = this.dataview.totalrecords;
            if (this.summaryrows) {
                totalrecords += this.summaryrows.length;
            }

            return { rowscount: totalrecords, sortinformation: this.getsortinformation(), paginginformation: this.getpaginginformation() }
        },

        // gets sort information.
        getsortinformation: function () {
            return { sortcolumn: this.sortcolumn, sortdirection: this.sortdirection };
        },

        // get paging information.
        getpaginginformation: function () {
            return { pagenum: this.dataview.pagenum, pagesize: this.pagesize, pagescount: Math.ceil(this.dataview.totalrecords / this.pagesize) };
        },

        _updaterowsproperties: function () {
            this._updatehiddenrows();
            this._updaterowheights();
            this._updaterowdetails();
        },

        _updatehiddenrows: function () {
            var me = this.that;
            this.hiddens = new Array();
            var hiddenboundrows = this.hiddenboundrows;
            $.each(hiddenboundrows, function (index) {
                if (this.index != undefined) {
                    var boundindex = this.index;
                    var visibleindex = me.getrowvisibleindex(index);
                    me.hiddens[visibleindex] = this.hidden;
                }
            });
        },

        _updaterowheights: function () {
            var me = this.that;
            this.heights = new Array();
            var heightboundrows = this.heightboundrows;
            $.each(heightboundrows, function (index) {
                if (this.index != undefined) {
                    var boundindex = this.index;
                    var visibleindex = me.getrowvisibleindex(index);
                    me.heights[visibleindex] = this.height;
                }
            });
        },

        _updaterowdetails: function () {
            var me = this.that;
            this.details = new Array();
            var detailboundrows = this.detailboundrows;
            $.each(detailboundrows, function (index) {
                if (this.index != undefined) {
                    var boundindex = this.index;
                    var visibleindex = me.getrowvisibleindex(index);
                    me.details[visibleindex] = this.details;
                }
            });
        },

        _getmenuitembyindex: function (index) {
            if (index == undefined)
                return null;

            return this.menuitemsarray[index];
        },

        _closemenu: function () {
            if (this._hasOpenedMenu) {
                if (this.gridmenu != null) {
                    this.gridmenu.jqxMenu('close');
                }

                var menu = $.data(document.body, "contextmenu" + this.element.id);
                var menuoffset = 16;
                if (menu != null && this.autoshowcolumnsmenubutton) {
                    if (this.enableanimations) {
                        $(menu.columnsmenu).animate({
                            'margin-left': 0
                        }, 'fast', function () {
                            $(menu.columnsmenu).css('display', 'none');
                        });
                        var left = !this.rtl ? -32 : 0;
                        menu.column.iconscontainer.animate({
                            'margin-left': left
                        }, 'fast');
                    }
                    else {
                        $(menu.columnsmenu).css('display', 'none');
                        var left = !this.rtl ? -32 : 0;
                        menu.column.iconscontainer.css('margin-left', left);
                    }

                    $.data(document.body, "contextmenu" + this.element.id, null)
                }
                this._hasOpenedMenu = false;


                var filteritem = this._getmenuitembyindex(5);
                if (filteritem) {
                    var condition = $(filteritem).find('#filter1' + this.element.id);
                    var filteroperator = $(filteritem).find('#filter2' + this.element.id);
                    var condition2 = $(filteritem).find('#filter3' + this.element.id);
                    if (condition.length > 0 && this.filtermode === "default") {
                        condition.jqxDropDownList('hideListBox');
                        filteroperator.jqxDropDownList('hideListBox');
                        condition2.jqxDropDownList('hideListBox');
                    }
                }
            }
        },

        scrolloffset: function (top, left) {
            if (top == null || left == null || top == undefined || left == undefined)
                return;

            this.vScrollBar.jqxScrollBar('setPosition', top);
            this.hScrollBar.jqxScrollBar('setPosition', left);
        },

        scrollleft: function (left) {
            if (left == null || left == undefined)
                return;
            if (this.hScrollBar.css('visibility') != 'hidden') {
                this.hScrollBar.jqxScrollBar('setPosition', left);
            }
        },

        scrolltop: function (top) {
            if (top == null || top == undefined)
                return;
            if (this.vScrollBar.css('visibility') != 'hidden') {
                this.vScrollBar.jqxScrollBar('setPosition', top);
            }
        },

        beginupdate: function () {
            this._updating = true;
            this._datachanged = false;
        },

        endupdate: function () {
            this.resumeupdate();
        },

        resumeupdate: function () {
            this._updating = false;
            if (this._datachanged == true) {
                var verticalScrollValue = this.vScrollInstance.value;
                this.render(true, true, false);
                this._datachanged = false;
                if (verticalScrollValue != 0 && verticalScrollValue < this.vScrollInstance.max) {
                    this.scrolltop(verticalScrollValue);
                }
            }
            else {
                this.rendergridcontent(true);
                this._renderrows(this.virtualsizeinfo);
            }
            if (this.showaggregates && this.renderaggregates) {
                this.renderaggregates();
            }
            this._updatecolumnwidths();
            this._updatecellwidths();
            this._renderrows(this.virtualsizeinfo);
        },

        updating: function () {
            return this._updating;
        },

        showloadelement: function () {
            if (this.renderloadelement) {
                this.dataloadelement.html(this.renderloadelement());
            }

            $(this.dataloadelement).css('visibility', 'visible');
            $(this.dataloadelement).css('display', 'block');
        },

        hideloadelement: function () {
            $(this.dataloadelement).css('visibility', 'hidden');
            $(this.dataloadelement).css('display', 'none');
        },

        _updatefocusedfilter: function () {
            var me = this.that;
            if (me.focusedfilter) {
                me.focusedfilter.focus();
                setTimeout(function () {
                    me.focusedfilter.focus();
                    if (me.focusedfilter[0].nodeName.toLowerCase() == "input") {
                        var start = me.focusedfilter.val().length;
                        try {
                            if ('selectionStart' in me.focusedfilter[0]) {
                                me.focusedfilter[0].setSelectionRange(start, start);
                            }
                            else {
                                var range = me.focusedfilter[0].createTextRange();
                                range.collapse(true);
                                range.moveEnd('character', start);
                                range.moveStart('character', start);
                                range.select();
                            }
                        }
                        catch (error) {
                        }
                    }
                }, 10);
            }
        },

        databind: function (source, reason) {
            if (this.loadingstate === true) {
                return;
            }
        
            if (this.host.css('display') == 'block') {
                if (this.autoshowloadelement) {
                    $(this.dataloadelement).css('visibility', 'visible');
                    $(this.dataloadelement).css('display', 'block');
                    this.dataloadelement.width(this.host.width());
                    this.dataloadelement.height(this.host.height());
                    this._hideemptyrow();
                }
                else {
                    $(this.dataloadelement).css('visibility', 'hidden');
                    $(this.dataloadelement).css('display', 'none');
                }
            }
            if (!this._initgroupsheader && this.groups.length > 0) {
                this.groups = new Array();
            }

            var me = this.that;
            if (source == null) {
                source = {};
            }

            if (!source.recordstartindex) {
                source.recordstartindex = 0;
            }
            if (!source.recordendindex) {
                source.recordendindex = 0;
            }
            if (source.loadallrecords == undefined || source.loadallrecords == null) {
                source.loadallrecords = true;
            }
            if (source.sortcomparer == undefined || source.sortcomparer == null) {
                source.sortcomparer = null;
            }
            if (source.filter == undefined || source.filter == null) {
                source.filter = null;
            }
            if (source.sort == undefined || source.sort == null) {
                source.sort = null;
            }
            if (source.data == undefined || source.data == null) {
                source.data = null;
            }

            var url = null;
            if (source != null) {
                url = source._source != undefined ? source._source.url : source.url;
            }
            this.dataview = this.dataview || new $.jqx.dataview();
            if ($.jqx.dataview.sort) {
                $.extend(this.dataview, new $.jqx.dataview.sort());
            }
            if ($.jqx.dataview.grouping) {
                $.extend(this.dataview, new $.jqx.dataview.grouping());
            }

            this.dataview.suspendupdate();
            this.dataview.pageable = this.pageable;
            this.dataview.groupable = this.groupable;
            this.dataview.groups = this.groups;
            this.dataview.virtualmode = this.virtualmode;
            this.dataview.grid = this;
            this.dataview._clearcaches();
            if (!this.pageable && this.virtualmode) {
                this.loadondemand = true;
            }
            if (!me.initializedcall) {
                if (source._source) {
                    if (this.sortable) {
                        if (source._source.sortcolumn != undefined) {
                            this.sortcolumn = source._source.sortcolumn;
                            this.source.sortcolumn = this.sortcolumn;
                            this.dataview.sortfield = source._source.sortcolumn;
                            source._source.sortcolumn = null;
                        }
                        if (source._source.sortdirection != undefined) {
                            this.dataview.sortfielddirection = source._source.sortdirection;
                            var sortdirection = source._source.sortdirection;
                            if (sortdirection == 'a' || sortdirection == 'asc' || sortdirection == 'ascending' || sortdirection == true) {
                                var ascending = true;
                            }
                            else {
                                var ascending = false;
                            }

                            if (sortdirection != null) {
                                this.sortdirection = { 'ascending': ascending, 'descending': !ascending };
                            }
                            else {
                                this.sortdirection = { 'ascending': false, 'descending': false };
                            }
                        }
                    }
                }
                if (this.pageable) {
                    if (source._source) {   
                        if (source._source.pagenum != undefined) {
                            this.dataview.pagenum = source._source.pagenum;
                        }
                        if (source._source.pagesize != undefined) {
                            this.pagesize = source._source.pagesize;
                            this.dataview.pagesize = source._source.pagesize;
                        }
                        else {
                            this.dataview.pagesize = source._source.pagesize;
                            if (this.dataview.pagesize == undefined)
                                this.dataview.pagesize = this.pagesize;
                        }
                    }
                }
                if (this.sortable) {
                    if (source.sortcolumn) {
                        this.dataview.sortfield = source.sortcolumn;
                    }
                    if (source.sortdirection) {
                        this.dataview.sortfielddirection = source.sortdirection;
                    }
                }
            }

            this._loading = true;

            this.dataview.update = function (rowschanged) {
                if (!me.pageable && me.virtualmode) {
                    me.loadondemand = true;
                }
                me._loading = false;
                if (me.dataview.isupdating()) {
                    me.dataview.resumeupdate(false);
                }
                if (me.pageable && me.pagerrenderer) {
                    if (me._initpager)
                        me._initpager();
                    else throw new Error('jqxGrid: Missing reference to jqxgrid.pager.js.');
                }

                if ((me.source && me.source.sortcolumn) && me.sortby && !me.virtualmode) {
                    me.render();
                    if (!me.source._source.sort) {
                        me.sortby(me.source.sortcolumn, me.source.sortdirection, me.source.sortcomparer);
                    }
                    me.source.sortcolumn = null;
                }
                else {
                    var vvalue = me.vScrollInstance.value;
                    var hvalue = me.hScrollInstance.value;
                    var datatype = me.source ? me.source.datatype : "array";
                    if (datatype != 'local' || datatype != 'array') {
                        var virtualheight = me.virtualsizeinfo == null || (me.virtualsizeinfo != null && me.virtualsizeinfo.virtualheight == 0);
                        if (reason == 'cells') {
                            var hasfilter = false;
                            if (me.filterable && me._initfilterpanel && me.dataview.filters.length) {
                                hasfilter = true;
                            }

                            if (false == rowschanged) {
                                if (!me.vScrollInstance.isScrolling() && !me.hScrollInstance.isScrolling()) {
                                    me._cellscache = new Array();
                                    me._pagescache = new Array();
                                    me._renderrows(me.virtualsizeinfo);
                                    if (me.showfilterrow && me.filterable && me.filterrow) {
                                        me._updatelistfilters(true);
                                    }

                                    if (me.showaggregates && me._updateaggregates) {
                                        me._updateaggregates();
                                    }
                                }
                                if (me.autoshowloadelement) {
                                    $(me.dataloadelement).css('visibility', 'hidden');
                                    $(me.dataloadelement).css('display', 'none');
                                }
                                return;
                            }
                            else {
                                if (hasfilter) {
                                    reason = 'filter';
                                }
                                else if (me.sortcolumn != undefined) {
                                    reason = 'sort';
                                }
                            }
                        }

                        if (!me.virtualmode || virtualheight || (me.virtualmode && me.pageable)) {
                            if (me.initializedcall == true && reason == 'pagechanged') {
                                vvalue = 0;
                                if (me.groupable && me.groups.length > 0) {
                                    me._render(true, true, false, false, false);
                                    me._updatecolumnwidths();
                                    me._updatecellwidths();
                                    me._renderrows(me.virtualsizeinfo);
                                }
                                else {
                                    me.rendergridcontent(true);
                                    if (me.pageable && me.updatepagerdetails) {
                                        me.updatepagerdetails();
                                        if (me.autoheight) {
                                            me._updatepageviews();
                                            if (me.autorowheight) {
                                                me._renderrows(this.virtualsizeinfo);
                                            }
                                        }
                                        else {
                                            if (me.autorowheight) {
                                                me._updatepageviews();
                                                me._renderrows(this.virtualsizeinfo);
                                            }
                                        }
                                    }
                                }

                                if (me.showaggregates && me._updateaggregates) {
                                    me._updateaggregates();
                                }
                                //     me._render(true, true, false, false);
                            }
                            else if (reason == 'filter') {
                                me._render(true, true, false, false, false);
                                me._updatefocusedfilter();
                                me._updatecolumnwidths();
                                me._updatecellwidths();
                                me._renderrows(me.virtualsizeinfo);
                            }
                            else if (reason == 'sort') {
                                me.rendergridcontent(true);
                                if (me.showaggregates && me._updateaggregates) {
                                    me._updateaggregates();
                                }
                            }
                            else if (reason == 'data') {
                                me._render(true, true, false, false, false);
                            }
                            else if (reason == "state") {
                                me._render(true, true, false, me.menuitemsarray && me.menuitemsarray.length > 0 && !me.virtualmode);
                            }
                            else {
                                me._render(true, true, true, me.menuitemsarray && me.menuitemsarray.length > 0 && !me.virtualmode);
                            }
                        }
                        else {
                            if (me.virtualmode && rowschanged == true && !me.pageable) {
                                me._render(true, true, false, false, false);
                                me._updatefocusedfilter();
                                me._updatecolumnwidths();
                                me._updatecellwidths();
                                me._renderrows(me.virtualsizeinfo);
                            }
                            else if (me.virtualmode && !me.pageable && rowschanged == false && reason != undefined) {
                                me.rendergridcontent(true);
                                if (me.showaggregates && me._updateaggregates) {
                                    me._updateaggregates();
                                }
                            }
                            else {
                                if (me.virtualmode && me.dataview.totalrecords == 0 && me.dataview.filters.length > 0) {
                                    me._render(true, true, true, me.menuitemsarray && !me.virtualmode);
                                }
                                else {
                                    me._pagescache = new Array();
                                    me._renderrows(me.virtualsizeinfo);
                                }
                            }
                        }
                        if (me.vScrollInstance.value != vvalue && vvalue <= me.vScrollInstance.max) {
                            me.vScrollInstance.setPosition(vvalue);
                        }
                        if (me.hScrollInstance.value != hvalue && hvalue <= me.hScrollInstance.max) {
                            me.hScrollInstance.setPosition(hvalue);
                        }
                    }
                }
                if (me.autoshowloadelement) {
                    $(me.dataloadelement).css('visibility', 'hidden');
                    $(me.dataloadelement).css('display', 'none');
                }
                if (me.pageable) {
                    if (me.pagerrightbutton) {
                        me.pagerrightbutton.jqxButton({ disabled: false });
                        me.pagerleftbutton.jqxButton({ disabled: false });
                        me.pagershowrowscombo.jqxDropDownList({ disabled: false });
                    }
                }

                me._raiseEvent(11);
                if (!me.initializedcall) {
                    var callReady = function () {
                        me._raiseEvent(0);
                        me.initializedcall = true;
                        if (me.ready) {
                            me.ready();
                        }
                        if (me.autoloadstate) {
                            if (me.loadstate) {
                                me.loadstate(null, true);
                            }
                        }
                    }

                    if (!$.jqx.isHidden(me.host)) {
                        callReady();
                    }
                    else {
                        var t = setInterval(function () {
                            if (!$.jqx.isHidden(me.host)) {
                                clearInterval(t);
                                callReady();
                                me._initmenu();
                            }
                        }, 500);
                    }

                    if ((me.width != null && me.width.toString().indexOf('%') != -1) || (me.height != null && me.height.toString().indexOf('%') != -1)) {
                    //    me._updatesize(true);
                    }

                    if (me.host.css('visibility') == 'hidden') {
                        var ie7 = $.jqx.browser.msie && $.jqx.browser.version < 8;

                        if (me.vScrollBar.css('visibility') == 'visible') {
                            me.vScrollBar.css('visibility', 'inherit');
                        }

                        if (!me.autowidth) {
                            if (me.hScrollBar.css('visibility') == 'visible') {
                                me.hScrollBar.css('visibility', 'inherit');
                            }
                        }

                        me._intervalTimer = setInterval(function () {
                            if (me.host.css('visibility') == 'visible') {
                                me._updatesize(true);
                                clearInterval(me._intervalTimer);
                            }
                        }, 100);
                    }
                }
                else me._updateTouchScrolling();
            }

            this.dataview.databind(source);

            if (this.dataview.isupdating()) {
                if (url != undefined) {
                    this.dataview.suspend = false;
                }
                else {
                    this.dataview.resumeupdate(false);
                }
            }

            this._initializeRows();
        },

        scrollto: function (left, top) {
            if (undefined != left) {
                this.hScrollInstance.setPosition(left);
            }

            if (undefined != top) {
                this.vScrollInstance.setPosition(top);
            }
        },

        scrollposition: function () {
            return { top: this.vScrollInstance.value, left: this.hScrollInstance.value }
        },

        ensurerowvisible: function (index) {
            if (this.autoheight && !this.pageable) {
                return true;
            }

            var pagesize = this._getpagesize();
            var pagenumber = Math.floor(index / pagesize);

            if (!this._pageviews[pagenumber] && !this.pageable) {
                this._updatepageviews();
            }
            if (this.groupable && this.groups.length > 0)
                return true;

            var result = false;
            if (this.pageable && this.gotopage && !this.virtualmode) {
                var pagenumber = Math.floor(index / pagesize);
                if (this.dataview.pagenum != pagenumber) {
                    if (this.groupable && this.groups.length > 0)
                        return true;

                    this.gotopage(pagenumber);
                    result = true;
                }
            }

            var value = this.vScrollInstance.value;
            var height = this._gettableheight() - this.rowsheight;
            var rowindexinpage = pagesize * (index / pagesize - pagenumber);
            rowindexinpage = Math.round(rowindexinpage);

            if (this._pageviews[pagenumber]) {
                var top = this._pageviews[pagenumber].top;
                var rowposition = top + rowindexinpage * this.rowsheight;
                if (this.rowdetails) {
                    for (var i = pagesize * pagenumber; i < index; i++) {
                        if (this.details[i]) {
                            if (this.details[i].rowdetailshidden == false) {
                                rowposition += this.details[i].rowdetailsheight;
                            }
                        }
                    }
                }

                if (this.scrollmode == 'deferred') {
                    if (this.vScrollInstance.max <= rowposition + this.rowsheight) {
                        rowposition = this.vScrollInstance.max;
                    }
                }

                if (rowposition < value) {
                    this.scrolltop(rowposition);
                    result = true;
                }
                else if (rowposition > value + height + 2) {
                    this.scrolltop(rowposition - height);
                    result = true;
                }
            }
            else if (this.pageable) {
                var rowposition = rowindexinpage * this.rowsheight;
                if (this.rowdetails) {
                    for (var i = pagesize * pagenumber; i < pagesize * pagenumber + rowindexinpage; i++) {
                        if (this.details[i] && this.details[i].rowdetailshidden == false) {
                            rowposition += this.details[i].rowdetailsheight;
                        }
                    }
                }

                if (rowposition < value || rowposition > value + height) {
                    this.scrollto(0, rowposition);
                    result = true;
                }
            }
            return result;
        },

        ensurecellvisible: function (index, datafield) {
            var self = this.that;
            var hvalue = this.hScrollBar.jqxScrollBar('value');
            var max = self.hScrollInstance.max;
            if (self.rtl) {
                if (this.hScrollBar.css('visibility') != 'visible') {
                    max = 0;
                }
            }

            var result = this.ensurerowvisible(index);
            var left = 0;
            if (this.columns.records) {
                var value = hvalue;
                if (this.hScrollBar.css('visibility') == 'hidden')
                    return;

                var gridwidth = this.host.width();
                var columnindex = 0;
                var vScrollOffset = this.vScrollBar.css('visibility') == 'visible' ? 20 : 0;
                var hresult = false;
          
                $.each(this.columns.records, function () {
                    if (this.datafield == datafield) {
                        var newleft = 0;
                        var val = !self.rtl ? value : max - hvalue;
                        if (left + this.width > val + gridwidth - vScrollOffset) {
                            newleft = left + this.width - gridwidth + vScrollOffset;
                            if (self.rtl) {
                                newleft = max - newleft;
                            }
                            self.scrollleft(newleft);
                            hresult = true;
                        }
                        else if (left <= val) {
                            newleft = left - this.width;
                            if (self.rtl) {
                                newleft = max - newleft;
                            }
                            self.scrollleft(newleft);
                            hresult = true;
                        }

                        if (columnindex == 0) {
                            if (self.rtl) {
                                self.scrollleft(max);
                            }
                            else {
                                self.scrollleft(0);
                            }
                            hresult = true;
                        }
                        else if (columnindex == self.columns.records.length - 1) {
                            if (self.hScrollBar.css('visibility') == 'visible') {
                                if (!self.rtl) {
                                    self.scrollleft(self.hScrollBar.jqxScrollBar('max'));
                                }
                                else {
                                    self.scrollleft(self.hScrollBar.jqxScrollBar('min'));
                                }

                                hresult = true;
                            }
                        }
                        return false;
                    }
                    columnindex++;
                    left += this.width;
                });
                if (!hresult) {
                    self.scrollleft(value);
                }
            }
            return result;
        },

        setrowheight: function (index, height) {
            if (this._loading) {
                throw new Error('jqxGrid: ' + this.loadingerrormessage);
                return false;
            }

            if (index == null || height == null)
                return false;

            this.heightboundrows[index] = { index: index, height: height };

            index = this.getrowvisibleindex(index);
            if (index < 0)
                return false;

            if (this.rows.records[index]) {
                this.rows.records[index].height = height;
            }
            else {
                row = new jqxGridRow(this, null);
                row.height = height;
                this.rows.replace(index, row);
            }
            this.heights[index] = height;

            this.rendergridcontent(true);
            return true;
        },

        getrowheight: function (index) {
            if (index == null)
                return null;

            index = this.getrowvisibleindex(index);
            if (index < 0)
                return false;

            if (this.rows.records[index]) {
                return this.rows.records[index].height;
            }
        },

        setrowdetails: function (index, details, height, hidden) {
            if (index == undefined || index == null || index < 0)
                return;

            var lookupkey = index + "_";
            if (this._rowdetailscache[lookupkey]) {
                var element = this._rowdetailscache[lookupkey].element;
                $(element).remove();
                this._rowdetailscache[lookupkey] = null;
            }

            var detailskey = this.dataview.generatekey();
            this.detailboundrows[index] = { index: index, details: { rowdetails: details, rowdetailsheight: height, rowdetailshidden: hidden, key: detailskey} };

            index = this.getrowvisibleindex(index);
            if (index < 0)
                return false;

            return this._setrowdetails(index, details, height, hidden, detailskey);
        },

        getcolumn: function (datafield) {
            var column = null;
            if (this.columns.records) {
                $.each(this.columns.records, function () {
                    if (this.datafield == datafield || this.displayfield == datafield) {
                        column = this;
                        return false;
                    }
                });
            }
            return column;
        },

        _getcolumnindex: function (datafield) {
            var index = -1;
            if (this.columns.records) {
                $.each(this.columns.records, function () {
                    index++;
                    if (this.datafield == datafield) {
                        return false;
                    }
                });
            }
            return index;
        },

        _getcolumnat: function (index) {
            var column = this.columns.records[index];
            return column;
        },

        _getprevvisiblecolumn: function (index) {
            var self = this.that;
            while (index > 0) {
                index--;
                var column = self.getcolumnat(index);
                if (!column)
                    return null;

                if (!column.hidden)
                    return column;
            }
            return null;
        },

        _getnextvisiblecolumn: function (index) {
            var self = this.that;
            while (index < this.columns.records.length) {
                index++;
                var column = self.getcolumnat(index);

                if (!column)
                    return null;

                if (!column.hidden)
                    return column;
            }
            return null;
        },

        getcolumnat: function (index) {
            if (!isNaN(index)) {
                var column = this.columns.records[index];
                return column;
            }

            return null;
        },

        _getcolumn: function (datafield) {
            var column = null;
            $.each(this._columns, function () {
                if (this.datafield == datafield || this.displayfield == datafield) {
                    column = this;
                    return false;
                }
            });
            return column;
        },

        _setcolumnproperty: function (datafield, propertyname, value) {
            if (datafield == null || propertyname == null || value == null)
                return null;

            propertyname = propertyname.toLowerCase();
            var column = this.getcolumn(datafield);
            if (column == null)
                return;

            var oldvalue = column[propertyname];
            column[propertyname] = value;

            var _cachedcolumn = this._getcolumn(datafield);
            if (_cachedcolumn != null) {
                _cachedcolumn[propertyname] = value;
            }
            this._cellscache = new Array();

            switch (propertyname) {
                case "filteritems":
                    if (this.filterable && this.showfilterrow) {
                        this._updatelistfilters(true, true);
                    }
                    break;
                case "text":
                    this.prerenderrequired = true;
                    this._rendercolumnheaders();
                    this._updatecellwidths();
                    if (this._groupsheader()) {
                        if (this._initgroupsheader) {
                            this._initgroupsheader();
                        }
                    }
                    this._renderrows(this.virtualsizeinfo);
                    break;
                case "editable":
                case "resizable":
                case "draggable":
                    if (propertyname == "editable") {
                        if (value != oldvalue) {
                            if (this.editcell != null && this.endcelledit) {
                                this.endcelledit(this.editcell.row, this.editcell.column, true, true);
                            }
                            if (column.columntype == 'checkbox') {
                                this.prerenderrequired = true;
                                this.rendergridcontent(true, false);
                                if (this.updating()) {
                                    return false;
                                }
                            }
                            if (this.updating()) {
                                return false;
                            }
                            this._renderrows(this.virtualsizeinfo);
                        }
                    }
                    break;
                case "hidden":
                case "hideable":
                case "renderer":
                case "cellsrenderer":
                case "align":
                case "aggregates":
                case "cellsalign":
                case "cellsformat":
                case "pinned":
                case "contenttype":
                case "filterable":
                case "groupable":
                case "cellclass":
                case "cellclassname":
                case "class":
                    this.prerenderrequired = true;
                    this.rendergridcontent(true);
                    if (this.updating()) {
                        return false;
                    }

                    this._renderrows(this.virtualsizeinfo);
                    if (this.showaggregates && this._updateaggregates) {
                        this._updateaggregates();
                    }
                    break;
                case "width":
                case "minwidth":
                case "maxwidth":
                    if (this.updating()) {
                        return false;
                    }
                    column['_width'] = null;
                    this._updatecolumnwidths();
                    this._updatecellwidths();
                    this._renderrows(this.virtualsizeinfo);
                    break;
            }
        },

        _getcolumnproperty: function (datafield, propertyname) {
            if (datafield == null || propertyname == null)
                return null;

            propertyname = propertyname.toLowerCase();

            var column = this.getcolumn(datafield);
            return column[propertyname];
        },

        // sets a property of a column.
        setcolumnproperty: function (datafield, propertyname, value) {
            this._setcolumnproperty(datafield, propertyname, value);
        },

        // gets the value of a column property.
        getcolumnproperty: function (datafield, propertyname) {
            return this._getcolumnproperty(datafield, propertyname);
        },

        // hides a column.
        hidecolumn: function (datafield) {
            this._setcolumnproperty(datafield, 'hidden', true);
        },

        // shows a column.
        showcolumn: function (datafield) {
            this._setcolumnproperty(datafield, 'hidden', false);
        },

        // gets column's hidden.
        iscolumnvisible: function (datafield) {
            return !this._getcolumnproperty(datafield, 'hidden');
        },

        // pins the column.
        pincolumn: function (datafield) {
            this._setcolumnproperty(datafield, 'pinned', true);
        },

        // unpins the column.
        unpincolumn: function (datafield) {
            this._setcolumnproperty(datafield, 'pinned', false);
        },

        iscolumnpinned: function (datafield) {
            return this._getcolumnproperty(datafield, 'pinned');
        },

        _setrowdetails: function (index, details, height, hidden, detailskey) {
            if (height == 0) {
                height = 100;
            }

            if (index == null || height == null)
                return false;

            if (detailskey != null) {
                this.details[index] = { rowdetails: details, rowdetailsheight: height, rowdetailshidden: hidden, detailskey: detailskey };
            }
            else {
                var olddetailskey = this.details[index] != null ? this.details[index].detailskey : null;
                var newdetails = { rowdetails: details, rowdetailsheight: height, rowdetailshidden: hidden, detailskey: olddetailskey };

                var me = this.that;

                for (var i = 0; i < this.detailboundrows.length; i++) {
                    if (this.detailboundrows[i] != undefined) {
                        var olddetails = this.detailboundrows[i];
                        if (olddetails.details.detailskey == olddetailskey) {
                            olddetails.details.rowdetailsheight = newdetails.rowdetailsheight;
                            olddetails.details.rowdetailshidden = newdetails.rowdetailshidden;
                            olddetails.details.rowdetails = newdetails.rowdetails;
                            break;
                        }
                    }
                }
                this.details[index] = newdetails;
            }

            this.rendergridcontent(true);
            this._updatecolumnwidths();
            this._updatecellwidths();
            this._renderrows(this.virtualsizeinfo);

            return true;
        },

        // gets the row details.
        getrowdetails: function (index) {
            if (index == null)
                return false;

            index = this.getrowvisibleindex(index);
            return this._getrowdetails(index);
        },


        _getrowdetails: function (index) {
            if (index == null)
                return false;

            if (index < 0)
                return false;

            if (this.details[index]) {
                return this.details[index];
            }

            if (this.rowdetailstemplate) {
                return this.rowdetailstemplate;
            }
        },

        // gets all records count.
        getrecordscount: function () {
            return this.dataview.totalrecords;
        },

        // shows the row details.
        showrowdetails: function (index) {
            if (this._loading) {
                throw new Error( 'jqxGrid: ' + this.loadingerrormessage);
                return false;
            }
            if (index == null)
                return false;

            index = this.getrowvisibleindex(index);
            if (index < 0)
                return false;

            var details = this._getrowdetails(index);
            return this._setrowdetailsvisibility(index, details, false);
        },

        // hides the row details.
        hiderowdetails: function (index) {
            if (this._loading) {
                throw new Error( 'jqxGrid: ' + this.loadingerrormessage);
                return false;
            }

            index = this.getrowvisibleindex(index);
            if (index < 0)
                return false;

            var details = this._getrowdetails(index);
            return this._setrowdetailsvisibility(index, details, true);
        },

        _togglerowdetails: function (row) {
            var index = row.visibleindex;
            var details = this._getrowdetails(index);
            if (details != null) {
                var scrollPosition = this.vScrollInstance.value;
                var hidden = !details.rowdetailshidden;
                var result = this._setrowdetailsvisibility(index, details, hidden);
                if (scrollPosition !== 0 && this.vScrollBar.css('visibility') !== 'hidden') {
                    if (scrollPosition <= this.vScrollInstance.max) {
                        this.vScrollInstance.setPosition(scrollPosition);
                    }
                    else {
                        this.vScrollInstance.setPosition(this.vScrollInstance.max);
                    }
                }

                return result;
            }
            return false;
        },

        _setrowdetailsvisibility: function (index, details, hidden) {
            if (this.rowdetailstemplate) {
                if (!this.details) this.details = new Array();
                if (!this.details[index]) {
                    this.details[index] = { rowdetailshidden: this.rowdetailstemplate.rowdetailshidden, rowdetailsheight: this.rowdetailstemplate.rowdetailsheight, rowdetails: this.rowdetailstemplate.rowdetails };
                    var detailskey = this.dataview.generatekey();
                    this.details[index].detailskey = detailskey;
                    this.detailboundrows[index] = { index: index, details: this.details[index] };
                }
            }

            if (details != null) {
                this.details[index].rowdetailshidden = hidden;
            }
            else {
                return false;
            }

            var newdetails = this.details[index];
            if (hidden) {
                this._raiseEvent(21, { rowindex: index, details: newdetails.rowdetails, height: newdetails.rowdetailsheight });
            }
            else {
                this._raiseEvent(20, { rowindex: index, details: newdetails.rowdetails, height: newdetails.rowdetailsheight });
            }
            return this._setrowdetails(index, newdetails.rowdetails, newdetails.rowdetailsheight, newdetails.rowdetailshidden);
        },

        // gets the row's visible index.
        getrowvisibleindex: function (boundindex) {
            if (boundindex == undefined || boundindex == null || boundindex < 0)
                return false;

            if (this.virtualmode) {
                var row = this.dataview.loadedrecords[boundindex];
                if (row == undefined) {
                    return -1;
                }
                return row.visibleindex;
            }

            return this.getrowdisplayindex(boundindex);
        },

        // hides a row.
        hiderow: function (index) {
            if (this._loading) {
                throw new Error('jqxGrid: ' + this.loadingerrormessage);
                return false;
            }

            if (index == undefined || index == null || index < 0)
                return false;

            if (index == null)
                return false;

            this.hiddenboundrows[index] = { index: index, hidden: true };
            index = this.getrowvisibleindex(index);

            return this._setrowvisibility(index, true);
        },

        // shows a row.
        showrow: function (index) {
            if (this._loading) {
                throw new Error('jqxGrid: ' + this.loadingerrormessage);
                return false;
            }

            if (index == undefined || index == null || index < 0)
                return false;

            if (index == null)
                return false;

            this.hiddenboundrows[index] = { index: index, hidden: false };
            index = this.getrowvisibleindex(index);

            return this._setrowvisibility(index, false);
        },
        // is row hidden
        isrowhiddenat: function (index) {
            if (index == null)
                return null;

            index = this.getrowvisibleindex(index);

            if (this.rows.records[index]) {
                return this.rows.records[index].hidden;
            }
        },

        _setrowvisibility: function (index, hidden, refresh) {
            if (index == null)
                return false;

            this.hiddens[index] = hidden;

            if (refresh == undefined || refresh) {
                this.rendergridcontent(true);
                return true;
            }
            return false;
        },

        _loadrows: function () {
            if (!this._pageviews[this.dataview.pagenum] && !this.pageable)
                return;

            var top = !this.pageable ? this._pageviews[this.dataview.pagenum].top : 0;
            if (!this.pageable && this._pagescache[this.dataview.pagenum] != undefined) {
                return null;
            }

            if (!this.virtualsizeinfo) {
                return;
            }

            var self = this.that;
            var storage = new Array();
            var datastorage = new Array();
            var hasgroups = self.groupable && self.groups.length > 0;
            var totalrows = this.dataview.totalrecords;
            var virtualheight = this.virtualsizeinfo.virtualheight;
            var rowindex = 0;

            this.rows.beginupdate();
            var pagesize = this.dataview.pagesize;
            if (this.pageable && hasgroups) {
                pagesize = this.dataview.rows.length;
            }

            for (var i = 0; i < pagesize; i++) {
                if (i >= this.dataview.rows.length)
                    break;

                var datarow = this.dataview.rows[i];
                var row = null;
                if (!self.rows.records[datarow.visibleindex]) {
                    row = new jqxGridRow(self, datarow);
                }
                else {
                    row = self.rows.records[datarow.visibleindex];
                    row.setdata(datarow);
                }

                row.hidden = this.hiddens[row.visibleindex];

                if (this.rowdetailstemplate) {
                    row.rowdetails = this.rowdetailstemplate.rowdetails;
                    row.rowdetailsheight = this.rowdetailstemplate.rowdetailsheight;
                    row.rowdetailshidden = this.rowdetailstemplate.rowdetailshidden;
                }

                var details = this.details[row.visibleindex];
                if (details) {
                    row.rowdetails = details.rowdetails;
                    row.rowdetailsheight = details.rowdetailsheight;
                    row.rowdetailshidden = details.rowdetailshidden;
                }
                else if (!this.rowdetailstemplate) {
                    row.rowdetails = null;
                }

                if (hasgroups && this.pageable && row.parentbounddata != null) {
                    var parentrow = storage[row.parentbounddata.uniqueid];
                    if (parentrow != null) {
                        var groupstate = this._findgroupstate(parentrow.uniqueid);

                        if (this._setsubgroupsvisibility) {
                            this._setsubgroupsvisibility(this, row.parentbounddata, !groupstate, false);
                        }

                        row.hidden = this.hiddens[row.visibleindex];
                    }

                    if (parentrow != null && parentrow != undefined) {
                        row.parentrow = parentrow;
                        parentrow.subrows[parentrow.subrows.length++] = row;
                    }
                }

                if (row.hidden)
                    continue;

                var num = datarow.visibleindex;
                if (!this.heights[num]) {
                    this.heights[num] = this.rowsheight;
                }

                row.height = this.heights[num];

                if (this.rowdetails) {
                    if (row.rowdetails && !row.rowdetailshidden) {
                        row.height += row.rowdetailsheight;
                    }
                }

                storage[row.uniqueid] = row;
                datastorage[rowindex++] = row;

                row.top = top;
                top += row.height;

                var recordindex = num;
                self.rows.replace(recordindex, row);
            }

            if ((this.autoheight || this.pageable) && this.autorowheight) {
                if (this._pageviews && this._pageviews.length > 0) {
                    this._pageviews[0].height = top;
                }
            }

            this.rows.resumeupdate();

            if (datastorage.length > 0) {
                this._pagescache[this.dataview.pagenum] = datastorage;
            }
        },

        _gettableheight: function () {
            if (this.tableheight != undefined)
                return this.tableheight;

            var realheight = this.host.height();

            if (this.columnsheader) {
                var columnheaderheight = this.columnsheader.outerHeight();
                if (!this.showheader) {
                    columnheaderheight = 0;
                }
            }

            realheight -= columnheaderheight;

            if (this.hScrollBar[0].style.visibility == 'visible') {
                realheight -= this.hScrollBar.outerHeight();
            }

            if (this.pageable) {
                realheight -= this.pager.outerHeight();
            }

            if (this._groupsheader()) {
                realheight -= this.groupsheader.outerHeight();
            }

            if (this.showtoolbar) {
                realheight -= this.toolbarheight;
            }

            if (this.showstatusbar) {
                realheight -= this.statusbarheight;
            }

            if (realheight > 0) {
                this.tableheight = realheight;
                return realheight;
            }

            return this.host.height();
        },

        _getpagesize: function () {
            if (this.pageable) {
                return this.pagesize;
            }

            if (this.virtualmode) {
                var hostHeight = Math.round(this.host.height()) + 2 * this.rowsheight;

                var visiblerecords = Math.round(hostHeight / this.rowsheight);
                return visiblerecords;
            }

            if (this.autoheight || this.autorowheight) {
                if (this.dataview.totalrows == 0)
                    return 1;
                return this.dataview.totalrows;
            }

            if (this.dataview.totalrows < 100 && this.dataview.totalrecords < 100 && this.dataview.totalrows > 0) {
                return this.dataview.totalrows;
            }

            return 100;
        },

        _calculatevirtualheight: function () {
            var self = this.that;

            var hostHeight = Math.round(this.host.height()) + 2 * this.rowsheight;
            realheight = this._gettableheight();
            var visiblerecords = Math.round(hostHeight / this.rowsheight);

            this.heights = new Array();
            this.hiddens = new Array();
            this.details = new Array();
            this.expandedgroups = new Array();
            this.hiddenboundrows = new Array();
            this.heightboundrows = new Array();
            this.detailboundrows = new Array();

            var totalrows = Math.max(this.dataview.totalrows, this.dataview.totalrecords);
            if (this.pageable) {
                totalrows = this.pagesize;
                if (this.pagesize > Math.max(this.dataview.totalrows, this.dataview.totalrecords) && this.autoheight) {
                    totalrows = Math.max(this.dataview.totalrows, this.dataview.totalrecords);
                }
                else if (!this.autoheight) {
                    if (this.dataview.totalrows < this.pagesize) {
                        totalrows = Math.max(this.dataview.totalrows, this.dataview.totalrecords);
                    }
                }
            }

            var virtualheight = totalrows * this.rowsheight;
            var top = 0;
            var index = 0;
            var lasttop = 0;
            var pagesize = this._getpagesize();
            var pageheight = pagesize * this.rowsheight;
            var i = 0;
            if (!this.pageable && this.autoheight) {
                visiblerecords = totalrows;
            }

            if (totalrows + pagesize > 0) {
                while (i <= totalrows + pagesize) {
                    top += pageheight;
                    if (i - pagesize < totalrows && i >= totalrows) {
                        var rows = i - totalrows;
                        if (rows > 0) {
                            lasttop -= pageheight;
                            this._pageviews[index - 1] = { top: lasttop, height: pageheight - rows * this.rowsheight };
                        }
                        break;
                    }
                    else {
                        this._pageviews[index++] = { top: lasttop, height: pageheight };
                    }
                    lasttop = top;
                    i += pagesize;
                }
            }

            if (this.resizingGrid != true) {
                this.vScrollBar.jqxScrollBar({ value: 0 });
            }
            if (virtualheight > realheight && !this.autoheight) {
                this.vScrollBar.css('visibility', 'visible');
                if (this.scrollmode == 'deferred') {
                    this.vScrollBar.jqxScrollBar({ max: virtualheight });
                }
                else {
                    this.vScrollBar.jqxScrollBar({ max: virtualheight - realheight });
                }
            }
            else {
                this.vScrollBar.css('visibility', 'hidden');
            }

            this.dataview.pagesize = pagesize;
            this.dataview.updateview();
            return { visiblerecords: visiblerecords, virtualheight: virtualheight };
        },

        _updatepageviews: function () {
            if (this.updating())
                return;
            this._pagescache = new Array();
            this._pageviews = new Array();
            this.tableheight = null;
            var self = this.that;
            var hostHeight = Math.round(this.host.height()) + 2 * this.rowsheight;
            var visiblerecords = Math.round(hostHeight / this.rowsheight);
            var totalrows = Math.max(this.dataview.totalrows, this.dataview.totalrecords);
            var virtualheight = totalrows * this.rowsheight;
            var top = 0;
            var currentheight = 0;
            var index = 0;
            var lasttop = 0;
            var k = 0;
            var pagesize = this._getpagesize();

            if (!this.pageable) {
                for (var i = 0; i < totalrows; i++) {
                    var rowinfo = { index: i, height: this.heights[i], hidden: this.hiddens[i], details: this.details[i] }
                    if (this.heights[i] == undefined) {
                        this.heights[i] = this.rowsheight;
                        rowinfo.height = this.rowsheight;
                    }
                    if (this.hiddens[i] == undefined) {
                        this.hiddens[i] = false;
                        rowinfo.hidden = false;
                    }
                    if (this.details[i] == undefined) {
                        this.details[i] = null;
                    }
                    if (rowinfo.height != self.rowsheight) {
                        virtualheight -= self.rowsheight;
                        virtualheight += rowinfo.height;
                    }

                    if (rowinfo.hidden) {
                        virtualheight -= rowinfo.height;
                    }
                    else {
                        currentheight += rowinfo.height;
                        var detailsheight = 0;
                        if (this.rowdetails) {
                            if (this.rowdetailstemplate) {
                                if (!rowinfo.details) rowinfo.details = this.rowdetailstemplate;
                            }

                            if (rowinfo.details && rowinfo.details.rowdetails && !rowinfo.details.rowdetailshidden) {
                                detailsheight = rowinfo.details.rowdetailsheight;
                                currentheight += detailsheight;
                                virtualheight += detailsheight;
                            }
                        }
                        top += rowinfo.height + detailsheight;
                    }

                    k++;
                    if (k >= pagesize || i == totalrows - 1) {
                        this._pageviews[index++] = { top: lasttop, height: currentheight };
                        currentheight = 0;
                        lasttop = top;
                        k = 0;
                    }
                }
            }
            else {
                if (this._updatepagedview) {
                    virtualheight = this._updatepagedview(totalrows, virtualheight, 0);
                }
                if (this.autoheight) {
                    this._arrange();
                }
            }

            var tableheight = this._gettableheight();
            if (virtualheight > tableheight) {
                if (this.pageable && this.gotopage) {
                    virtualheight = this._pageviews[0].height; // -this._gettableheight();
                    if (virtualheight < 0) {
                        virtualheight = this._pageviews[0].height;
                    }
                }

                if (this.vScrollBar.css('visibility') != 'visible') {
                    this.vScrollBar.css('visibility', 'visible');
                }
                if (virtualheight <= tableheight || this.autoheight) {
                    this.vScrollBar.css('visibility', 'hidden');
                }

                if (virtualheight - tableheight > 0) {
                    if (this.scrollmode != 'deferred') {
                        var max = virtualheight - tableheight;
                        var oldmax = this.vScrollInstance.max;
                        this.vScrollBar.jqxScrollBar({ max: max });
                        if (max != oldmax) {
                            this.vScrollBar.jqxScrollBar({ value: 0 });
                        }
                    }
                }
                else {
                    this.vScrollBar.jqxScrollBar({ value: 0, max: virtualheight });
                }
            }
            else {
                if (!this._loading) {
                    this.vScrollBar.css('visibility', 'hidden');
                }
                this.vScrollBar.jqxScrollBar({ value: 0 });
            }

            this._arrange();

            if (this.autoheight) {
                visiblerecords = Math.round(this.host.height() / this.rowsheight);
            }

            this.virtualsizeinfo = { visiblerecords: visiblerecords, virtualheight: virtualheight };
        },

        updatebounddata: function (reason) {
            this.databind(this.source, reason);
        },

        refreshdata: function () {
            this._refreshdataview();
            this.render();
        },

        _updatevscrollbarmax: function () {
            if (this._pageviews && this._pageviews.length > 0) {
                var virtualheight = this._pageviews[0].height;
                if (this.virtualmode) {
                    virtualheight = this.virtualsizeinfo.virtualheight;
                }

                var tableheight = this._gettableheight();
                if (virtualheight > tableheight) {
                    if (this.pageable && this.gotopage) {
                        virtualheight = this._pageviews[0].height;
                        if (virtualheight < 0) {
                            virtualheight = this._pageviews[0].height;
                        }
                    }

                    if (this.vScrollBar.css('visibility') != 'visible') {
                        this.vScrollBar.css('visibility', 'visible');
                    }
                    if (virtualheight <= tableheight || this.autoheight) {
                        this.vScrollBar.css('visibility', 'hidden');
                    }

                    if (virtualheight - tableheight > 0) {
                        var max = virtualheight - tableheight;
                        this.vScrollBar.jqxScrollBar({ max: max });
                    }
                    else {
                        this.vScrollBar.jqxScrollBar({ value: 0, max: virtualheight });
                    }
                }
                else {
                    this.vScrollBar.css('visibility', 'hidden');
                    this.vScrollBar.jqxScrollBar({ value: 0 });
                }
            }
        },

        _refreshdataview: function () {
            this.dataview.refresh();
        },

        refresh: function (initialRefresh) {
            if (initialRefresh != true) {
                if ($.jqx.isHidden(this.host))
                    return;

                if (this.virtualsizeinfo != null) {
                    //   this._requiresupdate = true;
                    this._cellscache = new Array();
                    this._renderrows(this.virtualsizeinfo);
                    this._updatesize();
                }
            }
        },

        render: function () {
            this._render(true, true, true, true);
        },

        invalidate: function () {
            if (this.virtualsizeinfo) {
                this._updatecolumnwidths();
                this._updatecellwidths();
                this._renderrows(this.virtualsizeinfo);
            }
        },

        clear: function () {
            this.databind(null);
            this.render();
        },

        _preparecolumngroups: function()
        {
            var columnsheight = this.columnsheight;
            if (this.columngroups) {
                this.columnshierarchy = new Array();
                if (this.columngroups.length) {
                    var that = this;
                    for (var i = 0; i < this.columngroups.length; i++) {
                        this.columngroups[i].parent = null;
                        this.columngroups[i].groups = null;
                    }
                    for (var i = 0; i < this.columns.records.length; i++) {
                        this.columns.records[i].parent = null;
                        this.columns.records[i].groups = null;
                    }

                    var getParentGroup = function (name) {
                        for (var i = 0; i < that.columngroups.length; i++) {
                            var group = that.columngroups[i];
                            if (group.name === name)
                                return group;
                        }
                        return null;
                    }

                    for (var i = 0; i < this.columngroups.length; i++) {
                        var group = this.columngroups[i];
                        if (!group.groups) {
                            group.groups = null;
                        }
                        if (group.parentgroup) {
                            var parentgroup = getParentGroup(group.parentgroup);
                            if (parentgroup) {
                                group.parent = parentgroup;
                                if (!parentgroup.groups) {
                                    parentgroup.groups = new Array();
                                }
                                if (parentgroup.groups.indexOf(group) === -1) {
                                    parentgroup.groups.push(group);
                                }
                            }
                        }
                    }
                    for (var i = 0; i < this.columns.records.length; i++) {
                        var group = this.columns.records[i];
                        if (group.columngroup) {
                            var parentgroup = getParentGroup(group.columngroup);
                            if (parentgroup) {
                                if (!parentgroup.groups) {
                                    parentgroup.groups = new Array();
                                }
                                group.parent = parentgroup;
                                if (parentgroup.groups.indexOf(group) === -1) {
                                    parentgroup.groups.push(group);
                                }
                            }
                        }
                    }
                    var totalmaxlevel = 0;
                    for (var i = 0; i < this.columns.records.length; i++) {
                        var group = this.columns.records[i];
                        var initialgroup = group;
                        group.level = 0;
                        while (initialgroup.parent) {
                            initialgroup = initialgroup.parent;
                            group.level++;
                        }
                        var initialgroup = group;
                        var maxlevel = group.level;
                        totalmaxlevel = Math.max(totalmaxlevel, group.level);
                        while (initialgroup.parent) {
                            initialgroup = initialgroup.parent;
                            if (initialgroup) {
                                initialgroup.level = --maxlevel;
                            }
                        }
                    }

                    var getcolumns = function (group) {
                        var columns = new Array();
                        if (group.columngroup) {
                            columns.push(group);
                        }
                        if (group.groups) {
                            for (var i = 0; i < group.groups.length; i++) {
                                if (group.groups[i].columngroup) {
                                    columns.push(group.groups[i]);
                                }
                                else {
                                    if (group.groups[i].groups) {
                                        var tmpcolumns = getcolumns(group.groups[i]);
                                        for (var j = 0; j < tmpcolumns.length; j++) {
                                            columns.push(tmpcolumns[j]);
                                        }
                                    }
                                }
                            }
                        }
                        return columns;
                    }

                    for (var i = 0; i < this.columngroups.length; i++) {
                        var group = this.columngroups[i];
                        var columns = getcolumns(group);
                        group.columns = columns;
                        var indexes = new Array();
                        var pinned = 0;
                        for (var j = 0; j < columns.length; j++) {
                            indexes.push(this.columns.records.indexOf(columns[j]));
                            if (columns[j].pinned) {
                                pinned++;
                            }
                        }
                        if (pinned != 0) {
                            throw new Error("jqxGrid: Column Groups initialization Error. Please, check the initialization of the jqxGrid's columns array. The columns in a column group cannot be pinned.");
                        }

                        indexes.sort(function (value1, value2) {
                            value1 = parseInt(value1);
                            value2 = parseInt(value2);

                            if (value1 < value2) { return -1; }
                            if (value1 > value2) { return 1; }
                            return 0;
                        }
                        );
                        for (var index = 1; index < indexes.length; index++) {
                            if (indexes[index] != indexes[index - 1] + 1) {
                                throw new Error("jqxGrid: Column Groups initialization Error. Please, check the initialization of the jqxGrid's columns array. The columns in a column group are expected to be siblings in the columns array.");
                                this.host.remove();
                            }
                        }
                    }
                }
                this.columngroupslevel = 1 + totalmaxlevel;
                columnsheight = this.columngroupslevel * this.columnsheight;
            }
            return columnsheight;
        },

        _render: function (initialization, forceupdate, rendercolumns, rendermenu, updatelistfilter) {
            if (this.dataview == null)
                return;

            if (this._loading) {
                return;
            }

            if ($.jqx.isHidden(this.host)) {
                var that = this;
                if (that.___hiddenTimer) {
                    clearInterval(that.___hiddenTimer);
                    that.___hiddenTimer = null;
                }

                this.___hiddenTimer = setInterval(function () {
                    if (!$.jqx.isHidden(that.host)) {
                        clearInterval(that.___hiddenTimer);
                        that._render(initialization, forceupdate, rendercolumns, rendermenu, updatelistfilter);
                    }
                }, 300);
                return;
            }

            if (this.editcell != null && this.endcelledit) {
                this.endcelledit(this.editcell.row, this.editcell.column, true, false);
            }
            this.validationpopup = null;
            this._removeHandlers();
            this._addHandlers();
            this._initializeRows();

            this._requiresupdate = forceupdate != undefined ? forceupdate : true;
            this._newmax = null;

            if (rendercolumns) {
                if (!this._requiresupdate) {
                    if (rendermenu != false) {
                        this._initmenu();
                    }
                }

                if (this.columns == null) {
                    this.columns = new $.jqx.collection(this.element);
                }
                else {
                    this._initializeColumns();
                }
            }

            this.tableheight = null;
            this._pagescache = new Array();
            this._pageviews = new Array();
            this.visiblerows = new Array();
            this.hittestinfo = new Array();

            if (this._requiresupdate) {
                this._clearcaches();
                if (rendermenu == true) {
                    this._initmenu();
                }   
            }

            this.virtualsizeinfo = null;
            this.prerenderrequired = true;

            if ((this.groupable && this.groups.length > 0 && this.rowdetails) || (this.rowdetails)) {
                if (this.gridcontent) {
                    this._rowdetailscache = new Array();
                    this._rowdetailselementscache = new Array();
                    this.detailboundrows = new Array();
                    this.details = new Array();
                    $.jqx.utilities.html(this.gridcontent, '');
                    this.gridcontent = null;
                }
            }

            if (this.gridcontent) {
                if (this.editable && this._destroyeditors) {
                    this._destroyeditors();
                }
            }

            if (rendercolumns) {
                if (this.filterrow) this.filterrow.detach();
                $.jqx.utilities.html(this.content, '');
                this.columnsheader = this.columnsheader || $('<div style="overflow: hidden;"></div>');
                this.columnsheader.remove();
                this.columnsheader.addClass(this.toTP('jqx-widget-header'));
                this.columnsheader.addClass(this.toTP('jqx-grid-header'));
            }
            else {
                if (this.gridcontent) {
                    $.jqx.utilities.html(this.gridcontent, '');
                }
            }

            if (!this.showheader) {
                this.columnsheader.css('display', 'none');
            }
            else {
                if (this.columnsheader) {
                    this.columnsheader.css('display', 'block');
                }
            }

            this.gridcontent = this.gridcontent || $('<div style="width: 100%; overflow: hidden; position: absolute;"></div>');
            this.gridcontent.remove();

            var columnsheight = this.columnsheight;
            columnsheight = this._preparecolumngroups();

            if (this.showfilterrow && this.filterable) {
                this.columnsheader.height(columnsheight + this.filterrowheight);
            }
            else {
                this.columnsheader.height(columnsheight);
            }

            this.content.append(this.columnsheader);
            this.content.append(this.gridcontent);
            this._arrange();

            if (this._initgroupsheader) {
                this._initgroupsheader();
            }

            this.selectionarea = this.selectionarea || $("<div style='z-index: 99999; visibility: hidden; position: absolute;'></div>");
            this.selectionarea.addClass(this.toThemeProperty('jqx-grid-selectionarea'));
            this.selectionarea.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
            this.content.append(this.selectionarea);
            this.tableheight = null;

            this.rendergridcontent(false, rendercolumns);
            if (this.groups.length > 0 && this.groupable) {
                this.suspendgroupevents = true;
                if (this.collapseallgroups) {
                    if (!this.groupsexpandedbydefault) {
                        this.collapseallgroups(false);
                        this._updatescrollbarsafterrowsprerender();
                    }
                    else {
                        this.expandallgroups(false);
                    }
                }
                this.suspendgroupevents = false;
            }

            if (this.pageable && this.updatepagerdetails) {
                this.updatepagerdetails();
                if (this.autoheight) {
                    this._updatepageviews();
                }
                if (this.autorowheight) {
                    if (!this.autoheight) {
                        this._updatepageviews();
                    }
                    this._renderrows(this.virtualsizeinfo);
                }
            }

            if (this.showaggregates && this._updateaggregates) {
                this._updateaggregates();
            }

            this._addoverlayelement();
            if (this.scrollmode == "deferred") {
                this._addscrollelement();
            }

            if (this.showfilterrow && this.filterable && this.filterrow && (updatelistfilter == undefined || updatelistfilter == true)) {
                this._updatelistfilters(!rendercolumns);
            }

            // callback when the rendering is complete.
            if (this.rendered) {
                this.rendered('full');
            }
        },

        _addoverlayelement: function () {
            if (this.autoheight) {
                if (this._overlayElement) {
                    this._overlayElement.remove();
                }
                return;
            }

            var browserInfo = $.jqx.utilities.getBrowser();
            if ((browserInfo.browser == 'msie' && parseInt(browserInfo.version) < 9) || this.isTouchDevice()) {
                if (this._overlayElement) {
                    this._overlayElement.remove();
                }
                this._overlayElement = $("<div style='visibility: hidden; position: absolute; width: 100%; height: 100%;'></div>");
                this._overlayElement.css('background', 'white');
                this._overlayElement.css('z-index', 18000);
                this._overlayElement.css('opacity', 0.001);
                if (this.isTouchDevice()) {
                    if (this.vScrollBar.css('visibility') !== "hidden" || this.hScrollBar.css('visibility') !== "hidden") {
                     //   this.table.prepend(this._overlayElement);
                     //   this._overlayElement.css('visibility', 'visible');
                        var leftOffset = 0;
                        if (this.selectionmode == "checkbox") {
                            leftOffset += 30;
                        }
                        if (this.groupable || this.rowdetails) {
                            this._overlayElement.css('left', 30 * (this.groups.length + (this.rowdetails ? 1 : 0)));
                        }
                        var left = this._overlayElement.css('left');
                        this._overlayElement.css('left', left + leftOffset);
                    }
                    else {
                        if (this._overlayElement) {
                            this._overlayElement.remove();
                        }
                    }
                }
                else {
                    this.content.prepend(this._overlayElement);
                }
            }
            this._updateTouchScrolling();
        },

        _addscrollelement: function () {
            if (this._scrollelement) {
                this._scrollelement.remove();
            }
            if (this._scrollelementoverlay) {
                this._scrollelementoverlay.remove();
            }

            this._scrollelementoverlay = $("<div style='visibility: hidden; position: absolute; width: 100%; height: 100%;'></div>");
            this._scrollelementoverlay.css('background', 'black');
            this._scrollelementoverlay.css('z-index', 18000);
            this._scrollelementoverlay.css('opacity', 0.1);

            this._scrollelement = $("<span style='visibility: hidden; top: 50%; right: 10px; position: absolute;'></span>");
            this._scrollelement.css('z-index', 18005);
            this._scrollelement.addClass(this.toThemeProperty('jqx-button'));
            this._scrollelement.addClass(this.toThemeProperty('jqx-fill-state-normal'));
            this._scrollelement.addClass(this.toThemeProperty('jqx-rc-all'));
            this._scrollelement.addClass(this.toThemeProperty('jqx-shadow'));
            this.content.prepend(this._scrollelement);
            this.content.prepend(this._scrollelementoverlay);
        },

        rendergridcontent: function (requiresupdate, rendercolumns) {
            if (this.updating()) {
                return false;
            }

            if (requiresupdate == undefined || requiresupdate == null) {
                requiresupdate = false;
            }

            this._requiresupdate = requiresupdate;

            var prerender = this.prerenderrequired;
            if (this.prerenderrequired) {
                this._arrange();
            }

            var me = this.that;
            var rendercolumns = rendercolumns;
            if (rendercolumns == null || rendercolumns == undefined) {
                rendercolumns = true;
            }

            this.tableheight = null;
            me.virtualsizeinfo = me.virtualsizeinfo || me._calculatevirtualheight();
            if (me.pageable && !me.autoheight) {
                if (me.dataview.totalrows < me.pagesize) {
                    me._requiresupdate = true;
                }
            }

            if (rendercolumns) {
                me._rendercolumnheaders();
            }
            else {
                if (this._rendersortcolumn) {
                    this._rendersortcolumn();
                }
                if (this._renderfiltercolumn) {
                    this._renderfiltercolumn();
                }
            }

            me._renderrows(me.virtualsizeinfo);

            if (this.gridcontent) {
                if (this.gridcontent[0].scrollTop != 0) {
                    this.gridcontent[0].scrollTop = 0;
                }

                if (this.gridcontent[0].scrollLeft != 0) {
                    this.gridcontent[0].scrollLeft = 0;
                }
            }

            if (prerender) {
                var tableheight = this.tableheight;
                this._arrange();
                if (tableheight != this.tableheight && this.autoheight) {
                    me._renderrows(me.virtualsizeinfo);
                }
            }

            if (this.rtl) {
                this._renderhorizontalscroll();
            }

            if (this.autosavestate) {
                if (this.initializedcall != null) {
                    if (this.savestate) {
                        this.savestate();
                    }
                }
            }

            return true;
        },

        _updatecolumnwidths: function () {
            var totalwidth = this.host.width();
            var hostwidth = totalwidth;
            var allcharacters = '';
            if (this.columns == undefined || this.columns.records == undefined)
                return;

            var self = this.that;
            $.each(this.columns.records, function (i, value) {
                if (!(this.hidden && this.hideable)) {
                    if (this.width.toString().indexOf('%') != -1 || this._percentagewidth != undefined) {
                        var value = 0;
                        var offset = self.vScrollBar[0].style.visibility == 'hidden' ? 0 : self.scrollbarsize + 5;
                        value = parseInt(this.width) * hostwidth / 100;
                        if (this._percentagewidth != undefined) {
                            value = parseInt(this._percentagewidth) * (hostwidth - offset) / 100;
                        }

                        if (value < this.minwidth && this.minwidth != 'auto') value = this.minwidth;
                        if (value > this.maxwidth && this.maxwidth != 'auto') value = this.maxwidth;
                        totalwidth -= Math.round(value);
                    }
                    else if (this.width != 'auto' && !this._width) {
                        totalwidth -= this.width;
                    }
                    else {
                        allcharacters += this.text;
                    }
                }
            });

            var tableheight = this._gettableheight();

            if (!this.autoheight) {
                if (this.virtualsizeinfo && this.virtualsizeinfo.virtualheight > tableheight) {
                    if (this.groupable && this.groups.length > 0) {
                        if (this.dataview && this.dataview.loadedrootgroups && !this.groupsexpandedbydefault) {
                            var groupsheight = this.dataview.loadedrootgroups.length * this.rowsheight;
                            if (this.pageable) {
                                for (var q = 0; q < this.dataview.rows.length; q++) {
                                    if (this.dataview.rows[q].group && this.dataview.rows[q].level === 0) {
                                        groupsheight += this.rowsheight;
                                    }
                                }
                            }
                            
                            if (groupsheight > tableheight) {
                                totalwidth -= this.scrollbarsize + 5;
                                hostwidth -= this.scrollbarsize + 5;
                            }
                            else if (this.vScrollBar.css('visibility') == 'visible') {
                                totalwidth -= this.scrollbarsize + 5;
                                hostwidth -= this.scrollbarsize + 5;
                            }
                        }
                        else {
                            totalwidth -= this.scrollbarsize + 5;
                            hostwidth -= this.scrollbarsize + 5;
                        }
                    }
                    else {
                        totalwidth -= this.scrollbarsize + 5;
                        hostwidth -= this.scrollbarsize + 5;
                    }
                }
            }
            var indent = this.rowdetails && this.showrowdetailscolumn ? (1 + this.groups.length) * this.groupindentwidth : (this.groups.length) * this.groupindentwidth;
            hostwidth -= indent;

            var columnheader = this.columnsheader.find('#columntable' + this.element.id);
            if (columnheader.length == 0)
                return;

            var columns = columnheader.find('.jqx-grid-column-header');
            var left = 0;
            $.each(this.columns.records, function (i, value) {
                var column = $(columns[i]);
                var percentage = false;
                var desiredwidth = this.width;
                if (this.width.toString().indexOf('%') != -1 || this._percentagewidth != undefined) {
                    if (this._percentagewidth != undefined) {
                        desiredwidth = parseInt(this._percentagewidth) * hostwidth / 100;
                    }
                    else {
                        desiredwidth = parseInt(this.width) * hostwidth / 100;
                    }
                    percentage = true;
                }

                if (this.width != 'auto' && !this._width && !percentage) {
                    if (parseInt(column[0].style.width) != this.width) {
                        column.width(this.width);
                    }
                }
                else if (percentage) {
                    if (desiredwidth < this.minwidth && this.minwidth != 'auto') {
                        desiredwidth = this.minwidth;
                        this.width = desiredwidth;
                    }
                    if (desiredwidth > this.maxwidth && this.maxwidth != 'auto') {
                        desiredwidth = this.maxwidth;
                        this.width = desiredwidth;
                    }

                    if (parseInt(column[0].style.width) != desiredwidth) {
                        column.width(desiredwidth);
                        this.width = desiredwidth;
                    }
                }
                else {
                    var width = Math.floor(totalwidth * (this.text.length / allcharacters.length));
                    if (isNaN(width)) {
                        width = this.minwidth;
                    }

                    if (width < 0) {
                        $element = $('<span>' + this.text + '</span>');
                        $(document.body).append($element);
                        width = 10 + $element.width();
                        $element.remove();
                    }
                    if (width < this.minwidth) {
                        width = this.minwidth;
                    }
                    if (width > this.maxwidth) {
                        width = this.maxwidth;
                    }
                    
                    totalwidth -= width;
                    allcharacters = allcharacters.substring(this.text.length);
                    this._width = 'auto';
                    this.width = width;
                    column.width(this.width);
                }
                if (parseInt(column[0].style.left) != left) {
                    column.css('left', left);
                }

                if (!(this.hidden && this.hideable)) {
                    left += this.width;
                }

                this._requirewidthupdate = true;
            });
            this.columnsheader.width(2 + left);
            columnheader.width(this.columnsheader.width());
            
            this._resizecolumngroups();
            if (this.showfilterrow && this.filterrow) {
                this.filterrow.width(this.columnsheader.width());
                this._updatefilterrowui();
            }
            if (this.autowidth) {
                this._arrange();
            }
        },

        _rendercolumnheaders: function () {
            var self = this.that;

            if (!this.prerenderrequired) {
                if (this._rendersortcolumn) {
                    this._rendersortcolumn();
                }
                if (this._renderfiltercolumn) {
                    this._renderfiltercolumn();
                }
                if (this.showfilterrow && this.filterrow) {
                    this.filterrow.width(this.columnsheader.width());
                    this._updatefilterrowui();
                }
                return;
            }

            this._columnsbydatafield = new Array();
            this.columnsheader.find('#columntable' + this.element.id).remove();
            var columnheader = $('<div id="columntable' + this.element.id + '" style="height: 100%; position: relative;"></div>')
            columnheader[0].cells = new Array();

            var k = 0;
            var left = 0;

            var allcharacters = "";
            var totalwidth = this.host.width();
            var hostwidth = totalwidth;

            var pinnedcolumns = new Array();
            var normalcolumns = new Array();

            $.each(this.columns.records, function (i, value) {
                if (!(this.hidden && this.hideable)) {
                    if (this.width != 'auto' && !this._width) {
                        if (this.width < this.minwidth && this.minwidth != 'auto') {
                            totalwidth -= this.minwidth;
                        }
                        else if (this.width > this.maxwidth && this.maxwidth != 'auto') {
                            totalwidth -= this.maxwidth;
                        }
                        else if (this.width.toString().indexOf('%') != -1) {
                            var value = 0;
                            var offset = self.vScrollBar[0].style.visibility == 'hidden' ? 0 : self.scrollbarsize + 5;
                            value = parseInt(this.width) * (hostwidth-offset) / 100;
                            if (value < this.minwidth && this.minwidth != 'auto') value = this.minwidth;
                            if (value > this.maxwidth && this.maxwidth != 'auto') value = this.maxwidth;
                            totalwidth -= value;
                        }
                        else {
                            if (typeof this.width == 'string') this.width = parseInt(this.width);
                            totalwidth -= this.width;
                        }
                    }
                    else {
                        allcharacters += this.text;
                    }
                }
                if (this.pinned || this.grouped || this.checkboxcolumn) {
                    if (self._haspinned) {
                        this.pinned = true;
                    }
                    pinnedcolumns[pinnedcolumns.length] = this;
                }
                else {
                    normalcolumns[normalcolumns.length] = this;
                }
            });

            if (!this.rtl) {
                for (var i = 0; i < pinnedcolumns.length; i++) {
                    this.columns.replace(i, pinnedcolumns[i]);
                }
                for (var j = 0; j < normalcolumns.length; j++) {
                    this.columns.replace(pinnedcolumns.length + j, normalcolumns[j]);
                }
            }
            else {
                var p = 0;
                pinnedcolumns.reverse();
                for (var i = this.columns.records.length - 1; i >= this.columns.records.length - pinnedcolumns.length; i--) {
                    this.columns.replace(i, pinnedcolumns[p++]);
                }
                for (var j = 0; j < normalcolumns.length; j++) {
                    this.columns.replace(j, normalcolumns[j]);
                }
            }

            var zindex = this.headerZIndex;
            var groupslength = self.groupable ? self.groups.length : 0;
            if (this.rowdetails && this.showrowdetailscolumn) {
                groupslength++;
            }

            var headerheight = self.columnsheader.height();
            if (this.showfilterrow) {
                if (!this.columngroups) {
                    headerheight = this.columnsheight;
                }
                else {
                    headerheight -= this.filterrowheight;
                }
            }
            var tableheight = this._gettableheight();

            if (this.virtualsizeinfo && this.virtualsizeinfo.virtualheight > tableheight) {
                if (this.groupable && this.groups.length > 0) {
                    if (this.dataview && this.dataview.loadedrootgroups && !this.groupsexpandedbydefault) {
                        var groupsheight = 0;
                        if (!this.pageable) {
                            var groupsheight = this.dataview.loadedrootgroups.length * this.rowsheight;
                        }
                        else if (this.pageable) {
                            for (var q = 0; q < this.dataview.rows.length; q++) {
                                if (this.dataview.rows[q].group && this.dataview.rows[q].level === 0) {
                                    groupsheight += this.rowsheight;
                                }
                            }
                        }
                        if (groupsheight > tableheight) {
                            totalwidth -= this.scrollbarsize + 5;
                            hostwidth -= this.scrollbarsize + 5;
                        }
                    }
                    else {
                        totalwidth -= this.scrollbarsize + 5;
                        hostwidth -= this.scrollbarsize + 5;
                    }
                }
                else {
                    if (!this.autoheight) {
                        totalwidth -= this.scrollbarsize + 5;
                        hostwidth -= this.scrollbarsize + 5;
                    }
                }
            }

            var indent = this.rowdetails && this.showrowdetailscolumn ? (1 + this.groups.length) * this.groupindentwidth : (this.groups.length) * this.groupindentwidth;
            hostwidth -= indent;

            var getcolumnheight = function (datafield, column) {
                var height = self.columngroupslevel * self.columnsheight;
                height = height - (column.level * self.columnsheight);
                return height;
            }

            $.each(this.columns.records, function (i, value) {
                this.height = self.columnsheight;
                if (self.columngroups) {
                    if (self.columngroups.length) {
                        this.height = getcolumnheight(this.datafield, this);
                        headerheight = this.height;
                    }
                }

                var classname = self.toTP('jqx-grid-column-header') + " " + self.toTP('jqx-widget-header');
                if (self.rtl) {
                    classname += " " + self.toTP('jqx-grid-column-header-rtl');
                }

                var pinnedZIndex = !self.rtl ? 50 + zindex-1 : 50 + zindex+1;
                var columnZIndex = !self.rtl ? zindex-- : zindex++;

                var column = $('<div role="columnheader" style="z-index: '  + columnZIndex + ';position: absolute; height: 100%;" class="' + classname + '"><div style="height: 100%; width: 100%;"></div></div>');

                if (self.columngroups) {
                    column[0].style.height = headerheight + 'px';
                    column[0].style.bottom = '0px';

                    if (this.pinned) {
                        column[0].style.zIndex = pinnedZIndex;
                    }
                }

                this.uielement = column;
                if (this.classname != '' && this.classname) {
                    column.addClass(this.classname);
                }

                var desiredwidth = this.width;
                var percentage = false;
                if (this.width.toString().indexOf('%') != -1 || this._percentagewidth != undefined) {
                    if (this._percentagewidth != undefined) {
                        desiredwidth = parseInt(this._percentagewidth) * hostwidth / 100;
                    }
                    else {
                        desiredwidth = parseInt(this.width) * hostwidth / 100;
                    }
                    percentage = true;
                }

                if (this.width != 'auto' && !this._width && !percentage) {
                    if (desiredwidth < this.minwidth && this.minwidth != 'auto') {
                        desiredwidth = this.minwidth;
                    }
                    if (desiredwidth > this.maxwidth && this.maxwidth != 'auto') {
                        desiredwidth = this.maxwidth;
                    }

                    column[0].style.width = parseInt(desiredwidth) + 'px';
                }
                else if (percentage) {
                    if (desiredwidth < this.minwidth && this.minwidth != 'auto') {
                        desiredwidth = this.minwidth;
                    }
                    if (desiredwidth > this.maxwidth && this.maxwidth != 'auto') {
                        desiredwidth = this.maxwidth;
                    }

                    if (this._percentagewidth == undefined || this.width.toString().indexOf('%') != -1) {
                        this._percentagewidth = this.width;
                    }
                    column.width(desiredwidth);
                    this.width = desiredwidth;
                }
                else {
                    var width = Math.round(totalwidth * (this.text.length / allcharacters.length));
                    if (isNaN(width)) {
                        width = this.minwidth;
                    }

                    if (width < 0) {
                        $element = $('<span>' + this.text + '</span>');
                        $(document.body).append($element);
                        width = 10 + $element.width();
                        $element.remove();
                    }
                    if (width < this.minwidth) {
                        width = this.minwidth;
                    }
                    if (width > this.maxwidth) {
                        width = this.maxwidth;
                    }

                    this._width = 'auto';
                    this.width = width;
                    totalwidth -= width;
                    allcharacters = allcharacters.substring(this.text.length);
                    desiredwidth = this.width;
                    column.width(this.width);
                }

                if (this.hidden && this.hideable) {
                    column.css('display', 'none');
                }

                var columncontentcontainer = $(column.children()[0]);
                var menuinnerelementclassname = self.rtl ? self.toTP('jqx-grid-column-menubutton') + " " + self.toTP('jqx-grid-column-menubutton-rtl') : self.toTP('jqx-grid-column-menubutton');
                var columnsmenu = $('<div style="height: ' + headerheight + 'px; display: none; left: 100%; top: 0%; position: absolute;"><div class="' + menuinnerelementclassname + '" style="width: 100%; height:100%;"></div></div>');
               
                if (!self.enableanimations) {
                    columnsmenu.css('margin-left', -16);
                }
                if (self.rtl) {
                    columnsmenu.css('left', '0px');
                }

                this.columnsmenu = columnsmenu[0];
                columnheader[0].cells[i] = column[0];
                columnsmenu[0].style.width = parseInt(self.columnsmenuwidth) + 'px';
                var showcolumnsmenu = self.columnsmenu;
                var shouldhandledragdrop = false;
                var detailscolumn = false;

                var isgroupcolumn = (self.groupable && groupslength > 0 && k < groupslength) || (self.rowdetails && k < groupslength);
                if (self.rtl) {
                    isgroupcolumn = (self.groupable && groupslength > 0 && k < groupslength) || (self.rowdetails && k < groupslength);
                    isgroupcolumn &= i > self.columns.records.length - 1 - groupslength;
                }

                if (isgroupcolumn) {
                    k++;
                    showcolumnsmenu &= false;
                    this.sortable = false;
                    this.editable = false;
                    detailscolumn = true;
                }
                else {
                    var columnContent = this.renderer != null ? this.renderer(this.text, this.align, headerheight) : self._rendercolumnheader(this.text, this.align, headerheight, self);
                    if (columnContent == null) {
                        columnContent = self._rendercolumnheader(this.text, this.align, headerheight, self);
                    }
                    if (this.renderer != null) columnContent = $(columnContent);
                    showcolumnsmenu &= true;
                    shouldhandledragdrop = true;
                }
                if (self.WinJS) {
                    MSApp.execUnsafeLocalFunction(function () {
                        columncontentcontainer.append($(columnContent));
                    });
                }
                else {
                    if (this.renderer) {
                        columncontentcontainer.append($(columnContent));
                    }
                    else {
                        if (columnContent) {
                            columncontentcontainer[0].innerHTML = columnContent;
                        }
                    }
                }

                if (columnContent != null) {
                    var iconscontainer = $('<div class="iconscontainer" style="height: ' + headerheight + 'px; margin-left: -32px; display: block; position: absolute; left: 100%; top: 0%; width: 32px;">'
                        + '<div class="filtericon ' + self.toTP('jqx-widget-header') + '" style="height: ' + headerheight + 'px; float: right; display: none; width: 16px;"><div class="' + self.toTP('jqx-grid-column-filterbutton') + '" style="width: 100%; height:100%;"></div></div>'
                        + '<div class="sortasc ' + self.toTP('jqx-widget-header') + '" style="height: ' + headerheight + 'px; float: right; display: none; width: 16px;"><div class="' + self.toTP('jqx-grid-column-sortascbutton') + '" style="width: 100%; height:100%;"></div></div>'
                        + '<div class="sortdesc ' + self.toTP('jqx-widget-header') + '" style="height: ' + headerheight + 'px; float: right; display: none; width: 16px;"><div class="' + self.toTP('jqx-grid-column-sortdescbutton') + '" style="width: 100%; height:100%;"></div></div>'
                        + '</div>');
                    columnsmenu.addClass(self.toTP('jqx-widget-header'));
                    columncontentcontainer.append(iconscontainer);

                    var iconschildren = iconscontainer.children();
                    this.sortasc = iconschildren[1];
                    this.sortdesc = iconschildren[2];
                    this.filtericon = iconschildren[0];

                    this.iconscontainer = iconscontainer;
                    if (self.rtl) {
                        iconscontainer.css('margin-left', '0px');
                        iconscontainer.css('left', '0px');
                        $(this.sortasc).css('float', 'left');
                        $(this.filtericon).css('float', 'left');
                        $(this.sortdesc).css('float', 'left');
                    }
                    if (!self.autoshowfiltericon && this.filterable) {
                         $(this.filtericon).css('display', 'block');
                    }

                }

                if (showcolumnsmenu) {
                    self._handlecolumnsmenu(self, columncontentcontainer, column, columnsmenu, this);
                    if (!this.menu) columnsmenu.hide();
                }

                columnheader.append(column);

                if (self.groupable && shouldhandledragdrop) {
                    column[0].id = self.dataview.generatekey();
                    if (self._handlecolumnstogroupsdragdrop) {
                        self._handlecolumnstogroupsdragdrop(this, column);
                    }
                    else throw new Error('jqxGrid: Missing reference to jqxgrid.grouping.js.');
                }
                if (self.columnsreorder && this.draggable && self._handlecolumnsdragreorder) {
                    self._handlecolumnsdragreorder(this, column);
                }

                var columnitem = this;
                self.addHandler(column, 'click', function (event) {
                    if (columnitem.checkboxcolumn)
                        return true;

                    if (self.sorttogglestates > 0 && self._togglesort) {
                        if (!self._loading) {
                            self._togglesort(columnitem);
                        }
                    }
                    event.preventDefault();
                    self._raiseEvent(7, { column: columnitem.getcolumnproperties(), datafield: columnitem.datafield, originalEvent: event });
                });

                if (columnitem.resizable && self.columnsresize && !detailscolumn) {
                    var isTouchDevice = false;
                    var eventname = 'mousemove';
                    if (self.isTouchDevice() && self.touchmode !== true) {
                        isTouchDevice = true;
                        eventname = $.jqx.mobile.getTouchEventName('touchstart');
                    }
                    self.addHandler(column, eventname, function (event) {
                        var pagex = parseInt(event.pageX);
                        var offset = 5;
                        var columnleft = parseInt(column.coord().left);
                        if (self.hasTransform) {
                            columnleft = $.jqx.utilities.getOffset(column).left;
                        }
                        if (self.resizing) {
                            return true;
                        }

                        if (self._handlecolumnsresize) {
                            if (isTouchDevice) {
                                var touches = self.getTouches(event);
                                var touch = touches[0];
                                pagex = touch.pageX;
                                offset = 40;
                                if (pagex >= columnleft + columnitem.width - offset) {
                                    self.resizablecolumn = { columnelement: column, column: columnitem };
                                    column.css('cursor', "col-resize");
                                }
                                else {
                                    column.css('cursor', "");
                                    self.resizablecolumn = null;
                                }
                                return true;
                            }

                            var colwidth = columnitem.width;
                            if (self.rtl) colwidth = 0;

                            if (pagex >= columnleft + colwidth - offset) {
                                if (pagex <= columnleft + colwidth + offset) {
                                    self.resizablecolumn = { columnelement: column, column: columnitem };
                                    column.css('cursor', "col-resize");
                                    return false;
                                }
                                else {
                                    column.css('cursor', "");
                                    self.resizablecolumn = null;
                                }
                            }
                            else {
                                column.css('cursor', "");
                                if (pagex < columnleft + colwidth - offset) {
                                    if (!columnitem._animating && !columnitem._menuvisible) {
                                        column.mouseenter();
                                    }
                                }

                                self.resizablecolumn = null;
                            }
                        }
                    });
                }

                column.css('left', left);

                if (!(this.hidden && this.hideable)) {
                    left += desiredwidth;
                }

                if (columnitem.rendered) {
                    var result = columnitem.rendered($(columncontentcontainer[0].firstChild), columnitem.align, headerheight);
                    if (result && iconscontainer != null) {
                        iconscontainer.hide();
                    }
                }
                if (columnitem.checkboxcolumn) {
                    if (iconscontainer) {
                        iconscontainer.hide();
                    }
                    if (!self.host.jqxCheckBox) {
                        throw new Error("jqxGrid: Missing reference to jqxcheckbox.js");
                    }

                    columncontentcontainer.html('<div style="cursor: pointer; margin-left: 5px; top: 50%; margin-top: -8px; position: relative;"></div>');
                    var checkboxelement = columncontentcontainer.find('div:first');
                    checkboxelement.jqxCheckBox({_canFocus: false, disabledContainer: true, theme: self.theme, enableContainerClick: false, width: 16, height: 16, animationShowDelay: 0, animationHideDelay: 0 });
                    columnitem.checkboxelement = checkboxelement;
                    var checkboxinstance = checkboxelement.data().jqxCheckBox.instance;
                    self._checkboxcolumn = columnitem;
                    checkboxinstance.updated = function (event, checked, oldchecked) {
                        self._checkboxcolumnupdating = true;
                        if (checked) {
                            self.selectallrows();
                        }
                        else {
                            self.clearselection(true, false);
                        }
                        self._checkboxcolumnupdating = false;
                    }
                }
            });

            if (left > 0) {
                this.columnsheader.width(2 + left);
            }
            else {
                this.columnsheader.width(left);
            }

            this.columnsrow = columnheader;
            self.columnsheader.append(columnheader);
            if (this.showfilterrow && this._updatefilterrow) {
                if (!this.columngroups) {
                    columnheader.height(this.columnsheight);
                }
                else {
                    columnheader.height(this.columngroupslevel*this.columnsheight);                    
                }

                if (!this.filterrow) {
                    var filterrow = $("<div></div>");
                    filterrow[0].id = "filterrow." + this.element.id;
                    filterrow.height(this.filterrowheight);
                    this.filterrow = filterrow;
                }
                this.filterrow.width(left);

                this.columnsheader.append(this.filterrow);
                this._updatefilterrow();
            }

            columnheader.width(left);
            if (this._handlecolumnsdragdrop) {
                this._handlecolumnsdragdrop();
            }
            if (this._handlecolumnsreorder) {
                this._handlecolumnsreorder();
            }
            if (this._rendersortcolumn) {
                this._rendersortcolumn();
            }
            if (this._renderfiltercolumn) {
                this._renderfiltercolumn();
            }
            if (this._handlecolumnsresize) {
                this._handlecolumnsresize();
            }
            if (this.columngroups) {
                this._rendercolumngroups();
            }
            if (this._updatecheckboxselection) {
                this._updatecheckboxselection();
            }
        },

        _rendercolumngroups: function()
        {
            if (!this.columngroups) return;
            var pinnedColumns = 0;
            for (var i = 0; i < this.columns.records.length; i++) {
                if (this.columns.records[i].pinned) pinnedColumns++;
            }

            var zindex = this.headerZIndex - pinnedColumns + this.columns.records.length;
            var self = this.that;
            var classname = self.toTP('jqx-grid-column-header') + " " + self.toTP('jqx-grid-columngroup-header') + " " + self.toTP('jqx-widget-header');
            if (self.rtl) {
                classname += " " + self.toTP('jqx-grid-columngroup-header-rtl');
            }
            var columnheader = this.columnsheader.find('#columntable' + this.element.id);
            columnheader.find('jqx-grid-columngroup-header').remove();

            for (var j = 0; j < this.columngroupslevel-1; j++) {
                for (var i = 0; i < this.columngroups.length; i++) {
                    var group = this.columngroups[i];
                    var level = group.level;
                    if (level !== j)
                        continue;

                    var top = level * this.columnsheight;
                    var left = 99999;
                    if (group.groups) {
                        var getwidth = function (group) {
                            var width = 0;
                            for (var j = 0; j < group.groups.length; j++) {
                                var currentgroup = group.groups[j];
                                if (!currentgroup.groups) {
                                    if (!currentgroup.hidden) {
                                        width += currentgroup.width;
                                        left = Math.min(parseInt(currentgroup.element.style.left), left);
                                    }
                                }
                                else {
                                    width += getwidth(currentgroup);
                                }
                            }
                            return width;
                        }
                        group.width = getwidth(group);
                        group.left = left;

                        var height = this.columnsheight;
                        var columnZIndex = zindex--;
                        var column = $('<div role="columnheader" style="z-index: ' + columnZIndex + ';position: absolute;" class="' + classname + '"></div>');
                        var element = $(this._rendercolumnheader(group.text, group.align, this.columnsheight, this));
                        if (group.renderer) {
                            var element = $("<div style='height: 100%; width: 100%;'></div>");
                            var content = group.renderer(group.text, group.align, height);
                            element.html(content);
                        }

                        column.append(element);
                        column[0].style.left = left + 'px';
                        if (left === 0) {
                            column[0].style.borderLeftColor = 'transparent';
                        }
                        column[0].style.top = top + 'px';
                        column[0].style.height = height + 'px';
                        column[0].style.width = -1 + group.width + 'px';
                        columnheader.append(column);
                        group.element = column;
                        if (group.rendered) {
                            group.rendered(element, group.align, height);
                        }
                    }
                }
            }
        },

        _resizecolumngroups: function()
        {
            if (!this.columngroups) return;
            for (var i = 0; i < this.columngroups.length; i++) {
                var group = this.columngroups[i];
                var level = group.level;
                var top = level * this.columnsheight;
                var left = 99999;
                if (group.groups) {
                    var getwidth = function (group) {
                        var width = 0;
                        for (var j = 0; j < group.groups.length; j++) {
                            var currentgroup = group.groups[j];
                            if (!currentgroup.groups) {
                                if (!currentgroup.hidden) {
                                    width += currentgroup.width;
                                    left = Math.min(parseInt(currentgroup.element.style.left), left);
                                }
                            }
                            else {
                                width += getwidth(currentgroup);
                            }
                        }
                        return width;
                    }
                    group.width = getwidth(group);
                    group.left = left;

                    var height = this.columnsheight;
                    var column = group.element;
                    column[0].style.left = left + 'px';
                    column[0].style.top = top + 'px';
                    column[0].style.height = height + 'px';
                    column[0].style.width = -1 + group.width + 'px';
                }
            }
        },

        _handlecolumnsmenu: function (self, columncontentcontainer, column, columnsmenu, columnitem) {
            self.dragmousedown = null;
            columnsmenu[0].id = self.dataview.generatekey();

            columncontentcontainer.append(columnsmenu);
            column[0].columnsmenu = columnsmenu[0];
            columnitem.element = column[0];

            var menuoffset = this.columnsmenuwidth + 1;

            var showcolumnsmenu = function () {
                if (!columnitem.menu)
                    return false;

                if (!self.resizing) {
                    if (columnitem._menuvisible && self._hasOpenedMenu) return false;

                    columnitem._animating = true;
                    if (self.menuitemsarray && self.menuitemsarray.length > 0) {
                        if (!self.enableanimations) {
                            columnsmenu.css('display', 'block');
                            var left = !self.rtl ? -48 : 16;
                            columnitem.iconscontainer.css('margin-left', left + 'px');
                            columnitem._animating = false;
                            columnitem._menuvisible = true;
                        }
                        else {
                            columnsmenu.css('display', 'block');
                            columnsmenu.stop();
                            columnitem.iconscontainer.stop();
                            if (!self.rtl) {
                                columnsmenu.css('margin-left', '0px');
                                columnsmenu.animate({
                                    'margin-left': -menuoffset
                                }, 'fast', function () {
                                    columnsmenu.css('display', 'block');
                                    columnitem._animating = false;
                                    columnitem._menuvisible = true;
                                }
                                );
                            }
                            else {
                                columnsmenu.css('margin-left', -menuoffset);
                                columnsmenu.animate({
                                    'margin-left': '0px'
                                }, 'fast', function () {
                                    columnsmenu.css('display', 'block');
                                    columnitem._animating = false;
                                    columnitem._menuvisible = true;
                                }
                                );
                            }

                            var left = !self.rtl ? -(32+menuoffset) : menuoffset;
                            columnitem.iconscontainer.animate({
                                'margin-left': left
                            }, 'fast');
                        }
                    }
                }
            }
            
            self.addHandler(column, 'mouseenter', function (event) {
                var pagex = parseInt(event.pageX);
                var offset = self.columnsresize && columnitem.resizable ? 3 : 0;
                var columnleft = parseInt(column.coord().left);
                if (self.hasTransform) {
                    columnleft = $.jqx.utilities.getOffset(column).left;
                }
              
                var colwidth = columnitem.width;
                if (self.rtl) colwidth = 0;

                if (offset != 0) {
                    if (pagex >= columnleft + colwidth - offset) {
                        if (pagex <= columnleft + colwidth + offset) {
                            return false;
                        }
                    }
                }

                var scrolling = self.vScrollInstance.isScrolling();
                if (columnitem.menu && self.autoshowcolumnsmenubutton && !scrolling) {
                    showcolumnsmenu();
                }
            });

            if (!self.autoshowcolumnsmenubutton) {
                columnsmenu.css('display', 'block');
                var left = !self.rtl ? -48 : 16;
                columnitem.iconscontainer.css('margin-left', left + 'px');
                if (!self.rtl) {
                    columnsmenu.css({ 'margin-left': -menuoffset });
                }
                else {
                    columnsmenu.css({ 'margin-left': '0px' });
                }
            }

            self.addHandler(column, 'mouseleave', function (event) {
                if (self.menuitemsarray && self.menuitemsarray.length > 0 && columnitem.menu) {
                    var menu = $.data(document.body, "contextmenu" + self.element.id);
                    if (menu != undefined && columnsmenu[0].id == menu.columnsmenu.id) {
                        return;
                    }

                    if (self.autoshowcolumnsmenubutton) {
                        if (!self.enableanimations) {
                            columnsmenu.css('display', 'none');
                            var left = !self.rtl ? -32 : 0;
                            columnitem.iconscontainer.css('margin-left', left + 'px');
                            columnitem._menuvisible = false;
                        }
                        else {
                            if (!self.rtl) {
                                columnsmenu.css('margin-left', -menuoffset);
                            }
                            else columnsmenu.css('margin-left', '0px');

                            columnsmenu.stop();
                            columnitem.iconscontainer.stop();
                            if (!self.rtl) {
                                columnsmenu.animate({
                                    'margin-left': 0
                                }, 'fast', function () {
                                    columnsmenu.css('display', 'none');
                                    columnitem._menuvisible = false;
                                });
                            }
                            else {
                                columnsmenu.animate({
                                    'margin-left': -menuoffset
                                }, 'fast', function () {
                                    columnsmenu.css('display', 'none');
                                    columnitem._menuvisible = false;
                                });
                            }

                            var left = !self.rtl ? -32 : 0;
                            columnitem.iconscontainer.animate({
                                'margin-left': left
                            }, 'fast');
                        }
                    }
                }
            });

            var canopen = true;
            var openedmenu = "";
            var $filtericon = $(columnitem.filtericon);

            self.addHandler(columnsmenu, 'mousedown', function (event) {
                if (!self.gridmenu) self._initmenu();
                canopen = !$.data(self.gridmenu[0], 'contextMenuOpened' + self.gridmenu[0].id);
                openedmenu = $.data(document.body, "contextmenu" + self.element.id);
                if (openedmenu != null) {
                    openedmenu = openedmenu.column.datafield;
                }
            });

            self.addHandler($filtericon, 'mousedown', function (event) {
                if (!self.gridmenu) self._initmenu();
                canopen = !$.data(self.gridmenu[0], 'contextMenuOpened' + self.gridmenu[0].id);
                openedmenu = $.data(document.body, "contextmenu" + self.element.id);
                if (openedmenu != null) {
                    openedmenu = openedmenu.column.datafield;
                }
            });

            var opencolumnsmenu = function () {
                if (!columnitem.menu)
                    return false;

                if (!self.gridmenu) {
                    self._initmenu();
                }

                var offset = columnsmenu.coord(true);
                var top = columnsmenu.height();

                if (!canopen) {
                    canopen = true;

                    if (openedmenu == columnitem.datafield) {
                        self._closemenu();
                        return false;
                    }
                }

                var hostOffset = self.host.coord(true);
                if (self.hasTransform) {
                    hostOffset = $.jqx.utilities.getOffset(self.host);
                    offset = $.jqx.utilities.getOffset(columnsmenu);
                }

                if (hostOffset.left + self.host.width() > parseInt(offset.left) + self.gridmenu.width()) {
                    self.gridmenu.jqxMenu('open', offset.left, offset.top + top);
                }
                else {
                    self.gridmenu.jqxMenu('open', columnsmenu.width() + offset.left - self.gridmenu.width(), offset.top + top);
                }
                if (self.gridmenu.width() < 100) {
                    self._arrangemenu();
                }
                self._hasOpenedMenu = true;

                var sortascmenuitem = self._getmenuitembyindex(0);
                var sortdescmenuitem = self._getmenuitembyindex(1);
                var sortremovemenuitem = self._getmenuitembyindex(2);
                var groupmenuitem = self._getmenuitembyindex(3);
                var groupremoveitem = self._getmenuitembyindex(4);
                var filteritem = self._getmenuitembyindex(5);

                if (sortascmenuitem != null && sortdescmenuitem != null && sortremovemenuitem != null) {
                    var sortable = columnitem.sortable && self.sortable;
                    self.gridmenu.jqxMenu('disable', sortascmenuitem.id, !sortable);
                    self.gridmenu.jqxMenu('disable', sortdescmenuitem.id, !sortable);
                    self.gridmenu.jqxMenu('disable', sortremovemenuitem.id, !sortable);

                    if (columnitem.datafield) {
                        if (self.sortcolumn == columnitem.datafield) {
                            var sortinfo = self.getsortinformation();
                            if (sortable) {
                                if (sortinfo.sortdirection.ascending) {
                                    self.gridmenu.jqxMenu('disable', sortascmenuitem.id, true);
                                }
                                else {
                                    self.gridmenu.jqxMenu('disable', sortdescmenuitem.id, true);
                                }
                            }
                        }
                        else {
                            self.gridmenu.jqxMenu('disable', sortremovemenuitem.id, true);
                        }
                    }
                }
                if (groupmenuitem != null && groupremoveitem != null) {
                    if (!self.groupable || !columnitem.groupable) {
                        self.gridmenu.jqxMenu('disable', groupremoveitem.id, true);
                        self.gridmenu.jqxMenu('disable', groupmenuitem.id, true);
                    }
                    else {
                        if (self.groups && self.groups.indexOf(columnitem.datafield) != -1) {
                            self.gridmenu.jqxMenu('disable', groupmenuitem.id, true);
                            self.gridmenu.jqxMenu('disable', groupremoveitem.id, false);
                        }
                        else {
                            self.gridmenu.jqxMenu('disable', groupmenuitem.id, false);
                            self.gridmenu.jqxMenu('disable', groupremoveitem.id, true);
                        }
                    }
                }
                if (filteritem != null) {

                    self._updatefilterpanel(self, filteritem, columnitem);

                    var itemscount = 0;
                    if (self.sortable && self._togglesort && self.showsortmenuitems) {
                        itemscount += 3;
                    }

                    if (self.groupable && self.addgroup && self.showgroupmenuitems) {
                        itemscount += 2;
                    }

                    var height = itemscount * 27 + 3;
                    if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                        height += 20;
                        $(filteritem).height(190);
                    }

                    if (self.filterable && self.showfiltermenuitems) {
                        if (!columnitem.filterable) {
                            self.gridmenu.height(height);
                            $(filteritem).css('display', 'none');
                        }
                        else {
                            self.gridmenu.height(height + 180);
                            $(filteritem).css('display', 'block');
                        }
                    }
                }
                $.data(document.body, "contextmenu" + self.element.id, { column: columnitem, columnsmenu: columnsmenu[0] });
            }

            self.addHandler($filtericon, 'click', function (event) {
                if (!columnitem.menu)
                    return false;
                if (!self.showfilterrow) {
                    showcolumnsmenu();
                    opencolumnsmenu();
                }
                return false;
            });

            self.addHandler(columnsmenu, 'click', function (event) {
                if (!columnitem.menu)
                    return false;

                opencolumnsmenu();
                return false;
            });
        },

        _removecolumnhandlers: function (columnitem) {
            var self = this.that;
            var column = $(columnitem.element);
            if (column.length > 0) {
                self.removeHandler(column, 'mouseenter');
                self.removeHandler(column, 'mouseleave');
                var $filtericon = $(columnitem.filtericon);
                self.removeHandler($filtericon, 'mousedown');
                self.removeHandler($filtericon, 'click');
                self.removeHandler(column, 'click');
                self.removeHandler(column, 'mousemove');
                if (self.columnsreorder) {
                    self.removeHandler(column, 'mousedown.drag');
                    self.removeHandler(column, 'mousemove.drag');
                }
                self.removeHandler(column, 'dragstart');
                if (column[0].columnsmenu) {
                    var columnsmenu = $(column[0].columnsmenu);
                    self.removeHandler(columnsmenu, 'click');
                    self.removeHandler(columnsmenu, 'mousedown');
                }
            }
        },

        _rendercolumnheader: function (text, align, headerheight, self) {
            var margin = '4px';

            if (self.columngroups) {
                margin = (headerheight / 2 - this._columnheight / 2);
                if (margin < 0) {
                    margin = 4;
                }
                margin += 'px';
            }
            else {
                if (this.columnsheight != 25) {
                    margin = (this.columnsheight / 2 - this._columnheight / 2);
                    if (margin < 0) {
                        margin = 4;
                    }
                    margin += 'px';
                }
            }

            if (this.enableellipsis) {
                return '<div style="padding-bottom: 2px; overflow: hidden; text-overflow: ellipsis; text-align: ' + align + '; margin-left: 4px; margin-right: 2px; margin-bottom: ' + margin + '; margin-top: ' + margin + ';">' + '<span style="text-overflow: ellipsis; cursor: default;">' + text + '</span>' + '</div>';
            }

            if (align == 'center' || align == 'middle')
                return '<div style="padding-bottom: 2px; text-align: center; margin-top: ' + margin + ';">' + '<a href="#">' + text + '</a>' + '</div>';

            var link = '<a style="margin-top: ' + margin + '; float: ' + align + ';" href="#">' + text + '</a>';
            return link;
        },

        _renderrows: function (virtualsizeinfo, forceVirtualRefresh, reason) {
            var self = this.that;

            if ((this.pageable || this.groupable) && (this.autoheight || this.autorowheight)) {
                if (this.table != null && this.table[0].rows != null && this.table[0].rows.length < this.dataview.rows.length) {
                    self.prerenderrequired = true;
                }
            }

            if (!this.pageable && (this.autoheight || this.autorowheight) && (this.virtualmode || this.unboundmode)) {
                var recordscount = this.source.totalrecords;
                if (!isNaN(recordscount)) {
                    if (this.table != null && this.table[0].rows != null && this.table[0].rows.length != recordscount) {
                        self.prerenderrequired = true;
                    }
                }
            }
            if ((this.autoheight || this.autorowheight) && !self.prerenderrequired) {
                if (this.table && this.table[0].rows) {
                    if (this.table[0].rows.length < this.dataview.records.length) {
                        if (this.pageable && this.table[0].rows.length < this.dataview.pagesize) {
                            self.prerenderrequired = true;
                        }
                        else if (!this.pageable) {
                            self.prerenderrequired = true;
                        }
                    }
                    if (this.table[0].rows.length < this.dataview.cachedrecords.length) {
                        if (this.pageable && this.table[0].rows.length < this.dataview.pagesize) {
                            self.prerenderrequired = true;
                        }
                        else if (!this.pageable) {
                            self.prerenderrequired = true;
                        }
                    }
                }
            }

            self._prerenderrows(virtualsizeinfo);
            if (self._requiresupdate) {
                self._requiresupdate = false;
                self._updatepageviews();
            }

            var callrenderrows = function () {
                if (self._loading) return;

                if (self.WinJS) {
                    MSApp.execUnsafeLocalFunction(function () {
                        self._rendervisualrows();
                    });
                }
                else {
                    self._rendervisualrows();
                }

                if (self.virtualmode && self.showaggregates && self._updateaggregates) {
                    self.refreshaggregates();
                }
            }
            var oldie = $.jqx.browser.msie && $.jqx.browser.version < 10;

            if (this.virtualmode) {
                var loadondemand = function () {
                    if (self.rendergridrows) {
                        var startboundindex = self._startboundindex;
                        if (startboundindex == undefined) startboundindex = 0;
                        var endboundindex = startboundindex + 1 + self.dataview.pagesize;
                        if (startboundindex != null && endboundindex != null) {
                            var isdataadapter = self.source._source ? true : false;
                            var sourcestartindex = !isdataadapter ? self.source.recordstartindex : self.source._source.recordstartindex;

                            if (sourcestartindex != startboundindex || forceVirtualRefresh == true) {
                                if (!isdataadapter) {
                                    self.source.recordstartindex = startboundindex;
                                    self.source.recordendindex = endboundindex;
                                }
                                else {
                                    if (endboundindex >= self.source._source.totalrecords) {
                                        endboundindex = self.source._source.totalrecords;
                                        startboundindex = endboundindex - self.dataview.pagesize - 1;
                                        if (startboundindex < 0) startboundindex = 0;
                                        if (self.source._source.recordendindex == endboundindex && self.source._source.recordstartindex == startboundindex) {
                                            return;
                                        }
                                    }

                                    self.source._source.recordstartindex = startboundindex;
                                    self.source._source.recordendindex = endboundindex;
                                }
                                self.updatebounddata();
                            }
                        }
                    }
                }

                if (this.loadondemand) {
                    callrenderrows();
                    loadondemand();
                    this.loadondemand = false;
                }
                var ie10 = this._browser == undefined ? this._isIE10() : this._browser;

                if (this.editable && this.editcell && !this.vScrollInstance.isScrolling() && !this.hScrollInstance.isScrolling()) {
                    callrenderrows();
                }
                else {
                    if (this.autoheight) {
                        callrenderrows();
                    }
                    else {
                        if (ie10 || oldie || $.jqx.browser.mozilla || (navigator && navigator.userAgent.indexOf('Safari') != -1)) {
                            if (this._scrolltimer != null) {
                                clearTimeout(this._scrolltimer);
                            }
                            this._scrolltimer = setTimeout(function () {
                                callrenderrows();
                            }, 5);
                        }
                        else {
                            callrenderrows();
                        }
                    }
                }
            }
            else {
                if (this.scrollmode == 'deferred' && (this.hScrollInstance.isScrolling() || this.vScrollInstance.isScrolling())) {
                    if (this._scrolltimer != null) {
                        clearInterval(this._scrolltimer);
                    }
                    var row = this._getfirstvisualrow();
                    if (row != null) {
                        var renderer = function (data) {
                            if (row == null) return "";
                            var table = "<table>";
                            var columns = self.deferreddatafields;
                            if (columns == null) {
                                if (self.columns.records.length > 0) {
                                    columns = new Array();
                                    columns.push(self.columns.records[0].displayfield);
                                }
                            }

                            for (var i = 0; i < columns.length; i++) {
                                var field = columns[i];
                                var column = self._getcolumnbydatafield(field);
                                if (column) {
                                    var cellvalue = self._getcellvalue(column, row);
                                    if (column.cellsformat != '') {
                                        if ($.jqx.dataFormat) {
                                            if ($.jqx.dataFormat.isDate(cellvalue)) {
                                                cellvalue = $.jqx.dataFormat.formatdate(cellvalue, column.cellsformat, self.gridlocalization);
                                            }
                                            else if ($.jqx.dataFormat.isNumber(cellvalue)) {
                                                cellvalue = $.jqx.dataFormat.formatnumber(cellvalue, column.cellsformat, self.gridlocalization);
                                            }
                                        }
                                    }
                                    table += "<tr><td>" + cellvalue + "</td></tr>";
                                }
                            }
                            table += "</table>";
                            return table;
                        }

                        var html = this.scrollfeedback ? this.scrollfeedback(row.bounddata) : renderer(row.bounddata);
                        if (html != this._scrollelementcontent) {
                            this._scrollelement[0].innerHTML = html;
                            this._scrollelementcontent = html;
                        }
                    }

                    this._scrollelement.css('visibility', 'visible');
                    this._scrollelementoverlay.css('visibility', 'visible');
                    this._scrollelement.css('margin-top', -this._scrollelement.height() / 2);

                    this._scrolltimer = setInterval(function () {
                        if (!self.hScrollInstance.isScrolling() && !self.vScrollInstance.isScrolling()) {
                            callrenderrows();
                            self._scrollelement.css('visibility', 'hidden');
                            self._scrollelementoverlay.css('visibility', 'hidden');
                            clearInterval(self._scrolltimer);
                            if (row) {
                                self.ensurerowvisible(row.visibleindex);
                            }
                        }
                    }, 100);

                    return;
                }

                if (navigator && navigator.userAgent.indexOf('Chrome') == -1 && navigator.userAgent.indexOf('Safari') != -1) {
                    this.updatedelay = 1;
                }
                if (this.touchDevice != undefined && this.touchDevice == true) {
                    this.updatedelay = 5;
                }

                var ie10 = this._browser == undefined ? this._isIE10() : this._browser;

                if (ie10 || oldie) {
                    this.updatedelay = 5;
                }

                if ((ie10 || $.jqx.browser.mozilla) && this.hScrollInstance.isScrolling()) {
                    callrenderrows();
                    return;
                }

                if ($.jqx.browser.mozilla && this.updatedelay == 0 && (this.vScrollInstance.isScrolling() || this.hScrollInstance.isScrolling())) {
                    this.updatedelay = 1;  
                }

                if (this.updatedelay == 0) {
                    callrenderrows();
                }
                else {
                    var timer = this._jqxgridrendertimer;
                    if (timer != null) {
                        clearTimeout(timer);
                    }
                    if (this.vScrollInstance.isScrolling() || this.hScrollInstance.isScrolling()) {
                        timer = setTimeout(function () {
                            callrenderrows();
                        }, this.updatedelay);
                        this._jqxgridrendertimer = timer;
                    }
                    else {
                        this._jqxgridrendertimer = timer;
                        callrenderrows();
                    }
                }
            }
            if (self.autorowheight && !self.autoheight) {
                if (this._pageviews.length > 0) {
                    var tableheight = this._gettableheight();
                    var virtualheight = this._pageviews[0].height;
                    if (virtualheight > tableheight) {
                        if (this.pageable && this.gotopage) {
                            virtualheight = this._pageviews[0].height;
                            if (virtualheight < 0) {
                                virtualheight = this._pageviews[0].height;
                            }
                        }

                        if (this.vScrollBar.css('visibility') != 'visible') {
                            this.vScrollBar.css('visibility', 'visible');
                        }
                        if (virtualheight <= tableheight || this.autoheight) {
                            this.vScrollBar.css('visibility', 'hidden');
                        }

                        if (virtualheight - tableheight > 0) {
                            if (this.scrollmode != 'deferred') {
                                var max = virtualheight - tableheight;
                                var oldmax = this.vScrollInstance.max;
                                this.vScrollBar.jqxScrollBar({ max: max });
                                if (Math.round(max) != Math.round(oldmax)) {
                                    this.vScrollBar.jqxScrollBar({ value: 0 });
                                }
                            }
                        }
                        else {
                            this.vScrollBar.jqxScrollBar({ value: 0, max: virtualheight });
                        }
                    }
                    else {
                        if (!this._loading) {
                            this.vScrollBar.css('visibility', 'hidden');
                        }
                        this.vScrollBar.jqxScrollBar({ value: 0 });
                    }

                    this._arrange();
                    if (this.virtualsizeinfo) {
                        this.virtualsizeinfo.virtualheight = virtualheight;
                    }
                }
            }
        },

        scrolling: function()
        {
            var vertical = this.vScrollInstance.isScrolling();
            var horizontal = this.hScrollInstance.isScrolling();
            return { vertical: vertical, horizontal: horizontal };
        },

        _renderhorizontalscroll: function () {
            var hScrollInstance = this.hScrollInstance;
            var horizontalscrollvalue = hScrollInstance.value;
            if (this.hScrollBar.css('visibility') === 'hidden') {
                hScrollInstance.value = 0;
                horizontalscrollvalue = 0;
            }

            var left = parseInt(horizontalscrollvalue);
            if (this.table == null)
                return;

            var rows = this.table[0].rows.length;
            var columnsrow = this.columnsrow;
            var columnstart = this.groupable && this.groups.length > 0 ? this.groups.length : 0;
            var columnend = this.columns.records.length - columnstart;
            var columns = this.columns.records;
            var isempty = this.dataview.rows.length == 0;
            if (this.rtl) {
                if (this.hScrollBar.css('visibility') != 'hidden') {
                    left = hScrollInstance.max - left;
                }
            }

            if (isempty && !this._haspinned) {
                for (var i = 0; i < rows; i++) {
                    var tablerow = this.table[0].rows[i];
                    for (var j = 0; j < columnstart + columnend; j++) {
                        var tablecell = tablerow.cells[j];
                        if (tablecell != undefined) {
                            var column = columns[j];
                            if (column.pinned) {
                                tablecell.style.marginLeft = left + 'px';
                                if (i == 0) {
                                    var columncell = columnsrow[0].cells[j];
                                    columncell.style.marginLeft = left + 'px';
                                }
                            }
                        }
                    }
                }
                this.table[0].style.marginLeft = -left + 'px';
                columnsrow[0].style.marginLeft = -left + 'px';
            }
            else {
                if (this._haspinned || this._haspinned == undefined) {
                    for (var i = 0; i < rows; i++) {
                        var tablerow = this.table[0].rows[i];
                        for (var j = 0; j < columnstart + columnend; j++) {
                            var tablecell = tablerow.cells[j];
                            if (tablecell != undefined) {
                                var column = columns[j];
                                if (column.pinned) {
                                    if (left == 0 && tablecell.style.marginLeft == "")
                                        continue;

                                    var statuscell = null;
                                    var filtercell = null;

                                    if (this.showfilterrow && this.filterrow) {
                                        if (this.filterrow[0].cells) {
                                            filtercell = this.filterrow[0].cells[j];
                                        }
                                    }

                                    if (this.showaggregates) {
                                        if (this.statusbar[0].cells) {
                                            statuscell = this.statusbar[0].cells[j];
                                        }
                                    }

                                    if (!this.rtl) {
                                        tablecell.style.marginLeft = left + 'px';
                                        if (i == 0) {
                                            var columncell = columnsrow[0].cells[j];
                                            columncell.style.marginLeft = left + 'px';
                                            if (statuscell) {
                                                statuscell.style.marginLeft = left + 'px';
                                            }
                                            if (filtercell) {
                                                filtercell.style.marginLeft = left + 'px';
                                            }
                                        }
                                    }
                                    else {
                                        tablecell.style.marginLeft = -parseInt(horizontalscrollvalue) + 'px';
                                        if (i == 0) {
                                            var columncell = columnsrow[0].cells[j];
                                            columncell.style.marginLeft = -parseInt(horizontalscrollvalue) + 'px';
                                            if (statuscell) {
                                                statuscell.style.marginLeft = -parseInt(horizontalscrollvalue) + 'px';
                                            }
                                            if (filtercell) {
                                                filtercell.style.marginLeft = -parseInt(horizontalscrollvalue) + 'px';
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    this.table[0].style.marginLeft = -left + 'px';
                    columnsrow[0].style.marginLeft = -left + 'px';
                }
                else if (this._haspinned == false) {
                    this.table[0].style.marginLeft = -left + 'px';
                    columnsrow[0].style.marginLeft = -left + 'px';
                }
            }

            if (this.showaggregates) {
                if (this.statusbar[0].cells) {
                    var offset = 0;
                    if (this.rtl) {
                        if (this.vScrollBar.css('visibility') != 'hidden') {
                            if (this.hScrollBar.css('visibility') != 'hidden') {
                                offset = 2 + parseInt(this.hScrollBar.css('left'));
                            }
                        }
                    }
                    this.statusbar[0].style.marginLeft = -left + offset + 'px';
                }
            }
            if (this.showfilterrow && this.filterrow) {
                if (this.filterrow[0].cells) {
                    this.filterrow[0].style.marginLeft = -left + 'px';
                }
            }
        },

        _updaterowdetailsvisibility: function () {
            if (this.rowdetails) {
                for (var i = 0; i < this._rowdetailselementscache.length; i++) {
                    $(this._rowdetailselementscache[i]).css('display', 'none');
                }
            }
        },

        _getvisualcolumnsindexes: function (left, tablewidth, columnstart, columnend, hasgroups) {
            if (this.rowdetails || this.rtl || this.editcell || (this.width && this.width.toString().indexOf('%') >= 0) || this.exporting) {
                return { start: 0, end: columnstart + columnend };
            }

            var xcolumn = 0;
            var hcolumnstart = -1;
            var hcolumnend = columnstart + columnend;
            var haspinnedcolumn = false;

            if (this.autorowheight) {
                return { start: 0, end: columnstart + columnend };
            }

            if (!hasgroups) {
                for (var j = 0; j < columnstart + columnend; j++) {
                    var rendercolumn = j;

                    if (!haspinnedcolumn) {
                        if (this.columns.records[j].pinned) {
                            haspinnedcolumn = true;
                        }
                    }

                    if (!this.columns.records[j].hidden) {
                        xcolumn += this.columns.records[j].width;
                    }

                    if (xcolumn >= left && hcolumnstart == -1) {
                        hcolumnstart = j;
                    }

                    if (xcolumn > tablewidth + left) {
                        hcolumnend = j
                        break;
                    }
                }
            }

            hcolumnend++;
            if (hcolumnend > columnstart + columnend) {
                hcolumnend = columnstart + columnend;
            }

            if (hcolumnstart == -1 || haspinnedcolumn) {
                hcolumnstart = 0;
            }

            return { start: hcolumnstart, end: hcolumnend };
        },

        _getfirstvisualrow: function () {
            var vScrollInstance = this.vScrollInstance;
            var verticalscrollvalue = vScrollInstance.value;
            var top = parseInt(verticalscrollvalue);

            if (this._pagescache.length == 0) {
                this.dataview.updateview();
                this._loadrows();
            }

            if (this.vScrollBar[0].style.visibility != 'visible') {
                top = 0;
            }

            if (!this.pageable) {
                var pagenum = this._findvisiblerow(top, this._pageviews);

                if (pagenum == -1) {
                    return null;
                }

                if (pagenum != this.dataview.pagenum) {
                    this.dataview.pagenum = pagenum;
                    this.dataview.updateview();
                    this._loadrows();
                }
                else if (!this._pagescache[this.dataview.pagenum]) {
                    this._loadrows();
                }
            }

            var firstvisiblerow = this._findvisiblerow(top, this._pagescache[this.dataview.pagenum]);
            var rowstorender = this._pagescache[this.dataview.pagenum];
            if (rowstorender && rowstorender[0]) {
                return rowstorender[firstvisiblerow];
            }
        },

        _rendervisualrows: function () {
            if (!this.virtualsizeinfo)
                return;

            var vScrollInstance = this.vScrollInstance;
            var hScrollInstance = this.hScrollInstance;
            var verticalscrollvalue = vScrollInstance.value;
            var horizontalscrollvalue = hScrollInstance.value;
            var top = parseInt(verticalscrollvalue);
            var left = parseInt(horizontalscrollvalue);
            var tableheight = this._gettableheight();
            var tablewidth = this._hostwidth != undefined ? this._hostwidth : this.host.width();
            if (this.hScrollBar[0].style.visibility == 'visible') {
                tableheight += 29;
            }
            if (this.scrollmode == 'deferred' && this._newmax != 0) {
                if (top > this._newmax && this._newmax != null) top = this._newmax;
            }

            var scrolling = vScrollInstance.isScrolling() || hScrollInstance.isScrolling() || this._keydown;
            var hasgroups = this.groupable && this.groups.length > 0;
            this.visiblerows = new Array();
            this.hittestinfo = new Array();

            if (this.editcell && this.editrow == undefined) {
                this._hidecelleditor(false);
            }
            if (this.editrow != undefined) {
                this._hideeditors();
            }

            if (this.virtualmode && !this.pageable) {
                this._pagescache = new Array();
            }

            if (this._pagescache.length == 0) {
                this.dataview.updateview();
                this._loadrows();
            }

            if (this.vScrollBar[0].style.visibility == 'hidden') {
                top = 0;
            }

            if (!this.pageable) {
                var pagenum = this._findvisiblerow(top, this._pageviews);

                if (pagenum == -1) {
                    this._clearvisualrows();
                    this._renderemptyrow();
                    this._updaterowdetailsvisibility();
                    return;
                }

                if (pagenum != this.dataview.pagenum) {
                    this.dataview.pagenum = pagenum;
                    this.dataview.updateview();
                    this._loadrows();
                }
                else if (!this._pagescache[this.dataview.pagenum]) {
                    this._loadrows();
                }
            }

            var columnstart = this.groupable && this.groups.length > 0 ? this.groups.length : 0;
            if (!this.columns.records) {
                return;
            }
            var columnend = this.columns.records.length - columnstart;
            var firstvisiblerow = this._findvisiblerow(top, this._pagescache[this.dataview.pagenum]);
            var rowstorender = this._pagescache[this.dataview.pagenum];
            var startindex = firstvisiblerow;
            if (startindex < 0) startindex = 0;

            var emptyheight = 0;
            var renderedrows = 0;
            var renderedheight = 0;
            var tableoffset = 0;
            var pagesize = this.virtualsizeinfo.visiblerecords;
            var groupslength = this.groupable ? this.groups.length : 0;
            var cellclass = this.toTP('jqx-grid-cell');
            if (this.rtl) {
                cellclass += ' ' + this.toTP('jqx-grid-cell-rtl');
            }

            if ((this.autoheight || this.autorowheight) && this.pageable) {
                if (!this.groupable) {
                    pagesize = this.dataview.pagesize;
                }
            }

            if (hasgroups) {
                cellclass = ' ' + this.toTP('jqx-grid-group-cell');
            }

            if (this.isTouchDevice()) {
                cellclass += ' ' + this.toTP('jqx-touch');
            }

            if (this.autorowheight) {
                cellclass += ' jqx-grid-cell-wrap'
            }

            var rowheight = this.rowsheight;
            var altrowindex = startindex;
            var rendercellfunc = this._rendercell;
            var enableselection = true;

            var visualcolumnsindexes = this._getvisualcolumnsindexes(left, tablewidth, columnstart, columnend, hasgroups);
            var hcolumnstart = visualcolumnsindexes.start;
            var hcolumnend = visualcolumnsindexes.end;
            if ((this.autoheight || this.pageable) && this.autorowheight) {
                if (this._pageviews[0]) {
                    this._oldpageviewheight = this._pageviews[0].height;
                }
            }

            if (this.autorowheight) {
                startindex = 0;
            }

            if (startindex >= 0) {
                this._updaterowdetailsvisibility();
                this._startboundindex = rowstorender != null ? rowstorender[startindex].bounddata.boundindex : 0;
                this._startvisibleindex = rowstorender != null ? rowstorender[startindex].bounddata.visibleindex : 0;
                for (var renderindex = 0; renderindex < pagesize && renderedrows < pagesize; renderindex++) {
                    var renderrow = rowstorender != undefined ? rowstorender[startindex + renderindex] : null;

                    if (renderrow == null) {
                        startindex = -renderindex;
                        if (this._pagescache[this.dataview.pagenum + 1]) {
                            rowstorender = this._pagescache[this.dataview.pagenum + 1];
                            this.dataview.pagenum++;
                        }
                        else {
                            var pageviewslength = this._pageviews.length;
                            do {
                                if (this.dataview.pagenum < this._pageviews.length - 1) {
                                    this.dataview.pagenum++;
                                    rowstorender = undefined;
                                    if (this._pageviews[this.dataview.pagenum].height > 0) {
                                        this.dataview.updateview();
                                        this._loadrows();
                                        rowstorender = this._pagescache[this.dataview.pagenum];
                                    }
                                }
                                else {
                                    rowstorender = undefined;
                                    break;
                                }
                            } while (rowstorender == undefined && this.dataview.pagenum < pageviewslength);
                        }

                        if (rowstorender != undefined) {
                            renderrow = rowstorender[startindex + renderindex]
                        }
                    }

                    if (renderrow != null) {
                        if (renderrow.hidden)
                            continue;

                        this._endboundindex = this._startboundindex + renderindex;
                        this._endvisibleindex = this._startvisibleindex + renderindex;
                        if (renderindex == 0) {
                            var topoffset = Math.abs(top - renderrow.top);
                            this.table[0].style.top = -topoffset + 'px';
                            tableoffset = -topoffset;
                        }

                        var tablerow = this.table[0].rows[renderedrows];
                        if (!tablerow) continue;
                        if (parseInt(tablerow.style.height) != renderrow.height) {
                            tablerow.style.height = parseInt(renderrow.height) + 'px';
                        }

                        renderedheight += renderrow.height;
                        var hasdetails = this.rowdetails && renderrow.rowdetails;
                        var showdetails = !renderrow.rowdetailshidden;
                        if (hasdetails && showdetails) {
                            tablerow.style.height = parseInt(renderrow.height - renderrow.rowdetailsheight) + 'px';
                            pagesize++;
                        }

                        var selected = this._isrowselected(enableselection, renderrow);
                        for (var cindex = hcolumnstart; cindex < hcolumnend; cindex++) {
                            var rendercolumn = cindex;
                            this._rendervisualcell(rendercellfunc, cellclass, selected, hasdetails, showdetails, hasgroups, groupslength, tablerow, renderrow, rendercolumn, renderedrows, scrolling);
                        }

                        if (renderrow.group != undefined && this._rendergroup) {
                            this._rendergroup(groupslength, tablerow, renderrow, columnstart, columnend, renderedrows, tablewidth);
                        }

                        if (this.autorowheight && (this.autoheight || this.pageable)) {
                            var rowheight = this.rowsheight;
                            for (var cindex = hcolumnstart; cindex < hcolumnend; cindex++) {
                                if (this.editable && this.editcell && this.editcell.column == this.columns.records[cindex].datafield && this.editcell.row == this.getboundindex(renderrow)) {
                                    continue;
                                }

                                if (tablerow.cells[cindex].firstChild) {
                                    rowheight = Math.max(rowheight, 8 + parseInt(tablerow.cells[cindex].firstChild.offsetHeight));
                                }
                            }
                            tablerow.style.height = parseInt(rowheight) + 'px';
                            this.heights[this._startboundindex + renderindex] = rowheight;
                            if (hasdetails && showdetails) {
                                rowheight += renderrow.rowdetailsheight;
                            }
                            renderrow.height = rowheight;
                        }

                        this.visiblerows[this.visiblerows.length] = renderrow;
                        this.hittestinfo[this.hittestinfo.length] = { row: renderrow, visualrow: tablerow, details: false };

                        if (hasdetails && showdetails) {
                            renderedrows++;
                            var tablerow = this.table[0].rows[renderedrows];
                            this._renderrowdetails(cellclass, tablerow, renderrow, columnstart, columnend, renderedrows);

                            this.visiblerows[this.visiblerows.length] = renderrow;
                            this.hittestinfo[this.hittestinfo.length] = { row: renderrow, visualrow: tablerow, details: true };
                        }

                        if (!this.autorowheight) {
                            if (renderedheight + tableoffset >= tableheight)
                                break;
                        }
                    }
                    else {
                        cansetheight = true;
                        this._clearvisualrow(left, hasgroups, renderedrows, columnstart, columnend);
                        if (renderedheight + emptyheight + tableoffset <= tableheight) {
                            emptyheight += rowheight;
                        }
                    }
                    renderedrows++;
                }
                this._horizontalvalue = left;

                if (emptyheight > 0) {
                    if (this.vScrollBar[0].style.visibility == 'visible') {
                        var tabletop = parseInt(this.table.css('top'));
                        var lastpageview = this._pageviews[this._pageviews.length - 1];
                        var oldmax = vScrollInstance.max;
                        var newmax = lastpageview.top + lastpageview.height - tableheight; //tabletop + this.visiblerows[this.visiblerows.length - 1].top + tableheight; //offset + vScrollInstance.max - emptyheight;
                        if (this.hScrollBar.css('visibility') == 'visible') {
                            newmax += this.scrollbarsize + 20;
                        }

                        if (oldmax != newmax && !this.autorowheight) {
                            if (newmax >= 0) {
                                if (this.scrollmode != 'deferred') {
                                    vScrollInstance.max = newmax;
                                    vScrollInstance.setPosition(vScrollInstance.max);
                                }
                                else {
                                    if (this._newmax != newmax) {
                                        this._newmax = newmax;
                                        this._rendervisualrows();
                                    }
                                }
                            }
                        }
                    }
                }
            }

            if ((this.autoheight || this.pageable) && this.autorowheight) {
                this._pagescache = new Array();
                var y = 0;
                var height = 0;
                for (var i = 0; i < this.visiblerows.length; i++) {
                    var row = this.visiblerows[i];
                    row.top = y;
                    y += row.height;
                    height += row.height;
                    var hasdetails = this.rowdetails && row.rowdetails;
                    var showdetails = !row.rowdetailshidden;
                    var tablerow = this.table[0].rows[i];
                    if (hasdetails && showdetails) {
                        i++;
                    }

                    for (var cindex = hcolumnstart; cindex < hcolumnend; cindex++) {
                        var column = this.columns.records[cindex];
                        if (!column.hidden) {
                            if (!column.cellsrenderer) {
                                var cell = tablerow.cells[cindex];
                                var topMargin = 0;
                                if (cell.firstChild) {
                                    var topMargin = (row.height - parseInt(cell.firstChild.offsetHeight) - 8) / 2;
                                    if (hasdetails && showdetails) {
                                        var topMargin = (row.height - row.rowdetailsheight - $(cell.firstChild).height() - 8) / 2;
                                    }
                                }
                                else {
                                    var topMargin = (row.height - parseInt($(cell).height()) - 8) / 2;
                                }

                                if (topMargin >= 0) {
                                    topMargin = parseInt(topMargin) + 4;
                                    if (cell.firstChild) {
                                        if (cell.firstChild.className.indexOf('jqx-grid-groups-row') == -1) {
                                            if (column.columntype != 'checkbox' && column.columntype != 'button') {
                                                if (this.editable && this.editcell && this.editcell.column == column.datafield && this.editcell.row == this.getboundindex(row))
                                                    continue;

                                                cell.firstChild.style.marginTop = topMargin + 'px';
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                if (this._pageviews[0]) {
                    this._pageviews[0].height = height; //this.table.height();
                }
                this._arrange();
            }
            this._renderemptyrow();
        },

        _hideemptyrow: function()
        {
            if (!this.showemptyrow) return;
            if (!this.table) return;
            if (!this.table[0].rows) return;

            var row = this.table[0].rows[0];
            if (!row) return;
            var rendered = false;
            for (var i = 0; i < row.cells.length; i++) {
                var cell = $(row.cells[i]);
                if (cell.css('display') != 'none' && !rendered) {
                    if (cell.width() == this.host.width() || cell.text() == this.gridlocalization.emptydatastring) {
                        cell[0].checkbox = null;
                        cell[0].button = null;
                        rendered = true;
                        cell[0].innerHTML = "";
                    }
                }
            }     
        },

        _renderemptyrow: function () {
            if (this._loading) {
                return;
            }

            if (this.dataview.records.length == 0 && this.showemptyrow) {
                var rendered = false;
                var cellclass = this.toTP('jqx-grid-cell');

                if (this.table && this.table.length > 0 && this.table[0].rows && this.table[0].rows.length > 0) {
                    var row = this.table[0].rows[0];
                    this.table[0].style.top = '0px';
                    for (var i = 0; i < row.cells.length; i++) {
                        var cell = $(row.cells[i]);
                        if (cell.css('display') != 'none' && !rendered) {
                            cell[0].checkbox = null;
                            cell[0].button = null;
                            cell[0].className = cellclass;
                            rendered = true;
                            cell[0].innerHTML = "";
                            var span = $("<span style='white-space: nowrap; float: left; margin-left: 50%; position: relative;'></span>");
                            span.text(this.gridlocalization.emptydatastring);
                            cell.append(span);
                            var hscroll = 0;
                            if (!this.oldhscroll) {
                                hscroll = parseInt(this.table[0].style.marginLeft);
                                if (this.rtl) {
                                    cell.css('z-index', 999);
                                    cell.css('overflow', 'visible');
                                }
                            }

                            span.css('left', -hscroll - (span.width() / 2));
                            span.css('top', this._gettableheight() / 2 - span.height() / 2);
                            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                                span.css('margin-left', '0px');
                                span.css('left', this.host.width() / 2 - span.width() / 2);
                            }
                            var top = Math.abs(parseInt(this.table[0].style.top));
                            if (isNaN(top)) top = 0;
                            $(row).height(this._gettableheight() + top);
                            cell.css('margin-left', '0px');
                            cell.width(this.host.width());
                            if (this.table.width() < this.host.width()) {
                                this.table.width(this.host.width());
                            }
                        }
                        cell.addClass(this.toThemeProperty('jqx-grid-empty-cell'));
                    }
                }
            }
        },

        _clearvisualrows: function () {
            var pagesize = this.virtualsizeinfo.visiblerecords;
            var hScrollInstance = this.hScrollInstance;
            var horizontalscrollvalue = hScrollInstance.value;
            var left = parseInt(horizontalscrollvalue);
            var hasgroups = this.groupable && this.groups.length > 0;
            if (!this.columns.records)
                return;

            for (var renderindex = 0; renderindex < pagesize; renderindex++) {
                this._clearvisualrow(left, hasgroups, renderindex, 0, this.columns.records.length);
            }
        },

        _isrowselected: function (enableselection, row) {
            var selected = false;
            var boundindexoffset = 0;
            if (this.virtualmode && this.pageable && this.groupable) {
                if (this.groups.length > 0) {
                    boundindexoffset = this.dataview.pagesize * this.dataview.pagenum;
                }
            }
            
            if (enableselection && row.bounddata != null) {
                if (this.selectionmode != "singlerow") {
                    if (this.dataview.filters.length > 0) {
                        if (!this.virtualmode) {
                            if (this.selectedrowindexes.indexOf(boundindexoffset + row.bounddata.dataindex) != -1) {
                                selected = true;
                            }
                        }
                        else {
                            if (this.selectedrowindexes.indexOf(boundindexoffset + row.bounddata.boundindex) != -1) {
                                selected = true;
                            }
                        }
                    }
                    else {
                        if (this.selectedrowindexes.indexOf(boundindexoffset + row.bounddata.boundindex) != -1) {
                            selected = true;
                        }
                    }
                }
                else {
                    if (this.dataview.filters.length > 0) {
                        if (!this.virtualmode) {
                            if (this.selectedrowindexes.indexOf(boundindexoffset + row.bounddata.dataindex) != -1) {
                                selected = true;
                            }
                        }
                        else {
                            if (this.selectedrowindexes.indexOf(boundindexoffset + row.bounddata.boundindex) != -1) {
                                selected = true;
                            }
                        }
                    }
                    else {
                        if (boundindexoffset + row.bounddata.boundindex == this.selectedrowindex) {
                            selected = true;
                        }
                    }
                }
            }

            return selected;
        },

        _rendervisualcell: function (rendercellfunc, cellclass, selected, hasdetails, showdetails, hasgroups, groupslength, tablerow, renderrow, rendercolumn, renderedrows, scrolling) {
            var cell = null;
            var column = this.columns.records[rendercolumn];
            if (column.hidden) {
                var tablecell = tablerow.cells[rendercolumn];
                tablecell.innerHTML = "";
                return;
            }

            cellvalue = this._getcellvalue(column, renderrow);
            var tablecell = tablerow.cells[rendercolumn];
            var classname = cellclass;

            if (this.selectionmode.indexOf('cell') != -1) {
                if (this.dataview.filters.length > 0) {
                    if (this.selectedcells[renderrow.bounddata.dataindex + '_' + column.datafield]) {
                        selected = true;
                    }
                    else {
                        selected = false;
                    }
                }
                else {
                    if (this.selectedcells[renderrow.boundindex + '_' + column.datafield]) {
                        selected = true;
                    }
                    else {
                        selected = false;
                    }
                }
                if (this.editcell) {
                    if (this.editcell.row === renderrow.boundindex && this.editcell.column === column.datafield) {
                        if (column.columntype !== "checkbox") {
                            selected = false;
                        }
                    }
                }
            }

            if (column.cellclassname != '' && column.cellclassname) {
                if (typeof column.cellclassname == "string") {
                    classname += ' ' + column.cellclassname;
                }
                else {
                    var customclassname = column.cellclassname(this.getboundindex(renderrow), column.datafield, cellvalue, renderrow.bounddata);
                    if (customclassname) {
                        classname += ' ' + customclassname;
                    }
                }
            }
            
            var issortcolumn = this.showsortcolumnbackground && this.sortcolumn && column.displayfield == this.sortcolumn;
            if (issortcolumn) {
                classname += ' ' + this.toTP('jqx-grid-cell-sort');
            }

            if (column.filter && this.showfiltercolumnbackground) {
                classname += ' ' + this.toTP('jqx-grid-cell-filter');
            }

            if ((column.pinned && this.showpinnedcolumnbackground) || column.grouped) {
                if (hasgroups) {
                    classname += ' ' + this.toTP('jqx-grid-cell-pinned');
                }
                else {
                    classname += ' ' + this.toTP('jqx-grid-cell-pinned');
                }
            }

            if (this.altrows && renderrow.group == undefined) {
                var altrowindex = renderrow.visibleindex;
                if (altrowindex >= this.altstart) {
                    if ((this.altstart + altrowindex) % (1 + this.altstep) == 0) {
                        if (!issortcolumn) {
                            classname += ' ' + this.toTP('jqx-grid-cell-alt');
                        }
                        else classname += ' ' + this.toTP('jqx-grid-cell-sort-alt');

                        if (column.filter && this.showfiltercolumnbackground) {
                            classname += ' ' + this.toTP('jqx-grid-cell-filter-alt');
                        }

                        if (column.pinned && this.showpinnedcolumnbackground) {
                            classname += ' ' + this.toTP('jqx-grid-cell-pinned-alt');
                        }
                    }
                }
            }

            if (rendercolumn <= groupslength) {
                if (hasgroups || this.rowdetails) {
                    var $tablecell = $(tablecell);
                    var cellwidth = this.columns.records[rendercolumn].width;

                    if (tablecell.style.width != parseInt(cellwidth) + 'px') {
                        $tablecell.width(cellwidth);
                    }
                }
            }
            else {
                if (hasgroups || this.rowdetails) {
                    if (this._hiddencolumns) {
                        var $tablecell = $(tablecell);
                        var cellwidth = this.columns.records[rendercolumn].width;

                        if (parseInt(tablecell.style.width) != cellwidth) {
                            $tablecell.width(cellwidth);
                        }
                    }
                }
            }

            var selectedstate = true;
            if (this.rowdetails && hasdetails) {
                if (showdetails && !hasgroups) {
                    classname += ' ' + this.toTP('jqx-grid-details-cell');
                }
                else if (hasgroups) {
                    classname += ' ' + this.toTP('jqx-grid-group-details-cell');
                }

                if (this.showrowdetailscolumn) {
                    if (!this.rtl) {
                        if (renderrow.group == undefined && rendercolumn == groupslength) {
                            if (showdetails) {
                                classname += ' ' + this.toTP('jqx-grid-group-expand');
                            }
                            else {
                                classname += ' ' + this.toTP('jqx-grid-group-collapse');
                            }
                            selectedstate = false;
                            tablecell.title = "";
                            tablecell.innerHTML = "";
                            if (tablecell.className != classname) {
                                tablecell.className = classname;
                            }
                            return;
                        }
                    }
                    else {
                        if (renderrow.group == undefined && rendercolumn == tablerow.cells.length - groupslength - 1) {
                            if (showdetails) {
                                classname += ' ' + this.toTP('jqx-grid-group-expand-rtl');
                            }
                            else {
                                classname += ' ' + this.toTP('jqx-grid-group-collapse-rtl');
                            }
                            selectedstate = false;
                            tablecell.title = "";
                            tablecell.innerHTML = "";
                            if (tablecell.className != classname) {
                                tablecell.className = classname;
                            }
                            return;
                        }
                    }
                }
            }

            if (selected && selectedstate && rendercolumn >= groupslength) {
                classname += ' ' + this.toTP('jqx-grid-cell-selected');
                classname += ' ' + this.toTP('jqx-fill-state-pressed');
            }

            if (tablecell.className != classname) {
                tablecell.className = classname;
            }

            if (renderrow.group != undefined) {
                cellvalue = "";
                tablecell.title = "";
                tablecell.innerHTML = "";

                return;
            }
            rendercellfunc(this, column, renderrow, cellvalue, tablecell, scrolling);
        },

        _rendercell: function (me, column, row, value, tablecell, scrolling) {
            var lookupkey = value + "_" + column.visibleindex;
            //row.uniqueid + "_" + column.visibleindex;
            if (column.columntype == "number" || column.cellsrenderer != null) {
                var lookupkey = row.uniqueid + "_" + column.visibleindex;
            }

            if (me.editcell && me.editrow == undefined) {
                if (me.editmode == "selectedrow" && column.editable && me.editable) {
                    if (me.editcell.row == me.getboundindex(row)) {
                        if (me._showcelleditor) {
                            if (!me.hScrollInstance.isScrolling() && !me.vScrollInstance.isScrolling()) {
                                me._showcelleditor(me.editcell.row, column, tablecell, me.editcell.init);
                            }
                            else {
                                me._showcelleditor(me.editcell.row, column, tablecell, me.editcell.init, false);
                            }
                            return;
                        }
                    }
                }
                else {
                    if (me.editcell.row == me.getboundindex(row) && me.editcell.column == column.datafield) {
                        me.editcell.element = tablecell;
                        if (me.editcell.editing) {
                            if (me._showcelleditor) {
                                if (!me.hScrollInstance.isScrolling() && !me.vScrollInstance.isScrolling()) {
                                    me._showcelleditor(me.editcell.row, column, me.editcell.element, me.editcell.init);
                                }
                                else {
                                    me._showcelleditor(me.editcell.row, column, me.editcell.element, me.editcell.init, false);
                                }
                                return;
                            }
                        }
                    }
                }
            }

            var defaultcellsrenderer = me._defaultcellsrenderer(value, column);

            var cachedcell = me._cellscache[lookupkey];
            //   var ie10 = me._browser == undefined ? me._isIE10() : me._browser;
            if (cachedcell) {
                if (column.columntype == "inline") {
                    me._renderinlinecell(me, tablecell, column, row, value);
                    if (column.cellsrenderer != null) {
                        var newvalue = column.cellsrenderer(me.getboundindex(row), column.datafield, value, defaultcellsrenderer, column.getcolumnproperties(), row.bounddata);
                        if (newvalue != undefined) {
                            tablecell.innerHTML = newvalue;
                        }
                    } return;
                }
                else if (column.columntype == "checkbox") {
                    if (me.host.jqxCheckBox) {
                        if (value === "") value = null;
                        var empty = tablecell.innerHTML.toString().length == 0;
                        if (tablecell.checkbox && !me.groupable && !empty) {
                            tablecell.checkboxrow = me.getboundindex(row);
                            if (value == "") value = false;
                            if (value == "1") value = true;
                            if (value == "0") value = false;
                            if (value == 1) value = true;
                            if (value == 0) value = false;
                            if (value == 'true') value = true;
                            if (value == 'false') value = false;
                            if (value == null && !column.threestatecheckbox) {
                                value = false;
                            }
                            if (column.checkboxcolumn) {
                                value = false;
                                if (me.dataview.filters.length > 0 && !me.virtualmode) {
                                    if (me.selectedrowindexes.indexOf(row.bounddata.dataindex) != -1) {
                                        value = true;
                                    }
                                }
                                else {
                                    if (me.selectedrowindexes.indexOf(row.bounddata.boundindex) != -1) {
                                        value = true;
                                    }
                                }
                            }
                            if (tablecell.checkboxinstance) {
                                tablecell.checkboxinstance._setState(value);
                            }
                            else {
                                tablecell.checkbox.jqxCheckBox('_setState', value);
                            }
                        }
                        else {
                            me._rendercheckboxcell(me, tablecell, column, row, value);
                        }
                        if (column.cellsrenderer != null) {
                            var newvalue = column.cellsrenderer(me.getboundindex(row), column.datafield, value, defaultcellsrenderer, column.getcolumnproperties(), row.bounddata);
                            if (newvalue != undefined) {
                                tablecell.innerHTML = newvalue;
                            }
                        }

                        return;
                    }
                }
                else if (column.columntype == "button") {
                    if (me.host.jqxButton) {
                        if (value == "") value = false;
                        if (column.cellsrenderer != null) {
                            value = column.cellsrenderer(me.getboundindex(row), column.datafield, value, defaultcellsrenderer, column.getcolumnproperties(), row.bounddata);
                        }

                        if (tablecell.innerHTML == "") {
                            tablecell.buttonrow = me.getboundindex(row);
                            tablecell.button = null;
                            me._renderbuttoncell(me, tablecell, column, row, value);
                        }

                        if (tablecell.button && !me.groupable) {
                            tablecell.buttonrow = me.getboundindex(row);
                            tablecell.button.val(value);
                        }
                        else {
                            me._renderbuttoncell(me, tablecell, column, row, value);
                        }
                        return;
                    }
                }

                var cellelement = cachedcell.element;

                if (column.cellsrenderer != null || (tablecell.childNodes && tablecell.childNodes.length == 0) || me.groupable || me.rowdetails) {
                    if (tablecell.innerHTML != cellelement) {
                        tablecell.innerHTML = cellelement;
                    }
                }
                else {
                    if (tablecell.innerHTML.indexOf('editor') >= 0) {
                        tablecell.innerHTML = cellelement;
                    }
                    else if (scrolling) {
                        var textStartIndex = cellelement.indexOf('>');
                        var textEndIndex = cellelement.indexOf('</');
                        var text = cellelement.substring(textStartIndex + 1, textEndIndex);
                        var child = tablecell.childNodes[0];
                        if (child.childNodes[0]) {
                            if (text != child.childNodes[0].nodeValue) {
                                if (text.indexOf('&') >= 0) {
                                    tablecell.innerHTML = cellelement;
                                }
                                else {
                                    child.childNodes[0].nodeValue = text;
                                }
                                    //      var newChild = document.createTextNode(text);
                          //      child.replaceChild(newChild, child.childNodes[0]);
                            }
                        }
                        else {
                            var newChild = document.createTextNode(text);
                            child.appendChild(newChild);
                        }
                    }
                    else {
                        if (tablecell.innerHTML != cellelement) {
                            tablecell.innerHTML = cellelement;
                        }
                    }
                }

                if (me.enabletooltips && column.enabletooltips) {
                    tablecell.title = cachedcell.title;
                }
                return;
            }

            if (column.columntype == "checkbox") {
                me._rendercheckboxcell(me, tablecell, column, row, value);
                me._cellscache[lookupkey] = { element: "", title: value };
                if (me.enabletooltips && column.enabletooltips) {
                    tablecell.title = value;
                }
                return;
            }
            else if (column.columntype == "button") {
                if (column.cellsrenderer != null) {
                    value = column.cellsrenderer(me.getboundindex(row), column.datafield, value, defaultcellsrenderer, column.getcolumnproperties(), row.bounddata);
                }
                me._renderbuttoncell(me, tablecell, column, row, value);
                me._cellscache[lookupkey] = { element: "", title: value };
                if (me.enabletooltips && column.enabletooltips) {
                    tablecell.title = value;
                }
                return;
            }
            else if (column.columntype == "number") {
                value = row.visibleindex;
            }
            else if (column.columntype == "inline") {
                me._renderinlinecell(me, tablecell, column, row, value);
                me._cellscache[lookupkey] = { element: "", title: value };
                if (me.enabletooltips && column.enabletooltips) {
                    tablecell.title = value;
                }
                return;
            }

            var cellelement = null;
            if (column.cellsrenderer != null) {
                cellelement = column.cellsrenderer(me.getboundindex(row), column.datafield, value, defaultcellsrenderer, column.getcolumnproperties(), row.bounddata);
            }
            else {
                cellelement = defaultcellsrenderer;
            }

            if (cellelement == null) {
                cellelement = defaultcellsrenderer;
            }
            var formattedValue = value;
            if (me.enabletooltips && column.enabletooltips) {
               if (column.cellsformat != '') {
                    if ($.jqx.dataFormat) {
                        if ($.jqx.dataFormat.isDate(value)) {
                            formattedValue = $.jqx.dataFormat.formatdate(formattedValue, column.cellsformat, this.gridlocalization);
                        }
                        else if ($.jqx.dataFormat.isNumber(value)) {
                            formattedValue = $.jqx.dataFormat.formatnumber(formattedValue, column.cellsformat, this.gridlocalization);
                        }
                    }
                }
                tablecell.title = formattedValue;
            }

            if (me.WinJS) {
                WinJS.Utilities.setInnerHTMLUnsafe(tablecell, cellelement);
            }
            else {
                tablecell.innerHTML = cellelement;
            }

            me._cellscache[lookupkey] = { element: tablecell.innerHTML, title: formattedValue };
            return true;
        },

        _isIE10: function () {
            if (this._browser == undefined) {
                var browserInfo = $.jqx.utilities.getBrowser();
                if (browserInfo.browser == 'msie' && parseInt(browserInfo.version) > 9)
                    this._browser = true;
                else {
                    this._browser = false;
                    if (browserInfo.browser == 'msie') {
                        var txt = "Browser CodeName: " + navigator.appCodeName + "";
                        txt += "Browser Name: " + navigator.appName + "";
                        txt += "Browser Version: " + navigator.appVersion + "";
                        txt += "Platform: " + navigator.platform + "";
                        txt += "User-agent header: " + navigator.userAgent + "";
                        if (txt.indexOf('Zune 4.7') != -1) {
                            this._browser = true;
                        }
                    }
                }
            }
            return this._browser;
        },

        _renderinlinecell: function (me, tablecell, column, row, value) {
            var $tablecell = $(tablecell); 
            tablecell.innerHTML = '<div style="position: absolute;"></div>';
        },

        _rendercheckboxcell: function (me, tablecell, column, row, value) {
            if (me.host.jqxCheckBox) {
                var $tablecell = $(tablecell);
                if (value === "") {
                    if (column.threestatecheckbox) {
                        value = null;
                    }
                    else {
                        value = false;
                    }
                }
                if (value == "1") value = true;
                if (value == "0") value = false;
                if (value == 1) value = true;
                if (value == 0) value = false;
                if (value == 'true') value = true;
                if (value == 'false') value = false;
                if (column.checkboxcolumn) {
                    value = false;
                    if (this.dataview.filters.length > 0) {
                        if (this.selectedrowindexes.indexOf(row.bounddata.dataindex) != -1) {
                            value = true;
                        }
                    }
                    else {
                        if (this.selectedrowindexes.indexOf(row.bounddata.boundindex) != -1) {
                            value = true;
                        }
                    }
                }

                if ($tablecell.find('.jqx-checkbox').length == 0) {
                    tablecell.innerHTML = '<div style="position: absolute; top: 50%; left: 50%; margin-top: -7px; margin-left: -10px;"></div>';
                    $(tablecell.firstChild).jqxCheckBox({ _canFocus: false, hasInput: false, hasThreeStates: column.threestatecheckbox, enableContainerClick: false, animationShowDelay: 0, animationHideDelay: 0, locked: true, theme: me.theme, checked: value });

                    if (this.editable && column.editable) {
                        $(tablecell.firstChild).jqxCheckBox({ locked: false });
                    }
                    if (column.checkboxcolumn) {
                        $(tablecell.firstChild).jqxCheckBox({ locked: false });
                    }

                    tablecell.checkbox = $(tablecell.firstChild);
                    tablecell.checkboxinstance = tablecell.checkbox.data().jqxCheckBox.instance;
                    tablecell.checkboxrow = row.boundindex;
                    if (this.dataview.filters.length > 0) {
                        var boundindex = row.bounddata.dataindex;
                        tablecell.checkboxrow = boundindex;
                    }
                    var checkinstance = $.data(tablecell.firstChild, "jqxCheckBox").instance;
                    checkinstance.updated = function (event, checked, oldchecked) {
                        if (column.editable) {
                            var totalrows = me.table[0].rows.length;
                            var columnindex = me._getcolumnindex(column.datafield);

                            if (me.editrow == undefined) {
                                if (column.cellbeginedit) {
                                    var beginEdit = column.cellbeginedit(tablecell.checkboxrow, column.datafield, column.columntype, !checked);
                                    if (beginEdit == false) {
                                        me.setcellvalue(tablecell.checkboxrow, column.datafield, !checked, true);
                                        return;
                                    }
                                }

                                if (me.editmode !== "selectedrow") {
                                    for (var currentCheckbox = 0; currentCheckbox < totalrows; currentCheckbox++) {
                                        var checkboxcell = me.table[0].rows[currentCheckbox].cells[columnindex].firstChild;
                                        if (checkboxcell) {
                                            $(checkboxcell).jqxCheckBox('destroy');
                                        }
                                    }
                                }

                                if (me.editcell && me.editcell.validated == false) {
                                    me.setcellvalue(tablecell.checkboxrow, column.datafield, !checked, true);
                                }
                                else {
                                    me._raiseEvent(17, { rowindex: tablecell.checkboxrow, datafield: column.datafield, value: oldchecked, columntype: column.columntype });
                                    me.setcellvalue(tablecell.checkboxrow, column.datafield, checked, true);
                                    me._raiseEvent(18, { rowindex: tablecell.checkboxrow, datafield: column.datafield, oldvalue: oldchecked, value: checked, columntype: column.columntype });
                                }
                            }
                        }
                        else if (column.checkboxcolumn) {
                            if (me.editcell) {
                                me.endcelledit(me.editcell.row, me.editcell.column, false, true);
                            }
                            if (checked) {
                                me.selectrow(tablecell.checkboxrow);
                            }
                            else {
                                me.unselectrow(tablecell.checkboxrow);
                            }
                            if (me.autosavestate) {
                                if (me.savestate) me.savestate();
                            }
                        }
                    }
                }
                else {
                    tablecell.checkboxrow = row.boundindex;
                    if (this.dataview.filters.length > 0) {
                        boundindex = row.bounddata.dataindex;
                        tablecell.checkboxrow = boundindex;
                    }
                    $(tablecell.firstChild).jqxCheckBox('_setState', value);
                }
            }
        },

        _renderbuttoncell: function (me, tablecell, column, row, value) {
            if (me.host.jqxButton) {
                var $tablecell = $(tablecell);
                if (value == "") value = false;
                if ($tablecell.find('.jqx-button').length == 0) {
                    tablecell.innerHTML = '<input type="button" style="opacity: 0.99; position: absolute; top: 0%; left: 0%; padding: 0px; margin-top: 2px; margin-left: 2px;"/>';
                    $(tablecell.firstChild).val(value);
                    $(tablecell.firstChild).attr("hideFocus", "true");
                    $(tablecell.firstChild).jqxButton({ theme: me.theme, height: me.rowsheight - 4, width: column.width - 4 });
                    tablecell.button = $(tablecell.firstChild);
                    tablecell.buttonrow = me.getboundindex(row);
                    var isTouch = this.isTouchDevice();
                    if (isTouch) {
                        var eventname = $.jqx.mobile.getTouchEventName('touchend');
                        me.addHandler($(tablecell.firstChild), eventname, function (event) {
                            if (column.buttonclick) {
                                column.buttonclick(tablecell.buttonrow, event);
                            }
                        });
                    }
                    else {
                        me.addHandler($(tablecell.firstChild), 'click', function (event) {
                            if (column.buttonclick) {
                                column.buttonclick(tablecell.buttonrow, event);
                            }
                        });
                    }
                }
                else {
                    tablecell.buttonrow = me.getboundindex(row);
                    $(tablecell.firstChild).val(value);
                }
            }
        },

        _clearvisualrow: function (left, hasgroups, renderedrows, columnstart, columnend) {
            var cellclass = this.toTP('jqx-grid-cell');
            if (hasgroups) {
                cellclass = ' ' + this.toTP('jqx-grid-group-cell');
            }
            cellclass += ' ' + this.toTP('jqx-grid-cleared-cell');
            var rows = this.table[0].rows;
            for (var j = 0; j < columnstart + columnend; j++) {
                if (rows[renderedrows]) {
                    var tablecell = rows[renderedrows].cells[j];
                    if (tablecell.className != cellclass) {
                        tablecell.className = cellclass;
                    }
                    var columnrecord = this.columns.records[j];
                    if (this._horizontalvalue != left && !columnrecord.pinned) {
                        //      $(tablecell).css('margin-left', -left);
                        if (this.oldhscroll == true) {
                            var margin = -left;
                            tablecell.style.marginLeft = -left + 'px';
                        }
                    }
                    var cellwidth = columnrecord.width;
                    if (cellwidth < columnrecord.minwidth) cellwidth = columnrecord.minwidth;
                    if (cellwidth > columnrecord.maxwidth) cellwidth = columnrecord.maxwidth;

                    if (parseInt(tablecell.style.width) != cellwidth) {
                        $(tablecell).width(cellwidth);
                    }
                    if (tablecell.title != "") {
                        tablecell.title = "";
                    }
                    if (tablecell.innerHTML != "") {
                        tablecell.innerHTML = "";
                    }
                }
            }
            if (rows[renderedrows]) {
                if (parseInt(rows[renderedrows].style.height) != this.rowsheight) {
                    rows[renderedrows].style.height = parseInt(this.rowsheight) + 'px';
                }
            }
        },

        _findgroupstate: function (uniqueid) {
            var group = this._findgroup(uniqueid);
            if (group == null) {
                return false;
            }
            return group.expanded;
        },

        _findgroup: function (uniqueid) {
            var group = null;

            if (this.expandedgroups[uniqueid])
                return this.expandedgroups[uniqueid];

            return group;
        },

        _clearcaches: function () {
            this._columnsbydatafield = new Array();
            this._pagescache = new Array();
            this._pageviews = new Array();
            this._cellscache = new Array();
            this.heights = new Array();
            this.hiddens = new Array();
            this.hiddenboundrows = new Array();
            this.heightboundrows = new Array();
            this.detailboundrows = new Array();
            this.details = new Array();
            this.expandedgroups = new Array();
            this._rowdetailscache = new Array();
            this._rowdetailselementscache = new Array();
            if ($.jqx.dataFormat) {
                $.jqx.dataFormat.cleardatescache();
            }
            this.tableheight = null;
        },

        _getColumnText: function (datafield) {
            if (this._columnsbydatafield == undefined) {
                this._columnsbydatafield = new Array();
            }

            if (this._columnsbydatafield[datafield])
                return this._columnsbydatafield[datafield];

            var columnname = datafield;
            var column = null;
            $.each(this.columns.records, function () {
                if (this.datafield == datafield) {
                    columnname = this.text;
                    column = this;
                    return false;
                }
            });

            this._columnsbydatafield[datafield] = { label: columnname, column: column };
            return this._columnsbydatafield[datafield];
        },

        _getcolumnbydatafield: function (datafield) {
            if (this.__columnsbydatafield == undefined) {
                this.__columnsbydatafield = new Array();
            }

            if (this.__columnsbydatafield[datafield])
                return this.__columnsbydatafield[datafield];

            var columnname = datafield;
            var column = null;
            $.each(this.columns.records, function () {
                if (this.datafield == datafield || this.displayfield == datafield) {
                    columnname = this.text;
                    column = this;
                    return false;
                }
            });

            this.__columnsbydatafield[datafield] = column;
            return this.__columnsbydatafield[datafield];
        },

        isscrollingvertically: function () {
            var isscrolling = (this.vScrollBar.jqxScrollBar('isScrolling'))
            return isscrolling;
        },

        _renderrowdetails: function (cellclass, tablerow, renderrow, columnstart, columnend, renderedrows) {
            if (tablerow == undefined)
                return;

            var $tablerow = $(tablerow);
            var cellindex = 0;
            var indent = this.rowdetails && this.showrowdetailscolumn ? (1 + this.groups.length) * this.groupindentwidth : (this.groups.length) * this.groupindentwidth;
            if (this.groupable && this.groups.length > 0) {
                for (var detailsIndex = 0; detailsIndex <= columnend; detailsIndex++) {
                    var tablecell = $(tablerow.cells[detailsIndex]);
                    tablecell[0].innerHTML = "";
                    tablecell[0].className = 'jqx-grid-details-cell';
                }
            }

            var tablecell = $(tablerow.cells[cellindex]);
            if (tablecell[0].style.display == "none") {
                var cellToRender = tablerow.cells[cellindex];
                var m = 2;
                var start = cellindex;
                while (cellToRender != undefined && cellToRender.style.display == 'none' && m < 10) {
                    cellToRender = tablerow.cells[start + m - 1];
                    m++;
                }
                tablecell = $(cellToRender);
            }

            if (this.rtl) {
                for (var s = columnstart; s < columnend; s++) {
                    tablerow.cells[s].innerHTML = "";
                    tablerow.cells[s].className = 'jqx-grid-details-cell';
                }
            }

            tablecell.css('width', '100%');
            $tablerow.height(renderrow.rowdetailsheight);
            tablecell[0].className = cellclass;

            var boundindex = this.getboundindex(renderrow);
            var lookupkey = boundindex + "_";

            if (this._rowdetailscache[lookupkey]) {
                var cache = this._rowdetailscache[lookupkey];
                var $detailselement = cache.html;

                if (this.initrowdetails) {
                    if (this._rowdetailscache[lookupkey].element) {
                        var element = this._rowdetailscache[lookupkey].element;
                        var tablecelloffset = tablecell.coord();
                        var gridcontentoffset = this.gridcontent.coord();
                        var top = parseInt(tablecelloffset.top) - parseInt(gridcontentoffset.top);
                        var left = parseInt(tablecelloffset.left) - parseInt(gridcontentoffset.left);
                        if (this.rtl) {
                            left = 0;
                        }

                        $(element).css('top', top);
                        $(element).css('left', left);
                        $(element).css('display', 'block');
                        $(element).width(this.host.width() - indent);
                        if (this.layoutrowdetails) {
                            this.layoutrowdetails(boundindex, element, this.element, this.getrowdata(boundindex));
                        }
                    }
                }
                else {
                    tablecell[0].innerHTML = $detailselement;
                }
                return;
            }

            tablecell[0].innerHTML = '';
            if (!this.enablerowdetailsindent) {
                indent = 0;
            }

            var detailselement = '<div role="rowgroup" style="border: none; overflow: hidden; width: 100%; height: 100%; margin-left: ' + indent + 'px;">' + renderrow.rowdetails + '</div>';
            if (this.rtl) {
                var detailselement = '<div role="rowgroup" style="border: none; overflow: hidden; width: 100%; height: 100%; margin-left: ' + 0 + 'px; margin-right: ' + indent + 'px;">' + renderrow.rowdetails + '</div>';
            }

            this._rowdetailscache[lookupkey] = { id: tablerow.id, html: detailselement }
            if (this.initrowdetails) {
                var element = $(detailselement)[0];
                $(this.gridcontent).prepend($(element));

                $(element).css('position', 'absolute');
                $(element).width(this.host.width() - indent);
                $(element).height(tablecell.height());

                var tablecelloffset = tablecell.coord();
                $(element).css('z-index', 2000);
                if (this.isTouchDevice()) {
                    $(element).css('z-index', 99999);
                }
                $(element).addClass(this.toThemeProperty('jqx-widget-content'));
                var tablecelloffset = tablecell.coord();
                var gridcontentoffset = this.gridcontent.coord();
                var top = parseInt(tablecelloffset.top) - parseInt(gridcontentoffset.top);
                var left = parseInt(tablecelloffset.left) - parseInt(gridcontentoffset.left);

                $(element).css('top', top);
                $(element).css('left', left);

                this.content[0].scrollTop = 0;
                this.content[0].scrollLeft = 0;
                var details = $($(element).children()[0]);
                if (details[0].id != "") {
                    details[0].id = details[0].id + boundindex;
                }

                this.initrowdetails(boundindex, element, this.element, this.getrowdata(boundindex));

                this._rowdetailscache[lookupkey].element = element;
                this._rowdetailselementscache[boundindex] = element;
            }
            else {
                tablecell[0].innerHTML = detailselement;
            }
        },

        _defaultcellsrenderer: function (value, column) {
            if (column.cellsformat != '') {
                if ($.jqx.dataFormat) {
                    if ($.jqx.dataFormat.isDate(value)) {
                        value = $.jqx.dataFormat.formatdate(value, column.cellsformat, this.gridlocalization);
                    }
                    else if ($.jqx.dataFormat.isNumber(value)) {
                        value = $.jqx.dataFormat.formatnumber(value, column.cellsformat, this.gridlocalization);
                    }
                }
            }

            var margin = '4px';
            if (this.rowsheight != 25) {
                margin = (this.rowsheight / 2 - this._cellheight / 2);
                if (margin < 0) {
                    margin = 4;
                }
                margin += 'px';
            }

            if (this.enableellipsis) {
                if (column.cellsalign == 'center' || column.cellsalign == 'middle') {
                    margin = '5px';
                    return '<div style="text-overflow: ellipsis; overflow: hidden; padding-bottom: 2px; text-align: center; margin-top: ' + margin + ';">' + value + '</div>';
                }

                if (column.cellsalign == 'left')
                    return '<div style="overflow: hidden; text-overflow: ellipsis; padding-bottom: 2px; text-align: left; margin-right: 2px; margin-left: 4px; margin-top: ' + margin + ';">' + value + '</div>';

                if (column.cellsalign == 'right')
                    return '<div style="overflow: hidden;  text-overflow: ellipsis; padding-bottom: 2px; text-align: right; margin-right: 2px; margin-left: 4px; margin-top: ' + margin + ';">' + value + '</div>';
            }

            if (column.cellsalign == 'center' || column.cellsalign == 'middle') {
                margin = '5px';
                return '<div style="text-align: center; margin-top: ' + margin + ';">' + value + '</div>';
            }
            return '<span style="margin-left: 4px; margin-right: 2px; margin-top: ' + margin + '; float: ' + column.cellsalign + ';">' + value + '</span>';
        },

        getcelltext: function (row, datafield) {
            if (row == null || datafield == null)
                return null;

            var cellvalue = this.getcellvalue(row, datafield);
            var column = this.getcolumn(datafield);
            if (column && column.cellsformat != '') {
                if ($.jqx.dataFormat) {
                    if ($.jqx.dataFormat.isDate(cellvalue)) {
                        cellvalue = $.jqx.dataFormat.formatdate(cellvalue, column.cellsformat, this.gridlocalization);
                    }
                    else if ($.jqx.dataFormat.isNumber(cellvalue)) {
                        cellvalue = $.jqx.dataFormat.formatnumber(cellvalue, column.cellsformat, this.gridlocalization);
                    }
                }
            }
            return cellvalue;
        },

        getcelltextbyid: function (row, datafield) {
            if (row == null || datafield == null)
                return null;

            var cellvalue = this.getcellvaluebyid(row, datafield);
            var column = this.getcolumn(datafield);
            if (column && column.cellsformat != '') {
                if ($.jqx.dataFormat) {
                    if ($.jqx.dataFormat.isDate(cellvalue)) {
                        cellvalue = $.jqx.dataFormat.formatdate(cellvalue, column.cellsformat, this.gridlocalization);
                    }
                    else if ($.jqx.dataFormat.isNumber(cellvalue)) {
                        cellvalue = $.jqx.dataFormat.formatnumber(cellvalue, column.cellsformat, this.gridlocalization);
                    }
                }
            }
            return cellvalue;
        },

        _getcellvalue: function (column, row) {
            var value = null;
            value = row.bounddata[column.datafield];
            if (column.displayfield != null) {
                value = row.bounddata[column.displayfield];
            }

            if (value == null) value = "";
            return value;
        },

        // gets a cell.
        getcell: function (row, datafield) {
            if (row == null || datafield == null)
                return null;

            var rowindex = parseInt(row);
            var datarow = row;
            var value = '';

            if (!isNaN(rowindex)) {
                datarow = this.getrowdata(rowindex);
            }

            if (datarow != null) {
                value = datarow[datafield];
            }

            return this._getcellresult(value, row, datafield);
        },
        // gets the rendered cell data.
        getrenderedcell: function (row, datafield) {
            if (row == null || datafield == null)
                return null;

            var rowindex = parseInt(row);
            var datarow = row;
            var value = '';

            if (!isNaN(rowindex)) {
                datarow = this.getrenderedrowdata(rowindex);
            }

            if (datarow != null) {
                value = datarow[datafield];
            }
            return this._getcellresult(value, row, datafield);
        },

        _getcellresult: function (value, row, datafield) {
            var column = this.getcolumn(datafield);
            if (column == null || column == undefined) {
                return null;
            }

            var properties = column.getcolumnproperties();

            var hidden = properties.hidden;
            var width = properties.width;
            var pinned = properties.pinned;
            var align = properties.cellsalign;
            var format = properties.cellsformat;
            var height = this.getrowheight(row);

            // invalid row.
            if (height == false) {
                return null;
            }

            return { value: value, row: row, column: datafield, datafield: datafield, width: width, height: height, hidden: hidden, pinned: pinned, align: align, format: format };
        },

        setcellvaluebyid: function(row, datafield, value, refresh, sync) {
            var rowindex = this.getrowboundindexbyid(row);
            return this.setcellvalue(rowindex, datafield, value, refresh, sync);
        },

        getcellvaluebyid: function (row, datafield) {
            var rowindex = this.getrowboundindexbyid(row);
            return this.getcellvalue(rowindex, datafield);
        },
       
        setcellvalue: function (row, datafield, value, refresh, sync) {
            if (row == null || datafield == null)
                return false;

            var rowindex = parseInt(row);
            var datasourcerowindex = rowindex;

            var datarow = row;
            if (!isNaN(rowindex)) {
                datarow = this.getrowdata(rowindex);
            }

            var hasfilter = false;
            if (this.filterable && this._initfilterpanel && this.dataview.filters.length) {
                hasfilter = true;
            }
            if (this.virtualmode) {
                this._pagescache = new Array();
            }

            var oldvalue = "";
            if (datarow != null && datarow[datafield] !== value) {
                var column = this._getcolumnbydatafield(datafield);
                var type = 'string';
                var datafields = this.source.datafields || ((this.source._source) ? this.source._source.datafields : null);

                if (datafields) {
                    var foundType = "";
                    $.each(datafields, function () {
                        if (this.name == column.displayfield) {
                            if (this.type) {
                                foundType = this.type;
                            }
                            return false;
                        }
                    });
                    if (foundType)
                        type = foundType;
                }

                oldvalue = datarow[datafield];
                if (!column.nullable || (value != null && value !== "" && column.nullable && value.label === undefined)) {
                    if ($.jqx.dataFormat.isNumber(oldvalue) || type == 'number' || type == 'float' || type == 'int' || type == 'decimal' && type != 'date') {
                        value = new Number(value);
                        value = parseFloat(value);
                        if (isNaN(value)) {
                            value = 0;
                        }
                    }
                    else if ($.jqx.dataFormat.isDate(oldvalue) || type == 'date') {
                        if (value != '') {
                            var tmp = value;
                            tmp = new Date(tmp);
                            if (tmp != 'Invalid Date' && tmp != null) {
                                value = tmp;
                            }
                            else if (tmp == 'Invalid Date') {
                                tmp = new Date();
                                value = tmp;
                            }
                        }
                    }
                }
               
                datarow[datafield] = value;
                var renderedrow = this.getrenderedrowdata(rowindex, true);
                renderedrow[datafield] = value;

                if (value != null && value.label != null) {
                    var column = this._getcolumnbydatafield(datafield);
                    datarow[column.displayfield] = value.label;
                    renderedrow[column.displayfield] = value.label;
                    datarow[datafield] = value.value;
                    renderedrow[datafield] = value.value;
                }

                if (hasfilter) {
                    if (datarow.dataindex != undefined) {
                        datasourcerowindex = datarow.dataindex;
                        this.dataview.cachedrecords[datarow.dataindex][datafield] = value;
                        if (value != null && value.label != undefined) {
                            this.dataview.cachedrecords[datarow.dataindex][datafield] = value.value;
                            this.dataview.cachedrecords[datarow.dataindex][column.displayfield] = value.label;
                        }
                    }
                }
            }
            else {
                if (!this._updating && refresh != false) {
                    this._renderrows(this.virtualsizeinfo);
                }
                return false;
            }

            if (this.source && this.source._knockoutdatasource && !this._updateFromAdapter && this.autokoupdates) {
                if (this.source._source._localdata) {
                    var korowindex = rowindex;
                    if (hasfilter) {
                        if (datarow.dataindex != undefined) {
                            korowindex = datarow.dataindex;
                        }
                    }

                    var olditem = this.source._source._localdata()[korowindex];
                    this.source.suspendKO = true;
                    var oldobject = olditem;
                    if (oldobject[datafield] && oldobject[datafield].subscribe) {
                        if (value != null && value.label != null) {
                            oldobject[column.displayfield](value.label);
                            oldobject[datafield](value.value);
                        }
                        else {
                            oldobject[datafield](value);
                        }
                    }
                    else {
                        var datafields = this.source._source.datafields;
                        var sourcedatafield = null;
                        var map = null;
                        if (datafields) {
                            $.each(datafields, function () {
                                if (this.name == datafield) {
                                    map = this.map;
                                    return false;
                                }
                            });
                        }
                        if (map == null) {
                            if (value != null && value.label != null) {
                                oldobject[datafield] = value.value;
                                oldobject[column.displayfield] = value.label;
                            }
                            else {
                                oldobject[datafield] = value;
                            }
                        }
                        else {
                            var splitMap = map.split(this.source.mapChar);
                            if (splitMap.length > 0) {
                                var datavalue = oldobject;
                                for (var p = 0; p < splitMap.length-1; p++) {
                                    datavalue = datavalue[splitMap[p]];
                                }
                                datavalue[splitMap[splitMap.length - 1]] = value;
                            }
                        }
                        this.source._source._localdata.replace(olditem, $.extend({}, oldobject));
                    }

                    this.source.suspendKO = false;
                }
            }

            if (this.sortcolumn && this.dataview.sortby && !this._updating) {
                var sortinformation = this.getsortinformation();
                if (this.sortcolumn == datafield) {
                    this.dataview.clearsortdata();
                    this.dataview.sortby(sortinformation.sortcolumn, sortinformation.sortdirection.ascending);
                }
            }
            else if (!this._updating){
                if (this.dataview.sortby) {
                    if (this.dataview.sortcache[datafield]) {
                        this.dataview.sortcache[datafield] = null;
                    }
                }
            }

            this._cellscache = new Array();

            if (this.source.updaterow && (sync == undefined || sync == true)) {
                var success = false;
                var me = this.that;
                var result = function (param) {
                    if (false == param) {
                        me.setcellvalue(row, datafield, oldvalue, true, false);
                    }
                }
                try {
                    var rowid = this.getrowid(rowindex);
                    success = this.source.updaterow(rowid, datarow, result);
                    if (success == undefined) success = true;
                }
                catch (error) {
                    success = false;
                    me.setcellvalue(row, datafield, oldvalue, true, false);
                    return;
                }
            }

            //     var rowid = this.getrowid(row);
            var scrollvalue = this.vScrollInstance.value;

            if (this._updating && refresh != true) {
                refresh = false;
            }

            if (refresh == true || refresh == undefined) {
                var me = this.that;
                var updatepager = function () {
                    if (me.pageable && me.updatepagerdetails) {
                        me.updatepagerdetails();
                        if (me.autoheight || me.autorowheight) {
                            me._updatepageviews();
                        }
                    }
                }
                var hasgroups = this.groupable && this.groups.length > 0;

                if (hasfilter && !hasgroups) {
                    if (this.autoheight || this.autorowheight) this.prerenderrequired = true;
                    this.dataview.refresh();
                    this.rendergridcontent(true, false);
                    updatepager();
                    this._renderrows(this.virtualsizeinfo);
                }
                else if (this.sortcolumn && !hasgroups) {
                    if (this.autoheight || this.autorowheight) this.prerenderrequired = true;
                    this.dataview.reloaddata();
                    this.rendergridcontent(true, false);
                    updatepager();
                    this._renderrows(this.virtualsizeinfo);
                }
                else if (this.groupable && this.groups.length > 0) {
                    if (this.autoheight || this.autorowheight) this.prerenderrequired = true;
                    if (this.pageable) {
                        if (this.groups.indexOf(datafield) != -1) {
                            this._pagescache = new Array();
                            this._cellscache = new Array();
                            this.dataview.refresh();
                            this._render(true, true, false, false);
                        }
                        else {
                            this._pagescache = new Array();
                            this._cellscache = new Array();
                            this.dataview.updateview();
                            this._renderrows(this.virtualsizeinfo);
                        }
                    }
                    else {
                        this._pagescache = new Array();
                        this._cellscache = new Array();
                        this.dataview.updateview();
                        this._renderrows(this.virtualsizeinfo);

                        //     this.dataview.updateview();
                        //     this._renderrows(this.virtualsizeinfo);
                    }
                    //                    this.dataview.reloaddata();
                    //                    this.render(true, true, false, false);
                    //                    var datarow = this.getrowdata(row);
                    //                    var renderedrow = this.getrenderedrowdata(rowindex, true);
                    //                    var parentItem = renderedrow.parentItem;
                    //                    this._setgroupstate(parentItem, true, true);
                }
                else {
                    this.dataview.updateview();
                    this._renderrows(this.virtualsizeinfo);
                }
            }
            this.vScrollInstance.setPosition(scrollvalue);
            if (this.showaggregates && this._updatecolumnsaggregates) {
                this._updatecolumnsaggregates();
            }
            if (this.showfilterrow && this.filterable && this.filterrow) {
                var filtertype = this.getcolumn(datafield).filtertype;
                if (filtertype == 'list' || filtertype == 'checkedlist') {
                    this._updatelistfilters(true);
                }
            }

            this._raiseEvent(19, { rowindex: row, datafield: datafield, newvalue: value, value: value, oldvalue: oldvalue });
            return true;
        },

        // get cell's bound value.
        getcellvalue: function (row, datafield) {
            if (row == null || datafield == null)
                return null;

            var rowindex = parseInt(row);
            var datarow = row;
            if (!isNaN(rowindex)) {
                datarow = this.getrowdata(rowindex);
            }

            if (datarow != null) {
                var value = datarow[datafield];
                return value;
            }

            return null;
        },

        getrows: function () {
            var length = this.dataview.records.length;
            if (this.virtualmode) {
                var rows = new Array();

                for (var i = 0; i < this.dataview.records.length; i++) {
                    var record = this.dataview.records[i];
                    if (record) {
                        rows.push(record);
                    }
                }
                if (this.dataview.records.length === undefined) {
                    $.each(this.dataview.records, function () {
                        var record = this;
                        if (record) {
                            rows.push(record);
                        }
                    });
                }

                var recordsoffset = 0;
                if (this.pageable) {
                    recordsoffset = this.dataview.pagenum * this.dataview.pagesize;
                }

                if (rows.length > this.source._source.totalrecords - recordsoffset) {
                    return rows.slice(0, this.source._source.totalrecords - recordsoffset);
                }
                return rows;
            }

            if (this.dataview.sortdata) {
                var rows = new Array();
                for (var i = 0; i < length; i++) {
                    var item = {};
                    item = $.extend({}, this.dataview.sortdata[i].value);
                    rows[i] = item;
                }
                return rows;
            }
            else return this.dataview.records;
        },

        getrowboundindexbyid: function(id)
        {
            var rowdata = this.dataview.recordsbyid["id" + id];
            if (rowdata) {
                if (rowdata.boundindex)
                    return this.getboundindex(rowdata);
            }

            var rows = this.getboundrows();
            for (var i = 0; i < rows.length; i++) {
                if (rows[i]) {
                    if (rows[i].uid == id) {
                        return i;
                    }
                }
            }

            return -1;
        },

        getrowdatabyid: function(id)
        {
            var rowdata = this.dataview.recordsbyid["id" + id];
            if (rowdata) {
                return rowdata;
            }
            else {
                var index = this.getrowboundindexbyid(id);
                return this.getboundrows()[index];
            }

            return null;
        },

        // get getrowdata.
        getrowdata: function (boundindex) {
            if (boundindex == undefined)
                boundindex = 0;

            if (this.virtualmode) {
                var record = this.dataview.records[boundindex];
                return record;
            }
            else {
                var record = this.getboundrows()[boundindex];
                return record;
            }

            return null;
        },

        // deprecated.
        // get visible row data.
        getrenderedrowdata: function (boundindex, bypasspaging) {
            if (boundindex == undefined)
                boundindex = 0;

            if (this.virtualmode) {
                var visibleindex = this.getrowvisibleindex(boundindex);
                var record = this.dataview.loadedrecords[visibleindex];
                return record;
            }

            var visibleindex = this.getrowvisibleindex(boundindex);
            if (visibleindex >= 0) {
                if (this.groupable && this.groups.length > 0) {
                    var record = this.dataview.loadedrecords[visibleindex];
                }
                else {
                    var record = this.dataview.loadedrecords[visibleindex];

                    if (this.pageable && (bypasspaging == undefined || bypasspaging == false)) {
                        var record = this.dataview.loadedrecords[this.dataview.pagesize * this.dataview.pagenum + boundindex];
                    }
                }
                return record;
            }

            return null;
        },

        // gets all rows loaded in jqxGrid.
        getboundrows: function () {
            return this.dataview.cachedrecords;
        },

        getrowdisplayindex: function(boundindex)
        {
            var rows = this.getdisplayrows();
            for (var i = 0; i < rows.length; i++) {
                if (rows[i].dataindex !== undefined) {
                    if (rows[i].dataindex === boundindex)
                        return rows[i].visibleindex;
                }
                else {
                    if (rows[i].boundindex === boundindex)
                        return rows[i].visibleindex;
                }
            }
            return -1;
        },

        getboundindex: function(row)
        {
            var boundindex = row.boundindex;
            if (this.dataview.filters.length > 0) {
                if (row.bounddata) {
                    if (row.bounddata.dataindex !== undefined) {
                        boundindex = row.bounddata.dataindex;
                    }
                }
                else {
                    if (row.dataindex !== undefined) {
                        boundindex = row.dataindex;
                    }
                }
            }
            return boundindex;
        },

        getrowboundindex: function (displayindex) {
            var rowdata = this.getdisplayrows()[displayindex];
            if (rowdata) {
                if (rowdata.dataindex !== undefined) {
                    return rowdata.dataindex;
                }

                return rowdata.boundindex;
            }
            return -1;
        },

        // gets all rows displayed in jqxGrid.
        getdisplayrows: function()
        {
            return this.dataview.loadedrecords;
        },

        // deprecated.
        getloadedrows: function () {
            return this.getdisplayrows();
        },

        // deprecated.
        getvisiblerowdata: function (visibleindex) {
            var visiblerows = this.getvisiblerows();
            if (visiblerows) {
                return visiblerows[visibleindex];
            }

            return null;
        },

        // deprecated.
        getloadedrowdata: function (visibleindex) {
            var visiblerows = this.getloadedrows();
            if (visiblerows) {
                return visiblerows[visibleindex];
            }

            return null;
        },

        // deprecated.
        getvisiblerows: function () {
            if (this.virtualmode) {
                return this.dataview.loadedrecords
            }

            if (this.pageable) {
                var rows = [];
                for (var i = 0; i < this.dataview.pagesize; i++) {
                    var record = this.dataview.loadedrecords[i + (this.dataview.pagesize * this.dataview.pagenum)];
                    if (record == undefined) break;
                    rows.push(record);
                }
                return rows;
            }
            else {
                if (this._startboundindex != undefined && this._endboundindex != undefined) {
                    var rows = [];

                    for (var i = this._startvisibleindex; i <= this._endvisibleindex; i++) {
                        var record = this.dataview.loadedrecords[i];
                        if (record == undefined) break;
                        rows.push(record);
                    }
                    return rows;
                }
            }

            return this.dataview.loadedrecords;
        },

        // get row id.
        getrowid: function (boundindex) {
            if (boundindex == undefined)
                boundindex = 0;

            if (this.virtualmode) {
                var visibleindex = this.getrowvisibleindex(boundindex);
                var record = this.dataview.loadedrecords[visibleindex];
                if (record)
                    return record.uid;
            }
            else {
                var record = null;
                var hasFilters = this.dataview.filters.length > 0;
                if (boundindex >= 0 && boundindex < this.dataview.bounditems.length && !hasFilters) {
                    if (this.groupable && this.groups.length > 0) {
                        var visibleindex = this.getrowvisibleindex(boundindex);
                        var record = this.dataview.loadedrecords[visibleindex];
                    }
                    else {
                        var visibleindex = this.getrowvisibleindex(boundindex);
                        var record = this.dataview.loadedrecords[visibleindex];
                    }
                    if (record)
                        return record.uid;
                }
                if (this.dataview.filters.length > 0) {
                    var record = this.getboundrows()[boundindex];
                    if (record) {
                        if (record.uid != null) {
                            return record.uid;
                        }
                    }
                    return null;
                }
            }

            return null;
        },

        _updateGridData: function (reason) {
            var hasfilter = false;
            if (this.filterable && this._initfilterpanel && this.dataview.filters.length) {
                hasfilter = true;
            }
            if (hasfilter) {
                this.dataview.refresh();
                if (reason == "updaterow") {
                    this._render(true, true, false, false, false);
                    this.invalidate();
                }
                else {
                    this.render();
                }
            }
            else if (this.sortcolumn || (this.groupable && this.groups.length > 0)) {
                this.dataview.reloaddata();
                this.render();
            }
            else {
                this._cellscache = new Array();
                this._pagescache = new Array();
                this._renderrows(this.virtualsizeinfo);
            }
            if (this.showfilterrow && this.filterable && this.filterrow) {
                this._updatelistfilters(true);
            }
        },

        // update row.
        updaterow: function (rowid, rowdata, refresh) {
            if (rowid != undefined && rowdata != undefined) {
                var me = this.that;
                var success = false;
                me._datachanged = true;
                var applychanges = function (me, rowid, rowdata) {
                    if (me._loading) {
                        throw new Error('jqxGrid: ' + me.loadingerrormessage);
                        return false;
                    }

                    var success = false;
                    if (!$.isArray(rowid)) {
                        success = me.dataview.updaterow(rowid, rowdata);
                    }
                    else {
                        $.each(rowid, function (index, value) {
                            success = me.dataview.updaterow(this, rowdata[index], false);
                        });
                        me.dataview.refresh();
                    }

                    var scrollvalue = me.vScrollInstance.value;
                    if (refresh == undefined || refresh == true) {
                        if (me._updating == undefined || me._updating == false) {
                            me._updateGridData("updaterow");
                        }
                    }

                    if (me.showaggregates && me._updatecolumnsaggregates) {
                        me._updatecolumnsaggregates();
                    }

                    if (me.source && me.source._knockoutdatasource && !me._updateFromAdapter && me.autokoupdates) {
                        if (me.source._source._localdata) {
                            var record = me.dataview.recordsbyid["id" + rowid];
                            var recordindex = me.dataview.records.indexOf(record);
                            var olditem = me.source._source._localdata()[recordindex];
                            me.source.suspendKO = true;
                            me.source._source._localdata.replace(olditem, $.extend({}, record));
                            me.source.suspendKO = false;
                        }
                    }

                    me.vScrollInstance.setPosition(scrollvalue);
                    return success;
                }

                if (this.source.updaterow) {
                    var done = function (result) {
                        if (result == true || result == undefined) {
                            applychanges(me, rowid, rowdata);
                        }
                    }
                    try {
                        success = this.source.updaterow(rowid, rowdata, done);
                        if (success == undefined) success = true;
                    }
                    catch (error) {
                        success = false;
                    }
                }
                else {
                    success = applychanges(me, rowid, rowdata);
                }

                return success;
            }

            return false;
        },

        // delete row.
        deleterow: function (rowid) {
            if (rowid != undefined) {
                this._datachanged = true;
                var success = false;
                var me = this.that;

                var applychanges = function (me, rowid) {
                    if (me._loading) {
                        throw new Error('jqxGrid: ' + me.loadingerrormessage);
                        return false;
                    }

                    var success = false;
                    var scrollvalue = me.vScrollInstance.value;
                    if (!$.isArray(rowid)) {
                        var success = me.dataview.deleterow(rowid);
                    }
                    else {
                        $.each(rowid, function () {
                            success = me.dataview.deleterow(this, false);
                        });
                        me.dataview.refresh();
                    }
                    if (me._updating == undefined || me._updating == false) {
                        me._render(true, true, false, false);
                        if (me.vScrollBar.css('visibility') != 'visible') {
                            me._arrange();
                            me._updatecolumnwidths();
                            me._updatecellwidths();
                            me._renderrows(me.virtualsizeinfo);
                        }
                    }

                    if (me.source && me.source._knockoutdatasource && !me._updateFromAdapter && me.autokoupdates) {
                        if (me.source._source._localdata) {
                            me.source.suspendKO = true;
                            me.source._source._localdata.pop(rowdata);
                            me.source.suspendKO = false;
                        }
                    }

                    me.vScrollInstance.setPosition(scrollvalue);
                    return success;
                }

                if (this.source.deleterow) {
                    var done = function (result) {
                        if (result == true || result == undefined) {
                            applychanges(me, rowid);
                        }
                    }
                    try {
                        this.source.deleterow(rowid, done);
                        if (success == undefined) success = true;
                    }
                    catch (error) {
                        success = false;
                    }
                }
                else {
                    success = applychanges(me, rowid);
                }
                return success;
            }

            return false;
        },

        // add row.
        addrow: function (rowid, rowdata, position) {
            if (rowdata != undefined) {
                this._datachanged = true;
                if (position == undefined) {
                    position = 'last';
                }

                var success = false;
                var me = this.that;
   
                if (rowid == null) {
                    var hasFilter = this.dataview.filters && this.dataview.filters.length > 0;
                    var totallength = !hasFilter ? this.dataview.totalrecords : this.dataview.cachedrecords.length;
                    if (!$.isArray(rowdata)) {
                        rowid = this.dataview.getid(this.dataview.source.id, rowdata, totallength);
                        while (null != this.dataview.recordsbyid["id" + rowid]) {
                            rowid++;
                        }
                    } else {
                        var ids = new Array();
                        $.each(rowdata, function (index, value) {
                            var id = me.dataview.getid(me.dataview.source.id, rowdata[index], totallength + index);
                            ids.push(id);
                        });
                        rowid = ids;
                    }
                }

                var applychanges = function (me, rowid, rowdata, position) {
                    if (me._loading) {
                        throw new Error('jqxGrid: ' + me.loadingerrormessage);
                        return false;
                    }

                    var scrollvalue = me.vScrollInstance.value;
                    var success = false;
                    if (!$.isArray(rowdata)) {
                        if (rowdata != undefined && rowdata.dataindex != undefined) {
                            delete rowdata.dataindex;
                        }
                        success = me.dataview.addrow(rowid, rowdata, position);
                    }
                    else {
                        $.each(rowdata, function (index, value) {
                            if (this.dataindex != undefined) {
                                delete this.dataindex;
                            }

                            var id = null;
                            if (rowid != null && rowid[index] != null) id = rowid[index];
                            success = me.dataview.addrow(id, this, position, false);
                        });
                        me.dataview.refresh();
                    }

                    if (me._updating == undefined || me._updating == false) {
                        me._render(true, true, false, false);
                        me.invalidate();
                    }

                    if (me.source && me.source._knockoutdatasource && !me._updateFromAdapter && me.autokoupdates) {
                        if (me.source._source._localdata) {
                            me.source.suspendKO = true;
                            me.source._source._localdata.push(rowdata);
                            me.source.suspendKO = false;
                        }
                    }

                    if (me.scrollmode != "deferred") {
                        me.vScrollInstance.setPosition(scrollvalue);
                    }
                    else {
                        me.vScrollInstance.setPosition(0);
                    }

                    return success;
                }

                if (this.source.addrow) {
                    var done = function (result, ids) {
                        if (result == true || result == undefined) {
                            if (ids != undefined) rowid = ids;
                            applychanges(me, rowid, rowdata, position);
                        }
                    }
                    // undefined or true response code are handled as success. false or exception as failure
                    try {
                        success = this.source.addrow(rowid, rowdata, position, done);
                        if (success == undefined) success = true;
                    }
                    catch (e) {
                        success = false;
                    }
                    if (success == false) {
                        return false;
                    }
                }
                else {
                    applychanges(this, rowid, rowdata, position);
                }

                return success;
            }
            return false;
        },

        _findvisiblerow: function (value, collection) {
            if (value == undefined) {
                value = parseInt(this.vScrollInstance.value);
            }
            var min = 0;
            if (collection == undefined || collection == null) {
                collection = this.rows.records;
            }

            var max = collection.length;
            while (min <= max) {
                mid = parseInt((min + max) / 2)
                var item = collection[mid];

                if (item == undefined)
                    break;

                if (item.top > value && item.top + item.height > value) {
                    max = mid - 1;
                } else if (item.top < value && item.top + item.height < value) {
                    min = mid + 1;
                } else {
                    return mid;
                    break;
                }
            }

            return -1;
        },

        _updatecellwidths: function () {
            var virtualsizeinfo = this.virtualsizeinfo;
            if (!virtualsizeinfo) {
                return;
            }
            var me = this.that;

            if (this.gridcontent == undefined)
                return;

            if (this.table == undefined) {
                this.table = this.gridcontent.find('#contenttable' + this.element.id);
            }

            var hasgroups = this.groupable && this.groups.length > 0;
            var tablewidth = 0;
            var pagesize = virtualsizeinfo.visiblerecords;

            if (this.pageable && (this.autoheight || this.autorowheight)) {
                pagesize = this.dataview.pagesize;

                if (this.groupable) {
                    this.dataview.updateview();
                    pagesize = this.dataview.rows.length;
                }
            }

            if (!this.groupable && !this.pageable && (this.autoheight || this.autorowheight)) {
                pagesize = this.dataview.totalrecords;
            }

            if (this.rowdetails) {
                pagesize += this.dataview.pagesize;
            }

            var columnslength = this.columns.records.length;
            var rows = this.table[0].rows;
            for (var i = 0; i < pagesize; i++) {
                var tablerow = rows[i];
                if (!tablerow)
                    break;

                var cells = tablerow.cells;
                var left = 0;
                for (var j = 0; j < columnslength; j++) {
                    var columnrecord = this.columns.records[j];
                    var width = columnrecord.width;
                    var tablecolumn = cells[j];
                    if (parseInt(tablecolumn.style.left) != left) {
                        tablecolumn.style.left = left + 'px';
                    }

                    if (parseInt(tablecolumn.style.width) != width) {
                        tablecolumn.style.width = width + 'px';
                    }
               //     tablecolumn[0].left = left;
                    if (!(columnrecord.hidden && columnrecord.hideable)) {
                        left += width;
                    }
                    else {
                        tablecolumn.style.display = "none";
                    }
                }

                if (tablewidth == 0) {
                    this.table.width(parseInt(left) + 2);
                    tablewidth = left;
                }
            }

            if (this.showaggregates && this._updateaggregates) {
                this._updateaggregates();
            }
            if (this.showfilterrow && this.filterable && this._updatefilterrowui) {
                this._updatefilterrowui();
            }
            this._updatescrollbarsafterrowsprerender();
            if (hasgroups) {
                this._renderrows(this.virtualsizeinfo);
            }
        },

        _updatescrollbarsafterrowsprerender: function () {
            var hscrollbarvisibility = this.hScrollBar[0].style.visibility;
            var offset = 0;
            var vscrollbarvisibility = this.vScrollBar[0].style.visibility;
            if (vscrollbarvisibility == 'visible') {
                offset = this.scrollbarsize + 3;
            }
            var w = this.element.style.width;
            if (w.toString().indexOf('%') >= 0) {
                w = this.host.width();
            }
            else {
                w = parseInt(w);
            }

            if (parseInt(this.table[0].style.width) - 2 > w - offset) {
                if (hscrollbarvisibility != 'visible') {
                    if (!this.autowidth) {
                        this.hScrollBar.css('visibility', 'visible');
                    }
                    this._arrange();
                }

                if (vscrollbarvisibility == 'visible') {
                    if (this.scrollmode != 'deferred' && !this.virtualmode) {
                        if (this.virtualsizeinfo) {
                            var vscrollbarmax = this.virtualsizeinfo.virtualheight - this._gettableheight();
                            if (!isNaN(vscrollbarmax) && vscrollbarmax > 0) {
                                if (hscrollbarvisibility != 'hidden') {
                                    this.vScrollBar.jqxScrollBar('max', vscrollbarmax + this.scrollbarsize + 4);
                                }
                                else {
                                    this.vScrollBar.jqxScrollBar('max', vscrollbarmax);
                                }
                            }
                        }
                    }
                    else {
                        this._updatevscrollbarmax();
                    }
                }
                else {
                    offset = -2;
                }

                this.hScrollBar.jqxScrollBar('max', offset + this.table.width() - this.host.width());
            }
            else {
                if (hscrollbarvisibility != 'hidden') {
                    this.hScrollBar.css('visibility', 'hidden');
                    this._arrange();
                }
            }
            this._renderhorizontalscroll();
        },

        _prerenderrows: function (virtualsizeinfo) {
            var me = this.that;
            if (this.prerenderrequired == true) {
                this.prerenderrequired = false;
                if (this.editable && this._destroyeditors) {
                    this._destroyeditors();
                }

                if (this.gridcontent == undefined)
                    return;

                this.gridcontent.find('#contenttable' + this.element.id).remove();
                if (this.table != null) {
                    this.table.remove();
                    this.table = null;
                }

                this.table = $('<div id="contenttable' + this.element.id + '" style="overflow: hidden; position: relative;" height="100%"></div>');
                this.gridcontent.addClass(this.toTP('jqx-grid-content'));
                this.gridcontent.addClass(this.toTP('jqx-widget-content'));
                this.gridcontent.append(this.table);
                var hasgroups = this.groupable && this.groups.length > 0;
                var tablewidth = 0;
                this.table[0].rows = new Array();
                var cellclass = this.toTP('jqx-grid-cell');
                if (hasgroups) {
                    cellclass = ' ' + this.toTP('jqx-grid-group-cell');
                }

                var pagesize = virtualsizeinfo.visiblerecords;

                if (this.pageable && (this.autoheight || this.autorowheight)) {
                    pagesize = this.dataview.pagesize;
                    if (this.groupable) {
                        this.dataview.updateview();
                        pagesize = this.dataview.rows.length;
                        if (pagesize < this.dataview.pagesize) {
                            pagesize = this.dataview.pagesize;
                        }
                    }
                }

                if (!this.pageable && (this.autoheight || this.autorowheight)) {
                    pagesize = this.dataview.totalrecords;
                }

                if (this.groupable && (this.autoheight || this.autorowheight) && !this.pageable) {
                    pagesize = this.dataview.rows.length;
                }

                if (this.rowdetails) {
                    if (this.autoheight || this.autorowheight) {
                        pagesize += this.dataview.pagesize;
                    }
                    else {
                        pagesize += pagesize;
                    }
                }

                var columnslength = this.columns.records.length;

                if ($.jqx.browser.msie && $.jqx.browser.version > 8) {
                    this.table.css('opacity', '0.99');
                }

                if ($.jqx.browser.mozilla) {
                    this.table.css('opacity', '0.99');
                }

                if (navigator.userAgent.indexOf('Safari') != -1) {
                    this.table.css('opacity', '0.99');
                }

                var isIE7 = $.jqx.browser.msie && $.jqx.browser.version < 8;
                if (isIE7) {
                    this.host.attr("hideFocus", "true");
                }

                var zindex = this.tableZIndex;
                if (pagesize * columnslength > zindex) {
                    zindex = pagesize * columnslength;
                }
                var isempty = this.dataview.records.length == 0;
                var isTouch = this.isTouchDevice();
                var tableHTML = "";
                this._hiddencolumns = false;
                for (var i = 0; i < pagesize; i++) {
                    var tablerow = '<div role="row" style="position: relative; height=' + this.rowsheight + 'px;" id="row' + i + this.element.id + '">';
                    if (isIE7) {
                        var tablerow = '<div role="row" style="position: relative; z-index: ' + zindex + '; height:' + this.rowsheight + 'px;" id="row' + i + this.element.id + '">';
                        zindex--;
                    }

                    var left = 0;

                    for (var j = 0; j < columnslength; j++) {
                        var columnrecord = this.columns.records[j];
                        var width = columnrecord.width;
                        if (width < columnrecord.minwidth) width = columnrecord.minwidth;
                        if (width > columnrecord.maxwidth) width = columnrecord.maxwidth;
                        if (this.rtl) {
                            var rtlzindex = zindex - columnslength + 2 * j;
                            var tablecolumn = '<div role="gridcell" style="left: ' + left + 'px; z-index: ' + rtlzindex + '; width:' + width + 'px;';
                            zindex--;
                        }
                        else var tablecolumn = '<div role="gridcell" style="left: ' + left + 'px; z-index: ' + zindex-- + '; width:' + width + 'px;';

                        if (!(columnrecord.hidden && columnrecord.hideable)) {
                            left += width;
                        }
                        else {
                            tablecolumn += 'display: none;'
                            this._hiddencolumns = true;
                            zindex++;
                        }
                        tablecolumn += '" class="' + cellclass + '"></div>';
                        tablerow += tablecolumn;
                    }

                    if (tablewidth == 0) {
                        this.table.width(parseInt(left) + 2);
                        tablewidth = left;
                    }

                    tablerow += '</div>';
                    tableHTML += tablerow;
                }

                if (me.WinJS) {
                    MSApp.execUnsafeLocalFunction(function () {
                        me.table.html(tableHTML);
                    });
                }
                else {
                    me.table[0].innerHTML = tableHTML;
                }

                this.table[0].rows = new Array();
                var rows = this.table.children();
                for (var i = 0; i < pagesize; i++) {
                    var row = rows[i];
                    this.table[0].rows.push(row);
                    row.cells = new Array();
                    var cells = $(row).children();
                    for (var j = 0; j < columnslength; j++) {
                        row.cells.push(cells[j]);
                    }
                }

                if (pagesize == 0) {
                    var left = 0;
                    if (this.showemptyrow) {
                        var tablerow = $('<div style="position: relative;" id="row0' + this.element.id + '"></div>');
                        this.table.append(tablerow);
                        tablerow.height(this.rowsheight);
                        this.table[0].rows[0] = tablerow[0];
                        this.table[0].rows[0].cells = new Array();
                    }
                    for (var j = 0; j < columnslength; j++) {
                        var columnrecord = this.columns.records[j];
                        var width = columnrecord.width;
                        if (this.showemptyrow) {
                            var tablecolumn = $('<div style="position: absolute; height: 100%; left: ' + left + 'px; z-index: ' + zindex-- + '; width:' + width + 'px;" class="' + cellclass + '"></div>');
                            tablecolumn.height(this.rowsheight);
                            tablerow.append(tablecolumn);
                            this.table[0].rows[0].cells[j] = tablecolumn[0];
                        }
                        if (width < columnrecord.minwidth) width = columnrecord.minwidth;
                        if (width > columnrecord.maxwidth) width = columnrecord.maxwidth;
                        if (!(columnrecord.hidden && columnrecord.hideable)) {
                            left += width;
                        }
                    }
                    this.table.width(parseInt(left) + 2);
                    tablewidth = left;
                }

                this._updatescrollbarsafterrowsprerender();
                // callback when the rendering is complete.
                if (this.rendered) {
                    this.rendered('rows');
                }
                this._addoverlayelement();
            }
        },

        _groupsheader: function () {
            return this.groupable && this.showgroupsheader;
        },

        _arrange: function () {
            var width = null;
            var height = null;
            this.tableheight = null;
            var me = this.that;
            var isPercentageWidth = false;
            var isPercentageHeight = false;
     
            if (this.width != null && this.width.toString().indexOf("px") != -1) {
                width = this.width;
            }
            else
                if (this.width != undefined && !isNaN(this.width)) {
                    width = this.width;
                };

            if (this.width != null && this.width.toString().indexOf("%") != -1) {
                width = this.width;
                isPercentageWidth = true;
            }

            if (this.autowidth) {
                var w = 0;
                for (var i = 0; i < this.columns.records.length; i++) {
                    var cw = this.columns.records[i].width;
                    if (cw == 'auto') {
                        cw = this._measureElementWidth(this.columns.records[i].text);
                        w += cw;
                    }
                    else {
                        w += cw;
                    }
                }
                if (this.vScrollBar.css('visibility') != 'hidden') {
                    w += this.scrollbarsize + 4
                }

                width = w;
                this.width = width;
            }

            if (this.height != null && this.height.toString().indexOf("px") != -1) {
                height = this.height;
            }
            else if (this.height != undefined && !isNaN(this.height)) {
                height = this.height;
            };

            if (this.height != null && this.height.toString().indexOf("%") != -1) {
                height = this.height;
                isPercentageHeight = true;
            }

            var baseheight = function () {
                var height = 0;
                var columnheaderheight = me.showheader ? me.columnsheader != null ? me.columnsheader.height() + 2 : 0 : 0;
                height += columnheaderheight;
                if (me.pageable) {
                    height += me.pagerheight;
                }
                if (me._groupsheader()) {
                    height += me.groupsheaderheight;
                }
                if (me.showtoolbar) {
                    height += me.toolbarheight;
                }
                if (me.showstatusbar) {
                    height += me.statusbarheight;
                }
                if (me.hScrollBar[0].style.visibility == 'visible') {
                    height += 20;
                }

                return height;
            }

            if (this.autoheight && this.virtualsizeinfo) {
                if (this.pageable && this.gotopage) {
                    //var newheight = this.host.height() - this._gettableheight();
                    var newheight = 0;
                    height = newheight + (this._pageviews[0] ? this._pageviews[0].height : 0);
                    //if (height == 0) {
                    height += baseheight();               
                    //}
                    if (this.showemptyrow && this.dataview.totalrecords == 0) {
                        height += this.rowsheight;
                    }
                }
                else {
                    var newheight = this.host.height() - this._gettableheight();
                    if (this._pageviews.length > 0) {
                        height = newheight + this._pageviews[this._pageviews.length - 1].height + this._pageviews[this._pageviews.length - 1].top;
                        this.vScrollBar[0].style.visibility = 'hidden';
                    }
                    else {
                        height = baseheight();
                        if (this.showemptyrow) {
                            height += this.rowsheight;
                        }
                    }
                }
            }
            else if (this.autoheight) {
                height = this.dataview.totalrecords * this.rowsheight;
                if (this._loading) {
                    height = 250;
                    this.dataloadelement.height(height);
                }
                height += baseheight();

                if (height > 10000)
                    height = 10000;
            }

            if (width != null) {
                width = parseInt(width);
                if (!isPercentageWidth) {
                    if (this.element.style.width != parseInt(this.width) + 'px') {
                        this.element.style.width = parseInt(this.width) + 'px';
                    }
                }
                else {
                    this.element.style.width = this.width;
                }

                if (isPercentageWidth) {
                    width = this.host.width();
                    if (width <= 2) {
                        width = 600;
                        this.host.width(width);
                    }
                    if (!this._oldWidth) {
                        this._oldWidth = width;
                    }
                }
            }
            else this.host.width(250);

            if (height != null) {
                if (!isPercentageHeight) {
                    height = parseInt(height);
                }

                if (!isPercentageHeight) {
                    if (this.element.style.height != parseInt(height) + 'px') {
                        this.element.style.height = parseInt(height) + 'px';
                    }
                }
                else {
                    this.element.style.height = this.height;
                }

                if (isPercentageHeight && !this.autoheight) {
                    height = this.host.height();
                    if (height == 0) {
                        height = 400;
                        this.host.height(height);
                    }
                    if (!this._oldHeight) {
                        this._oldHeight = height;
                    }
                }
            }
            else this.host.height(250);

            if (this.autoheight) {
                this.tableheight = null;
                this._gettableheight();
            }

            var top = 0;

            if (this.showtoolbar) {
                this.toolbar.width(width);
                this.toolbar.height(this.toolbarheight - 1);
                this.toolbar.css('top', 0);
                top += this.toolbarheight;
                height -= parseInt(this.toolbarheight);
            }
            else {
                this.toolbar[0].style.height = '0px';
            }

            if (this.showstatusbar) {
                if (this.showaggregates) {
                    this.statusbar.width(!this.table ? width : Math.max(width, this.table.width()));
                }
                else {
                    this.statusbar.width(width);
                }

                this.statusbar.height(this.statusbarheight - 1);
            }
            else {
                this.statusbar[0].style.height = '0px';
            }

            if (this._groupsheader()) {
                this.groupsheader.width(width);
                this.groupsheader.height(this.groupsheaderheight);
                this.groupsheader.css('top', top);
                var groupsheaderheight = this.groupsheader.height() + 1;
                top += groupsheaderheight;
                if (height > groupsheaderheight) {
                    height -= parseInt(groupsheaderheight);
                }
            }
            else {
                if (this.groupsheader[0].style.width != width + 'px') {
                    this.groupsheader[0].style.width = parseInt(width) + 'px';
                }
                if (this.groupsheader[0].style.height != this.groupsheaderheight + 'px') {
                    this.groupsheader[0].style.height = parseInt(this.groupsheaderheight) + 'px';
                }

                if (this.groupsheader[0].style.top != top + 'px') {
                    this.groupsheader.css('top', top);
                }

                var groupsheaderheight = this.showgroupsheader && this.groupable ? this.groupsheaderheight : 0;
                var newContentTop = top + groupsheaderheight + 'px';
                if (this.content[0].style.top != newContentTop) {
                    this.content.css('top', top + this.groupsheaderheight);
                }
            }

            // scrollbar Size.
            var scrollSize = this.scrollbarsize;
            if (isNaN(scrollSize)) {
                scrollSize = parseInt(scrollSize);
                if (isNaN(scrollSize)) {
                    scrollSize = '17px';
                }
                else scrollSize = scrollSize + 'px';
            }

            scrollSize = parseInt(scrollSize);
            var scrollOffset = 4;
            var bottomSizeOffset = 2;
            var rightSizeOffset = 0;

            // right scroll offset. 
            if (this.vScrollBar[0].style.visibility == 'visible') {
                rightSizeOffset = scrollSize + scrollOffset;
            }

            // bottom scroll offset.
            if (this.hScrollBar[0].style.visibility == 'visible') {
                bottomSizeOffset = scrollSize + scrollOffset + 2;
            }

            var pageheight = 0;
            if (this.pageable) {
                pageheight = this.pagerheight;
                bottomSizeOffset += this.pagerheight;
            }
            if (this.showstatusbar) {
                bottomSizeOffset += this.statusbarheight;
                pageheight += this.statusbarheight;
            }

            if (this.hScrollBar[0].style.height != scrollSize + 'px') {
                this.hScrollBar[0].style.height = parseInt(scrollSize) + 'px';
            }

            if (this.hScrollBar[0].style.top != top + height - scrollOffset - scrollSize - pageheight + 'px' || this.hScrollBar[0].style.left != '0px') {
                this.hScrollBar.css({ top: top + height - scrollOffset - scrollSize - pageheight + 'px', left: '0px' });
            }

            var hScrollWidth = this.hScrollBar[0].style.width;
            var hSizeChange = false;
            var vSizeChange = false;

            if (rightSizeOffset == 0) {
                if (hScrollWidth != (width - 2) + 'px') {
                    this.hScrollBar.width(width - 2);
                    hSizeChange = true;
                }
            }
            else {
                if (hScrollWidth != (width - scrollSize - scrollOffset) + 'px') {
                    this.hScrollBar.width(width - scrollSize - scrollOffset + 'px');
                    hSizeChange = true;
                }
            }


            if (!this.autoheight) {
                if (this.vScrollBar[0].style.width != scrollSize + 'px') {
                    this.vScrollBar.width(scrollSize);
                    vSizeChange = true;
                }
                if (this.vScrollBar[0].style.height != parseInt(height) - bottomSizeOffset + 'px') {
                    this.vScrollBar.height(parseInt(height) - bottomSizeOffset + 'px');
                    vSizeChange = true;
                }
                if (this.vScrollBar[0].style.left != parseInt(width) - parseInt(scrollSize) - scrollOffset + 'px' || this.vScrollBar[0].style.top != top + 'px') {
                    this.vScrollBar.css({ left: parseInt(width) - parseInt(scrollSize) - scrollOffset + 'px', top: top });
                }
            }

            if (this.rtl) {
                this.vScrollBar.css({ left: '0px', top: top });
                if (this.vScrollBar.css('visibility') != 'hidden') {
                    this.hScrollBar.css({ left: scrollSize + 2 });
                }
            }

            var vScrollInstance = this.vScrollInstance;
            vScrollInstance.disabled = this.disabled;
            if (!this.autoheight) {
                if (vSizeChange) {
                    vScrollInstance.refresh();
                }
            }
            var hScrollInstance = this.hScrollInstance;
            hScrollInstance.disabled = this.disabled;
            if (hSizeChange) {
                hScrollInstance.refresh();
            }

            if (this.autowidth) {
                this.hScrollBar[0].style.visibility = 'hidden';
            }

            var updateBottomRight = function (me) {
                if ((me.vScrollBar[0].style.visibility == 'visible') && (me.hScrollBar[0].style.visibility == 'visible')) {
                    me.bottomRight[0].style.visibility = 'visible';
                    me.bottomRight.css({ left: 1 + parseInt(me.vScrollBar.css('left')), top: parseInt(me.hScrollBar.css('top')) });
                    if (me.rtl) {
                        me.bottomRight.css('left', '0px');
                    }

                    me.bottomRight.width(parseInt(scrollSize) + 3);
                    me.bottomRight.height(parseInt(scrollSize) + 4);
                    if (me.showaggregates) {
                        me.bottomRight.css('z-index', 99);
                        me.bottomRight.height(parseInt(scrollSize) + 4 + me.statusbarheight);
                        me.bottomRight.css({ top: parseInt(me.hScrollBar.css('top')) - me.statusbarheight });
                    }
                }
                else me.bottomRight[0].style.visibility = 'hidden';
            }

            updateBottomRight(this);
            if (this.content[0].style.width != width - rightSizeOffset + 'px') {
                this.content.width(width - rightSizeOffset);
            }
            if (this.content[0].style.height != height - bottomSizeOffset + 3 + 'px') {
                this.content.height(height - bottomSizeOffset + 3);
            }
            if (this.content[0].style.top != top + 'px') {
                this.content.css('top', top);
            }
            if (this.rtl) {
                this.content.css('left', rightSizeOffset);
                if (this.table) {
                    var tablewidth = this.table.width();
                    if (tablewidth < width - rightSizeOffset) {
                        this.content.css('left',  width - tablewidth);
                    }
                }
            }

            if (this.showstatusbar) {
                this.statusbar.css('top', top + height - this.statusbarheight - (this.pageable ? this.pagerheight : 0));
                if (this.showaggregates) {
                    if (this.hScrollBar.css('visibility') == 'visible') {
                        this.hScrollBar.css({ top: top + height - scrollOffset - scrollSize - pageheight + this.statusbarheight + 'px' });
                        this.statusbar.css('top', 1 + top + height - scrollSize - 5 - this.statusbarheight - (this.pageable ? this.pagerheight : 0));
                    }
                    updateBottomRight(this);
                }
                if (this.rtl) {
                    if (this.hScrollBar.css('visibility') != 'visible') {
                        this.statusbar.css('left', this.content.css('left'));
                    }
                    else {
                        this.statusbar.css('left', '0px');
                    }
                }
            }

            if (this.pageable) {
                this.pager.width(width);
                this.pager.height(this.pagerheight);
                this.pager.css('top', top + height - this.pagerheight - 1);
            }
            else {
                this.pager[0].style.height = '0px';
            }

            if (this.table != null) {
                var offset = -2;
                if (this.vScrollBar[0].style.visibility == 'visible') {
                    offset = this.scrollbarsize + 3;
                }

                if (this.hScrollBar[0].style.visibility == 'visible') {
                    var newoffset = offset + this.table.width() - this.host.width();
                    if (newoffset >= 0) {
                        this.hScrollBar.jqxScrollBar('max', newoffset);
                    }
                    if (this.hScrollBar[0].style.visibility == 'visible' && newoffset == 0) {
                        this.hScrollBar[0].style.visibility = 'hidden';
                        this._arrange();
                    }
                }
            }

            if (width != parseInt(this.dataloadelement[0].style.width)) {
                this.dataloadelement[0].style.width = this.element.style.width;
            }
            if (height != parseInt(this.dataloadelement[0].style.height)) {
                this.dataloadelement[0].style.height = this.element.style.height;
            }
            this._hostwidth = width;
        },

        // destroy grid.
        destroy: function () {
            delete $.jqx.dataFormat.datescache;
            delete this.gridlocalization;
            $.jqx.utilities.resize(this.host, null, true);

            if (this.table && this.table[0])
            {
                var rowscount = this.table[0].rows.length;
                for (var i = 0; i < rowscount; i++) {
                    var row = this.table[0].rows[i];
                    var cells = row.cells;
                    var cellscount = cells.length;
                    for (var j = 0; j < cellscount; j++) {
                        $(row.cells[j]).remove();
                        row.cells[j] = null;
                        delete row.cells[j];
                    }
                    row.cells = null;
                    if (row.cells) {
                        delete row.cells;
                    }
                    $(this.table[0].rows[i]).remove();
                    this.table[0].rows[i] = null;
                }
                try
                {
                    delete this.table[0].rows;
                }
                catch (error) {
                }
                this.table.remove();
                delete this.table;
            }

            if (this.columns && this.columns.records) {
                for (var i = 0; i < this.columns.records.length; i++) {
                    var column = this.columns.records[i];
                    this._removecolumnhandlers(this.columns.records[i]);
                    if (column.element) {
                        $(column.element).remove();
                        $(column.sortasc).remove();
                        $(column.sortdesc).remove();
                        $(column.filtericon).remove();
                        $(column.menu).remove();

                        column.element = null;
                        column.uielement = null;
                        column.sortasc = null;
                        column.sortdesc = null;
                        column.filtericon = null;
                        column.menu = null;
                        delete column.element;
                        delete column.uielement;
                        delete column.sortasc;
                        delete column.sortdesc;
                        delete column.filtericon;
                        delete column.menu;
                        delete this.columnsrow[0].cells[i];
                    }
                }

                try
                {
                    delete this.columnsrow[0].cells;
                }
                catch (error) {
                }
                delete this.columnsrow;
            }
            jQuery.removeData(document.body, "contextmenu" + this.element.id);

            if (this.host.jqxDropDownList) {
                if (this._destroyfilterpanel) {
                    this._destroyfilterpanel();
                }
            }
            if (this.editable && this._destroyeditors) {
                this._destroyeditors();
            }
            if (this.filterable && this._destroyedfilters && this.showfilterrow) {
                this._destroyedfilters();
            }

            if (this.host.jqxMenu) {
                if (this.gridmenu) {
                    this.removeHandler($(document), 'click.menu' + this.element.id);
                    this.removeHandler(this.gridmenu, 'keydown');
                    this.removeHandler(this.gridmenu, 'closed');
                    this.removeHandler(this.gridmenu, 'itemclick');
                    this.gridmenu.jqxMenu('destroy');
                    this.gridmenu = null;
                }
            }

            if (this.pagershowrowscombo) {
                this.pagershowrowscombo.jqxDropDownList('destroy');
                this.pagershowrowscombo = null;
            }

            if (this.pagerrightbutton) {
                this.removeHandler(this.pagerrightbutton, 'mousedown');
                this.removeHandler(this.pagerrightbutton, 'mouseup');
                this.removeHandler(this.pagerrightbutton, 'click');
                this.pagerrightbutton.jqxButton('destroy');
                this.pagerrightbutton = null;
            }

            if (this.pagerleftbutton) {
                this.removeHandler(this.pagerleftbutton, 'mousedown');
                this.removeHandler(this.pagerleftbutton, 'mouseup');
                this.removeHandler(this.pagerleftbutton, 'click');
                this.pagerleftbutton.jqxButton('destroy');
                this.removeHandler($(document), 'mouseup.pagerbuttons' + this.element.id);
                this.pagerleftbutton = null;
            }

            this.removeHandler($(document), 'mousedown.resize' + this.element.id);
            this.removeHandler($(document), 'mouseup.resize' + this.element.id);
            this.removeHandler($(document), 'mousemove.resize' + this.element.id);
            this.removeHandler($(document), 'mousedown.reorder' + this.element.id);
            this.removeHandler($(document), 'mouseup.reorder' + this.element.id);
            this.removeHandler($(document), 'mousemove.reorder' + this.element.id);
            this.removeHandler($(window), 'resize.' + this.element.id);

            if (this.groupable) {
                var mousemove = 'mousemove.grouping' + this.element.id;
                var mousedown = 'mousedown.grouping' + this.element.id;
                var mouseup = 'mouseup.grouping' + this.element.id;
                this.removeHandler($(document), mousemove);
                this.removeHandler($(document), mousedown);
                this.removeHandler($(document), mouseup);
            }
            if (this.columnsreorder) {
                var mousemove = 'mousemove.reorder' + this.element.id;
                var mousedown = 'mousedown.reorder' + this.element.id;
                var mouseup = 'mouseup.reorder' + this.element.id;
                this.removeHandler($(document), mousemove);
                this.removeHandler($(document), mousedown);
                this.removeHandler($(document), mouseup);
                delete this.columnsbounds;
            }

            if (this.content) {
                this.removeHandler(this.content, 'mousedown');
                this.removeHandler(this.content, 'scroll');
            }

    
            this._removeHandlers();
            this.hScrollInstance.destroy();
            this.vScrollInstance.destroy();
            this.hScrollBar.remove();
            this.vScrollBar.remove();
            this._clearcaches();
            delete this.hScrollInstance;
            delete this.vScrollInstance;
            delete this.visiblerows;
            delete this.hittestinfo;
            delete this.rows;
            delete this.columns;
            delete this.columnsbydatafield;
            delete this.pagescache;
            delete this.pageviews;
            delete this.cellscache;
            delete this.heights;
            delete this.hiddens;
            delete this.hiddenboundrows;
            delete this.heightboundrows;
            delete this.detailboundrows;
            delete this.details;
            delete this.expandedgroups;
            delete this._rowdetailscache;
            delete this._rowdetailselementscache;
            delete this.columnsmenu;
            this.columnsheader.remove();
            delete this.columnsheader;
            this.selectionarea.remove();
            delete this.selectionarea;
            if (this.menuitemsarray && this.menuitemsarray.length) {
                var itemslength = this.menuitemsarray.length;
                for (var i = 0; i < itemslength; i++) {
                    $(this.menuitemsarray[i]).remove();
                }
            }
            delete this.menuitemsarray;

            this.dataview._clearcaches();
            this.content.removeClass();
            this.content.remove();
            this.content = null;
            delete this.content;
            this.vScrollBar = null;
            this.hScrollBar = null;
            delete this.hScrollBar;
            delete this.hScrollBar;
            this.gridcontent.remove();
            delete this.gridcontent;

            if (this.gridmenu) {
                this.gridmenu = null;
                delete this.gridmenu;
            }

            delete this._mousemovefunc;
            delete this._mousewheelfunc;

            this.dataview.destroy();
            delete this.dataview;
            
            this.bottomRight.remove();
            delete this.bottomRight;

            this.wrapper.remove();
            delete this.wrapper;

            if (this.pagerdiv) {
                this.pagerdiv.remove();
                delete this.pagerdiv;
            }
            if (this.pagerpageinput) {
                this.pagerpageinput.remove();
                delete this.pagerpageinput;
            }
            if (this.pagergoto) {
                this.pagergoto.remove();
                delete this.pagergoto;
            }
            if (this.pagershowrows) {
                this.pagershowrows.remove();
                delete this.pagershowrows;
            }
            if (this.pagerfirstbutton) {
                this.pagerfirstbutton.remove();
                delete this.pagerfirstbutton;
            }
            if (this.pagerlastbutton) {
                this.pagerlastbutton.remove();
                delete this.pagerlastbutton;
            }
            if (this.pagerbuttons) {
                this.pagerbuttons.remove();
                delete this.pagerbuttons;
            }
            if (this.pagerdetails) {
                this.pagerdetails.remove();
                delete this.pagerdetails;
            }
            if (this.pagergotoinput) {
                this.pagergotoinput.remove();
                delete this.pagergotoinput;
            }

            this.pager.remove();
            delete this.pager;

            this.groupsheader.remove();
            delete this.groupsheader;

            this.dataloadelement.remove();
            delete this.dataloadelement;

            this.toolbar.remove();
            delete this.toolbar;

            this.statusbar.remove();
            delete this.statusbar;

            this.host.removeData();
            this.host.removeClass();
            this.host.remove();
            this.host = null;
            delete this.host;
            delete this.element;
            delete this.set;
            delete this.get;
            delete this.that;
            delete this.call;
        },

        _initializeColumns: function () {
            var datafields = this.source ? this.source.datafields : null;
            if (datafields == null && this.source && this.source._source) {
                datafields = this.source._source.datafields;
            }
            var hasfields = datafields ? datafields.length > 0 : false;
            if (this.autogeneratecolumns) {
                var cols = new Array();
                if (datafields) {
                    $.each(datafields, function () {
                        var column = { datafield: this.name, text: this.text || this.name, cellsformat: this.format || "" };
                        cols.push(column);
                    });
                }
                else {
                    if (this.source.records.length > 0) {
                        var row = this.source.records[0];
                        for (obj in row) {
                            if (obj != "uid") {
                                var column = {width: 100, datafield: obj, text: obj};
                                cols.push(column);
                            }
                        }
                    }
                }
                this.columns = cols;
            }

            if (this.columns && this.columns.records) {
                for (var i = 0; i < this.columns.records.length; i++) {
                    this._removecolumnhandlers(this.columns.records[i]);
                }
            }
            var me = this.that;
            var _columns = new $.jqx.collection(this.element);
            var visibleindex = 0;
            this._haspinned = false;
            if (!this._columns) {
                this._columns = this.columns;
            }
            else {
                this.columns = this._columns;
            }

            if (this.groupable) {
                $.each(this.groups, function (index) {
                    var column = new jqxGridColumn(me, this);
                    column.visibleindex = visibleindex++;
                    column.width = me.groupindentwidth;
                    _columns.add(column);
                    column.grouped = true;
                    column.filterable = false;
                    column.sortable = false;
                    column.editable = false;
                    column.resizable = false;
                    column.draggable = false;
                });
            }

            if (this.rowdetails && this.showrowdetailscolumn) {
                var column = new jqxGridColumn(me, this);
                column.visibleindex = visibleindex++;
                column.width = me.groupindentwidth;
                column.pinned = true;
                column.editable = false;
                column.filterable = false;
                column.draggable = false;
                column.groupable = false;
                column.resizable = false;
                _columns.add(column);
                me._haspinned = true;
            }

            if (this.selectionmode == "checkbox") {
                var column = new jqxGridColumn(me, this);
                column.visibleindex = visibleindex++;
                column.width = me.groupindentwidth;
                column.checkboxcolumn = true;
                column.editable = false;
                column.columntype = 'checkbox';
                column.groupable = false;
                column.draggable = false;
                column.filterable = false;
                column.resizable = false;
                column.datafield = "_checkboxcolumn";
                _columns.add(column);
            }

            var keys = new Array();
            $.each(this.columns, function (index) {
                if (me.columns[index] != undefined) {
                    var column = new jqxGridColumn(me, this);
                    column.visibleindex = visibleindex++;
                    if (this.dataField != undefined) {
                        this.datafield = this.dataField;
                    }
                    if (this.pinned) {
                        me._haspinned = true;
                    }

                    if (this.datafield == null) {
                        if (me.source && me.source._source && (me.source._source.datatype == 'array')) {
                            if (!hasfields) {
                                if (!me.source._source.datafields) {
                                    me.source._source.datafields = new Array();
                                    me.source._source.datafields.push({ name: index.toString() });
                                }
                                else {
                                    me.source._source.datafields.push({ name: index.toString() });
                                }
                            }
                            this.datafield = index.toString();
                            this.displayfield = index.toString();
                            column.datafield = this.datafield;
                            column.displayfield = this.displayfield;
                      
                        }
                    }
                    else {
                        if (keys[this.datafield]) {
                            throw new Error("jqxGrid: Invalid column 'datafield' setting. jqxGrid's columns should be initialized with unique data fields.");
                            me.host.remove();
                            return false;
                        }
                        else {
                            keys[this.datafield] = true;
                        }
                    }
                    _columns.add(column);
                }
            });

            if (this.rtl) _columns.records.reverse();
            this.columns = _columns;
        },

        _initializeRows: function () {
            var _rows = new $.jqx.collection(this.element);
            if (this.rows) {
                this.rows.clear();
            }
            this.rows = _rows;
        },

        _raiseEvent: function (id, arg) {
            if (arg == undefined)
                arg = { owner: null };

            if (this._trigger === false)
                return;

            var evt = this.events[id];
            if (!this._camelCase) {
                evt = evt.toLowerCase();
            }

            args = arg;
            args.owner = this;

            var event = new jQuery.Event(evt);
            event.owner = this;
            event.args = args;
            var result = this.host.trigger(event);

            // save the new event arguments.
            arg = event.args;
            return result;
        },

        // performs mouse wheel.
        wheel: function (event, self) {
            if (self.autoheight && self.hScrollBar.css('visibility') != 'visible') {
                event.returnValue = true;
                return true;
            }

            var delta = 0;
            if (!event) /* For IE. */
                event = window.event;

            if (event.originalEvent && event.originalEvent.wheelDelta) {
                event.wheelDelta = event.originalEvent.wheelDelta;
            }

            if (event.wheelDelta) { /* IE/Opera. */
                delta = event.wheelDelta / 120;
            } else if (event.detail) { /** Mozilla case. */
                delta = -event.detail / 3;
            }

            if (delta) {
                var result = self._handleDelta(delta);
                if (result) {
                    if (event.preventDefault)
                        event.preventDefault();

                    if (event.originalEvent != null) {
                        event.originalEvent.mouseHandled = true;
                    }

                    if (event.stopPropagation != undefined) {
                        event.stopPropagation();
                    }
                }

                if (result) {
                    result = false;
                    event.returnValue = result;
                    return result;
                }
                else {
                    return false;
                }
            }

            if (event.preventDefault)
                event.preventDefault();
            event.returnValue = false;
        },

        _handleDelta: function (delta) {
            if (this.vScrollBar.css('visibility') != 'hidden') {
                var oldvalue = this.vScrollInstance.value;
                if (delta < 0) {
                    this.scrollDown();
                }
                else this.scrollUp();
                var newvalue = this.vScrollInstance.value;
                if (oldvalue != newvalue) {
                    return true;
                }
            }
            else if (this.hScrollBar.css('visibility') != 'hidden') {
                var oldvalue = this.hScrollInstance.value;
                if (delta > 0) {
                    if (this.hScrollInstance.value > 2 * this.horizontalscrollbarstep) {
                        this.hScrollInstance.setPosition(this.hScrollInstance.value - 2 * this.horizontalscrollbarstep);
                    }
                    else {
                        this.hScrollInstance.setPosition(0);
                    }
                }
                else {
                    if (this.hScrollInstance.value < this.hScrollInstance.max) {
                        this.hScrollInstance.setPosition(this.hScrollInstance.value + 2 * this.horizontalscrollbarstep);
                    }
                    else this.hScrollInstance.setPosition(this.hScrollInstance.max);

                }
                var newvalue = this.hScrollInstance.value;
                if (oldvalue != newvalue) {
                    return true;
                }
            }

            return false;
        },

        // scrolls down.
        scrollDown: function () {
            if (this.vScrollBar.css('visibility') == 'hidden')
                return;

            var vScrollInstance = this.vScrollInstance;
            if (vScrollInstance.value + this.rowsheight <= vScrollInstance.max) {
                vScrollInstance.setPosition(parseInt(vScrollInstance.value) + this.rowsheight);
            }
            else vScrollInstance.setPosition(vScrollInstance.max);
        },

        // scrolls up.
        scrollUp: function () {
            if (this.vScrollBar.css('visibility') == 'hidden')
                return;

            var vScrollInstance = this.vScrollInstance;
            if (vScrollInstance.value - this.rowsheight >= vScrollInstance.min) {
                vScrollInstance.setPosition(parseInt(vScrollInstance.value) - this.rowsheight);
            }
            else vScrollInstance.setPosition(vScrollInstance.min);
        },

        _removeHandlers: function () {
            var self = this.that;
            this.removeHandler(this.vScrollBar, 'valuechanged');
            this.removeHandler(this.hScrollBar, 'valuechanged');
            this.vScrollInstance.valuechanged = null;
            this.hScrollInstance.valuechanged = null;

            var eventname = 'mousedown.jqxgrid';

            if (this.isTouchDevice()) {
                eventname = $.jqx.mobile.getTouchEventName('touchend');
            }

            this.removeHandler(this.host, 'dblclick.jqxgrid');
            this.removeHandler(this.host, eventname);
            this.removeHandler(this.content, 'mousemove', this._mousemovefunc);
            this.removeHandler(this.host, 'mouseleave.jqxgrid');
            this.removeHandler(this.content, 'mouseenter');
            this.removeHandler(this.content, 'mouseleave');
            this.removeHandler(this.content, 'mousedown');
            this.removeHandler(this.content, 'scroll');
            this.removeHandler(this.content, 'selectstart.' + this.element.id);
            this.removeHandler(this.host, 'dragstart.' + this.element.id);
            this.removeHandler(this.host, 'keydown.edit' + this.element.id);
            this.removeHandler($(document), 'keydown.edit' + this.element.id);
            this.removeHandler($(document), 'keyup.edit' + this.element.id);
            if (this._mousemovedocumentfunc) {
                this.removeHandler($(document), 'mousemove.selection' + this.element.id, this._mousemovedocumentfunc);
            }
            this.removeHandler($(document), 'mouseup.selection' + this.element.id);
            if (this._mousewheelfunc) {
                this.removeHandler(this.host, 'mousewheel', this._mousewheelfunc);
            }
            if (this.editable) {
                this.removeHandler($(document), 'mousedown.gridedit' + this.element.id);
            }
            if (this.host.off) {
                this.content.off('mousemove');
                this.host.off('mousewheel');
            }

        },

        _addHandlers: function () {
            var self = this.that;
            var isTouch = self.isTouchDevice();
            if (!isTouch) {
                this.addHandler(this.host, 'dragstart.' + this.element.id, function (event) {
                    return false;
                });
            }

            if (this.editable) {
                this.addHandler($(document), 'mousedown.gridedit' + this.element.id, function (event) {
                    if (self.editable && self.begincelledit) {
                        if (self.editcell) {
                            if (!self.vScrollInstance.isScrolling() && !self.vScrollInstance.isScrolling()) {
                                var gridOffset = self.host.coord();
                                var gridWidth = self.host.width();
                                var gridHeight = self.host.height();
                                var close = false;
                                var yclose = false;
                                var xclose = false;
                                if (event.pageY < gridOffset.top || event.pageY > gridOffset.top + gridHeight) {
                                    close = true;
                                    yclose = true;
                                }
                                if (event.pageX < gridOffset.left || event.pageX > gridOffset.left + gridWidth) {
                                    close = true;
                                    xclose = true;
                                }

                                if (close) {
                                    var stopPropagation = false;
                                    if (self.editcell && self.editcell.editor) {
                                        switch (self.editcell.columntype) {
                                            case "datetimeinput":
                                                if (self.editcell.editor.jqxDateTimeInput && self.editcell.editor.jqxDateTimeInput('container')[0].style.display == 'block') {
                                                    var top = self.editcell.editor.jqxDateTimeInput('container').coord().top;
                                                    var bottom = self.editcell.editor.jqxDateTimeInput('container').coord().top + self.editcell.editor.jqxDateTimeInput('container').height();
                                                    if (yclose && (event.pageY < top || event.pageY > bottom)) {
                                                        close = true;
                                                        self.editcell.editor.jqxDateTimeInput('close');
                                                    }
                                                    else {
                                                        return;
                                                    }
                                                }
                                                break;
                                            case "combobox":
                                                if (self.editcell.editor.jqxComboBox && self.editcell.editor.jqxComboBox('container')[0].style.display == 'block') {
                                                    var top = self.editcell.editor.jqxComboBox('container').coord().top;
                                                    var bottom = self.editcell.editor.jqxComboBox('container').coord().top + self.editcell.editor.jqxComboBox('container').height();
                                                    if (yclose && (event.pageY < top || event.pageY > bottom)) {
                                                        close = true;
                                                        self.editcell.editor.jqxComboBox('close');
                                                    }
                                                    else {
                                                        return;
                                                    }
                                                }
                                                break;
                                            case "dropdownlist":
                                                if (self.editcell.editor.jqxDropDownList && self.editcell.editor.jqxDropDownList('container')[0].style.display == 'block') {
                                                    var top = self.editcell.editor.jqxDropDownList('container').coord().top;
                                                    var bottom = self.editcell.editor.jqxDropDownList('container').coord().top + self.editcell.editor.jqxDropDownList('container').height();
                                                    if (yclose && (event.pageY < top || event.pageY > bottom)) {
                                                        close = true;
                                                        self.editcell.editor.jqxDropDownList('close');
                                                    }
                                                    else {
                                                        return;
                                                    }
                                                }
                                                break;
                                            case "template":
                                            case "custom":
                                                var editorType = ['jqxDropDownList', 'jqxComboBox', 'jqxDropDownButton', 'jqxDateTimeInput'];
                                                var testEditorType = function (type) {
                                                    var editorData = self.editcell.editor.data();
                                                    if (editorData[type] && editorData[type].instance.container && editorData[type].instance.container[0].style.display == 'block') {
                                                        var instance = editorData[type].instance;
                                                        var top = instance.container.coord().top;
                                                        var bottom = instance.container.coord().top + instance.container.height();
                                                        if (yclose && (event.pageY < top || event.pageY > bottom)) {
                                                            close = true;
                                                            instance.close();
                                                            return true;
                                                        }
                                                        else {
                                                            return false;
                                                        }
                                                    }
                                                }
                                                for (var i = 0; i < editorType.length; i++) {
                                                    var result = testEditorType(editorType[i]);
                                                    if (result == false) return;
                                                }
                                                break;
                                        }
                                    }
                                    self.endcelledit(self.editcell.row, self.editcell.column, false, true);
                                }
                            }
                        }
                    }
                });
            }

            this.vScrollInstance.valuechanged = function (params) {
                if (self.virtualsizeinfo) {
                    self._closemenu();
                    if (self.scrollmode != 'physical') {
                        self._renderrows(self.virtualsizeinfo);
                        self.currentScrollValue = params.currentValue;
                    }
                    else {
                        if (self.currentScrollValue != undefined && Math.abs(self.currentScrollValue - params.currentValue) >= 5) {
                            self._renderrows(self.virtualsizeinfo);
                            self.currentScrollValue = params.currentValue;
                        }
                        else {
                            self._renderrows(self.virtualsizeinfo);
                            self.currentScrollValue = params.currentValue;
                        }
                    }

                    if (!self.pageable && !self.groupable && self.dataview.virtualmode) {
                        if (self.loadondemandupdate) {
                            clearTimeout(self.loadondemandupdate);
                        }

                        self.loadondemandupdate = setTimeout(function () {
                            self.loadondemand = true;
                            self._renderrows(self.virtualsizeinfo);
                        }, 100);
                    }
                    if (isTouch) {
                        self._lastScroll = new Date();
                    }
                }
            }

            this.hScrollInstance.valuechanged = function (params) {
                if (self.virtualsizeinfo) {
                    self._closemenu();
                    var doHScroll = function () {
                        self._renderhorizontalscroll();
                        self._renderrows(self.virtualsizeinfo);
                        if (self.editcell && !self.editrow) {
                            if (self._showcelleditor && self.editcell.editing) {
                                if (!self.hScrollInstance.isScrolling()) {
                                    self._showcelleditor(self.editcell.row, self.getcolumn(self.editcell.column), self.editcell.element, self.editcell.init);
                                }
                            }
                        }
                    }

                    var ie10 = self._browser == undefined ? self._isIE10() : self._browser;
                    if (navigator && navigator.userAgent.indexOf('Safari') != -1) {
                        if (self._hScrollTimer) clearTimeout(self._hScrollTimer);
                        self._hScrollTimer = setTimeout(function () {
                            doHScroll();
                        }, 1);
                    }
                    else if ($.jqx.browser.mozilla || $.jqx.browser.msie) {
                        if (self._hScrollTimer) clearTimeout(self._hScrollTimer);
                        self._hScrollTimer = setTimeout(function () {
                            doHScroll();
                        }, 0.01);
                    }
                    else {
                        doHScroll();
                    }

                    if (isTouch) {
                        self._lastScroll = new Date();
                    }
                }
            }

            this._mousewheelfunc = this._mousewheelfunc || function (event) {
                if (!self.editcell && self.enablemousewheel) {
                    self.wheel(event, self);
                    return false;
                }
            };

            this.removeHandler(this.host, 'mousewheel', this._mousewheelfunc);
            this.addHandler(this.host, 'mousewheel', this._mousewheelfunc);

            var eventname = 'mousedown.jqxgrid';

            if (isTouch) {
                eventname = $.jqx.mobile.getTouchEventName('touchend');
            }

            this.addHandler(this.host, eventname, function (event) {
                if (self.isTouchDevice()) {
                    self._newScroll = new Date();
                    if (self._newScroll - self._lastScroll < 500) {
                        return false;
                    }
                    if ($(event.target).ischildof(self.vScrollBar)) {
                        return false;
                    }
                    if ($(event.target).ischildof(self.hScrollBar)) {
                        return false;
                    }
                }
                self._mousedown = new Date();
                var result = self._handlemousedown(event, self);
                if (self.isNestedGrid) {
                    if (!self.resizablecolumn && !self.columnsreorder) {
                        event.stopPropagation();
                    }
                }

                self._lastmousedown = new Date();
                return result;
            });

            if (!isTouch) {
                this.addHandler(this.host, 'dblclick.jqxgrid', function (event) {
                    if (self.editable && self.begincelledit && self.editmode == 'dblclick') {
                        self._handledblclick(event, self);
                    }
                    else if ($.jqx.browser.msie && $.jqx.browser.version < 9) {
                        var result = self._handlemousedown(event, self);
                    }

                    self.mousecaptured = false;
                    self._lastmousedown = new Date();
                    return true;
                });

                this._mousemovefunc = function (event) {
                    if (self._handlemousemove) {
                        return self._handlemousemove(event, self);
                    };
                }

                this.addHandler(this.content, 'mousemove', this._mousemovefunc);

                if (self._handlemousemoveselection) {
                    this._mousemovedocumentfunc = function (event) {
                        if (self._handlemousemoveselection) {
                            return self._handlemousemoveselection(event, self);
                        };
                    }

                    this.addHandler($(document), 'mousemove.selection' + this.element.id, this._mousemovedocumentfunc);
                }
                     
                this.addHandler($(document), 'mouseup.selection' + this.element.id, function (event) {
                    if (self._handlemouseupselection) {
                        self._handlemouseupselection(event, self);
                    }
                });
            }

            try
            {
                if (document.referrer != "" || window.frameElement) {
                    if (window.top != null && window.top != window.self) {
                        var parentLocation = null;

                        if (window.parent && document.referrer) {
                            parentLocation = document.referrer;
                        }

                        if (parentLocation && parentLocation.indexOf(document.location.host) != -1) {
                            var eventHandle = function (event) {
                                if (self._handlemouseupselection) {
                                    self._handlemouseupselection(event, self);
                                }
                            };

                            if (window.top.document.addEventListener) {
                                window.top.document.addEventListener('mouseup', eventHandle, false);

                            } else if (window.top.document.attachEvent) {
                                window.top.document.attachEvent("on" + 'mouseup', eventHandle);
                            }
                        }
                    }
                }
            }
            catch (error) {
            }

            this.focused = false;

            if (!isTouch) {
                this.addHandler(this.content, 'mouseenter', function (event) {
                    self.focused = true;

                    if (self.wrapper) {
                        self.wrapper.parent().attr('tabindex', 0);
                        self.wrapper.attr('tabindex', 1);
                        self.content.attr('tabindex', 2);
                    }

                    if (self._overlayElement) {
                        if (self.vScrollInstance.isScrolling() || self.hScrollInstance.isScrolling()) {
                            self._overlayElement[0].style.visibility = 'visible';
                        }
                        else {
                            self._overlayElement[0].style.visibility = 'hidden';
                        }
                    }
                });

                this.addHandler(this.content, 'mouseleave', function (event) {
                    if (self.wrapper) {
                        self.wrapper.parent().removeAttr('tabindex');
                        self.wrapper.removeAttr('tabindex');
                        self.content.removeAttr('tabindex');
                    }

                    if (self._handlemousemove) {
                        if (self.enablehover) {
                            self._clearhoverstyle();
                        }
                    }
                    if (self._overlayElement) {
                        self._overlayElement[0].style.visibility = 'hidden';
                    }
                    self.focused = false;
                });

                if (this.groupable || this.columnsreorder) {
                    this.addHandler($(document), 'selectstart.' + this.element.id, function (event) {
                        if (self.__drag === true) {
                            return false;
                        }
                    });
                }

                this.addHandler(this.content, 'selectstart.' + this.element.id, function (event) {
                    if (self.enablebrowserselection) {
                        return true;
                    }

                    if (self.showfilterrow) {
                        if ($(event.target).ischildof(self.filterrow))
                            return true;
                    }

                    if (!self.editcell) {
                        return false;
                    }
                });

                this.addHandler($(document), 'keyup.edit' + this.element.id, function (event) {
                    self._keydown = false;
                });

                this.addHandler($(document), 'keydown.edit' + this.element.id, function (event) {
                    self._keydown = true && !self.editcell;
                    var key = event.charCode ? event.charCode : event.keyCode ? event.keyCode : 0;
                    if (self.handlekeyboardnavigation) {
                        var handled = self.handlekeyboardnavigation(event);
                        if (handled == true)
                            return false;
                    }

                    if (self.editable && self.editcell) {
                        if (key == 13 || key == 27) {
                            if (self._handleeditkeydown) {
                                result = self._handleeditkeydown(event, self);
                            }
                        }
                    }
                    if (key == 27) {
                        self.mousecaptured = false;
                        if (self.selectionarea.css('visibility') == 'visible') {
                            self.selectionarea.css('visibility', 'hidden');
                        }
                    }
                    if ($.jqx.browser.msie && $.jqx.browser.version < 8 && self.focused && !self.isNestedGrid) {
                        if (key == 13 && result == false) {
                            return result;
                        }

                        var result = true;
                        var key = event.charCode ? event.charCode : event.keyCode ? event.keyCode : 0;
                        if (!self.editcell && self.editable && self.editmode != 'programmatic') {
                            if (self._handleeditkeydown) {
                                result = self._handleeditkeydown(event, self);
                            }
                        }
                        if (result && self.keyboardnavigation && self._handlekeydown) {
                            result = self._handlekeydown(event, self);
                            if (!result) {
                                if (event.preventDefault)
                                    event.preventDefault();

                                if (event.stopPropagation != undefined) {
                                    event.stopPropagation();
                                }
                            }
                            return result;
                        }
                    }

                    return true;
                });

                this.addHandler(this.host, 'keydown.edit' + this.element.id, function (event) {
                    var result = true;
                    if (self.handlekeyboardnavigation) {
                        var handled = self.handlekeyboardnavigation(event);
                        if (handled == true) {
                            return false;
                        }
                    }

                    if (self.editable && self.editmode != 'programmatic') {
                        if (self._handleeditkeydown) {
                            result = self._handleeditkeydown(event, self);
                        }
                    }
                    if (!($.jqx.browser.msie && $.jqx.browser.version < 8)) {
                        if (result && self.keyboardnavigation && self._handlekeydown) {
                            result = self._handlekeydown(event, self);
                            if (self.isNestedGrid) {
                                event.stopPropagation();
                            }
                        }
                    }
                    else if (self.isNestedGrid) {
                        if (result && self.keyboardnavigation && self._handlekeydown) {
                            result = self._handlekeydown(event, self);
                            event.stopPropagation();
                        }
                    }

                    if (!result) {
                        if (event.preventDefault)
                            event.preventDefault();

                        if (event.stopPropagation != undefined) {
                            event.stopPropagation();
                        }
                    }
                    return result;
                });
            }
        },

        _hittestrow: function (x, y) {
            if (this.vScrollInstance == null || this.hScrollInstance == null)
                return;

            if (x == undefined) x = 0;
            if (y == undefined) y == 0;

            var vScrollInstance = this.vScrollInstance;
            var hScrollInstance = this.hScrollInstance;
            var verticalscrollvalue = vScrollInstance.value;
            if (this.vScrollBar.css('visibility') != 'visible') {
                verticalscrollvalue = 0;
            }
            var horizontalscrollvalue = hScrollInstance.value;
            if (this.hScrollBar.css('visibility') != 'visible') {
                horizontalscrollvalue = 0;
            }

            if (this.scrollmode == 'deferred' && this._newmax != null) {
                if (verticalscrollvalue > this._newmax) verticalscrollvalue = this._newmax;
            }

            var top = parseInt(verticalscrollvalue) + y;
            var left = parseInt(horizontalscrollvalue) + x;

            if (this.visiblerows == null) {
                return;
            }
            var details = false;
            var hitIndex = this._findvisiblerow(top, this.visiblerows);
            if (hitIndex >= 0) {
                var hitRow = this.visiblerows[hitIndex];
                var hasdetails = this.rowdetails && hitRow.rowdetails;
                var showdetails = !hitRow.rowdetailshidden;
                if (hasdetails) {
                    var prevRow = this.visiblerows[hitIndex - 1];
                    if (prevRow == hitRow) {
                        hitRow = prevRow;
                        hitIndex--;
                    }

                    if (showdetails) {
                        var rowstop = $(this.hittestinfo[hitIndex].visualrow).position().top + parseInt(this.table.css('top'));
                        var rowsheight = $(this.hittestinfo[hitIndex].visualrow).height();
                        if (!(y >= rowstop && y <= rowstop + rowsheight)) {
                            hitIndex++;
                            hitRow = this.visiblerows[hitIndex];
                            details = true;
                        }
                    }
                }
            }
            return { index: hitIndex, row: hitRow, details: details };
        },

        getcellatposition: function (left, top) {
            var self = this.that;
            var columnheaderheight = this.showheader ? this.columnsheader.height() + 2 : 0;
            var groupsheaderheight = this._groupsheader() ? this.groupsheader.height() : 0;
            var toolbarheight = this.showtoolbar ? this.toolbarheight : 0;
            groupsheaderheight += toolbarheight;

            var hostoffset = this.host.coord();
            if (this.hasTransform) {
                hostoffset = $.jqx.utilities.getOffset(this.host);
            }
            var x = left - hostoffset.left;
            var y = top - columnheaderheight - hostoffset.top - groupsheaderheight;
            var rowinfo = this._hittestrow(x, y);
            var row = rowinfo.row;
            var index = rowinfo.index;
            var tablerow = this.table[0].rows[index];

            if (this.dataview && this.dataview.records.length == 0) {
                var rows = this.table[0].rows;
                var rowY = 0;
                for (var i = 0; i < rows.length; i++) {
                    if (y >= rowY && y < rowY + this.rowsheight) {
                        tablerow = rows[i];
                        break;
                    }
                    rowY += this.rowsheight;
                }
                row = { boundindex: i };
            }

            if (tablerow == null)
                return true;

            var hScrollInstance = this.hScrollInstance;
            var horizontalscrollvalue = hScrollInstance.value;
            var cellindex = 0;
            var groupslength = this.groupable ? this.groups.length : 0;

            for (var i = 0; i < tablerow.cells.length; i++) {
                var columnleft = parseInt($(this.columnsrow[0].cells[i]).css('left'));
                var left = columnleft - horizontalscrollvalue;
                if (self.columns.records[i].pinned) {
                    left = columnleft;
                }

                var right = left + $(this.columnsrow[0].cells[i]).width();
                if (right >= x && x >= left) {
                    cellindex = i;
                    break;
                }
            }

            if (row != null) {
                var column = this._getcolumnat(cellindex);
                return { row: this.getboundindex(row), column: column.datafield, value: this.getcellvalue(this.getboundindex(row), column.datafield) };
            }

            return null;
        },

        _handlemousedown: function (event, self) {
            if (event.target == null) {
                return true;
            }

            if (self.disabled) {
                return true;
            }

            if ($(event.target).ischildof(this.columnsheader)) {
                return true;
            }

            var rightclick;
            if (event.which) rightclick = (event.which == 3);
            else if (event.button) rightclick = (event.button == 2);

            var middleclick;
            if (event.which) middleclick = (event.which == 2);
            else if (event.button) middleclick = (event.button == 1);

            if (middleclick) {
                return true;
            }

            if (this.showstatusbar) {
                if ($(event.target).ischildof(this.statusbar))
                    return true;
                if (event.target == this.statusbar[0])
                    return true;
            }

            if (!this.columnsheader) return true;

            var columnheaderheight = this.showheader ? this.columnsheader.height() + 2 : 0;
            var groupsheaderheight = this._groupsheader() ? this.groupsheader.height() : 0;
            var toolbarheight = this.showtoolbar ? this.toolbarheight : 0;
            groupsheaderheight += toolbarheight;

            var hostoffset = this.host.coord();
            if (this.hasTransform) {
                hostoffset = $.jqx.utilities.getOffset(this.host);
                var bodyOffset = this._getBodyOffset();
                hostoffset.left -= bodyOffset.left;
                hostoffset.top -= bodyOffset.top;
            }
        
            var left = parseInt(event.pageX);
            var top = parseInt(event.pageY);

            if (this.isTouchDevice()) {
                var touches = self.getTouches(event);
                var touch = touches[0];
                left = parseInt(touch.pageX);
                top = parseInt(touch.pageY);
                if (self.touchmode == true) {
                    left = parseInt(touch._pageX);
                    top = parseInt(touch._pageY);
                }
            }
            var x = left - hostoffset.left;
            var y = top - columnheaderheight - hostoffset.top - groupsheaderheight;
            if (this.pageable && !this.autoheight && this.gotopage) {
                var pagerposition = this.pager.coord().top - hostoffset.top - groupsheaderheight - columnheaderheight;
                if (y > pagerposition) {
                    return;
                }
            }
            var rowinfo = this._hittestrow(x, y);
            if (!rowinfo)
                return;

            if (rowinfo.details)
                return;

            var row = rowinfo.row;
            var index = rowinfo.index;
            var targetclassname = event.target.className;
            var tablerow = this.table[0].rows[index];
            if (tablerow == null) {
                if (self.editable && self.begincelledit) {
                    if (self.editcell) {
                        self.endcelledit(self.editcell.row, self.editcell.column, false, true);
                    }
                }
                return true;
            }

            self.mousecaptured = true;
            self.mousecaptureposition = { left: event.pageX, top: event.pageY - groupsheaderheight, clickedrow: tablerow };

            var hScrollInstance = this.hScrollInstance;
            var horizontalscrollvalue = hScrollInstance.value;
            if (this.rtl) {
                if (this.hScrollBar.css('visibility') != 'hidden') {
                    horizontalscrollvalue = hScrollInstance.max - hScrollInstance.value;
                }
            }

            var cellindex = -1;
            var groupslength = this.groupable ? this.groups.length : 0;
            if (this.rtl) {
                if (this.vScrollBar[0].style.visibility != 'hidden') {
                    horizontalscrollvalue -= this.scrollbarsize + 4;
                }
                if (this.hScrollBar[0].style.visibility == 'hidden') {
                    horizontalscrollvalue = -parseInt(this.content.css('left'));
                }
            }

            for (var i = 0; i < tablerow.cells.length; i++) {
                var columnleft = parseInt($(this.columnsrow[0].cells[i]).css('left'));
                var left = columnleft - horizontalscrollvalue;
                if (self.columns.records[i].pinned && !self.rtl) {
                    left = columnleft;
                }

                var column = this._getcolumnat(i);
                if (column != null && column.hidden) {
                    continue;
                }

                var right = left + $(this.columnsrow[0].cells[i]).width();
                if (right >= x && x >= left) {
                    cellindex = i;
                    self.mousecaptureposition.clickedcell = i;
                    break;
                }
            }

            if (this.rtl && this._haspinned) {
                for (var i = tablerow.cells.length-1; i >= 0; i--) {
                    if (!self.columns.records[i].pinned) break;

                    var columnleft = $(this.columnsrow[0].cells[i]).coord().left-this.host.coord().left;
                    var left = columnleft;
        
                    var column = this._getcolumnat(i);
                    if (column != null && column.hidden) {
                        continue;
                    }

                    var right = left + $(this.columnsrow[0].cells[i]).width();
                    if (right >= x && x >= left) {
                        cellindex = i;
                        self.mousecaptureposition.clickedcell = i;
                        break;
                    }
                }
            }

            if (row != null && cellindex >= 0) {
                this._raiseEvent(1, { rowindex: this.getboundindex(row), visibleindex: row.visibleindex, group: row.group, rightclick: rightclick, originalEvent: event });
                var column = this._getcolumnat(cellindex);
                var cellvalue = this.getcellvalue(this.getboundindex(row), column.datafield);
                if (this.editable && this.editcell) {
                    if (column.datafield == this.editcell.column) {
                        if (this.getboundindex(row) == this.editcell.row) {
                            this.mousecaptured = false;
                        }
                    }
                }

                this._raiseEvent(8, { rowindex: this.getboundindex(row), column: column ? column.getcolumnproperties() : null, datafield: column ? column.datafield : null, columnindex: cellindex, value: cellvalue, rightclick: rightclick, originalEvent: event });

                if (this.isTouchDevice()) {
                    if (column.columntype == 'checkbox' && this.editable && this._overlayElement) {
                        if (!this.editcell) {
                            this._overlayElement.css('visibility', 'hidden');
                            this.editcell = this.getcell(index, column.datafield);
                            return true;
                        }
                    }
                    else if (column.columntype == 'button' && this._overlayElement) {
                        //   this._overlayElement.css('visibility', 'hidden');
                        if (column.buttonclick) {
                            column.buttonclick(tablerow.cells[cellindex].buttonrow, event);
                        }
                        return true;
                    }
                }

                // handle double clicks.
                var _triggeredEvents = false;
                if (this._lastmousedown != null) {
                    if (this._mousedown - this._lastmousedown < 300) {
                        if (this._clickedrowindex == this.getboundindex(row)) {
                            this._raiseEvent(22, { rowindex: this.getboundindex(row), visibleindex: row.visibleindex, group: row.group, rightclick: rightclick, originalEvent: event });
                            if (this._clickedcolumn == column.datafield) {
                                this._raiseEvent(23, { rowindex: this.getboundindex(row), column: column ? column.getcolumnproperties() : null, datafield: column ? column.datafield : null, columnindex: cellindex, value: cellvalue, rightclick: rightclick, originalEvent: event });
                            }
                            _triggeredEvents = true;
                            this._clickedrowindex = -1;
                            this._clickedcolumn = null;
                            if (event.isPropagationStopped && event.isPropagationStopped()) {
                                return false;
                            }
                        }
                    }
                }

                if (rightclick) return true;

                if (!_triggeredEvents) {
                    this._clickedrowindex = this.getboundindex(row);
                    this._clickedcolumn = column.datafield;
                }
                // end of handle double clicks.

                var browserInfo = $.jqx.utilities.getBrowser();
                if (browserInfo.browser == 'msie' && parseInt(browserInfo.version) <= 7) {
                    if (cellindex == 0 && this.rowdetails) {
                        targetclassname = "jqx-grid-group-collapse";
                    }
                    if (groupslength > 0) {
                        if (cellindex <= groupslength) {
                            targetclassname = "jqx-grid-group-collapse";
                        }
                    }
                }

                if (targetclassname.indexOf('jqx-grid-group-expand') != -1 || targetclassname.indexOf('jqx-grid-group-collapse') != -1) {
                    if (!this.rtl) {
                        if (groupslength > 0 && cellindex < groupslength && this._togglegroupstate) {
                            this._togglegroupstate(row.bounddata, true);
                        }
                        else if (cellindex == groupslength && this.rowdetails && this.showrowdetailscolumn) {
                            this._togglerowdetails(row.bounddata, true);
                            this.gridcontent[0].scrollTop = 0;
                            this.gridcontent[0].scrollLeft = 0;
                        }
                    }
                    else {
                        if (groupslength > 0 && cellindex > tablerow.cells.length - groupslength - 1 && this._togglegroupstate) {
                            this._togglegroupstate(row.bounddata, true);
                        }
                        else if (cellindex == tablerow.cells.length - 1 - groupslength && this.rowdetails && this.showrowdetailscolumn) {
                            this._togglerowdetails(row.bounddata, true);
                            this.gridcontent[0].scrollTop = 0;
                            this.gridcontent[0].scrollLeft = 0;
                        }
                    }
                }
                else {
                    if (row.boundindex != -1) {
                        var oldselectedrowindexes = this.selectedrowindexes.slice(0);
                        var isoldcell = false;
                        if (self.selectionmode != 'none' && self.selectionmode != 'checkbox' && this._selectrowwithmouse) {
                            if (self.selectionmode == 'multiplecellsadvanced' || self.selectionmode == 'multiplecellsextended' || self.selectionmode == 'multiplerowsextended' || self.selectionmode == 'multiplerowsadvanced') {
                                if (!event.ctrlKey && !event.shiftKey) {
                                    self.selectedrowindexes = new Array();
                                    self.selectedcells = new Array();
                                }
                            }

                            var caneditrow = false;

                            var boundindex = this.getboundindex(row);
                            if (self._oldselectedrow === boundindex || self.selectionmode === "none") {
                                caneditrow = true;
                            }

                            if (self.selectionmode.indexOf('cell') == -1) {
                                if ((self.selectionmode != 'singlerow') || (self.selectedrowindex != boundindex && self.selectionmode == 'singlerow')) {
                                    this._applyrowselection(boundindex, true, false, null, column.datafield);
                                    this._selectrowwithmouse(self, rowinfo, oldselectedrowindexes, column.datafield, event.ctrlKey, event.shiftKey);
                                }
                            }
                            else {
                                if (column.datafield != null) {
                                    this._selectrowwithmouse(self, rowinfo, oldselectedrowindexes, column.datafield, event.ctrlKey, event.shiftKey);
                                    this._applycellselection(boundindex, column.datafield, true, false);
                                }
                            }

                            if (self._oldselectedcell) {
                                if (self._oldselectedcell.datafield == self.selectedcell.datafield && self._oldselectedcell.rowindex == self.selectedcell.rowindex) {
                                    isoldcell = true;
                                }
                            }
                            self._oldselectedcell = self.selectedcell;

                            self._oldselectedrow = boundindex;
                        }
                        if (self.autosavestate) {
                            if (self.savestate) self.savestate();
                        }
                        if (self.editable && self.begincelledit) {
                            if (event.isPropagationStopped && event.isPropagationStopped()) {
                                return false;
                            }

                            if (self.editmode == "selectedrow") {
                                if (caneditrow && !self.editcell) {
                                    if (column.columntype !== "checkbox") {
                                        var result = self.beginrowedit(this.getboundindex(row));
                                    }
                                }
                                else if (self.editcell && !caneditrow && self.selectionmode != "none") {
                                    var result = self.endrowedit(self.editcell.row);
                                }
                            }
                            else {
                                var canselect = self.editmode == 'click' || (isoldcell && self.editmode == 'selectedcell');
                                if (self.selectionmode.indexOf('cell') == -1) {
                                    if (self.editmode != 'dblclick') {
                                        canselect = true;
                                    }
                                }

                                if (canselect) {
                                    if (row.boundindex != undefined && column.editable) {
                                        var result = self.begincelledit(this.getboundindex(row), column.datafield, column.defaulteditorvalue);
                                    }
                                }

                                if (self.selectionmode.indexOf('cell') != -1) {
                                    if (self.editmode == 'selectedcell' && !isoldcell && self.editcell) {
                                        self.endcelledit(self.editcell.row, self.editcell.column, false, true);
                                    }
                                }
                            }
                            return true;
                        }
                    }
                }
            }
            return true;
        },

        _columnPropertyChanged: function (column, key, oldvalue, value) {
        },

        _rowPropertyChanged: function (row, key, oldvalue, value) {
        },

        _serializeObject: function (data) {
            if (data == null) return "";
            var str = "";
            $.each(data, function (index) {
                var val = this;
                if (index > 0) str += ', ';
                str += "[";
                var m = 0;
                for (obj in val) {
                    if (m > 0) str += ', ';
                    str += '{' + obj + ":" + val[obj] + '}';
                    m++;
                }
                str += "]";
            });
            return str;
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (this.isInitialized == undefined || this.isInitialized == false)
                return;

            key = key.toLowerCase();
            switch (key) {
                case "enablebrowserselection":
                    if (!object.showfilterrow) {
                        if (!object.showstatusbar && !object.showtoolbar) {
                            object.host.addClass('jqx-disableselect');
                        }
                        object.content.addClass('jqx-disableselect');
                    }

                    if (object.enablebrowserselection) {
                        object.content.removeClass('jqx-disableselect');
                        object.host.removeClass('jqx-disableselect');
                    }
                    break;
                case "columnsheight":
                    if (object.columnsheight != 25 || object.columngroups) {
                        object._measureElement('column');
                    }
                    object._render(true, true, true, false, false);
                    break;
                case "rowsheight":
                    if (value != oldvalue) {
                        if (object.rowsheight != 25) {
                            object._measureElement('cell');
                        }
                        object.virtualsizeinfo = null;
                        object.rendergridcontent(true, false);
                        object.refresh();
                    }
                    break;
                case "scrollMode":
                    object.vScrollInstance.thumbStep = object.rowsheight;
                    break;
                case "showdefaultloadelement":
                    object._builddataloadelement();
                    break;
                case "showfiltermenuitems":
                case "showsortmenuitems":
                case "showgroupmenuitems":
                case "filtermode":
                    object._initmenu();
                    break;
                case "touchmode":
                    if (oldvalue != value) {
                        object._removeHandlers();
                        object.touchDevice = null;
                        object.vScrollBar.jqxScrollBar({ touchMode: value });
                        object.hScrollBar.jqxScrollBar({ touchMode: value });
                        object._updateTouchScrolling();
                        object._arrange();
                        object._updatecolumnwidths();
                        object._updatecellwidths();

                        object._addHandlers();
                    }
                    break;
                case "autoshowcolumnsmenubutton":
                    if (oldvalue != value) {
                        object._rendercolumnheaders();
                    }
                    break;
                case "rendergridrows":
                    if (oldvalue != value) {
                        object.updatebounddata();
                    }
                    break;
                case "editmode":
                    if (oldvalue != value) {
                        object._removeHandlers();
                        object._addHandlers();
                    }
                    break;
                case "source":
                    object.virtualsizeinfo = null;
                    if (object.showfilterrow && object.filterable && object.filterrow) {
                        if (object.clearfilters) {
                            object.clearfilters(false);
                        }
                        object.filterrow.remove();
                        object._filterrowcache = new Array();
                        object.filterrow = null;
                    }
                    else if (object.filterable) {
                        if (object.clearfilters) {
                            object.clearfilters(false);
                        }
                    }


                    if (object.groupable) {
                        object.dataview.groups = [];
                        object.groups = [];
                    }

                    if (object.pageable) {
                        object.pagenum = 0;
                        object.dataview.pagenum = 0;
                    }
                    if (object.sortable) {
                        object.sortcolumn = null;
                        object.sortdirection = '';
                        object.dataview.sortfielddirection = "";
                        object.dataview.clearsortdata();
                    }

                    object.updatebounddata();
                    if (object.virtualmode && !object._loading) {
                        object.loadondemand = true;
                        object._renderrows(object.virtualsizeinfo);
                    }
                    break;
                case "horizontalscrollbarstep":
                case "verticalscrollbarstep":
                case "horizontalscrollbarlargestep":
                case "verticalscrollbarlargestep":
                    this.vScrollBar.jqxScrollBar({ step: this.verticalscrollbarstep, largestep: this.verticalscrollbarlargestep });
                    this.hScrollBar.jqxScrollBar({ step: this.horizontalscrollbarstep, largestep: this.horizontalscrollbarlargestep });
                    break;
                case "closeablegroups":
                    if (object._initgroupsheader) {
                        object._initgroupsheader();
                    }
                    break;
                case "showgroupsheader":
                    if (oldvalue != value) {
                        object.rendergridcontent();
                    }
                    break;
                case "theme":
                    if (value != oldvalue) {
                        if (object.pager) {
                            object.pager.removeClass();
                            object.pager.addClass(object.toTP('jqx-grid-pager'));
                            object.pager.addClass(object.toTP('jqx-widget-header'));
                            if (object.pageable && object._updatepagertheme) {
                                object._updatepagertheme();
                            }
                        }
                        if (object.groupsheader) {
                            object.groupsheader.removeClass();
                            object.groupsheader.addClass(object.toTP('jqx-grid-groups-header'));
                            object.groupsheader.addClass(object.toTP('jqx-widget-header'));
                        }
                        object.toolbar.removeClass();
                        object.toolbar.addClass(object.toTP('jqx-grid-toolbar'));
                        object.toolbar.addClass(object.toTP('jqx-widget-header'));
                        object.statusbar.removeClass();
                        object.statusbar.addClass(object.toTP('jqx-grid-statusbar'));
                        object.statusbar.addClass(object.toTP('jqx-widget-content'));
                        object.vScrollBar.jqxScrollBar({ theme: object.theme });
                        object.hScrollBar.jqxScrollBar({ theme: object.theme });
                        object.host.removeClass();
                        object.host.addClass(object.toTP('jqx-grid'));
                        object.host.addClass(object.toTP('jqx-reset'));
                        object.host.addClass(object.toTP('jqx-rc-all'));
                        object.host.addClass(object.toTP('jqx-widget'));
                        object.host.addClass(object.toTP('jqx-widget-content'));
                        object.bottomRight.removeClass();
                        object.bottomRight.addClass(object.toTP('jqx-grid-bottomright'));
                        object.toolbar.addClass(object.toTP('jqx-grid-toolbar'));
                        object.toolbar.addClass(object.toTP('jqx-widget-header'));
                        object.statusbar.addClass(object.toTP('jqx-grid-statusbar'));
                        object.statusbar.addClass(object.toTP('jqx-widget-header'));

                        object.render();
                    }
                    break;
                case "showtoolbar":
                case "toolbarheight":
                    if (oldvalue != value) {
                        object._arrange();
                        object.refresh();
                    }
                    break;
                case "showstatusbar":
                    if (oldvalue != value) {
                        if (object.statusbar) {
                            if (value) {
                                object.statusbar.show();
                            }
                            else {
                                object.statusbar.hide();
                            }
                        }

                        object._arrange();
                        object.refresh();
                    }
                    break;
                case "statusbarheight":
                    if (oldvalue != value) {
                        object._arrange();
                        object.refresh();
                    }
                    break;
                case "filterable":
                case "showfilterrow":
                    if (oldvalue != value) {
                        object.render();
                    }
                    break;
                case "autoshowfiltericon":
                case "showfiltercolumnbackground":
                case "showpinnedcolumnbackground":
                case "showsortcolumnbackground":
                    if (oldvalue != value) {
                        object.rendergridcontent();
                    }
                    break;
                case "showrowdetailscolumn":
                    if (oldvalue != value) {
                        object.render();
                    }
                    break;
                case "scrollbarsize":
                    if (oldvalue != value) {
                        object._arrange();
                    }
                    break;
                case "width":
                case "height":
                    if (oldvalue != value) {
                        object._updatesize(true, true);
                        object._resizeWindow();
                        if (object.virtualmode && !object._loading) {
                            object.vScrollInstance.setPosition(0);
                        }
                    }
                    break;
                case "altrows":
                case "altstart":
                case "altstep":
                    if (oldvalue != value) {
                        object._renderrows(object.virtualsizeinfo);
                    }
                    break;
                case "groupsheaderheight":
                    if (oldvalue != value) {
                        object._arrange();
                        if (object._initgroupsheader) {
                            object._initgroupsheader();
                        }
                    }
                    break;
                case "pagerheight":
                    if (oldvalue != value)
                        object._initpager();
                    break;
                case "selectedrowindex":
                    object.selectrow(value);
                    break;
                case "selectionmode":
                    if (oldvalue != value) {
                        if (value == 'none') {
                            object.selectedrowindexes = new Array();
                            object.selectedcells = new Array();
                            object.selectedrowindex = -1;
                        }
                        object._renderrows(object.virtualsizeinfo);
                    }
                    break;
                case "showheader":
                    if (value) {
                        object.columnsheader.css('display', 'block');
                    }
                    else {
                        object.columnsheader.css('display', 'none');
                    }
                    break;
                case "virtualmode":
                    if (oldvalue != value) {
                        object.dataview.virtualmode = object.virtualmode;
                        object.dataview.refresh(false);
                        object._render(false, false, false);
                    }
                    break;
                case "columnsmenu":
                    if (oldvalue != value) {
                        object.render();
                    }
                    break;
                case "columngroups":
                    object._render(true, true, true, false, false);
                    break;
                case "columns":
                    if (object._serializeObject(object._cachedcolumns) !== object._serializeObject(value)) {
                        object._columns = null;
                        object._filterrowcache = [];
                        object.render();
                        object._cachedcolumns = object.columns;        
                    }
                    else object._initializeColumns();
                    break;
                case "autoheight":
                    if (oldvalue != value) {
                        object._render(false, false, true);
                    }
                    break;
                case "pagermode":
                case "pagerbuttonscount":
                case "pagesizeoptions":
                case "pageable":
                case "pagesize":
                    if (oldvalue != value) {
                        if (object._loading) {
                            throw new Error( 'jqxGrid: ' + object.loadingerrormessage);
                            return;
                        }
                        if (!object.host.jqxDropDownList || !object.host.jqxListBox) {
                            object._testmodules();
                            return;
                        }

                        if (object._initpager) {
                            if (key != "pageable") {
                                if (typeof (value) == "string") {
                                    var message = "The expected value type is: Int.";
                                    if (key != "pagesize") {
                                        var message = "The expected value type is: Array of Int values.";
                                    }

                                    throw new Error("Invalid Value for: " + key + ". " + message);
                                }
                            }

                            object.dataview.pageable = object.pageable;
                            object.dataview.pagenum = 0;
                            object.dataview.pagesize = object._getpagesize();
                            if (object.virtualmode) {
                                object.updatebounddata();
                            }
                            object.dataview.refresh(true);
                            object._initpager();
                            if (key == "pagesizeoptions") {
                                if (value != null && value.length > 0) {                        
                                    object.pagesize = parseInt(value[0]);
                                    object.dataview.pagesize = parseInt(value[0]);
                                    object.prerenderrequired = true;
                                    object._requiresupdate = true;
                                    object.dataview.pagenum = -1;
                                    object.gotopage(0);
                                }
                            }
                        }
                        object._render(false, false, false);
                    }
                    break;
                case "groups":
                    if (object._serializeObject(oldvalue) !== object._serializeObject(value)) {
                        object.dataview.groups = value;
                        object._refreshdataview();
                        object._render(true, true, true, false);
                    }
                    break;
                case "groupable":
                    if (oldvalue != value) {
                        object.dataview.groupable = object.groupable;
                        object.dataview.pagenum = 0;
                        object.dataview.refresh(false);
                        object._render(false, false, true);
                    }
                    break;
                case "renderstatusbar":
                    if (value != null)
                    {
                        object.renderstatusbar(object.statusbar);
                    }
                    break;
                case "rendertoolbar":
                    if (value != null) {
                        object.rendertoolbar(object.toolbar);
                    }
                    break;
                case "disabled":
                    if (value) {
                        object.host.addClass(object.toThemeProperty('jqx-fill-state-disabled'));
                    }
                    else object.host.removeClass(object.toThemeProperty('jqx-fill-state-disabled'));
                    $.jqx.aria(object, "aria-disabled", object.disabled);
                    if (object.pageable) {
                        if (object.pagerrightbutton) {
                            object.pagerrightbutton.jqxButton({ disabled: value });
                            object.pagerleftbutton.jqxButton({ disabled: value });
                            object.pagershowrowscombo.jqxDropDownList({ disabled: value });
                            object.pagergotoinput.attr('disabled', value);
                        }
                    }
                    object.vScrollBar.jqxScrollBar({ disabled: value });
                    object.hScrollBar.jqxScrollBar({ disabled: value });
                    break;
            }
        }
    });

    function jqxGridColumn(owner, data) {
        this.owner = owner;
        this.datafield = null;
        this.displayfield = null;
        this.text = '';
        this.sortable = true;
        this.hideable = true;
        this.editable = true;
        this.hidden = false;
        this.groupable = true;
        this.renderer = null;
        this.cellsrenderer = null;
        // checkbox column, number column, button column
        this.checkchange = null,
        this.threestatecheckbox = false;
        this.buttonclick = null,
        this.columntype = null;
        this.cellsformat = "";
        this.align = 'left';
        this.cellsalign = 'left';
        this.width = 'auto';
        this.minwidth = 25;
        this.maxwidth = 'auto';
        this.pinned = false;
        this.visibleindex = -1;
        this.filterable = true;
        // default, filter row, checked list
        this.filter = null;
        this.filteritems = [];
        this.resizable = true;
        this.initeditor = null;
        this.createeditor = null;
        this.destroyeditor = null;
        this.geteditorvalue = null;
        this.validation = null;
        this.classname = '';
        this.cellclassname = '';
        this.cellendedit = null;
        this.cellbeginedit = null;
        this.cellvaluechanging = null;
        this.aggregates = null;
        this.aggregatesrenderer = null;
        this.menu = true;
        this.createfilterwidget = null;
        this.filtertype = 'default';
        this.filtercondition = null;
        this.rendered = null;
        this.exportable = true;
        this.exporting = false;
        this.draggable = true;
        this.nullable = true;
        this.enabletooltips = true;
        this.columngroup = null;

        this.getcolumnproperties = function () {
            return {
                nullable: this.nullable,
                sortable: this.sortable, hideable: this.hideable,
                hidden: this.hidden, groupable: this.groupable, width: this.width, align: this.align, editable: this.editable,
                minwidth: this.minwidth, maxwidth: this.maxwidth, resizable: this.resizable, datafield: this.datafield, text: this.text,
                exportable: this.exportable, cellsalign: this.cellsalign, pinned: this.pinned, cellsformat: this.cellsformat, columntype: this.columntype, classname: this.classname, cellclassname: this.cellclassname, menu: this.menu
            };
        },

        this.setproperty = function (propertyname, value) {
            if (this[propertyname]) {
                var oldvalue = this[propertyname];
                this[propertyname] = value;
                this.owner._columnPropertyChanged(this, propertyname, value, oldvalue);
            }
            else {
                if (this[propertyname.toLowerCase()]) {
                    var oldvalue = this[propertyname.toLowerCase()];
                    this[propertyname.toLowerCase()] = value;
                    this.owner._columnPropertyChanged(this, propertyname.toLowerCase(), value, oldvalue);
                }
            }
        }

        this._initfields = function (data) {
            if (data != null) {
                var me = this.that;
                if ($.jqx.hasProperty(data, 'dataField')) {
                    this.datafield = $.jqx.get(data, 'dataField');
                }

                if ($.jqx.hasProperty(data, 'displayField')) {
                    this.displayfield = $.jqx.get(data, 'displayField');
                }
                else {
                    this.displayfield = this.datafield;
                }
                if ($.jqx.hasProperty(data, 'enableTooltips')) {
                    this.enabletooltips = $.jqx.get(data, 'enableTooltips');
                }
                if ($.jqx.hasProperty(data, 'text')) {
                    this.text = $.jqx.get(data, 'text');
                }
                if ($.jqx.hasProperty(data, 'sortable')) {
                    this.sortable = $.jqx.get(data, 'sortable');
                }
                if ($.jqx.hasProperty(data, 'hideable')) {
                    this.hideable = $.jqx.get(data, 'hideable');
                }
                if ($.jqx.hasProperty(data, 'hidden')) {
                    this.hidden = $.jqx.get(data, 'hidden');
                }
                if ($.jqx.hasProperty(data, 'groupable')) {
                    this.groupable = $.jqx.get(data, 'groupable');
                }
                if ($.jqx.hasProperty(data, 'renderer')) {
                    this.renderer = $.jqx.get(data, 'renderer');
                }
                if ($.jqx.hasProperty(data, 'align')) {
                    this.align = $.jqx.get(data, 'align');
                }
                if ($.jqx.hasProperty(data, 'cellsAlign')) {
                    this.cellsalign = $.jqx.get(data, 'cellsAlign');
                }
                if ($.jqx.hasProperty(data, 'cellsFormat')) {
                    this.cellsformat = $.jqx.get(data, 'cellsFormat');
                }
                if ($.jqx.hasProperty(data, 'width')) {
                    this.width = $.jqx.get(data, 'width');
                }
                if ($.jqx.hasProperty(data, 'minWidth')) {
                    this.minwidth = $.jqx.get(data, 'minWidth');
                }
                if ($.jqx.hasProperty(data, 'maxWidth')) {
                    this.maxwidth = $.jqx.get(data, 'maxWidth');
                }
                if ($.jqx.hasProperty(data, 'cellsRenderer')) {
                    this.cellsrenderer = $.jqx.get(data, 'cellsRenderer');
                }
                if ($.jqx.hasProperty(data, 'columnType')) {
                    this.columntype = $.jqx.get(data, 'columnType');
                }
                if ($.jqx.hasProperty(data, 'checkChange')) {
                    this.checkchange = $.jqx.get(data, 'checkChange');
                }
                if ($.jqx.hasProperty(data, 'buttonClick')) {
                    this.buttonclick = $.jqx.get(data, 'buttonClick');
                }
                if ($.jqx.hasProperty(data, 'pinned')) {
                    this.pinned = $.jqx.get(data, 'pinned');
                }
                if ($.jqx.hasProperty(data, 'visibleIndex')) {
                    this.visibleindex = $.jqx.get(data, 'visibleIndex');
                }
                if ($.jqx.hasProperty(data, 'filterable')) {
                    this.filterable = $.jqx.get(data, 'filterable');
                }
                if ($.jqx.hasProperty(data, 'filter')) {
                    this.filter = $.jqx.get(data, 'filter');
                }
                if ($.jqx.hasProperty(data, 'resizable')) {
                    this.resizable = $.jqx.get(data, 'resizable');
                }
                if ($.jqx.hasProperty(data, 'editable')) {
                    this.editable = $.jqx.get(data, 'editable');
                }
                if ($.jqx.hasProperty(data, 'initEditor')) {
                    this.initeditor = $.jqx.get(data, 'initEditor');
                }
                if ($.jqx.hasProperty(data, 'createEditor')) {
                    this.createeditor = $.jqx.get(data, 'createEditor');
                }
                if ($.jqx.hasProperty(data, 'destroyEditor')) {
                    this.destroyeditor = $.jqx.get(data, 'destroyEditor');
                }
                if ($.jqx.hasProperty(data, 'getEditorValue')) {
                    this.geteditorvalue = $.jqx.get(data, 'getEditorValue');
                }
                if ($.jqx.hasProperty(data, 'validation')) {
                    this.validation = $.jqx.get(data, 'validation');
                }
                if ($.jqx.hasProperty(data, 'cellBeginEdit')) {
                    this.cellbeginedit = $.jqx.get(data, 'cellBeginEdit');
                }
                if ($.jqx.hasProperty(data, 'cellEndEdit')) {
                    this.cellendedit = $.jqx.get(data, 'cellEndEdit');
                }
                if ($.jqx.hasProperty(data, 'className')) {
                    this.classname = $.jqx.get(data, 'className');
                }
                if ($.jqx.hasProperty(data, 'cellClassName')) {
                    this.cellclassname = $.jqx.get(data, 'cellClassName');
                }
                if ($.jqx.hasProperty(data, 'menu')) {
                    this.menu = $.jqx.get(data, 'menu');
                }
                if ($.jqx.hasProperty(data, 'aggregates')) {
                    this.aggregates = $.jqx.get(data, 'aggregates');
                }
                if ($.jqx.hasProperty(data, 'aggregatesRenderer')) {
                    this.aggregatesrenderer = $.jqx.get(data, 'aggregatesRenderer');
                }
                if ($.jqx.hasProperty(data, 'createFilterWidget')) {
                    this.createfilterwidget = $.jqx.get(data, 'createFilterWidget');
                }
                if ($.jqx.hasProperty(data, 'filterType')) {
                    this.filtertype = $.jqx.get(data, 'filterType');
                }
                if ($.jqx.hasProperty(data, 'rendered')) {
                    this.rendered = $.jqx.get(data, 'rendered');
                }
                if ($.jqx.hasProperty(data, 'exportable')) {
                    this.exportable = $.jqx.get(data, 'exportable');
                }
                if ($.jqx.hasProperty(data, 'filterItems')) {
                    this.filteritems = $.jqx.get(data, 'filterItems');
                }
                if ($.jqx.hasProperty(data, 'cellValueChanging')) {
                    this.cellvaluechanging = $.jqx.get(data, 'cellValueChanging');
                }
                if ($.jqx.hasProperty(data, 'draggable')) {
                    this.draggable = $.jqx.get(data, 'draggable');
                }
                if ($.jqx.hasProperty(data, 'filterCondition')) {
                    this.filtercondition = $.jqx.get(data, 'filterCondition');
                }
                if ($.jqx.hasProperty(data, 'threeStateCheckbox')) {
                    this.threestatecheckbox = $.jqx.get(data, 'threeStateCheckbox');
                }
                if ($.jqx.hasProperty(data, 'nullable')) {
                    this.nullable = $.jqx.get(data, 'nullable');
                }
                if ($.jqx.hasProperty(data, 'columnGroup')) {
                    this.columngroup = $.jqx.get(data, 'columnGroup');
                }

                if (!data instanceof String && !(typeof data == "string")) {
                    for (var obj in data) {
                        if (!me.hasOwnProperty(obj)) {
                            if (!me.hasOwnProperty(obj.toLowerCase())) {
                                owner.host.remove();
                                throw new Error("jqxGrid: Invalid property name - " + obj + ".");
                            }
                        }
                    }
                }
            }
        }

        this._initfields(data);
        return this;
    }

    function jqxGridRow(owner, data) {
        this.setdata = function (data) {
            if (data != null) {
                this.bounddata = data;
                this.boundindex = data.boundindex;
                this.visibleindex = data.visibleindex;
                this.group = data.group;
                this.parentbounddata = data.parentItem;
                this.uniqueid = data.uniqueid;
                this.level = data.level;
            }
        }
        this.setdata(data);
        this.parentrow = null;
        this.subrows = new Array();
        this.owner = owner;
        this.height = 25;
        this.hidden = false;
        this.rowdetails = null;
        this.rowdetailsheight = 100;
        this.rowdetailshidden = true;
        this.top = -1;

        //        this.getrowinfo = function () {
        //            return { hidden: this.hidden, rowdetails: this.rowdetails, rowdetailsheight: this.rowdetailsheight,
        //                showdetails: !this.rowdetailshidden, height: this.height, index: this.visibleindex
        //            };
        //        }

        this.setrowinfo = function (data) {
            this.hidden = data.hidden;
            this.rowdetails = data.rowdetails;
            this.rowdetailsheight = data.rowdetailsheight;
            this.rowdetailshidden = !data.showdetails;
            this.height = data.height;
        }

        return this;
    }

    $.jqx.collection = function (owner) {
        this.records = new Array();
        this.owner = owner;
        this.updating = false;
        this.beginupdate = function () {
            this.updating = true;
        }

        this.resumeupdate = function () {
            this.updating = false;
        }

        this._raiseEvent = function (args) {
        }

        this.clear = function () {
            this.records = new Array();
        }

        this.replace = function (index, object) {
            this.records[index] = object;
            if (!this.updating) {
                this._raiseEvent({ type: 'replace', element: object });
            }
        }

        this.isempty = function (index) {
            if (this.records[index] == undefined) {
                return true;
            }

            return false;
        }

        this.initialize = function (size) {
            if (size < 1) size = 1;
            this.records[size - 1] = -1;
        }

        this.length = function () {
            return this.records.length;
        }

        this.indexOf = function (object) {
            return this.records.indexOf(object);
        }

        this.add = function (object) {
            if (object == null)
                return false;

            this.records[this.records.length] = object;
            if (!this.updating) {
                this._raiseEvent({ type: 'add', element: object });
            }
            return true;
        }

        this.insertAt = function (index, object) {
            if (index == null || index == undefined)
                return false;

            if (object == null)
                return false;

            if (index >= 0) {
                if (index < this.records.length) {
                    this.records.splice(index, 0, object);
                    if (!this.updating) {
                        this._raiseEvent({ type: 'insert', index: index, element: object });
                    }
                    return true;
                }
                else return this.add(object);
            }

            return false;
        }

        this.remove = function (object) {
            if (object == null || object == undefined)
                return false;

            var index = this.records.indexOf(object);
            if (index != -1) {
                this.records.splice(index, 1);
                if (!this.updating) {
                    this._raiseEvent({ type: 'remove', element: object });
                }
                return true;
            }

            return false;
        }

        this.removeAt = function (index) {
            if (index == null || index == undefined)
                return false;

            if (index < 0)
                return false;

            if (index < this.records.length) {
                var object = this.records[index];
                this.records.splice(index, 1);
                if (!this.updating) {
                    this._raiseEvent({ type: 'removeAt', index: index, element: object });
                }
                return true;
            }

            return false;
        }

        return this;
    }

    $.jqx.dataview = function () {
        this.self = this;
        this.grid = null;
        this.uniqueId = "id";
        this.records = [];
        this.rows = [];
        this.columns = [];
        this.groups = [];
        this.filters = new Array();
        this.updated = null;
        this.update = null;
        this.suspend = false;
        this.pagesize = 0;
        this.pagenum = 0;
        this.totalrows = 0;
        this.totalrecords = 0;
        this.groupable = true;
        this.loadedrecords = [];
        this.loadedrootgroups = [];
        this.loadedgroups = [];
        this.loadedgroupsByKey = [];
        this.virtualmode = true;
        this._cachegrouppages = new Array();
        this.source = null;
        this.changedrecords = new Array();
        this.rowschangecallback = null;
        this.that = this;

        this.destroy = function()
        {
            delete this.self;
            delete this.grid;
            delete this.uniqueId;
            delete this.records;
            delete this.rows;
            delete this.columns;
            delete this.groups;
            delete this.filters;
            delete this.updated;
            delete this.update;
            delete this.suspend;
            delete this.pagesize;
            delete this.pagenum;
            delete this.totalrows;
            delete this.totalrecords;
            delete this.groupable;
            delete this.loadedrecords;
            delete this.loadedrootgroups;
            delete this.loadedgroups;
            delete this.loadedgroupsByKey;
            delete this.virtualmode;
            delete this._cachegrouppages;
            delete this.source;
            delete this.changedrecords;
            delete this.rowschangecallback;
            delete this.that;
        },

        this.suspendupdate = function () {
            this.suspend = true;
        },

        this.isupdating = function () {
            return this.suspend;
        },

        this.resumeupdate = function (refresh) {
            this.suspend = false;

            if (refresh == undefined)
                refresh = true;

            this.refresh(refresh);
        },

        this.getrecords = function () {
            return this.records;
        },

        this.clearrecords = function () {
            this.recordids = new Array();
        }

        this.databind = function (source, objectuniqueId) {
            var isdataadapter = source._source ? true : false;
            var dataadapter = null;

            if (isdataadapter) {
                dataadapter = source;
                source = source._source;
            }
            else {
                dataadapter = new $.jqx.dataAdapter(source,
                {
                    autoBind: false
                });
            }

            var initadapter = function (me) {
                dataadapter.recordids = [];
                dataadapter.records = new Array();
                dataadapter.cachedrecords = new Array();
                dataadapter.originaldata = new Array();
                dataadapter._options.virtualmode = me.virtualmode;
                dataadapter._options.totalrecords = me.totalrecords;
                dataadapter._options.originaldata = me.originaldata;
                dataadapter._options.recordids = me.recordids;
                dataadapter._options.cachedrecords = new Array();
                dataadapter._options.pagenum = me.pagenum;
                dataadapter._options.pageable = me.pageable;
                if (source.type != undefined) {
                    dataadapter._options.type = source.type;
                }
                if (source.formatdata != undefined) {
                    dataadapter._options.formatData = source.formatdata;
                }
                if (source.contenttype != undefined) {
                    dataadapter._options.contentType = source.contenttype;
                }
                if (source.async != undefined) {
                    dataadapter._options.async = source.async;
                }
                if (source.updaterow != undefined) {
                    dataadapter._options.updaterow = source.updaterow;
                }
                if (source.addrow != undefined) {
                    dataadapter._options.addrow = source.addrow;
                }
                if (source.deleterow != undefined) {
                    dataadapter._options.deleterow = source.deleterow;
                }

                if (me.pagesize == 0) me.pagesize = 10;
                dataadapter._options.pagesize = me.pagesize;
            }

            var updatefromadapter = function (me) {
                me.totalrecords = dataadapter.totalrecords;
                if (!me.virtualmode) {
                    me.originaldata = dataadapter.originaldata;
                    me.records = dataadapter.records;
                    me.recordids = dataadapter.recordids;
                    me.cachedrecords = dataadapter.cachedrecords;
                }
                else {
                    var rendergridrowsobj = { startindex: me.pagenum * me.pagesize, endindex: (me.pagenum * me.pagesize + me.pagesize) };
                    if (source.recordstartindex) {
                        rendergridrowsobj.startindex = source.recordstartindex;
                    }
                    if (source.recordendindex) {
                        rendergridrowsobj.endindex = source.recordendindex;
                    }
                    else if (!me.grid.pageable) {
                        rendergridrowsobj.endindex = rendergridrowsobj.startindex + 100;
                        if (me.grid.autoheight) {
                            rendergridrowsobj.endindex = rendergridrowsobj.startindex + me.totalrecords;
                        }
                    }
                    rendergridrowsobj.data = dataadapter.records;
                    if (me.grid.rendergridrows && me.totalrecords > 0) {
                        var recordscount = 0;
                        source.records = me.grid.rendergridrows(rendergridrowsobj);
                        if (source.records.length) {
                            recordscount = source.records.length;
                        }

                        if (source.records && !source.records[rendergridrowsobj.startindex]) {
                            var newArray = new Array();
                            var newArrayIndex = rendergridrowsobj.startindex;
                            $.each(source.records, function () {
                                newArray[newArrayIndex] = this;
                                newArrayIndex++;
                                recordscount++;
                            });
                            source.records = newArray;
                        }
                        if (recordscount == 0) {
                            if (source.records) {
                                $.each(source.records, function () {
                                    recordscount++;
                                });
                            }
                        }
                        if (recordscount > 0 && recordscount < rendergridrowsobj.endindex - rendergridrowsobj.startindex && !me.grid.groupable) {
                            var toClone = source.records[0];
                           
                            for (var i = 0; i < rendergridrowsobj.endindex - rendergridrowsobj.startindex - recordscount; i++) {
                                var newData = {};
                                for (obj in toClone) {
                                    newData[obj] = "";
                                }

                                if (source.records.push) {
                                    source.records.push(newData);
                                }
                            }
                        }
                    }

                    if (!source.records || me.totalrecords == 0) {
                        source.records = new Array();
                    }

                    me.originaldata = source.records;
                    me.records = source.records;
                    me.cachedrecords = source.records;
                }
            }

            initadapter(this);

            this.source = source;
            if (objectuniqueId !== undefined) {
                uniqueId = objectuniqueId;
            }

            var me = this.that;
            //if (this.virtualmode && !this.pageable) {
            //    var rendergridrowsobj = { startindex: me.pagenum * me.pagesize, endindex: (me.pagenum * me.pagesize + me.pagesize) };
            //    if (dataadapter.records && dataadapter.records[rendergridrowsobj.startindex]) {
            //        updatefromadapter(this);
            //        return;
            //    }
            //}

            switch (source.datatype) {
                case "local":
                case "array":
                default:
                    if (source.localdata == null) {
                        source.localdata = [];
                    }

                    if (source.localdata != null) {
                        dataadapter.unbindBindingUpdate(me.grid.element.id);
                        dataadapter.dataBind();

                        var updateFunc = function (changeType) {
                            if (changeType != undefined && changeType != "") {
                                var dataItem = dataadapter._changedrecords[0];
                                if (dataItem) {
                                    $.each(dataadapter._changedrecords, function (rowIndex) {
                                        var index = this.index;
                                        var item = this.record;

                                        me.grid._updateFromAdapter = true;
                                        switch (changeType) {
                                            case "update":
                                                var id = me.grid.getrowid(index);
                                                if (rowIndex == dataadapter._changedrecords.length - 1) {
                                                    me.grid.updaterow(id, item);
                                                }
                                                else {
                                                    me.grid.updaterow(id, item, false);
                                                }

                                                me.grid._updateFromAdapter = false;
                                                return;
                                            case "add":
                                                me.grid.addrow(null, item);
                                                me.grid._updateFromAdapter = false;
                                                return;
                                            case "remove":
                                                var id = me.grid.getrowid(index);
                                                me.grid.deleterow(id);
                                                me.grid._updateFromAdapter = false;
                                                return;
                                        }
                                    });
                                }
                                if (changeType == "update") {
                                    return;
                                }
                            }
                            var totalrecords = me.totalrecords;
                            updatefromadapter(me, changeType);

                            if (changeType == 'updateData') {
                                me.refresh();
                                me.grid._updateGridData();
                            }
                            else {
                                if (source.recordstartindex && this.virtualmode) {
                                    me.updateview(source.recordstartindex, source.recordstartindex + me.pagesize);
                                }
                                else {
                                    me.refresh();
                                }
                                me.update(totalrecords != me.totalrecords);
                            }
                        }

                        updateFunc();
                        dataadapter.bindBindingUpdate(me.grid.element.id, updateFunc);
                    }
                    break;
                case "json":
                case "jsonp":
                case "xml":
                case "xhtml":
                case "script":
                case "text":
                case "csv":
                case "tab":
                    {
                        if (source.localdata != null) {
                            dataadapter.unbindBindingUpdate(me.grid.element.id);
                            dataadapter.dataBind();

                            var updateFunc = function (changeType) {
                                var totalrecords = me.totalrecords;
                                updatefromadapter(me);

                                if (changeType == 'updateData') {
                                    me.refresh();
                                    me.grid._updateGridData();
                                }
                                else {
                                    if (source.recordstartindex) {
                                        me.updateview(source.recordstartindex, source.recordstartindex + me.pagesize);
                                    }
                                    else {
                                        me.refresh();
                                    }

                                    me.update(totalrecords != me.totalrecords);
                                }
                            }

                            updateFunc();
                            dataadapter.bindBindingUpdate(me.grid.element.id, updateFunc);
                            return;
                        }

                        var filterdata = {};
                        var filterslength = 0;
                        var postdata = {};
                        for (var x = 0; x < this.filters.length; x++) {
                            var filterdatafield = this.filters[x].datafield;
                            var filter = this.filters[x].filter;
                            var filters = filter.getfilters();
                            postdata[filterdatafield + "operator"] = filter.operator;
                            for (var m = 0; m < filters.length; m++) {
                                filters[m].datafield = filterdatafield;
                                var filtervalue = filters[m].value;
                                if (filters[m].type == "datefilter") {
                                    if (filters[m].value && filters[m].value.toLocaleString) {
                                        var column = this.grid.getcolumn(filters[m].datafield);
                                        if (column.cellsformat) {
                                            var value = this.grid.source.formatDate(filters[m].value, column.cellsformat, this.grid.gridlocalization);
                                            if (value) {
                                                postdata["filtervalue" + filterslength] = value;
                                            }
                                            else {
                                                postdata["filtervalue" + filterslength] = filters[m].value.toLocaleString();
                                            }
                                        }
                                        else {
                                            postdata["filtervalue" + filterslength] = filtervalue.toString();
                                        }
                                    }
                                    else {
                                        postdata["filtervalue" + filterslength] = filtervalue.toString();
                                    }
                                }
                                else {
                                    postdata["filtervalue" + filterslength] = filtervalue.toString();
                                }
                                postdata["filtercondition" + filterslength] = filters[m].condition;
                                postdata["filteroperator" + filterslength] = filters[m].operator;
                                postdata["filterdatafield" + filterslength] = filterdatafield;

                                filterslength++;
                            }
                        }

                        postdata.filterscount = filterslength;
                        postdata.groupscount = me.groups.length;
                        for (var x = 0; x < me.groups.length; x++) {
                            postdata["group" + x] = me.groups[x];
                        }

                        if (source.recordstartindex == undefined) source.recordstartindex = 0;
                        if (source.recordendindex == undefined || source.recordendindex == 0) {
                            if (me.grid.height && me.grid.height.toString().indexOf('%') == -1) {
                                source.recordendindex = parseInt(me.grid.height) / me.grid.rowsheight;
                                source.recordendindex += 2;
                            }
                            else {
                                source.recordendindex = $(window).height() / me.grid.rowsheight;
                            }
                            if (this.pageable) {
                                source.recordendindex = this.pagesize;
                            }
                        }

                        $.extend(postdata, { sortdatafield: me.sortfield, sortorder: me.sortfielddirection, pagenum: me.pagenum, pagesize: me.grid.pagesize, recordstartindex: source.recordstartindex, recordendindex: source.recordendindex });
                        var tmpdata = dataadapter._options.data;
                        if (dataadapter._options.data) {
                            $.extend(dataadapter._options.data, postdata);
                        }
                        else {
                            if (source.data) {
                                $.extend(postdata, source.data);
                            }
                            dataadapter._options.data = postdata;
                        }

                        var updateFunc = function () {
                            var ie = $.jqx.browser.msie && $.jqx.browser.version < 9;
                            var doUpdate = function () {
                                var totalrecords = me.totalrecords;
                                updatefromadapter(me);

                                if (source.recordstartindex) {
                                    me.updateview(source.recordstartindex, source.recordstartindex + me.pagesize);
                                }
                                else {
                                    me.refresh();
                                }

                                me.update(totalrecords != me.totalrecords);
                            }
                            if (ie) {
                                try {
                                    doUpdate();
                                }
                                catch (error) {
                                }
                            }
                            else {
                                doUpdate();
                            }
                        }

                        dataadapter.unbindDownloadComplete(me.grid.element.id);
                        dataadapter.bindDownloadComplete(me.grid.element.id, updateFunc);
                        dataadapter.dataBind();
                        dataadapter._options.data = tmpdata;
                    }
            }
        }

        this.getid = function (id, record, index) {
            if ($(id, record).length > 0) {
                return $(id, record).text();
            }

            if (id) {
                if (id.toString().length > 0) {
                    var result = $(record).attr(id);
                    if (result != null && result.toString().length > 0) {
                        return result;
                    }
                }
            }

            return index;
        }

        this.getvaluebytype = function (value, datafield) {
            var originalvalue = value;
            if (datafield.type == 'date') {
                var tmpvalue = new Date(value);

                if (tmpvalue.toString() == 'NaN' || tmpvalue.toString() == "Invalid Date") {
                    if ($.jqx.dataFormat) {
                        value = $.jqx.dataFormat.tryparsedate(value);
                    }
                    else value = tmpvalue;
                }
                else {
                    value = tmpvalue;
                }

                if (value == null) {
                    value = originalvalue;
                }
            }
            else if (datafield.type == 'float') {
                var value = parseFloat(value);
                if (isNaN(value)) {
                    value = originalvalue;
                }
            }
            else if (datafield.type == 'int') {
                var value = parseInt(value);
                if (isNaN(value)) {
                    value = originalvalue;
                }
            }
            else if (datafield.type == 'bool') {
                if (value != null) {
                    if (value.toLowerCase() == 'false') {
                        value = false;
                    }
                    else if (value.toLowerCase() == 'true') {
                        value = true;
                    }
                }

                if (value == 1) {
                    value = true;
                }
                else if (value == 0) {
                    value = false;
                }
                else value = '';
            }

            return value;
        }

        this.setpaging = function (args) {
            if (args.pageSize != undefined) {
                this.pagesize = args.pageSize;
            }

            if (args.pageNum != undefined) {
                this.pagenum = Math.min(args.pageNum, Math.ceil(this.totalrows / this.pagesize));
            }

            this.refresh();
        }

        this.getpagingdetails = function () {
            return { pageSize: this.pagesize, pageNum: this.pagenum, totalrows: this.totalrows };
        }

        this._clearcaches = function () {
            this.sortcache = {};
            this.sortdata = null;
            this.changedrecords = new Array();
            this.records = new Array();
            this.rows = new Array();
            this.cacheddata = new Array();
            this.originaldata = new Array();
            this.bounditems = new Array();
            this.loadedrecords = new Array();
            this.loadedrootgroups = new Array();
            this.loadedgroups = new Array();
            this.loadedgroupsByKey = new Array();
            this._cachegrouppages = new Array();
            this.recordsbyid = new Array();
            this.cachedrecords = new Array();
            this.recordids = new Array();
        }

        this.addfilter = function (field, filter) {
            var filterindex = -1;
            for (var m = 0; m < this.filters.length; m++) {
                if (this.filters[m].datafield == field) {
                    filterindex = m;
                    break;
                }
            }

            if (filterindex == -1) {
                this.filters[this.filters.length] = { filter: filter, datafield: field };
            }
            else {
                this.filters[filterindex] = { filter: filter, datafield: field };
            }
        }

        this.removefilter = function (field) {
            for (var i = 0; i < this.filters.length; i++) {
                if (this.filters[i].datafield == field) {
                    this.filters.splice(i, 1);
                    break;
                }
            }
        }

        this.getItemFromIndex = function (i) {
            return this.records[i];
        }

        this.updaterow = function (rowid, rowdata, refresh) {
            var hasFilter = this.filters && this.filters.length > 0;

            if (!hasFilter && rowdata != undefined && rowid != undefined) {
                rowdata.uid = rowid;
                if (!(rowdata[this.source.id])) {
                    rowdata[this.source.id] = rowdata.uid;
                }

                var record = this.recordsbyid["id" + rowid];
                var recordindex = this.records.indexOf(record);
                if (recordindex == -1)
                    return false;

                this.records[recordindex] = rowdata;
                if (this.cachedrecords) {
                    this.cachedrecords[recordindex] = rowdata;
                }
                if (refresh == true || refresh == undefined) {
                    this.refresh();
                }
                this.changedrecords[rowdata.uid] = { Type: "Update", OldData: record, Data: rowdata };
                return true;
            }
            else if (this.filters && this.filters.length > 0) {
                var records = this.cachedrecords;
                var record = null;
                var recordindex = -1;
                for (var i = 0; i < records.length; i++) {
                    if (records[i].uid == rowid) {
                        record = records[i];
                        recordindex = i;
                        break;
                    }
                }
                if (record) {
                    var me = this.that;
                    for (var obj in rowdata) {
                        me.cachedrecords[recordindex][obj] = rowdata[obj];
                    }
                    if (refresh == true || refresh == undefined) {
                        this.refresh();
                    }
                    return true;
                }
            }

            return false;
        }

        this.addrow = function (rowid, rowdata, position, refresh) {
            if (rowdata != undefined) {
                if (!rowid) {
                    rowdata.uid = this.getid(this.source.id, rowdata, this.totalrecords);
                    var record = this.recordsbyid["id" + rowdata.uid];
                    while (record != null) {
                        var uid = Math.floor(Math.random() * 10000).toString();
                        rowdata.uid = uid;
                        record = this.recordsbyid["id" + uid];
                    }
                }
                else rowdata.uid = rowid;

                if (!(rowdata[this.source.id])) {
                    if (this.source.id != undefined) {
                        rowdata[this.source.id] = rowdata.uid;
                    }
                }

                if (position == 'last') {
                    this.records.push(rowdata);
                }
                else if (typeof position === 'number' && isFinite(position)) {
                    this.records.splice(position, 0, rowdata);
                }
                else {
                    this.records.splice(0, 0, rowdata);
                }
                if (this.filters && this.filters.length > 0) {
                    if (position == 'last') {
                        this.cachedrecords.push(rowdata);
                    }
                    else if (typeof position === 'number' && isFinite(position)) {
                        this.cachedrecords.splice(position, 0, rowdata);
                    }
                    else {
                        this.cachedrecords.splice(0, 0, rowdata);
                    }
                }

                this.totalrecords++;
                if (this.virtualmode) {
                    this.source.totalrecords = this.totalrecords;
                }
                if (refresh == true || refresh == undefined) {
                    this.refresh();
                }

                this.changedrecords[rowdata.uid] = { Type: "New", Data: rowdata };
                return true;
            }
            return false;
        }

        this.deleterow = function (rowid, refresh) {
            if (rowid != undefined) {
                var hasFilter = this.filters && this.filters.length > 0;
                if (this.recordsbyid["id" + rowid] && !hasFilter) {
                    var record = this.recordsbyid["id" + rowid];
                    var recordindex = this.records.indexOf(record);
                    this.changedrecords[rowid] = { Type: "Delete", Data: this.records[recordindex] };
                    this.records.splice(recordindex, 1);
                    this.totalrecords--;
                    if (this.virtualmode) {
                        this.source.totalrecords = this.totalrecords;
                    }
                    if (refresh == true || refresh == undefined) {
                        this.refresh();
                    }
                    return true;
                }
                else if (this.filters && this.filters.length > 0) {
                    var records = this.cachedrecords;
                    var record = null;
                    var recordindex = -1;
                    for (var i = 0; i < records.length; i++) {
                        if (records[i].uid == rowid) {
                            record = records[i];
                            recordindex = i;
                            break;
                        }
                    }
                    if (record) {
                        this.cachedrecords.splice(recordindex, 1);
                        if (refresh == true || refresh == undefined) {
                            this.totalrecords = 0;
                            this.records = this.cachedrecords;
                            this.refresh();
                        }
                        return true;
                    }
                }

                return false;
            }

            return false;
        }

        this.reload = function (_records, _rows, _filter, _updated, fullupdate, startindex, endindex) {
            var self = this.that;
            var diff = new Array();
            var records = _records;
            var rows = _rows;
            var filter = _filter;
            var updated = _updated;

            var rl = rows.length;
            var currentRowIndex = 0;
            var currentPageIndex = 0;
            var item, id;
            this.columns = [];
            this.bounditems = new Array();
            this.loadedrecords = new Array();
            this.loadedrootgroups = new Array();
            this.loadedgroups = new Array();
            this.loadedgroupsByKey = new Array();
            this._cachegrouppages = new Array();
            this.recordsbyid = {};

            if (this.totalrecords == 0) {
                Object.size = function (obj) {
                    var size = 0, key;
                    for (key in obj) {
                        if (obj.hasOwnProperty(key)) size++;
                    }
                    return size;
                };

                var totalrecords = Object.size(records);
                this.totalrecords = totalrecords;

                $.each(this.records, function (i) {
                    var item = this;
                    var index = 0;
                    $.each(item, function (columnName, value) {
                        self.columns[index++] = columnName;
                    });

                    return false;
                });
            }

            if (this.virtualmode) {
                if (this.pageable) {
                    this.updateview();
                    return;
                }

                var startindex = 0;
                if (!this.groupable) {
                    this.updateview();
                    return;
                }
                else {
                    var endindex = this.totalrecords;
                }
            }
            else {
                var startindex = 0;
                var endindex = this.totalrecords;
            }

            if (this.groupable && this.groups.length > 0 && this.loadgrouprecords) {
                var visualRows = startindex;
                visualRows = this.loadgrouprecords(0, startindex, endindex, filter, currentPageIndex, updated, rows, rl, diff);
            }
            else {
                currentRowIndex = this.loadflatrecords(startindex, endindex, filter, currentPageIndex, updated, rows, rl, diff);
            }

            if (rl > currentPageIndex)
                rows.splice(currentPageIndex, rl - currentPageIndex);


            if (this.groups.length > 0 && this.groupable) {
                this.totalrows = visualRows;
            }
            else {
                this.totalrows = currentRowIndex;
            }

            return diff;
        }

        this.loadflatrecords = function (startindex, endindex, filter, currentPageIndex, updated, rows, rl, diff) {
            var self = this.that;
            var i = startindex;
            var currentRowIndex = startindex;
            endindex = Math.min(endindex, this.totalrecords);

            var hassortdata = this.sortdata != null;
            var localdata = this.source.id && (this.source.datatype == 'local' || this.source.datatype == 'array' || this.source.datatype == '');

            var data = hassortdata ? this.sortdata : this.records;

            for (var obj = startindex; obj < endindex; obj++) {
                var item = {};
                if (!hassortdata) {
                    item = $.extend({}, data[obj]);
                    id = item[self.uniqueId];
                    item.boundindex = i;
                    self.loadedrecords[i] = item;

                    if (item.uid == undefined) {
                        item.uid = self.getid(self.source.id, item, i);
                    }
                    self.recordsbyid["id" + item.uid] = data[obj];
                    item.uniqueid = self.generatekey();
                    self.bounditems[this.bounditems.length] = item;
                }
                else {
                    item = $.extend({}, data[obj].value);
                    id = item[self.uniqueId];
                    item.boundindex = data[obj].index;
                    if (item.uid == undefined) {
                        item.uid = self.getid(self.source.id, item, item.boundindex);
                    }
                    self.recordsbyid["id" + item.uid] = data[obj].value;
                    self.loadedrecords[i] = item;
                    item.uniqueid = self.generatekey();
                    self.bounditems[item.boundindex] = item;
                }

                if (currentPageIndex >= rl || id != rows[currentPageIndex][self.uniqueId] || (updated && updated[id]))
                    diff[diff.length] = currentPageIndex;

                rows[currentPageIndex] = item;
                currentPageIndex++;

                item.visibleindex = currentRowIndex;
                currentRowIndex++;
                i++;
            }

            if (self.grid.summaryrows) {
                var rowindex = i;
                $.each(self.grid.summaryrows, function () {
                    var item = $.extend({}, this);
                    item.boundindex = endindex++;
                    self.loadedrecords[rowindex] = item;
                    item.uniqueid = self.generatekey();
                    self.bounditems[self.bounditems.length] = item;
                    rows[currentPageIndex] = item;
                    currentPageIndex++;
                    item.visibleindex = currentRowIndex;
                    currentRowIndex++;
                    rowindex++;
                });
            }

            return currentRowIndex;
        },

        this.updateview = function (from, to) {
            var self = this.that;
            var currentRowIndex = this.pagesize * this.pagenum;
            var currentPageIndex = 0;
            var rows = new Array();
            var filter = this.filters;
            var updated = this.updated;
            var rl = rows.length;

            if (this.pageable) {
                if (this.virtualmode) {
                    if (!this.groupable || this.groups.length == 0) {
                        this.loadflatrecords(this.pagesize * this.pagenum, this.pagesize * (1 + this.pagenum), filter, currentPageIndex, updated, rows, rl, []);
                        this.totalrows = rows.length;
                    }
                    else if (this.groupable && this.groups.length > 0 && this.loadgrouprecords) {
                        if (this._cachegrouppages[this.pagenum + '_' + this.pagesize] != undefined) {
                            this.rows = this._cachegrouppages[this.pagenum + '_' + this.pagesize];
                            this.totalrows = this.rows.length;
                            return;
                        }

                        var endindex = this.pagesize * (1 + this.pagenum);
                        if (endindex > this.totalrecords) {
                            endindex = this.totalrecords;
                        }

                        this.loadgrouprecords(0, this.pagesize * this.pagenum, endindex, filter, currentPageIndex, updated, rows, rl, []);
                        this._cachegrouppages[this.pagenum + '_' + this.pagesize] = this.rows;
                        this.totalrows = this.rows.length;
                        return;
                    }
                }
            }
            else {
                if (this.virtualmode && (!this.groupable || this.groups.length == 0)) {
                    var pagesize = this.pagesize;
                    if (pagesize == 0) {
                        pagesize = Math.min(100, this.totalrecords);
                    }
                    var start = pagesize * this.pagenum;
                    if (this.loadedrecords.length == 0) start = 0;

                    if (from != null && to != null) {
                        this.loadflatrecords(from, to, filter, currentPageIndex, updated, rows, rl, []);
                    }
                    else {
                        this.loadflatrecords(this.pagesize * this.pagenum, this.pagesize * (1 + this.pagenum), filter, currentPageIndex, updated, rows, rl, []);
                    }
                    this.totalrows = this.loadedrecords.length;
                    this.rows = rows;
                    if (rows.length >= pagesize) {
                        return;
                    }
                }
            }

            if (this.groupable && this.pageable && this.groups.length > 0 && this._updategroupsinpage) {
                rows = this._updategroupsinpage(self, filter, currentRowIndex, currentPageIndex, rl, this.pagesize * this.pagenum, this.pagesize * (1 + this.pagenum));
            }
            else {
                for (var i = this.pagesize * this.pagenum; i < this.pagesize * (1 + this.pagenum); i++) {
                    var item = i < this.loadedrecords.length ? this.loadedrecords[i] : null;
                    if (item == null) continue;

                    if (!this.pagesize || (currentRowIndex >= this.pagesize * this.pagenum && currentRowIndex <= this.pagesize * (this.pagenum + 1))) {
                        rows[currentPageIndex] = item;
                        currentPageIndex++;
                    }

                    currentRowIndex++;
                }
            }

            if ((rows.length == 0 || rows.length < this.pagesize) && !this.pageable && this.virtualmode) {
                currentPageIndex = rows.length;
                var startlength = rows.length;
                for (var i = this.pagesize * this.pagenum; i < this.pagesize * (1 + this.pagenum) - startlength; i++) {
                    var item = {};
                    item.boundindex = i + startlength;
                    item.visibleindex = i + startlength;
                    item.uniqueid = self.generatekey();
                    item.empty = true;
                    self.bounditems[i + startlength] = item;
                    rows[currentPageIndex] = item;
                    currentPageIndex++;
                }
            }

            this.rows = rows;
        }

        this.generatekey = function () {
            var S4 = function () {
                return (((1 + Math.random()) * 0x10) | 0);
            };
            return ("" + S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
        }

        this.reloaddata = function () {
            this.reload(this.records, this.rows, this.filter, this.updated, true);
        }

        this.refresh = function (fullupdate) {
            if (this.suspend) return;

            if (fullupdate == undefined) {
                fullupdate = true;
            }

            var countBefore = this.rows.length;
            var totalrowsBefore = this.totalrows;

            if (this.filters.length > 0 && !this.virtualmode) {
                var filter = "";
                var length = this.cachedrecords.length;
                var filtereddata = new Array();
                this.totalrecords = 0;
                var data = this.cachedrecords;
                this._dataIndexToBoundIndex = new Array();
                var filterslength = this.filters.length;

                if (this.source != null && this.source.filter != undefined && this.source.localdata != undefined) {
                    filtereddata = this.source.filter(this.filters, data, length);
                    if (filtereddata == undefined) {
                        filtereddata = new Array();
                    }
                    this.records = filtereddata;
                }
                else if (this.source.filter == null || this.source.filter == undefined) {
                    for (var row = 0; row < length; row++) {
                        var datarow = data[row];
                        var filterresult = undefined;
                        for (var j = 0; j < filterslength; j++) {
                            var filter = this.filters[j].filter;
                            var value = datarow[this.filters[j].datafield];
                            var result = filter.evaluate(value);

                            if (filterresult == undefined) filterresult = result;
                            else {
                                if (filter.operator == 'or') {
                                    filterresult = filterresult || result;
                                }
                                else {
                                    filterresult = filterresult && result;
                                }
                            }
                        }

                        if (filterresult) {
                            filtereddata[filtereddata.length] = $.extend({ dataindex: row }, datarow);
                            this._dataIndexToBoundIndex[row] = { boundindex: filtereddata.length - 1 };
                        }
                        else this._dataIndexToBoundIndex[row] = null;
                    }
                    this.records = filtereddata;
                }
                if (this.sortdata) {
                    var lookupkey = this.sortfield;
                    if (this.sortcache[lookupkey]) {
                        this.sortdata = null;
                        var direction = this.sortcache[lookupkey].direction;
                        this.sortcache[lookupkey] = null;
                        this.sortby(this.sortfield, direction);
                        return;
                    }
                }
            }
            else if (this.filters.length == 0 && !this.virtualmode) {
                if (this.cachedrecords) {
                    this.totalrecords = 0;
                    var data = this.cachedrecords;
                    this.records = data;
                    if (this.sortdata) {
                        var lookupkey = this.sortfield;
                        if (this.sortcache[lookupkey]) {
                            this.sortdata = null;
                            var direction = this.sortcache[lookupkey].direction;
                            this.sortcache[lookupkey] = null;
                            this.sortby(this.sortfield, direction);
                            return;
                        }
                    }
                }
            }

            var diff = this.reload(this.records, this.rows, this.filter, this.updated, fullupdate);
            this.updated = null;

            if (this.rowschangecallback != null) {
                if (totalrowsBefore != totalrows) this.rowschangecallback({ type: "PagingChanged", data: getpagingdetails() });
                if (countBefore != rows.length) this.rowschangecallback({ type: "RowsCountChanged", data: { previous: countBefore, current: rows.length } });
                if (diff.length > 0 || countBefore != rows.length) {
                    this.rowschangecallback({ type: "RowsChanged", data: { previous: countBefore, current: rows.length, diff: diff } });
                }
            }
        }

        return this;
    }
})(jQuery);(function ($) {

    $.extend($.jqx._jqxGrid.prototype, {
        // select all rows.
        selectallrows: function () {
            this._trigger = false;
            var length = this.virtualmode ? this.dataview.totalrecords : this.getboundrows().length;
            this.selectedrowindexes = new Array();
            for (var i = 0; i < length; i++) {
                this.selectedrowindexes[i] = i;
            }
            if (this.selectionmode == "checkbox" && !this._checkboxcolumnupdating) {
                if (this._checkboxcolumn) {
                    this._checkboxcolumn.checkboxelement.jqxCheckBox({ checked: true });
                }
            }

            this._renderrows(this.virtualsizeinfo);
            this._trigger = true;
        },

        // selects a row by index.
        selectrow: function (index, refresh) {
            this._applyrowselection(index, true, refresh);
            if (refresh !== false) {
                this._updatecheckboxselection();
            }
        },

        _updatecheckboxselection: function()
        {
            if (this.selectionmode == "checkbox") {
                var rows = this.getrows();
                if (rows && this._checkboxcolumn) {
                    if (rows.length === 0) {
                        this._checkboxcolumn.checkboxelement.jqxCheckBox({ checked: false });
                        return;
                    }
                    var length = rows.length;
                    if (this.virtualmode) length = this.source._source.totalrecords;

                    var checkedItemsCount = this.selectedrowindexes.length;
                    if (checkedItemsCount === length) {
                        this._checkboxcolumn.checkboxelement.jqxCheckBox({ checked: true });
                    }
                    else if (checkedItemsCount === 0) {
                        this._checkboxcolumn.checkboxelement.jqxCheckBox({ checked: false });
                    }
                    else this._checkboxcolumn.checkboxelement.jqxCheckBox({ checked: null });
                }
            }
        },

        // unselects a row by index.
        unselectrow: function (index, refresh) {
            this._applyrowselection(index, false, refresh);
            if (refresh !== false) {
                this._updatecheckboxselection();
            }
        },

        // selects a cell.
        selectcell: function (row, datafield) {
            this._applycellselection(row, datafield, true);
        },

        // unselects a cell.
        unselectcell: function (row, datafield) {
            this._applycellselection(row, datafield, false);
        },

        // clears the selection.
        clearselection: function (refresh, raiseEvent) {
            this._trigger = false;
            this.selectedrowindex = -1;

            if (raiseEvent !== false) {
                for (var i = 0; i < this.selectedrowindexes.length; i++) {
                    this._raiseEvent(3, { rowindex: this.selectedrowindexes[i] });
                }
            }

            this.selectedrowindexes = new Array();
            this.selectedcells = new Array();

            if (this.selectionmode == "checkbox" && !this._checkboxcolumnupdating ) {
                this._checkboxcolumn.checkboxelement.jqxCheckBox({ checked: false });
            }

            if (false === refresh) {
                this._trigger = true;
                return;
            }

            this._renderrows(this.virtualsizeinfo);
            this._trigger = true;
        },

        // gets the selected row index.
        getselectedrowindex: function () {
            return this.selectedrowindex;
        },

        // gets the selected row index.
        getselectedrowindexes: function () {
            return this.selectedrowindexes;
        },

        // gets the selected cell.
        getselectedcell: function () {
            var cell = this.selectedcell;
            cell.row = this.selectedcell.rowindex;
            cell.column = this.selectedcell.datafield;
            cell.value = this.getcellvalue(cell.row, cell.column);
            return cell;
        },

        // gets the selected cells.
        getselectedcells: function () {
            var cells = new Array();
            for (obj in this.selectedcells) {
                cells[cells.length] = this.selectedcells[obj];
            }

            return cells;
        },

        _getcellsforcopypaste: function () {
            var cells = new Array();
            if (this.selectionmode.indexOf('cell') == -1) {
                var rows = this.selectedrowindexes;
                for (var j = 0; j < rows.length; j++) {
                    var index = rows[j];
                    for (var i = 0; i < this.columns.records.length; i++) {
                        var uniquekey = index + "_" + this.columns.records[i].datafield;
                        var cell = { rowindex: index, datafield: this.columns.records[i].datafield };
                        cells.push(cell);
                    }
                }
            }
            return cells;
        },

        deleteselection: function () {
            var self = this;
            var cells = self.getselectedcells();
            if (this.selectionmode.indexOf('cell') == -1) {
                cells = this._getcellsforcopypaste();
            }
            if (cells != null && cells.length > 0) {
                for (var cellIndex = 0; cellIndex < cells.length; cellIndex++) {
                    var cell = cells[cellIndex];
                    var column = self.getcolumn(cell.datafield);
                    var cellValue = self.getcellvalue(cell.rowindex, cell.datafield);
                    if (!column) continue;

                    if (cellValue !== "") {
                        var newvalue = null;
                        if (column.columntype == "checkbox") {
                            if (!column.threestatecheckbox) {
                                newvalue = false;
                            }
                        }
                        self._raiseEvent(17, { rowindex: cell.rowindex, datafield: cell.datafield, value: cellValue });
                        if (cellIndex == cells.length - 1) {
                            self.setcellvalue(cell.rowindex, cell.datafield, newvalue, true);
                            if (column.displayfield != column.datafield) {
                                self.setcellvalue(cell.rowindex, column.displayfield, newvalue, true);
                            }
                        }
                        else {
                            self.setcellvalue(cell.rowindex, cell.datafield, newvalue, false);
                            if (column.displayfield != column.datafield) {
                                self.setcellvalue(cell.rowindex, column.displayfield, newvalue, true);
                            } 
                        }
                        self._raiseEvent(18, { rowindex: cell.rowindex, datafield: cell.datafield, oldvalue: cellValue, value: newvalue });
                    }
                }
                this.dataview.updateview();
                this._renderrows(this.virtualsizeinfo);
            }
        },

        copyselection: function () {
            var selectedtext = "";
            var self = this;
            this.clipboardselection = {};
            this._clipboardselection = [];
            var cells = self.getselectedcells();
            if (this.selectionmode.indexOf('cell') == -1) {
                cells = this._getcellsforcopypaste();
            }

            if (cells != null && cells.length > 0) {
                var minrowindex = 999999999999999;
                var maxrowindex = -1;
                for (var cellIndex = 0; cellIndex < cells.length; cellIndex++) {
                    var cell = cells[cellIndex];
                    var column = self.getcolumn(cell.datafield);
                    if (column != null) {
                        var cellValue = self.getcellvalue(cell.rowindex, cell.datafield);
                        if (!this.clipboardselection[cell.rowindex]) this.clipboardselection[cell.rowindex] = {};
                        this.clipboardselection[cell.rowindex][cell.datafield] = cellValue;
                        minrowindex = Math.min(minrowindex, cell.rowindex);
                        maxrowindex = Math.max(maxrowindex, cell.rowindex);
                    }
                }
                for (var i = minrowindex; i <= maxrowindex; i++) {
                    var x = 0;
                    this._clipboardselection[this._clipboardselection.length] = new Array();
                    if (this.clipboardselection[i] != undefined) {
                        $.each(this.clipboardselection[i], function (index, value) {
                            if (x > 0) selectedtext += "\t";
                            var text = value;
                            if (value == null) text = "";
                            self._clipboardselection[self._clipboardselection.length - 1][x] = text;
                            x++;
                            selectedtext += text;
                        });
                    }
                    if (i < maxrowindex) {
                        selectedtext += '\n';
                    }
                }
            }
            this.clipboardselectedtext = selectedtext;
            return selectedtext;
        },

        pasteselection: function () {
            var cells = this.getselectedcells();
            if (this.selectionmode.indexOf('cell') == -1) {
                cells = this._getcellsforcopypaste();
            }
            if (cells != null && cells.length > 0) {
                var rowindex = cells[0].rowindex;
                var datafield = cells[0].datafield;
                var columnindex = this._getcolumnindex(datafield);
                var x = 0;
                if (!this._clipboardselection) return;
                for (var row = 0; row < this._clipboardselection.length; row++) {
                    for (var c = 0; c < this._clipboardselection[row].length; c++) {
                        var column = this.getcolumnat(columnindex + c);
                        if (!column) continue;

                        var cell = this.getcell(rowindex + row, column.datafield);
                        var cellvalue = null;
                        cellvalue = this._clipboardselection[row][c];
                        if (cellvalue != null) {
                            this._raiseEvent(17, { rowindex: rowindex + row, datafield: cell.datafield, value: cellvalue });
                            this.setcellvalue(cell.row, cell.column, cellvalue, false);
                            this._raiseEvent(18, { rowindex: rowindex + row, datafield: cell.datafield, oldvalue: this.getcellvalue(cell.rowindex, cell.datafield), value: cellvalue });
                            this._applycellselection(rowindex + row, cell.datafield, true, false);
                        }
                    }
                }

                this.dataview.updateview();
                this._renderrows(this.virtualsizeinfo);
            }
        },

        _applyrowselection: function (index, select, refresh, multiplerows, column) {
            if (index == null)
                return false;

            var oldindex = this.selectedrowindex;

            if (this.selectionmode == 'singlerow') {
                if (select) {
                    this._raiseEvent(2, { rowindex: index, row: this.getrowdata(index) });
                }
                else {
                    this._raiseEvent(3, { rowindex: index, row: this.getrowdata(index) });
                }

                this._raiseEvent(3, { rowindex: oldindex });
                this.selectedrowindexes = new Array();
                this.selectedcells = new Array();
            }

            if (multiplerows == true) {
                this.selectedrowindexes = new Array();
            }

            if (this.dataview.filters.length > 0) {
                var data = this.getrowdata(index);
                if (data && data.dataindex !== undefined) {
                    index = data.dataindex;
                }
                else if (data && data.dataindex === undefined) {
                    if (data.uid) {
                        index = this.getrowboundindexbyid(data.uid);

                    }
                }
            }

            var indexIn = this.selectedrowindexes.indexOf(index);

            if (select) {
                this.selectedrowindex = index;

                if (indexIn == -1) {
                    this.selectedrowindexes.push(index);

                    if (this.selectionmode != 'singlerow') {
                        this._raiseEvent(2, { rowindex: index, row: this.getrowdata(index) });
                    }
                }
                else if (this.selectionmode == 'multiplerows') {
                    this.selectedrowindexes.splice(indexIn, 1);
                    this._raiseEvent(3, { rowindex: this.selectedrowindex, row: this.getrowdata(index) });
                    this.selectedrowindex = this.selectedrowindexes.length > 0 ? this.selectedrowindexes[this.selectedrowindexes.length - 1] : -1;
                }
            }
            else if (indexIn >= 0 || this.selectionmode == 'singlerow' || this.selectionmode == 'multiplerowsextended' || this.selectionmode == 'multiplerowsadvanced') {
                var oldIndex = this.selectedrowindexes[indexIn];
                this.selectedrowindexes.splice(indexIn, 1);
                this._raiseEvent(3, { rowindex: oldIndex, row: this.getrowdata(index) });
                this.selectedrowindex = -1;
            }

            if (refresh == undefined || refresh) {
                this._rendervisualrows();
            }

            return true;
        },

        _applycellselection: function (index, column, select, refresh) {
            if (index == null)
                return false;

            if (column == null)
                return false;

            var oldindex = this.selectedrowindex;

            if (this.selectionmode == 'singlecell') {
                var oldcell = this.selectedcell;
                if (oldcell != null) {
                    this._raiseEvent(16, { rowindex: oldcell.rowindex, datafield: oldcell.datafield });
                }
                this.selectedcells = new Array();
            }

            if (this.selectionmode == 'multiplecellsextended' || this.selectionmode == 'multiplecellsadvanced') {
                var oldcell = this.selectedcell;
                if (oldcell != null) {
                    this._raiseEvent(16, { rowindex: oldcell.rowindex, datafield: oldcell.datafield });
                }
            }

            var uniquekey = index + "_" + column;
            if (this.dataview.filters.length > 0) {
                var data = this.getrowdata(index);
                if (data && data.dataindex !== undefined) {
                    index = data.dataindex;
                    var uniquekey = index + "_" + column;
                }
                else if (data && data.dataindex === undefined) {
                    if (data.uid) {
                        index = this.getrowboundindexbyid(data.uid);
                        var uniquekey = index + "_" + column;
                    }
                }
            }

            var cell = { rowindex: index, datafield: column };
            if (select) {
                this.selectedcell = cell;
                if (!this.selectedcells[uniquekey]) {
                    this.selectedcells[uniquekey] = cell;
                    this.selectedcells.length++;
                    this._raiseEvent(15, cell);
                }
                else if (this.selectionmode == "multiplecells" || this.selectionmode == 'multiplecellsextended' || this.selectionmode == 'multiplecellsadvanced') {
                    delete this.selectedcells[uniquekey];
                    if (this.selectedcells.length > 0) {
                        this.selectedcells.length--;
                    }
                    this._raiseEvent(16, cell);
                }
            }
            else {
                delete this.selectedcells[uniquekey];
                if (this.selectedcells.length > 0) {
                    this.selectedcells.length--;
                }

                this._raiseEvent(16, cell);
            }

            if (refresh == undefined || refresh) {
                this._rendervisualrows();
            }

            return true;
        },

        _getcellindex: function (uniquekey) {
            var id = -1;
            $.each(this.selectedcells, function () {
                id++;
                if (this[uniquekey]) {
                    return false;
                }
            });
            return id;
        },

        _clearhoverstyle: function () {
            if (undefined == this.hoveredrow || this.hoveredrow == -1)
                return;

            if (this.vScrollInstance.isScrolling())
                return;

            if (this.hScrollInstance.isScrolling())
                return;

            var cells = this.table.find('.jqx-grid-cell-hover');

            if (cells.length > 0) {
                cells.removeClass(this.toTP('jqx-grid-cell-hover'));
                cells.removeClass(this.toTP('jqx-fill-state-hover'));
            }
            this.hoveredrow = -1;
        },

        _clearselectstyle: function () {
            var rowscount = this.table[0].rows.length;
            var rows = this.table[0].rows;
            var selectclass = this.toTP('jqx-grid-cell-selected');
            var selectclass2 = this.toTP('jqx-fill-state-pressed');
            var hoverclass = this.toTP('jqx-grid-cell-hover');
            var hoverclass2 = this.toTP('jqx-fill-state-hover');

            for (var i = 0; i < rowscount; i++) {
                var tablerow = rows[i];
                var cellslength = tablerow.cells.length;
                var cells = tablerow.cells;
                for (var j = 0; j < cellslength; j++) {
                    var tablecell = cells[j];
                    var $tablecell = $(tablecell);
                    if (tablecell.className.indexOf('jqx-grid-cell-selected') != -1) {
                        $tablecell.removeClass(selectclass);
                        $tablecell.removeClass(selectclass2);
                    }

                    if (tablecell.className.indexOf('jqx-grid-cell-hover') != -1) {
                        $tablecell.removeClass(hoverclass);
                        $tablecell.removeClass(hoverclass2);
                    }
                }
            }
        },

        _selectpath: function (row, column) {
            var self = this;
            var minRow = this._lastClickedCell ? Math.min(this._lastClickedCell.row, row) : 0;
            var maxRow = this._lastClickedCell ? Math.max(this._lastClickedCell.row, row) : 0;
            if (minRow <= maxRow) {
                var index1 = this._getcolumnindex(this._lastClickedCell.column);
                var index2 = this._getcolumnindex(column);
                var minColumn = Math.min(index1, index2);
                var maxColumn = Math.max(index1, index2);
                this.selectedcells = new Array();
                var rows = this.dataview.loadedrecords;

                for (var r = minRow; r <= maxRow; r++) {
                    for (var c = minColumn; c <= maxColumn; c++) {
                        var row = rows[r];
                        this._applycellselection(self.getboundindex(row), self._getcolumnat(c).datafield, true, false);
                    }
                }
                this._rendervisualrows();
            }
        },

        _selectrowpath: function (row) {     
            if (this.selectionmode == 'multiplerowsextended') {
                var self = this;
                var minRow = this._lastClickedCell ? Math.min(this._lastClickedCell.row, row) : 0;
                var maxRow = this._lastClickedCell ? Math.max(this._lastClickedCell.row, row) : 0;
                var rows = this.dataview.loadedrecords;
                if (minRow <= maxRow) {
                    this.selectedrowindexes = new Array();
                    for (var r = minRow; r <= maxRow; r++) {
                        var row = rows[r];
                        var boundIndex = this.getrowboundindex(r);
                        this._applyrowselection(boundIndex, true, false);
                    }
                    this._rendervisualrows();
                }
            }
        },

        _selectrowwithmouse: function (self, rowinfo, oldindexes, column, ctrlKey, shiftKey) {
            var row = rowinfo.row;

            if (row == undefined)
                return;

            var index = rowinfo.index;

            if (this.hittestinfo[index] == undefined) {
                return;
            }

            var tablerow = this.hittestinfo[index].visualrow;

            if (this.hittestinfo[index].details) {
                return;
            }

            var cellclass = tablerow.cells[0].className;
            if (row.group) {
                return;
            }

            if (this.selectionmode == 'multiplerows' || this.selectionmode == 'multiplecells' || this.selectionmode == 'checkbox' || (this.selectionmode.indexOf('multiple') != -1 && (shiftKey == true || ctrlKey == true))) {
                var boundindex = this.getboundindex(row);
                if (this.dataview.filters.length > 0) {
                    var data = this.getrowdata(boundindex);
                    if (data) {
                        boundindex = data.dataindex;
                        if (boundindex == undefined) {
                            var boundindex = this.getboundindex(row);
                        }
                    }
                }

                var hasindex = oldindexes.indexOf(boundindex) != -1;
                var key = this.getboundindex(row) + "_" + column;

                if (this.selectionmode.indexOf('cell') != -1) {
                    var hascellindex = this.selectedcells[key] != undefined;
                    if (this.selectedcells[key] != undefined && hascellindex) {
                        this._selectcellwithstyle(self, false, index, column, tablerow);
                    }
                    else {
                        this._selectcellwithstyle(self, true, index, column, tablerow);
                    }
                    if (shiftKey && this._lastClickedCell == undefined) {
                        var cells = this.getselectedcells();
                        if (cells && cells.length > 0) {
                            this._lastClickedCell = { row: cells[0].rowindex, column: cells[0].datafield };
                        }
                    }
                    if (shiftKey && this._lastClickedCell) {
                        this._selectpath(row.visibleindex, column);
                        this.mousecaptured = false;
                        if (this.selectionarea.css('visibility') == 'visible') {
                            this.selectionarea.css('visibility', 'hidden');
                        }
                    }
                }
                else {
                    if (hasindex) {
                        if (ctrlKey) {
                            this._applyrowselection(this.getboundindex(row), false);
                        }
                        else {
                            this._selectrowwithstyle(self, tablerow, false, column);
                        }
                    }
                    else {
                        this._selectrowwithstyle(self, tablerow, true, column);
                    }

                    if (shiftKey && this._lastClickedCell == undefined) {
                        var indexes = this.getselectedrowindexes();
                        if (indexes && indexes.length > 0) {
                            this._lastClickedCell = { row: indexes[0], column: column };
                        }
                    }
                    if (shiftKey && this._lastClickedCell) {
                        this.selectedrowindexes = new Array();
                        var minRow = this._lastClickedCell ? Math.min(this._lastClickedCell.row, row.visibleindex) : 0;
                        var maxRow = this._lastClickedCell ? Math.max(this._lastClickedCell.row, row.visibleindex) : 0;
                        var rows = this.dataview.loadedrecords;

                        for (var r = minRow; r <= maxRow; r++) {
                            var row = rows[r];
                            this._applyrowselection(this.getboundindex(row), true, false, false);
                        }
                        this._rendervisualrows();
                    }
                }
            }
            else {
                this._clearselectstyle();
                this._selectrowwithstyle(self, tablerow, true, column);
                if (this.selectionmode.indexOf('cell') != -1) {
                    this._selectcellwithstyle(self, true, index, column, tablerow);
                }
            }
            if (!shiftKey) {
                this._lastClickedCell = { row: row.visibleindex, column: column };
            }
        },

        _selectcellwithstyle: function (self, select, row, column, tablerow) {
            var cell = $(tablerow.cells[self._getcolumnindex(column)]);
            cell.removeClass(this.toTP('jqx-grid-cell-hover'));
            cell.removeClass(this.toTP('jqx-fill-state-hover'));
            if (select) {
                cell.addClass(this.toTP('jqx-grid-cell-selected'));
                cell.addClass(this.toTP('jqx-fill-state-pressed'));
            }
            else {
                cell.removeClass(this.toTP('jqx-grid-cell-selected'));
                cell.removeClass(this.toTP('jqx-fill-state-pressed'));
            }
        },

        _selectrowwithstyle: function (self, tablerow, select, column) {
            var cellslength = tablerow.cells.length;

            var startindex = 0;
            if (self.rowdetails && self.showrowdetailscolumn) {
                if (!this.rtl) {
                    startindex = 1 + this.groups.length;
                }
                else {
                    cellslength -= 1;
                    cellslength -= this.groups.length;
                }
            }
            else if (this.groupable) {
                if (!this.rtl) {
                    startindex = this.groups.length;
                }
                else {
                    cellslength -= this.groups.length;
                }
            }

            for (var i = startindex; i < cellslength; i++) {
                var tablecell = tablerow.cells[i];
                if (select) {
                    $(tablecell).removeClass(this.toTP('jqx-grid-cell-hover'));
                    $(tablecell).removeClass(this.toTP('jqx-fill-state-hover'));

                    if (self.selectionmode.indexOf('cell') == -1) {
                        $(tablecell).addClass(this.toTP('jqx-grid-cell-selected'));
                        $(tablecell).addClass(this.toTP('jqx-fill-state-pressed'));
                    }
                }
                else {
                    $(tablecell).removeClass(this.toTP('jqx-grid-cell-hover'));
                    $(tablecell).removeClass(this.toTP('jqx-grid-cell-selected'));
                    $(tablecell).removeClass(this.toTP('jqx-fill-state-hover'));
                    $(tablecell).removeClass(this.toTP('jqx-fill-state-pressed'));
                }
            }
        },

        _handlemousemoveselection: function (event, self) {
            if ((self.selectionmode == 'multiplerowsextended' || self.selectionmode == 'multiplecellsextended' || self.selectionmode == 'multiplecellsadvanced') && self.mousecaptured) {
                if (self.multipleselectionbegins) {
                    var canSelectMultipleRows = self.multipleselectionbegins(event);
                    if (canSelectMultipleRows === false) {
                        return true;
                    }
                }

                var columnheaderheight = this.showheader ? this.columnsheader.height() + 2 : 0;
                var groupsheaderheight = this._groupsheader() ? this.groupsheader.height() : 0;
                var toolbarheight = this.showtoolbar ? this.toolbarheight : 0;
                groupsheaderheight += toolbarheight;
                var hostoffset = this.host.coord();
                if (this.hasTransform) {
                    hostoffset = $.jqx.utilities.getOffset(this.host);
                    var bodyOffset = this._getBodyOffset();
                    hostoffset.left -= bodyOffset.left;
                    hostoffset.top -= bodyOffset.top;
                }
                var x = event.pageX;
                var y = event.pageY - groupsheaderheight;

                if (Math.abs(this.mousecaptureposition.left - x) > 3 || Math.abs(this.mousecaptureposition.top - y) > 3) {
                    var columnheadertop = parseInt(this.columnsheader.coord().top);
                    if (this.hasTransform) {
                        columnheadertop = $.jqx.utilities.getOffset(this.columnsheader).top;
                    }
                    if (x < hostoffset.left) {
                        x = hostoffset.left;
                    }

                    if (x > hostoffset.left + this.host.width()) {
                        x = hostoffset.left + this.host.width();
                    }
                    var columnheaderbottom = hostoffset.top + columnheaderheight;
                    if (y < columnheaderbottom) y = columnheaderbottom + 5;
                    var rectleft = parseInt(Math.min(self.mousecaptureposition.left, x));
                    var recttop = -5 + parseInt(Math.min(self.mousecaptureposition.top, y));
                    var rectwidth = parseInt(Math.abs(self.mousecaptureposition.left - x));
                    var rectheight = parseInt(Math.abs(self.mousecaptureposition.top - y));
                    rectleft -= hostoffset.left;
                    recttop -= hostoffset.top;

                    this.selectionarea.css('visibility', 'visible');

                    if (self.selectionmode == 'multiplecellsadvanced') {
                        var x = rectleft;
                        var arearight = x + rectwidth;
                        var arealeft = x;
                        var hScrollInstance = self.hScrollInstance;
                        var horizontalscrollvalue = hScrollInstance.value;
                        if (this.rtl) {
                            if (this.hScrollBar.css('visibility') != 'hidden') {
                                horizontalscrollvalue = hScrollInstance.max - hScrollInstance.value;
                            }
                            if (this.vScrollBar[0].style.visibility != 'hidden') {
                          //      horizontalscrollvalue -= this.scrollbarsize + 4;
                            }
                        }
                        var tablerow = self.table[0].rows[0];
                        var p = 0;

                        var leftcellindex = self.mousecaptureposition.clickedcell;
                        var rightcellindex = leftcellindex;
                        var found = false;

                        var starti = 0;
                        var endi = tablerow.cells.length;
                        if (self.mousecaptureposition.left <= event.pageX) {
                            starti = leftcellindex;
                        }

                        for (var i = starti; i < endi; i++) {
                            var columnleft = parseInt($(this.columnsrow[0].cells[i]).css('left'));
                            var left = columnleft - horizontalscrollvalue;
                            if (self.columns.records[i].pinned) {
                                left = columnleft;
                                continue;
                            }

                            var column = this._getcolumnat(i);
                            if (column != null && column.hidden) {
                                continue;
                            }

                            if (self.groupable && self.groups.length > 0) {
                                if (i < self.groups.length) {
                                    continue;
                                }
                            }

                            var right = left + $(this.columnsrow[0].cells[i]).width();
                            if (self.mousecaptureposition.left > event.pageX) {
                                if (right >= x && x >= left) {
                                    rightcellindex = i;
                                    found = true;
                                    break;
                                }
                            }
                            else {
                                if (right >= arearight && arearight >= left) {
                                    rightcellindex = i;
                                    found = true;
                                    break;
                                }
                            }
                        }
                        if (!found) {
                            if (self.mousecaptureposition.left > event.pageX) {
                                $.each(this.columns.records, function (index, value) {
                                    if (self.groupable && self.groups.length > 0) {
                                        if (index < self.groups.length) {
                                            return true;
                                        }
                                    }

                                    if (!this.pinned && !this.hidden) {
                                        rightcellindex = index;
                                        return false;
                                    }
                                });
                            }
                            else {
                                if (!self.groupable || (self.groupable && !self.groups.length > 0)) {
                                    rightcellindex = tablerow.cells.length - 1;
                                }
                            }
                        }
                        var tmpindex = leftcellindex;
                        leftcellindex = Math.min(leftcellindex, rightcellindex);
                        rightcellindex = Math.max(tmpindex, rightcellindex);
                        recttop += 5;
                        recttop += groupsheaderheight;
                        var startrowindex = self.table[0].rows.indexOf(self.mousecaptureposition.clickedrow);
                        var increaseheight = 0;
                        var startrow = -1;
                        var endrow = -1;
                        var offsettop = 0;
                        for (var i = 0; i < self.table[0].rows.length; i++) {
                            var row = $(self.table[0].rows[i]);
                            if (i == 0) offsettop = row.coord().top;
                            var rowheight = row.height();
                            var rowtop = offsettop - hostoffset.top;
                            if (startrow == -1 && rowtop + rowheight >= recttop) {
                                var toContinue = false;
                                for (var q = 0; q < self.groups.length; q++) {
                                    var className = row[0].cells[q].className;
                                    if (className.indexOf('jqx-grid-group-collapse') != -1 || className.indexOf('jqx-grid-group-expand') != -1) {
                                        toContinue = true;
                                        break;
                                    }
                                }
                                if (toContinue) continue;


                                startrow = i;
                            }
                            offsettop += rowheight;

                            if (self.groupable && self.groups.length > 0) {
                                var toContinue = false;
                                for (var q = 0; q < self.groups.length; q++) {
                                    var className = row[0].cells[q].className;
                                    if (className.indexOf('jqx-grid-group-collapse') != -1 || className.indexOf('jqx-grid-group-expand') != -1) {
                                        toContinue = true;
                                        break;
                                    }
                                }
                                if (toContinue) continue;

                                var p = 0;
                                for (var k = self.groups.length; k < row[0].cells.length; k++) {
                                    var cell = row[0].cells[k];
                                    if ($(cell).html() == "") {
                                        p++;
                                    }
                                }
                                if (p == row[0].cells.length - self.groups.length) {
                                    continue;
                                }
                            }

                            if (startrow != -1) {
                                increaseheight += rowheight;
                            }

                            if (rowtop + rowheight > recttop + rectheight) {
                                endrow = i;
                                break;
                            }
                        }


                        if (startrow != -1) {
                            recttop = $(self.table[0].rows[startrow]).coord().top - hostoffset.top - groupsheaderheight - 2;
                            var additionalHeight = 0;
                            if (this.filterable && this.showfilterrow) {
                                additionalHeight = this.filterrowheight;
                            }

                            if (parseInt(self.table[0].style.top) < 0 && recttop < this.rowsheight + additionalHeight) {
                                recttop -= parseInt(self.table[0].style.top);
                                increaseheight += parseInt(self.table[0].style.top);
                            }

                            rectheight = increaseheight;
                            var leftcell = $(this.columnsrow[0].cells[leftcellindex]);
                            var rightcell = $(this.columnsrow[0].cells[rightcellindex]);
                            rectleft = parseInt(leftcell.css('left'));
                            rectwidth = parseInt(rightcell.css('left')) - parseInt(rectleft) + rightcell.width() - 2;
                            rectleft -= horizontalscrollvalue;
                            if (self.editcell && self.editable && self.endcelledit && (leftcellindex != rightcellindex || startrow != endrow)) {
                                if (self.editcell.validated == false) return;
                                self.endcelledit(self.editcell.row, self.editcell.column, true, true);
                            }
                        }
                    }

                    this.selectionarea.width(rectwidth);
                    this.selectionarea.height(rectheight);
                    this.selectionarea.css('left', rectleft);
                    this.selectionarea.css('top', recttop);
                }
            }
        },

        _handlemouseupselection: function (event, self) {
            if (!this.selectionarea) return;

            if (this.selectionarea.css('visibility') != 'visible') {
                self.mousecaptured = false;
                return true;
            }

            if (self.mousecaptured && (self.selectionmode == 'multiplerowsextended' || self.selectionmode == 'multiplerowsadvanced' || self.selectionmode == 'multiplecellsextended' || self.selectionmode == 'multiplecellsadvanced')) {
                self.mousecaptured = false;
                if (this.selectionarea.css('visibility') == 'visible') {
                    this.selectionarea.css('visibility', 'hidden');

                    var columnheaderheight = this.showheader ? this.columnsheader.height() + 2 : 0;
                    var groupsheaderheight = this._groupsheader() ? this.groupsheader.height() : 0;
                    var toolbarheight = this.showtoolbar ? this.toolbarheight : 0;
                    groupsheaderheight += toolbarheight;
                    var areaoffset = this.selectionarea.coord();
                    var hostoffset = this.host.coord();
                    if (this.hasTransform) {
                        hostoffset = $.jqx.utilities.getOffset(this.host);
                        areaoffset = $.jqx.utilities.getOffset(this.selectionarea);
                    }

                    var x = areaoffset.left - hostoffset.left;
                    var y = areaoffset.top - columnheaderheight - hostoffset.top - groupsheaderheight;
                    var m = y;
                    var arearight = x + this.selectionarea.width();
                    var arealeft = x;

                    var rows = new Array();
                    var indexes = new Array();

                    if (self.selectionmode == 'multiplerowsextended') {
                        while (y < m + this.selectionarea.height()) {
                            var rowinfo = this._hittestrow(x, y);
                            var row = rowinfo.row;
                            var index = rowinfo.index;
                            if (index != -1) {
                                if (!indexes[index]) {
                                    indexes[index] = true;
                                    rows[rows.length] = rowinfo;
                                }
                            }
                            y += 20;
                        }
                        var m = 0;
                        $.each(rows, function () {
                            var rowinfo = this;
                            var row = this.row;
                            if (self.selectionmode != 'none' && self._selectrowwithmouse) {
                                if (event.ctrlKey) {
                                    self._applyrowselection(self.getboundindex(row), true, false, false);
                                }
                                else {
                                    if (m == 0) {
                                        self._applyrowselection(self.getboundindex(row), true, false, true);
                                    }
                                    else {
                                        self._applyrowselection(self.getboundindex(row), true, false, false);
                                    }
                                }
                                m++;
                            }
                        });
                    }
                    else {
                        if (self.selectionmode == 'multiplecellsadvanced') {
                            y += 2;
                        }
                        var hScrollInstance = self.hScrollInstance;
                        var horizontalscrollvalue = hScrollInstance.value;
                        if (this.rtl) {
                            if (this.hScrollBar.css('visibility') != 'hidden') {
                                horizontalscrollvalue = hScrollInstance.max - hScrollInstance.value;
                            }
                            if (this.vScrollBar[0].style.visibility != 'hidden') {
                                horizontalscrollvalue -= this.scrollbarsize + 4;
                            }
                        }
                        var tablerow = self.table[0].rows[0];
                        var selectionheight = self.selectionarea.height();
                        if (!event.ctrlKey && selectionheight > 0) {
                            self.selectedcells = new Array();
                        }

                        var selectionHeight = selectionheight;
                        while (y < m + selectionHeight) {
                            var rowinfo = self._hittestrow(x, y);
                            var row = rowinfo.row;
                            var index = rowinfo.index;
                            if (index != -1) {
                                if (!indexes[index]) {
                                    indexes[index] = true;
                                    for (var i = 0; i < tablerow.cells.length; i++) {
                                        var left = parseInt($(self.columnsrow[0].cells[i]).css('left')) - horizontalscrollvalue;
                                        var right = left + $(self.columnsrow[0].cells[i]).width();
                                        if ((arealeft >= left && arealeft <= right) || (arearight >= left && arearight <= right)
                                        || (left >= arealeft && left <= arearight)) {
                                            self._applycellselection(self.getboundindex(row), self._getcolumnat(i).datafield, true, false);
                                        }
                                    }
                                }
                            }
                            y += 5;
                        }
                    }
                    if (self.autosavestate) {
                        if (self.savestate) self.savestate();
                    }
                    self._renderrows(self.virtualsizeinfo);
                }
            }
        },

        selectprevcell: function (row, datafield) {
            var columnindex = this._getcolumnindex(datafield);
            var columnscount = this.columns.records.length;
            var prevcolumn = this._getprevvisiblecolumn(columnindex);
            if (prevcolumn != null) {
                this.clearselection();
                this.selectcell(row, prevcolumn.datafield);
            }
        },

        selectnextcell: function (row, datafield) {
            var columnindex = this._getcolumnindex(datafield);
            var columnscount = this.columns.records.length;
            var nextcolumn = this._getnextvisiblecolumn(columnindex);
            if (nextcolumn != null) {
                this.clearselection();
                this.selectcell(row, nextcolumn.datafield);
            }
        },

        _getfirstvisiblecolumn: function () {
            var self = this;
            var length = this.columns.records.length;
            for (var i = 0; i < length; i++) {
                var column = this.columns.records[i];
                if (!column.hidden && column.datafield != null)
                    return column;
            }

            return null;
        },

        _getlastvisiblecolumn: function () {
            var self = this;
            var length = this.columns.records.length;
            for (var i = length - 1; i >= 0; i--) {
                var column = this.columns.records[i];
                if (!column.hidden && column.datafield != null)
                    return column;
            }

            return null;
        },

        _handlekeydown: function (event, self) {
            if (self.groupable) {
                return true;
            }

            var key = event.charCode ? event.charCode : event.keyCode ? event.keyCode : 0;
            if (self.editcell && self.selectionmode != 'multiplecellsadvanced') {
                return true;
            }
            else if (self.editcell && self.selectionmode == 'multiplecellsadvanced') {
                if (key >= 33 && key <= 40) {
                    if (!event.altKey) {
                        if (self._cancelkeydown == undefined || self._cancelkeydown == false) {
                            if (self.editmode !== "selectedrow") {
                                self.endcelledit(self.editcell.row, self.editcell.column, false, true);
                                self._cancelkeydown = false;
                                if (self.editcell && !self.editcell.validated) {
                                    self._rendervisualrows();
                                    self.endcelledit(self.editcell.row, self.editcell.column, false, true);
                                    return false;
                                }
                            }
                            else {
                                return true;
                            }
                        }
                        else {
                            self._cancelkeydown = false;
                            return true;
                        }
                    }
                    else {
                        self._cancelkeydown = false;
                        return true;
                    }
                }
                else return true;
            }

            if (self.selectionmode == 'none')
                return true;

            if (self.showfilterrow && self.filterable) {
                if (this.filterrow) {
                    if ($(event.target).ischildof(this.filterrow))
                        return true;
                }
            }

            if (self.pageable) {
                if ($(event.target).ischildof(this.pager)) {
                    return true;
                }
            }

            if (this.showtoolbar) {
                if ($(event.target).ischildof(this.toolbar)) {
                    return true;
                }
            }
            if (this.showstatusbar) {
                if ($(event.target).ischildof(this.statusbar)) {
                    return true;
                }
            }

            var selectionchanged = false;
            if (event.altKey) {
                return true;
            }

            if (event.ctrlKey) {
                if (this.clipboard) {
                    var pressedkey = String.fromCharCode(key).toLowerCase();

                    if (pressedkey == 'c' || pressedkey == 'x') {
                        var text = this.copyselection();
                        if (window.clipboardData) {
                            window.clipboardData.setData("Text", text);
                        }
                    }
                    else if (pressedkey == 'v') {
                        this.pasteselection();
                    }
                    if (pressedkey == 'x') {
                        this.deleteselection();
                    }
                }
            }

            var hostHeight = Math.round(self._gettableheight());
            // get records per page.
            var pagesize = Math.round(hostHeight / self.rowsheight);
            var datainfo = self.getdatainformation();

            switch (self.selectionmode) {
                case 'singlecell':
                case 'multiplecells':
                case 'multiplecellsextended':
                case 'multiplecellsadvanced':
                    var selectedcell = self.getselectedcell();

                    if (selectedcell != null) {
                        var visibleindex = this.getrowvisibleindex(selectedcell.rowindex);
                        var rowindex = visibleindex;
                        var datafield = selectedcell.datafield;
                        var columnindex = self._getcolumnindex(datafield);
                        var columnscount = self.columns.records.length;
                        var selectgridcell = function (row, datafield, clearselection) {
                            var tryselect = function (row, datafield) {
                                var datarow = self.dataview.loadedrecords[row];
                                if (datarow != undefined && datafield != null) {
                                    if (clearselection || clearselection == undefined) {
                                        self.clearselection();
                                    }
                                    var visibleindex = self.getboundindex(datarow);
                                    self.selectcell(visibleindex, datafield);
                                    self._oldselectedcell = self.selectedcell;
                                    selectionchanged = true;
                                    self.ensurecellvisible(row, datafield);
                                    return true;
                                }
                                return false;
                            }

                            if (!tryselect(row, datafield)) {
                                self.ensurecellvisible(row, datafield);
                                tryselect(row, datafield);
                                if (self.virtualmode) {
                                    self.host.focus();
                                }
                            }

                            if (event.shiftKey && key != 9) {
                                if (self.selectionmode == 'multiplecellsextended' || self.selectionmode == 'multiplecellsadvanced') {
                                    if (self._lastClickedCell) {
                                        self._selectpath(row, datafield);
                                        self.selectedcell = { rowindex: row, datafield: datafield };
                                        return;
                                    }
                                }
                            }
                            else if (!event.shiftKey) {
                                self._lastClickedCell = { row: row, column: datafield };
                            }
                        }
                        var shift = event.shiftKey && self.selectionmode != 'singlecell' && self.selectionmode != 'multiplecells';
                        var home = function () {
                            selectgridcell(0, datafield, !shift);
                        }
                        var end = function () {
                            var newindex = datainfo.rowscount - 1;
                            selectgridcell(newindex, datafield, !shift);
                        }

                        var tab = key == 9 && !event.shiftKey;
                        var shifttab = key == 9 && event.shiftKey;
                        if (tab || shifttab) shift = false;
                        var ctrl = event.ctrlKey;
                        if (ctrl && key == 37) {
                            var previouscolumn = self._getfirstvisiblecolumn(columnindex);
                            if (previouscolumn != null) {
                                selectgridcell(rowindex, previouscolumn.datafield);
                            }
                        }
                        else if (ctrl && key == 39) {
                            var next = self._getlastvisiblecolumn(columnindex);
                            if (next != null) {
                                selectgridcell(rowindex, next.datafield);
                            }
                        }
                        else if (key == 39 || tab) {
                            var nextcolumn = self._getnextvisiblecolumn(columnindex);
                            if (nextcolumn != null) {
                                selectgridcell(rowindex, nextcolumn.datafield, !shift);
                            }
                            else {
                                if (!tab) {
                                    selectionchanged = true;
                                }
                            }
                        }
                        else if (key == 37 || shifttab) {
                            var previouscolumn = self._getprevvisiblecolumn(columnindex);
                            if (previouscolumn != null) {
                                selectgridcell(rowindex, previouscolumn.datafield, !shift);
                            }
                            else {
                                if (!shifttab) {
                                    selectionchanged = true;
                                }
                            }
                        }
                        else if (key == 36) {
                            home();
                        }
                        else if (key == 35) {
                            end();
                        }
                        else if (key == 33) {
                            if (rowindex - pagesize >= 0) {
                                var newindex = rowindex - pagesize;
                                selectgridcell(newindex, datafield, !shift);
                            }
                            else {
                                home();
                            }
                        }
                        else if (key == 34) {
                            if (datainfo.rowscount > rowindex + pagesize) {
                                var newindex = rowindex + pagesize;
                                selectgridcell(newindex, datafield, !shift);
                            }
                            else {
                                end();
                            }
                        }
                        else if (key == 38) {
                            if (ctrl) {
                                home();
                            }
                            else {
                                if (rowindex > 0) {
                                    selectgridcell(rowindex - 1, datafield, !shift);
                                }
                                else selectionchanged = true;
                            }
                        }
                        else if (key == 40) {
                            if (ctrl) {
                                end();
                            }
                            else {
                                if (datainfo.rowscount > rowindex + 1) {
                                    selectgridcell(rowindex + 1, datafield, !shift);
                                }
                                else selectionchanged = true;
                            }
                        }
                    }
                    break;
                case 'singlerow':
                case 'multiplerows':
                case 'multiplerowsextended':
                case 'multiplerowsadvanced':
                    var rowindex = self.getselectedrowindex();
                    if (rowindex == null || rowindex == -1)
                        return true;

                    rowindex = this.getrowvisibleindex(rowindex);
                    var selectgridrow = function (index, clearselection) {
                        var tryselect = function (index) {
                            var datarecord = self.dataview.loadedrecords[index];

                            if (datarecord != undefined) {
                                var visibleindex = self.getboundindex(datarecord);
                                var tmpindex = self.selectedrowindex;
                                if (clearselection || clearselection == undefined) {
                                    self.clearselection();
                                }
                                self.selectedrowindex = tmpindex;
                                self.selectrow(visibleindex, false);
                                var scrolled = self.ensurerowvisible(index);
                                if (!scrolled || self.autoheight || self.groupable) {
                                    self._rendervisualrows();
                                }
                                selectionchanged = true;
                                return true;
                            }

                            return false;
                        }
                        if (!tryselect(index)) {
                            self.ensurerowvisible(index);
                            tryselect(index, clearselection);
                            if (self.virtualmode) {
                                self.host.focus();
                            }
                        }
                        if (event.shiftKey && key != 9) {
                            if (self.selectionmode == 'multiplerowsextended') {
                                if (self._lastClickedCell) {
                                    self._selectrowpath(index);
                                    self.selectedrowindex = self.getrowboundindex(index);
                                    return;
                                }
                            }
                        }
                        else if (!event.shiftKey) {
                            self._lastClickedCell = { row: index };
                            self.selectedrowindex = self.getrowboundindex(index);
                        }
                    }
                    var shift = event.shiftKey && self.selectionmode != 'singlerow' && self.selectionmode != 'multiplerows';

                    var home = function () {
                        selectgridrow(0, !shift);
                    }
                    var end = function () {
                        var newindex = datainfo.rowscount - 1;
                        selectgridrow(newindex, !shift);
                    }

                    var ctrl = event.ctrlKey;
                    if (key == 36 || (ctrl && key == 38)) {
                        home();
                    }
                    else if (key == 35 || (ctrl && key == 40)) {
                        end();
                    }
                    else if (key == 33) {
                        if (rowindex - pagesize >= 0) {
                            var newindex = rowindex - pagesize;
                            selectgridrow(newindex, !shift);
                        }
                        else {
                            home();
                        }
                    }
                    else if (key == 34) {
                        if (datainfo.rowscount > rowindex + pagesize) {
                            var newindex = rowindex + pagesize;
                            selectgridrow(newindex, !shift);
                        }
                        else {
                            end();
                        }
                    }
                    else if (key == 38) {
                        if (rowindex > 0) {
                            selectgridrow(rowindex - 1, !shift);
                        }
                        else selectionchanged = true;
                    }
                    else if (key == 40) {
                        if (datainfo.rowscount > rowindex + 1) {
                            selectgridrow(rowindex + 1, !shift);
                        }
                        else selectionchanged = true;
                    }
                    break;
            }

            if (selectionchanged) {
                if (self.autosavestate) {
                    if (self.savestate) self.savestate();
                }

                //if (self.editcell != null && self.endcelledit) {
                //    self.endcelledit(self.editcell.row, self.editcell.column, true, true);
                //}
                return false;
            }
            return true;
        },

        _handlemousemove: function (event, self) {
            if (self.vScrollInstance.isScrolling())
                return;

            if (self.hScrollInstance.isScrolling())
                return;

            var columnheaderheight;
            var groupsheaderheight;
            var hostoffset;
            var x;
            var y;

            if (self.enablehover || self.selectionmode == 'multiplerows') {
                columnheaderheight = this.showheader ? this.columnsheader.height() + 2 : 0;
                groupsheaderheight = this._groupsheader() ? this.groupsheader.height() : 0;
                var toolbarheight = this.showtoolbar ? this.toolbarheight : 0;
                groupsheaderheight += toolbarheight;
                hostoffset = this.host.coord();
                if (this.hasTransform) {
                    hostoffset = $.jqx.utilities.getOffset(this.host);
                    var bodyOffset = this._getBodyOffset();
                    hostoffset.left -= bodyOffset.left;
                    hostoffset.top -= bodyOffset.top;
                }
                x = event.pageX - hostoffset.left;
                y = event.pageY - columnheaderheight - hostoffset.top - groupsheaderheight;
            }

            if (self.selectionmode == 'multiplerowsextended' || self.selectionmode == 'multiplecellsextended' || self.selectionmode == 'multiplecellsadvanced') {
                if (self.mousecaptured == true) {
                    return;
                }
            }

            if (self.enablehover) {
                if (self.disabled) {
                    return;
                }

                if (this.vScrollInstance.isScrolling() || this.hScrollInstance.isScrolling()) {
                    return;
                }

                var rowinfo = this._hittestrow(x, y);
                if (!rowinfo)
                    return;

                var row = rowinfo.row;
                var index = rowinfo.index;

                // if the new index is the same as the last, do nothing.
                if (this.hoveredrow != -1 && index != -1 && this.hoveredrow == index && this.selectionmode.indexOf('cell') == -1 && this.selectionmode != 'checkbox') {
                    return;
                }

                this._clearhoverstyle();

                if (index == -1 || row == undefined)
                    return;

                var tablerow = this.hittestinfo[index].visualrow;
                if (tablerow == null)
                    return;

                if (this.hittestinfo[index].details) {
                    return;
                }

                if (event.clientX > $(tablerow).width() + $(tablerow).coord().left) return;

                var startindex = 0;
                var cellslength = tablerow.cells.length;
                if (self.rowdetails && self.showrowdetailscolumn) {
                    if (!this.rtl) {
                        startindex = 1 + this.groups.length;
                    }
                    else {
                        cellslength -= 1;
                        cellslength -= this.groups.length;
                    }
                }
                else if (this.groupable) {
                    if (!this.rtl) {
                        startindex = this.groups.length;
                    }
                    else {
                        cellslength -= this.groups.length;
                    }
                }

                if (tablerow.cells.length == 0)
                    return;

                var cellclass = tablerow.cells[startindex].className;
                if (row.group || (this.selectionmode.indexOf('row') >= 0 && cellclass.indexOf('jqx-grid-cell-selected') != -1))
                    return;

                this.hoveredrow = index;

                if (this.selectionmode.indexOf('cell') != -1 || this.selectionmode == "checkbox") {
                    var cellindex = -1;
                    var hScrollInstance = this.hScrollInstance;
                    var horizontalscrollvalue = hScrollInstance.value;
                    if (this.rtl) {
                        if (this.hScrollBar.css('visibility') != 'hidden') {
                            horizontalscrollvalue = hScrollInstance.max - hScrollInstance.value;
                        }
                    }
   
                    for (var i = startindex; i < cellslength; i++) {
                        var left = parseInt($(this.columnsrow[0].cells[i]).css('left')) - horizontalscrollvalue;
                        var right = left + $(this.columnsrow[0].cells[i]).width();
                        if (right >= x && x >= left) {
                            cellindex = i;
                            break;
                        }
                    }

                    if (cellindex != -1) {
                        var tablecell = tablerow.cells[cellindex];
                        if (tablecell.className.indexOf('jqx-grid-cell-selected') == -1) {
                     //       if (tablecell.className.indexOf('jqx-grid-group') == -1) {
                            if (this.editcell) {
                                var column = this._getcolumnat(cellindex);
                                if (column) {
                                    if (this.editcell.row == index && this.editcell.column == column.datafield) {
                                        return;
                                    }
                                }
                            }
                                $(tablecell).addClass(this.toTP('jqx-grid-cell-hover'));
                                $(tablecell).addClass(this.toTP('jqx-fill-state-hover'));
                                if (this.cellhover) {
                                    this.cellhover(tablecell, event.pageX, event.pageY);
                                }
                     //       }
                        }
                    }
                    return;
                }

                for (var i = startindex; i < cellslength; i++) {
                    var tablecell = tablerow.cells[i];
               //     if (tablecell.className.indexOf('jqx-grid-group') == -1) {
                        $(tablecell).addClass(this.toTP('jqx-grid-cell-hover'));
                        $(tablecell).addClass(this.toTP('jqx-fill-state-hover'));
                        if (this.cellhover) {
                            this.cellhover(tablecell, event.pageX, event.pageY);
                        }
                    //     }
                }
            }
            else return true;
        }
    });
})(jQuery);


(function ($) {

    $.extend($.jqx._jqxGrid.prototype, {
        autoresizecolumns: function (resizetype, additionalwidth) {
            if (resizetype != 'cells' && resizetype != 'all' && resizetype != 'column') resizetype = 'all';
            var me = this.that;
            var rows = this.getrows();
            if (this.pageable) {
                rows = this.dataview.rows;
                if (this.groupable) {
                    rows = this.dataview.records;
                }
            }
            if (additionalwidth == undefined) additionalwidth = 0;
            else additionalwidth = parseInt(additionalwidth);

            var length = rows.length;
            if (length == undefined && rows != undefined) {
                var rowsArr = new Array();
                $.each(rows, function (index) {
                    rowsArr.push(this);
                });
                rows = rowsArr;
                length = rows.length;
            }

            var span = $("<span></span>");
            span.addClass(this.toThemeProperty('jqx-widget'));
            span.addClass(this.toThemeProperty('jqx-grid-cell'));
            $(document.body).append(span);
            var textlength = [];
            var maxLength = [];
            var maxText = [];
            var maxUppers = [];
            var hostwidth = me.host.width();
            if (me.vScrollBar[0].style.visibility != 'hidden') {
                hostwidth -= this.scrollbarsize + 5;
            }
            if (hostwidth < 0) hostwidth = 0;

            for (var i = 0; i < length; i++) {
                var row = rows[i];

                for (var j = 0; j < this.columns.records.length; j++) {
                    var column = this.columns.records[j];
                    if (column.hidden) continue;

                    if (maxLength[column.displayfield] == undefined) {
                        maxLength[column.displayfield] = 0;
                    }

                    if (maxText[column.displayfield] == undefined) {
                        maxText[column.displayfield] = "";
                    }

                    var text = row[column.displayfield];
                    if (column.cellsformat != '') {
                        if ($.jqx.dataFormat) {
                            if ($.jqx.dataFormat.isDate(text)) {
                                text = $.jqx.dataFormat.formatdate(text, column.cellsformat, this.gridlocalization);
                            }
                            else if ($.jqx.dataFormat.isNumber(text)) {
                                text = $.jqx.dataFormat.formatnumber(text, column.cellsformat, this.gridlocalization);
                            }
                        }
                    }
                    else if (column.cellsrenderer) {
                        var defaultcellsrenderer = me._defaultcellsrenderer(text, column);

                        var result = column.cellsrenderer(i, column.datafield, text, defaultcellsrenderer, column.getcolumnproperties(), row);
                        if (result != undefined) {
                            text = $(result).text();
                        }
                    }

                    if (resizetype == undefined || resizetype == 'cells' || resizetype == 'all') {
                        if (text != null) {
                            var textlength = text.toString().length;
                            var str = text.toString();
                            var charslength = str.replace(/[^A-Z]/g, "").length;
                        
                            if (textlength > maxLength[column.displayfield]) {
                                maxLength[column.displayfield] = textlength;
                                maxText[column.displayfield] = text;
                                maxUppers[column.displayfield] = charslength;
                            }

                            if (textlength > 0 && textlength >= charslength) {
                                var k1 = charslength * 20 + (textlength - charslength) * 15
                                var k2 = maxUppers[column.displayfield] * 20 + (maxLength[column.displayfield] - maxUppers[column.displayfield]) * 15;
                                if (k1 > k2 && k1 > 0 && k2 > 0) {
                                    maxLength[column.displayfield] = textlength;
                                    maxText[column.displayfield] = text;
                                    maxUppers[column.displayfield] = charslength;
                                }
                            }
                        }
                    }

                    if (resizetype == 'column' || resizetype == 'all') {
                        if (column.text.toString().length > maxLength[column.displayfield]) {
                            maxText[column.displayfield] = column.text;
                            maxLength[column.displayfield] = column.text.length;
                            var str = column.text.toString();
                            var charslength = str.replace(/[^A-Z]/g, "").length;
                            maxUppers[column.displayfield] = charslength;
                        }
                        var text = column.text;
                        var textlength = text.toString().length;
                        var str = text.toString();
                        var charslength = str.replace(/[^A-Z]/g, "").length;

                        if (textlength > 0 && textlength >= charslength) {
                            var k1 = charslength * 20 + (textlength - charslength) * 15
                            var k2 = maxUppers[column.displayfield] * 20 + (maxLength[column.displayfield] - maxUppers[column.displayfield]) * 15;
                            if (k1 > k2 && k1 > 0 && k2 > 0) {
                                maxLength[column.displayfield] = textlength;
                                maxText[column.displayfield] = text;
                                maxUppers[column.displayfield] = charslength;
                            }
                        }
                    }
                }
            }
            if (!this.columns.records) {
                return;
            }

            for (var j = 0; j < this.columns.records.length; j++) {
                var column = this.columns.records[j];
                if (maxText[column.displayfield] == undefined) {
                    maxText[column.displayfield] = column.text;
                }

                span[0].innerHTML = maxText[column.displayfield].toString();
                var maxWidth = span.outerWidth() + 10;
                if (span.children().length > 0) {
                    maxWidth = span.children().outerWidth() + 10;
                }
                if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                    maxWidth += 10;
                }
                if (this.filterable && this.showfilterrow) {
                    maxWidth += 5;
                }
                maxWidth += additionalwidth;

                if (maxWidth > column.maxwidth) maxWidth = column.maxwidth;

                if (column._width != undefined) column.__width = column._width;
                column._width = null;
                if (column.maxwidth == 'auto' || maxWidth <= column.maxwidth) {
                    var oldwidth = column.width;
                    if (maxWidth < column.minwidth) {
                        maxWidth = column.minwidth;
                    }

                    column.width = maxWidth;
                    if (column._percentagewidth != undefined) {
                        column._percentagewidth = null;
                    }
                    this._raiseEvent(14, { columntext: column.text, column: column.getcolumnproperties(), datafield: column.datafield, displayfield: column.displayfield, oldwidth: oldwidth, newwidth: maxWidth });
                }
            }

            span.remove();
            this._updatecolumnwidths();
            this._updatecellwidths();
            this._renderrows(this.virtualsizeinfo);
            for (var j = 0; j < this.columns.records.length; j++) {
                var column = this.columns.records[j];
                if (column.__width != undefined) {
                    column._width = column.__width;
                }
            }
        },

        autoresizecolumn: function (datafield, resizetype, additionalwidth) {
            if (resizetype != 'cells' && resizetype != 'all' && resizetype != 'column') resizetype = 'all';
            if (datafield == undefined) {
                return false;
            }

            var rows = this.getrows();
            if (this.pageable) {
                rows = this.dataview.rows;
                if (this.groupable) {
                    rows = this.dataview.records;
                }
            }

            var column = this.getcolumn(datafield);
            if (column == undefined) {
                return false;
            }

            if (additionalwidth == undefined) additionalwidth = 0;
            else additionalwidth = parseInt(additionalwidth);

            var length = rows.length;
            var span = $("<span></span>");
            span.addClass(this.toThemeProperty('jqx-widget'));
            span.addClass(this.toThemeProperty('jqx-grid-cell'));
            $(document.body).append(span);
            var maxLength = 0;
            var maxText = "";
            var maxUppers = 0;

            var me = this.that;
            var hostwidth = me.host.width();
            if (me.vScrollBar[0].style.visibility != 'hidden') {
                hostwidth -= this.scrollbarsize + 5;
            }
            if (hostwidth < 0) hostwidth = 0;

            if (resizetype == undefined || resizetype == 'cells' || resizetype == 'all') {
                for (var i = 0; i < length; i++) {
                    var text = rows[i][column.displayfield];
                    if (column.cellsformat != '') {
                        if ($.jqx.dataFormat) {
                            if ($.jqx.dataFormat.isDate(text)) {
                                text = $.jqx.dataFormat.formatdate(text, column.cellsformat, this.gridlocalization);
                            }
                            else if ($.jqx.dataFormat.isNumber(text)) {
                                text = $.jqx.dataFormat.formatnumber(text, column.cellsformat, this.gridlocalization);
                            }
                        }
                    } else if (column.cellsrenderer) {
                        var result = column.cellsrenderer(i, column, text);
                        if (result != undefined) {
                            text = $(result).text();
                        }
                    }

                    if (text != null) {
                        var textlength = text.toString().length;
                        var str = text.toString();
                        var charslength = str.replace(/[^A-Z]/g, "").length;
                        if (textlength > maxLength) {
                            maxLength = textlength;
                            maxText = text;
                            maxUppers = charslength;
                        }
                        if (textlength > 0 && textlength >= charslength) {
                            var k1 = charslength * 20 + (textlength - charslength) * 15
                            var k2 = maxUppers * 20 + (maxLength - maxUppers) * 15;
                            if (k1 > k2 && k1 > 0 && k2 > 0) {
                                maxLength= textlength;
                                maxText = text;
                                maxUppers = charslength;
                            }
                        }
                    }
                }
            }

            if (resizetype == 'column' || resizetype == 'all') {
                if (column.text.toString().length > maxLength) {
                    maxText = column.text;
                }

                var text = column.text.toString();
                var textlength = text.toString().length;
                var str = text.toString();
                var charslength = str.replace(/[^A-Z]/g, "").length;

                if (textlength > 0 && textlength >= charslength) {
                    var k1 = charslength * 20 + (textlength - charslength) * 15
                    var k2 = maxUppers * 20 + (maxLength - maxUppers) * 15;
                    if (k1 > k2 && k1 > 0 && k2 > 0) {
                        maxLength = textlength;
                        maxText = text;
                        maxUppers = charslength;
                    }
                }
            }
            if (maxText == undefined) {
                maxText = column.text;
            }

            span[0].innerHTML = maxText;
            var maxWidth = span.outerWidth() + 10;
            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                maxWidth += 5;
            }
            if (this.filterable && this.showfilterrow) {
                maxWidth += 5;
            }
            maxWidth += additionalwidth;

            span.remove();
            if (maxWidth > column.maxwidth) maxWidth = column.maxwidth;

            if (column.maxwidth == 'auto' || maxWidth <= column.maxwidth) {
                var oldwidth = column.width;
                if (maxWidth < column.minwidth) maxWidth = column.minwidth;
                column.width = maxWidth;
                if (column._width != undefined) column.__width = column._width;
                column._width = null;
                if (column._percentagewidth != undefined) {
                    column._percentagewidth = null;
                }
                this._updatecolumnwidths();
                this._updatecellwidths();
                this._raiseEvent(14, { columntext: column.text, column: column.getcolumnproperties(), datafield: datafield, displayfield: column.displayfield, oldwidth: oldwidth, newwidth: maxWidth });
                this._renderrows(this.virtualsizeinfo);
                if (column._width != undefined)
                    column._width = column.__width;
            }
        },

        _handlecolumnsresize: function () {
            var self = this.that;
            if (this.columnsresize) {
                var touchdevice = false;
                if (self.isTouchDevice() && self.touchmode !== true) {
                    touchdevice = true;
                }
                var mousemove = 'mousemove.resize' + this.element.id;
                var mousedown = 'mousedown.resize' + this.element.id;
                var mouseup = 'mouseup.resize' + this.element.id;
                if (touchdevice) {
                    var mousemove = $.jqx.mobile.getTouchEventName('touchmove') + '.resize' + this.element.id;
                    var mousedown = $.jqx.mobile.getTouchEventName('touchstart') + '.resize' + this.element.id;
                    var mouseup = $.jqx.mobile.getTouchEventName('touchend') + '.resize' + this.element.id;
                }

                this.removeHandler($(document), mousemove);
                this.addHandler($(document), mousemove, function (event) {
                    var openedmenu = $.data(document.body, "contextmenu" + self.element.id);
                    if (openedmenu != null && self.autoshowcolumnsmenubutton)
                        return true;

                    if (self.resizablecolumn != null && !self.disabled && self.resizing) {
                        if (self.resizeline != null) {
                            var resizeElement = self.resizablecolumn.columnelement;

                            var hostoffset = self.host.coord();
                            var startleft = parseInt(self.resizestartline.coord().left);

                            var minleft = startleft - self._startcolumnwidth
                            var mincolumnwidth = self.resizablecolumn.column.minwidth;
                            if (mincolumnwidth == 'auto') mincolumnwidth = 0;
                            else mincolumnwidth = parseInt(mincolumnwidth);
                            var maxcolumnwidth = self.resizablecolumn.column.maxwidth;
                            if (maxcolumnwidth == 'auto') maxcolumnwidth = 0;
                            else maxcolumnwidth = parseInt(maxcolumnwidth);
                            var pageX = event.pageX;
                            if (touchdevice) {
                                var touches = self.getTouches(event);
                                var touch = touches[0];
                                pageX = touch.pageX;
                            }

                            minleft += mincolumnwidth;

                            var maxleft = maxcolumnwidth > 0 ? startleft + maxcolumnwidth : 0;
                            var canresize = maxcolumnwidth == 0 ? true : self._startcolumnwidth + pageX - startleft < maxcolumnwidth ? true : false;
                            if (self.rtl) {
                                var canresize = true;
                            }

                            if (canresize) {
                                if (!self.rtl) {
                                    if (pageX >= hostoffset.left && pageX >= minleft) {
                                        if (maxleft != 0 && event.pageX < maxleft) {
                                            self.resizeline.css('left', pageX);
                                        }
                                        else if (maxleft == 0) {
                                            self.resizeline.css('left', pageX);
                                        }

                                        if (touchdevice)
                                            return false;
                                    }
                                }
                                else {
                                    if (pageX >= hostoffset.left && pageX <= hostoffset.left + self.host.width()) {
                                        self.resizeline.css('left', pageX);

                                        if (touchdevice)
                                            return false;
                                    }
                                }
                            }
                        }
                    }

                    if (!touchdevice && self.resizablecolumn != null)
                        return false;
                });

                this.removeHandler($(document), mousedown);
                this.addHandler($(document), mousedown, function (event) {
                    var openedmenu = $.data(document.body, "contextmenu" + self.element.id);
                    if (openedmenu != null && self.autoshowcolumnsmenubutton)
                        return true;

                    if (self.resizablecolumn != null && !self.disabled) {
                        var resizeElement = self.resizablecolumn.columnelement;
                        if (resizeElement.coord().top + resizeElement.height() + 5 < event.pageY) {
                            self.resizablecolumn = null;
                            return;
                        }

                        if (resizeElement.coord().top - 5 > event.pageY) {
                            self.resizablecolumn = null;
                            return;
                        }

                        self._startcolumnwidth = self.resizablecolumn.column.width;
                        self.resizablecolumn.column._width = null;
                        $(document.body).addClass('jqx-disableselect');
                        $(document.body).addClass('jqx-position-reset');
                        self.host.addClass('jqx-disableselect');
                        self.content.addClass('jqx-disableselect');

                        self._mouseDownResize = new Date();
                        self.resizing = true;

                        self._resizecolumn = self.resizablecolumn.column;
                        self.resizeline = self.resizeline || $('<div style="position: absolute;"></div>');
                        self.resizestartline = self.resizestartline || $('<div style="position: absolute;"></div>');

                        self.resizebackground = self.resizebackground || $('<div style="position: absolute; left: 0; top: 0; background: #000;"></div>');
                        self.resizebackground.css('opacity', 0.01);
                        self.resizebackground.css('cursor', "col-resize");
                        self.resizeline.css('cursor', 'col-resize');
                        self.resizestartline.css('cursor', 'col-resize');

                        self.resizeline.addClass(self.toThemeProperty('jqx-grid-column-resizeline'));
                        self.resizestartline.addClass(self.toThemeProperty('jqx-grid-column-resizestartline'));

                        $(document.body).append(self.resizeline);
                        $(document.body).append(self.resizestartline);
                        $(document.body).append(self.resizebackground);
                        var resizelineoffset = self.resizablecolumn.columnelement.coord();
                        self.resizebackground.css('left', self.host.coord().left);
                        self.resizebackground.css('top', self.host.coord().top);
                        self.resizebackground.width(self.host.width());
                        self.resizebackground.height(self.host.height());
                        self.resizebackground.css('z-index', 9999);

                        var positionline = function (resizeline) {
                            if (!self.rtl) {
                                resizeline.css('left', parseInt(resizelineoffset.left) + self._startcolumnwidth);
                            }
                            else {
                                resizeline.css('left', parseInt(resizelineoffset.left));
                            }

                            var hasgroups = self._groupsheader();
                            var groupsheaderheight = hasgroups ? self.groupsheader.height() : 0;
                            var toolbarheight = self.showtoolbar ? self.toolbarheight : 0;
                            groupsheaderheight += toolbarheight;
                            var statusbarheight = self.showstatusbar ? self.statusbarheight : 0;
                            groupsheaderheight += statusbarheight;

                            var pagerheight = 0;
                            if (self.pageable) {
                                pagerheight = self.pagerheight;
                            }
                            var scrollbaroffset = self.hScrollBar.css('visibility') == 'visible' ? 17 : 0;

                            resizeline.css('top', parseInt(resizelineoffset.top));
                            resizeline.css('z-index', 99999);
                            if (self.columngroups) {
                                resizeline.height(self.host.height() +self.resizablecolumn.columnelement.height()  - pagerheight - groupsheaderheight - scrollbaroffset - self.columngroupslevel * self.columnsheight);
                            }
                            else {
                                resizeline.height(self.host.height() - pagerheight - groupsheaderheight - scrollbaroffset);
                            }
                            if (self.enableanimations) {
                                resizeline.show('fast');
                            }
                            else {
                                resizeline.show();
                            }
                        }
                        positionline(self.resizeline);
                        positionline(self.resizestartline);
                        self.dragmousedown = null;
                    }
                });

                var doresize = function () {
                    $(document.body).removeClass('jqx-disableselect');
                    $(document.body).removeClass('jqx-position-reset');

                    if (self.showfilterrow || self.showstatusbar || self.showtoolbar || self.enablebrowserselection) {
                        self.host.removeClass('jqx-disableselect');
                        self.content.removeClass('jqx-disableselect');
                    }

                    if (!self.resizing)
                        return;

                    self._mouseUpResize = new Date();
                    var timeout = self._mouseUpResize - self._mouseDownResize;
                    if (timeout < 200) {
                        self.resizing = false;
                        if (self._resizecolumn != null && self.resizeline != null && self.resizeline.css('display') == 'block') {
                            self._resizecolumn = null;
                            self.resizeline.hide();
                            self.resizestartline.hide();
                            self.resizebackground.remove();
                        }
                        return;
                    }

                    self.resizing = false;

                    if (self.disabled)
                        return;

                    var hostwidth = self.host.width();
                    if (self.vScrollBar[0].style.visibility != 'hidden') hostwidth -= 20;
                    if (hostwidth < 0) hostwidth = 0;

                    if (self._resizecolumn != null && self.resizeline != null && self.resizeline.css('display') == 'block') {
                        var resizelineleft = parseInt(self.resizeline.css('left'));
                        var resizestartlineleft = parseInt(self.resizestartline.css('left'));

                        var newwidth = self._startcolumnwidth + resizelineleft - resizestartlineleft;
                        if (self.rtl) {
                            var newwidth = self._startcolumnwidth - resizelineleft + resizestartlineleft;
                        }

                        var oldwidth = self._resizecolumn.width;
                        self._closemenu();
                        self._resizecolumn.width = newwidth;
                        if (self._resizecolumn._percentagewidth != undefined) {
                            self._resizecolumn._percentagewidth = (newwidth / hostwidth) * 100;
                        }
                        for (var m = 0; m < self._columns.length; m++) {
                            if (self._columns[m].datafield === self._resizecolumn.datafield) {
                                self._columns[m].width = self._resizecolumn.width;
                                break;
                            }
                        }

                        var scrollVisibility = self.hScrollBar[0].style.visibility;

                        self._updatecolumnwidths();
                        self._updatecellwidths();
                        self._raiseEvent(14, { columntext: self._resizecolumn.text, column: self._resizecolumn.getcolumnproperties(), datafield: self._resizecolumn.datafield, oldwidth: oldwidth, newwidth: newwidth });
                        self._renderrows(self.virtualsizeinfo);
                        if (self.autosavestate) {
                            if (self.savestate) self.savestate();
                        }
                        if (scrollVisibility != self.hScrollBar[0].style.visibility) {
                            self.hScrollInstance.setPosition(0);
                        }
                        if (self.rtl) {
                            self._arrange();
                        }

                        self._resizecolumn = null;

                        self.resizeline.hide();
                        self.resizestartline.hide();
                        self.resizebackground.remove();
                        self.resizablecolumn = null;
                    }
                    else {
                        self.resizablecolumn = null;
                    }
                }

                try {
                    if (document.referrer != "" || window.frameElement) {
                        var parentLocation = null;
                        if (window.top != null && window.top != window.self) {
                            if (window.parent && document.referrer) {
                                parentLocation = document.referrer;
                            }
                        }

                        if (parentLocation && parentLocation.indexOf(document.location.host) != -1) {
                            var eventHandle = function (event) {
                                doresize();
                            };

                            if (window.top.document.addEventListener) {
                                window.top.document.addEventListener('mouseup', eventHandle, false);

                            } else if (window.top.document.attachEvent) {
                                window.top.document.attachEvent("on" + 'mouseup', eventHandle);
                            }
                        }
                    }
                }
                catch (error) {
                }

                this.removeHandler($(document), mouseup);
                this.addHandler($(document), mouseup, function (event) {
                    var openedmenu = $.data(document.body, "contextmenu" + self.element.id);
                    if (openedmenu != null && self.autoshowcolumnsmenubutton)
                        return true;

                    doresize();
                });
            }
        }
    });
})(jQuery);


(function ($) {
    $.jqx.dataview.sort = function () {
        this.sortby = function (field, ascending, comparer) {
            var tmpToString = Object.prototype.toString;
            if (ascending == null) {
                this.sortdata = null;
                this.refresh();
                return;
            }

            if (ascending == undefined) {
                ascending = true;
            }

            if (ascending == 'a' || ascending == 'asc' || ascending == 'ascending' || ascending == true) {
                ascending = true;
            }
            else {
                ascending = false;
            }

            var lookupkey = field;
            this.sortfield = field;
            this.sortfielddirection = ascending ? "asc" : "desc";

            if (this.sortcache == undefined) {
                this.sortcache = {};
            }

            this.sortdata = [];
            var _sortdata = [];
            var sorted = false;
            if (lookupkey == 'constructor') lookupkey = "";

            if (!this.virtualmode && this.sortcache[lookupkey] != null) {
                var cache = this.sortcache[lookupkey];
                _sortdata = cache._sortdata;

                if (cache.direction == ascending) {
                    _sortdata.reverse();
                }
                else {
                    if (!cache.direction && ascending) {
                        _sortdata.reverse();
                    }

                    sorted = true;
                }

                if (_sortdata.length < this.totalrecords) {
                    this.sortcache = {};
                    sorted = false;
                    _sortdata = [];
                }
            }

            Object.prototype.toString = (typeof field == "function") ? field : function () { return this[field] };
            var records = this.records;

            var me = this.that;

            var datatype = '';

            if (this.source.datafields) {
                $.each(this.source.datafields, function () {
                    if (this.name == field) {
                        if (this.type) {
                            datatype = this.type;
                        }
                        return false;
                    }
                });
            }

            if (_sortdata.length == 0) {
                if (records.length) {
                    var length = records.length;
                    // tries to loop through the records with for loop for better performance.
                    for (var i = 0; i < length; i++) {
                        var record = records[i];
                        if (record != null) {
                            var recordvalue = record;
                            var sortkey = recordvalue.toString();
                            _sortdata.push({ sortkey: sortkey, value: recordvalue, index: i });
                        }
                    }
                }
                else {
                    var caniterate = false;
                    // tries to loop through the records with for..in for better performance.
                    for (obj in records) {
                        var record = records[obj];
                        if (record == undefined) {
                            caniterate = true;
                            break;
                        }

                        var recordvalue = record;
                        _sortdata.push({ sortkey: recordvalue.toString(), value: recordvalue, index: obj });
                    }

                    if (caniterate) {
                        $.each(records, function (i, value) {
                            _sortdata.push({ sortkey: value.toString(), value: value, index: i });
                        });
                    }
                }
            }

            if (!sorted) {
                if (comparer == null) {
                    this._sortcolumntype = datatype;
                    var that = this;
                    _sortdata.sort(function (value1, value2) {
                        return that._compare(value1, value2, datatype);
                    });
                }
                else {
                    _sortdata.sort(comparer);
                }
            }

            if (!ascending) {
                _sortdata.reverse();
            }

            Object.prototype.toString = tmpToString;
            this.sortdata = _sortdata;

            this.sortcache[lookupkey] = { _sortdata: _sortdata, direction: ascending };
            this.reload(this.records, this.rows, this.filters, this.updated, true);
        },

        this.clearsortdata = function () {
            this.sortcache = {};
            this.sortdata = null;
        }

        this._compare = function (value1, value2, type) {
            var value1 = value1.sortkey;
            var value2 = value2.sortkey;
            if (value1 === undefined) { value1 = null; }
            if (value2 === undefined) { value2 = null; }
            if (value1 === null && value2 === null) {
                return 0;
            }
            if (value1 === null && value2 !== null) {
                return 1;
            }
            if (value1 !== null && value2 === null) {
                return -1;
            }

            if ($.jqx.dataFormat) {
                if (type && type != "") {
                    switch (type) {
                        case "number":
                        case "int":
                        case "float":
                            if (value1 < value2) { return -1; }
                            if (value1 > value2) { return 1; }
                            return 0;
                        case "date":
                        case "time":
                            if (value1 < value2) { return -1; }
                            if (value1 > value2) { return 1; }
                            return 0;
                        case "string":
                        case "text":
                            value1 = String(value1).toLowerCase();
                            value2 = String(value2).toLowerCase();
                            break;
                    }
                }
                else {
                    if ($.jqx.dataFormat.isNumber(value1) && $.jqx.dataFormat.isNumber(value2)) {
                        if (value1 < value2) { return -1; }
                        if (value1 > value2) { return 1; }
                        return 0;
                    }
                    else if ($.jqx.dataFormat.isDate(value1) && $.jqx.dataFormat.isDate(value2)) {
                        if (value1 < value2) { return -1; }
                        if (value1 > value2) { return 1; }
                        return 0;
                    }
                    else if (!$.jqx.dataFormat.isNumber(value1) && !$.jqx.dataFormat.isNumber(value2)) {
                        value1 = String(value1).toLowerCase();
                        value2 = String(value2).toLowerCase();
                    }
                }
            }
            try {
                if (value1 < value2) { return -1; }
                if (value1 > value2) { return 1; }
            }
            catch (error) {
                var er = error;
            }

            return 0;
        };

        this._equals = function (value1, value2) {
            return (this._compare(value1, value2) === 0);
        };
    }

    $.extend($.jqx._jqxGrid.prototype, {
        //[optimize]
        _rendersortcolumn: function () {
            var self = this.that;
            var sortcolumn = this.getsortcolumn();

            if (this.sortdirection) {
                var ariaFunc = function (column, direction) {
                    var sortc = self.getcolumn(column);
                    if (sortc) {
                        if (direction.ascending) {
                            $.jqx.aria(sortc.element, "aria-sort", "ascending");
                        }
                        else if (direction.descending) {
                            $.jqx.aria(sortc.element, "aria-sort", "descending");
                        } else {
                            $.jqx.aria(sortc.element, "aria-sort", "none");
                        }
                    }
                }
                if (this._oldsortinfo) {
                    if (this._oldsortinfo.column) {
                        ariaFunc(this._oldsortinfo.column, { ascending: false, descending: false });
                    }
                }
                ariaFunc(sortcolumn, this.sortdirection);

            }
            this._oldsortinfo = { column: sortcolumn, direction: this.sortdirection };

            if (this.sortdirection) {
                $.each(this.columns.records, function (i, value) {
                    var groupingsortelements = $.data(document.body, "groupsortelements" + this.displayfield);

                    if (sortcolumn == null || this.displayfield != sortcolumn) {
                        $(this.sortasc).hide();
                        $(this.sortdesc).hide();

                        if (groupingsortelements != null) {
                            groupingsortelements.sortasc.hide();
                            groupingsortelements.sortdesc.hide();
                        }
                    }
                    else {
                        if (self.sortdirection.ascending) {
                            $(this.sortasc).show();
                            $(this.sortdesc).hide();
                            if (groupingsortelements != null) {
                                groupingsortelements.sortasc.show();
                                groupingsortelements.sortdesc.hide();
                            }
                        }
                        else {
                            $(this.sortasc).hide();
                            $(this.sortdesc).show();
                            if (groupingsortelements != null) {
                                groupingsortelements.sortasc.hide();
                                groupingsortelements.sortdesc.show();
                            }
                        }
                    }
                });
            }
        },

        // gets the sort column.
        getsortcolumn: function () {
            if (this.sortcolumn != undefined) {
                return this.sortcolumn;
            }

            return null;
        },
        // removes the sorting.
        removesort: function () {
            this.sortby(null);
        },

        // sorts by a column.
        sortby: function (datafield, sortdirection, comparer, refresh, checkloading) {
            if (this._loading && checkloading !== false) {
                throw new Error('jqxGrid: ' + this.loadingerrormessage);
                return false;
            }

            // clear the sorting.
            if (datafield == null) {
                sortdirection = null;
                datafield = this.sortcolumn;
            }

            if (datafield != undefined) {
                var self = this.that;
                if (comparer == undefined && self.source.sortcomparer != null) {
                    comparer = self.source.sortcomparer;
                }

                if (sortdirection == 'a' || sortdirection == 'asc' || sortdirection == 'ascending' || sortdirection == true) {
                    ascending = true;
                }
                else {
                    ascending = false;
                }

                //var columnbydatafield = self.getcolumn(datafield);
                //if (columnbydatafield == undefined || columnbydatafield == null)
                //    return;

                if (sortdirection != null) {
                    self.sortdirection = { 'ascending': ascending, 'descending': !ascending };
                }
                else {
                    self.sortdirection = { 'ascending': false, 'descending': false };
                }

                if (sortdirection != null) {
                    self.sortcolumn = datafield;
                }
                else {
                    self.sortcolumn = null;
                }

                if (self.source.sort || self.virtualmode) {
                    self.dataview.sortfield = datafield;
                    if (sortdirection == null) {
                        self.dataview.sortfielddirection = "";
                    }
                    else {
                        self.dataview.sortfielddirection = ascending ? "asc" : "desc";
                    }
                    if (self.source.sort && !this._loading) {
                        self.source.sort(datafield, sortdirection);
                        self._raiseEvent(6, { sortinformation: self.getsortinformation() });
                        return;
                    }
                }
                else {
                    self.dataview.sortby(datafield, sortdirection, comparer);
                }

                if (refresh === false) {
                    return;
                }

                // if grouping is enabled, we need to refresh the groups too.
                if (self.groupable && self.groups.length > 0) {
                    self._render(true, false, false);
                    if (self._updategroupheadersbounds && self.showgroupsheader) {
                        self._updategroupheadersbounds();
                    }
                }
                else {
                    if (self.pageable) {
                        self.dataview.updateview();
                    }
                    self._updaterowsproperties();
                    self.rendergridcontent(true);
                }
                self._raiseEvent(6, { sortinformation: self.getsortinformation() });
            }
        },

        _togglesort: function (column) {
            var self = this.that;
            if (this.disabled) {
                return;
            }

            if (column.sortable && self.sortable) {
                var sortinformation = self.getsortinformation();
                var checked = null;
                if (sortinformation.sortcolumn != null && sortinformation.sortcolumn == column.displayfield) {
                    checked = sortinformation.sortdirection.ascending;
                    if (self.sorttogglestates > 1) {
                        if (checked == true) {
                            checked = false;
                        }
                        else {
                            checked = null;
                        }
                    }
                    else {
                        checked = !checked;
                    }
                }
                else {
                    checked = true;
                }

                self.sortby(column.displayfield, checked, null);
            }
        }
    });
})(jQuery);


(function ($) {

    $.extend($.jqx._jqxGrid.prototype, {
        _updatefilterrowui: function (forceupdateui) {
            var columnslength = this.columns.records.length;
            var left = 0;
            for (var j = 0; j < columnslength; j++) {
                var columnrecord = this.columns.records[j];
                var width = columnrecord.width;
                if (width < columnrecord.minwidth) width = columnrecord.minwidth;
                if (width > columnrecord.maxwidth) width = columnrecord.maxwidth;
                var tablecolumn = $(this.filterrow[0].cells[j]);
                tablecolumn.css('left', left);
                var updateui = true;
                if (tablecolumn.width() == width) {
                    updateui = false;
                }
                if (forceupdateui) {
                    updateui = true;
                }
                tablecolumn.width(width);
                tablecolumn[0].left = left;
                if (!(columnrecord.hidden && columnrecord.hideable)) {
                    left += width;
                }
                else {
                    tablecolumn.css('display', 'none');
                }
                if (!updateui)
                    continue;

                if (columnrecord.createfilterwidget && columnrecord.filtertype == 'custom') {
                    columnrecord.createfilterwidget(columnrecord, tablecolumn);
                }
                else {
                    if (columnrecord.filterable) {
                        var addtextfilter = function (me, tablecolumn) {
                            var textbox = $(tablecolumn.children()[0]);
                            textbox.width(width - 10);
                        }

                        switch (columnrecord.filtertype) {
                            case 'number':
                                $(tablecolumn.children()[0]).width(width);
                                tablecolumn.find('input').width(width - 30);
                                break;
                            case 'date':
                                if (this.host.jqxDateTimeInput) {
                                    $(tablecolumn.children()[0]).jqxDateTimeInput({ width: width - 10 });
                                }
                                else addtextfilter(this, tablecolumn);
                                break;
                            case 'textbox':
                            case 'default':
                                addtextfilter(this, tablecolumn);
                                break;
                            case 'list':
                            case 'checkedlist':
                                if (this.host.jqxDropDownList) {
                                    $(tablecolumn.children()[0]).jqxDropDownList({ width: width - 10 });
                                }
                                else addtextfilter(this, tablecolumn);
                                break;
                            case 'bool':
                            case 'boolean':
                                if (!this.host.jqxCheckBox) {
                                    addtextfilter(this, tablecolumn);
                                }
                                break;
                        }
                    }
                }
            }
            var tablerow = $(this.filterrow.children()[0]);
            tablerow.width(parseInt(left) + 2);
            tablerow.height(this.filterrowheight);
        },

        clearfilterrow: function () {
            this._disablefilterrow = true;
            var columnslength = this.columns.records.length;
            var left = 0;
            for (var j = 0; j < columnslength; j++) {
                var columnrecord = this.columns.records[j];
                var tablecolumn = $(this.filterrow[0].cells[j]);

                if (columnrecord.filterable) {
                    var addtextfilter = function (me, tablecolumn) {
                        var textbox = $(tablecolumn.children()[0]);
                        textbox.val("");
                        if (textbox[0]) {
                            me["_oldWriteText" + textbox[0].id] = "";
                        }
                    }

                    switch (columnrecord.filtertype) {
                        case 'number':
                            tablecolumn.find('input').val("");
                            break;
                        case 'date':
                            if (this.host.jqxDateTimeInput) {
                                $(tablecolumn.children()[0]).jqxDateTimeInput('setDate', null);
                            }
                            else addtextfilter(this, tablecolumn);
                            break;
                        case 'textbox':
                        case 'default':
                            addtextfilter(this, tablecolumn);
                            break;
                        case 'list':
                            if (this.host.jqxDropDownList) {
                                $(tablecolumn.children()[0]).jqxDropDownList('clearSelection');
                            }
                            else addtextfilter(this, tablecolumn);
                            break;
                        case 'checkedlist':
                            if (this.host.jqxDropDownList) {
                                $(tablecolumn.children()[0]).jqxDropDownList('checkAll', false);
                            }
                            else addtextfilter(this, tablecolumn);
                            break;
                        case 'bool':
                        case 'boolean':
                            if (!this.host.jqxCheckBox) {
                                addtextfilter(this, tablecolumn);
                            }
                            else $(tablecolumn.children()[0]).jqxCheckBox({ checked: null });
                            break;
                    }

                }
            }
            this._disablefilterrow = false;
        },

        _applyfilterfromfilterrow: function () {
            if (this._disablefilterrow == true)
                return;

            var columnslength = this.columns.records.length;
            var me = this.that;

            for (var j = 0; j < columnslength; j++) {
                var filtergroup = new $.jqx.filter();
                var columnrecord = this.columns.records[j];
                if (!columnrecord.filterable) continue;
                if (columnrecord.datafield === null) continue;

                var type = me._getcolumntypebydatafield(columnrecord);
                var filtertype = me._getfiltertype(type);
                var filter_or_operator = 1;
                var hasFilter = true;
                var columnrecordfiltertype = columnrecord.filtertype;
                var addstringfilter = function (columnrecord, filtertype, filtergroup) {
                    var result = true;
                    if (columnrecord._filterwidget) {
                        var filtervalue = columnrecord._filterwidget.val();
                        if (filtervalue != "") {
                            var filtercondition = 'equal';
                            if (filtertype == 'stringfilter') {
                                var filtercondition = 'contains';
                            }
                            if (filtertype == "numericfilter") {
                                if (me.gridlocalization.decimalseparator == ',') {
                                    if (filtervalue.indexOf(me.gridlocalization.decimalseparator) >= 0) {
                                        filtervalue = filtervalue.replace(me.gridlocalization.decimalseparator, '.');
                                    }
                                }
                            }

                            if (filtertype != 'stringfilter') {
                                var hasoperator = 0;
                                if (filtervalue.indexOf('>') != -1) {
                                    filtercondition = "greater_than";
                                    hasoperator = 1;
                                }
                                if (filtervalue.indexOf('<') != -1) {
                                    filtercondition = "less_than";
                                    hasoperator = 1;
                                }
                                if (filtervalue.indexOf('=') != -1) {
                                    if (filtercondition == "greater_than") {
                                        filtercondition = "greater_than_or_equal";
                                        hasoperator = 2;
                                    }
                                    else if (filtercondition == "less_than") {
                                        filtercondition = "less_than_or_equal";
                                        hasoperator = 2;
                                    }
                                    else {
                                        filtercondition = "equal";
                                        hasoperator = 1;
                                    }
                                }
                                if (hasoperator != 0) {
                                    filtervalue = filtervalue.substring(hasoperator);
                                    if (filtervalue.length < 1) return false;
                                }
                            }

                            if (columnrecord.filtercondition != undefined) filtercondition = columnrecord.filtercondition;

                            if (filtertype == "datefilter") {
                                var filter = filtergroup.createfilter(filtertype, filtervalue, filtercondition, null, columnrecord.cellsformat, me.gridlocalization);
                            }
                            else {
                                var filter = filtergroup.createfilter(filtertype, filtervalue, filtercondition);
                            }

                            filtergroup.addfilter(filter_or_operator, filter);
                        }
                        else result = false;
                    }
                    return result;
                }

                switch (columnrecord.filtertype) {
                    case 'date':
                        if (columnrecord._filterwidget.jqxDateTimeInput) {
                            var filtervalue = columnrecord._filterwidget.jqxDateTimeInput('getRange');
                            if (filtervalue != null && filtervalue.from != null && filtervalue.to != null) {
                                var filtercondition = 'GREATER_THAN_OR_EQUAL';
                                var date1 = new Date(0);
                                date1.setHours(0);
                                date1.setFullYear(filtervalue.from.getFullYear(), filtervalue.from.getMonth(), filtervalue.from.getDate());
                                var date2 = new Date(0);
                                date2.setHours(0);
                                date2.setFullYear(filtervalue.to.getFullYear(), filtervalue.to.getMonth(), filtervalue.to.getDate());
                                date2.setHours(filtervalue.to.getHours());
                                date2.setMinutes(filtervalue.to.getMinutes());
                                date2.setSeconds(filtervalue.to.getSeconds());

                                var filter1 = filtergroup.createfilter(filtertype, date1, filtercondition);
                                filtergroup.addfilter(0, filter1);

                                var filtercondition2 = 'LESS_THAN_OR_EQUAL';
                                var filter2 = filtergroup.createfilter(filtertype, date2, filtercondition2);
                                filtergroup.addfilter(0, filter2);
                            }
                            else hasFilter = false;
                        }
                        else {
                            hasFilter = addstringfilter(columnrecord, filtertype, filtergroup);
                        }
                        break;
                    case 'number':
                        if (columnrecord._filterwidget) {
                            var filtervalue = columnrecord._filterwidget.find('input').val();
                            if (me.gridlocalization.decimalseparator == ',') {
                                if (filtervalue.indexOf(me.gridlocalization.decimalseparator) >= 0) {
                                    filtervalue = filtervalue.replace(me.gridlocalization.decimalseparator, '.');
                                }
                            }
                            var index = columnrecord._filterwidget.find('.filter').jqxDropDownList('selectedIndex');
                            var condition = filtergroup.getoperatorsbyfiltertype(filtertype)[index];
                            if (me.updatefilterconditions) {
                                var newfilterconditions = me.updatefilterconditions(filtertype, filtergroup.getoperatorsbyfiltertype(filtertype));
                                if (newfilterconditions != undefined) {
                                    filtergroup.setoperatorsbyfiltertype(filtertype, newfilterconditions);
                                }
                                var condition = filtergroup.getoperatorsbyfiltertype(filtertype)[index];
                            }
                            var nullcondition1 = condition == "NULL" || condition == "NOT_NULL";
                            var emptycondition1 = condition == "EMPTY" || condition == "NOT_EMPTY";
                            if (filtervalue != undefined && filtervalue.length > 0 || nullcondition1 || emptycondition1) {
                                filter1 = filtergroup.createfilter(filtertype, new Number(filtervalue), condition, null, columnrecord.cellsformat, me.gridlocalization);
                                filtergroup.addfilter(0, filter1);
                            }
                            else hasFilter = false;
                        }
                        else {
                            hasFilter = false;
                        }
                        break;
                    case 'textbox':
                    case 'default':
                        hasFilter = addstringfilter(columnrecord, filtertype, filtergroup);
                        break;
                    case 'bool':
                    case 'boolean':
                        if (columnrecord._filterwidget.jqxCheckBox) {
                            var filtervalue = columnrecord._filterwidget.jqxCheckBox('checked');
                            if (filtervalue != null) {
                                var filtercondition = 'equal';
                                var filter = filtergroup.createfilter(filtertype, filtervalue, filtercondition);
                                filtergroup.addfilter(filter_or_operator, filter);
                            }
                            else hasFilter = false;
                        } else hasFilter = addstringfilter(columnrecord, filtertype, filtergroup);
                        break;
                    case 'list':
                        var widget = columnrecord._filterwidget.jqxDropDownList('listBox');
                        if (widget.selectedIndex > 0) {
                            var selectedItem = widget.getItem(widget.selectedIndex);
                            var filtervalue = selectedItem.label;
                            var filtercondition = 'equal';
                            var filter = filtergroup.createfilter(filtertype, filtervalue, filtercondition);
                            filtergroup.addfilter(filter_or_operator, filter);
                        } else {
                            hasFilter = false;
                        }
                        break;
                    case 'checkedlist':
                        if (columnrecord._filterwidget.jqxDropDownList) {
                            var widget = columnrecord._filterwidget.jqxDropDownList('listBox');
                            var checkedItems = widget.getCheckedItems();
                            if (checkedItems.length == 0) {
                                for (var i = 1; i < widget.items.length; i++) {
                                    var filtervalue = widget.items[i].label;
                                    var filtercondition = 'not_equal';
                                    var filter = filtergroup.createfilter(filtertype, filtervalue, filtercondition);
                                    filtergroup.addfilter(0, filter);
                                }

                                hasFilter = true;
                            }
                            else {
                                if (checkedItems.length != widget.items.length) {
                                    for (var i = 0; i < checkedItems.length; i++) {
                                        var filtervalue = checkedItems[i].label;
                                        var filtercondition = 'equal';
                                        var filter = filtergroup.createfilter(filtertype, filtervalue, filtercondition);
                                        filtergroup.addfilter(filter_or_operator, filter);
                                    }
                                }
                                else hasFilter = false;
                            }
                        }
                        else hasFilter = addstringfilter(columnrecord, filtertype, filtergroup);
                        break;
                }

                if (!this._loading) {
                    if (hasFilter) {
                        this.addfilter(columnrecord.displayfield, filtergroup, false);
                    }
                    else {
                        this.removefilter(columnrecord.displayfield, false);
                    }
                }
            }
            if (!this._loading) {
                this.applyfilters('filterrow');
            }
        },

        _updatefilterrow: function () {
            var tablerow = $('<div style="position: relative;" id="row00' + this.element.id + '"></div>');
            var left = 0;
            var columnslength = this.columns.records.length;
            var cellclass = this.toThemeProperty('jqx-grid-cell');
            cellclass += ' ' + this.toThemeProperty('jqx-grid-cell-pinned');
            cellclass += ' ' + this.toThemeProperty('jqx-grid-cell-filter-row');
            var zindex = columnslength + 10;
            var cells = new Array();
            var me = this.that;
            this.filterrow[0].cells = cells;
            tablerow.height(this.filterrowheight);
            this.filterrow.children().detach();
            this.filterrow.append(tablerow);
            if (!this._filterrowcache)
                this._filterrowcache = new Array();

            this._initcolumntypes();

            var usefromcache = false;
            var _newfilterrowcache = new Array();
            for (var j = 0; j < columnslength; j++) {
                var columnrecord = this.columns.records[j];
                var width = columnrecord.width;
                if (width < columnrecord.minwidth) width = columnrecord.minwidth;
                if (width > columnrecord.maxwidth) width = columnrecord.maxwidth;

                var tablecolumn = $('<div style="overflow: hidden; position: absolute; height: 100%;" class="' + cellclass + '"></div>');
                tablerow.append(tablecolumn);
                tablecolumn.css('left', left);
                if (this.rtl) {
                    tablecolumn.css('z-index', zindex++);
                    tablecolumn.css('border-left-width', '1px');
                }
                else {
                    tablecolumn.css('z-index', zindex--);
                }
                tablecolumn.width(width);
                tablecolumn[0].left = left;
                if (!(columnrecord.hidden && columnrecord.hideable)) {
                    left += width;
                }
                else {
                    tablecolumn.css('display', 'none');
                }
                cells[cells.length] = tablecolumn[0];

                var addFilterWidget = true;
                if (!this.rtl) {
                    if (this.groupable) {
                        var detailsoffset = (this.showrowdetailscolumn && this.rowdetails) ? 1 : 0;
                        if (this.groups.length + detailsoffset > j) {
                            addFilterWidget = false;
                        }
                    }
                    if (this.showrowdetailscolumn && this.rowdetails && j == 0) addFilterWidget = false;
                }
                else {
                    if (this.groupable) {
                        var detailsoffset = (this.showrowdetailscolumn && this.rowdetails) ? 1 : 0;
                        if (this.groups.length + detailsoffset + j > columnslength - 1) {
                            addFilterWidget = false;
                        }
                    }
                    if (this.showrowdetailscolumn && this.rowdetails && j == columnslength-1) addFilterWidget = false;
                }

                if (addFilterWidget) {
                    if (columnrecord.filtertype == 'custom' && columnrecord.createfilterwidget) {
                        var applyfilter = function () {
                            me._applyfilterfromfilterrow();
                        }
                        columnrecord.createfilterwidget(columnrecord, tablecolumn, applyfilter);
                    }
                    else {
                        if (columnrecord.filterable) {
                            if (this._filterrowcache[columnrecord.datafield]) {
                                usefromcache = true;
                                tablecolumn.append(this._filterrowcache[columnrecord.datafield]);
                                columnrecord._filterwidget = this._filterrowcache[columnrecord.datafield];
                            }
                            else {
                                this._addfilterwidget(columnrecord, tablecolumn, width);
                                _newfilterrowcache[columnrecord.datafield] = columnrecord._filterwidget;
                            }
                        }
                    }
                }
            }
            this._filterrowcache = _newfilterrowcache;
            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                tablerow.css('z-index', zindex--);
            }

            tablerow.width(parseInt(left) + 2);
            this.filterrow.addClass(cellclass);
            this.filterrow.css('border-top-width', '1px');
            this.filterrow.css('border-right-width', '0px');
            if (usefromcache) {
                this._updatefilterrowui(true);
            }
        },

        _addfilterwidget: function (columnrecord, tablecolumn, width) {
            var me = this.that;
            var filtervalue = "";
            for (var f = 0; f < me.dataview.filters.length; f++) {
                var currentfilter = me.dataview.filters[f];
                if (currentfilter.datafield && currentfilter.datafield == columnrecord.datafield) {
                    filtervalue = currentfilter.filter.getfilters()[0].value;
                    break;
                }
            }

            var addtextfilter = function (me, tablecolumn) {
                var textbox = $('<input autocomplete="off" type="textarea"/>');
                textbox[0].id = $.jqx.utilities.createId();
                textbox.addClass(me.toThemeProperty('jqx-widget'));
                textbox.addClass(me.toThemeProperty('jqx-input'));
                textbox.addClass(me.toThemeProperty('jqx-widget-content'));
                if (me.rtl) {
                    textbox.css('direction', 'rtl');
                }

                textbox.appendTo(tablecolumn);
                textbox.width(width - 10);
                textbox.height(me.filterrowheight - 10);
                textbox.css('margin', '4px');
                if (columnrecord.createfilterwidget) {
                    columnrecord.createfilterwidget(columnrecord, tablecolumn, textbox);
                }
                columnrecord._filterwidget = textbox;

                textbox.focus(function () {
                    me.focusedfilter = textbox;
                    textbox.addClass(me.toThemeProperty('jqx-fill-state-focus'));
                });
                textbox.blur(function () {
                    textbox.removeClass(me.toThemeProperty('jqx-fill-state-focus'));
                });

                
                textbox.keydown(function (event) {
                    if (event.keyCode == '13')
                        me._applyfilterfromfilterrow();
                    if (textbox[0]._writeTimer) clearTimeout(textbox[0]._writeTimer);
                    textbox[0]._writeTimer = setTimeout(function () {
                        if (!me._loading) {
                            if (me["_oldWriteText" + textbox[0].id] != textbox.val()) {
                                me._applyfilterfromfilterrow();
                                me["_oldWriteText" + textbox[0].id] = textbox.val();
                            }
                        }
                    }, 800);
                    me.focusedfilter = textbox;
                });
                me.host.removeClass('jqx-disableselect');
                me.content.removeClass('jqx-disableselect');
                textbox.val(filtervalue);
            }

            if (columnrecord.datatype != null) {
                if (columnrecord.filtertype == "number") {
                    if (columnrecord.datatype == "string" || columnrecord.datatype == "date" || columnrecord.datatype == "bool") {
                        columnrecord.filtertype = "textbox";
                    }
                }
                if (columnrecord.filtertype == "date") {
                    if (columnrecord.datatype == "string" || columnrecord.datatype == "number" || columnrecord.datatype == "bool") {
                        columnrecord.filtertype = "textbox";
                    }
                }
                if (columnrecord.filtertype == "bool") {
                    if (columnrecord.datatype == "string" || columnrecord.datatype == "number" || columnrecord.datatype == "date") {
                        columnrecord.filtertype = "textbox";
                    }
                }
            }

            switch (columnrecord.filtertype) {
                case 'number':
                    var numberwidget = $("<div></div>");
                    numberwidget.width(tablecolumn.width());
                    numberwidget.height(this.filterrowheight);
                    tablecolumn.append(numberwidget);
                    var width = tablecolumn.width() - 20;
                    var addInput = function (element, width, sign) {
                        var textbox = $('<input style="float: left;" autocomplete="off" type="textarea"/>');
                        if (me.rtl) {
                            textbox.css('float', 'right');
                            textbox.css('direction', 'rtl');
                        }
                        textbox[0].id = $.jqx.utilities.createId();
                        textbox.addClass(me.toThemeProperty('jqx-widget'));
                        textbox.addClass(me.toThemeProperty('jqx-input'));
                        textbox.addClass(me.toThemeProperty('jqx-widget-content'));
                        textbox.appendTo(element);
                        textbox.width(width - 10);
                        textbox.height(me.filterrowheight - 10);
                        textbox.css('margin', '4px');
                        textbox.css('margin-right', '2px');
                        textbox.focus(function () {
                            me.focusedfilter = textbox;
                            textbox.addClass(me.toThemeProperty('jqx-fill-state-focus'));
                        });
                        textbox.blur(function () {
                            textbox.removeClass(me.toThemeProperty('jqx-fill-state-focus'));
                        });
                        textbox.keydown(function (event) {
                            if (event.keyCode == '13')
                                me._applyfilterfromfilterrow();
                            if (textbox[0]._writeTimer) clearTimeout(textbox[0]._writeTimer);
                            textbox[0]._writeTimer = setTimeout(function () {
                                if (!me._loading) {
                                    if (me["_oldWriteText" + textbox[0].id] != textbox.val()) {
                                        me._applyfilterfromfilterrow();
                                        me["_oldWriteText" + textbox[0].id] = textbox.val();
                                    }
                                }
                            }, 800);
                            me.focusedfilter = textbox;
                        });
                        textbox.val(filtervalue);
                        return textbox;
                    }

                    addInput(numberwidget, width);
                    var source = me._getfiltersbytype('number');
                    var dropdownlist = $("<div class='filter' style='float: left;'></div>");
                    dropdownlist.css('margin-top', '4px');
                    dropdownlist.appendTo(numberwidget);
                    if (me.rtl) {
                        dropdownlist.css('float', 'right');
                    }

                    var selectedIndex = 0;
                    if (columnrecord.filtercondition != null) {
                        var newIndex = source.indexOf(columnrecord.filtercondition);
                        if (newIndex != -1)
                            selectedIndex = newIndex;
                    }

                    dropdownlist.jqxDropDownList({touchMode: me.touchmode, rtl: me.rtl, dropDownHorizontalAlignment: 'right', enableBrowserBoundsDetection: true, selectedIndex: selectedIndex, width: 18, height: 20, dropDownHeight: 150, dropDownWidth: 170, source: source, theme: me.theme });
                    dropdownlist.jqxDropDownList({
                        selectionRenderer: function (element) {
                            return "";
                        }
                    });
                    dropdownlist.jqxDropDownList('setContent', "");
                    dropdownlist.find('.jqx-dropdownlist-content').hide();
                    if (columnrecord.createfilterwidget) {
                        columnrecord.createfilterwidget(columnrecord, tablecolumn, numberwidget);
                    }
                    columnrecord._filterwidget = numberwidget;

                    var lastSelectedItem = null;
                    this.addHandler(dropdownlist, 'select', function () {
                        var selectedItem = dropdownlist.jqxDropDownList('getSelectedItem').label;
                        if (columnrecord._filterwidget.find('input').val().length > 0 && !me.refreshingfilter) {
                            me._applyfilterfromfilterrow();
                        }
                        else if (columnrecord._filterwidget.find('input').val().length == 0 && !me.refreshingfilter) {
                            if (lastSelectedItem == 'null' || lastSelectedItem == 'not null' || selectedItem == 'null' || selectedItem == 'not null') {
                                me._applyfilterfromfilterrow();
                            }
                        }
                        lastSelectedItem = selectedItem;
                    });
                    break;
                case 'textbox':
                case 'default':
                default:
                    addtextfilter(this, tablecolumn);
                    break;
                case 'none':
                    break;
                case 'date':
                    if (this.host.jqxDateTimeInput) {
                        var datetimeinput = $("<div></div>");
                        datetimeinput.css('margin', '4px');
                        datetimeinput.appendTo(tablecolumn);
                        var localization = { calendar: this.gridlocalization, todayString: this.gridlocalization.todaystring, clearString: this.gridlocalization.clearstring };
                        datetimeinput.jqxDateTimeInput({localization: localization, rtl: me.rtl, showFooter: true, formatString: columnrecord.cellsformat, selectionMode: 'range', value: null, theme: this.theme, width: width - 10, height: this.filterrowheight - 10 });
                        if (columnrecord.createfilterwidget) {
                            columnrecord.createfilterwidget(columnrecord, tablecolumn, datetimeinput);
                        }
                        columnrecord._filterwidget = datetimeinput;
                        this.addHandler(datetimeinput, 'valuechanged', function (event) {
                            if (!me.refreshingfilter) {
                                me._applyfilterfromfilterrow();
                                me.focusedfilter = null;
                            }
                        });
                    }
                    else addtextfilter(this, tablecolumn);
                    break;
                case 'list':
                case 'checkedlist':
                    if (this.host.jqxDropDownList) {
                        var dataadapter = this._getfilterdataadapter(columnrecord);

                        var autoheight = false;
                        var dropdownlist = $("<div></div>");
                        dropdownlist.css('margin', '4px');
                        var datafield = columnrecord.datafield;
                        var checkboxes = columnrecord.filtertype == 'checkedlist' ? true : false;
                        var dropDownWidth = width < 150 ? 220 : 'auto';
                        dropdownlist.jqxDropDownList({ touchMode: me.touchmode, rtl: me.rtl, checkboxes: checkboxes, dropDownWidth: dropDownWidth, source: dataadapter, autoDropDownHeight: autoheight, theme: this.theme, width: width - 10, height: this.filterrowheight - 10, displayMember: columnrecord.displayfield, valueMember: datafield });
                        dropdownlist.appendTo(tablecolumn);
                        var dropdownitems = dropdownlist.jqxDropDownList('getItems');
                        var listbox = dropdownlist.jqxDropDownList('listBox');
                        if (dropdownitems.length < 8) {
                            dropdownlist.jqxDropDownList('autoDropDownHeight', true);
                        }
                        else {
                            dropdownlist.jqxDropDownList('autoDropDownHeight', false);
                            autoheight = false;
                        }
                        if (checkboxes) {
                            dropdownlist.jqxDropDownList({
                                selectionRenderer: function () {
                                    return me.gridlocalization.filterselectstring;
                                }
                            });
                            var spanElement = $('<span style="top: 2px; position: relative; color: inherit; border: none; background-color: transparent;">' + me.gridlocalization.filterselectstring + '</span>');
                            spanElement.addClass(this.toThemeProperty('jqx-item'));
                            if (listbox != undefined) {
                                if (!autoheight) {
                                    listbox.host.height(200);
                                }
                                listbox.insertAt(me.gridlocalization.filterselectallstring, 0);
                                dropdownlist.jqxDropDownList('setContent', spanElement);
                                var handleCheckChange = true;
                                var checkedItems = new Array();
                                listbox.checkAll(false);
                                me.addHandler(listbox.host, 'checkChange', function (event) {
                                    dropdownlist[0]._selectionChanged = true;
                                    if (!handleCheckChange)
                                        return;

                                    if (event.args.label != me.gridlocalization.filterselectallstring) {
                                        handleCheckChange = false;
                                        listbox.host.jqxListBox('checkIndex', 0, true, false);
                                        var checkedItems = listbox.host.jqxListBox('getCheckedItems');
                                        var items = listbox.host.jqxListBox('getItems');

                                        if (checkedItems.length == 1) {
                                            listbox.host.jqxListBox('uncheckIndex', 0, true, false);
                                        }
                                        else if (items.length != checkedItems.length) {
                                            listbox.host.jqxListBox('indeterminateIndex', 0, true, false);
                                        }
                                        handleCheckChange = true;
                                    }
                                    else {
                                        handleCheckChange = false;
                                        if (event.args.checked) {
                                            listbox.host.jqxListBox('checkAll', false);
                                        }
                                        else {
                                            listbox.host.jqxListBox('uncheckAll', false);
                                        }

                                        handleCheckChange = true;
                                    }
                                });
                            }
                        }
                        else {
                            listbox.insertAt({ label: this.gridlocalization.filterchoosestring, value: "" }, 0);
                            dropdownlist.jqxDropDownList({ selectedIndex: 0 });
                        }

                        if (columnrecord.createfilterwidget) {
                            columnrecord.createfilterwidget(columnrecord, tablecolumn, dropdownlist);
                        }
                        columnrecord._filterwidget = dropdownlist;

                        var dropdownlistWrapper = dropdownlist.jqxDropDownList('dropdownlistWrapper');
                        if (columnrecord.filtertype == 'list') {
                            this.addHandler(dropdownlist, 'select', function (event) {
                                if (!me.refreshingfilter) {
                                    if (event.args && event.args.type != 'none') {
                                        me._applyfilterfromfilterrow();
                                        me.focusedfilter = null;
                                    }
                                }
                            });
                        }
                        else {
                            this.addHandler(dropdownlist, 'close', function (event) {
                                if (dropdownlist[0]._selectionChanged) {
                                    me._applyfilterfromfilterrow();
                                    me.focusedfilter = null;
                                    dropdownlist[0]._selectionChanged = false;
                                }
                            });
                        }
                    }
                    else addtextfilter(this, tablecolumn);
                    break;
                case 'bool':
                case 'boolean':
                    if (this.host.jqxCheckBox) {
                        var checkbox = $('<div tabIndex=0 style="opacity: 0.99; position: absolute; top: 50%; left: 50%; margin-top: -7px; margin-left: -10px;"></div>');
                        checkbox.appendTo(tablecolumn);
                        checkbox.jqxCheckBox({ enableContainerClick: false, animationShowDelay: 0, animationHideDelay: 0, hasThreeStates: true, theme: this.theme, checked: null });
                        if (columnrecord.createfilterwidget) {
                            columnrecord.createfilterwidget(columnrecord, tablecolumn, checkbox);
                        }
                        if (filtervalue === true || filtervalue == "true") {
                            checkbox.jqxCheckBox({ checked: true });
                        }
                        else if (filtervalue === false || filtervalue == "false") {
                            checkbox.jqxCheckBox({ checked: false });
                        }

                        columnrecord._filterwidget = checkbox;
                        this.addHandler(checkbox, 'change', function (event) {
                            if (!me.refreshingfilter) {
                                if (event.args) {
                                    me.focusedfilter = null;
                                    me._applyfilterfromfilterrow();
                                }
                            }
                        });
                    }
                    else addtextfilter(this, tablecolumn);
                    break;
            }
        },

        _getfilterdataadapter: function (columnrecord) {
            var isdataadapter = this.source._source ? true : false;

            if (!isdataadapter) {
                dataadapter = new $.jqx.dataAdapter(this.source,
                            {
                                autoBind: false,
                                uniqueDataFields: [columnrecord.displayfield],
                                autoSort: true,
                                autoSortField: columnrecord.displayfield,
                                async: false
                            });
            }
            else {
                var dataSource =
                {
                    localdata: this.source.records,
                    datatype: this.source.datatype,
                    async: false
                }
                var that = this;
                dataadapter = new $.jqx.dataAdapter(dataSource,
                {
                    autoBind: false,
                    autoSort: true,
                    autoSortField: columnrecord.displayfield,
                    async: false,
                    uniqueDataFields: [columnrecord.displayfield],
                    beforeLoadComplete: function (records) {
                        var data = new Array();
                        if (columnrecord.cellsformat) {
                            var columntype = that._getcolumntypebydatafield(columnrecord);

                            for (var i = 0; i < records.length; i++) {
                                data.push(records[i]);
                                var value = records[i][columnrecord.displayfield];
                                records[i][columnrecord.displayfield + "JQValue"] = value;
                                if (columntype === "date") {
                                    records[i][columnrecord.displayfield] = dataadapter.formatDate(value, columnrecord.cellsformat, that.gridlocalization);
                                }
                                else if (columntype === "number" || columntype === "float" || columntype === "int") {
                                    records[i][columnrecord.displayfield] = dataadapter.formatNumber(value, columnrecord.cellsformat, that.gridlocalization);
                                }
                            }
                            return data;
                        }
                        else return records;
                    }
                });
            }
            if (columnrecord.filteritems && columnrecord.filteritems.length > 0) {
                var dataSource =
                {
                    localdata: columnrecord.filteritems,
                    datatype: this.source.datatype,
                    async: false
                }

                dataadapter = new $.jqx.dataAdapter(dataSource,
                {
                    autoBind: false,
                    async: false
                });
            }
            else if (columnrecord.filteritems) {
                if (columnrecord.filteritems._source) {
                    columnrecord.filteritems._options.autoBind = false;
                    columnrecord.filteritems._options.async = false;

                    return columnrecord.filteritems;
                }
                else if ($.isFunction(columnrecord.filteritems)) {
                    return columnrecord.filteritems();
                }
            }

            return dataadapter;
        },

        refreshfilterrow: function () {
            if (!this.showfilterrow) {
                return;
            }

            this.refreshingfilter = true;
            this._updatefilterrowui();
            this._updatelistfilters(true, true);
            var me = this.that;
            var columnslength = this.columns.records.length;
            for (var j = 0; j < columnslength; j++) {
                var column = this.columns.records[j];
                if (column.filterable) {
                    if (column.filter) {
                        var filters = column.filter.getfilters();
                        if (filters.length > 0) {
                            var value = filters[0].value;
                            var widget = column._filterwidget;
                            var tablecolumn = column._filterwidget.parent();
                            if (widget != null) {
                                switch (column.filtertype) {
                                    case 'number':
                                        tablecolumn.find('input').val(value);
                                        if (this.host.jqxDropDownList) {
                                            var conditions = column.filter.getoperatorsbyfiltertype('numericfilter');
                                            widget.find('.filter').jqxDropDownList('selectIndex', conditions.indexOf(filters[0].condition));
                                        }
                                        break;
                                    case 'date':
                                        if (this.host.jqxDateTimeInput) {
                                            var value = column.filter.getfilterat(0).filtervalue;
                                            if (value != undefined) {
                                                if (column.filter.getfilterat(1)) {
                                                    var value2 = column.filter.getfilterat(1).filtervalue;
                                                }
                                                else {
                                                    value2 = value;
                                                }

                                                $(tablecolumn.children()[0]).jqxDateTimeInput('setRange', new Date(value), new Date(value2));
                                            }
                                        }
                                        else {
                                            widget.val(value);
                                        }
                                        break;
                                    case 'textbox':
                                    case 'default':
                                        widget.val(value);
                                        me["_oldWriteText" + widget[0].id] = value;
                                        break;
                                    case 'bool':
                                    case 'boolean':
                                        if (!this.host.jqxCheckBox) {
                                            widget.val(value);
                                        }
                                        else $(tablecolumn.children()[0]).jqxCheckBox({ checked: value });
                                        break;
                                }
                            }
                        }
                    }
                }
            }
            this.refreshingfilter = false;
        },

        _destroyedfilters: function ()
        {
                var me = this.that;
                var columnslength = this.columns.records.length;
                for (var j = 0; j < columnslength; j++) {
                    var columnrecord = this.columns.records[j];
                    if (columnrecord.filterable) {
                        var widget = columnrecord._filterwidget;
                        if (columnrecord.filtertype == 'list' || columnrecord.filtertype == 'checkedlist') {
                            this.removeHandler(widget, 'select');
                            this.removeHandler(widget, 'close');
                            widget.jqxDropDownList('destroy');
                        }
                        else if (columnrecord.filtertype == 'date') {
                            this.removeHandler(widget, 'valuechanged');
                            widget.jqxDateTimeInput('destroy');
                        }
                        else if (columnrecord.filtertype == 'bool') {
                            this.removeHandler(widget, 'change');
                            widget.jqxCheckBox('destroy');
                        }
                        else if (columnrecord.filtertype == 'number') {
                            var input = widget.find('.jqx-input');
                            this.removeHandler(input, 'keydown');
                            var dropdownlist = $(widget.children()[1]);
                            dropdownlist.jqxDropDownList('destroy');
                        }
                        else {
                            this.removeHandler(widget, 'keydown');
                        }
                        widget.remove();
                    }
                }
        },

        _updatelistfilters: function (endcelledit, updatecheckstates) {
            var me = this.that;
            var columnslength = this.columns.records.length;
            for (var j = 0; j < columnslength; j++) {
                var columnrecord = this.columns.records[j];
                if (columnrecord.filterable) {
                    if (columnrecord.filtertype == 'list' || columnrecord.filtertype == 'checkedlist') {
                        var dropdownlist = columnrecord._filterwidget;
                        if (!endcelledit) {
                            if (columnrecord.filter == undefined) {
                                dropdownlist.jqxDropDownList('renderSelection');
                                continue;
                            }
                        }
                        else {
                            var dataadapter = this._getfilterdataadapter(columnrecord);
                            dropdownlist.jqxDropDownList({ source: dataadapter });
                            var dropdownitems = dropdownlist.jqxDropDownList('getItems');
                            var equalSources = true;
                            if (dropdownitems.length != dataadapter.records.length + 1)
                                equalSources = false;

                            if (equalSources) {
                                for (var i = 1; i < dropdownitems.length; i++) {
                                    if (dropdownitems[i].label != dataadapter.records[i - 1][columnrecord.displayfield]) {
                                        equalSources = false;
                                        break;
                                    }
                                }
                            }
                            if (equalSources && !updatecheckstates)
                                continue;
                        }

                        var checkboxes = columnrecord.filtertype == 'checkedlist' ? true : false;
                        var dropdownitems = dropdownlist.jqxDropDownList('getItems');
                        var listbox = dropdownlist.jqxDropDownList('listBox');
                        dropdownlist.jqxDropDownList('dataBind');
                     
                        if (checkboxes) {
                            dropdownlist.jqxDropDownList({
                                selectionRenderer: function () {
                                    return me.gridlocalization.filterselectstring;
                                }
                            });
                            listbox.insertAt(this.gridlocalization.filterselectallstring, 0);
                            dropdownlist.jqxDropDownList('setContent', this.gridlocalization.filterselectstring);
                            listbox.checkAll(false);
                            if (columnrecord.filter) {
                                var filters = columnrecord.filter.getfilters();

                                for (var i = 0; i < listbox.items.length; i++) {
                                    var label = listbox.items[i].label;
                                    $.each(filters, function () {
                                        if (this.condition == "NOT_EQUAL") {
                                            if (label == this.value) {
                                                listbox.uncheckIndex(i, false, false);
                                            }
                                            else {
                                                listbox.checkIndex(i, false, false);
                                            }
                                        }
                                        else if (this.condition == "EQUAL") {
                                            if (label == this.value) {
                                                listbox.checkIndex(i, false, false);
                                            }
                                            else {
                                                listbox.uncheckIndex(i, false, false);
                                            }
                                        }
                                    });
                                }
                                listbox._updateCheckedItems();
                                var checkedItemsLength = listbox.getCheckedItems().length;
                                if (listbox.items.length != checkedItemsLength && checkedItemsLength > 0) {
                                    listbox.host.jqxListBox('indeterminateIndex', 0, true, false);
                                }
                            }
                        }
                        else {
                            listbox.insertAt({ label: this.gridlocalization.filterchoosestring, value: "" }, 0);
                            dropdownlist.jqxDropDownList({ selectedIndex: 0 });
                            if (columnrecord.filter) {
                                var filters = columnrecord.filter.getfilters();
                                var selectedIndex = -1;
                                for (var i = 0; i < listbox.items.length; i++) {
                                    var label = listbox.items[i].label;
                                    $.each(filters, function () {
                                        if (this.condition == "NOT_EQUAL") return true;
                                        if (label == this.value) {
                                            selectedIndex = i;
                                            return false;
                                        }
                                    });
                                }
                                if (selectedIndex != -1) {
                                    listbox.selectIndex(selectedIndex);
                                }
                            }
                        }
                        if (dropdownitems.length < 8) {
                            dropdownlist.jqxDropDownList('autoDropDownHeight', true);
                        }
                        else {
                            dropdownlist.jqxDropDownList('autoDropDownHeight', false);
                        }
                    }
                }
            }
        },

        _renderfiltercolumn: function () {
            var self = this.that;

            if (this.filterable) {
                $.each(this.columns.records, function (i, value) {
                    if (self.autoshowfiltericon) {
                        if (this.filter) {
                            $(this.filtericon).show();
                        }
                        else {
                            $(this.filtericon).hide();
                        }
                    }
                    else {
                        if (this.filterable) {
                            $(this.filtericon).show();
                        }
                    }
                });
            }
        },

        _initcolumntypes: function()
        {
            if (this.columns && this.columns.records) {
                var datafields = this.source._source.datafields;
                if (datafields) {
                    for (var i = 0; i < this.columns.records.length; i++) {
                        var column = this.columns.records[i];
                        if (column.datatype) continue;
                        var foundType = "";
                        $.each(datafields, function () {
                            if (this.name == column.displayfield) {
                                if (this.type) {
                                    foundType = this.type;
                                }
                                return false;
                            }
                        });
                        if (foundType != "")
                            column.datatype = foundType;
                        else column.datatype = "";
                    }
                }
            }
        },

        _getcolumntypebydatafield: function (column) {
            var me = this.that;
            var type = 'string';
            var datafields = me.source.datafields || ((me.source._source) ? me.source._source.datafields : null);

            if (datafields) {
                var foundType = "";
                $.each(datafields, function () {
                    if (this.name == column.displayfield) {
                        if (this.type) {
                            foundType = this.type;
                        }
                        return false;
                    }
                });
                if (foundType)
                    return foundType;
            }

            if (column != null) {
                if (this.dataview.cachedrecords == undefined) {
                    return type;
                }

                var cell = null;

                if (!this.virtualmode) {
                    if (this.dataview.cachedrecords.length == 0)
                        return type;

                    cell = this.dataview.cachedrecords[0][column.displayfield];
                    if (cell != null && cell.toString() == "") {
                        return "string";
                    }
                }
                else {
                    $.each(this.dataview.cachedrecords, function () {
                        cell = this[column.displayfield];
                        return false;
                    });
                }

                if (cell != null) {
                    if (typeof cell == 'boolean') {
                        type = 'boolean';
                    }
                    else if ($.jqx.dataFormat.isNumber(cell)) {
                        type = 'number';
                    }
                    else {
                        var tmpvalue = new Date(cell);

                        if (tmpvalue.toString() == 'NaN' || tmpvalue.toString() == "Invalid Date") {
                            if ($.jqx.dataFormat) {
                                tmpvalue = $.jqx.dataFormat.tryparsedate(cell);
                                if (tmpvalue != null) {
                                    if (tmpvalue && tmpvalue.getFullYear()) {
                                        if (tmpvalue.getFullYear() == 1970 && tmpvalue.getMonth() == 0 && tmpvalue.getDate() == 1) {
                                            var num = new Number(cell);
                                            if (!isNaN(num))
                                                return 'number';

                                            return 'string';
                                        }
                                    }

                                    return 'date';
                                }
                                else {
                                    type = 'string';
                                }
                            }
                            else type = 'string';
                        }
                        else {
                            type = 'date';
                        }
                    }
                }
            }
            return type;
        },

        _getfiltersbytype: function (type) {
            var me = this.that;
            var source = '';
            switch (type) {
                case "number":
                case "float":
                case "int":
                    source = me.gridlocalization.filternumericcomparisonoperators;
                    break;
                case "date":
                    source = me.gridlocalization.filterdatecomparisonoperators;
                    break;
                case "boolean":
                case "bool":
                    source = me.gridlocalization.filterbooleancomparisonoperators;
                    break;
                case "string":
                default:
                    source = me.gridlocalization.filterstringcomparisonoperators;
                    break;

            }
            return source;
        },

        _updatefilterpanel: function (me, element, column) {
            if (me == null || me == undefined) me = this;
            var type = me._getcolumntypebydatafield(column);
            var source = me._getfiltersbytype(type);

            if (!me.host.jqxDropDownList) {
                throw new Error('jqxGrid: Missing reference to jqxdropdownlist.js.');
                return;
            }

            var $element = $(element);
            var clearbutton = $element.find('#filterclearbutton' + me.element.id);
            var filterbutton = $element.find('#filterbutton' + me.element.id);
            var condition = $element.find('#filter1' + me.element.id);
            var filteroperator = $element.find('#filter2' + me.element.id);
            var condition2 = $element.find('#filter3' + me.element.id);
            var input1 = $element.find('.filtertext1' + me.element.id);
            var input2 = $element.find('.filtertext2' + me.element.id);
            input1.val('');
            input2.val('');

            this.removeHandler(filterbutton, 'click');
            this.addHandler(filterbutton, 'click', function () {
                me._buildfilter(me, element, column);
                me._closemenu();
            });

            this.removeHandler(clearbutton, 'click');
            this.addHandler(clearbutton, 'click', function () {
                me._clearfilter(me, element, column);
                me._closemenu();
            });

            if (this.filtermode === "default") {
                if (condition.jqxDropDownList('source') != source) {
                    condition.jqxDropDownList({ enableBrowserBoundsDetection: false, source: source });
                    condition2.jqxDropDownList({ enableBrowserBoundsDetection: false, source: source });
                }

                if (type == 'boolean' || type == 'bool') {
                    condition.jqxDropDownList({ autoDropDownHeight: true, selectedIndex: 0 });
                    condition2.jqxDropDownList({ autoDropDownHeight: true, selectedIndex: 0 });
                }
                else {
                    var autoDropDownHeight = false;
                    if (source && source.length) {
                        if (source.length < 5) {
                            autoDropDownHeight = true;
                        }
                    }

                    condition.jqxDropDownList({ autoDropDownHeight: autoDropDownHeight, selectedIndex: 2 });
                    condition2.jqxDropDownList({ autoDropDownHeight: autoDropDownHeight, selectedIndex: 2 });
                }
                filteroperator.jqxDropDownList({ selectedIndex: 0 });

                var filter = column.filter;
                var filtergroup = new $.jqx.filter();
                var filtertype = "";
                switch (type) {
                    case "number":
                    case "int":
                    case "float":
                    case "decimal":
                        filtertype = 'numericfilter';
                        conditions = filtergroup.getoperatorsbyfiltertype('numericfilter');
                        break;
                    case "boolean":
                    case "bool":
                        filtertype = 'booleanfilter';
                        conditions = filtergroup.getoperatorsbyfiltertype('booleanfilter');
                        break;
                    case "date":
                    case "time":
                        filtertype = 'datefilter';
                        conditions = filtergroup.getoperatorsbyfiltertype('datefilter');
                        break;
                    case "string":
                        filtertype = 'stringfilter';
                        conditions = filtergroup.getoperatorsbyfiltertype('stringfilter');
                        break;
                }
                if (filter != null) {
                    var filter1 = filter.getfilterat(0);
                    var filter2 = filter.getfilterat(1);
                    var operator = filter.getoperatorat(0);
                 
                    if (me.updatefilterconditions) {
                        var conditions = [];
                        var newfilterconditions = me.updatefilterconditions(filtertype, conditions);
                        if (newfilterconditions != undefined) {
                            for (var c = 0; c < newfilterconditions.length; c++) {
                                newfilterconditions[c] = newfilterconditions[c].toUpperCase();
                            }
                            filter.setoperatorsbyfiltertype(filtertype, newfilterconditions);
                            conditions = newfilterconditions;
                        }
                    }

                    var animationtype = this.enableanimations ? 'default' : 'none';
                    if (filter1 != null) {
                        var index1 = conditions.indexOf(filter1.comparisonoperator);
                        var value1 = filter1.filtervalue;
                        input1.val(value1);
                        condition.jqxDropDownList({ selectedIndex: index1, animationType: animationtype });
                    }
                    if (filter2 != null) {
                        var index2 = conditions.indexOf(filter2.comparisonoperator);
                        var value2 = filter2.filtervalue;
                        input2.val(value2);
                        condition2.jqxDropDownList({ selectedIndex: index2, animationType: animationtype });
                    }
                    if (filter.getoperatorat(0) == undefined) {
                        filteroperator.jqxDropDownList({ selectedIndex: 0, animationType: animationtype });
                    }
                    else {
                        if (filter.getoperatorat(0) == 'and' || filter.getoperatorat(0) == 0) {
                            filteroperator.jqxDropDownList({ selectedIndex: 0 });
                        }
                        else {
                            filteroperator.jqxDropDownList({ selectedIndex: 1 });
                        }
                    }
                }
                if (me.updatefilterpanel) {
                    me.updatefilterpanel(condition, condition2, filteroperator, input1, input2, filterbutton, clearbutton, filter, filtertype, conditions);
                }

                input1.focus();
                setTimeout(function () {
                    input1.focus();
                }, 10);
            }
            else {
                var dataadapter = me._getfilterdataadapter(column);
                var filtertype = me._getfiltertype(type);
                if (column.cellsformat) {
                    condition.jqxListBox({ displayMember: column.displayfield, valueMember: column.displayfield + "JQValue", source: dataadapter });
                }
                else {
                    condition.jqxListBox({ displayMember: column.displayfield, valueMember: column.displayfield, source: dataadapter });
                }

                condition.jqxListBox('insertAt', me.gridlocalization.filterselectallstring, 0);
                var listbox = condition.data().jqxListBox.instance;
                listbox.checkAll(false);
                var that = this;
                if (column.filter) {
                    listbox.uncheckAll(false);
                    var filters = column.filter.getfilters();
                    for (var i = 0; i < listbox.items.length; i++) {
                        var label = listbox.items[i].value;

                        $.each(filters, function () {
                            if (this.condition == "NOT_EQUAL") {
                                if (label != this.value) {
                                    listbox.uncheckIndex(i, false, false);
                                    return false;
                                }
                            }
                            else if (this.condition == "EQUAL") {
                                if (label == this.value) {
                                    listbox.checkIndex(i, false, false);
                                    return false;
                                }
                            }
                        });
                    }

                    listbox._updateCheckedItems();
                    var checkedItemsLength = listbox.getCheckedItems().length;
                    if (listbox.items.length != checkedItemsLength && checkedItemsLength > 0) {
                        listbox.host.jqxListBox('indeterminateIndex', 0, true, false);
                    }
                    if (checkedItemsLength === listbox.items.length - 1) {
                        listbox.host.jqxListBox('checkIndex', 0, true, false);
                    }
                }
            } 
        },

        _getfiltertype: function (type) {
            var filtertype = "stringfilter";
            switch (type) {
                case "number":
                case "int":
                case "float":
                case "decimal":
                    filtertype = 'numericfilter';
                    break;
                case "boolean":
                case "bool":
                    filtertype = 'booleanfilter';
                    break;
                case "date":
                case "time":
                    filtertype = 'datefilter';
                    break;
                case "string":
                    filtertype = 'stringfilter';
                    break;
            }
            return filtertype;
        },

        _buildfilter: function (me, element, column) {
            var condition = $(element).find('#filter1' + me.element.id);
            var operator = $(element).find('#filter2' + me.element.id);
            var condition2 = $(element).find('#filter3' + me.element.id);
            var input1 = $(element).find('.filtertext1' + me.element.id);
            var input2 = $(element).find('.filtertext2' + me.element.id);
            var value1 = input1.val();
            var value2 = input2.val();
            var type = me._getcolumntypebydatafield(column);
            var source = me._getfiltersbytype(type);

            var filtergroup = new $.jqx.filter();
            var filtertype = me._getfiltertype(type);
            if (me.filtermode === "default") {
                var index1 = condition.jqxDropDownList('selectedIndex');
                var operatorindex = operator.jqxDropDownList('selectedIndex');
                var index2 = condition2.jqxDropDownList('selectedIndex');
              
                var filter1 = null;
                var filter2 = null;
               
                if (me.updatefilterconditions) {
                    var newfilterconditions = me.updatefilterconditions(filtertype, filtergroup.getoperatorsbyfiltertype(filtertype));
                    if (newfilterconditions != undefined) {
                        filtergroup.setoperatorsbyfiltertype(filtertype, newfilterconditions);
                    }
                }

                var isvalidfilter = false;
                var condition1 = filtergroup.getoperatorsbyfiltertype(filtertype)[index1];
                var condition2 = filtergroup.getoperatorsbyfiltertype(filtertype)[index2];
                var nullcondition1 = condition1 == "NULL" || condition1 == "NOT_NULL";
                var emptycondition1 = condition1 == "EMPTY" || condition1 == "NOT_EMPTY";

                if (condition1 == undefined) condition1 = filtergroup.getoperatorsbyfiltertype(filtertype)[0];
                if (condition2 == undefined) condition2 = filtergroup.getoperatorsbyfiltertype(filtertype)[0];

                if (value1.length > 0 || nullcondition1 || emptycondition1) {
                    filter1 = filtergroup.createfilter(filtertype, value1, condition1, null, column.cellsformat, me.gridlocalization);
                    filtergroup.addfilter(operatorindex, filter1);
                    isvalidfilter = true;
                }

                var nullcondition2 = condition2 == "NULL" || condition2 == "NOT_NULL";
                var emptycondition2 = condition2 == "EMPTY" || condition2 == "NOT_EMPTY";

                if (value2.length > 0 || nullcondition2 || emptycondition2) {
                    filter2 = filtergroup.createfilter(filtertype, value2, condition2, null, column.cellsformat, me.gridlocalization);
                    filtergroup.addfilter(operatorindex, filter2);
                    isvalidfilter = true;
                }

                if (isvalidfilter) {
                    var datafield = column.displayfield;
                    this.addfilter(datafield, filtergroup, true);
                }
                else {
                    this._clearfilter(me, element, column);
                }
            }
            else {
                var that = this;
                var hasFilter = false;
                var widget = condition.data().jqxListBox.instance;
                var checkedItems = widget.getCheckedItems();
                if (checkedItems.length == 0) {
                    for (var i = 1; i < widget.items.length; i++) {
                        var filtervalue = widget.items[i].value;
                        var filtercondition = 'not_equal';
                    
                        var filter = filtergroup.createfilter(filtertype, filtervalue, filtercondition, null);
                        filtergroup.addfilter(0, filter);
                    }

                    hasFilter = true;
                }
                else {
                    if (checkedItems.length != widget.items.length) {
                        hasFilter = true;
                        for (var i = 0; i < checkedItems.length; i++) {
                            if (me.gridlocalization.filterselectallstring === checkedItems[i].value)
                                continue;

                            var filtervalue = checkedItems[i].value;
                            var filtercondition = 'equal';
            
                            var filter = filtergroup.createfilter(filtertype, filtervalue, filtercondition, null);
                            var filter_or_operator = 1;
                            filtergroup.addfilter(filter_or_operator, filter);
                        }
                    }
                    else hasFilter = false;
                }
                if (hasFilter) {
                    var datafield = column.displayfield;
                    this.addfilter(datafield, filtergroup, true);
                }
                else {
                    var datafield = column.displayfield;
                    this.removefilter(datafield, true);
                }
            }     
        },

        _clearfilter: function (me, element, column) {
            var datafield = column.displayfield;
            this.removefilter(datafield, true);
        },

        addfilter: function (datafield, filter, apply) {
            if (this._loading) {
                throw new Error('jqxGrid: ' + this.loadingerrormessage);
                return false;
            }

            var columnbydatafield = this.getcolumn(datafield);
            var _columnbydatafield = this._getcolumn(datafield);
            if (columnbydatafield == undefined || columnbydatafield == null)
                return;

            columnbydatafield.filter = filter;
            _columnbydatafield.filter = filter;

            this.dataview.addfilter(datafield, filter);
            if (apply == true && apply != undefined) {
                this.applyfilters('add');
            }
        },

        // removes a filter.
        removefilter: function (datafield, apply) {
            if (this._loading) {
                throw new Error('jqxGrid: ' + this.loadingerrormessage);
                return false;
            }

            var columnbydatafield = this.getcolumn(datafield);
            var _columnbydatafield = this._getcolumn(datafield);
            if (columnbydatafield == undefined || columnbydatafield == null)
                return;

            if (columnbydatafield.filter == null)
                return;

            this.dataview.removefilter(datafield, columnbydatafield.filter);
            columnbydatafield.filter = null;
            _columnbydatafield.filter = null;

            if (apply == true || apply !== false) {
                this.applyfilters('remove');
            }
        },

        applyfilters: function (reason) {
            var customfilter = false;

            if (this.dataview.filters.length >= 0 && (this.virtualmode || !this.source.localdata)) {
                if (this.source != null && this.source.filter) {
                    var tmppage = -1;
                    if (this.pageable) {
                        tmppage = this.dataview.pagenum;
                        this.dataview.pagenum = 0;
                    }
                    else {
                        this.vScrollInstance.setPosition(0);
                        this.loadondemand = true;
                        this._renderrows(this.virtualsizeinfo);
                    }

                    this.source.filter(this.dataview.filters, this.dataview.records, this.dataview.records.length);
                    if (this.pageable) {
                        this.dataview.pagenum = tmppage;
                    }
                }
            }
            if (this.dataview.clearsortdata) {
                this.dataview.clearsortdata();
            }
            if (!this.virtualmode) {
                var selectedrowindexes = this.selectedrowindexes;
                var me = this.that;
                this.dataview.refresh();
                if (this.dataview.clearsortdata) {
                    if (this.sortcolumn && this.sortdirection) {
                        var sortdirection = this.sortdirection.ascending ? "asc" : "desc";
                        if (!this._loading) {
                            this.sortby(this.sortcolumn, sortdirection, null, false);
                        }
                        else {
                            this.sortby(this.sortcolumn, sortdirection, null, false, false);
                        }
                    }
                }

            }
            else {
                if (this.pageable) {
                    this.dataview.updateview();
                    if (this.gotopage) {
                        this.gotopage(0);
                    }
                }
                this.rendergridcontent(false, false);
                if (this.showfilterrow) {
                    if (typeof reason != 'string' && $.isEmptyObject(reason)) {
                        this.refreshfilterrow();
                    }
                }
                this._raiseEvent(13, { filters: this.dataview.filters });
                return;
            }

            if (this.pageable) {
                this.dataview.updateview();
                if (this.gotopage) {
                    this.gotopage(0);
                    this.updatepagerdetails();
                }
            }
            this._updaterowsproperties();
            if (!this.groupable || (this.groupable && this.groups.length == 0)) {
                this._rowdetailscache = new Array();
                this.virtualsizeinfo = null;
                this._pagescache = new Array();
                if (this.columns && this.columns.records && this.columns.records.length > 0 && !this.columns.records[0].filtericon) {
                    this.prerenderrequired = true;
                }
                // it is not necessary to update the columns and that's why the second param is false.
                this.rendergridcontent(true, false);
                this._updatecolumnwidths();
                this._updatecellwidths();
                this._renderrows(this.virtualsizeinfo);
                if (this.showaggregates && this._updatecolumnsaggregates) {
                    this._updatecolumnsaggregates();
                }
            }
            else {
                this._rowdetailscache = new Array();
                this._render(true, true, false, false, false);
                if (this.showfilterrow) this._updatefocusedfilter();
                this._updatecolumnwidths();
                this._updatecellwidths();
                this._renderrows(this.virtualsizeinfo);
            }
            if (this.showfilterrow) {
                if (typeof reason != 'string' && $.isEmptyObject(reason)) {
                    this.refreshfilterrow();
                }
            }

            this._raiseEvent(13, { filters: this.dataview.filters });
        },

        getfilterinformation: function () {
            var filters = new Array();
            for (var i = 0; i < this.dataview.filters.length; i++) {
                var column = this.getcolumn(this.dataview.filters[i].datafield);
                filters[i] = { filter: this.dataview.filters[i].filter, filtercolumn: column.datafield, filtercolumntext: column.text };
            }
            return filters;
        },

        clearfilters: function (apply) {
            var me = this.that;
            if (this.showfilterrow) {
                this.clearfilterrow();
            }

            if (this.columns.records) {
                var canApply = apply == true || apply !== false;
                $.each(this.columns.records, function () {
                    me.removefilter(this.displayfield, !canApply);
                });
            }

            if (apply === false)
                return;

            if (apply == true || apply !== false) {
                this.applyfilters('clear');
            }
        },

        _destroyfilterpanel: function () {
            var clearbutton = $($.find('#filterclearbutton' + this.element.id));
            var filterbutton = $($.find('#filterbutton' + this.element.id));
            var condition = $($.find('#filter1' + this.element.id));
            var filteroperator = $($.find('#filter2' + this.element.id));
            var condition2 = $($.find('#filter3' + this.element.id));
            var input1 = $($.find('.filtertext1' + this.element.id));
            var input2 = $($.find('.filtertext2' + this.element.id));
            if (input1.length > 0 && input2.length > 0) {
                input1.removeClass();
                input2.removeClass();
                input1.remove();
                input2.remove();
            }

            if (clearbutton.length > 0) {
                clearbutton.jqxButton('destroy');
                filterbutton.jqxButton('destroy');
                this.removeHandler(clearbutton, 'click');
                this.removeHandler(filterbutton, 'click');
            }

            if (condition.length > 0) {
                condition.jqxDropDownList('destroy');
            }
            if (filteroperator.length > 0) {
                filteroperator.jqxDropDownList('destroy');
            }
            if (condition2.length > 0) {
                condition2.jqxDropDownList('destroy');
            }
        },

        _initfilterpanel: function (me, element, column, width) {
            if (me == null || me == undefined) me = this;
            element[0].innerHTML = "";
            var filterpanelcontainer = $("<div class='filter' style='margin-left: 7px;'></div>");

            element.append(filterpanelcontainer);
            var showwhere = $("<div class='filter' style='margin-top: 3px; margin-bottom: 3px;'></div>");
            showwhere.text(me.gridlocalization.filtershowrowstring);
            var condition = $("<div class='filter' id='filter1" + me.element.id + "'></div>");
            var operator = $("<div class='filter' id='filter2" + me.element.id + "' style='margin-bottom: 3px;'></div>");
            var condition2 = $("<div class='filter' id='filter3" + me.element.id + "'></div>");
            var type = me._getcolumntypebydatafield(column);

            if (!condition.jqxDropDownList) {
                throw new Error('jqxGrid: jqxdropdownlist.js is not loaded.');
                return;
            }

            var source = me._getfiltersbytype(type);

            var input = $("<div class='filter'><input class='filtertext1" + me.element.id + "' style='height: 20px; margin-top: 3px; margin-bottom: 3px;' type='text'></input></div>");
            var textField = input.find('input');
            textField.addClass(this.toThemeProperty('jqx-input'));
            textField.addClass(this.toThemeProperty('jqx-widget-content'));
            textField.addClass(this.toThemeProperty('jqx-rc-all'));
            textField.width(width - 15);
            var input2 = $("<div class='filter'><input class='filtertext2" + me.element.id + "' style='height: 20px; margin-top: 3px;' type='text'></input></div>");
            var textField2 = input2.find('input');
            textField2.addClass(this.toThemeProperty('jqx-input'));
            textField2.addClass(this.toThemeProperty('jqx-widget-content'));
            textField2.addClass(this.toThemeProperty('jqx-rc-all'));
            textField2.width(width - 15);

            if (me.rtl) {
                textField.css('direction', 'rtl');
                textField2.css('direction', 'rtl');
            }

            var applyinput = $("<div class='filter' style='height: 25px; margin-left: 20px; margin-top: 7px;'></div>");
            var filterbutton = $('<span tabIndex=0 id="filterbutton' + me.element.id + '" class="filterbutton" style="padding: 4px 12px; margin-left: 2px;">' + me.gridlocalization.filterstring + '</span>');
            applyinput.append(filterbutton);
            var filterclearbutton = $('<span tabIndex=0 id="filterclearbutton' + me.element.id + '" class="filterclearbutton" style="padding: 4px 12px; margin-left: 5px;">' + me.gridlocalization.filterclearstring + '</span>');
            applyinput.append(filterclearbutton);

            filterbutton.jqxButton({ height: 20, theme: me.theme });
            filterclearbutton.jqxButton({ height: 20, theme: me.theme });

            var selectionrenderer = function (selectionelement) {
                if (selectionelement) {
                    if (selectionelement.text().indexOf("case sensitive") != -1) {
                        var selectiontext = selectionelement.text();
                        selectiontext = selectiontext.replace("case sensitive", "match case");
                        selectionelement.text(selectiontext);
                    }
                    selectionelement.css('font-family', me.host.css('font-family'));
                    selectionelement.css('font-size', me.host.css('font-size'));

                    return selectionelement;
                }
                return "";
            }

            if (this.filtermode === "default") {
                filterpanelcontainer.append(showwhere);
                filterpanelcontainer.append(condition);
                condition.jqxDropDownList({ rtl: me.rtl, enableBrowserBoundsDetection: false, selectedIndex: 2, width: width - 15, height: 20, dropDownHeight: 150, dropDownWidth: width - 15, selectionRenderer: selectionrenderer, source: source, theme: me.theme });
                filterpanelcontainer.append(input);
                var operators = new Array();
                operators[0] = me.gridlocalization.filterandconditionstring;
                operators[1] = me.gridlocalization.filterorconditionstring;
                operator.jqxDropDownList({ rtl: me.rtl, enableBrowserBoundsDetection: false, autoDropDownHeight: true, selectedIndex: 0, width: 60, height: 20, source: operators, selectionRenderer: selectionrenderer, theme: me.theme });
                filterpanelcontainer.append(operator);
                condition2.jqxDropDownList({ rtl: me.rtl, enableBrowserBoundsDetection: false, selectedIndex: 2, width: width - 15, height: 20, dropDownHeight: 150, dropDownWidth: width - 15, selectionRenderer: selectionrenderer, source: source, theme: me.theme });
                filterpanelcontainer.append(condition2);
                filterpanelcontainer.append(input2);
            }
            else {
                filterpanelcontainer.append(showwhere);
                filterpanelcontainer.append(condition);
                condition.jqxListBox({ rtl: me.rtl, checkboxes: true, selectedIndex: 2, width: width - 15, height: 120, theme: me.theme });
                var handleCheckChange = true;
                me.addHandler(condition, 'checkChange', function (event) {
                    if (!handleCheckChange)
                        return;

                    if (event.args.label != me.gridlocalization.filterselectallstring) {
                        handleCheckChange = false;
                        condition.jqxListBox('checkIndex', 0, true, false);
                        var checkedItems = condition.jqxListBox('getCheckedItems');
                        var items = condition.jqxListBox('getItems');

                        if (checkedItems.length == 1) {
                            condition.jqxListBox('uncheckIndex', 0, true, false);
                        }
                        else if (items.length != checkedItems.length) {
                            condition.jqxListBox('indeterminateIndex', 0, true, false);
                        }
                        handleCheckChange = true;
                    }
                    else {
                        handleCheckChange = false;
                        if (event.args.checked) {
                            condition.jqxListBox('checkAll', false);
                        }
                        else {
                            condition.jqxListBox('uncheckAll', false);
                        }

                        handleCheckChange = true;
                    }
                });
            }

            filterpanelcontainer.append(applyinput);
            if (me.updatefilterpanel) {
                me.updatefilterpanel(condition, condition2, operator, input, input2, filterbutton, filterclearbutton, null, null, source);
            }
        }
    });
})(jQuery);


(function ($) {
    $.jqx.dataview.grouping = function () {
        this.loadgrouprecords = function (startvisibleindex, startindex, endindex, filter, currentPageIndex, updated, rows, rl, diff) {
            var visualRows = startvisibleindex;
            var self = this;
            var groupHashCodes = new Array();
            for (var iGroupColumn = 0; iGroupColumn < self.groups.length; iGroupColumn++) {
                groupHashCodes[iGroupColumn] = self.generatekey();
            }
            var grouprecords = new Array();
            var grouprecordsindex = 0;
            var groupHashCodes = groupHashCodes;
            var hashRowGroups = new Array();

            var i = startindex;
            var currentRowIndex = startindex;
            var groupslength = self.groups.length;
            this.loadedrecords = new Array();

            this.bounditems = new Array();
            this.loadedrecords = new Array(); // all data records ready for rendering.
            this.loadedrootgroups = new Array(); // all groups ready for rendering
            this.loadedgroups = new Array(); // all groups ready for rendering
            this.loadedgroupsByKey = new Array(); // all groups ready for rendering
            this.sortedgroups = new Array();

            var hassortdata = this.sortdata != null;
            var data = hassortdata ? this.sortdata : this.records;
            if (this.pageable) {
                var tmpToString = Object.prototype.toString;
                var field = this.groups[0];
                Object.prototype.toString = (typeof field == "function") ? field : function () { return this[field] };
                if (!data.sort) {
                    var items = new Array();
                    var index = 0;
                    $.each(data, function () {
                        items[startindex + index++] = this;
                    });
                    data = items;
                }

                if (!hassortdata) {
                    data.sort(function (value1, value2) {
                        if (value1 === undefined) { value1 = null; }
                        if (value2 === undefined) { value2 = null; }
                        if (value1 === null && value2 === null) {
                            return 0;
                        }
                        if (value1 === null && value2 !== null) {
                            return 1;
                        }
                        if (value1 !== null && value2 === null) {
                            return -1;
                        }

                        value1 = value1.toString();
                        value2 = value2.toString();

                        if ($.jqx.dataFormat.isNumber(value1) && $.jqx.dataFormat.isNumber(value2)) {
                            if (value1 < value2) { return -1; }
                            if (value1 > value2) { return 1; }
                            return 0;
                        }
                        else if ($.jqx.dataFormat.isDate(value1) && $.jqx.dataFormat.isDate(value2)) {
                            if (value1 < value2) { return -1; }
                            if (value1 > value2) { return 1; }
                            return 0;
                        }
                        else if (!$.jqx.dataFormat.isNumber(value1) && !$.jqx.dataFormat.isNumber(value2)) {
                            value1 = String(value1).toLowerCase();
                            value2 = String(value2).toLowerCase();
                        }

                        try {
                            if (value1 < value2) { return -1; }
                            if (value1 > value2) { return 1; }
                        }
                        catch (error) {
                            var er = error;
                        }

                        return 0;
                    });
                }
                else {
                    data.sort(function (value1, value2) {
                        var value1 = value1.value;
                        var value2 = value2.value;
                        if (value1 === undefined) { value1 = null; }
                        if (value2 === undefined) { value2 = null; }
                        if (value1 === null && value2 === null) {
                            return 0;
                        }
                        if (value1 === null && value2 !== null) {
                            return 1;
                        }
                        if (value1 !== null && value2 === null) {
                            return -1;
                        }

                        if ($.jqx.dataFormat.isNumber(value1) && $.jqx.dataFormat.isNumber(value2)) {
                            if (value1 < value2) { return -1; }
                            if (value1 > value2) { return 1; }
                            return 0;
                        }
                        else if ($.jqx.dataFormat.isDate(value1) && $.jqx.dataFormat.isDate(value2)) {
                            if (value1 < value2) { return -1; }
                            if (value1 > value2) { return 1; }
                            return 0;
                        }
                        else if (!$.jqx.dataFormat.isNumber(value1) && !$.jqx.dataFormat.isNumber(value2)) {
                            value1 = String(value1).toLowerCase();
                            value2 = String(value2).toLowerCase();
                        }

                        try {
                            if (value1 < value2) { return -1; }
                            if (value1 > value2) { return 1; }
                        }
                        catch (error) {
                            var er = error;
                        }

                        return 0;
                    });
                }
                Object.prototype.toString = tmpToString;
            }

            if (this.virtualmode) {
                var items = new Array();
                var index = 0;
                for (var i = 0; i < endindex - startindex; i++) {
                    items[startindex + index++] = data[i];
                }
                data = items;
            }

            for (var obj = startindex; obj < endindex; obj++) {
                var item = {};

                if (!hassortdata) {
                    item = $.extend({}, data[obj]);
                }
                else {
                    item = $.extend({}, data[obj].value);
                }

                id = item[self.uniqueId];


                if (currentPageIndex >= rl || id != rows[currentPageIndex][self.uniqueId] || (updated && updated[id]))
                    diff[diff.length] = currentPageIndex;

                var itemKeysHierarchy = new Array();
                var keys = 0;
                for (var iGroupColumn = 0; iGroupColumn < groupslength; iGroupColumn++) {
                    var group = self.groups[iGroupColumn];
                    var value = item[group];
                    if (value == null) value = "";
                    itemKeysHierarchy[keys++] = { value: value, hash: groupHashCodes[iGroupColumn] };
                }

                if (itemKeysHierarchy.length != groupslength)
                    break;

                var parentItem = null;

                var lookupKey = "";
                var iLevel = -1;

                for (var q = 0; q < itemKeysHierarchy.length; q++) {
                    iLevel++;
                    var itemKey = itemKeysHierarchy[q].value;
                    var columnHash = itemKeysHierarchy[q].hash;
                    lookupKey = lookupKey + "_" + columnHash + "_" + itemKey;

                    if (hashRowGroups[lookupKey] != undefined && hashRowGroups[lookupKey] != null) {
                        parentItem = hashRowGroups[lookupKey];
                        continue;
                    }

                    if (parentItem == null) {
                        parentItem = { group: itemKey, subItems: new Array(), subGroups: new Array(), level: 0 };
                        grouprecords[grouprecordsindex++] = parentItem;
                        parentItem.uniqueid = self.generatekey();
                        self.loadedgroupsByKey[itemKey] = parentItem;
                    }
                    else {
                        var subItem = { group: itemKey, subItems: new Array(), subGroups: new Array(), parentItem: parentItem, level: parentItem.level + 1 };
                        self.loadedgroupsByKey[parentItem.uniqueid + '_' + itemKey] = subItem;
                        subItem.uniqueid = self.generatekey();
                        parentItem.subGroups[parentItem.subGroups.length++] = subItem;
                        parentItem = subItem;
                    }

                    hashRowGroups[lookupKey] = parentItem;
                }

                if (parentItem != null) {
                    if (!item.uid) {
                        item.uid = this.getid(this.source.id, item, i);
                    }

                    if (!hassortdata) {
                        item.boundindex = i;
                        this.recordsbyid["id" + item.uid] = data[obj];
                    }
                    else {
                        item.boundindex = data[obj].index;
                        this.recordsbyid["id" + item.uid] = data[obj].value;
                    }

                    this.bounditems[item.boundindex] = item;
                    this.sortedgroups[i] = item;
                    item.uniqueid = self.generatekey();
                    item.parentItem = parentItem;
                    item.level = parentItem.level + 1;

                    parentItem.subItems[parentItem.subItems.length++] = item;
                }
                else {
                    if (!item.uid) {
                        item.uid = this.getid(this.source.id, item, i);
                    }

                    if (!hassortdata) {
                        item.boundindex = i;
                        this.recordsbyid["id" + item.uid] = data[obj];
                    }
                    else {
                        item.boundindex = data[obj].index;
                        this.recordsbyid["id" + item.uid] = data[obj].value;
                    }

                    this.sortedgroups[i] = item;
                    this.bounditems[item.boundindex] = item;
                    item.uniqueid = self.generatekey();
                }

                currentPageIndex++;

                i++;
                currentRowIndex++;
            };

            var loopitems = function (self, group, visualRows) {
                for (var m = 0; m < group.subItems.length; m++) {
                    group.subItems[m].visibleindex = startvisibleindex + visualRows;
                    self.rows[visualRows] = group.subItems[m];
                    self.loadedrecords[visualRows] = group.subItems[m];
                    visualRows++;
                }
                return visualRows
            }

            var loopGroups = function (self, group, visualRows) {
                var totals = function (group) {
                    if (self.aggregates == true) {
                        var olditem = group;

                        var item = {};
                        if (olditem != null) {
                            item.level = olditem.level;
                            item.visibleindex = startvisibleindex + visualRows;
                            item.uniqueid = self.generatekey();
                            self.rows[visualRows] = item;
                            self.loadedrecords[visualRows++] = item;
                            item.totalsrow = true;

                            if (group.subItems.length > 0) {
                                olditem = group.subItems[group.subItems.length - 1];
                                item.parentItem = olditem.parentItem;
                                if (item.parentItem.subItems) {
                                    item.parentItem.subItems[item.parentItem.subItems.length] = item;
                                }
                            }
                            else if (group.subGroups.length > 0) {
                                olditem = group.subGroups[group.subGroups.length - 1];
                                item.level = olditem.level;
                                item.parentItem = group;
                                group.subGroups[group.subGroups.length] = item;
                            }
                        }
                    }
                }
                for (subGroup in group.subGroups) {
                    var currentGroup = group.subGroups[subGroup];
                    if (currentGroup.subGroups) {
                        self.loadedgroups[self.loadedgroups.length] = currentGroup;
                        currentGroup.visibleindex = startvisibleindex + visualRows;
                        self.rows[visualRows] = currentGroup;
                        self.loadedrecords[visualRows] = currentGroup;
                        visualRows++;
                        if (currentGroup.subGroups.length > 0) {
                            visualRows = loopGroups(self, currentGroup, visualRows);
                        }
                        else if (currentGroup.subItems.length > 0) {
                            visualRows = loopitems(self, currentGroup, visualRows);
                        }
                        totals(currentGroup);
                    }
                }
                if (group.subItems.length > 0) {
                    visualRows = loopitems(self, group, visualRows);
                }
                totals(group);
                return visualRows;
            }

            var grouprecordslength = grouprecords.length;
            this.loadedgroups = new Array();
            this.rows = new Array();
            var visualRows = 0;

            for (var i = 0; i < grouprecordslength; i++) {
                var group = grouprecords[i];
                this.loadedrootgroups[i] = group;
                this.loadedgroups[this.loadedgroups.length] = group;
                group.visibleindex = startvisibleindex + visualRows;
                this.rows[visualRows] = group;
                this.loadedrecords[visualRows] = group;
                visualRows++;
                visualRows = loopGroups(this, group, visualRows);
            }


            return visualRows;
        }


        this._updategroupsinpage = function (self, filter, currentRowIndex, currentPageIndex, rl, start, end) {
            // create rows.
            var rows = new Array();

            var diff = [];
            if (this.groupable && this.groups.length > 0) {
                var visualrows = 0;
                var hashRowGroups = new Array();
                var groupHashCodes = new Array();
                for (var iGroupColumn = 0; iGroupColumn < self.groups.length; iGroupColumn++) {
                    groupHashCodes[iGroupColumn] = self.generatekey();
                }
                var i = 0;
                var grouprecords = new Array();
                var grouprecordsindex = 0;
                if (end > this.totalrecords) {
                    end = this.totalrecords;
                }
           
                for (var obj = start; obj < end; obj++) {
                    var item = $.extend({}, self.sortedgroups[obj]);
                    id = item[self.uniqueId];

                    if (!self.pagesize || (currentRowIndex >= self.pagesize * self.pagenum && currentRowIndex < self.pagesize * (self.pagenum + 1))) {
                        if (currentPageIndex >= rl || id != rows[currentPageIndex][self.uniqueId] || (updated && updated[id]))
                            diff[diff.length] = currentPageIndex;

                        var itemKeysHierarchy = new Array();
                        var keys = 0;
                        for (var iGroupColumn = 0; iGroupColumn < self.groups.length; iGroupColumn++) {
                            var group = self.groups[iGroupColumn];
                            var value = item[group];

                            if (null == value)
                                value = "";

                            itemKeysHierarchy[keys++] = { value: value, hash: groupHashCodes[iGroupColumn] };
                        }

                        if (itemKeysHierarchy.length != self.groups.length)
                            break;

                        var parentItem = null;

                        var lookupKey = "";
                        var iLevel = -1;

                        for (var q = 0; q < itemKeysHierarchy.length; q++) {
                            iLevel++;
                            var itemKey = itemKeysHierarchy[q].value;
                            var columnHash = itemKeysHierarchy[q].hash;
                            lookupKey = lookupKey + "_" + columnHash + "_" + itemKey;

                            if (hashRowGroups[lookupKey] != undefined && hashRowGroups[lookupKey] != null) {
                                parentItem = hashRowGroups[lookupKey];
                                continue;
                            }

                            if (parentItem == null) {
                                parentItem = { group: itemKey, subItems: new Array(), subGroups: new Array(), level: 0 };
                                grouprecords[grouprecordsindex++] = parentItem;
                                var initialgroup = self.loadedgroupsByKey[itemKey];
                                if (initialgroup != undefined) {
                                    parentItem.visibleindex = initialgroup.visibleindex;
                                    parentItem.uniqueid = initialgroup.uniqueid;
                                }
                            }
                            else {
                                var subItem = { group: itemKey, subItems: new Array(), subGroups: new Array(), parentItem: parentItem, level: parentItem.level + 1 };
                                var initialgroup = self.loadedgroupsByKey[parentItem.uniqueid + '_' + itemKey];
                                subItem.visibleindex = initialgroup.visibleindex;
                                subItem.uniqueid = initialgroup.uniqueid;
                                parentItem.subGroups[parentItem.subGroups.length++] = subItem;
                                parentItem = subItem;
                            }

                            hashRowGroups[lookupKey] = parentItem;
                        }

                        if (parentItem != null) {
                            item.parentItem = parentItem;
                            item.level = parentItem.level + 1;
                            parentItem.subItems[parentItem.subItems.length++] = item;
                        }

                        currentPageIndex++;
                    }
                    i++;
                    currentRowIndex++;
                };

                var loopitems = function (self, group, visualrows) {
                    for (var m = 0; m < group.subItems.length; m++) {
                        rows[visualrows] = $.extend({}, group.subItems[m]);
                        visualrows++;
                    }
                    return visualrows;
                }

                var anysubitems = function (group) {
                    var hasitems = false;

                    for (subGroup in group.subGroups) {
                        var currentGroup = group.subGroups[subGroup];
                        if (currentGroup.subGroups) {
                            if (currentGroup.subGroups.length > 0) {
                                var result = anysubitems(currentGroup);
                                if (result) {
                                    hasitems = true;
                                    return true;
                                }
                            }
                            if (currentGroup.subItems.length > 0) {
                                hasitems = true;
                                return true;
                            }
                        }
                    }
                    if (group.subItems.length > 0) {
                        hasitems = true;
                        return true;
                    }
                    return hasitems;
                }

                var loopGroups = function (self, group, visualrows) {
                    for (subGroup in group.subGroups) {
                        var currentGroup = group.subGroups[subGroup];

                        if (currentGroup.subGroups) {
                            if (anysubitems(currentGroup)) {
                                rows[visualrows] = currentGroup;
                                visualrows++;
                                if (currentGroup.subGroups.length > 0) {
                                    visualrows = loopGroups(self, currentGroup, visualrows);
                                }
                                else if (currentGroup.subItems.length > 0) {
                                    visualrows = loopitems(self, currentGroup, visualrows);
                                }
                            }
                        }
                    }
                    if (group.subItems.length > 0) {
                        visualrows = loopitems(self, group, visualrows);
                    }
                    return visualrows;
                }

                var parentgroup = 0;
                for (var i = 0; i < grouprecords.length; i++) {
                    var group = grouprecords[i];

                    if (anysubitems(group)) {
                        rows[visualrows] = group;
                        visualrows++;
                        visualrows = loopGroups(this, group, visualrows);
                    }
                }
            }

            return rows;
        }
    }

    $.extend($.jqx._jqxGrid.prototype, {
        _initgroupsheader: function () {
            this.groupsheader.css('visibility', 'hidden');
            if (this._groupsheader()) {
                this.groupsheader.css('visibility', 'inherit');
                var me = this;
                var groupsheaderstring = this.gridlocalization.groupsheaderstring;
                this.groupsheaderdiv = this.groupsheaderdiv || $('<div style="width: 100%; position: relative;"></div>');
                this.groupsheaderdiv.height(this.groupsheaderheight);
                this.groupsheaderdiv.css('top', 0);
                this.groupsheader.append(this.groupsheaderdiv);
                this.groupheadersbounds = new Array();

                var groupslength = this.groups.length;

                // remove handlers and children.
                this.groupsheaderdiv.children().remove();
                this.groupsheaderdiv[0].innerHTML = '';

                var groups = new Array();
                if (groupslength > 0) {
                    $.each(this.groups, function (index) {
                        var groupcolumn = this;
                        var groupcolumninfo = me._getColumnText(this);
                        var text = groupcolumninfo.label;
                        var group = me._rendergroupcolumn(text, groupcolumn);
                        group.addClass(me.toThemeProperty('jqx-grid-group-column'));
                        me.groupsheaderdiv.append(group);
                        if (me.closeablegroups) {
                            var closebutton = $(group.find('.jqx-icon-close'));
                            if (me.isTouchDevice() && me.touchmode !== true) {
                                me.addHandler(closebutton, 'touchstart', function () {
                                    me.removegroupat(index);
                                    return false;
                                });
                            }
                            else {
                                me.addHandler(closebutton, 'click', function () {
                                    me.removegroupat(index);
                                    return false;
                                });
                            } 
                        }
                        if (me.sortable) {
                            me.addHandler(group, 'click', function () {
                                var columnitem = me.getcolumn(groupcolumn);
                                if (columnitem != null) {
                                    me._togglesort(columnitem);
                                }
                                return false;
                            });
                        }
                        groups[groups.length] = group;
                        me._handlegroupstocolumnsdragdrop(this, group);
                        if (index < groupslength - 1) {
                            var height = group.height();
                            var line = $('<div style="float: left; position: relative;"></div>');
                            if (me.rtl) {
                                line.css('float', 'right');
                            }

                            line.width(me.groupindentwidth / 3);
                            line.height(1);
                            line.css('top', height / 2);
                            line.addClass(me.toThemeProperty('jqx-grid-group-column-line'));
                            me.groupsheaderdiv.append(line);
                        }
                    });
                }
                else {
                    var emptygroupselement = $('<div style="position: relative;">' + groupsheaderstring + '</div>');
                    this.groupsheaderdiv.append(emptygroupselement);
                    if (this.rtl) {
                        emptygroupselement.addClass(this.toThemeProperty('jqx-rtl'));
                    }
                }

                this._groupheaders = groups;
                this._updategroupheadersbounds();
            }
        },

        _updategroupheadersbounds: function () {
            var me = this;
            var headerdivheight = this.groupsheaderdiv.children().outerHeight();
            var top = (this.groupsheader.height() - headerdivheight) / 2;
            this.groupsheaderdiv.css('top', top);
            if (!this.rtl) {
                this.groupsheaderdiv.css('left', top);
            }
            else {
                this.groupsheaderdiv.css('right', top);
            }

            if (this.rtl) this._groupheaders.reverse();
            $.each(this._groupheaders, function (index) {
                var groupoffset = this.coord();
                me.groupheadersbounds[index] = { left: groupoffset.left, top: groupoffset.top, width: this.outerWidth(), height: this.outerHeight(), index: index };
            });

        },

        // adds a group.
        addgroup: function (datafield) {
            if (datafield) {
                var self = this;
                if (self.groups !== self.dataview.groups) {
                    self.dataview.groups = self.groups;
                }
                self.groups[self.groups.length] = datafield;
                self.refreshgroups();
                this._raiseEvent(12, { type: "Add", index: self.groups[self.groups.length], groups: self.groups });
            }
        },

        // inserts a new group.
        insertgroup: function (index, datafield) {
            if (index != undefined && index != null && index >= 0 && index <= this.groups.length) {
                if (datafield) {
                    var self = this;
                    if (self.groups !== self.dataview.groups) {
                        self.dataview.groups = self.groups;
                    }
                    self.groups.splice(index, 0, datafield);
                    self.refreshgroups();
                    this._raiseEvent(12, { type: "Insert", index: index, groups: self.groups });
                }
            }
        },

        refreshgroups: function () {
            this._refreshdataview();
            this._render(true, true, true, false);
        },

        _insertaftergroup: function (groupfield, datafield) {
            var index = this._getGroupIndexByDataField(groupfield);
            this.insertgroup(index + 1, datafield);
        },

        _insertbeforegroup: function (groupfield, datafield) {
            var index = this._getGroupIndexByDataField(groupfield);
            this.insertgroup(index, datafield);
        },

        // removes a group by index.
        removegroupat: function (index) {
            if (index >= 0 && index != null && index != undefined) {
                var self = this;
                if (self.groups !== self.dataview.groups) {
                    self.dataview.groups = self.groups;
                }
                self.groups.splice(index, 1);
                self.refreshgroups();
                if (self.virtualmode) {
                    self.updatebounddata();
                }
                this._raiseEvent(12, { type: "Remove", index: index, groups: self.groups });
                return true;
            }
            return false;
        },

        cleargroups: function () {
            var self = this;
            self.groups = [];
            self.dataview.groups = self.groups;
            self.refreshgroups();
            this._raiseEvent(12, { type: "Clear", groups: self.groups });
            return true;
        },

        // removes a group by datafield
        removegroup: function (datafield) {
            if (datafield == null)
                return false;

            var index = this.groups.indexOf(datafield.toString());
            return this.removegroupat(index);
        },


        // gets the number of root groups.
        getrootgroupscount: function () {
            var count = this.dataview.loadedrootgroups.length;
            return count;
        },

        // collapses a group.
        collapsegroup: function (index) {
            return this._setrootgroupstate(index, false);
        },

        // expands a group.
        expandgroup: function (index) {
            return this._setrootgroupstate(index, true);
        },

        // collapses all groups.
        collapseallgroups: function (refresh) {
            this._setbatchgroupstate(false, refresh);
        },

        // expands all groups.
        expandallgroups: function (refresh) {
            this._setbatchgroupstate(true, refresh);
        },

        // gets a group by index.
        getgroup: function (index) {
            var group = this.dataview.loadedrootgroups[index];
            if (group == null)
                return null;

            var expanded = this.expandedgroups[group.uniqueid].expanded;
            var groupname = group.group;
            var level = group.level;

            var subgroups = new Array();
            this._getsubgroups(subgroups, group);
            var me = this;
            var obj = { group: groupname, level: level, expanded: expanded, subgroups: subgroups };
            if (group.subItems) {
                var items = new Array();
                $.each(group.subItems, function () {
                    var index = this.boundindex;
                    items[items.length] = me.getrowdata(index);
                });
                if (items.length > 0) {
                    obj.subrows = items;
                }
            }

            return obj;
        },

        getrootgroups: function () {
            var count = this.dataview.loadedrootgroups.length;
            var groups = new Array();
            for (var m = 0; m < count; m++) {
                groups[m] = this.getgroup(m);
            }
            return groups;
        },
    
        _getsubgroups: function (subgroups, group) {
            var me = this;
            for (obj in group.subGroups) {
                var subGroup = group.subGroups[obj];
                var expanded = me.expandedgroups[subGroup.uniqueid].expanded;
                var groupname = subGroup.group;
                var level = subGroup.level;
                subgroups[subgroups.length] = { group: groupname, level: level, expanded: expanded };
                if (subGroup.subItems) {
                    var items = new Array();
                    $.each(subGroup.subItems, function () {
                        var index = this.boundindex;
                        items[items.length] = me.getrowdata(index);
                    });
                    subgroups[subgroups.length - 1].subrows = items;
                }
                if (subGroup.subGroups) {
                    var childsubgroups = new Array();
                    me._getsubgroups(childsubgroups, subGroup);
                }
            }

            return subgroups;
        },

        _setbatchgroupstate: function (expanded, update) {
            var me = this;
            for (obj in this.dataview.loadedrootgroups) {
                me._setrootgroupstate(obj, expanded, false, true);
            }

            if (update == false) {
                me._requiresupdate = true;
                me._renderrows(me.virtualsizeinfo);
                return true;
            }

            var scrollBarVisibility = this.vScrollBar[0].style.visibility;
            this.rendergridcontent(true, false);
            if (scrollBarVisibility != this.vScrollBar[0].style.visibility || this._hiddencolumns) {
                this._updatecolumnwidths();
                this._updatecellwidths();
                this._renderrows(this.virtualsizeinfo);
            }

            return true;
        },

        _setrootgroupstate: function (index, expanded, refresh, applytosubgroups) {
            if (index == undefined || index == null || index < 0)
                return false;

            if (!this.groupable || this.groups.length == 0)
                return false;

            var update = refresh != undefined ? refresh : true;

            if (index >= 0 && index < this.dataview.loadedrootgroups.length) {
                var group = this.dataview.loadedrootgroups[index];
                if (this.pageable) {
                    var rootgroups = new Array();
                    for (var i = 0; i < this.dataview.rows.length; i++) {
                        if (this.dataview.rows[i].group != null && this.dataview.rows[i].level === 0) {
                            rootgroups.push(this.dataview.rows[i]);
                        }
                    }

                    group = rootgroups[index];
                    if (!group) {
                        return;
                    }
                }

                return this._setgroupstate(group, expanded, update, applytosubgroups);
            }

            return false;
        },

        _togglegroupstate: function (group, update) {
            if (group == null || group == undefined)
                return false;

            var scrollPosition = this.vScrollInstance.value;
            var groupstate = this.expandedgroups[group.uniqueid];
            if (groupstate == undefined) {
                groupstate = false;
            }
            else {
                groupstate = groupstate.expanded;
            }
            groupstate = !groupstate;
            var result = this._setgroupstate(group, groupstate, update);
            if (scrollPosition !== 0 && this.vScrollBar.css('visibility') !== 'hidden') {
                if (scrollPosition <= this.vScrollInstance.max) {
                    this.vScrollInstance.setPosition(scrollPosition);
                }
                else {
                    this.vScrollInstance.setPosition(this.vScrollInstance.max);
                }
            } return result;
        },

        _setgroupstate: function (group, expanded, update, applytosubgroups) {
            if (group == null || group == undefined)
                return false;

            var isDirty = false;
                
            if (this.editable && this.editcell) {
                this.endcelledit(this.editcell.row, this.editcell.column, false, false);
            }

            var groupstate = this.expandedgroups[group.uniqueid];
            if (groupstate == undefined) {
                groupstate = { expanded: false };
                isDirty = true;
            }

            if (groupstate.expanded != expanded) {
                isDirty = true;
            }

            if (isDirty) {
                this.expandedgroups[group.uniqueid] = { expanded: expanded, group: group };
                this._setsubgroupsvisibility(this, group, !expanded, applytosubgroups);
                if (update) {
                    var scrollBarVisibility = this.vScrollBar[0].style.visibility;
                    this.rendergridcontent(true, false);
                    if (scrollBarVisibility != this.vScrollBar[0].style.visibility || this._hiddencolumns) {
                        this._updatecolumnwidths();
                        this._updatecellwidths();
                        this._renderrows(this.virtualsizeinfo);
                    }
                }

                if (undefined == this.suspendgroupevents || this.suspendgroupevents == false) {
                    if (expanded) {
                        this._raiseEvent(4, { group: group.group, parentgroup: group.parentItem ? group.parentItem.group : null, level: group.level, visibleindex: group.visibleindex });
                    }
                    else {
                        this._raiseEvent(5, { group: group.group, parentgroup: group.parentItem ? group.parentItem.group : null, level: group.level, visibleindex: group.visibleindex });
                    }
                }

                return true;
            }

            return false;
        },

        _setgroupitemsvisibility: function (self, group, hidden) {
            for (var m = 0; m < group.subItems.length; m++) {
                self._setrowvisibility(group.subItems[m].visibleindex, hidden, false);
            }
        }, 
        
        _setsubgroupsvisibility: function (self, group, hidden, applytosubgroups) {
            if (group.parentItem != null) {
                if (this.hiddens[group.parentItem.visibleindex])
                    return;
            }
            else if (group.parentItem == null) {
                if (this.hiddens[group.visibleindex])
                    return;
            }

            for (subGroup in group.subGroups) {
                var currentGroup = group.subGroups[subGroup];

                if (!hidden) {
                    self._setrowvisibility(currentGroup.visibleindex, hidden, false);
                }

                var expanded = !hidden;

                if (!applytosubgroups) {
                    if (self.expandedgroups[currentGroup.uniqueid] == undefined) {
                        expanded = false;
                    }
                    else {
                        expanded = self.expandedgroups[currentGroup.uniqueid].expanded;
                    }
                }
                else {
                    this.expandedgroups[currentGroup.uniqueid] = { expanded: expanded, group: currentGroup };
                }

                if (currentGroup.subGroups) {
                    if (currentGroup.subGroups.length > 0) {
                        self._setsubgroupsvisibility(self, currentGroup, !expanded || hidden, applytosubgroups);
                    }
                    else if (currentGroup.subItems.length > 0) {
                        self._setgroupitemsvisibility(self, currentGroup, !expanded || hidden);
                    }
                }

                if (hidden) {
                    self._setrowvisibility(currentGroup.visibleindex, hidden, false);
                }
            }
            if (group.subItems && group.subItems.length > 0) {
                self._setgroupitemsvisibility(self, group, hidden);
            }
        },


        
        _handlecolumnsdragdrop: function () {
            var self = this;
            var dropindex = -1;
            var candrop = false;

            if (!self.groupable)
                return;

            var mousemove = 'mousemove.grouping' + this.element.id;
            var mousedown = 'mousedown.grouping' + this.element.id;
            var mouseup = 'mouseup.grouping' + this.element.id;

            var touchdevice = false;
            if (this.isTouchDevice() && this.touchmode !== true) {
                touchdevice = true;
                mousemove = $.jqx.mobile.getTouchEventName('touchmove') + '.grouping' + this.element.id;
                mousedown = $.jqx.mobile.getTouchEventName('touchstart') + '.grouping' + this.element.id;
                mouseup = $.jqx.mobile.getTouchEventName('touchend') + '.grouping' + this.element.id;
            }

            this.removeHandler($(document), mousemove);
            this.addHandler($(document), mousemove, function (event) {
                if (!self.showgroupsheader)
                    return true;

                if (self.dragcolumn != null) {
                    var left = parseInt(event.pageX);
                    var top = parseInt(event.pageY);
                    if (touchdevice) {
                        var touches = self.getTouches(event);
                        var touch = touches[0];
                        left = parseInt(touch.pageX);
                        top = parseInt(touch.pageY);
                    }
                    var hostoffset = self.host.coord();
                    var hostleft = parseInt(hostoffset.left);
                    var hosttop = parseInt(hostoffset.top);
                    if (self.dragmousedownoffset == undefined || self.dragmousedownoffset == null) {
                        self.dragmousedownoffset = { left: 0, top: 0 };
                    }

                    var leftposition = parseInt(left) - parseInt(self.dragmousedownoffset.left);
                    var topposition = parseInt(top) - parseInt(self.dragmousedownoffset.top);

                    self.dragcolumn.css({ left: leftposition + 'px', top: topposition + 'px' });
                    candrop = false;
                    if (left >= hostleft && left <= hostleft + self.host.width()) {
                        if (top >= hosttop && top <= hosttop + self.host.height()) {
                            candrop = true;
                        }
                    }
                    dropindex = -1;
                    if (candrop) {
                        self.dragcolumnicon.removeClass(self.toThemeProperty('jqx-grid-dragcancel-icon'));
                        self.dragcolumnicon.addClass(self.toThemeProperty('jqx-grid-drag-icon'));
                        var groupsheaderoffset = self.groupsheader.coord();
                        var groupsheaderbottom = groupsheaderoffset.top + self.groupsheader.height();
                        var datarecord = $.data(self.dragcolumn[0], 'datarecord');
                        if (datarecord) {
                            var indexingroups = self.groups.indexOf(datarecord.toString());
                        }
                        else {
                            var indexingroups = -1;
                        }

                        var candrag = (indexingroups == -1) || (self.groups.length > 1 && indexingroups > -1);

                        if (self.dropline != null) {
                            if (top >= groupsheaderoffset.top && top <= groupsheaderbottom) {
                                if (candrag) {
                                    dropindex = self._handlegroupdroplines(left);
                                }
                            }
                            else {
                                self.dropline.fadeOut('slow');
                            }
                        }
                    }
                    else {
                        if (self.dropline != null) {
                            self.dropline.fadeOut('slow');
                        }

                        self.dragcolumnicon.removeClass(self.toThemeProperty('jqx-grid-drag-icon'));
                        self.dragcolumnicon.addClass(self.toThemeProperty('jqx-grid-dragcancel-icon'));
                    }
                    if (touchdevice) {
                        event.preventDefault();
                        event.stopPropagation();
                        return false;
                    }
                    //   return false;
                }
            });

            this.removeHandler($(document), mouseup);
            this.addHandler($(document), mouseup, function (event) {
                if (!self.showgroupsheader)
                    return true;

                self.__drag = false;

                $(document.body).removeClass('jqx-disableselect');
                var left = parseInt(event.pageX);
                var top = parseInt(event.pageY);
                if (touchdevice) {
                    var touches = self.getTouches(event);
                    var touch = touches[0];
                    left = parseInt(touch.pageX);
                    top = parseInt(touch.pageY);
                }
                var hostoffset = self.host.coord();
                var hostleft = parseInt(hostoffset.left);
                var hosttop = parseInt(hostoffset.top);
                var groupsheaderheight = self.groupsheader.height();
                if (self.showtoolbar) {
                    hosttop += self.toolbarheight;
                }

                self.dragstarted = false;
                self.dragmousedown = null;
                if (self.dragcolumn != null) {
                    var datafield = $.data(self.dragcolumn[0], 'datarecord');
                    self.dragcolumn.remove();
                    self.dragcolumn = null;

                    if (datafield != null) {
                        if (!self.getcolumn(datafield).groupable) {
                            if (self.dropline != null) {
                                self.dropline.remove();
                                self.dropline = null;
                            }
                            return;
                        }

                        if (candrop) {
                            if (dropindex != -1) {
                                var index = dropindex.index;
                                var targetgroup = self.groups[index];
                            
                                var indexInGroups = self._getGroupIndexByDataField(datafield);
                                if (indexInGroups != index) {
                                    if (indexInGroups != undefined && indexInGroups >= 0) {
                                        self.groups.splice(indexInGroups, 1);
                                    }

                                    if (dropindex.position == 'before') {
                                        if (!self.rtl) {
                                            self._insertbeforegroup(targetgroup, datafield);
                                        }
                                        else {
                                            self._insertaftergroup(targetgroup, datafield);
                                        }
                                    }
                                    else {
                                        if (!self.rtl) {
                                            self._insertaftergroup(targetgroup, datafield);
                                        }
                                        else {
                                            self._insertbeforegroup(targetgroup, datafield);
                                        }
                                    }
                                }
                            }
                            else if (self.groups.length == 0) {
                                if (top > hosttop && top <= hosttop + groupsheaderheight) {
                                    self.addgroup(datafield);
                                }
                            }
                            else if (top > hosttop + groupsheaderheight) {
                                var indexInGroups = self._getGroupIndexByDataField(datafield);
                                self.removegroupat(indexInGroups);
                            }
                        }

                        if (self.dropline != null) {
                            self.dropline.remove();
                            self.dropline = null;
                        }
                    }
                    //  return false;
                }
            });
        },

        _getGroupIndexByDataField: function (datafield) {
            for (var i = 0; i < this.groups.length; i++) {
                if (this.groups[i] == datafield)
                    return i;
            }
            return -1;
        },

        _isColumnInGroups: function (column) {
            for (var i = 0; i < this.groups.length; i++) {
                if (this.groups[i] == column)
                    return true;
            }
            return false;
        },

        
        _handlegroupdroplines: function (left) {
            var self = this;
            var dropindex = -1;

            $.each(self.groupheadersbounds, function (index) {
                if (left <= this.left + this.width / 2) {
                    var groupleft = this.left - 3;
                    if (index > 0) {
                        groupleft = this.left - 1 - self.groupindentwidth / 6;
                    }

                    self.dropline.css('left', groupleft);
                    self.dropline.css('top', this.top);
                    self.dropline.height(this.height);
                    self.dropline.fadeIn('slow');
                    
                    dropindex = { index: index, position: 'before' };
                    if (self.rtl) {
                        dropindex = { index: self.groupheadersbounds.length - 1 - index, position: 'before' };                      
                    }

                    return false;
                }
                else if (left >= this.left + this.width / 2) {
                    self.dropline.css('left', 1 + this.left + this.width);
                    self.dropline.css('top', this.top);
                    self.dropline.height(this.height);
                    self.dropline.fadeIn('slow');
                    dropindex = { index: index, position: 'after' };
                    if (self.rtl) {
                        dropindex = { index: self.groupheadersbounds.length - 1 - index, position: 'after' };
                    }
                }
            });

            return dropindex;
        },

        
        _handlegroupstocolumnsdragdrop: function (datafield, column) {
            this.dragmousedown = null;
            this.dragmousedownoffset = null;
            this.dragstarted = false;
            this.dragcolumn = null;
            var me = this;
            var mousemove;

            var mousedownevent = 'mousedown';
            var mousemoveevent = 'mousemove';

            var touchdevice = false;
            if (this.isTouchDevice() && this.touchmode !== true) {
                touchdevice = true;
                mousedownevent = $.jqx.mobile.getTouchEventName('touchstart');
                mousemoveevent = $.jqx.mobile.getTouchEventName('touchmove');
            }
            this.addHandler(column, 'dragstart', function (event) {
                return false;
            });

            this.addHandler(column, mousedownevent, function (event) {
                if (!me.showgroupsheader)
                    return true;

                var left = event.pageX;
                var top = event.pageY;

                me.__drag = true;
                me.dragmousedown = { left: left, top: top };
                if (touchdevice) {
                    var touches = me.getTouches(event);
                    var touch = touches[0];
                    left = touch.pageX;
                    top = touch.pageY;
                    me.dragmousedown = { left: left, top: top };
                    if (event.preventDefault) {
                        event.preventDefault();
                    }
                }

                var offsetposition = $(event.target).coord();
                me.dragmousedownoffset = { left: parseInt(left) - parseInt(offsetposition.left), top: parseInt(top - offsetposition.top) };
            });

            this.addHandler(column, mousemoveevent, function (event) {
                if (!me.showgroupsheader)
                    return true;

                if (me.dragmousedown) {
                    mousemove = { left: event.pageX, top: event.pageY };
                    if (touchdevice) {
                        var touches = me.getTouches(event);
                        var touch = touches[0];
                        mousemove = { left: touch.pageX, top: touch.pageY };
                    }
                    if (!me.dragstarted && me.dragcolumn == null) {
                        var xoffset = Math.abs(mousemove.left - me.dragmousedown.left);
                        var yoffset = Math.abs(mousemove.top - me.dragmousedown.top);
                        if (xoffset > 3 || yoffset > 3) {
                            me._createdragcolumn(column, mousemove, true);
                            $(document.body).addClass('jqx-disableselect');
                            $.data(me.dragcolumn[0], 'datarecord', datafield);
                            if (event.preventDefault) {
                                event.preventDefault();
                            }
                        }
                    }
                }
            });
        },

        
        _createdragcolumn: function (column, position, hasdropline) {
            var me = this;
            var mousemove = position;

            me.dragcolumn = $('<div></div>');
            var columnclone = column.clone();
            me.dragcolumn.css('z-index', 999999);
            columnclone.css('border-width', '1px');
            columnclone.css('opacity', '0.4');
            var menubutton = $(columnclone.find('.' + me.toThemeProperty('jqx-grid-column-menubutton')));
            if (menubutton.length > 0) {
                menubutton.css('display', 'none');
            }
            var closebutton = $(columnclone.find('.jqx-icon-close'));
            if (closebutton.length > 0) {
                closebutton.css('display', 'none');
            }

            me.dragcolumnicon = $('<div style="z-index: 9999; position: absolute; left: 100%; top: 50%; margin-left: -18px; margin-top: -7px;"></div>');
            me.dragcolumnicon.addClass(me.toThemeProperty('jqx-grid-drag-icon'));
            me.dragcolumn.css('float', 'left');

            me.dragcolumn.css('position', 'absolute');
            var hostoffset = me.host.coord();
            columnclone.width(column.width() + 16);
            me.dragcolumn.append(columnclone);
            me.dragcolumn.height(column.height());
            me.dragcolumn.width(columnclone.width());
            me.dragcolumn.append(me.dragcolumnicon);
            $(document.body).append(me.dragcolumn);

            columnclone.css('margin-left', 0);
            columnclone.css('left', 0);
            columnclone.css('top', 0);
            me.dragcolumn.css('left', mousemove.left + me.dragmousedown.left);
            me.dragcolumn.css('top', mousemove.top + me.dragmousedown.top);

            if (hasdropline != undefined && hasdropline) {
                me.dropline = $('<div style="display: none; position: absolute;"></div>');

                me.dropline.width(2);
                me.dropline.addClass(me.toThemeProperty('jqx-grid-group-drag-line'));
                $(document.body).append(me.dropline);
            }
        },

        // gets column's groupable.
        iscolumngroupable: function (datafield) {
            return this._getcolumnproperty(datafield, 'groupable');
        },

        
        _handlecolumnstogroupsdragdrop: function (record, column) {
            this.dragmousedown = null;
            this.dragmousedownoffset = null;
            this.dragstarted = false;
            this.dragcolumn = null;

            var me = this;
            var mousemove;
            var touchdevice = false;
            if (this.isTouchDevice() && this.touchmode !== true) {
                touchdevice = true;
            }

            var mousedown = 'mousedown.drag';
            var mousemove = 'mousemove.drag';
            if (touchdevice) {
                mousedown = $.jqx.mobile.getTouchEventName('touchstart') + '.drag';
                mousemove = $.jqx.mobile.getTouchEventName('touchmove') + '.drag';
            }
            else {
                this.addHandler(column, 'dragstart', function (event) {
                    return false;
                });
            }

            this.addHandler(column, mousedown, function (event) {
                if (!me.showgroupsheader)
                    return true;

                me.__drag = true;

                if (me._isColumnInGroups(record.displayfield)) {
                    if (column.css('cursor') != 'col-resize') {
                        return true;
                    }
                    else return true;
                }
                if (false == record.groupable) {
                    return true;
                }

                var pagex = event.pageX;
                var pagey = event.pageY;
                if (touchdevice) {
                    var touches = me.getTouches(event);
                    var touch = touches[0];
                    pagex = touch.pageX;
                    pagey = touch.pageY;
                }

                me.dragmousedown = { left: pagex, top: pagey };
                if (touchdevice) {
                    if (event.preventDefault) event.preventDefault();
                }

                var offsetposition = $(event.target).coord();
                me.dragmousedownoffset = { left: parseInt(pagex) - parseInt(offsetposition.left), top: parseInt(pagey - offsetposition.top) };
            });

            this.addHandler(column, mousemove, function (event) {
                if (!me.showgroupsheader)
                    return true;

                if (me._isColumnInGroups(record.displayfield))
                    if (column.css('cursor') != 'col-resize') {
                        return true;
                    }
                    else {
                        return true;
                    }

                if (me.dragmousedown) {
                    var pagex = event.pageX;
                    var pagey = event.pageY;
                    if (touchdevice) {
                        var touches = me.getTouches(event);
                        var touch = touches[0];
                        pagex = touch.pageX;
                        pagey = touch.pageY;
                    }
                    mousemove = { left: pagex, top: pagey };
                    if (!me.dragstarted && me.dragcolumn == null) {
                        var xoffset = Math.abs(mousemove.left - me.dragmousedown.left);
                        var yoffset = Math.abs(mousemove.top - me.dragmousedown.top);
                        if (xoffset > 3 || yoffset > 3) {
                            me._createdragcolumn(column, mousemove, true);
                            $.data(me.dragcolumn[0], 'datarecord', record.displayfield);
                            if (event.preventDefault) {
                                event.preventDefault();
                            }
                        }
                    }
                }
            });
        },

        
        _rendergroupcolumn: function (text, groupcolumn) {
            var group = $('<div style="float: left; position: relative;"></div>');
            if (this.rtl) {
                group.css('float', 'right');
            }

            if (this.groupcolumnrenderer != null) {
                group[0].innerHTML = this.groupcolumnrenderer(text);
                group.addClass(this.toThemeProperty('jqx-grid-group-column'));
                group.addClass(this.toThemeProperty('jqx-fill-state-normal'));
            }

            if (this.closeablegroups) {
                if (group[0].innerHTML == '') {
                    group[0].innerHTML = '<a style="float: left;" href="#">' + text + '</a>';
                }
                if (this.rtl) {
                    group[0].innerHTML = '<a style="float: right;" href="#">' + text + '</a>';
                }
                var fl = !this.rtl ? 'right' : 'left';

                var closebutton = '<div style="float: ' + fl + '; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 100%; top: 50%; margin-left: -18px; margin-top: -8px; float: none; width: 16px; height: 16px;" class="' + this.toThemeProperty('jqx-icon-close') + '"></div></div>';
                if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                    closebutton = '<div style="float: left; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 100%; top: 50%; margin-left: -18px; margin-top: -8px; float: none; width: 16px; height: 16px;" class="' + this.toThemeProperty('jqx-icon-close') + '"></div></div>';
                }
                if (this.rtl) {
                    var closebutton = '<div style="float: ' + fl + '; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 0px; top: 50%; margin-top: -8px; float: none; width: 16px; height: 16px;" class="' + this.toThemeProperty('jqx-icon-close') + '"></div></div>';
                    if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                        closebutton = '<div style="float: left; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 0px; top: 50%; margin-top: -8px; float: none; width: 16px; height: 16px;" class="' + this.toThemeProperty('jqx-icon-close') + '"></div></div>';
                    }
                }

                group[0].innerHTML += closebutton;
            }
            else {
                if (group[0].innerHTML == '') {
                    group[0].innerHTML = '<a href="#">' + text + '</a>';
                }
            }

            if (this.sortable) {
                var sortasc = $('<div style="float: right; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 100%; top: 50%; margin-left: -16px; margin-top: -8px; float: none; width: 16px; height: 16px;" class="' + this.toThemeProperty('jqx-grid-column-sortascbutton') + '"></div></div>');
                var sortdesc = $('<div style="float: right; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 100%; top: 50%; margin-left: -16px; margin-top: -8px; float: none; width: 16px; height: 16px;" class="' + this.toThemeProperty('jqx-grid-column-sortdescbutton') + '"></div></div>');
                if (this.closeablegroups) {
                    var sortasc = $('<div style="float: right; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 100%; top: 50%; margin-left: -32px; margin-top: -8px; float: none; width: 16px; height: 16px;" class="' + this.toThemeProperty('jqx-grid-column-sortascbutton') + '"></div></div>');
                    var sortdesc = $('<div style="float: right; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 100%; top: 50%; margin-left: -32px; margin-top: -8px; float: none; width: 16px; height: 16px;" class="' + this.toThemeProperty('jqx-grid-column-sortdescbutton') + '"></div></div>');
                }
                if (this.rtl) {
                    var sortasc = $('<div style="float: right; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 0px; top: 50%; margin-left: 0px; margin-top: -8px; float: none; width: 16px; height: 16px;" class="' + this.toThemeProperty('jqx-grid-column-sortascbutton') + '"></div></div>');
                    var sortdesc = $('<div style="float: right; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 0px; top: 50%; margin-left: 0px; margin-top: -8px; float: none; width: 16px; height: 16px;" class="' + this.toThemeProperty('jqx-grid-column-sortdescbutton') + '"></div></div>');
                    if (this.closeablegroups) {
                        var sortasc = $('<div style="float: right; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 0px; top: 50%; margin-left: 16px; margin-top: -8px; float: none; width: 16px; height: 16px;" class="' + this.toThemeProperty('jqx-grid-column-sortascbutton') + '"></div></div>');
                        var sortdesc = $('<div style="float: right; min-height: 16px; min-width: 18px;"><div style="position: absolute; left: 0px; top: 50%; margin-left: 16px; margin-top: -8px; float: none; width: 16px; height: 16px;" class="' + this.toThemeProperty('jqx-grid-column-sortdescbutton') + '"></div></div>');
                    }
                }
                sortasc.css('display', 'none');
                sortdesc.css('display', 'none');
                if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                    sortasc.css('float', 'left');
                    sortdesc.css('float', 'left');
                }
                group.append(sortasc);
                group.append(sortdesc);
                $.data(document.body, "groupsortelements" + groupcolumn, { sortasc: sortasc, sortdesc: sortdesc });
            }

            group.addClass(this.toThemeProperty('jqx-fill-state-normal'));
            group.addClass(this.toThemeProperty('jqx-grid-group-column'));
            return group;
        },

        _rendergroup: function (groupslength, tablerow, renderrow, columnstart, columnend, renderedrows, tablewidth) {
            var visualrow = tablerow;
            var tablecell = tablerow.cells[renderrow.level];
            if (this.rtl) {
                tablecell = tablerow.cells[tablerow.cells.length - 1 - renderrow.level];
            }

            var expanded = this._findgroupstate(renderrow.uniqueid);
            if (renderrow.bounddata.subGroups.length > 0 || renderrow.bounddata.subItems.length > 0) {
                var rtl = this.rtl ? "-rtl" : "";
                if (expanded) {
                    tablecell.className += " " + this.toThemeProperty('jqx-grid-group-expand' + rtl);
                }
                else {
                    tablecell.className += " " + this.toThemeProperty('jqx-grid-group-collapse' + rtl);
                }
            }

            var text = this._getColumnText(this.groups[renderrow.level]).label;
            var indentwidth = this.groupindentwidth;
            var indent = this.rowdetails && this.showrowdetailscolumn ? (1 + groupslength) * indentwidth : (groupslength) * indentwidth;
            var width = tablewidth - indent;

            var start = renderrow.level + 1;
            if (this.rtl) {
                start = 0;
            }

            var cellToRender = visualrow.cells[start];
            var m = 2;
            while (cellToRender != undefined && cellToRender.style.display == 'none' && m < visualrow.cells.length-1) {
                cellToRender = visualrow.cells[start + m - 1];
                m++;
            }
         
            var $cellToRender = $(cellToRender);
            if (!cellToRender) {
                return;
            }
            cellToRender.style.width = parseInt(width) + 'px';
            if (cellToRender.className.indexOf('jqx-grid-cell-filter') != -1) {
                $cellToRender.removeClass(this.toThemeProperty('jqx-grid-cell-filter'));
            }
            if (cellToRender.className.indexOf('jqx-grid-cell-sort') != -1) {
                $cellToRender.removeClass(this.toThemeProperty('jqx-grid-cell-sort'));
            }
            if (cellToRender.className.indexOf('jqx-grid-cell-pinned') != -1) {
                $cellToRender.removeClass(this.toThemeProperty('jqx-grid-cell-pinned'));
            }

            if (this.groupsrenderer != null) {
                var groupdata = { group: renderrow.group, level: renderrow.level, parent: renderrow.bounddata.parentItem, subGroups: renderrow.bounddata.subGroups, subItems: renderrow.bounddata.subItems, groupcolumn: this._getColumnText(this.groups[renderrow.level]).column };
                var html = this.groupsrenderer(text + ': ' + renderrow.group, renderrow.group, expanded, groupdata);
                if (html) {
                    cellToRender.innerHTML = html;
                }
                else {
                    var count = renderrow.bounddata.subItems.length > 0 ? renderrow.bounddata.subItems.length : renderrow.bounddata.subGroups.length;
                    cellToRender.innerHTML = '<div class="' + this.toThemeProperty('jqx-grid-groups-row') + '" style="position: absolute;"><span>' + text + ': </span>' + '<span class="' + this.toThemeProperty('jqx-grid-groups-row-details') + '">' + renderrow.group + ' (' + count + ')' + '</span></div>';
                }
            }
            else {
                var column = this._getcolumnbydatafield(this.groups[renderrow.level]);
                var value = renderrow.group;
                if (column != null) {
                    if (column.cellsformat) {
                        if ($.jqx.dataFormat) {
                            if ($.jqx.dataFormat.isDate(value)) {
                                value = $.jqx.dataFormat.formatdate(value, column.cellsformat, this.gridlocalization);
                            }
                            else if ($.jqx.dataFormat.isNumber(value)) {
                                value = $.jqx.dataFormat.formatnumber(value, column.cellsformat, this.gridlocalization);
                            }
                        }
                    }
                    var count = renderrow.bounddata.subItems.length > 0 ? renderrow.bounddata.subItems.length : renderrow.bounddata.subGroups.length;
                    cellToRender.innerHTML = '<div class="' + this.toThemeProperty('jqx-grid-groups-row') + '" style="position: absolute;"><span>' + text + ': </span>' + '<span class="' + this.toThemeProperty('jqx-grid-groups-row-details') + '">' + value + ' (' + count + ')' + '</span></div>';
                }
                else throw new Error("jqxGrid: Unable to find '" + this.groups[renderrow.level] + "' group in the Grid's columns collection.");
            }
            if (this.rtl) {
                if (!column) {
                    column = this._getcolumnbydatafield(this.groups[renderrow.level])
                }
                var scrollValue = this.hScrollBar.css('visibility') == 'hidden' ? 0 : this.hScrollInstance.max - this.hScrollInstance.value;
                var scrollIndent = this.vScrollBar.css('visibility') == 'hidden' ? 0 : this.scrollbarsize + 6;
                var indent = this.rowdetails && this.showrowdetailscolumn ? (2 + renderrow.level) * indentwidth : (1 + renderrow.level) * indentwidth;
                cellToRender.style.width = tablewidth + parseInt(scrollValue) - indent - scrollIndent + 'px';
                $cellToRender.addClass(this.toThemeProperty('jqx-rtl'));
                //var zIndex = $cellToRender.css('z-index');
                var zIndex = $(tablerow.cells[tablerow.cells.length - 1]).css('z-index');
                $cellToRender.css('z-index', zIndex);
                var content = $cellToRender.find('div');
                var width = content.width();
                content.css('left', '100%');
                var pinnedColumn = this.columns.records[tablerow.cells.length - 2 - renderrow.level] != null ? this.columns.records[tablerow.cells.length - 2 - renderrow.level].pinned : false;
                if (this.table.width() < tablewidth) {
                    tablewidth = this.table.width();
                    if (this.vScrollBar.css('visibility') != 'hidden') {
                        tablewidth += this.vScrollBar.outerWidth();
                    }
                }
                if (column.pinned || pinnedColumn) {
                    if (this.rowdetails && this.showrowdetailscolumn) {
                        tablewidth += 30;
                    }
                    content.css('margin-left', -width);
                    cellToRender.style.width = tablewidth + scrollValue - indent - scrollIndent + 'px';
                }
                else {               
                    var scrollValue = this.hScrollBar.css('visibility') == 'hidden' ? 0 : this.hScrollInstance.max;
                    cellToRender.style.width = tablewidth + scrollValue - indent - scrollIndent + 'px';
                    var width = content.width();
                    content.css('margin-left', -width);
                }
            }
        }
    });
})(jQuery);(function ($) {
    $.extend($.jqx._jqxGrid.prototype, {
        _initpager: function () {
            var me = this.that;
            var pagergotopagestring = this.gridlocalization.pagergotopagestring;
            var pagerrangestring = this.gridlocalization.pagerrangestring;
            var pagershowrowsstring = this.gridlocalization.pagershowrowsstring;

            var top = (this.pagerheight - 17) / 2;

            this.pagerdiv = this.pagerdiv || $('<div style="width: 100%; height: 100%; position: relative;"></div>');
            if (!this.pageable) {
                this.pagerdiv.remove();
                this.vScrollBar.jqxScrollBar({ thumbSize: 0 });
                return;
            }

            if (!this.pagerrenderer) {
                this.pagerdiv.css('top', top);
                this.pager.append(this.pagerdiv);
                this.pagergotoinput = this.pagergotoinput || $('<div style="margin-right: 7px; width: 27px; height: 17px; float: right;"><input style="margin-top: 0px; text-align: right; width: 27px;" type="text"/></div>');
                this.pagergoto = this.pagergoto || $('<div style="float: right; margin-right: 7px;"></div>');
                this.pagerrightbutton = this.pagerrightbutton || $('<div type="button" style="padding: 0px; margin-top: 0px; margin-right: 3px; width: 27px; float: right;"></div>');
                this.pagerleftbutton = this.pagerleftbutton || $('<div type="button" style="padding: 0px; margin-top: 0px; margin-right: 3px; width: 27px; float: right;"></div>');
                this.pagerdetails = this.pagerdetails || $('<div style="margin-right: 7px; float: right;"></div>');
                this.pagershowrows = this.pagershowrows || $('<div style="margin-right: 7px; float: right;"></div>');
                this.pagerbuttons = $('<div style="margin-right: 3px; float: right;"></div>');
                if (this.pagershowrowscombo && this.pagershowrowscombo.jqxDropDownList) {
                    this.pagershowrowscombo.remove();
                    this.pagershowrowscombo = null;
                }
                this.pagergotoinput.attr('disabled', this.disabled);
                this.pagerfirstbutton = $('<div type="button" style="padding: 0px; margin-top: 0px; margin-left: 3px; margin-right: 3px; width: 27px; float: right;"></div>');
                this.pagerlastbutton = $('<div type="button" style="padding: 0px; margin-top: 0px; margin-right: 3px; width: 27px; float: right;"></div>');

                this.pagershowrowscombo = this.pagershowrowscombo || $('<div id="gridpagerlist" style="margin-top: 0px; margin-right: 7px; float: right;"></div>');
                this.pagerdiv.children().remove();
                this.pagershowrowscombo[0].id = "gridpagerlist" + this.element.id;
                this.removeHandler(this.pagerrightbutton, 'mousedown');
                this.removeHandler(this.pagerrightbutton, 'mouseup');
                this.removeHandler(this.pagerrightbutton, 'click');
                this.removeHandler(this.pagerleftbutton, 'mousedown');
                this.removeHandler(this.pagerleftbutton, 'mouseup');
                this.removeHandler(this.pagerleftbutton, 'click');
                this.removeHandler(this.pagerfirstbutton, 'mousedown');
                this.removeHandler(this.pagerfirstbutton, 'mouseup');
                this.removeHandler(this.pagerfirstbutton, 'click');
                this.removeHandler(this.pagerlastbutton, 'mousedown');
                this.removeHandler(this.pagerlastbutton, 'mouseup');
                this.removeHandler(this.pagerlastbutton, 'click');

                this.pagerleftbutton.attr('title', this.gridlocalization.pagerpreviousbuttonstring);
                this.pagerrightbutton.attr('title', this.gridlocalization.pagernextbuttonstring);

                if (this.pagermode == "simple") {
                    if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                        this.pagerbuttons.css('overflow', 'visible');
                        this.pagerbuttons.css('padding', '3px');
                    }

                    this.pagerfirstbutton.attr('title', this.gridlocalization.pagerfirstbuttonstring);
                    this.pagerlastbutton.attr('title', this.gridlocalization.pagerlastbuttonstring);
                    var firstarrow = $("<div style='margin-left: 6px; width: 15px; height: 15px;'></div>");
                    firstarrow.addClass(this.toThemeProperty('jqx-icon-arrow-first'));
                    this.pagerfirstbutton.wrapInner(firstarrow);

                    var lastarrow = $("<div style='margin-left: 6px; width: 15px; height: 15px;'></div>");
                    lastarrow.addClass(this.toThemeProperty('jqx-icon-arrow-last'));
                    this.pagerlastbutton.wrapInner(lastarrow);
                    if (!this.rtl) {
                        this.pagerdiv.append(this.pagerfirstbutton);
                        this.pagerdiv.append(this.pagerleftbutton);
                        this.pagerdiv.append(this.pagerbuttons);
                        this.pagerdiv.append(this.pagerrightbutton);
                        this.pagerdiv.append(this.pagerlastbutton);
                    }
                    else {
                        this.pagerdiv.append(this.pagerlastbutton);
                        this.pagerdiv.append(this.pagerrightbutton);
                        this.pagerdiv.append(this.pagerbuttons);
                        this.pagerdiv.append(this.pagerleftbutton);
                        this.pagerdiv.append(this.pagerfirstbutton);
                    }
                    this.pagerlastbutton.jqxButton({ cursor: 'pointer', disabled: this.disabled, theme: this.theme });
                    this.pagerfirstbutton.jqxButton({ cursor: 'pointer', disabled: this.disabled, theme: this.theme });
                    var floatMode = !this.rtl ? 'left' : 'right';
                    this.pagerbuttons.css('float', floatMode);
                    this.pagerlastbutton.css('float', floatMode);
                    this.pagerfirstbutton.css('float', floatMode);
                    this.pagerrightbutton.css('float', floatMode);
                    this.pagerleftbutton.css('float', floatMode);

                    this.pagerdetails.css('float', this.rtl ? 'left' : 'right');
                    if (this.rtl) {
                        this.pagerdetails.css('margin-left', '7px');
                        this.pagerdetails.css('margin-right', '0px');
                    }
                    else {
                        this.pagerdetails.css('margin-left', '0px');
                        this.pagerdetails.css('margin-right', '7px');
                    }

                    this.pagergotoinput.hide();
                    this.pagershowrowscombo.hide();
                    this.pagergoto.hide();
                    this.pagershowrows.hide();
                }
                else {
                    this.pagergotoinput.show();
                    this.pagershowrowscombo.show();
                    this.pagergoto.show();
                    this.pagershowrows.show();
                    if (!this.rtl) {
                        this.pagerdiv.append(this.pagerrightbutton);
                        this.pagerdiv.append(this.pagerleftbutton);
                    }
                }

                this.pagerrightbutton.jqxButton({ cursor: 'pointer', disabled: this.disabled, theme: this.theme });
                this.pagerleftbutton.jqxButton({ cursor: 'pointer', disabled: this.disabled, theme: this.theme });

                this.pagerleftbutton.find('.jqx-icon-arrow-left').remove();
                this.pagerrightbutton.find('.jqx-icon-arrow-right').remove();

                var leftarrow = $("<div style='margin-left: 6px; width: 15px; height: 15px;'></div>");
                leftarrow.addClass(this.toThemeProperty('jqx-icon-arrow-left'));
                this.pagerleftbutton.wrapInner(leftarrow);

                var rightarrow = $("<div style='margin-left: 6px; width: 15px; height: 15px;'></div>");
                rightarrow.addClass(this.toThemeProperty('jqx-icon-arrow-right'));
                this.pagerrightbutton.wrapInner(rightarrow);

                if (!this.rtl) {
                    this.pagerdiv.append(this.pagerdetails);
                }
                if (this.pagermode != "simple") {
                    if (!this.rtl) {
                        this.pagerdiv.append(this.pagershowrowscombo);
                        this.pagerdiv.append(this.pagershowrows);
                        this.pagerdiv.append(this.pagergotoinput);
                        this.pagerdiv.append(this.pagergoto);
                    }
                    else {
                        this.pagerdiv.append(this.pagergoto);
                        this.pagerdiv.append(this.pagergotoinput);
                        this.pagerdiv.append(this.pagershowrows);
                        this.pagerdiv.append(this.pagershowrowscombo);
                        this.pagerdiv.append(this.pagerdetails);
                        this.pagerdiv.append(this.pagerrightbutton);
                        this.pagerdiv.append(this.pagerleftbutton);

                    }
                }

                var source = this.pagesizeoptions;
                if (!this.pagershowrowscombo.jqxDropDownList) {
                    throw new Error('jqxGrid: jqxdropdownlist.js is not loaded.');
                    return;
                }

                this.pagershowrowscombo.jqxDropDownList({rtl: this.rtl, disabled: this.disabled, source: source, enableBrowserBoundsDetection: true, keyboardSelection: false, autoDropDownHeight: true, width: 44, height: 16, theme: this.theme });
                var selectedindex = 0;
                for (var i = 0; i < source.length; i++) {
                    if (this.pagesize >= source[i]) {
                        selectedindex = i;
                    }
                }
                this.pagershowrows[0].innerHTML = pagershowrowsstring;
                this.pagergoto[0].innerHTML = pagergotopagestring;
                this.updatepagerdetails();
                this.pagershowrowscombo.jqxDropDownList({ selectedIndex: selectedindex });
                this.pagerpageinput = this.pagergotoinput.find('input');
                this.pagerpageinput.addClass(this.toThemeProperty('jqx-input'));
                this.pagerpageinput.addClass(this.toThemeProperty('jqx-widget-content'));
                if (this.rtl) {
                    this.pagerpageinput.css('direction', 'rtl');
                }

                var me = this.that;
                this.removeHandler(this.pagershowrowscombo, 'select');
                this.addHandler(this.pagershowrowscombo, 'select', function (event) {
                    if (event.args) {
                        if (me.vScrollInstance) {
                            me.vScrollInstance.setPosition(0);
                        }

                        if (me.editcell != null && me.endcelledit) {
                            me.endcelledit(me.editcell.row, me.editcell.column, true, false);
                        }

                        var index = event.args.index;
                        var recordindex = me.dataview.pagenum * me.dataview.pagesize;
                        var pagesize = source[index];
                        var oldpagesize = me.pagesize;
                        me.pagesize = parseInt(pagesize);
                        if (isNaN(me.pagesize)) {
                            me.pagesize = 10;
                        }
                        if (pagesize >= 100) {
                            me.pagershowrowscombo.jqxDropDownList({ width: 55 });
                        }
                        else {
                            me.pagershowrowscombo.jqxDropDownList({ width: 44 });
                        }

                        me.dataview.pagesize = me.pagesize;
                        var pagenum = Math.floor(recordindex / me.dataview.pagesize);
                        me.prerenderrequired = true;
                        me._requiresupdate = true;
                        me._raiseEvent(10, { pagenum: pagenum, oldpagesize: oldpagesize, pagesize: me.dataview.pagesize });
                        me.gotopage(pagenum);
                        if (me.autoheight && me._updatesizeonwindowresize) {
                            me._updatesize(true);
                            setTimeout(function () {
                                me._updatesize(true);
                            }, 500);
                        }
                    }
                });

                var input = this.pagergotoinput.find('input');
                input.addClass(this.toThemeProperty('jqx-grid-pager-input'));
                input.addClass(this.toThemeProperty('jqx-rc-all'));
                this.removeHandler(input, 'keydown');
                this.removeHandler(input, 'change');
        
                this.addHandler(input, 'keydown', function (event) {
                    if (event.keyCode >= 65 && event.keyCode <= 90)
                        return false;

                    if (event.keyCode == '13') {
                        var val = input.val();
                        val = parseInt(val);
                        if (!isNaN(val)) {
                            me.gotopage(val - 1);
                        }
                        return false;
                    }
                });
                this.addHandler(input, 'change', function () {
                    var val = input.val();
                    val = parseInt(val);
                    if (!isNaN(val)) {
                        me.gotopage(val - 1);
                    }
                });

                this.addHandler(this.pagerrightbutton, 'mouseenter', function () {
                    rightarrow.addClass(me.toThemeProperty('jqx-icon-arrow-right-hover'));
                });

                this.addHandler(this.pagerleftbutton, 'mouseenter', function () {
                    leftarrow.addClass(me.toThemeProperty('jqx-icon-arrow-left-hover'));
                });

                this.addHandler(this.pagerrightbutton, 'mouseleave', function () {
                    rightarrow.removeClass(me.toThemeProperty('jqx-icon-arrow-right-hover'));
                });

                this.addHandler(this.pagerleftbutton, 'mouseleave', function () {
                    leftarrow.removeClass(me.toThemeProperty('jqx-icon-arrow-left-hover'));
                });

                this.addHandler(this.pagerrightbutton, 'mousedown', function () {
                    rightarrow.addClass(me.toThemeProperty('jqx-icon-arrow-right-selected'));
                });

                this.addHandler(this.pagerrightbutton, 'mouseup', function () {
                    rightarrow.removeClass(me.toThemeProperty('jqx-icon-arrow-right-selected'));
                });

                this.addHandler(this.pagerleftbutton, 'mousedown', function () {
                    leftarrow.addClass(me.toThemeProperty('jqx-icon-arrow-left-selected'));
                });

                this.addHandler(this.pagerleftbutton, 'mouseup', function () {
                    leftarrow.removeClass(me.toThemeProperty('jqx-icon-arrow-left-selected'));
                });

                this.addHandler($(document), 'mouseup.pagerbuttons' + this.element.id, function () {
                    rightarrow.removeClass(me.toThemeProperty('jqx-icon-arrow-right-selected'));
                    leftarrow.removeClass(me.toThemeProperty('jqx-icon-arrow-left-selected'));
                });

                this.addHandler(this.pagerrightbutton, 'click', function () {
                    if (!me.pagerrightbutton.jqxButton('disabled')) {
                        if (!me.rtl) {
                            me.gotonextpage();
                        }
                        else {
                            me.gotoprevpage();
                        }
                    }
                });
                this.addHandler(this.pagerleftbutton, 'click', function () {
                    if (!me.pagerleftbutton.jqxButton('disabled')) {
                        if (!me.rtl) {
                            me.gotoprevpage();
                        }
                        else {
                            me.gotonextpage();
                        }
                    }
                });

                var that = this;
                if (this.pagermode === "simple") {
                    var first = this.pagerfirstbutton;
                    var last = this.pagerlastbutton;

                    this.addHandler(last, 'mouseenter', function () {
                        lastarrow.addClass(that.toThemeProperty('jqx-icon-arrow-last-hover'));
                    });

                    this.addHandler(first, 'mouseenter', function () {
                        firstarrow.addClass(that.toThemeProperty('jqx-icon-arrow-first-hover'));
                    });

                    this.addHandler(last, 'mouseleave', function () {
                        lastarrow.removeClass(that.toThemeProperty('jqx-icon-arrow-last-hover'));
                    });

                    this.addHandler(first, 'mouseleave', function () {
                        firstarrow.removeClass(that.toThemeProperty('jqx-icon-arrow-first-hover'));
                    });

                    this.addHandler(last, 'mousedown', function () {
                        lastarrow.addClass(that.toThemeProperty('jqx-icon-arrow-last-selected'));
                    });

                    this.addHandler(first, 'mousedown', function () {
                        firstarrow.addClass(that.toThemeProperty('jqx-icon-arrow-first-selected'));
                    });

                    this.addHandler(last, 'mouseup', function () {
                        lastarrow.removeClass(that.toThemeProperty('jqx-icon-arrow-last-selected'));
                    });

                    this.addHandler(first, 'mouseup', function () {
                        firstarrow.removeClass(that.toThemeProperty('jqx-icon-arrow-first-selected'));
                    });
                    this.addHandler($(document), 'mouseup.pagerbuttons' + name + this.element.id, function () {
                        rightarrow.removeClass(that.toThemeProperty('jqx-icon-arrow-right-selected'));
                        leftarrow.removeClass(that.toThemeProperty('jqx-icon-arrow-left-selected'));
                        if (lastarrow) {
                            lastarrow.removeClass(that.toThemeProperty('jqx-icon-arrow-last-selected'));
                            firstarrow.removeClass(that.toThemeProperty('jqx-icon-arrow-first-selected'));
                        }
                    });
                    this.addHandler(first, 'click', function () {
                        if (!first.jqxButton('disabled')) {
                            if (!that.rtl) {
                                that.gotopage(0);
                            }
                            else {
                                var totalrecords = that.dataview.totalrecords;
                                var pages = Math.ceil(totalrecords / that.pagesize);
                                that.gotopage(pages - 1);
                            }
                        }
                    });
                    this.addHandler(last, 'click', function () {
                        if (!last.jqxButton('disabled')) {
                            if (!that.rtl) {
                                var totalrecords = that.dataview.totalrecords;
                                var pages = Math.ceil(totalrecords / that.pagesize);
                                that.gotopage(pages - 1);
                            }
                            else {
                                that.gotopage(0);
                            }
                        }
                    });
                }
            }
            else {
                this.pagerdiv.children().remove();
                var element = this.pagerrenderer();
                if (element != null) {
                    this.pagerdiv.append($(element));
                }
                this.pager.append(this.pagerdiv);
            }

            this.vScrollBar.jqxScrollBar({ thumbSize: this.host.height() / 5 });
            this.vScrollBar.jqxScrollBar('refresh');
            this._arrange();
        },

        _updatepagertheme: function () {
            if (this.pagershowrowscombo == null)
                return;

            this.pagershowrowscombo.jqxDropDownList({ theme: this.theme });
            this.pagerrightbutton.jqxButton({ theme: this.theme });
            this.pagerleftbutton.jqxButton({ theme: this.theme });

            this.pagerpageinput.removeClass();

            var input = this.pagergotoinput.find('input');
            input.removeClass();
            input.addClass(this.toThemeProperty('jqx-grid-pager-input'));
            input.addClass(this.toThemeProperty('jqx-rc-all'));
            this.pagerpageinput.addClass(this.toThemeProperty('jqx-input'));
            this.pagerpageinput.addClass(this.toThemeProperty('jqx-widget-content'));

            this.pagerleftbutton.find('.jqx-icon-arrow-left').remove();
            this.pagerrightbutton.find('.jqx-icon-arrow-right').remove();

            var leftarrow = $("<div style='margin-left: 6px; width: 15px; height: 15px;'></div>");
            leftarrow.addClass(this.toThemeProperty('jqx-icon-arrow-left'));
            this.pagerleftbutton.wrapInner(leftarrow);

            var rightarrow = $("<div style='margin-left: 6px; width: 15px; height: 15px;'></div>");
            rightarrow.addClass(this.toThemeProperty('jqx-icon-arrow-right'));
            this.pagerrightbutton.wrapInner(rightarrow);

            if (this.pagermode == "simple") {
                if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                    this.pagerbuttons.css('overflow', 'visible');
                    this.pagerbuttons.css('padding', '3px');
                }

                this.pagerfirstbutton.attr('title', this.gridlocalization.pagerfirstbuttonstring);
                this.pagerlastbutton.attr('title', this.gridlocalization.pagerlastbuttonstring);
                var firstarrow = $("<div style='margin-left: 6px; width: 15px; height: 15px;'></div>");
                firstarrow.addClass(this.toThemeProperty('jqx-icon-arrow-first'));
                this.pagerfirstbutton.wrapInner(firstarrow);

                var lastarrow = $("<div style='margin-left: 6px; width: 15px; height: 15px;'></div>");
                lastarrow.addClass(this.toThemeProperty('jqx-icon-arrow-last'));
                this.pagerlastbutton.wrapInner(lastarrow);
                this.pagerdiv.append(this.pagerfirstbutton);
                this.pagerdiv.append(this.pagerleftbutton);
                this.pagerdiv.append(this.pagerbuttons);
                this.pagerdiv.append(this.pagerrightbutton);
                this.pagerdiv.append(this.pagerlastbutton);
                this.pagerlastbutton.jqxButton({ cursor: 'pointer', disabled: this.disabled, theme: this.theme });
                this.pagerfirstbutton.jqxButton({ cursor: 'pointer', disabled: this.disabled, theme: this.theme });
                this.pagerbuttons.css('float', 'left');
                this.pagerlastbutton.css('float', 'left');
                this.pagerfirstbutton.css('float', 'left');
                this.pagerrightbutton.css('float', 'left');
                this.pagerleftbutton.css('float', 'left');
                this.pagergotoinput.hide();
                this.pagershowrowscombo.hide();
                this.pagergoto.hide();
                this.pagershowrows.hide();
            }
            else {
                this.pagergotoinput.show();
                this.pagershowrowscombo.show();
                this.pagergoto.show();
                this.pagershowrows.show();
            }

            var removeHandlers = function (me, button) {
                me.removeHandler(button, 'mouseenter');
                me.removeHandler(button, 'mouseleave');
                me.removeHandler(button, 'mousedown');
                me.removeHandler(button, 'mouseup');
            }
            removeHandlers(this, this.pagerrightbutton);
            removeHandlers(this, this.pagerleftbutton);
            var me = this.that;
            this.addHandler(this.pagerrightbutton, 'mouseenter', function () {
                rightarrow.addClass(me.toThemeProperty('jqx-icon-arrow-right-hover'));
            });

            this.addHandler(this.pagerleftbutton, 'mouseenter', function () {
                leftarrow.addClass(me.toThemeProperty('jqx-icon-arrow-left-hover'));
            });

            this.addHandler(this.pagerrightbutton, 'mouseleave', function () {
                rightarrow.removeClass(me.toThemeProperty('jqx-icon-arrow-right-hover'));
            });

            this.addHandler(this.pagerleftbutton, 'mouseleave', function () {
                leftarrow.removeClass(me.toThemeProperty('jqx-icon-arrow-left-hover'));
            });

            this.addHandler(this.pagerrightbutton, 'mousedown', function () {
                rightarrow.addClass(me.toThemeProperty('jqx-icon-arrow-right-selected'));
            });

            this.addHandler(this.pagerrightbutton, 'mouseup', function () {
                rightarrow.removeClass(me.toThemeProperty('jqx-icon-arrow-right-selected'));
            });

            this.addHandler(this.pagerleftbutton, 'mousedown', function () {
                leftarrow.addClass(me.toThemeProperty('jqx-icon-arrow-left-selected'));
            });

            this.addHandler(this.pagerleftbutton, 'mouseup', function () {
                leftarrow.removeClass(me.toThemeProperty('jqx-icon-arrow-left-selected'));
            });
        },

        gotopage: function (pagenum) {
            if (pagenum == null || pagenum == undefined)
                pagenum = 0;

            if (pagenum == -1)
                pagenum = 0;

            if (pagenum < 0)
                return;

            var totalrecords = this.dataview.totalrecords;
            if (this.summaryrows) {
                totalrecords += this.summaryrows.length;
            }

            var oldpagenum = this.pagenum;
            this._raiseEvent(25, { oldpagenum: this.dataview.pagenum, pagenum: pagenum, pagesize: this.dataview.pagesize });

            var pages = Math.ceil(totalrecords / this.pagesize);
            if (pagenum >= pages) {
                if (this.dataview.totalrecords == 0) {
                    this.dataview.pagenum = 0;
                    this.updatepagerdetails();
                }
                if (pagenum > 0) {
                    pagenum = pages - 1;
                }
            }

            if (this.dataview.pagenum != pagenum || this._requiresupdate) {
                if (this.pageable) {
                    if (this.source.pager) {
                        this.source.pager(pagenum, this.dataview.pagesize, this.dataview.pagenum);
                    }

                    this.dataview.pagenum = pagenum;

                    if (this.virtualmode) {
                        this.hiddens = new Array();
                        this.expandedgroups = new Array();
                        if (this.rendergridrows) {
                            var startboundindex = pagenum * this.dataview.pagesize;
                            var endboundindex = startboundindex + this.dataview.pagesize;
                            if (startboundindex != null && endboundindex != null) {
                                if (this.pagerrightbutton) {
                                    this.pagerrightbutton.jqxButton({ disabled: true });
                                    this.pagerleftbutton.jqxButton({ disabled: true });
                                    this.pagershowrowscombo.jqxDropDownList({ disabled: true });
                                }
                                this.updatebounddata('pagechanged');
                                this._raiseEvent(9, { pagenum: pagenum, oldpagenum: oldpagenum, pagesize: this.dataview.pagesize });
                                this.updatepagerdetails();
                                if (this.autosavestate) {
                                    if (this.savestate) this.savestate();
                                }
                                return;
                            }
                        }
                    }
                    else this.dataview.updateview();

                    this._loadrows();

                    this._updatepageviews();
                    this.tableheight = null;
                    this._updatecolumnwidths();
                    this._updatecellwidths();
                    this._renderrows(this.virtualsizeinfo);
                    this.updatepagerdetails();
                    if (this.autoheight || this.autorowheight) {
                        var newheight = this.host.height() - this._gettableheight();
                        height = newheight + this._pageviews[0].height;
                        if (height != this.host.height()) {
                            this._arrange();
                            this._updatepageviews();
                            if (this.autorowheight) {
                                this._renderrows(this.virtualsizeinfo);
                            }
                        }
                    }

                    if (this.editcell != null && this.endcelledit) {
                        this.endcelledit(this.editcell.row, this.editcell.column, true, false);
                    }

                    this._raiseEvent(9, { pagenum: pagenum, oldpagenum: oldpagenum, pagesize: this.dataview.pagesize });
                    if (this.autosavestate) {
                        if (this.savestate) this.savestate();
                    }
                }
            }
        },

        // goes to a previous page.
        gotoprevpage: function () {
            if (this.dataview.pagenum > 0) {
                this.gotopage(this.dataview.pagenum - 1);
            }
            else {
                if (this.pagermode != "simple") {
                    var totalrecords = this.dataview.totalrecords;
                    if (this.summaryrows) {
                        totalrecords += this.summaryrows.length;
                    }
                    var pages = Math.ceil(totalrecords / this.pagesize);
                    this.gotopage(pages - 1);
                }
            }
        },

        // goes to a next page.
        gotonextpage: function () {
            var totalrecords = this.dataview.totalrecords;
            if (this.summaryrows) {
                totalrecords += this.summaryrows.length;
            }
            var pages = Math.ceil(totalrecords / this.pagesize);
            if (this.dataview.pagenum < pages - 1) {
                this.gotopage(this.dataview.pagenum + 1);
            }
            else {
                if (this.pagermode != "simple") {
                    this.gotopage(0);
                }
            }
        },

        // updates a pager details.
        updatepagerdetails: function () {
            if (this.pagerdetails != null && this.pagerdetails.length > 0) {
                var currentrecord = this.dataview.pagenum * this.pagesize;
                var lastrecord = (this.dataview.pagenum + 1) * this.pagesize;
                if (lastrecord >= this.dataview.totalrecords) {
                    lastrecord = this.dataview.totalrecords;
                }
                var totalrecords = this.dataview.totalrecords;
                if (this.summaryrows) {
                    totalrecords += this.summaryrows.length;
                    if ((this.dataview.pagenum + 1) * this.pagesize > this.dataview.totalrecords)
                    { lastrecord = totalrecords; }
                }

                currentrecord++;
                var pagescount = Math.ceil(totalrecords / this.dataview.pagesize);
                if (pagescount >= 1) pagescount--;
                pagescount++;

                if (this.pagermode !== 'simple') {
                    var input = this.pagergotoinput.find('input');
                    input.val(this.dataview.pagenum + 1);
                }
                else {
                    var anchors = "";
                    var buttonsCount = this.pagerbuttonscount;
                    if (buttonsCount == 0 || !buttonsCount) {
                        buttonsCount = 5;
                    }

                    var i = 0;
                    if (this.rtl) {
                        i = buttonsCount - 1;
                    }
                    while ((this.rtl && i >= 0) || (!this.rtl && i < buttonsCount)) {
                        var page = 1 + i;

                        var division = this.dataview.pagenum / buttonsCount;
                        var step = Math.floor(division);
                        page += step * buttonsCount;
                        var className = this.toTP('jqx-grid-pager-number');
                        className += " " + this.toTP('jqx-rc-all');
                        if (page > pagescount)
                            break;

                        if (!this.rtl) {
                            if (i == 0 && page > buttonsCount) {
                                anchors += "<a class='" + className + "' tabindex=-1 href='javascript:;' data-page='" + (-1 + page) + "'>" + "..." + "</a>";
                            }
                        }

                        if (this.dataview.pagenum === page - 1) {
                            className += " " + this.toTP('jqx-fill-state-pressed');
                        }

                        if (!this.rtl) {
                            anchors += "<a class='" + className + "' tabindex=-1 href='javascript:;' data-page='" + page + "'>" + page + "</a>";

                            if (i === buttonsCount - 1) {
                                var className = this.toTP('jqx-grid-pager-number');
                                if (pagescount >= 1 + page) {
                                    anchors += "<a class='" + className + "' tabindex=-1 href='javascript:;' data-page='" + (1 + page) + "'>" + "..." + "</a>";
                                }
                            }
                        }
                        else {
                            if (i === buttonsCount - 1) {
                                var className = this.toTP('jqx-grid-pager-number');
                                if (pagescount >= 1 + page) {
                                    anchors += "<a class='" + className + "' tabindex=-1 href='javascript:;' data-page='" + (1 + page) + "'>" + "..." + "</a>";
                                }
                            }
                            if (this.dataview.pagenum === page - 1) {
                                className += " " + this.toTP('jqx-fill-state-pressed');
                            }
                            anchors += "<a class='" + className + "' tabindex=-1 href='javascript:;' data-page='" + page + "'>" + page + "</a>";
                        }

                        if (this.rtl) {
                            var className = this.toTP('jqx-grid-pager-number');
                            if (i == 0 && page > buttonsCount) {
                                anchors += "<a class='" + className + "' tabindex=-1 href='javascript:;' data-page='" + (-1 + page) + "'>" + "..." + "</a>";
                            }
                        }

                        if (!this.rtl) {
                            i++;
                        }
                        else {
                            i--;
                        }
                    }
                    var numbers = this["pagerbuttons"].find('a');
                    this.removeHandler(numbers, 'click');
                    this.removeHandler(numbers, 'mouseenter');
                    this.removeHandler(numbers, 'mouseleave');

                    this["pagerbuttons"][0].innerHTML = anchors;
                    var that = this;
                    var initAnchors = function () {
                        that.addHandler(numbers, 'click', function (event) {
                            var page = $(event.target).attr("data-page");
                            that.gotopage(parseInt(page) - 1);
                            return false;
                        });
                        that.addHandler(numbers, 'mouseenter', function (event) {
                            $(event.target).addClass(that.toTP("jqx-fill-state-hover"));
                        });
                        that.addHandler(numbers, 'mouseleave', function (event) {
                            $(event.target).removeClass(that.toTP("jqx-fill-state-hover"));
                        });
                    }

                    var numbers = this["pagerbuttons"].find('a');
                    initAnchors(numbers);
                }
              
                this.pagergotoinput.attr('title', '1 - ' + pagescount);
                if (lastrecord == 0 && lastrecord < currentrecord) {
                    currentrecord = 0;
                }

                if (!this.rtl) {
                    this.pagerdetails[0].innerHTML = currentrecord + '-' + lastrecord + this.gridlocalization.pagerrangestring + totalrecords;
                }
                else {
                    this.pagerdetails[0].innerHTML = totalrecords + this.gridlocalization.pagerrangestring + lastrecord + '-' + currentrecord;
                }

                if (currentrecord > lastrecord) {
                    this.gotoprevpage();
                }
            }
        },

        _updatepagedview: function (totalrows, virtualheight, currentheight) {
            var self = this.that;
            if (this.dataview.rows.length != this.dataview.pagesize) {
                this.dataview.updateview();
            }

            var rowslength = this.dataview.rows.length;
            for (var i = 0; i < rowslength; i++) {
                var index = this.dataview.rows[i].visibleindex;
                var rowinfo = { index: index, height: this.heights[index], hidden: this.hiddens[index], details: this.details[index] }
                if (this.heights[index] == undefined) {
                    this.heights[index] = this.rowsheight;
                    rowinfo.height = this.rowsheight;
                }
                if (this.hiddens[index] == undefined) {
                    this.hiddens[index] = false;
                    rowinfo.hidden = false;
                }
                if (this.details[index] == undefined) {
                    this.details[index] = null;
                }
                if (rowinfo.height != self.rowsheight) {
                    virtualheight -= self.rowsheight;
                    virtualheight += rowinfo.height;
                }

                if (rowinfo.hidden) {
                    virtualheight -= rowinfo.height;
                }
                else {
                    currentheight += rowinfo.height;
                    var detailsheight = 0;
                    if (this.rowdetails) {
                        if (rowinfo.details && rowinfo.details.rowdetails && !rowinfo.details.rowdetailshidden) {
                            detailsheight = rowinfo.details.rowdetailsheight;
                            currentheight += detailsheight;
                            virtualheight += detailsheight;
                        }
                    }
                }
            }
            this._pageviews[0] = { top: 0, height: currentheight };
            return virtualheight;
        }
    });
})(jQuery);(function ($) {

    $.extend($.jqx._jqxGrid.prototype, {
        _handledblclick: function (event, self) {
            if (event.target == null) {
                return;
            }

            if (self.disabled) {
                return;
            }

            if ($(event.target).ischildof(this.columnsheader)) {
                return;
            }

            var rightclick;
            if (event.which) rightclick = (event.which == 3);
            else if (event.button) rightclick = (event.button == 2);

            if (rightclick) {
                return;
            }

            var middleclick;
            if (event.which) middleclick = (event.which == 2);
            else if (event.button) middleclick = (event.button == 1);

            if (middleclick) {
                return;
            }

            var columnheaderheight = this.showheader ? this.columnsheader.height() + 2 : 0;
            var groupsheaderheight = this._groupsheader() ? this.groupsheader.height() : 0;
            var toolbarheight = this.showtoolbar ? this.toolbarheight : 0;
            groupsheaderheight += toolbarheight;

            var hostoffset = this.host.offset();
            var x = event.pageX - hostoffset.left;
            var y = event.pageY - columnheaderheight - hostoffset.top - groupsheaderheight;
            var rowinfo = this._hittestrow(x, y);
            var row = rowinfo.row;
            var index = rowinfo.index;
            var targetclassname = event.target.className;
            var tablerow = this.table[0].rows[index];
            if (tablerow == null)
                return;

            self.mousecaptured = true;
            self.mousecaptureposition = { left: event.pageX, top: event.pageY - groupsheaderheight };

            var hScrollInstance = this.hScrollInstance;
            var horizontalscrollvalue = hScrollInstance.value;
            var cellindex = 0;
            var groupslength = this.groupable ? this.groups.length : 0;

            for (var i = 0; i < tablerow.cells.length; i++) {
                var columnleft = parseInt($(this.columnsrow[0].cells[i]).css('left'));
                var left = columnleft - horizontalscrollvalue;
                if (self.columns.records[i].pinned) {
                    left = columnleft;
                }

                var column = this._getcolumnat(i);
                if (column != null && column.hidden) {
                    continue;
                }

                var right = left + $(this.columnsrow[0].cells[i]).width();
                if (right >= x && x >= left) {
                    cellindex = i;
                    break;
                }
            }

            if (row != null) {
                var column = this._getcolumnat(cellindex);
                if (!(targetclassname.indexOf('jqx-grid-group-expand') != -1 || targetclassname.indexOf('jqx-grid-group-collapse') != -1)) {
                    if (row.boundindex != -1) {
                        self.begincelledit(self.getboundindex(row), column.datafield, column.defaulteditorvalue);
                    }
                }
            }
        },

        _getpreveditablecolumn: function (index) {
            var self = this;
            while (index > 0) {
                index--;
                var column = self.getcolumnat(index);
                if (!column)
                    return null;

                if (!column.editable)
                    continue;

                if (!column.hidden)
                    return column;
            }
            return null;
        },

        _getnexteditablecolumn: function (index) {
            var self = this;
            while (index < this.columns.records.length) {
                index++;
                var column = self.getcolumnat(index);

                if (!column)
                    return null;

                if (!column.editable)
                    continue;

                if (!column.hidden)
                    return column;
            }
            return null;
        },

        _handleeditkeydown: function (event, self) {
            if (self.handlekeyboardnavigation) {
                var handled = self.handlekeyboardnavigation(event);
                if (handled == true) {
                    return true;
                }
            }

            var key = event.charCode ? event.charCode : event.keyCode ? event.keyCode : 0;

            if (self.showfilterrow && self.filterable) {
                if (this.filterrow) {
                    if ($(event.target).ischildof(this.filterrow))
                        return true;
                }
            }

            if (self.pageable) {
                if ($(event.target).ischildof(this.pager)) {
                    return true;
                }
            }

            if (this.showtoolbar) {
                if ($(event.target).ischildof(this.toolbar)) {
                    return true;
                }
            }
            if (this.showstatusbar) {
                if ($(event.target).ischildof(this.statusbar)) {
                    return true;
                }
            }

            if (this.rowdetails) {
                if ($(event.target).ischildof(this.content.find("[role='rowgroup']"))) {
                    return true;
                }
            }

            if (this.editcell) {
                if (this.editmode === "selectedrow") {
                    if (key === 13) {
                        this.endrowedit(this.editcell.row, false);
                    }
                    else if (key === 27) {
                        this.endrowedit(this.editcell.row, true);
                    }
                    if (key === 9) {
                        return false;
                    }

                    return true;
                }

                if (this.editcell.columntype == null || this.editcell.columntype == 'textbox' || this.editcell.columntype == 'numberinput' || this.editcell.columntype == 'combobox' || this.editcell.columntype == 'datetimeinput') {
                    if (key >= 33 && key <= 40 && self.selectionmode == 'multiplecellsadvanced') {
                        var editor = this.editcell.columntype == 'textbox' || this.editcell.columntype == null ? this.editcell.editor : this.editcell.editor.find('input');
                        var selection = self._selection(editor);
                        var strlength = editor.val().length;
                        if (selection.length > 0 && this.editcell.columntype != 'datetimeinput') {
                            self._cancelkeydown = true;
                        }

                        if (selection.start > 0 && key == 37) {
                            self._cancelkeydown = true;
                        }
                        if (selection.start < strlength && key == 39 && this.editcell.columntype != 'datetimeinput') {
                            self._cancelkeydown = true;
                        }
                        if (this.editcell.columntype == 'datetimeinput' && key == 39) {
                            if (selection.start + selection.length < strlength) {
                                self._cancelkeydown = true;
                            }
                        }
                    }
                }
                else if (this.editcell.columntype == 'dropdownlist') {
                    if (key == 37 || key == 39 && self.selectionmode == 'multiplecellsadvanced') {
                        self._cancelkeydown = false;
                    }
                }
                else if (this.selectionmode == 'multiplecellsadvanced' && this.editcell.columntype != 'textbox' && this.editcell.columntype != 'numberinput') {
                    self._cancelkeydown = true;
                }

                if (key == 32) {
                    if (self.editcell.columntype == 'checkbox') {
                        var column = self.getcolumn(self.editcell.datafield);
                        if (column.editable) {
                            var checked = !self.getcellvalue(self.editcell.row, self.editcell.column);
                            if (column.cellbeginedit) {
                                var beginEdit = column.cellbeginedit(self.editcell.row, column.datafield, column.columntype, !checked);
                                if (beginEdit == false) {
                                    return false;
                                }
                            }
                            self.setcellvalue(self.editcell.row, self.editcell.column, checked, true);
                            self._raiseEvent(18, { rowindex: self.editcell.row, datafield: self.editcell.column, oldvalue: !checked, value: checked, columntype: 'checkbox' });
                            return false;
                        }
                    }
                }
                if (key == 9) {
                    var rowindex = this.editcell.row;
                    var datafield = this.editcell.column;
                    var initialdatafield = datafield;
                    var columnindex = self._getcolumnindex(datafield);
                    var canedit = false;
                    var visibleindex = self.getrowvisibleindex(rowindex);
                    this.editchar = "";
     
                    if (this.editcell.validated != false) {
                        if (event.shiftKey) {
                            var column = self._getpreveditablecolumn(columnindex);
                            if (column) {
                                datafield = column.datafield;
                                canedit = true;
                                if (self.selectionmode.indexOf('cell') != -1) {
                                    self.selectprevcell(rowindex, initialdatafield);
                                    setTimeout(function () {
                                        self.ensurecellvisible(visibleindex, datafield);
                                    }, 10);
                                }
                            }
                        }
                        else {
                            var column = self._getnexteditablecolumn(columnindex);
                            if (column) {
                                datafield = column.datafield;
                                canedit = true;
                                if (self.selectionmode.indexOf('cell') != -1) {
                                    self.selectnextcell(rowindex, initialdatafield);
                                    self._oldselectedcell = self.selectedcell;
                                    setTimeout(function () {
                                        self.ensurecellvisible(visibleindex, datafield);
                                    }, 10);
                                }
                            }
                        }

                        if (canedit) {
                            self.begincelledit(rowindex, datafield);
                            if (this.editcell != null && this.editcell.columntype == 'checkbox') {
                                this._renderrows(this.virtualsizeinfo);
                            }
                        }
                        else {
                            if (this.editcell != null) {
                                self.endcelledit(rowindex, datafield, false);
                                this._renderrows(this.virtualsizeinfo);
                            }
                            return true;
                        }
                    }
                    return false;
                }
                else if (key == 13) {
                    var oldselectedcell = this.selectedcell;
                    if (oldselectedcell) {
                        var oldvisibleindex = this.getrowvisibleindex(oldselectedcell.rowindex);
                    }
                    this.endcelledit(this.editcell.row, this.editcell.column, false, true);
                    if (this.selectionmode == 'multiplecellsadvanced') {
                        var cell = self.getselectedcell();
                        if (cell != null) {
                            if (self.selectcell) {
                                if (this.editcell == null) {
                                    if (cell.rowindex + 1 < this.dataview.totalrecords) {
                                        if (this.sortcolumn != cell.datafield) {
                                            var visibleindex = this.getrowvisibleindex(cell.rowindex);
                                            var visiblerow = this.dataview.loadedrecords[visibleindex + 1];
                                            if (visiblerow) {
                                                if (!this.pageable || (this.pageable && visibleindex + 1 < (this.dataview.pagenum + 1 ) * this.pagesize)) {
                                                    this.clearselection(false);
                                                    this.selectcell(this.getboundindex(visiblerow), cell.datafield);
                                                    var cell = this.getselectedcell();
                                                    this.ensurecellvisible(visiblerow.visibleindex, cell.datafield);
                                                }
                                            }
                                        }
                                        else {
                                            if (oldselectedcell != null) {
                                                var oldvisiblerow = this.dataview.loadedrecords[oldvisibleindex + 1];
                                                if (oldvisiblerow) {
                                                    if (!this.pageable || (this.pageable && oldvisibleindex + 1 < this.pagesize)) {
                                                        this.clearselection(false);
                                                        this.selectcell(this.getboundindex(oldvisiblerow), cell.datafield);
                                                    }
                                                    else if (this.pageable && oldvisibleindex + 1 >= this.pagesize) {
                                                        this.clearselection(false);
                                                        var oldvisiblerow = this.dataview.loadedrecords[oldvisibleindex];
                                                        this.selectcell(this.getboundindex(oldvisiblerow), cell.datafield);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    return false;
                }
                else if (key == 27) {
                    this.endcelledit(this.editcell.row, this.editcell.column, true, true);
                    return false;
                }
            }
            else {
                var startedit = false;
                if (key == 113) {
                    startedit = true;
                }
                if (!event.ctrlKey && !event.altKey) {
                    if (key >= 48 && key <= 57) {
                        this.editchar = String.fromCharCode(key);
                        startedit = true;
                    }
                    if (key >= 65 && key <= 90) {
                        this.editchar = String.fromCharCode(key);
                        var shifton = false;
                        if (event.shiftKey) {
                            shifton = event.shiftKey;
                        } else if (event.modifiers) {
                            shifton = !!(event.modifiers & 4);
                        }
                        if (!shifton) {
                            this.editchar = this.editchar.toLowerCase();
                        }
                        startedit = true;
                    }
                    else if (key >= 96 && key <= 105) {
                        this.editchar = key - 96;
                        this.editchar = this.editchar.toString();
                        startedit = true;
                    }
                    var gridscount = $('.jqx-grid').length;
                    startedit = startedit && (gridscount == 1 || (gridscount > 1 && self.focused));
                    var editID = $.data(document.body, 'jqxgrid.edit');
                    if (editID !== undefined && editID !== "") {
                        if (key === 13 || startedit) {
                            if (editID != self.element.id) {
                                return true;
                            }
                        }
                    }
                }

                if (key == 13 || startedit) {
                    if (self.getselectedrowindex) {
                        var rowindex = self.getselectedrowindex();

                        switch (self.selectionmode) {
                            case 'singlerow':
                            case 'multiplerows':
                            case 'multiplerowsextended':
                                {
                                    if (rowindex >= 0) {
                                        var datafield = "";
                                        for (var m = 0; m < self.columns.records.length; m++) {
                                            var column = self.getcolumnat(m);
                                            if (column.editable) {
                                                datafield = column.datafield;
                                                break;
                                            }
                                        }

                                        self.begincelledit(rowindex, datafield);
                                    }
                                    break;
                                }
                            case 'singlecell':
                            case 'multiplecells':
                            case 'multiplecellsextended':
                                var cell = self.getselectedcell();
                                if (cell != null) {
                                    var column = self._getcolumnbydatafield(cell.datafield);
                                    if (column.columntype != 'checkbox') {
                                        self.begincelledit(cell.rowindex, cell.datafield);
                                    }
                                }
                                break;
                            case "multiplecellsadvanced":
                                var cell = self.getselectedcell();
                                if (cell != null) {
                                    if (key == 13) {
                                        if (self.selectcell) {
                                            if (cell.rowindex + 1 < self.dataview.totalrecords) {
                                                var visibleindex = this.getrowvisibleindex(cell.rowindex);
                                                var visiblerow = this.dataview.loadedrecords[visibleindex + 1];
                                                if (visiblerow) {
                                                    this.clearselection(false);
                                                    this.selectcell(this.getboundindex(visiblerow), cell.datafield);
                                                    var cell = this.getselectedcell();
                                                    this.ensurecellvisible(visiblerow.visibleindex, cell.datafield);
                                                }
                                            }
                                        }
                                    }
                                    else {
                                        if (self.editmode !== "selectedrow") {
                                            self.begincelledit(cell.rowindex, cell.datafield);
                                        }
                                    }
                                }

                                break;
                        }
                        return false;
                    }
                }
                if (key == 46) {
                    var cells = self.getselectedcells();
                    if (self.selectionmode.indexOf('cell') == -1) {
                        if (self._getcellsforcopypaste) {
                            cells = self._getcellsforcopypaste();
                        }
                    }
                    if (cells != null && cells.length > 0) {
                        for (var cellIndex = 0; cellIndex < cells.length; cellIndex++) {
                            var cell = cells[cellIndex];
                            if (!cell.datafield) continue;
                            var column = self.getcolumn(cell.datafield);
                            var cellValue = self.getcellvalue(cell.rowindex, cell.datafield);
                            if (cellValue !== "" && column.editable && self.enablekeyboarddelete) {
                                var newvalue = null;
                                if (column.columntype == "checkbox") {
                                    if (!column.threestatecheckbox) {
                                        newvalue = false;
                                    }
                                }
                                if (column.cellbeginedit) {
                                    var beginEdit = column.cellbeginedit(cell.rowindex, column.datafield, column.columntype, newvalue);
                                    if (beginEdit == false) {
                                        return false;
                                    }
                                }
                                self._raiseEvent(17, { rowindex: cell.rowindex, datafield: cell.datafield, value: cellValue });
                                if (cellIndex == cells.length - 1) {
                                    self.setcellvalue(cell.rowindex, cell.datafield, newvalue, true);
                                    if (column.displayfield != column.datafield) {
                                        self.setcellvalue(cell.rowindex, column.displayfield, newvalue, true);
                                    }
                                }
                                else {
                                    self.setcellvalue(cell.rowindex, cell.datafield, newvalue, false);
                                    if (column.displayfield != column.datafield) {
                                        self.setcellvalue(cell.rowindex, column.displayfield, newvalue, true);
                                    }
                                }
                                if (column.cellendedit) {
                                    var cellendeditresult = column.cellendedit(cell.rowindex, column.datafield, column.columntype, newvalue);
                                }
                                self._raiseEvent(18, { rowindex: cell.rowindex, datafield: cell.datafield, oldvalue: cellValue, value: newvalue });
                            }
                        }
                        this.dataview.updateview();
                        this._renderrows(this.virtualsizeinfo);
                        return false;
                    }
                }
                if (key == 32) {
                    var cell = self.getselectedcell();
                    if (cell != null) {
                        var column = self.getcolumn(cell.datafield);
                        if (column.columntype == 'checkbox' && column.editable) {
                            var checked = !self.getcellvalue(cell.rowindex, cell.datafield);
                            if (column.cellbeginedit) {
                                var beginEdit = column.cellbeginedit(cell.rowindex, column.datafield, column.columntype, !checked);
                                if (beginEdit == false) {
                                    return false;
                                }
                            }

                            self._raiseEvent(17, { rowindex: cell.rowindex, datafield: cell.datafield, value: !checked, columntype: 'checkbox' });
                            self.setcellvalue(cell.rowindex, cell.datafield, checked, true);
                            self._raiseEvent(18, { rowindex: cell.rowindex, datafield: cell.datafield, oldvalue: !checked, value: checked, columntype: 'checkbox' });
                            return false;
                        }
                    }
                }
            }

            return true;
        },

        // begins cell editing.
        begincelledit: function (row, datafield, defaultvalue, ensurevisible, render) {
            var column = this.getcolumn(datafield);
            this._cellscache = new Array();

            if (datafield == null)
                return;

            if (column.columntype == "number" || column.columntype == "button") {
                return;
            }

            if (this.groupable) {
                if (this.groups.indexOf(datafield) >= 0) {
                    return;
                }
                if (this.groups.indexOf(column.displayfield) >= 0) {
                    return;
                }
            }

            if (this.editrow != undefined) return;

            if (this.editcell) {
                if (this.editcell.row == row && this.editcell.column == datafield) {
                    return true;
                }
                if (this.editmode === "selectedrow") {
                    if (this.editcell.row == row) {
                        return;
                    }
                }

                var validated = this.endcelledit(this.editcell.row, this.editcell.column, false, true, false);
                if (false == validated)
                    return;
            }

            var isembeddededitor = column.columntype == 'checkbox' || column.columntype == 'button';
            this.host.removeClass('jqx-disableselect');
            this.content.removeClass('jqx-disableselect');

            if (column.editable) {
                if (column.cellbeginedit) {
                    var cell = this.getcell(row, datafield);
                    var beginEdit = column.cellbeginedit(row, datafield, column.columntype, cell != null ? cell.value : null);
                    if (beginEdit == false)
                        return;
                }

                var visiblerowindex = this.getrowvisibleindex(row);
                this.editcell = this.getcell(row, datafield);
                if (this.editcell) {
                    this.editcell.visiblerowindex = visiblerowindex;
                    if (!this.editcell.editing) {
                        if (!isembeddededitor) {
                            this.editcell.editing = true;
                        }
                        this.editcell.columntype = column.columntype;
                        this.editcell.defaultvalue = defaultvalue;
                        if (column.defaultvalue != undefined) {
                            this.editcell.defaultvalue = column.defaultvalue;
                        }
                        this.editcell.init = true;
                        // raise begin cell edit event.
                        if (column.columntype != "checkbox") {
                            this._raiseEvent(17, { rowindex: row, datafield: column.datafield, value: this.editcell.value, columntype: column.columntype });
                        }
                        $.data(document.body, 'jqxgrid.edit', this.element.id);

                        if (!isembeddededitor) {
                            var visibleindex = this.getrowvisibleindex(row);
                            if (ensurevisible !== false) {
                                this.ensurecellvisible(visibleindex, column.datafield);
                            }
                            if (render !== false) {
                                this._renderrows(this.virtualsizeinfo);
                            }
                        }
                        if (this.editcell) {
                            this.editcell.init = false;
                            return true;
                        }
                    }
                }
            }
            else {
                if (!this.editcell) {
                    return;
                }
                this.editcell.editor = null;
                this.editcell.editing = false;
                if (render !== false) {
                    this._renderrows(this.virtualsizeinfo);
                }
                this.editcell = null;
            }
        },

        getScrollTop: function () {
            if (this._py) {
                return pageYOffset;
            }

            this._py = typeof pageYOffset != 'undefined';
            if (this._py) {
                //most browsers
                return pageYOffset;
            }
            else{
                    var B= document.body; //IE 'quirks'
                var D= document.documentElement; //IE with doctype
                D= (D.clientHeight)? D: B;
                return D.scrollTop;
            }
        },

        getScrollLeft: function () {
            if (typeof pageXOffset != 'undefined') {
                //most browsers
                return pageXOffset;
            }
            else {
                var B = document.body; //IE 'quirks'
                var D = document.documentElement; //IE with doctype
                D = (D.clientHeight) ? D : B;
                return D.scrollLeft;
            }
        },

        endcelledit: function (row, datafield, cancelchanges, refresh, focus) {
            if (row == undefined || datafield == undefined) {
                if (this.editcell) {
                    row = this.editcell.row;
                    datafield = this.editcell.column;
                }
                if (cancelchanges == undefined) {
                    cancelchanges = true;
                }
            }

            if (!this.editcell) {
                return;
            }

            var column = this.getcolumn(datafield);
            var me = this;

            if (me.editmode === "selectedrow") {
                this.endrowedit(row, cancelchanges);
                return;
            }

            var setfocus = function () {
                if (focus != false) {
                    if (me.isTouchDevice()) {
                        return;
                    }

                    if (!me.isNestedGrid) {
                        var topPos = me.getScrollTop();
                        var leftPos = me.getScrollLeft();

                        try
                        {
                            me.element.focus();
                            me.content.focus();
                            if (topPos != me.getScrollTop()) {
                                window.scrollTo(leftPos, topPos);
                            }

                            setTimeout(function () {
                                me.element.focus();
                                me.content.focus();
                                if (topPos != me.getScrollTop()) {
                                    window.scrollTo(leftPos, topPos);
                                }
                            }, 10);
                        }
                        catch (error) {
                        }
                    }
                }
            }

            if (column.columntype == 'checkbox' || column.columntype == 'button') {
                if (this.editcell) {
                    this.editcell.editor = null;
                    this.editcell.editing = false;
                    this.editcell = null;
                }
                return true;
            }

            var editorvalue = this._geteditorvalue(column);

            var cancelchangesfunc = function (me) {
                me._hidecelleditor();
                if (column.cellendedit) {
                    column.cellendedit(row, datafield, column.columntype, me.editcell.value, editorvalue);           
                }
                me.editchar = null;
                if (column.displayfield != column.datafield) {
                    var label = me.getcellvalue(me.editcell.row, column.displayfield);
                    var value = me.editcell.value;
                    oldvalue = { value: value, label: label };
                }
                else oldvalue = me.editcell.value;

                me._raiseEvent(18, { rowindex: row, datafield: datafield, displayfield: column.displayfield, oldvalue: editorvalue, value: editorvalue, columntype: column.columntype });

                me.editcell.editor = null;
                me.editcell.editing = false;
                me.editcell = null;
                if (refresh || refresh == undefined) {
                    me._renderrows(me.virtualsizeinfo);
                }
                setfocus();
                if (!me.enablebrowserselection) {
                    me.host.addClass('jqx-disableselect');
                    me.content.addClass('jqx-disableselect');
                }
            }

            if (cancelchanges) {
                cancelchangesfunc(this);
                return false;
            }

            if (this.validationpopup) {
                this.validationpopup.hide();
                this.validationpopuparrow.hide();
            }

            if (column.cellvaluechanging) {
                var newcellvalue = column.cellvaluechanging(row, datafield, column.columntype, this.editcell.value, editorvalue);
                if (newcellvalue != undefined) {
                    editorvalue = newcellvalue;
                }
            }

            if (column.validation) {
                var cell = this.getcell(row, datafield);
                try {
                    var validationobj = column.validation(cell, editorvalue);
                    var validationmessage = this.gridlocalization.validationstring;
                    if (validationobj.message != undefined) {
                        validationmessage = validationobj.message;
                    }
                    var result = typeof validationobj == "boolean" ? validationobj : validationobj.result;

                    if (!result) {
                        if (validationobj.showmessage == undefined || validationobj.showmessage == true) {
                            this._showvalidationpopup(row, datafield, validationmessage);
                        }
                        this.editcell.validated = false;
                        return false;
                    }
                }
                catch (error) {
                    this._showvalidationpopup(row, datafield, this.gridlocalization.validationstring);
                    this.editcell.validated = false;
                    return false;
                }
            }

            if (column.displayfield != column.datafield) {
                var label = this.getcellvalue(this.editcell.row, column.displayfield);
                var value = this.editcell.value;
                oldvalue = { value: value, label: label };
            }
            else oldvalue = this.editcell.value;

            if (column.cellendedit) {
                var cellendeditresult = column.cellendedit(row, datafield, column.columntype, this.editcell.value, editorvalue);
                if (cellendeditresult == false) {
                    this._raiseEvent(18, { rowindex: row, datafield: datafield, displayfield: column.displayfield, oldvalue: oldvalue, value: oldvalue, columntype: column.columntype });
                    cancelchangesfunc(this);
                    return false;
                }
            }

            this._raiseEvent(18, { rowindex: row, datafield: datafield, displayfield: column.displayfield, oldvalue: oldvalue, value: editorvalue, columntype: column.columntype });

            this._hidecelleditor(false);
            if (this.editcell != undefined) {
                this.editcell.editor = null;
                this.editcell.editing = false;
            }
            this.editcell = null;
            this.editchar = null;
            this.setcellvalue(row, datafield, editorvalue, refresh);
            if (!this.enablebrowserselection) {
                this.host.addClass('jqx-disableselect');
                this.content.addClass('jqx-disableselect');
            }
            setfocus();
            $.data(document.body, 'jqxgrid.edit', "");

            // raise end cell edit event.
            return true;
        },

        beginrowedit: function (row) {
            var me = this;
            var lastIndex = -1;
            me._oldselectedrow = row;
            this._cellscache = new Array();
            $.each(this.columns.records, function (index, value) {
                if (me.editable && this.editable) {
                    var cell = me.getcell(row, this.datafield);
                    me.begincelledit(row, this.datafield, null, false, false);
                }
            });
            if (me.editcell) {
                me.editcell.init = true;
            }
            this._renderrows(this.virtualsizeinfo);
        },

        endrowedit: function (row, cancelchanges) {
            var me = this;
            if (!this.editcell) {
                return false;
            }

            if (this.editcell.editor == undefined) {
                return false;
            }

            var setfocus = function () {
                if (focus != false) {
                    if (me.isTouchDevice()) {
                        return;
                    }

                    if (!me.isNestedGrid) {
                        var topPos = me.getScrollTop();
                        var leftPos = me.getScrollLeft();

                        try {
                            me.element.focus();
                            me.content.focus();
                            if (topPos != me.getScrollTop()) {
                                window.scrollTo(leftPos, topPos);
                            }

                            setTimeout(function () {
                                me.element.focus();
                                me.content.focus();
                                if (topPos != me.getScrollTop()) {
                                    window.scrollTo(leftPos, topPos);
                                }
                            }, 10);
                        }
                        catch (error) {
                        }
                    }
                }
            }

            var hasInvalidColumns = false;
            var values = {};
            if (this.validationpopup) {
                this.validationpopup.hide();
                this.validationpopuparrow.hide();
            }

            for (var i = 0; i < this.columns.records.length; i++) {
                var column = this.columns.records[i];
                if (!column.editable) {
                    continue;
                }

                if (column.columntype == "checkbox") {
                    continue;
                }
                var editorvalue = this._geteditorvalue(column);

                var cancelchangesfunc = function (me) {
                    me._hidecelleditor();
                    var oldval = me.getcellvalue(me.editcell.row, column.displayfield);
                    if (column.cellendedit) {
                        column.cellendedit(row, datafield, column.columntype, oldval, editorvalue);
                    }
                    me.editchar = null;
                    if (column.displayfield != column.datafield) {
                        var label = me.getcellvalue(me.editcell.row, column.displayfield);
                        var value = oldval;
                        oldvalue = { value: value, label: label };
                    }
                    else oldvalue = oldval;

                    me._raiseEvent(18, { rowindex: row, datafield: datafield, displayfield: column.displayfield, oldvalue: oldval, value: oldval, columntype: column.columntype });

                    me.editcell.editing = false;
                }

                if (cancelchanges) {
                    cancelchangesfunc(this);
                    continue;
                }

                if (column.cellvaluechanging) {
                    var oldvalue = this.getcellvalue(this.editcell.row, column.displayfield);
                    var newcellvalue = column.cellvaluechanging(row, datafield, column.columntype, oldvalue, editorvalue);
                    if (newcellvalue != undefined) {
                        editorvalue = newcellvalue;
                    }
                }

                var datafield = column.datafield;
                if (column.validation) {
                    var cell = this.getcell(row, column.datafield);
                    try {
                        var validationobj = column.validation(cell, editorvalue);
                        var validationmessage = this.gridlocalization.validationstring;
                        if (validationobj.message != undefined) {
                            validationmessage = validationobj.message;
                        }
                        var result = typeof validationobj == "boolean" ? validationobj : validationobj.result;

                        if (!result) {
                            if (validationobj.showmessage == undefined || validationobj.showmessage == true) {
                                this._showvalidationpopup(row, datafield, validationmessage);
                            }
                            hasInvalidColumns = true;
                            this.editcell[column.datafield].validated = false;
                            continue;
                        }
                    }
                    catch (error) {
                        this._showvalidationpopup(row, datafield, this.gridlocalization.validationstring);
                        this.editcell[column.datafield].validated = false;
                        hasInvalidColumns = true;
                        continue;
                    }
                }

                if (column.displayfield != column.datafield) {
                    var label = this.getcellvalue(this.editcell.row, column.displayfield);
                    var value = this.editcell.value;
                    oldvalue = { value: value, label: label };
                }
                else oldvalue = this.getcellvalue(this.editcell.row, column.displayfield);
                values[column.datafield] = { newvalue: editorvalue, oldvalue: oldvalue };
               // raise end cell edit event.
            }

            var rowvalues = {};
            if (!hasInvalidColumns) {
                this._hidecelleditor(false);
             
                for (var i = 0; i < this.columns.records.length; i++) {
                    var column = this.columns.records[i];
                    var datafield = column.datafield;
                    if (!column.editable) {
                        continue;
                    }

                    if (column.columntype == "checkbox") {
                        continue;
                    }

                    if (!values[column.datafield]) {
                        continue;
                    }

                    var editorvalue = values[column.datafield].newvalue;
                    var oldvalue = values[column.datafield].oldvalue;

                    if (column.cellendedit) {
                        var cellendeditresult = column.cellendedit(row, datafield, column.columntype, oldvalue, editorvalue);
                        if (cellendeditresult == false) {
                            this._raiseEvent(18, { rowindex: row, datafield: datafield, displayfield: column.displayfield, oldvalue: oldvalue, value: oldvalue, columntype: column.columntype });
                            cancelchangesfunc(this);
                            continue;
                        }
                    }

                    this._raiseEvent(18, { rowindex: row, datafield: column.datafield, displayfield: column.displayfield, oldvalue: oldvalue, value: editorvalue, columntype: column.columntype });

                    rowvalues[column.datafield] = editorvalue;
                }
                var rowid = this.getrowid(row);
                var datarow = this.getrowdata(row);
                $.each(rowvalues, function (index, value) {
                    datarow[index] = value;
                });

         
                if (!this.enablebrowserselection) {
                    this.host.addClass('jqx-disableselect');
                    this.content.addClass('jqx-disableselect');
                }
                $.data(document.body, 'jqxgrid.edit', "");
                this.editcell = null;
                this.editchar = null;
                this.updaterow(rowid, datarow);
            }
 
            return hasInvalidColumns;
        },

        _selection: function (textbox) {
            if ('selectionStart' in textbox[0]) {
                var e = textbox[0];
                var selectionLength = e.selectionEnd - e.selectionStart;
                return { start: e.selectionStart, end: e.selectionEnd, length: selectionLength, text: e.value };
            }
            else {
                var r = document.selection.createRange();
                if (r == null) {
                    return { start: 0, end: e.value.length, length: 0 }
                }

                var re = textbox[0].createTextRange();
                var rc = re.duplicate();
                re.moveToBookmark(r.getBookmark());
                rc.setEndPoint('EndToStart', re);
                var selectionLength = r.text.length;

                return { start: rc.text.length, end: rc.text.length + r.text.length, length: selectionLength, text: r.text };
            }
        },

        _setSelection: function (start, end, textbox) {
            if ('selectionStart' in textbox[0]) {
                textbox[0].focus();
                textbox[0].setSelectionRange(start, end);
            }
            else {
                var range = textbox[0].createTextRange();
                range.collapse(true);
                range.moveEnd('character', end);
                range.moveStart('character', start);
                range.select();
            }
        },

        // finds the index to select in the jqxDropDownList editor.
        findRecordIndex: function (value, datafield, records) {
            var records = records;

            if (datafield) {
                var length = records.length;

                // loop through all records.
                for (var urec = 0; urec < length; urec++) {
                    var datarow = records[urec];
                    var currentValue = datarow['label'];
                    if (value == currentValue)
                        return urec;
                }
            }

            return -1;
        },

        _destroyeditors: function () {
            var me = this;
            $.each(this.columns.records, function (i, value) {
                var datafieldname = $.trim(this.datafield).split(" ").join("");

                switch (this.columntype) {
                    case "dropdownlist":
                        var dropdownlist = me.editors["dropdownlist" + "_" + datafieldname];
                        if (dropdownlist) {
                            dropdownlist.jqxDropDownList('destroy');
                            me.editors["dropdownlist" + "_" + datafieldname] = null;
                        }
                        break;
                    case "combobox":
                        var combobox = me.editors["combobox" + "_" + datafieldname];
                        if (combobox) {
                            combobox.jqxComboBox('destroy');
                            me.editors["combobox" + "_" + datafieldname] = null;
                        }
                        break;
                    case "datetimeinput":
                        var datetimeinput = me.editors["datetimeinput" + "_" + this.datafield];
                        if (datetimeinput) {
                            datetimeinput.jqxDateTimeInput('destroy');
                            me.editors["datetimeinput" + "_" + datafieldname] = null;
                        }
                        break;
                    case "numberinput":
                        var numberinput = me.editors["numberinput" + "_" + datafieldname];
                        if (numberinput) {
                            numberinput.jqxNumberInput('destroy');
                            me.editors["numberinput" + "_" + datafieldname] = null;
                        }
                        break;
                    case "custom":
                    case "template":
                        if (this.destroycustomeditor) {
                            this.destroycustomeditor(me.editors["customeditor" + "_" + datafieldname]);
                            me.editors["customeditor" + "_" + datafieldname] = null;
                        }
                        if (this.destrotemplateeditor) {
                            var rows = me.getrows.length();
                            for (var t = 0; t < rows; t++) {
                                this.destrotemplateeditor(me.editors["templateeditor" + "_" + datafieldname + "_" + t]);
                                me.editors["templateeditor" + "_" + datafieldname + "_" + t] = null;
                            }
                        }
                        break;
                }
            });
            me.editors = new Array();
        },

        _showcelleditor: function (row, column, element, init, focusable) {
            if (element == undefined)
                return;

            if (this.editcell == null)
                return;

            if (column.columntype == 'checkbox' && column.editable) {
                return;
            }

            if (focusable == undefined) focusable = true;
            if (this.editmode == "selectedrow") {
                this.editchar = "";
                focusable = false;
            }

            var datafield = column.datafield;
            var $element = $(element);
            var me = this;
            var editor = this.editcell.editor;
            var cellvalue = this.getcellvalue(row, datafield);
            var celltext = this.getcelltext(row, datafield);
            var hScrollInstance = this.hScrollInstance;
            var horizontalscrollvalue = hScrollInstance.value;
            var left = parseInt(horizontalscrollvalue);
            var columnIndex = this.columns.records.indexOf(column);
            this.editcell.element = element;

            if (this.editcell.validated == false) {
                this._showvalidationpopup();
            }

            var focuseditor = function (editor) {
                if (me.hScrollInstance.isScrolling() || me.vScrollInstance.isScrolling())
                    return;

                if (!focusable)
                    return;

                if (me.isTouchDevice()) {
                    return;
                }

                if (!me.isNestedGrid) {
                    editor.focus();
                }

                if (me.gridcontent[0].scrollTop != 0) {
                    me.scrolltop(Math.abs(me.gridcontent[0].scrollTop));
                    me.gridcontent[0].scrollTop = 0;
                }

                if (me.gridcontent[0].scrollLeft != 0) {
                    me.gridcontent[0].scrollLeft = 0;
                }
            }

            switch (column.columntype) {
                case "dropdownlist":
                    if (this.host.jqxDropDownList) {
                        element.innerHTML = "";
                        var datafieldname = $.trim(column.datafield).split(" ").join("");
                        var displayfield = $.trim(column.displayfield).split(" ").join("");

                        if (datafieldname.indexOf('.') != -1) {
                            datafieldname = datafieldname.replace('.', "");
                        }
                        if (displayfield.indexOf('.') != -1) {
                            displayfield = displayfield.replace('.', "");
                        }

                        var dropdownlisteditor = this.editors["dropdownlist" + "_" + datafieldname];
                        editor = dropdownlisteditor == undefined ? $("<div style='border-radius: 0px; -moz-border-radius: 0px; -webkit-border-radius: 0px; z-index: 99999; top: 0px; left: 0px; position: absolute;' id='dropdownlisteditor'></div>") : dropdownlisteditor;
                        editor.css('top', $(element).parent().position().top);
                        if (this.oldhscroll) {
                            editor.css('left', -left + parseInt($(element).position().left));
                        }
                        else {
                            editor.css('left', parseInt($(element).position().left));
                        }
                   
                        if (column.pinned) {
                            editor.css('left', left + parseInt($(element).position().left));
                        }


                        if (dropdownlisteditor == undefined) {
                            editor.prependTo(this.table);
                            editor[0].id = "dropdownlisteditor" + this.element.id + datafieldname;
                            var isdataadapter = this.source._source ? true : false;
                            var dataadapter = null;

                            if (!isdataadapter) {
                                dataadapter = new $.jqx.dataAdapter(this.source,
                                {
                                    autoBind: false,
                                    uniqueDataFields: [displayfield],
                                    async: false,
                                    autoSort: true,
                                    autoSortField: displayfield
                                });
                            }
                            else {
                                var dataSource =
                                {
                                    localdata: this.source.records,
                                    datatype: this.source.datatype,
                                    async: false
                                }

                                dataadapter = new $.jqx.dataAdapter(dataSource,
                                {
                                    autoBind: false,
                                    async: false,
                                    uniqueDataFields: [displayfield],
                                    autoSort: true,
                                    autoSortField: displayfield
                                });
                            }

                            var autoheight = !column.createeditor ? true : false;
                            editor.jqxDropDownList({ enableBrowserBoundsDetection: true, keyboardSelection: false, source: dataadapter, rtl: this.rtl, autoDropDownHeight: autoheight, theme: this.theme, width: $element.width() - 2, height: $element.height() - 2, displayMember: displayfield, valueMember: datafield });
                            editor.removeAttr('tabindex');
                            editor.find('div').removeAttr('tabindex');
                            this.editors["dropdownlist" + "_" + datafieldname] = editor;
                            if (column.createeditor) {
                                column.createeditor(row, cellvalue, editor);
                            }
                        }
                        if (column._requirewidthupdate) {
                            editor.jqxDropDownList({ width: $element.width() - 2 });
                        }

                        var dropdownitems = editor.jqxDropDownList('listBox').visibleItems;
                        if (!column.createeditor) {
                            if (dropdownitems.length < 8) {
                                editor.jqxDropDownList('autoDropDownHeight', true);
                            }
                            else {
                                editor.jqxDropDownList('autoDropDownHeight', false);
                            }
                        }
                        var cellvalue = this.getcellvalue(row, displayfield);
                        var selectedIndex = this.findRecordIndex(cellvalue, displayfield, dropdownitems);
                        if (init) {
                            if (cellvalue != "") {
                                editor.jqxDropDownList('selectIndex', selectedIndex, true);
                            }
                            else {
                                editor.jqxDropDownList('selectIndex', -1);
                            }
                        }

                        if (this.editcell.defaultvalue != undefined) {
                            editor.jqxDropDownList('selectIndex', this.editcell.defaultvalue, true);
                        }
                  
                        if (focusable) {
                            editor.jqxDropDownList('focus');
                        }
                    }
                    break;
                case "combobox":
                    if (this.host.jqxComboBox) {
                        element.innerHTML = "";
                        var datafieldname = $.trim(column.datafield).split(" ").join("");
                        var displayfield = $.trim(column.displayfield).split(" ").join("");
                        if (datafieldname.indexOf('.') != -1) {
                            datafieldname = datafieldname.replace('.', "");
                        }
                        if (displayfield.indexOf('.') != -1) {
                            displayfield = displayfield.replace('.', "");
                        }

                        var comboboxeditor = this.editors["combobox" + "_" + datafieldname];
                        editor = comboboxeditor == undefined ? $("<div style='border-radius: 0px; -moz-border-radius: 0px; -webkit-border-radius: 0px; z-index: 99999; top: 0px; left: 0px; position: absolute;' id='comboboxeditor'></div>") : comboboxeditor;
                        editor.css('top', $(element).parent().position().top);
                        if (this.oldhscroll) {
                            editor.css('left', -left + parseInt($(element).position().left));
                        }
                        else {
                            editor.css('left', parseInt($(element).position().left));
                        }
                        if (column.pinned) {
                            editor.css('left', left + parseInt($(element).position().left));
                        }

                        if (comboboxeditor == undefined) {
                            editor.prependTo(this.table);
                            editor[0].id = "comboboxeditor" + this.element.id + datafieldname;
                            var isdataadapter = this.source._source ? true : false;
                            var dataadapter = null;
                            if (!isdataadapter) {
                                dataadapter = new $.jqx.dataAdapter(this.source,
                                {
                                    autoBind: false,
                                    uniqueDataFields: [displayfield],
                                    async: false,
                                    autoSort: true,
                                    autoSortField: displayfield
                                });
                            }
                            else {
                                var dataSource =
                                {
                                    localdata: this.source.records,
                                    datatype: this.source.datatype,
                                    async: false
                                }

                                dataadapter = new $.jqx.dataAdapter(dataSource,
                                {
                                    autoBind: false,
                                    async: false,
                                    uniqueDataFields: [displayfield],
                                    autoSort: true,
                                    autoSortField: displayfield
                                });
                            }
                     
                            var autoheight = !column.createeditor ? true: false;
                            editor.jqxComboBox({ enableBrowserBoundsDetection: true, keyboardSelection: false, source: dataadapter, rtl: this.rtl, autoDropDownHeight: autoheight, theme: this.theme, width: $element.width() - 2, height: $element.height() - 2, displayMember: displayfield, valueMember: datafield });
                            editor.removeAttr('tabindex');
                            editor.find('div').removeAttr('tabindex');
                            this.editors["combobox" + "_" + datafieldname] = editor;
                            if (column.createeditor) {
                                column.createeditor(row, cellvalue, editor);
                            }
                        }
                        if (column._requirewidthupdate) {
                            editor.jqxComboBox({ width: $element.width() - 2 });
                        }

                        var dropdownitems = editor.jqxComboBox('listBox').visibleItems;
                        if (!column.createeditor) {
                            if (dropdownitems.length < 8) {
                                editor.jqxComboBox('autoDropDownHeight', true);
                            }
                            else {
                                editor.jqxComboBox('autoDropDownHeight', false);
                            }
                        }

                        var cellvalue = this.getcellvalue(row, displayfield);
                        var selectedIndex = this.findRecordIndex(cellvalue, displayfield, dropdownitems);
                        if (init) {
                            if (cellvalue != "") {
                                editor.jqxComboBox('selectIndex', selectedIndex, true);
                                editor.jqxComboBox('val', cellvalue);
                            }
                            else {
                                editor.jqxComboBox('selectIndex', -1);
                                editor.jqxComboBox('val', cellvalue);
                            }
                        }

                        if (this.editcell.defaultvalue != undefined) {
                            editor.jqxComboBox('selectIndex', this.editcell.defaultvalue, true);
                        }

                        if (this.editchar && this.editchar.length > 0) {
                            editor.jqxComboBox('input').val(this.editchar);
                        }

                        if (focusable) {
                            setTimeout(function () {
                                focuseditor(editor.jqxComboBox('input'));
                                editor.jqxComboBox('_setSelection', 0, 0);
                                if (me.editchar) {
                                    editor.jqxComboBox('_setSelection', 1, 1);
                                    me.editchar = null;
                                }
                                else {
                                    var val = editor.jqxComboBox('input').val();
                                    editor.jqxComboBox('_setSelection', 0, val.length);
                                }
                            }, 10);
                        }
                    }
                    break;
                case "datetimeinput":
                    if (this.host.jqxDateTimeInput) {
                        element.innerHTML = "";
                        var datafieldname = $.trim(column.datafield).split(" ").join("");
                        if (datafieldname.indexOf('.') != -1) {
                            datafieldname = datafieldname.replace('.', "");
                        }

                        var dateeditor = this.editors["datetimeinput" + "_" + datafieldname];
                        editor = dateeditor == undefined ? $("<div style='border-radius: 0px; -moz-border-radius: 0px; -webkit-border-radius: 0px; z-index: 99999; top: 0px; left: 0px; position: absolute;' id='datetimeeditor'></div>") : dateeditor;
                        editor.show();
                        editor.css('top', $(element).parent().position().top);
                        if (this.oldhscroll) {
                            editor.css('left', -left + parseInt($(element).position().left));
                        }
                        else {
                            editor.css('left', parseInt($(element).position().left));
                        }
                        if (column.pinned) {
                            editor.css('left', left + parseInt($(element).position().left));
                        }

                        if (dateeditor == undefined) {
                            editor.prependTo(this.table);
                            editor[0].id = "datetimeeditor" + this.element.id + datafieldname;
                            var localization = { calendar: this.gridlocalization };
                            editor.jqxDateTimeInput({ enableBrowserBoundsDetection: true, localization: localization, _editor: true, theme: this.theme, rtl: this.rtl, width: $element.width(), height: $element.height(), formatString: column.cellsformat });
                            this.editors["datetimeinput" + "_" + datafieldname] = editor;
                            if (column.createeditor) {
                                column.createeditor(row, cellvalue, editor);
                            }
                        }
                        if (column._requirewidthupdate) {
                            editor.jqxDateTimeInput({ width: $element.width() - 2 });
                        }
                        if (init) {
                            if (cellvalue != "" && cellvalue != null) {
                                var date = new Date(cellvalue);
                                if (date == "Invalid Date") {
                                    if (this.source.getvaluebytype) {
                                        date = this.source.getvaluebytype(cellvalue, { name: column.datafield, type: 'date' });
                                    }
                                }

                                editor.jqxDateTimeInput('setDate', date);
                            }
                            else {
                                editor.jqxDateTimeInput('setDate', null);
                            }

                            if (this.editcell.defaultvalue != undefined) {
                                editor.jqxDateTimeInput('setDate', this.editcell.defaultvalue);
                            }
                        }
                        if (focusable) {
                            setTimeout(function () {
                                focuseditor(editor.jqxDateTimeInput('dateTimeInput'));
                            }, 10);
                        }
                    }
                    break;
                case "numberinput":
                    if (this.host.jqxNumberInput) {
                        element.innerHTML = "";
                        var datafieldname = $.trim(column.datafield).split(" ").join("");
                        if (datafieldname.indexOf('.') != -1) {
                            datafieldname = datafieldname.replace('.', "");
                        }
                        var numbereditor = this.editors["numberinput" + "_" + datafieldname];
                        editor = numbereditor == undefined ? $("<div style='border-radius: 0px; -moz-border-radius: 0px; -webkit-border-radius: 0px; z-index: 99999; top: 0px; left: 0px; position: absolute;' id='numbereditor'></div>") : numbereditor;
                        editor.show();
                        editor.css('top', $(element).parent().position().top);
                        if (this.oldhscroll) {
                            editor.css('left', -left + parseInt($(element).position().left));
                        }
                        else {
                            editor.css('left', parseInt($(element).position().left));
                        }
                        if (column.pinned) {
                            editor.css('left', left + parseInt($(element).position().left));
                        }

                        if (numbereditor == undefined) {
                            editor.prependTo(this.table);
                            editor[0].id = "numbereditor" + this.element.id + datafieldname;
                            var symbol = '';
                            var symbolPosition = 'left';
                            var digits = 2;
                            if (column.cellsformat) {
                                if (column.cellsformat.indexOf('c') != -1) {
                                    symbol = this.gridlocalization.currencysymbol;
                                    symbolPosition = this.gridlocalization.currencysymbolposition;
                                    if (symbolPosition == 'before') symbolPosition = 'left';
                                    else symbolPosition = 'right';
                                    if (column.cellsformat.length > 1)
                                    {
                                        digits = parseInt(column.cellsformat.substring(1), 10);
                                    }
                                }
                                else if (column.cellsformat.indexOf('p') != -1) {
                                    symbol = this.gridlocalization.percentsymbol;
                                    symbolPosition = 'right';
                                    if (column.cellsformat.length > 1) {
                                        digits = parseInt(column.cellsformat.substring(1), 10);
                                    }
                                }
                            }
                            else digits = 0;

                            editor.jqxNumberInput({decimalSeparator: this.gridlocalization.decimalseparator, decimalDigits: digits, inputMode: 'simple', theme: this.theme, rtl: this.rtl, width: $element.width() - 1, height: $element.height() - 1, spinButtons: true, symbol: symbol, symbolPosition: symbolPosition });
                            this.editors["numberinput" + "_" + datafieldname] = editor;
                            if (column.createeditor) {
                                column.createeditor(row, cellvalue, editor);
                            }
                        }
                        if (column._requirewidthupdate) {
                            editor.jqxNumberInput({ width: $element.width() - 2 });
                        }
                        if (init) {
                            if (cellvalue != "" && cellvalue != null) {
                                var decimal = cellvalue;
                                editor.jqxNumberInput('setDecimal', decimal);
                            }
                            else {
                                editor.jqxNumberInput('setDecimal', 0);
                            }

                            if (this.editcell.defaultvalue != undefined) {
                                editor.jqxNumberInput('setDecimal', this.editcell.defaultvalue);
                            }

                            if (this.editchar && this.editchar.length > 0) {
                                var digit = parseInt(this.editchar);
                                if (!isNaN(digit)) {
                                    editor.jqxNumberInput('setDecimal', digit);
                                }
                            }

                            if (focusable) {
                                setTimeout(function () {
                                    focuseditor(editor.jqxNumberInput('numberInput'));
                                    editor.jqxNumberInput('_setSelectionStart', 0);
                                    if (me.editchar) {
                                        if (column.cellsformat.length > 0) {
                                            editor.jqxNumberInput('_setSelectionStart', 2);
                                        }
                                        else {
                                            editor.jqxNumberInput('_setSelectionStart', 1);
                                        }
                                        me.editchar = null;
                                    }
                                    else {
                                        var spinbuttons = editor.jqxNumberInput('spinButtons');
                                        if (spinbuttons) {
                                            var val = editor.jqxNumberInput('numberInput').val();
                                            me._setSelection(editor.jqxNumberInput('numberInput')[0], val.length, val.length);
                                        }
                                        else {
                                            var val = editor.jqxNumberInput('numberInput').val();
                                            me._setSelection(editor.jqxNumberInput('numberInput')[0], 0, val.length);
                                        }
                                    }
                                }, 10);
                            }
                        }
                    }
                    break;
                case "custom":
                    element.innerHTML = "";
                    var datafieldname = $.trim(column.datafield).split(" ").join("");
                    if (datafieldname.indexOf('.') != -1) {
                        datafieldname = datafieldname.replace('.', "");
                    }
                    var customeditor = this.editors["customeditor" + "_" + datafieldname + "_" + row];
                    editor = customeditor == undefined ? $("<div style='overflow: hidden; border-radius: 0px; -moz-border-radius: 0px; -webkit-border-radius: 0px; z-index: 99999; top: 0px; left: 0px; position: absolute;' id='customeditor'></div>") : customeditor;
                    editor.show();
                    editor.css('top', $(element).parent().position().top);
                    if (this.oldhscroll) {
                        editor.css('left', -left + parseInt($(element).position().left));
                    }
                    else {
                        editor.css('left', parseInt($(element).position().left));
                    }
                    if (column.pinned) {
                        editor.css('left', left + parseInt($(element).position().left));
                    }

                    if (customeditor == undefined) {
                        editor.prependTo(this.table);
                        editor[0].id = "customeditor" + this.element.id + datafieldname + "_" + row;
                        this.editors["customeditor" + "_" + datafieldname + "_" + row] = editor;
                        var width = $element.width() - 1;
                        var height = $element.height() - 1;
                        editor.width(width);
                        editor.height(height);

                        if (column.createeditor) {
                            column.createeditor(row, cellvalue, editor, celltext, width, height, this.editchar);
                        }
                    }
                    if (column._requirewidthupdate) {
                        editor.width($element.width() - 2);
                    }
                    break;
                case "template":
                    element.innerHTML = "";
                    var datafieldname = $.trim(column.datafield).split(" ").join("");
                    if (datafieldname.indexOf('.') != -1) {
                        datafieldname = datafieldname.replace('.', "");
                    }
                    var templateeditor = this.editors["templateeditor" + "_" + datafieldname];
                    editor = templateeditor == undefined ? $("<div style='overflow: hidden; border-radius: 0px; -moz-border-radius: 0px; -webkit-border-radius: 0px; z-index: 99999; top: 0px; left: 0px; position: absolute;' id='templateeditor'></div>") : templateeditor;
                    editor.show();
                    editor.css('top', $(element).parent().position().top);
                    if (this.oldhscroll) {
                        editor.css('left', -left + parseInt($(element).position().left));
                    }
                    else {
                        editor.css('left', parseInt($(element).position().left));
                    }
                    if (column.pinned) {
                        editor.css('left', left + parseInt($(element).position().left));
                    }

                    if (templateeditor == undefined) {
                        editor.prependTo(this.table);
                        editor[0].id = "templateeditor" + this.element.id + datafieldname;
                        this.editors["templateeditor" + "_" + datafieldname] = editor;
                        var width = $element.width() - 1;
                        var height = $element.height() - 1;
                        editor.width(width);
                        editor.height(height);
                  
                        if (column.createeditor) {
                            column.createeditor(row, cellvalue, editor, celltext, width, height, this.editchar);
                        }
                    }
                    if (column._requirewidthupdate) {
                        editor.width($element.width() - 2);
                    }
                    break;
                case "textbox":
                default:
                    element.innerHTML = "";
                    editor = this.editors["textboxeditor" + "_" + column.datafield] || $("<input autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false' type='textbox' id='textboxeditor'/>");
                    editor[0].id = "textboxeditor" + this.element.id + column.datafield;
                    editor.appendTo($element);

                    if (this.rtl) {
                        editor.css('direction', 'rtl');
                    }

                    if (init) {
                        editor.addClass(this.toThemeProperty('jqx-input'));
                        editor.addClass(this.toThemeProperty('jqx-widget-content'));
                        if (this.editchar && this.editchar.length > 0) {
                            editor.val(this.editchar);
                        }
                        else {
                            if (column.cellsformat != "") {
                                cellvalue = this.getcelltext(row, datafield);
                            }

                            editor.val(cellvalue);
                        }

                        if (this.editcell.defaultvalue != undefined) {
                            editor.val(this.editcell.defaultvalue);
                        }
                        editor.width($element.width()+1);
                        editor.height($element.height()+1);

                        if (column.createeditor) {
                            column.createeditor(row, cellvalue, editor);
                        }

                        if (column.cellsformat != "") {
                            if (column.cellsformat.indexOf('p') != -1 || column.cellsformat.indexOf('c') != -1 || column.cellsformat.indexOf('n') != -1 || column.cellsformat.indexOf('f') != -1) {
                                if (!this.editors["textboxeditor" + "_" + column.datafield]) {
                                    editor.keydown(function (event) {
                                        var key = event.charCode ? event.charCode : event.keyCode ? event.keyCode : 0;
                                        var letter = String.fromCharCode(key);
                                        var charDigit = parseInt(letter);
                                        if (isNaN(charDigit))
                                            return true;
                                        if (me._selection(editor).length > 0)
                                            return true;
                                       
                                        var val = "";
                                        var cellvalue = editor.val();
                                        if (column.cellsformat.length > 1) {
                                            var decimalOffset = parseInt(column.cellsformat.substring(1));
                                            if (isNaN(decimalOffset)) decimalOffset = 0;
                                        }
                                        else {
                                            var decimalOffset = 0;
                                        }

                                        if (decimalOffset > 0) {
                                            if (cellvalue.indexOf(me.gridlocalization.decimalseparator) != -1) {
                                                if (me._selection(editor).start > cellvalue.indexOf(me.gridlocalization.decimalseparator)) {
                                                    return true;
                                                }
                                            }
                                        }

                                        for (var t = 0; t < cellvalue.length - decimalOffset; t++) {
                                            var ch = cellvalue.substring(t, t + 1);
                                            if (ch.match(/^[0-9]+$/) != null) {
                                                val += ch;
                                            }
                                        }
                                        if (val.length >= 11) {
                                            return false;
                                        }
                                    });
                                }
                            }
                        }
                    }

                    this.editors["textboxeditor" + "_" + column.datafield] = editor;

                    if (init) {
                        if (focusable) {
                            setTimeout(function () {
                                focuseditor(editor);
                                if (me.editchar) {
                                    me._setSelection(editor[0], 1, 1);
                                    me.editchar = null;
                                }
                                else {
                                    me._setSelection(editor[0], 0, editor.val().length);
                                }
                            }, 10);
                        }
                    }
                    break;
            }

            if (init) {
                if (column.initeditor) {
                    column.initeditor(row, cellvalue, editor, celltext, this.editchar);
                }
            }

            if (editor) {
                editor[0].style.zIndex = 1 + element.style.zIndex;
                if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                    editor[0].style.zIndex = 1+this.columns.records.length + element.style.zIndex;
                }
                editor.css('display', 'block');
                this.editcell.editor = editor;
                if (!this.editcell[datafield]) {
                    this.editcell[datafield] = {};
                    this.editcell[datafield].editor = editor;
                }
                else {
                    this.editcell[datafield].editor = editor;
                }
            }
            if (me.isTouchDevice()) {
                return;
            }

            setTimeout(function () {
                if (me.content) {
                    me.content[0].scrollTop = 0;
                    me.content[0].scrollLeft = 0;
                }
                if (me.gridcontent) {
                    me.gridcontent[0].scrollLeft = 0;
                    me.gridcontent[0].scrollTop = 0;
                }
            }, 10);
        },

        _setSelection: function (textbox, start, end) {
            try {
                if ('selectionStart' in textbox) {
                    textbox.setSelectionRange(start, end);
                }
                else {
                    var range = textbox.createTextRange();
                    range.collapse(true);
                    range.moveEnd('character', end);
                    range.moveStart('character', start);
                    range.select();
                }
            }
            catch (error) {
                var err = error;
            }
        },

        _hideeditors: function () {
            if (this.editcells != null) {
                var me = this;
                for (var obj in this.editcells) {
                    me.editcell = me.editcells[obj];
                    me._hidecelleditor();
                }
            }
        },

        _hidecelleditor: function (focus) {
            if (!this.editcell) {
                return;
            }
      
            if (this.editmode === "selectedrow") {
                for (var i = 0; i < this.columns.records.length; i++) {
                    var column = this.columns.records[i];
                    if (this.editcell[column.datafield] && this.editcell[column.datafield].editor) {
                        this.editcell[column.datafield].editor.hide();
                        var editor = this.editcell[column.datafield].editor;
                        switch (column.columntype) {
                            case "dropdownlist":
                                editor.jqxDropDownList({ closeDelay: 0 });
                                editor.jqxDropDownList('hideListBox');
                                editor.jqxDropDownList({ closeDelay: 300 });
                                break;
                            case "combobox":
                                editor.jqxComboBox({ closeDelay: 0 });
                                editor.jqxComboBox('hideListBox');
                                editor.jqxComboBox({ closeDelay: 300 });
                                break;
                            case "datetimeinput":
                                if (editor.jqxDateTimeInput('isOpened')) {
                                    editor.jqxDateTimeInput({ closeDelay: 0 });
                                    editor.jqxDateTimeInput('hideCalendar');
                                    editor.jqxDateTimeInput({ closeDelay: 300 });
                                }
                                break;
                        }
                    }
                }
                if (this.validationpopup) {
                    this.validationpopup.hide();
                    this.validationpopuparrow.hide();
                }
                return;
            }

            if (this.editcell.columntype == 'checkbox') {
                return;
            }

            if (this.editcell.editor) {
                this.editcell.editor.hide();
                switch (this.editcell.columntype) {
                    case "dropdownlist":
                        this.editcell.editor.jqxDropDownList({ closeDelay: 0 });
                        this.editcell.editor.jqxDropDownList('hideListBox');
                        this.editcell.editor.jqxDropDownList({ closeDelay: 300 });
                        break;
                    case "combobox":
                        this.editcell.editor.jqxComboBox({ closeDelay: 0 });
                        this.editcell.editor.jqxComboBox('hideListBox');
                        this.editcell.editor.jqxComboBox({ closeDelay: 300 });
                        break;
                    case "datetimeinput":
                        var datetimeeiditor = this.editcell.editor;
                        if (datetimeeiditor.jqxDateTimeInput('isOpened')) {
                            datetimeeiditor.jqxDateTimeInput({ closeDelay: 0 });
                            datetimeeiditor.jqxDateTimeInput('hideCalendar');
                            datetimeeiditor.jqxDateTimeInput({ closeDelay: 300 });
                        }
                        break;
                }
            }

            if (this.validationpopup) {
                this.validationpopup.hide();
                this.validationpopuparrow.hide();
            }
            if (!this.isNestedGrid) {
                if (focus != false) {
                    this.element.focus();
                }
            }
        },

        _geteditorvalue: function (column) {
            var value = new String();
            if (!this.editcell) {
                return null;
            }

            var editor = this.editcell.editor;
            if (this.editmode == "selectedrow") {
                if (this.editcell[column.datafield]) {
                    var editor = this.editcell[column.datafield].editor;
                }
            }

            if (editor) {
                switch (column.columntype) {
                    case "textbox":
                    default:
                        value = editor.val();
                        if (column.cellsformat != "") {
                            var type = 'string';
                            var datafields = this.source.datafields || ((this.source._source) ? this.source._source.datafields : null);

                            if (datafields) {
                                var foundType = "";
                                $.each(datafields, function () {
                                    if (this.name == column.displayfield) {
                                        if (this.type) {
                                            foundType = this.type;
                                        }
                                        return false;
                                    }
                                });
                                if (foundType)
                                    type = foundType;
                            }

                            var number = type === "number" || type === "float" || type === "int" || type === "integer";
                            var date = type === "date" || type === "time";
                            if (number || (type === "string" && (column.cellsformat.indexOf('p') != -1 || column.cellsformat.indexOf('c') != -1 || column.cellsformat.indexOf('n') != -1 || column.cellsformat.indexOf('f') != -1))) {
                                if (value === "" && column.nullable)
                                    return "";

                                if (value.indexOf(this.gridlocalization.currencysymbol) > -1) {
                                    // remove currency symbol
                                    value = value.replace(this.gridlocalization.currencysymbol, "");
                                }
                               
                                var replaceAll = function(text, stringToFind, stringToReplace) {
                                    var temp = text;
                                    if (stringToFind == stringToReplace) return text;

                                    var index = temp.indexOf(stringToFind);
                                    while (index != -1) {
                                        temp = temp.replace(stringToFind, stringToReplace);
                                        index = temp.indexOf(stringToFind)
                                    }
                              
                                    return temp;
                                }

                                value = replaceAll(value, this.gridlocalization.thousandsseparator, "");
                                value = value.replace(this.gridlocalization.decimalseparator, ".");

                                if (value.indexOf(this.gridlocalization.percentsymbol) > -1) {
                                    value = value.replace(this.gridlocalization.percentsymbol, "");
                                }

                                var val = "";
                                for (var t = 0; t < value.length; t++) {
                                    var ch = value.substring(t, t + 1);
                                    if (ch === "-") val += "-";
                                    if (ch === ".") val += ".";
                                    if (ch.match(/^[0-9]+$/) != null) {
                                        val += ch;
                                    }
                                }

                                value = val;
                                value = value.replace(/ /g, "");

                                value = new Number(value);
                                if (isNaN(value))
                                    value = "";
                            }
                            if (date || (type === "string" && (column.cellsformat.indexOf('H') != -1 || column.cellsformat.indexOf('m') != -1 || column.cellsformat.indexOf('M') != -1 || column.cellsformat.indexOf('y') != -1
                                || column.cellsformat.indexOf('h') != -1 || column.cellsformat.indexOf('d') != -1))) {
                                if (value === "" && column.nullable)
                                    return "";

                                var tmpValue = value;
                                value = new Date(value);
                                if (value == "Invalid Date" || value == null) {
                                    if ($.jqx.dataFormat) {
                                        value = $.jqx.dataFormat.tryparsedate(tmpValue, this.gridlocalization);
                                    }
                                    if (value == "Invalid Date" || value == null) {
                                        value = "";
                                    }
                                }
                            }

                        }
                        if (column.displayfield != column.datafield) {
                            value = { label: value, value: value };
                        }
                        break;
                    case "datetimeinput":
                        if (editor.jqxDateTimeInput) {
                            editor.jqxDateTimeInput({ isEditing: false });
                            editor.jqxDateTimeInput('_validateValue');
                            value = editor.jqxDateTimeInput('getDate');
                            if (value == null) return null;
                            value = new Date(value.toString());
                            if (column.displayfield != column.datafield) {
                                value = { label: value, value: value };
                            }
                        }
                        break;
                    case "dropdownlist":
                        if (editor.jqxDropDownList) {
                            var selectedIndex = editor.jqxDropDownList('selectedIndex');
                            var item = editor.jqxDropDownList('listBox').getVisibleItem(selectedIndex);
                            if (column.displayfield != column.datafield) {
                                if (item) {
                                    value = { label: item.label, value: item.value };
                                }
                                else value = "";
                            }
                            else {
                                if (item) value = item.label;
                                else value = "";
                            }

                            if (value == null) {
                                value = "";
                            }
                        }
                        break;
                    case "combobox":
                        if (editor.jqxComboBox) {
                            value = editor.jqxComboBox('val');
                            if (column.displayfield != column.datafield) {
                                var item = editor.jqxComboBox('getSelectedItem');
                                if (item != null) {
                                    value = { label: item.label, value: item.value };
                                }
                            }

                            if (value == null) {
                                value = "";
                            }
                        }
                        break;
                    case "numberinput":
                        if (editor.jqxNumberInput) {
                            if (this.touchdevice) {
                                editor.jqxNumberInput('_doTouchHandling');
                            }
                            var decimal = editor.jqxNumberInput('getDecimal');
                            value = new Number(decimal);
                            value = parseFloat(value);
                            if (isNaN(value)) {
                                value = 0;
                            }
                            if (column.displayfield != column.datafield) {
                                value = { label: value, value: value };
                            }
                        }
                        break;
                }
                if (column.geteditorvalue) {
                    if (this.editmode == "selectedrow") {
                        value = column.geteditorvalue(this.editcell.row, this.getcellvalue(this.editcell.row, column.datafield), editor);
                    }
                    else {
                        value = column.geteditorvalue(this.editcell.row, this.editcell.value, editor);
                    }
                }
            }
            return value;
        },

        hidevalidationpopups: function () {
            if (this.popups) {
                $.each(this.popups, function () {
                    this.validation.remove();
                    this.validationrow.remove();
                });
                this.popups = new Array();
            }
            if (this.validationpopup) {
                this.validationpopuparrow.hide();
                this.validationpopup.hide();
            }
        },


        showvalidationpopup: function (row, datafield, message) {
            if (message == undefined) {
                var message = this.gridlocalization.validationstring;
            }

            var validationpopup = $("<div style='z-index: 99999; top: 0px; left: 0px; position: absolute;'></div>");
            var validationpopuparrow = $("<div style='width: 20px; height: 20px; z-index: 999999; top: 0px; left: 0px; position: absolute;'></div>");
            validationpopup.html(message);
            validationpopuparrow.addClass(this.toThemeProperty('jqx-grid-validation-arrow-up'));
            validationpopup.addClass(this.toThemeProperty('jqx-grid-validation'));
            validationpopup.addClass(this.toThemeProperty('jqx-rc-all'));
            validationpopup.prependTo(this.table);
            validationpopuparrow.prependTo(this.table);

            var hScrollInstance = this.hScrollInstance;
            var horizontalscrollvalue = hScrollInstance.value;
            var left = parseInt(horizontalscrollvalue);
            var element = this.getcolumn(datafield).uielement;
            var rowElement = $(this.hittestinfo[row].visualrow);
            validationpopup.css('top', parseInt(rowElement.position().top) + 30 + 'px');

            var topposition = parseInt(validationpopup.css('top'));

            validationpopuparrow.css('top', topposition - 12);
            validationpopuparrow.removeClass();
            validationpopuparrow.addClass(this.toThemeProperty('jqx-grid-validation-arrow-up'));

            var negativePosition = false;
            if (topposition >= this._gettableheight()) {
                validationpopuparrow.removeClass(this.toThemeProperty('jqx-grid-validation-arrow-up'));
                validationpopuparrow.addClass(this.toThemeProperty('jqx-grid-validation-arrow-down'));
                topposition = parseInt(rowElement.position().top) - this.rowsheight - 5;
                if (topposition < 0) {
                    topposition = 0;
                    this.validationpopuparrow.removeClass(this.toThemeProperty('jqx-grid-validation-arrow-down'));
                    negativePosition = true;
                }
                validationpopup.css('top', topposition + 'px');
                validationpopuparrow.css('top', topposition + validationpopup.outerHeight() - 9);
            }
            var leftposition = -left + parseInt($(element).position().left);

            validationpopuparrow.css('left', left + leftposition + 30);

            var width = validationpopup.width();
            if (width + leftposition > this.host.width() - 20) {
                var offset = width + leftposition - this.host.width() + 40;
                leftposition -= offset;
            }

            if (!negativePosition) {
                validationpopup.css('left', left + leftposition);
            } else {
                validationpopup.css('left', left + parseInt($(element).position().left) - validationpopup.outerWidth());
            }

            validationpopup.show();
            validationpopuparrow.show();
            if (!this.popups) {
                this.popups = new Array();
            }
            this.popups[this.popups.length] = { validation: validationpopup, validationrow: validationpopuparrow };
        },

        _showvalidationpopup: function (row, datafield, message) {
            var editor = this.editcell.editor;
            if (this.editmode == "selectedrow") {
                var editcell = this.editcell[datafield];
                if (editcell && editcell.editor) {
                    editor = editcell.editor;
                    editcell.element = editor;
                }
            }

            if (!editor)
                return;

            if (!this.validationpopup) {
                var validationpopup = $("<div style='z-index: 99999; top: 0px; left: 0px; position: absolute;'></div>");
                var validationpopuparrow = $("<div style='width: 20px; height: 20px; z-index: 999999; top: 0px; left: 0px; position: absolute;'></div>");
                validationpopup.html(message);
                validationpopuparrow.addClass(this.toThemeProperty('jqx-grid-validation-arrow-up'));
                validationpopup.addClass(this.toThemeProperty('jqx-grid-validation'));
                validationpopup.addClass(this.toThemeProperty('jqx-rc-all'));
                validationpopup.prependTo(this.table);
                validationpopuparrow.prependTo(this.table);
                this.validationpopup = validationpopup;
                this.validationpopuparrow = validationpopuparrow;
            }
            else {
                this.validationpopup.html(message);
            }

            var hScrollInstance = this.hScrollInstance;
            var horizontalscrollvalue = hScrollInstance.value;
            var left = parseInt(horizontalscrollvalue);

            this.validationpopup.css('top', parseInt($(this.editcell.element).parent().position().top) + (this.rowsheight + 5) + 'px');

            var topposition = parseInt(this.validationpopup.css('top'));

            this.validationpopuparrow.css('top', topposition - 12);
            this.validationpopuparrow.removeClass();
            this.validationpopuparrow.addClass(this.toThemeProperty('jqx-grid-validation-arrow-up'));
            var height = this._gettableheight();

            var negativePosition = false;
            if (topposition >= height) {
                this.validationpopuparrow.removeClass(this.toThemeProperty('jqx-grid-validation-arrow-up'));
                this.validationpopuparrow.addClass(this.toThemeProperty('jqx-grid-validation-arrow-down'));
                topposition = parseInt($(this.editcell.element).parent().position().top) - this.rowsheight - 5;
                if (topposition < 0) {
                    topposition = 0;
                    this.validationpopuparrow.removeClass(this.toThemeProperty('jqx-grid-validation-arrow-down'));
                    negativePosition = true;
                }

                this.validationpopup.css('top', topposition + 'px');
                this.validationpopuparrow.css('top', topposition + this.validationpopup.outerHeight() - 9);
            }
            var leftposition = -left + parseInt($(editor).position().left);

            this.validationpopuparrow.css('left', left + leftposition + 30);

            var width = this.validationpopup.width();
            if (width + leftposition > this.host.width() - 20) {
                var offset = width + leftposition - this.host.width() + 40;
                leftposition -= offset;
            }

            if (!negativePosition) {
                this.validationpopup.css('left', left + leftposition);
            }
            else {
                this.validationpopup.css('left', left + parseInt($(this.editcell.element).position().left) - this.validationpopup.outerWidth());
            }

            this.validationpopup.show();
            this.validationpopuparrow.show();
        }
    });
})(jQuery);


(function ($) {
    $.extend($.jqx._jqxGrid.prototype, {
        _calculateaggregate: function (column, aggregates, formatData, records) {
            var aggregate = column.aggregates;
            if (!aggregate) aggregate = aggregates;

            if (aggregate) {
                var formatstrings = new Array();
                for (var i = 0; i < aggregate.length; i++) {
                    if (aggregate[i] == 'count') {
                        continue;
                    }
                    formatstrings[formatstrings.length] = column.cellsformat;
                }

                if (this.source && this.source.getAggregatedData) {
                    if (records == undefined) {
                        records = this.getrows();
                    }
                    if (this.virtualmode) {
                        var records = new Array();
                        $.each(this.source._source.records, function () {
                            records.push(this);
                        });
                    }

                    if (formatData == undefined || formatData == true) {
                        var summaryData = this.source.getAggregatedData
                ([{ name: column.datafield, aggregates: aggregate, formatStrings: formatstrings }], this.gridlocalization, records);
                        return summaryData;
                    }
                    else {
                        var summaryData = this.source.getAggregatedData
                ([{ name: column.datafield, aggregates: aggregate }], this.gridlocalization, records);
                        return summaryData;
                    }
                }
            }
            return null;
        },

        getcolumnaggregateddata: function (datafield, aggregates, formatdata, records) {
            var column = this.getcolumn(datafield);
            var format = (formatdata == undefined || formatdata == false) ? false : formatdata;
            if (aggregates == null) return "";

            var tmpaggregates = column.aggregates;
            column.aggregates = null;

            var agg = this._calculateaggregate(column, aggregates, format, records);
            var summaryData = {};
            if (agg) {
                summaryData = agg[datafield];
                column.aggregates = tmpaggregates;
            }
            return summaryData;
        },

        refreshaggregates: function () {
            this._updatecolumnsaggregates();
        },

        renderaggregates: function () {
            this._updateaggregates();
        },

        _updatecolumnaggregates: function (column, aggregates, columnelement) {
            var me = this;
            if (!aggregates) {
                columnelement.children().remove();
                columnelement.html('');
                if (column.aggregatesrenderer) {
                    var obj = {};
                    if (column.aggregates) {
                        obj = this.getcolumnaggregateddata(column.datafield, column.aggregates);
                    }

                    var renderstring = column.aggregatesrenderer({}, column, columnelement, null);
                    columnelement.html(renderstring);
                }
                return;
            }

            columnelement.children().remove();
            columnelement.html('');
            if (column.aggregatesrenderer) {
                if (aggregates) {
                    var renderstring = column.aggregatesrenderer(aggregates[column.datafield], column, columnelement, this.getcolumnaggregateddata(column.datafield, aggregates[column.datafield]));
                    columnelement.html(renderstring);
                }
            }
            else {
                $.each(aggregates, function () {
                    var aggregate = this;
                    for (obj in aggregate) {
                        var field = $('<div style="position: relative; margin: 4px; overflow: hidden;"></div>');
                        var name = obj;
                        name = me._getaggregatename(name);
                        field.html(name + ':' + aggregate[obj]);
                        if (me.rtl) {
                            field.addClass(me.toThemeProperty('jqx-rtl'));
                        }

                        columnelement.append(field);
                    }
                });
            }
        },

        _getaggregatetype: function (obj) {
            switch (obj) {
                case 'min':
                case 'max':
                case 'count':
                case 'avg':
                case 'product':
                case 'var':
                case 'varp':
                case 'stdev':
                case 'stdevp':
                case 'sum':
                    return obj;
            }
            var name = obj;
            for (var myObj in obj) {
                name = myObj;
                break;
            }
            return name;
        },

        _getaggregatename: function (obj) {
            var name = obj;
            switch (obj) {
                case 'min':
                    name = 'Min';
                    break;
                case 'max':
                    name = 'Max';
                    break;
                case 'count':
                    name = 'Count';
                    break;
                case 'avg':
                    name = 'Avg';
                    break;
                case 'product':
                    name = 'Product';
                    break;
                case 'var':
                    name = 'Var';
                    break;
                case 'stdevp':
                    name = 'StDevP';
                    break;
                case 'stdev':
                    name = 'StDev';
                    break;
                case 'varp':
                    name = 'VarP';
                case 'sum':
                    name = 'Sum';
                    break;
            }
            if (obj === name && typeof(name) != 'string') {
                for (var myObj in obj) {
                    name = myObj;
                    break;
                }
            }
            return name;
        },

        _updatecolumnsaggregates: function () {
            var rows = this.getrows();
            var columnslength = this.columns.records.length;
            if (undefined != this.statusbar[0].cells) {
                for (var j = 0; j < columnslength; j++) {
                    var tablecolumn = $(this.statusbar[0].cells[j]);
                    var columnrecord = this.columns.records[j];
                    var summaryData = this._calculateaggregate(columnrecord, null, true, rows);
                    this._updatecolumnaggregates(columnrecord, summaryData, tablecolumn);
                }
            }
        },

        _updateaggregates: function () {
            var tablerow = $('<div style="position: relative;" id="statusrow' + this.element.id + '"></div>');
            var left = 0;
            var columnslength = this.columns.records.length;
            var cellclass = this.toThemeProperty('jqx-grid-cell');
            if (this.rtl) {
                cellclass += ' ' + this.toThemeProperty('jqx-grid-cell-rtl');
                left = -1;
            }
            cellclass += ' ' + this.toThemeProperty('jqx-grid-cell-pinned');
            //var cellclass = this.toThemeProperty('jqx-widget-header');
            var zindex = columnslength + 10;
            var cells = new Array();
            this.statusbar[0].cells = cells;
            
            for (var j = 0; j < columnslength; j++) {
                var columnrecord = this.columns.records[j];
                var summaryData = this._calculateaggregate(columnrecord);
                var width = columnrecord.width;
                if (width < columnrecord.minwidth) width = columnrecord.minwidth;
                if (width > columnrecord.maxwidth) width = columnrecord.maxwidth;

                var tablecolumn = $('<div style="overflow: hidden; position: absolute; height: 100%;" class="' + cellclass + '"></div>');
                tablerow.append(tablecolumn);
                tablecolumn.css('left', left);
                if (!this.rtl) {
                    tablecolumn.css('z-index', zindex--);
                }
                else {
                    tablecolumn.css('z-index', zindex++);
                }

                tablecolumn.width(width);
                tablecolumn[0].left = left;
                if (!(columnrecord.hidden && columnrecord.hideable)) {
                    left += width;
                }
                else {
                    tablecolumn.css('display', 'none');
                }
                cells[cells.length] = tablecolumn[0];
                this._updatecolumnaggregates(columnrecord, summaryData, tablecolumn);
            }

            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                tablerow.css('z-index', zindex--);
            }

            tablerow.width(parseInt(left) + 2);
            tablerow.height(this.statusbarheight);
            this.statusbar.children().remove();
            this.statusbar.append(tablerow);
            this.statusbar.removeClass(this.toThemeProperty('jqx-widget-header'));
            this.statusbar.addClass(cellclass);
            this.statusbar.css('border-bottom-color', 'transparent');
            this.statusbar.css('border-top-width', '1px');
            if (this.rtl && this.hScrollBar.css('visibility') != 'hidden') {
                this._renderhorizontalscroll();
            }
        }
    });
})(jQuery);



(function ($) {
    var ArrayExporter = (function () {

        var exportModules = {},
            data, dataFields, styles, exporter, stylesArray;

        function exportData(exporter) {
            exporter.beginFile();
            exportHeader(exporter);
            exportContent(exporter);
            exporter.endFile();
            return exporter.getFile();
        }

        function exportHeader(exporter) {
            var exportHeaders = true;
            $.each(dataFields, function () {
                if (this.hidden) {
                    exportHeaders = false;
                    return false;
                }
            });

            exporter.beginHeader(exportHeaders);
            for (var cellContent in dataFields) {
                var style = getHeaderStyle(cellContent, dataFields[cellContent]);
                exporter.appendHeaderCell(dataFields[cellContent], cellContent, style, exportHeaders);
            }
            exporter.endHeader(exportHeaders);
        }

        function exportContent(exporter) {
            exporter.beginBody();
            for (var i = 0; i < data.length; i += 1) {
                if (data[i] !== undefined) {
                    exportRow(exporter, data[i], i);
                }
            }
            exporter.endBody();
        }

        function exportRow(exporter, data, rowId) {
            var style;
            exporter.beginRow();
            for (var column in dataFields) {
                style = getRowCellStyle(rowId, column);
                if (data.hasOwnProperty(column)) {
                    exporter.appendBodyCell(data[column], dataFields[column], style);
                }
                else {
                    exporter.appendBodyCell("", dataFields[column], style);
                }
            }
            exporter.endRow();
        }

        function getHeaderStyle(columnName, dataField) {
            if (dataField.style) {
                return styles[dataField.style];
            }

            var rowStyles = getStylesArray();
            if (rowStyles.length > 0) {
                return rowStyles[0].style;
            }
            return null;
        }

        function getStylesArray() {
            if (!stylesArray) {
                stylesArray = new Array();
                $.each(styles, function (index, value) {
                    stylesArray[stylesArray.length] = { name: index, style: value };
                });
            }

            return stylesArray;
        }

        function getRowCellStyle(rowId, column) {
            var dataField = dataFields[column];
            if (dataField) {
                if (dataField.customCellStyles) {
                    var customStyle = dataField.customCellStyles[rowId];
                    if (customStyle) {
                        return styles[customStyle];
                    }
                }

                if (dataField.cellStyle) {
                    if (dataField.cellAltStyle) {
                        var styleId = rowId % 2;
                        if (styleId == 0)
                            return styles[dataField.cellStyle];
                        return styles[dataField.cellAltStyle];
                    }
                    return styles[dataField.cellStyle];
                }
                else {
                    var rowStyles = getStylesArray();
                    if (rowStyles.length > 0) {
                        var styleId = rowId % (rowStyles.length - 1);
                        var style = rowStyles[styleId + 1].style;
                        return style;
                    }
                }
            }
            return null;
        }

        function createHiddenInput(value, name, form) {
            var input = document.createElement('input');
            input.name = name;
            input.value = value;
            input.type = 'hidden';
            form.appendChild(input);
            return input;
        }

        function createHiddenTextArea(value, name, form) {
            var textArea = document.createElement('textarea');
            textArea.name = name;
            textArea.value = value;
            //      textArea.type = 'hidden';
            form.appendChild(textArea);
            return textArea;
        }

        function createForm(filename, format, content, exportServer, charset) {
            var form = document.createElement('form');
            createHiddenInput(filename, 'filename', form);
            createHiddenInput(format, 'format', form);
            createHiddenTextArea(content, 'content', form);
            if (exportServer == undefined || exportServer == '') {
                if (window && window.location.toString().indexOf('jqwidgets.com') >= 0) {
                    exportServer = 'http://jqwidgets.com/export_server/save-file.php';
                }
                else {
                    exportServer = 'http://jquerygrid.net/export_server/save-file.php';
                }
            }

            form.action = exportServer;
            form.method = 'post';
            if (charset) {
                form.acceptCharset = charset;
            }

            document.body.appendChild(form);
            return form;
        }

        exporter = function (inputData, inputDataFields, inputStyles, exportServer) {
            if (!(this instanceof ArrayExporter)) {
                return new ArrayExporter(inputData, inputDataFields, inputStyles);
            }
            data = inputData;
            dataFields = inputDataFields;
            styles = inputStyles;

            this.exportTo = function (format) {
                format = format.toString().toLowerCase();
                var module = exportModules[format];
                if (typeof module === 'undefined') {
                    throw 'You can\'t export to ' + format + ' format.';
                }
                return exportData(module, data, dataFields, styles);
            };

            this.exportToFile = function (format, filename, exportServer, charset) {
                var content = this.exportTo(format),
                    form = createForm(filename, format, content, exportServer, charset);
                form.submit();
                document.body.removeChild(form);
            };

            this.exportToLocalFile = function (format, filename) {
                var content = this.exportTo(format);
                document.location.href = 'data:application/octet-stream;filename=' + filename + ',' + encodeURIComponent(content);
            };

        };

        exporter.extend = function (exportFormat, exporter) {
            if (exporter instanceof $.jqx.dataAdapter.DataExportModuleBase) {
                exportModules[exportFormat] = exporter;
            } else {
                throw 'The module ' + exportFormat + ' is not instance of DataExportModuleBase.';
            }
        };

        return exporter;

    }());

    $.jqx.dataAdapter.ArrayExporter = ArrayExporter;

})(jQuery);


(function ($) {

    //Defines common interface for all modules used for exportation
    var DataExportModuleBase = function () {

        this.formatData = function (data, type, formatString, localization) {
            if (type === 'date') {
                var tmpdate = "";
                if (typeof data === 'string') {
                    tmpdate = $.jqx.dataFormat.tryparsedate(data);
                    data = tmpdate;
                }
                if (data === "" || data === null) return "";
                tmpdate = $.jqx.dataFormat.formatdate(data, formatString, localization);
                if (tmpdate.toString() == "NaN" || tmpdate == null) return "";
                data = tmpdate;
            } else if (type === 'number' || type === 'float' || type === 'int' || type == 'integer') {
                if (data === "" || data === null) return "";

                if (!isNaN(new Number(data))) {
                    var tmpdata = $.jqx.dataFormat.formatnumber(data, formatString, localization);
                    if (tmpdata.toString() == "NaN") return "";
                    else data = tmpdata;
                }
            } else {
                data = data;
            }
            if (data === null) return "";
            return data;
        };

        this.getFormat = function (dataOptions) {
            var formatString = dataOptions ? dataOptions['formatString'] : "";
            var localization = dataOptions ? dataOptions['localization'] : "";
            var dataType = 'string';
            dataType = dataOptions ? dataOptions['type'] : 'string';

            if (dataType == 'number' || dataType == 'float') {
                if (!formatString) formatString = 'n2';
            }
            if (dataType == 'int' || dataType == 'integer') {
                if (!formatString) formatString = 'n0';
            }
            if (dataType == 'date') {
                if (!formatString) formatString = 'd';
            }
            return { type: dataType, formatString: formatString, localization: localization };
        };

        this.beginFile = function () {
            throw 'Not implemented!';
        };

        this.beginHeader = function () {
            throw 'Not implemented!';
        };

        this.appendHeaderCell = function () {
            throw 'Not implemented!';
        };

        this.endHeader = function () {
            throw 'Not implemented!';
        };

        this.beginBody = function () {
            throw 'Not implemented!';
        };

        this.beginRow = function () {
            throw 'Not implemented!';
        };

        this.appendBodyCell = function () {
            throw 'Not implemented!';
        };

        this.endRow = function () {
            throw 'Not implemented!';
        };

        this.endBody = function () {
            throw 'Not implemented!';
        };

        this.endFile = function () {
            throw 'Not implemented!';
        };

        this.getFile = function () {
            throw 'Not implemented!';
        };
    }

    $.jqx.dataAdapter.DataExportModuleBase = DataExportModuleBase;

})(jQuery);

//Extending the exporter with TSV and CSV exporters
(function ($) {

    //Value exporter. This object is common prototype for TSV and CVS.
    var SvExporter = function (inValueSeparator) {

        var file, valueSeparator, hasHeader;
        var rowIndex = 0;
        var me = this;

        this.beginFile = function () {
            file = '';
        };

        this.beginHeader = function () {
        };

        this.appendHeaderCell = function (data, fieldName, style, exportHeader) {
            hasHeader = exportHeader;
            if (exportHeader) {
                appendCell(data.text);
            }
        };

        this.endHeader = function () {
            this.endRow();
        };

        this.beginBody = function () {
            rowIndex = 0;
        };

        this.beginRow = function () {
            if ((rowIndex > 0) || (rowIndex == 0 && hasHeader)) {
                file += '\n';
            }
            rowIndex++;
        };

        this.appendBodyCell = function (data, dataType) {
            appendCell(data, dataType);
        };

        this.endRow = function () {
            file = file.substring(0, file.length - 1);
        };

        this.endBody = function () {
        };

        this.endFile = function () {
        };

        this.getFile = function () {
            return file;
        };

        function prepareData(data, dataOptions) {
            if (dataOptions) {
                var format = me.getFormat(dataOptions);
                data = me.formatData(data, format.type, format.formatString, format.localization);
            }
            data = '"' + data + '"';
            return data;
        };

        function appendCell(data, dataOptions) {
            data = prepareData(data, dataOptions);
            file += data + inValueSeparator;
        };

    };

    SvExporter.prototype = new $.jqx.dataAdapter.DataExportModuleBase();

    var CsvExporter = function () { };
    CsvExporter.prototype = new SvExporter(',');

    var TsvExporter = function () { };
    TsvExporter.prototype = new SvExporter('\t');

    $.jqx.dataAdapter.ArrayExporter.extend('csv', new CsvExporter());
    $.jqx.dataAdapter.ArrayExporter.extend('tsv', new TsvExporter());

})(jQuery);

//Extending the exporter with HTML exporter
(function ($) {

    var HtmlExporter = function () {
        var isPDF = false;
        var file;
        var hasHeader;
        var rowIndex = 0;

        this.setPDF = function () {
            isPDF = true;
        };

        this.beginFile = function () {
            if (isPDF) {
                file = '<table style="empty-cells: show;" cellspacing="0" cellpadding="2">';
            }
            else {
                file = '<html>\n\t<head>\n\t\t<title></title>\n' +
					   '\t\t<meta http-equiv=Content-type content=\"text/html; charset=UTF-8\">\n\t</head>\n\t<body>\n' +
					   '\t\t<table style="empty-cells: show;" cellspacing="0" cellpadding="2">';
            }
        };

        this.beginHeader = function () {
            if (isPDF) {
                file += '\n\t<thead><tr>';
            }
            else {
                file += '\n\t\t\t<thead>';
            }
        };

        this.appendHeaderCell = function (data, fieldName, style, exportHeader) {
            hasHeader = exportHeader;
            if (!exportHeader) return;

            if (isPDF) {
                file += '\n\t\t\t\t<th style="' + buildStyle(style) + '">' + data.text + '</th>';
            }
            else {
                if (data.width) {
                    file += '\n\t\t\t\t<th style="width: ' + data.width + 'px; ' + buildStyle(style) + '">' + data.text + '</th>';
                }
                else {
                    file += '\n\t\t\t\t<th style="' + buildStyle(style) + '">' + data.text + '</th>';
                }
            }
        };

        this.endHeader = function () {
            if (isPDF) {
                file += '\n\t</tr></thead>';
            }
            else {
                file += '\n\t\t\t</thead>';
            }
        };

        this.beginBody = function () {
            if (isPDF) {
                file += '\n\t<tbody>';
            }
            else {
                file += '\n\t\t\t<tbody>';
            }
            rowIndex = 0;
        };

        this.beginRow = function () {
            if (isPDF) {
                file += '\n\t<tr>';
            }
            else {
                file += '\n\t\t\t\t<tr>';
            }
            rowIndex++;
        };

        this.appendBodyCell = function (data, dataOptions, style) {
            var format = this.getFormat(dataOptions);
            if (data === "") data = "&nbsp;";
            if (isPDF) {
                if (rowIndex == 1 && !hasHeader) {
                    file += '\n\t\t\t\t\t<td style="' + buildStyle(style) + ' border-top-width: 1px;">' + this.formatData(data, format.type, format.formatString, format.localization) + '</td>';
                }
                else {
                    file += '\n\t\t\t\t\t<td style="' + buildStyle(style) + '">' + this.formatData(data, format.type, format.formatString, format.localization) + '</td>';
                }    
            }
            else {
                if (rowIndex == 1 && !hasHeader) {
                    file += '\n\t\t\t\t\t<td style="' + buildStyle(style) + ' border-top-width: 1px;">' + this.formatData(data, format.type, format.formatString, format.localization) + '</td>';
                }
                else {
                    file += '\n\t\t\t\t\t<td style="' + buildStyle(style) + '">' + this.formatData(data, format.type, format.formatString, format.localization) + '</td>';
                }
            }
        };

        this.endRow = function () {
            if (isPDF) {
                file += '\n\t</tr>';
            }
            else {
                file += '\n\t\t\t\t</tr>';
            }
        };

        this.endBody = function () {
            if (isPDF) {
                file += '\n\t</tbody>';
            }
            else {
                file += '\n\t\t\t</tbody>';
            }
        };

        this.endFile = function () {
            if (isPDF) {
                file += '\n</table>';
            }
            else {
                file += '\n\t\t</table>\n\t</body>\n</html>\n';
            }
        };

        this.getFile = function () {
            return file;
        };

        function buildStyle(styles) {
            var result = '';
            for (var style in styles) {
                if (styles.hasOwnProperty(style)) {
                    if (isPDF && style == 'font-size') {
                        styles[style] = '100%';
                    }
                    result += style + ':' + styles[style] + ';';
                }
            }
            return result;
        }
    }

    HtmlExporter.prototype = new $.jqx.dataAdapter.DataExportModuleBase();

    var TableExporter = function () { };
    TableExporter.prototype = new HtmlExporter();

    var PDFExporter = function () { };
    PDFExporter.prototype = new HtmlExporter();
    var exporter = new PDFExporter();
    exporter.setPDF();

    $.jqx.dataAdapter.ArrayExporter.extend('html', new TableExporter());
    $.jqx.dataAdapter.ArrayExporter.extend('pdf', exporter);

})(jQuery);

//Exporting to XLS format (MS Office Excel 2003)
(function ($) {

    var ExcelExporter = function () {

        var header, content, headerFields, headerStyles, existingStyles, styleCounter,
            styleBuilder = {

                style: '',

                stylesMap: {
                    'font': {
                        'color': 'Color',
                        'font-family': 'FontName',
                        'font-style': 'Italic',
                        'font-weight': 'Bold'
                    },
                    'interior': {
                        'background-color': 'Color',
                        'background': 'Color'
                    },
                    'alignment': {
                        'left': 'Left',
                        'center': 'Center',
                        'right': 'Right'
                    }
                },

                startStyle: function (styleName) {
                    this.style += '\n\t\t<Style ss:ID="' + styleName + '" ss:Name="' + styleName + '">';
                },

                buildAlignment: function (styles) {
                    if (styles['text-align']) {
                        var alignment = this.stylesMap['alignment'][styles['text-align']];
                        if (!alignment) {
                            alignment = "Left";
                        }
                        var style = '\n\t\t\t<Alignment ss:Vertical="Bottom" ss:Horizontal="' + alignment + '"/>';
                        this.style += style;
                    }
                },

                buildBorder: function (styles) {
                    if (styles['border-color']) {
                        var border = '\n\t\t\t<Borders>';
                        var bottomBorder = '\n\t\t\t\t<Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="' + styles['border-color'] + '"/>';
                        var leftBorder = '\n\t\t\t\t<Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="' + styles['border-color'] + '"/>';
                        var rightBorder = '\n\t\t\t\t<Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="' + styles['border-color'] + '"/>';
                        var topBorder = '\n\t\t\t\t<Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1" ss:Color="' + styles['border-color'] + '"/>';

                        border += bottomBorder;
                        border += leftBorder;
                        border += rightBorder;
                        border += topBorder;
                        border += '\n\t\t\t</Borders>';
                        this.style += border;
                    }
                },

                buildFont: function (styles) {
                    var map = this.stylesMap['font'],
                        font = '\n\t\t\t<Font ';
                    for (var prop in map) {
                        if (typeof styles[prop] !== 'undefined') {
                            if (prop === 'font-style' && styles[prop].toString().toLowerCase() === 'italic') {
                                font += 'ss:Italic="1" ';
                            } else if (prop === 'font-weight' && styles[prop].toString().toLowerCase() === 'bold') {
                                font += 'ss:Bold="1" ';
                            } else if (prop === 'color') {
                                font += 'ss:' + map[prop] + '="' + styles[prop] + '" ';
                            }
                        }
                    }
                    font += '/>';
                    this.style += font;
                },

                buildInterior: function (styles) {
                    var map = this.stylesMap['interior'],
                        interior = '\n\t\t\t<Interior ';
                    var hasInterior = false;
                    for (var prop in map) {
                        if (typeof styles[prop] !== 'undefined') {
                            interior += 'ss:' + map[prop] + '="' + styles[prop] + '" ';
                            hasInterior = true;
                        }
                    }
                    if (hasInterior)
                        interior += 'ss:Pattern="Solid"';

                    interior += '/>';
                    this.style += interior;
                },

                buildFormat: function (styles) {
                    if (styles['dataType'] == 'number' || styles['dataType'] == 'float' || styles['dataType'] == 'int' || styles['dataType'] == 'integer') {
                        var formatString = styles['formatString'];
                        if (formatString == "" || formatString.indexOf('n') != -1 || formatString.indexOf('N') != -1) {
                            this.style += '\n\t\t\t<NumberFormat ss:Format="0"/>';
                        }
                        else if (formatString == "f" || formatString == "F" || formatString == "D" || formatString.indexOf('d') != -1) {
                            this.style += '\n\t\t\t<NumberFormat ss:Format="#,##0.00_);[Red]\(#,##0.00\)"/>';
                        }
                        else if (formatString.indexOf('p') != -1 || formatString.indexOf('P') != -1) {
                            this.style += '\n\t\t\t<NumberFormat ss:Format="Percent"/>';
                        }
                        else if (formatString.indexOf('c') != -1 || formatString.indexOf('C') != -1) {
                            if (parseInt(styles['currencysymbol'].charCodeAt(0)) == 8364)
                            {
                                 this.style += '\n\t\t\t<NumberFormat ss:Format="Euro Currency"/>';
                            }
                            else
                            {
                                this.style += '\n\t\t\t<NumberFormat ss:Format="Currency"/>';
                            }
                        }
                    }
                    else if (styles['dataType'] == 'date') {
                        this.style += '\n\t\t\t<NumberFormat ss:Format="Short Date"/>';
                    }
                },

                closeStyle: function () {
                    this.style += '\n\t\t</Style>';
                },

                toString: function () {
                    var temp = this.style;
                    this.style = '';
                    return temp;
                }
            };

        this.beginFile = function () {
            existingStyles = {};
            styleCounter = 0;
            header = '<?xml version="1.0"?>' +
                            '\n\t<?mso-application progid="Excel.Sheet"?> ' +
                            '\n\t<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" ' +
                            '\n\txmlns:o="urn:schemas-microsoft-com:office:office" ' +
                            '\n\txmlns:x="urn:schemas-microsoft-com:office:excel" ' +
                            '\n\txmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" ' +
                            '\n\txmlns:html="http://www.w3.org/TR/REC-html40"> ' +
                            '\n\t<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office"> ' +
                            '\n\t<Version>12.00</Version> ' +
                            '\n\t</DocumentProperties> ' +
                            '\n\t<ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel"> ' +
                            '\n\t<WindowHeight>8130</WindowHeight> ' +
                            '\n\t<WindowWidth>15135</WindowWidth> ' +
                            '\n\t<WindowTopX>120</WindowTopX> ' +
                            '\n\t<WindowTopY>45</WindowTopY> ' +
                            '\n\t<ProtectStructure>False</ProtectStructure> ' +
                            '\n\t<ProtectWindows>False</ProtectWindows> ' +
                            '\n\t</ExcelWorkbook> ' +
                        '\n\t<Styles>';
        };

        this.beginHeader = function () {
            content = '\n\t<Worksheet ss:Name="Sheet1">\n\t\t<Table>';
            headerFields = [];
            headerStyles = [];
        };

        this.appendHeaderCell = function (data, fieldName, style) {
            var width = data.width != undefined ? data.width : data.text.length * 10;
            content += '\n\t\t\t<Column ss:Width="' + width + '"/>';
            headerFields.push(data);
            headerStyles.push(style);
        };

        this.endHeader = function (exportHeader) {
            if (exportHeader) {
                this.beginRow();
                for (var i = 0; i < headerFields.length; i += 1) {
                    appendCell.call(this, headerFields[i]['text'], null, headerStyles[i]);
                }
                this.endRow();
            }
        };

        this.beginBody = function () {
        };

        this.beginRow = function () {
            content += '\n\t\t\t<Row>';
        };

        this.appendBodyCell = function (data, dataType, style) {
            appendCell.call(this, data, dataType, style);
        };

        this.endRow = function () {
            content += '\n\t\t\t</Row>';
        };

        this.endBody = function () {
            content += '\n\t\t</Table>';
        };

        this.endFile = function () {
            content += '\n\t</Worksheet>\n</Workbook>';
            header += '\n\t</Styles>';
        };

        this.getFile = function () {
            return header + content;
        };

        function appendCell(data, dataOptions, style) {
            var columnType = "String";

            var format = this.getFormat(dataOptions);
            
            if (data != null && data.toString().substring(0, 2) == "AG") {
                data = data.toString().substring(2);
                columnType = "String";
            }
            else {
                if (format.type == 'date') {
                    data = this.formatData(data, format.type, format.formatString, format.localization);
                    if (data === null || data === "") {
                        data = "";
                        columnType = "String";
                    }
                }
                if (format.type == 'string') {
                    if (data === null || data === undefined) {
                        data = "";
                    }
                    else {
                        if (data.toString().indexOf('&') >= 0) {
                            data = data.toString().replace(/&/g, '&amp;');
                        }
                        if (data.toString().indexOf('>') >= 0) {
                            data = data.toString().replace(/>/g, '&gt;');
                        }
                        if (data.toString().indexOf('<') >= 0) {
                            data = data.toString().replace(/</g, '&lt;');
                        }
                        if (data.toString().indexOf('"') >= 0) {
                            data = data.toString().replace(/"/g, '&quot;');
                        }
                        if (data.toString().indexOf("'") >= 0) {
                            data = data.toString().replace(/'/g, '&apos;');
                        }
                    }
                }

                if (style.dataType == 'number' || style.dataType == 'float' || style.dataType == 'int' || style.dataType == 'integer') {
                    columnType = "Number";
                    data = parseFloat(data);
                    if (data === null || isNaN(data) || data === "") {
                        data = "";
                        columnType = "String";
                    }
                    if (data && columnType != "String" && data != "") {
                        if (dataOptions && dataOptions.formatString && dataOptions.formatString.indexOf('p') >= 0) {
                            data = data / 100;
                        }
                    }

                    style.currencysymbol = dataOptions.localization.currencysymbol;
                }
            }

            var styleId = getStyleId(style);
            content += '\n\t\t\t\t<Cell ss:StyleID="' + styleId + '"><Data ss:Type="' + columnType + '">' + data + '</Data></Cell>';
        }

        function generateStyleId() {
            styleCounter += 1;
            return 'xls-style-' + styleCounter;
        }

        function findStyle(style) {
            for (var s in existingStyles) {
                if (isSubset(style, existingStyles[s]) && isSubset(existingStyles[s], style)) {
                    return s;
                }
            }
            return undefined;
        }

        function isSubset(first, second) {
            var subset = true;
            for (var p in first) {
                if (first[p] !== second[p]) {
                    subset = false;
                }
            }
            return subset;
        }

        function appendStyle(id, style) {
            styleBuilder.startStyle(id);
            styleBuilder.buildAlignment(style);
            styleBuilder.buildBorder(style);
            styleBuilder.buildFont(style);
            styleBuilder.buildInterior(style);
            styleBuilder.buildFormat(style);
            styleBuilder.closeStyle();
            header += styleBuilder.toString();
        }

        function getStyleId(style) {
            if (!style) {
                return '';
            }
            var id = findStyle(style);
            if (typeof id === 'undefined') {
                id = generateStyleId();
                existingStyles[id] = style;
                appendStyle(id, style);
            }
            return id;
        }
    }

    ExcelExporter.prototype = new $.jqx.dataAdapter.DataExportModuleBase();
    $.jqx.dataAdapter.ArrayExporter.extend('xls', new ExcelExporter());
})(jQuery);

//Exporting to XML
(function ($) {

    var XmlExporter = function () {

        var file, headerFields, index;

        this.beginFile = function () {
            file = '<?xml version="1.0" encoding="UTF-8" ?>';
            file += '\n<table>';
        }

        this.beginHeader = function () {
            headerFields = [];
        }

        this.appendHeaderCell = function (data, fieldName) {
            headerFields.push(fieldName);
        }

        this.endHeader = function () {
        }

        this.beginBody = function (data, dataType) {
        }

        this.beginRow = function () {
            file += '\n\t<row>';
            index = 0;
        }

        this.appendBodyCell = function (data, dataOptions) {
            var format = this.getFormat(dataOptions);
            data = this.formatData(data, format.type, format.formatString, format.localization);
            if (format.type == "string") {
                if (data.toString().indexOf('&') >= 0) {
                    data = data.toString().replace(/&/g, '&amp;');
                }
                if (data.toString().indexOf('>') >= 0) {
                    data = data.toString().replace(/>/g, '&gt;');
                }
                if (data.toString().indexOf('<') >= 0) {
                    data = data.toString().replace(/</g, '&lt;');
                }
                if (data.toString().indexOf('"') >= 0) {
                    data = data.toString().replace(/"/g, '&quot;');
                }
                if (data.toString().indexOf("'") >= 0) {
                    data = data.toString().replace(/'/g, '&apos;');
                }
            }
            file += '\n\t\t<' + headerFields[index] + '>' + data + '</' + headerFields[index] + '>';
            index++;
        }

        this.endRow = function () {
            file += '\n\t</row>';
            index = 0;
        }

        this.endBody = function () {
        }

        this.endFile = function () {
            file += '\n</table>';
        }

        this.getFile = function () {
            return file;
        }
    }

    XmlExporter.prototype = new $.jqx.dataAdapter.DataExportModuleBase();
    $.jqx.dataAdapter.ArrayExporter.extend('xml', new XmlExporter());
})(jQuery);


//Exporting to JSON
(function ($) {

    var escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
        meta = {
            '\b': '\\b',
            '\t': '\\t',
            '\n': '\\n',
            '\f': '\\f',
            '\r': '\\r',
            '"': '\\"',
            '\\': '\\\\'
        };

    function quote(string) {
        return '"' + string.replace(escapable, function (a) {
            var c = meta[a];
            return typeof c === 'string' ? c : '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
        }) + '"';
    }

    function formatNumber(n) {
        return n < 10 ? '0' + n : n;
    }

    function stringifyDate(value) {
        var date;
        if (isFinite(value.valueOf())) {
            date = value.getUTCFullYear() + '-' + formatNumber(value.getUTCMonth() + 1) + '-' +
            formatNumber(value.getUTCDate()) + 'T' + formatNumber(value.getUTCHours()) + ':' +
            formatNumber(value.getUTCMinutes()) + ':' + formatNumber(value.getUTCSeconds()) + 'Z"';
        } else {
            date = 'null';
        }
        return date;
    }

    function stringifyArray(value) {
        var len = value.length,
            partial = [],
            i;
        for (i = 0; i < len; i++) {
            partial.push(str(i, value) || 'null');
        }

        return '[' + partial.join(',') + ']';
    }

    function stringifyObject(value) {
        var partial = [],
            i, v;
        for (i in value) {
            if (Object.prototype.hasOwnProperty.call(value, i)) {
                v = str(i, value);
                if (v) {
                    partial.push(quote(i) + ':' + v);
                }
            }
        }
        return '{' + partial.join(',') + '}';
    }

    function stringifyReference(value) {
        switch (Object.prototype.toString.call(value)) {
            case '[object Date]':
                return stringifyDate(value);
            case '[object Array]':
                return stringifyArray(value);
        }
        return stringifyObject(value);
    }

    function stringifyPrimitive(value, type) {
        switch (type) {
            case 'string':
                return quote(value);
            case 'number':
            case 'float':
            case 'integer':
            case 'int':
                return isFinite(value) ? value : 'null';
            case 'boolean':
                return value;
        }
        return 'null';
    }

    function str(key, holder) {
        var value = holder[key], type = typeof value;

        if (value && typeof value === 'object' && typeof value.toJSON === 'function') {
            value = value.toJSON(key);
            type = typeof value;
        }
        if (/(number|float|int|integer|string|boolean)/.test(type) || (!value && type === 'object')) {
            return stringifyPrimitive(value, type);
        } else {
            return stringifyReference(value);
        }
    }

    function stringify(value) {
        if (window.JSON && typeof window.JSON.stringify === 'function') {
            return window.JSON.stringify(value);
        }

        return str("", { "": value });
    }

    var JsonExporter = function () {
        var me = this;
        this.prepareData = function(data, dataOptions) {
            if (dataOptions) {
                var format = me.getFormat(dataOptions);
                data = me.formatData(data, format.type, format.formatString, format.localization);
            }
            return data;
        }

        var file,
            content,
            currentCell;

        this.beginFile = function () {
            content = [];
        }

        this.beginHeader = function () {
        }

        this.appendHeaderCell = function (data) {
        }

        this.endHeader = function () {
        }

        this.beginBody = function (data, dataType) {
        }

        this.beginRow = function () {
            currentCell = {};
        }

        this.appendBodyCell = function (data, dataType) {
            var text = this.prepareData(data, dataType);
            currentCell[dataType['text']] = text;
        }

        this.endRow = function () {
            content.push(currentCell);
        }

        this.endBody = function () {
        }

        this.endFile = function () {
            file = stringify(content);
        }

        this.getFile = function () {
            return file;
        }
    }

    JsonExporter.prototype = new $.jqx.dataAdapter.DataExportModuleBase();
    $.jqx.dataAdapter.ArrayExporter.extend('json', new JsonExporter());

})(jQuery);

(function ($) {
    $.extend($.jqx._jqxGrid.prototype, {
        exportdata: function (datatype, filename, exportHeader, rows, exportHiddenColumns, exportServer, charset) {
            if (!$.jqx.dataAdapter.ArrayExporter) {
                throw 'jqxGrid: Missing reference to jqxdata.export.js!';
            }

            if (exportHeader == undefined) {
                exportHeader = true;
            }

            var me = this;

            if (rows == undefined) {
                var rows = this.getrows();
                if (rows.length == 0) {
                    throw 'No data to export.';
                }
            }

            this.exporting = true;
            if (this.altrows) {
                this._renderrows(this.virtualsizeinfo);
            }

            var addhiddencolumns = exportHiddenColumns != undefined ? exportHiddenColumns : false;
            var dataFields = {};
            var styles = {};
            var alignments = [];
            var $cell = this.host.find('.jqx-grid-cell:first');
            var $cellalt = this.host.find('.jqx-grid-cell-alt:first');
            $cell.removeClass(this.toThemeProperty('jqx-grid-cell-selected'));
            $cell.removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
            $cellalt.removeClass(this.toThemeProperty('jqx-grid-cell-selected'));
            $cellalt.removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
            $cell.removeClass(this.toThemeProperty('jqx-grid-cell-hover'));
            $cell.removeClass(this.toThemeProperty('jqx-fill-state-hover'));
            $cellalt.removeClass(this.toThemeProperty('jqx-grid-cell-hover'));
            $cellalt.removeClass(this.toThemeProperty('jqx-fill-state-hover'));

            var styleName = 'cell';
            var styleIndex = 1;
            var columnStyleName = 'column';
            var columnStyleIndex = 1;
            var aggregates = [];

            for (var j = 0; j < this.columns.records.length; j++) {
                var column = this.columns.records[j];
                if (column.cellclassname != "") {
                    column.customCellStyles = new Array();
                    if (typeof column.cellclassname == "string") {
                        column.customCellStyles.push(column.cellclassname);
                    }
                    else {
                        for (var i = 0; i < rows.length; i++) {
                            var boundIndex = this.getrowboundindex(i);
                            var className = column.cellclassname(boundIndex, column.displayfield, rows[i][column.displayfield]);
                            if (className) {
                                column.customCellStyles[i] = className;
                            }
                        }
                    }
                }
            }

            $.each(this.columns.records, function (index) {
                var $cell = $(me.table[0].rows[0].cells[index]);
                if (me.table[0].rows.length > 1) {
                    var $cellalt = $(me.table[0].rows[1].cells[index]);
                }
                var column = this;
                var removeClassFunc = function (cell) {
                    cell.removeClass(me.toThemeProperty('jqx-grid-cell-selected'));
                    cell.removeClass(me.toThemeProperty('jqx-fill-state-pressed'));
                    cell.removeClass(me.toThemeProperty('jqx-grid-cell-hover'));
                    cell.removeClass(me.toThemeProperty('jqx-fill-state-hover'));
                    if (column.customCellStyles) {
                        for (var o in column.customCellStyles) {
                            cell.removeClass(column.customCellStyles[o]);
                        }
                    }
                }
                removeClassFunc($cell);
                if ($cellalt) {
                    removeClassFunc($cellalt);
                }

                if (this.displayfield == null) return true;

                if (me.showaggregates) {
                    if (me.getcolumnaggregateddata) {
                        aggregates.push(me.getcolumnaggregateddata(this.displayfield, this.aggregates, true, rows));
                    }
                }

                var type = me._getexportcolumntype(this);
                if (this.exportable && (!this.hidden || addhiddencolumns)) {
                    dataFields[this.displayfield] = {};
                    dataFields[this.displayfield].text = this.text;
                    dataFields[this.displayfield].width = parseInt(this.width);
                    if (isNaN(dataFields[this.displayfield].width)) dataFields[this.displayfield].width = 60;
                    dataFields[this.displayfield].formatString = this.cellsformat;
                    dataFields[this.displayfield].localization = me.gridlocalization;
                    dataFields[this.displayfield].type = type;
                    dataFields[this.displayfield].cellsAlign = this.cellsalign;
                    dataFields[this.displayfield].hidden = !exportHeader;
                }

                styleName = 'cell' + styleIndex;

                var $element = $(this.element);
                if (this.element == undefined) $element = $(this.uielement);

                columnStyleName = 'column' + columnStyleIndex;
                if (datatype == 'html' || datatype == 'xls' || datatype == 'pdf') {
                    var buildStyle = function (styleName, $element, isColumn, altStyle, meColumn, me, index, customStyle, rowIndex) {
                        styles[styleName] = {};
                        styles[styleName]['font-size'] = $element.css('font-size');
                        styles[styleName]['font-weight'] = $element.css('font-weight');
                        styles[styleName]['font-style'] = $element.css('font-style');
                        styles[styleName]['background-color'] = me._getexportcolor($element.css('background-color'));
                        styles[styleName]['color'] = me._getexportcolor($element.css('color'));
                        styles[styleName]['border-color'] = me._getexportcolor($element.css('border-top-color'));
                        if (isColumn) {
                            styles[styleName]['text-align'] = meColumn.align;
                        }
                        else {
                            styles[styleName]['text-align'] = meColumn.cellsalign;
                            styles[styleName]['formatString'] = meColumn.cellsformat;
                            styles[styleName]['dataType'] = type;
                        }

                        if (datatype == 'html' || datatype == 'pdf') {
                            styles[styleName]['border-top-width'] = $element.css('border-top-width');
                            styles[styleName]['border-left-width'] = $element.css('border-left-width');
                            styles[styleName]['border-right-width'] = $element.css('border-right-width');
                            styles[styleName]['border-bottom-width'] = $element.css('border-bottom-width');
                            styles[styleName]['border-top-style'] = $element.css('border-top-style');
                            styles[styleName]['border-left-style'] = $element.css('border-left-style');
                            styles[styleName]['border-right-style'] = $element.css('border-right-style');
                            styles[styleName]['border-bottom-style'] = $element.css('border-bottom-style');
                            if (isColumn) {
                                if (index == 0) {
                                    styles[styleName]['border-left-width'] = $element.css('border-right-width');
                                }
                                styles[styleName]['border-top-width'] = $element.css('border-right-width');
                                styles[styleName]['border-bottom-width'] = $element.css('border-bottom-width');
                            }
                            else {
                                if (index == 0) {
                                    styles[styleName]['border-left-width'] = $element.css('border-right-width');
                                }
                            }
                            styles[styleName]['height'] = $element.css('height');
                        }

                        if (meColumn.exportable && (!meColumn.hidden || addhiddencolumns)) {
                            if (customStyle == true) {
                                if (!dataFields[meColumn.displayfield].customCellStyles) {
                                    dataFields[meColumn.displayfield].customCellStyles = new Array();
                                }

                                dataFields[meColumn.displayfield].customCellStyles[rowIndex] = styleName;
                            }
                            else {
                                if (isColumn) {
                                    dataFields[meColumn.displayfield].style = styleName;
                                }
                                else if (!altStyle) {
                                    dataFields[meColumn.displayfield].cellStyle = styleName;
                                }
                                else dataFields[meColumn.displayfield].cellAltStyle = styleName;
                            }
                        }
                    }
                    buildStyle(columnStyleName, $element, true, false, this, me, index);
                    columnStyleIndex++;
                    buildStyle(styleName, $cell, false, false, this, me, index);
                    if (me.altrows) {
                        styleName = 'cellalt' + styleIndex;
                        buildStyle(styleName, $cellalt, false, true, this, me, index);
                    }
                    if (this.customCellStyles) {
                        for (var o in column.customCellStyles) {
                            $cell.removeClass(column.customCellStyles[o]);
                        }
                        for (var o in column.customCellStyles) {
                            $cell.addClass(column.customCellStyles[o]);
                            buildStyle(styleName + column.customCellStyles[o], $cell, false, false, this, me, index, true, o);
                            $cell.removeClass(column.customCellStyles[o]);
                        }
                    }

                    styleIndex++;
                }
            });

            if (this.showaggregates) {
                var aggregatedrows = [];
                var prefix = datatype == 'xls' ? "AG" : "";
                var offset = this.groupable ? this.groups.length : 0;
                if (this.rowdetails) offset++;

                if (aggregates.length > 0) {
                    $.each(this.columns.records, function (index) {
                        if (this.aggregates) {
                            for (var i = 0; i < this.aggregates.length; i++) {
                                if (!aggregatedrows[i]) aggregatedrows[i] = {};
                                if (aggregatedrows[i]) {
                                    var aggregatename = me._getaggregatename(this.aggregates[i]);
                                    var aggregatetype = me._getaggregatetype(this.aggregates[i]);
                                    var aggregate = aggregates[index-offset];
                                    if (aggregate) {
                                        aggregatedrows[i][this.displayfield] = prefix + aggregatename + ": " + aggregate[aggregatetype];
                                    }
                                }
                            }
                        }
                    });
                    $.each(this.columns.records, function (index) {
                        for (var i = 0; i < aggregatedrows.length; i++) {
                            if (aggregatedrows[i][this.displayfield] == undefined) {
                                aggregatedrows[i][this.displayfield] = prefix;
                            }
                        }
                    });
                }
                $.each(aggregatedrows, function () {
                    rows.push(this);
                });
            }

            var that = this;
            var exporter = $.jqx.dataAdapter.ArrayExporter(rows, dataFields, styles);
            if (filename == undefined) {
                // update ui
                this._renderrows(this.virtualsizeinfo);
                var result = exporter.exportTo(datatype);
                if (this.showaggregates) {
                    $.each(aggregatedrows, function () {
                        rows.pop(this);
                    });
                }
                
                setTimeout(function () {
                    that.exporting = false;
                }, 50);
                return result;
            }
            else {
                exporter.exportToFile(datatype, filename, exportServer, charset);
            }
            // update ui
            if (this.showaggregates) {
                $.each(aggregatedrows, function () {
                    rows.pop(this);
                });
            }
            this._renderrows(this.virtualsizeinfo);
            setTimeout(function () {
                that.exporting = false;
            }, 50);
        },

        _getexportcolor: function (value) {
            var color = value;
            if (value == 'transparent') color = "#FFFFFF";
            if (!color || !color.toString()) {
                color = "#FFFFFF";
            }

            if (color.toString().indexOf('rgb') != -1) {
                var rgb = color.split(',');
                if (color.toString().indexOf('rgba') != -1) {
                    var r = parseInt(rgb[0].substring(5));
                    var g = parseInt(rgb[1]);
                    var b = parseInt(rgb[2]);
                    var a = parseInt(rgb[3].substring(1, 4));
                    var rgbObj = { r: r, g: g, b: b };
                    var hex = this._rgbToHex(rgbObj);
                    if (r == 0 && g == 0 && b == 0 && a == 0) {
                        return "#ffffff";
                    }

                    return "#" + hex;
                }

                var r = parseInt(rgb[0].substring(4));
                var g = parseInt(rgb[1]);
                var b = parseInt(rgb[2].substring(1, 4));
                var rgbObj = { r: r, g: g, b: b };
                var hex = this._rgbToHex(rgbObj);
                return "#" + hex;
            }
            else if (color.toString().indexOf('#') != -1) {
                if (color.toString().length == 4) {
                    var colorPart = color.toString().substring(1, 4);
                    color += colorPart;
                }
            }

            return color;
        },

        _rgbToHex: function (rgb) {
            return this._intToHex(rgb.r) + this._intToHex(rgb.g) + this._intToHex(rgb.b);
        },

        _intToHex: function (dec) {
            var result = (parseInt(dec).toString(16));
            if (result.length == 1)
                result = ("0" + result);
            return result.toUpperCase();
        },

        _getexportcolumntype: function (column) {
            var me = this;
            var type = 'string';
            var datafields = me.source.datafields || ((me.source._source) ? me.source._source.datafields : null);

            if (datafields) {
                var foundType = "";
                $.each(datafields, function () {
                    if (this.name == column.displayfield) {
                        if (this.type) {
                            foundType = this.type;
                        }
                        return false;
                    }
                });
                if (foundType)
                    return foundType;
            }

            if (column != null) {
                if (this.dataview.cachedrecords == undefined) {
                    return type;
                }

                var cell = null;

                if (!this.virtualmode) {
                    if (this.dataview.cachedrecords.length == 0)
                        return type;

                    cell = this.dataview.cachedrecords[0][column.displayfield];
                    if (cell != null && cell.toString() == "") {
                        return "string";
                    }
                }
                else {
                    $.each(this.dataview.cachedrecords, function () {
                        cell = this[column.displayfield];
                        return false;
                    });
                }

                if (cell != null) {
                    if (column.cellsformat.indexOf('c') != -1) {
                        return 'number';
                    }
                    if (column.cellsformat.indexOf('n') != -1) {
                        return 'number';
                    }
                    if (column.cellsformat.indexOf('p') != -1) {
                        return 'number';
                    }
                    if (column.cellsformat.indexOf('d') != -1) {
                        return 'date';
                    }
                    if (column.cellsformat.indexOf('y') != -1) {
                        return 'date';
                    }
                    if (column.cellsformat.indexOf('M') != -1) {
                        return 'date';
                    }
                    if (column.cellsformat.indexOf('m') != -1) {
                        return 'date';
                    }
                    if (column.cellsformat.indexOf('t') != -1) {
                        return 'date';
                    }

                    if (typeof cell == 'boolean') {
                        type = 'boolean';
                    }
                    else if ($.jqx.dataFormat.isNumber(cell)) {
                        type = 'number';
                    }
                    else {
                        var tmpvalue = new Date(cell);
                        if (tmpvalue.toString() == 'NaN' || tmpvalue.toString() == "Invalid Date") {
                            if ($.jqx.dataFormat) {
                                tmpvalue = $.jqx.dataFormat.tryparsedate(cell);
                                if (tmpvalue != null) {
                                    if (tmpvalue && tmpvalue.getFullYear()) {
                                        if (tmpvalue.getFullYear() == 1970 && tmpvalue.getMonth() == 0 && tmpvalue.getDate() == 1) {
                                            var num = new Number(cell);
                                            if (!isNaN(num))
                                                return 'number';

                                            return 'string';
                                        }
                                    }

                                    return 'date';
                                }
                                else {
                                    type = 'string';
                                }
                            }
                            else type = 'string';
                        }
                        else {
                            type = 'date';
                        }
                    }
                }
            }
            return type;
        }

    });
})(jQuery);


(function ($) {
    $.extend($.jqx._jqxGrid.prototype, {
        savestate: function (options) {
            var state = this.getstate();

            if (options !== undefined && !$.isEmptyObject(options)) {
                if (options.indexOf('sort') == -1) {
                    delete state.sortcolumn;
                    delete state.sortdirection;
                }
                if (options.indexOf('pager') == -1) {
                    delete state.pagenum;
                    delete state.pagesizeoptions;
                    delete state.pagesize;
                }
                if (options.indexOf('selection') == -1) {
                    delete state.selectedcells;;
                    delete state.selectedrowindexes;
                    delete state.selectedrowindex;
                }
                if (options.indexOf('grouping') == -1) {
                    delete state.groups;
                }
                if (options.indexOf('filter') == -1) {
                    delete state.filters;
                }
                $.each(this.columns.records, function (index) {
                    var column_state = state.columns[this.datafield];
                    if (options.indexOf('hidden_columns') == -1) {
                        delete column_state.hidden;
                    }
                    if (options.indexOf('reorder') == -1) {
                        delete column_state.index;
                    }
                    if (options.indexOf('columns_width') == -1) {
                        delete column_state.width;
                    }
                    if (options.indexOf('columns_text') == -1) {
                        delete column_state.text;
                    }
                    if (options.indexOf('alignment') == -1) {
                        delete column_state.align;
                        delete column_state.cellsalign;
                    }
                });
            }

            if (window.localStorage) {
                window.localStorage["jqxGrid" + this.element.id] = this._stringify(state);
            }
            this._savedstate = state;
            return state;
        },

        loadstate: function (gridstate, binding) {
            var state = "";
            if (gridstate != undefined && gridstate.width != undefined) {
                state = gridstate;
            }
            else if (window.localStorage) {
                var hasState = window.localStorage["jqxGrid" + this.element.id];
                if (hasState) {
                    var state = $.parseJSON(window.localStorage["jqxGrid" + this.element.id]);
                }
            }
            else if (this._savedstate) {
                var state = this._savedstate;
            }
            if (state != null && state !== "") {
                if (this.virtualmode || (this.source._source.url && this.source._source.url != "")) {
                    this.source.beginUpdate();
                }
                var data = state;
                if (data.width !== undefined) {
                    this.width = data.width;
                }
                if (data.height !== undefined) {
                    this.height = data.height;
                }
                if (this.pageable) {
                    if (data.pagesize != undefined) {
                        this.pagesize = data.pagesize;
                        this.dataview.pagesize = data.pagesize;
                    }
                    if (data.pagenum != undefined) {
                        this.dataview.pagenum = data.pagenum;
                    }
                    if (data.pagesizeoptions != undefined) {
                        this.pagesizeoptions = data.pagesizeoptions;
                    }
                    if (this.pagesizeoptions) {
                        var selectedindex = 0;

                        for (var i = 0; i < this.pagesizeoptions.length; i++) {
                            if (this.pagesize >= this.pagesizeoptions[i]) {
                                selectedindex = i;
                            }
                        }
                        if (this.pagershowrowscombo) {
                            this.pagershowrowscombo.jqxDropDownList({ selectedIndex: selectedindex });
                        }
                    }
                }
                if (this.sortable) {
                    if (data.sortdirection) {
                        if (data.sortdirection.ascending || data.sortdirection.descending) {
                            this.dataview.sortfield = data.sortcolumn;
                            var direction = data.sortdirection.ascending ? 'asc' : 'desc';
                            this.dataview.sortfielddirection = direction;
                            this.source.sortcolumn = data.sortcolumn;
                            this.source.sortdirection = direction;
                            this.sortby(data.sortcolumn, direction);
                        }
                    }
                    else if (this.dataview.sortfield != null && (this.dataview.sortfielddirection == 'asc' || this.dataview.sortfielddirection == 'desc')) {
                        this.sortby(this.dataview.sortfield, null);
                    }
                }
                if (this.groupable && data.groups) {
                    this.dataview.groups = data.groups;
                    this.groups = data.groups;
                }
                this.loadingstate = true;
                if (this.virtualsizeinfo) {
                    this._loadselectionandcolumnwidths(data);
                }
                this.loadingstate = false;
                if (this.virtualmode || (this.source._source.url && this.source._source.url != "")) {
                    if (binding == true) {
                        this.source.endUpdate(false);
                    }
                    else {
                        this.source.endUpdate(false);
                        if (this.virtualmode || this.source._source.filter || this.source._source.sort) {
                            this.updatebounddata("state");
                        }
                    }
                }
            }
        },

        _loadselectionandcolumnwidths: function (gridstate) {
            this.loadingstate = true;
            var state = "";

            if (gridstate != undefined && gridstate.width != undefined) {
                state = gridstate;
            }
            else if (window.localStorage) {
                if (window.localStorage["jqxGrid" + this.element.id]) {
                    var state = $.parseJSON(window.localStorage["jqxGrid" + this.element.id]);
                }
            }
            else if (this._savedstate) {
                var state = this._savedstate;
            }
            if (state != null && state != "") {
                var _tmploading = this._loading;
                this._loading = false;

                var data = state;
                var me = this;
                var requiresRender = false;
                var columnstomove = [];
                columnstomove.length = 0;
                var columnstomoveindexes = [];
                $.each(this.columns.records, function (index) {
                    var savedColumn = data.columns[this.datafield];
                    if (savedColumn != undefined) {
                        if (this.text != savedColumn.text) {
                            requiresRender = true;
                        }
                        if (this.hidden != savedColumn.hidden) {
                            requiresRender = true;
                        }

                        if (savedColumn.width !== undefined) {
                            this.width = savedColumn.width;
                            if (this._width) {
                                this._width = null;
                            }
                            if (this._percentagewidth) {
                                this._percentagewidth = null;
                            }
                        }
                        if (savedColumn.hidden !== undefined) {
                            this.hidden = savedColumn.hidden;
                        }
                        if (savedColumn.pinned !== undefined) {
                            this.pinned = savedColumn.pinned;
                        }
                        if (savedColumn.groupable !== undefined) {
                            this.groupable = savedColumn.groupable;
                        }
                        if (savedColumn.resizable !== undefined) {
                            this.resizable = savedColumn.resizable;
                        }
                        this.draggable = savedColumn.draggable;
                        if (savedColumn.text !== undefined) {
                            this.text = savedColumn.text;
                        }
                        if (savedColumn.align !== undefined) {
                            this.align = savedColumn.align;
                        }
                        if (savedColumn.cellsalign !== undefined) {
                            this.cellsalign = savedColumn.cellsalign;
                        }
                        if (me._columns) {
                            for (var j = 0; j < me._columns.length; j++) {
                                if (me._columns[j].datafield == this.datafield) {
                                    if (savedColumn.hidden !== undefined) {
                                        if (me._columns[j]["hidden"] != undefined) {
                                            me._columns[j]["hidden"] = savedColumn.hidden;
                                        }
                                    }
                                    if (savedColumn.width !== undefined) {
                                        if (me._columns[j]["width"] != undefined) {
                                            me._columns[j]["width"] = savedColumn.width;
                                        }
                                    }
                                }
                            }
                        }

                        if (savedColumn.index !== undefined) {
                            columnstomove[this.datafield] = savedColumn.index;
                            columnstomove.length++;
                        }
                    }
                });

                if (columnstomove.length > 0) {
                    if (this.setcolumnindex) {
                        var groupingcolumnscount = this.rowdetails ? 1 : 0;
                        groupingcolumnscount += this.groupable ? this.groups.length : 0;

                        var columnsRecords = new Array();
                        for (var i = 0; i < this.columns.records.length; i++) {
                            columnsRecords.push(this.columns.records[i]);
                        }

                        var groupedcolumns = 0;
                        for (var i = 0; i < columnsRecords.length; i++) {
                            var column = columnsRecords[i];
                            var index = columnstomove[column.datafield];

                            if (this.groupable && column.grouped) {
                                groupedcolumns++;
                                continue;
                            }
                            if (i == 0 && this.rowdetails) {
                                groupedcolumns++;
                                continue;
                            }

                            if (i !== index || this.groupable || this.rowdetails) {
                                me.setcolumnindex(column.datafield, groupedcolumns+index, false);
                            }
                        }
                    }
                    this.prerenderrequired = true;
                    if (this.groupable) {
                        this._refreshdataview();
                    }
                    this.rendergridcontent(true);
   
                    if (this._updatefilterrowui && this.filterable && this.showfilterrow) {
                        this._updatefilterrowui();
                    }
                    this._renderrows(this.virtualsizeinfo);
                }

                if (this.filterable && data.filters !== undefined) {
                    if (this.clearfilters) {
                        this._loading = false;
                        this.clearfilters(false);
                    }
                    var oldcolumn = "";
                    var filtergroup = new $.jqx.filter();
                    for (var i = 0; i < data.filters.filterscount; i++) {
                        var condition = data.filters['filtercondition' + i];
                        var datafield = data.filters['filterdatafield' + i];
                        var column = this.getcolumn(datafield);
                        if (datafield != oldcolumn) {
                            filtergroup = new $.jqx.filter();
                        }

                        oldcolumn = datafield;
                        if (column && column.filterable) {
                            var value = data.filters['filtervalue' + i];
                            var operator = data.filters['filteroperator' + i];
                            var filtertype = data.filters['filtertype' + i];
                            if (filtertype == "datefilter") {
                                var filter = filtergroup.createfilter(filtertype, value, condition, null, column.cellsformat, this.gridlocalization);
                            }
                            else {
                                var filter = filtergroup.createfilter(filtertype, value, condition);
                            }
                            filtergroup.addfilter(operator, filter);

                            if (this.showfilterrow) {
                                var widget = column._filterwidget;
                                var tablecolumn = column._filterwidget.parent();
                                if (widget != null) {
                                    switch (column.filtertype) {
                                        case 'number':
                                            tablecolumn.find('input').val(value);
                                            if (this.host.jqxDropDownList) {
                                                var conditions = filtergroup.getoperatorsbyfiltertype('numericfilter');
                                                widget.find('.filter').jqxDropDownList('selectIndex', conditions.indexOf(condition));
                                            }
                                            break;
                                        case 'date':
                                            if (this.host.jqxDateTimeInput) {
                                                var value2 = data.filters['filtervalue' + (i + 1)];
                                                var filtertype = data.filters['filtertype' + i];
                                                var filter = filtergroup.createfilter(filtertype, value2, "LESS_THAN_OR_EQUAL");
                                                filtergroup.addfilter(operator, filter);

                                                var from = new Date(value);
                                                var to = new Date(value2);
                                                if (isNaN(from)) {
                                                    from = $.jqx.dataFormat.tryparsedate(value);
                                                }
                                                if (isNaN(to)) {
                                                    to = $.jqx.dataFormat.tryparsedate(value);
                                                }

                                                $(tablecolumn.children()[0]).jqxDateTimeInput('setRange', from, to);
                                                i++;
                                            }
                                            else widget.val(value);
                                            break;
                                        case 'textbox':
                                        case 'default':
                                            widget.val(value);
                                            me["_oldWriteText" + widget[0].id] = value;
                                            break;
                                        case 'list':
                                            if (this.host.jqxDropDownList) {
                                                var items = $(tablecolumn.children()[0]).jqxDropDownList('getItems');
                                                var index = -1;
                                                $.each(items, function (i) {
                                                    if (this.value == value) {
                                                        index = i;
                                                        return false;
                                                    }
                                                });

                                                $(tablecolumn.children()[0]).jqxDropDownList('selectIndex', index);
                                            }
                                            else widget.val(value);
                                            break;
                                        case 'checkedlist':
                                            if (!this.host.jqxDropDownList) {
                                                widget.val(value);
                                            }
                                            break;
                                        case 'bool':
                                        case 'boolean':
                                            if (!this.host.jqxCheckBox) {
                                                widget.val(value);
                                            }
                                            else $(tablecolumn.children()[0]).jqxCheckBox({ checked: value });
                                            break;
                                    }
                                }
                            }
                            this.addfilter(datafield, filtergroup);
                        }
                    }
                    if (data.filters && data.filters.filterscount > 0) {
                        this.applyfilters();
                        if (this.showfilterrow) {
                            $.each(this.columns.records, function () {
                                if (this.filtertype == 'checkedlist' && this.filterable) {
                                    if (me.host.jqxDropDownList) {
                                        var column = this;
                                        var dropdownlist = column._filterwidget;
                                        var dropdownitems = dropdownlist.jqxDropDownList('getItems');
                                        var listbox = dropdownlist.jqxDropDownList('listBox');
                                        listbox.checkAll(false);
                                        if (column.filter) {
                                            listbox.uncheckAll(false);
                                            var filters = column.filter.getfilters();

                                            for (var i = 0; i < listbox.items.length; i++) {
                                                var label = listbox.items[i].label;
                                                $.each(filters, function () {
                                                    if (this.condition == "NOT_EQUAL") return true;
                                                    if (label == this.value) {
                                                        listbox.checkIndex(i, false, false);
                                                    }
                                                });
                                            }
                                            listbox._updateCheckedItems();
                                            var checkedItemsLength = listbox.getCheckedItems().length;
                                            if (listbox.items.length != checkedItemsLength && checkedItemsLength > 0) {
                                                listbox.host.jqxListBox('indeterminateIndex', 0, true, false);
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }

                    if (this.pageable && data.pagenum !== undefined) {
                        if (this.gotopage && !this.virtualmode) {
                            this.dataview.pagenum = -1;
                            this.gotopage(data.pagenum);
                        }
                        else if (this.gotopage && this.virtualmode) {
                            this.gotopage(data.pagenum);
                        }
                    }
                }

                if (data.selectedrowindexes && data.selectedrowindexes && data.selectedrowindexes.length > 0) {
                    this.selectedrowindexes = data.selectedrowindexes;
                    this.selectedrowindex = data.selectedrowindex;
                    if (this.selectionmode === "checkbox") {
                        this._updatecheckboxselection();
                    }
                }
                if (data.selectedcells) {
                    if (this._applycellselection) {
                        $.each(data.selectedcells, function () {
                            me._applycellselection(this.rowindex, this.datafield, true, false);
                        });
                    }
                }

                if (this.groupable && data.groups !== undefined) {
                    this._refreshdataview();
                    this.render();
                    this._loading = _tmploading;
                    this.loadingstate = false;

                    return;
                }

                if (requiresRender) {
                    this.prerenderrequired = true;
                    this.rendergridcontent(true);
                    this._loading = _tmploading;
                    this.loadingstate = false;
                    if (this.updating()) {
                        return false;
                    }
                }
                else {
                    this._loading = _tmploading;
                    this._updatecolumnwidths();
                    this._updatecellwidths();
                    this.loadingstate = false;
                }

                this.loadingstate = false;
                this._loading = _tmploading;
                this._renderrows(this.virtualsizeinfo);
            }
            this.loadingstate = false;
        },

        getstate: function () {
            var datainfo = this.getdatainformation();
            var data = {};
            data.width = this.width;
            data.height = this.height;
            data.pagenum = datainfo.paginginformation.pagenum;
            data.pagesize = datainfo.paginginformation.pagesize;
            data.pagesizeoptions = this.pagesizeoptions;
            data.sortcolumn = datainfo.sortinformation.sortcolumn;
            data.sortdirection = datainfo.sortinformation.sortdirection;
            if (this.selectionmode != null) {
                if (this.getselectedcells) {
                    if (this.selectionmode.toString().indexOf('cell') != -1) {
                        var selectedcells = this.getselectedcells();
                        var cells = new Array();
                        $.each(selectedcells, function () {
                            cells.push({ datafield: this.datafield, rowindex: this.rowindex });
                        });
                        data.selectedcells = cells;
                    }
                    else {
                        var selectedrowindexes = this.getselectedrowindexes();
                        data.selectedrowindexes = selectedrowindexes;
                        data.selectedrowindex = this.selectedrowindex;
                    }
                }
            }
            var postdata = {};
            var filterslength = 0;
            if (this.dataview.filters) {
                for (var x = 0; x < this.dataview.filters.length; x++) {
                    var filterdatafield = this.dataview.filters[x].datafield;
                    var filter = this.dataview.filters[x].filter;
                    var filters = filter.getfilters();
                    postdata[filterdatafield + "operator"] = filter.operator;
                    for (var m = 0; m < filters.length; m++) {
                        filters[m].datafield = filterdatafield;
                        if (filters[m].type == "datefilter") {
                            if (filters[m].value && filters[m].value.toLocaleString) {
                                var column = this.getcolumn(filters[m].datafield);
                                if (column.cellsformat) {
                                    var value = this.source.formatDate(filters[m].value, column.cellsformat, this.gridlocalization);
                                    if (value) {
                                        postdata["filtervalue" + filterslength] = value;
                                    }
                                    else {
                                        postdata["filtervalue" + filterslength] = filters[m].value.toLocaleString();
                                    }
                                }
                                else {
                                    postdata["filtervalue" + filterslength] = filters[m].value.toLocaleString();
                                }
                            }
                            else {
                                postdata["filtervalue" + filterslength] = filters[m].value;
                            }
                        }
                        else {
                            postdata["filtervalue" + filterslength] = filters[m].value;
                        }
                        postdata["filtercondition" + filterslength] = filters[m].condition;
                        postdata["filteroperator" + filterslength] = filters[m].operator;
                        postdata["filterdatafield" + filterslength] = filterdatafield;
                        postdata["filtertype" + filterslength] = filters[m].type;

                        filterslength++;
                    }
                }
            }
            postdata.filterscount = filterslength;
            data.filters = postdata;
            data.groups = this.groups;
            //if (this.groupable && this.groups.length > 0) {
            //    var me = this;
            //    var groupstates = [];
            //    $.each(this.dataview.loadedgroups, function () {
            //        var groupstate = me._findgroupstate(this.uniqueid);
            //        groupstates[this.group] = groupstate;
            //    });
            //    data.groupstates = groupstates;
            //}

            data.columns = {};
            var columnindex = 0;
            $.each(this.columns.records, function (index, value) {
                if (!this.datafield) {
                    return true;
                }

                var columndata = {};
                columndata.width = this.width;
                columndata.hidden = this.hidden;
                columndata.pinned = this.pinned;
                columndata.groupable = this.groupable;
                columndata.resizable = this.resizable;
                columndata.draggable = this.draggable;
                columndata.text = this.text;
                columndata.align = this.align;
                columndata.cellsalign = this.cellsalign;
                columndata.index = columnindex++;
                data.columns[this.datafield] = columndata;
            });

            return data;
        },

        _stringify: function (value) {
            if (window.JSON && typeof window.JSON.stringify === 'function') {
                var me = this;
                var json = "";
                try {
                    json = window.JSON.stringify(value);
                }
                catch (error) {
                    return me._str("", { "": value })
                }
                return json;
            }

            var json = this._str("", { "": value })
            return json;
        },

        _quote: function (string) {
            var escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
            meta = {
                '\b': '\\b',
                '\t': '\\t',
                '\n': '\\n',
                '\f': '\\f',
                '\r': '\\r',
                '"': '\\"',
                '\\': '\\\\'
            };

            return '"' + string.replace(escapable, function (a) {
                var c = meta[a];
                return typeof c === 'string' ? c : '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
            }) + '"';
        },


        _stringifyArray: function (value) {
            var len = value.length,
                partial = [],
                i;
            for (var i = 0; i < len; i++) {
                partial.push(this._str(i, value) || 'null');
            }

            return '[' + partial.join(',') + ']';
        },

        _stringifyObject: function (value) {
            var partial = [],
                i, v;
            var me = this;
            for (i in value) {
                if (Object.prototype.hasOwnProperty.call(value, i)) {
                    v = me._str(i, value);
                    if (v) {
                        partial.push(me._quote(i) + ':' + v);
                    }
                }
            }
            return '{' + partial.join(',') + '}';
        },

        _stringifyReference: function (value) {
            switch (Object.prototype.toString.call(value)) {
                case '[object Array]':
                    return this._stringifyArray(value);
            }
            return this._stringifyObject(value);
        },

        _stringifyPrimitive: function (value, type) {
            switch (type) {
                case 'string':
                    return this._quote(value);
                case 'number':
                    return isFinite(value) ? value : 'null';
                case 'boolean':
                    return value;
            }
            return 'null';
        },

        _str: function (key, holder) {
            var value = holder[key], type = typeof value;

            if (value && typeof value === 'object' && typeof value.toJSON === 'function') {
                value = value.toJSON(key);
                type = typeof value;
            }
            if (/(number|string|boolean)/.test(type) || (!value && type === 'object')) {
                return this._stringifyPrimitive(value, type);
            } else {
                return this._stringifyReference(value);
            }
        }
    });
})(jQuery);
(function ($) {
    $.extend($.jqx._jqxGrid.prototype, {

        getcolumnindex: function(datafield)
        {
            var column = this.getcolumn(datafield);
            var columnindex = this.columns.records.indexOf(column);
            return columnindex;
        },

        setcolumnindex: function (datafield, index, refresh) {
            var column = this.getcolumn(datafield);
            if (column.pinned) return;
            if (column.hidden) return;
            if (column.checkboxcolumn) return;
            if (column.grouped) return;

            var columnindex = this.columns.records.indexOf(column);
            this.columns.records.splice(columnindex, 1);
            this.columns.records.splice(index, 0, column);

            var left = 0;
            var zindex = this.headerZIndex;
            this.columnsrow.children().detach();

            var cellclass = this.toThemeProperty('jqx-grid-cell');
            cellclass += ' ' + this.toThemeProperty('jqx-grid-cell-pinned');
            if (this.filterrow) {
                $(this.filterrow.children()[0]).children().detach();
                this.filterrow[0].cells = [];
            }

            var self = this;
            var tablerow = null;
            if (self.filterrow != undefined) {
                var tablerow = $(self.filterrow.children()[0]);
            }

            this.columnsrow[0].cells = [];
            var hasHiddenColumns = false;
            $.each(this.columns.records, function (i, value) {
                var column = this.uielement;
                self.columnsrow.append(column);
                if (!self.rtl) {
                    column.css('z-index', zindex--);
                }
                else {
                    column.css('z-index', zindex++);
                }

                var desiredwidth = this.width;
                column.css('left', left);
                self.columnsrow[0].cells[self.columnsrow[0].cells.length] = column[0];

                if (self.filterrow) {
                    var tablecolumn = $('<div style="overflow: hidden; position: absolute; height: 100%;" class="' + cellclass + '"></div>');
                    tablerow.append(tablecolumn);
                    tablecolumn.css('left', left);
                    tablecolumn.css('z-index', zindex + 1);
                    tablecolumn.width(this.width);
                    tablecolumn[0].left = left;
                    tablecolumn.append(this._filterwidget);
                    self.filterrow[0].cells[self.filterrow[0].cells.length] = tablecolumn[0];
                }
                if (this.hidden) {
                    hasHiddenColumns = true;
                }
                if (!(this.hidden && this.hideable)) {
                    left += desiredwidth;
                }
            });

            if (this.groupable) {
                var groupslength = this.groups.length;
                if (groupslength > 0) {
                    if (columnindex - groupslength >= 0) {
                        columnindex -= groupslength;
                        index -= groupslength;
                    }
                }
            }
            if (this.rowdetails) {
                if (columnindex - 1 >= 0) {
                    columnindex --;
                    index --;
                }
            }
            if (this.selectionmode == 'checkbox') {
                if (columnindex - 1 >= 0) {
                    columnindex--;
                    index--;
                }
            }

            var column = this._columns[columnindex];
   
            this._columns.splice(columnindex, 1);
            this._columns.splice(index, 0, column);

            this._raiseEvent(24, { columntext: column.text, datafield: column.datafield, oldindex: columnindex, newindex: index });
            if (refresh == false) return;

            if (hasHiddenColumns) {
                this.prerenderrequired = true;
                this.rendergridcontent(true, false);
                this._updatecolumnwidths();
                this._updatecellwidths();
            }
            else {
                this._updatecolumnwidths();
                this._updatecellwidths();
            }
            if (this._updatefilterrowui && this.filterable && this.showfilterrow) {
                this._updatefilterrowui();
            }

            this._rendercolumngroups();
            this._renderrows(this.virtualsizeinfo);

        },

        _pinnedColumnsLength: function () {
            var pinned = 0;
            $.each(this.columns.records, function () {
                if (this.pinned) pinned++;
                if (this.grouped) pinned++;
            });
            if (this.selectionmode == 'checkbox') pinned++;
            return pinned;
        },

        _handlecolumnsreorder: function () {
            var self = this;
            var dropindex = -1;
            var candrop = false;

            if (!self.columnsreorder)
                return;

            var mousemove = 'mousemove.reorder' + this.element.id;
            var mousedown = 'mousedown.reorder' + this.element.id;
            var mouseup = 'mouseup.reorder' + this.element.id;

            var touchdevice = false;
            if (this.isTouchDevice() && this.touchmode !== true) {
                touchdevice = true;
                mousemove = $.jqx.mobile.getTouchEventName('touchmove') + '.reorder' + this.element.id;
                mousedown = $.jqx.mobile.getTouchEventName('touchstart') + '.reorder' + this.element.id;
                mouseup = $.jqx.mobile.getTouchEventName('touchend') + '.reorder' + this.element.id;
            }

            this.removeHandler($(document), mousemove);
            this.addHandler($(document), mousemove, function (event) {
                if (self.resizing) {
                    return true;
                }

                if (self.reordercolumn != null) {
                    var left = parseInt(event.pageX);
                    var top = parseInt(event.pageY);
                    if (touchdevice) {
                        var touches = self.getTouches(event);
                        var touch = touches[0];
                        if (touch != undefined) {
                            left = parseInt(touch.pageX);
                            top = parseInt(touch.pageY);
                        }
                    }
                    var hostoffset = self.host.coord();
                    var hostleft = parseInt(hostoffset.left);
                    var hosttop = parseInt(hostoffset.top);
                    if (self.dragmousedownoffset == undefined || self.dragmousedownoffset == null) {
                        self.dragmousedownoffset = { left: 0, top: 0 };
                    }

                    var leftposition = parseInt(left) - parseInt(self.dragmousedownoffset.left);
                    var topposition = parseInt(top) - parseInt(self.dragmousedownoffset.top);

                    self.reordercolumn.css({ left: leftposition + 'px', top: topposition + 'px' });
                    candrop = false;
                    if (left >= hostleft && left <= hostleft + self.host.width()) {
                        if (top >= hosttop && top <= hosttop + self.host.height()) {
                            candrop = true;
                        }
                    }

                    dropindex = -1;
                    if (candrop) {
                        self.reordercolumnicon.removeClass(self.toThemeProperty('jqx-grid-dragcancel-icon'));
                        self.reordercolumnicon.addClass(self.toThemeProperty('jqx-grid-drag-icon'));
                        var groupsheaderoffset = self.columnsheader.coord();
                        var groupsheaderbottom = groupsheaderoffset.top + self.columnsheader.height();

                        if (self.columnsdropline != null) {
                            if (top >= groupsheaderoffset.top && top <= groupsheaderbottom) {
                                dropindex = self._handlereordercolumnsdroplines(left);
                            }
                            else {
                                self.columnsdropline.fadeOut('slow');
                            }
                        }
                    }
                    else {
                        if (self.columnsdropline != null) {
                            self.columnsdropline.fadeOut('slow');
                        }

                        self.reordercolumnicon.removeClass(self.toThemeProperty('jqx-grid-drag-icon'));
                        self.reordercolumnicon.addClass(self.toThemeProperty('jqx-grid-dragcancel-icon'));
                    }
                    if (touchdevice) {
                        event.preventDefault();
                        event.stopPropagation();
                        return false;
                    }
                }
            });

            this.columnsbounds = new Array();

            this.removeHandler($(document), mousedown);
            this.addHandler($(document), mousedown, function (event) {
                if (self.resizing) {
                    return true;
                }

                self.columnsbounds = new Array();
                var left = self.host.coord().left;
                var top = self.host.coord().top;
                if (self.showtoolbar) top += self.toolbarheight;
                if (self.groupable && self.showgroupsheader) top += self.groupsheaderheight;
                var columnIndex = 0;
                $.each(self.columns.records, function (index) {
                    var column = this;

                    if (column.hidden) {
                        self.columnsbounds[self.columnsbounds.length] = { top: top, column: column, left: left, width: 0, height: 2 + self.rowsheight };
                        return true;
                    }

                    if (columnIndex == 0) {
                        if (!self.rtl) {
                            left = parseInt(self.host.coord().left) - self.hScrollInstance.value;
                        }
                        else {
                            left = parseInt(self.host.coord().left) - self.hScrollInstance.max + self.hScrollInstance.value;
                        }
                    }
                    columnIndex++;
                    var height = 2 + self.columnsheight;
                    if (self.columnshierarchy) {
                        top = $(column.uielement).coord().top;
                        height = $(column.uielement).height();
                    }
                    self.columnsbounds[self.columnsbounds.length] = { top: top, column: column, left: left, width: column.width, height: height };
                    left += column.width;
                });
            });
            this.removeHandler($(document), mouseup);
            this.addHandler($(document), mouseup, function (event) {
                if (self.resizing) {
                    return true;
                }

                self.__drag = false;

                $(document.body).removeClass('jqx-disableselect');
                var left = parseInt(event.pageX);
                var top = parseInt(event.pageY);
                if (touchdevice) {
                    var touches = self.getTouches(event);
                    var touch = touches[0];
                    left = parseInt(touch.pageX);
                    top = parseInt(touch.pageY);
                }
                var hostoffset = self.host.coord();
                var hostleft = parseInt(hostoffset.left);
                var hosttop = parseInt(hostoffset.top);
                var groupsheaderheight = self.groupsheader.height();
                if (self.showtoolbar) {
                    hosttop += self.toolbarheight;
                }

                self.columndragstarted = false;
                self.dragmousedown = null;
                if (self.reordercolumn != null) {
                    var datafield = $.data(self.reordercolumn[0], 'reorderrecord');
                    var oldindex = self.columns.records.indexOf(self.getcolumn(datafield));
                    self.reordercolumn.remove();
                    self.reordercolumn = null;
                    var minIndex = 0;
                 //   minIndex += self.rowdetails ? 1 : 0;
                    minIndex += self._pinnedColumnsLength();

                    if (datafield != null) {
                        if (candrop) {
                            if (dropindex != -1) {
                                var index = dropindex.index;
                                if (index >= minIndex) {
                                    var targetcolumn = self.columns.records[index];
                                    if (targetcolumn != undefined) {
                                        var columnindex = self.columns.records.indexOf(self.getcolumn(targetcolumn.datafield));
                                        if (targetcolumn.datafield == null) {
                                            var columnindex = self.columns.records.indexOf(self.getcolumnbytext(targetcolumn.text));
                                        }
                                        if (self.columngroups) {
                                            var target = targetcolumn;
                                            if (oldindex < columnindex) {
                                                if (dropindex.position == 'before') {
                                                     target = self.columns.records[columnindex - 1];
                                                }
                                            }

                                            if (target.columngroup != self.getcolumn(datafield).columngroup) {
                                                if (self.columnsdropline != null) {
                                                    self.columnsdropline.remove();
                                                    self.columnsdropline = null;
                                                }
                                                return;
                                            }
                                        }

                                        if (oldindex < columnindex) {
                                            if (dropindex.position == 'before') {
                                                self.setcolumnindex(datafield, columnindex - 1);
                                            }
                                            else {
                                                self.setcolumnindex(datafield, columnindex);
                                            }
                                        }
                                        else if (oldindex > columnindex) {
                                            self.setcolumnindex(datafield, columnindex);
                                        }
                                        if (self.autosavestate) {
                                            if (self.savestate) self.savestate();
                                        }
                                    }
                                }
                            }
                        }

                        if (self.columnsdropline != null) {
                            self.columnsdropline.remove();
                            self.columnsdropline = null;
                        }
                    }
                }
            });
        },

        getcolumnbytext: function (text) {
            var column = null;
            if (this.columns.records) {
                $.each(this.columns.records, function () {
                    if (this.text == text) {
                        column = this;
                        return false;
                    }
                });
            }
            return column;
        },

        _handlereordercolumnsdroplines: function (left) {
            var self = this;
            var dropindex = -1;
            var minIndex = self._pinnedColumnsLength();
            var hostleft = parseInt(self.host.coord().left);
            var hostright = hostleft + self.host.width();
            var leftOffset = self.vScrollBar.css('visibility') != 'hidden' ? 19 : 0;
            if (!self.rtl) leftOffset = 0;

            $.each(self.columnsbounds, function (index) {
                if (index >= minIndex) {
                    if (this.width == 0) return true;

                    if (left <= this.left + this.width / 2) {
                        if (left > hostright) {
                            self.columnsdropline.fadeOut();
                            return false;
                        }
                        self.columnsdropline.css('left', leftOffset + parseInt(this.left) + 'px');
                        self.columnsdropline.css('top', parseInt(this.top) + 'px');
                        self.columnsdropline.height(this.height);
                        self.columnsdropline.fadeIn('slow');
                        dropindex = { index: index, position: 'before' }
                        return false;
                    }
                    else if (left >= this.left + this.width / 2) {
                        if (this.left + this.width > hostright) {
                            self.columnsdropline.fadeOut();
                            return false;
                        }

                        self.columnsdropline.css('left', leftOffset + 1 + this.left + this.width);
                        self.columnsdropline.css('top', this.top);
                        self.columnsdropline.height(this.height);
                        self.columnsdropline.fadeIn('slow');
                        dropindex = { index: index, position: 'after' }
                    }
                }
            });

            return dropindex;
        },

        _createreordercolumn: function (column, position, hascolumnsdropline) {
            var me = this;
            var mousemove = position;

            if (me.reordercolumn) me.reordercolumn.remove();
            if (me.columnsdropline) me.columnsdropline.remove();
            me.reordercolumn = $('<div></div>');
            var columnclone = column.clone();
            me.reordercolumn.css('z-index', 999999);
            columnclone.css('border-width', '1px');
            columnclone.css('opacity', '0.4');
            var menubutton = $(columnclone.find('.' + me.toThemeProperty('jqx-grid-column-menubutton')));
            if (menubutton.length > 0) {
                menubutton.css('display', 'none');
            }
            var closebutton = $(columnclone.find('.jqx-icon-close'));
            if (closebutton.length > 0) {
                closebutton.css('display', 'none');
            }

            me.reordercolumnicon = $('<div style="z-index: 9999; position: absolute; left: 100%; top: 50%; margin-left: -18px; margin-top: -7px;"></div>');
            me.reordercolumnicon.addClass(me.toThemeProperty('jqx-grid-drag-icon'));
            me.reordercolumn.css('float', 'left');
            me.reordercolumn.css('position', 'absolute');
            var hostoffset = me.host.coord();
            columnclone.width(column.width() + 16);
            me.reordercolumn.append(columnclone);
            me.reordercolumn.height(column.height());
            me.reordercolumn.width(columnclone.width());
            me.reordercolumn.append(me.reordercolumnicon);
            $(document.body).append(me.reordercolumn);

            columnclone.css('margin-left', 0);
            columnclone.css('left', 0);
            columnclone.css('top', 0);
            me.reordercolumn.css('left', mousemove.left + me.dragmousedown.left);
            me.reordercolumn.css('top', mousemove.top + me.dragmousedown.top);

            if (hascolumnsdropline != undefined && hascolumnsdropline) {
                me.columnsdropline = $('<div style="z-index: 9999; display: none; position: absolute;"></div>');

                me.columnsdropline.width(2);
                me.columnsdropline.addClass(me.toThemeProperty('jqx-grid-group-drag-line'));
                $(document.body).append(me.columnsdropline);
            }
        },

        _handlecolumnsdragreorder: function (record, column) {
            if (this.reordercolumn) this.reordercolumn.remove();
            if (this.columnsdropline) this.columnsdropline.remove();

            this.dragmousedown = null;
            this.dragmousedownoffset = null;
            this.columndragstarted = false;
            this.reordercolumn = null;

            var me = this;
            var mousemove;
            var touchdevice = false;
            if (this.isTouchDevice() && this.touchmode !== true) {
                touchdevice = true;
            }

            var mousedown = 'mousedown.drag';
            var mousemove = 'mousemove.drag';
            if (touchdevice) {
                mousedown = $.jqx.mobile.getTouchEventName('touchstart') + '.drag';
                mousemove = $.jqx.mobile.getTouchEventName('touchmove') + '.drag';
            }
            else {
                this.addHandler(column, 'dragstart', function (event) {
                    return false;
                });
            }
            this.addHandler(column, mousedown, function (event) {
                if (false == record.draggable) {
                    return true;
                }
                if (me.resizing) {
                    return true;
                }

                me.__drag = true;

                var pagex = event.pageX;
                var pagey = event.pageY;
                if (touchdevice) {
                    var touches = me.getTouches(event);
                    var touch = touches[0];
                    pagex = touch.pageX;
                    pagey = touch.pageY;
                }

                me.dragmousedown = { left: pagex, top: pagey };

                var offsetposition = $(event.target).coord();
                me.dragmousedownoffset = { left: parseInt(pagex) - parseInt(offsetposition.left), top: parseInt(pagey - offsetposition.top) };
                return true;
            });

            this.addHandler(column, mousemove, function (event) {
                if (!record.draggable) return true;
                if (undefined == record.datafield) return true;
                if (record.pinned) return true;
                if (me.resizing) {
                    return true;
                }

                if (me.dragmousedown) {
                    var pagex = event.pageX;
                    var pagey = event.pageY;
                    if (touchdevice) {
                        var touches = me.getTouches(event);
                        var touch = touches[0];
                        if (touch != undefined) {
                            pagex = touch.pageX;
                            pagey = touch.pageY;
                        }
                    }
                    mousemove = { left: pagex, top: pagey };
                    if (!me.columndragstarted && me.reordercolumn == null) {
                        var xoffset = Math.abs(mousemove.left - me.dragmousedown.left);
                        var yoffset = Math.abs(mousemove.top - me.dragmousedown.top);
                        if (xoffset > 3 || yoffset > 3) {
                            me._createreordercolumn(column, mousemove, true);
                            $(document.body).addClass('jqx-disableselect');
                            $.data(me.reordercolumn[0], 'reorderrecord', record.datafield);
                        }
                    }
                }
            });
        }
    });
})(jQuery);(function ($) {

    $.jqx.jqxWidget('jqxListMenu', '', {});

    var listItemsCounter = 0,
        listsCounter = 0;

    $.extend($.jqx._jqxListMenu.prototype, {

        defineInstance: function () {
            this.filterCallback = function (text, searchValue) {
                var result = $.jqx.string.containsIgnoreCase($.trim(text), searchValue);
                return result;
            };
            this.placeHolder = 'Filter list items...';
            this.showFilter = false;
            this.showHeader = true;
            this.showBackButton = true;
            this.showNavigationArrows = true;
            this.alwaysShowNavigationArrows = false;
            this.backLabel = 'Back';
            this.width = '100%';
            this.height = 'auto';
            this.animationType = 'slide';
            this.animationDuration = 0;
            this.headerAnimationDuration = 0;
            this.autoSeparators = false;
            this.readOnly = false;
            this.roundedCorners = true;
            this.disabled = false;
            this.enableScrolling = true;
            this.touchMode = false;
            //private data members
            this._childrenMap = {};
            this._parentMap = {};
            this._lock = false;
            this._backButton = null;
            this._currentPage = null;
            this._header = null;
            this._oldHost;
            this.rtl = false;
            this.aria =
            {
                "aria-disabled": { name: "disabled", type: "boolean" }
            };
        },

        destroy: function () {
            this.host.remove();
        },

        createInstance: function () {
            $.jqx.aria(this);
            this.host.attr('data-role', 'listmenu');
            this.host.attr('role', 'tree');
        },

        refresh: function (init) {
            this._render();
            this._removeClasses();
            this._addClasses();
            this._currentPage = this._currentPage || this.host.children('.jqx-listmenu').first();
            this._changeHeader(this._currentPage);
            this._removeEventHandlers();
            this._addEventHandlers();
        },

        _render: function () {
            this._renderHost();
            this._renderAutoSeparators();
            this._renderSublists();
            this._renderFilterBar();
            this._renderHeader();
            this.host.css({
                width: this.width,
                height: this.height
            });
            if (this.disabled)
                this.disable();
            if (this.enableScrolling && this.host.jqxPanel && this.panel) {
                this.panel.jqxPanel('_arrange');
            }
        },

        _renderHost: function () {
            if (!this.host.is('div')) {
                this._oldHost = this.host;
                this.host.wrap('<div/>');
                this.host = this.host.parent();
                this.element = this.host[0];
                if (this.host.jqxPanel && this.enableScrolling) {
                    this.host.wrap('<div/>');
                    this.panel = this.host.parent();
                    this.panel[0].id = 'panel' + this.element.id;
                    this.panel.jqxPanel({ theme: this.theme, autoUpdate: true, width: this.width, height: this.height, touchMode: this.touchMode });
                    this.host.css({ width: '100%' });
                    this.host.css({ height: 'auto' });
                    this.host.css('border', 'none');
                }
            }
            else {
                this.element.style.overflow = 'hidden';
            }
            if (!this.enableScrolling) {
                this.element.style.overflow = 'hidden';
            }

            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                this.element.style.position = 'relative';
            }
            if (this.enableScrolling && this.panel) {
                this.panel.jqxPanel('_arrange');
            }
        },

        _renderAutoSeparators: function (list) {
            var autoSeparators = this.host.find('.jqx-listmenu-auto-separator'),
                lists = this.host.find('[data-role="listmenu"]'),
                list, i;
            autoSeparators.remove();
            for (i = 0; i < lists.length; i += 1) {
                list = $(lists[i]);
                if (list.data('auto-separators') || this.autoSeparators) {
                    this._renderListAutoSeparators(list);
                }
            }
        },

        _renderSublists: function () {
            var stack = [(this.host.find('.jqx-listmenu').first()[0] || this.host.find('ul,ol').first()[0])],
                lis, li, list, lisCount, childList;
            this._refreshList(stack[0]);
            while (stack.length) {
                list = stack.pop();
                lis = this._getChildrenByTagName(list, 'li', 'LI');
                lisCount = lis.length;
                for (var i = 0; i < lisCount; i += 1) {
                    li = lis[i];
                    $(li).attr('role', 'treeitem');
                    childList = this._getChildList(li);
                    this._refreshLi(li, i, lisCount);
                    if (childList) {
                        stack.push(childList);
                        this._refreshList(childList, li, true);
                    }
                }
            }
        },

        _refreshList: function (list, parent, sublist) {
            list = $(list);
            if (list.data('role') === 'listmenu') {
                if (!list.is('.jqx-listmenu')) {
                    this._renderList(list);
                    this._handleListId(list);
                    this._addListClasses(list);
                }
                if (parent) {
                    this._expandHierarchy(list[0], parent);
                }
                if (sublist) {
                    this._handleSublist(list[0]);
                }
            }
        },

        _renderList: function (list) {
            list = $(list);
            if (!list.is('.jqx-listmenu')) {
                list.detach();
                list.appendTo(this.host);
            }
        },

        _handleListId: function (list) {
            if (!list[0].id) {
                list[0].id = 'jqx-listmenu-' + listsCounter;
                listsCounter += 1;
            }
        },

        _renderListAutoSeparators: function (list) {
            var lis = list.children('li'),
                firstLetter, li;
            var separator = {};
            for (var i = 0; i < lis.length; i += 1) {
                li = $(lis[i]);
                if (!li.data('role')) {
                    if ($.trim(li.text())[0] !== firstLetter) {
                        firstLetter = $.trim(li.text())[0];
                        var element = $('<li data-role="separator" class="' +
                            this.toThemeProperty('jqx-listmenu-auto-separator') +
                            '">' + firstLetter + '</li>');
                        element.insertBefore(li);

                        element[0].items = new Array();
                        separator = element[0];
                    }
                    if (separator.items) {
                        separator.items[separator.items.length] = li[0];
                    }
                }
            }
        },

        _addListClasses: function (list) {
            list.addClass('jqx-listmenu');
        },

        _expandHierarchy: function (child, parent) {
            if (parent && child) {
                var pId = parent.id,
                    cId = child.id;
                this._childrenMap[pId] = cId;
                this._parentMap[cId] = pId;
            }
        },

        _handleSublist: function (list) {
            if (!this._currentPage || list !== this._currentPage[0]) {
                list.style.display = 'none';
            } else {
                list.style.display = 'block';
            }
        },

        _getChildrenByTagName: function (el, lcName, ucName) {
            var results = [],
                dict = {};
            dict[lcName] = dict[ucName] = true;
            el = el.firstChild;
            while (el) {
                if (dict[el.nodeName]) {
                    results.push(el);
                }
                el = el.nextSibling;
            }
            return results;
        },

        _renderFilterBar: function () {
            if (!this._filterBar) {
                this._filterBar = $('<div/>');
                this._filterInput = $('<input type="text" />');
                this._filterBar.append(this._filterInput);
                this.host.prepend(this._filterBar);
            }
            var IE7 = false;
            if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                IE7 = true;
            }

            if (!IE7) {
                this._filterInput.attr('placeholder', this.placeHolder);
            }

            if (!this.showFilter) {
                this._filterBar.css('display', 'none');
            } else {
                this._filterBar.css('display', 'block');
            }
        },

        _renderHeader: function () {
            if (!this._header) {
                this._header = $('<div/>');
                this.host.prepend(this._header);
                this._renderHeaderLabel();
            }
            this._renderBackButton();
            if (!this.showHeader) {
                this._header.css('display', 'none');
            } else {
                this._header.css('display', 'block');
            }
        },

        _renderHeaderLabel: function () {
            this._headerLabel = $('<span/>');
            this._headerLabel.addClass(this.toThemeProperty('jqx-listmenu-header-label'));
            this._header.append(this._headerLabel);
        },

        _renderBackButton: function () {
            if (!this._backButton) {
                this._backButton = $('<div><div style="float: left;"></div><span style="float: left;">' + this.backLabel + '</span><div style="clear:both;"></div></div>');
                this._header.prepend(this._backButton);
                this._backButton.jqxButton({ theme: this.theme });
                this._backButton.find('div:first').addClass(this.toThemeProperty('jqx-listmenu-backbutton-arrow'));
                if (!this.showBackButton) {
                    this._backButton.css('display', 'none');
                } else {
                    this._backButton.css('display', 'inline-block');
                }
                if (this.rtl) {
                    var ie7 = $.jqx.browser.msie && $.jqx.browser.version < 8;
                    if (!ie7) {
                        this._backButton.css('position', 'relative');
                        this._backButton.css('margin-left', '100%');
                        this._backButton.css('left', -this._backButton.outerWidth() - 15);
                    }
                    else {
                        this._backButton.css('position', 'relative');
                        this._backButton.css('left', '100%');
                        this._backButton.css('margin-left', - this._backButton.outerWidth() - 45 + 'px');
                    }
                }
            }

            if (!this.showBackButton) {
                this._backButton.css('display', 'none');
            } else {
                this._backButton.css('display', 'inline-block');
            }
        },

        _removeEventHandlers: function () {
            var isTouchDevice = this.isTouchDevice() && !this.touchMode;
            var touchstart = $.jqx.mobile.getTouchEventName('touchstart');

            this.removeHandler(this._backButton, !isTouchDevice ? 'click' : touchstart);
            this.removeHandler(this._filterInput, 'keyup');
            this.removeHandler(this._filterInput, 'change');
        },

        _addEventHandlers: function () {
            var self = this;
            var isTouchDevice = this.isTouchDevice() && !this.touchMode;
            var touchstart = $.jqx.mobile.getTouchEventName('touchstart');

            this.addHandler(this._backButton, !isTouchDevice ? 'click' : touchstart, function () {
                self.back();
            });
            this.addHandler(this._filterInput, 'keyup change', function () {
                self._filter($(this).val());
            });
        },

        _getChildList: function (li) {
            if (!li) return;
            var id = this._childrenMap[li.id],
                list;
            if (li.className.indexOf('jqx-listmenu-item') >= 0 && id) {
                return document.getElementById(id);
            }
            var childUl = this._getChildrenByTagName(li, 'ul', 'UL')[0],
            childOl = this._getChildrenByTagName(li, 'ol', 'OL')[0];
            list = childUl || childOl;
            return list;
        },

        _refreshLi: function (li, current, count) {
            if (li.parentNode && li.parentNode.getAttribute('data-role') === 'listmenu') {
                if (li.id == '') {
                    var i = 2;
                }
                this._handleLiId(li);
                this._renderLi(li);
                this._removeLiEventHandlers(li);
                this._addLiEventHandlers(li);
                this._addLiClasses(li, current, count);
            }
        },

        _handleLiId: function (li) {
            if (!li.id) {
                li.id = 'jqx-listmenu-item-' + listItemsCounter;
                listItemsCounter += 1;
            }
        },

        _renderLi: function (li) {
            if ((/(separator|header)/).test($(li).data('role')) ||
                $(li).children('.jqx-listmenu-arrow-right').length > 0) {
                return;
            }

            $(li).wrapInner('<span class="' + this.toThemeProperty('jqx-listmenu-item-label') + '"></span>');

            if (this.showNavigationArrows || this.alwaysShowNavigationArrows) {
                var arrow = $('<span/>');
                var nestedUL = $(li).find('ul');
                var nestedOL = $(li).find('ol');
                if (this.alwaysShowNavigationArrows || (((nestedUL.length > 0) && (/(listmenu)/).test(nestedUL.data('role'))) || ((nestedOL.length > 0) && (/(listmenu)/).test(nestedOL.data('role'))))) {
                    arrow.addClass(this.toThemeProperty('jqx-listmenu-arrow-right'));
                    if (!this.rtl) {
                        arrow.addClass(this.toThemeProperty('jqx-icon-arrow-right'));
                        arrow.appendTo(li);
                    }
                    else {
                        arrow.addClass(this.toThemeProperty('jqx-icon-arrow-left'));
                        arrow.addClass(this.toThemeProperty('jqx-listmenu-arrow-rtl'));
                        arrow.prependTo(li);
                    }
                }
            }
        },

        _removeLiEventHandlers: function (li) {
            var isTouchDevice = this.isTouchDevice();
            var touchstart = $.jqx.mobile.getTouchEventName('touchstart');
            var touchend = $.jqx.mobile.getTouchEventName('touchend');
            var touchmove = $.jqx.mobile.getTouchEventName('touchmove');

            var mouseDownEvent = (!isTouchDevice ? 'mousedown' : touchstart) + '.listmenu';
            var mouseUpEvent = (!isTouchDevice ? 'mouseup' : touchend) + '.listmenu';

            this.removeHandler($(li), mouseDownEvent);
            this.removeHandler($(document), mouseUpEvent + '.' + li.id);
        },

        isTouchDevice: function () {
            var isTouchDevice = $.jqx.mobile.isTouchDevice();
            if (this.touchMode == true) {
                isTouchDevice = true;
            }

            return isTouchDevice;
        },

        _addLiEventHandlers: function (li) {
            li = $(li);
            var self = this,
                pressed = this.toThemeProperty('jqx-listmenu-arrow-right-pressed'),
                arrow = li.children('.jqx-listmenu-arrow-right');
            var isTouchDevice = self.isTouchDevice() && !this.touchMode;
            var touchstart = $.jqx.mobile.getTouchEventName('touchstart');
            var touchend = $.jqx.mobile.getTouchEventName('touchstart');
            var touchmove = $.jqx.mobile.getTouchEventName('touchmove');

            var mouseDownEvent = (!isTouchDevice ? 'mousedown' : touchstart) + '.listmenu';
            var mouseUpEvent = (!isTouchDevice ? 'mouseup' : touchend) + '.listmenu';
            var downLi = null;
            var position = "";
            if (!(/(separator|readonly)/).test(li.data('role')) && !this.readOnly) {
                this.addHandler(li, 'dragstart', function () {
                    return false;
                });

                this.addHandler(li, mouseDownEvent, function (event) {
                    if (!self.disabled) {
                        downLi = event.target;
                        position = $.jqx.position(event);
                        if (li.find('div[data-role="content"]').length == 0) {
                            li.addClass(self.toThemeProperty('jqx-fill-state-pressed'));
                            arrow.addClass(pressed);
                        }
                    }
                });
                this.addHandler(li, mouseUpEvent, function (event) {
                    if (!self.disabled) {
                        if (downLi == event.target || !isTouchDevice) {
                            if (isTouchDevice) {
                                if ($.jqx.position(event).top === position.top) {
                                    self.next(li);
                                }
                            }
                            else {
                                if ($.jqx.position(event).top === position.top) {
                                    self.next(li);
                                }
                            }
                        }
                    }
                });
                this.addHandler($(document), mouseUpEvent + '.' + li[0].id, function () {
                    if (!self.disabled) {
                        li.removeClass(self.toThemeProperty('jqx-fill-state-pressed'));
                        arrow.removeClass(pressed);
                    }
                });
            }
        },

        _addLiClasses: function (li, current, count) {
            li = $(li);
            if (li.data('role') === 'separator') {
                this._handleSeparatorStyle(li);
            } else if (li.data('role') === 'header') {
                this._handleHeaderStyle(li);
            } else {
                if (this.readOnly || li.data('role') === 'readonly') {
                    li.addClass(this.toThemeProperty('jqx-listmenu-item-readonly'));
                } else {
                    li.removeClass(this.toThemeProperty('jqx-listmenu-item-readonly'));
                }
                this._handleItemStyle(li);
            }
            if (current === 0 && !this.showHeader && !this.showFilter) {
                li.addClass(this.toThemeProperty('jqx-rc-t'));
            }
            if (current === count - 1) {
                li.addClass(this.toThemeProperty('jqx-rc-b'));
            }
        },

        _handleSeparatorStyle: function (li) {
            li.addClass(this.toThemeProperty('jqx-listmenu-separator'));
            li.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
            li[0].style.listStyle = 'none';
        },

        _handleHeaderStyle: function (li) {
            li.css('display', 'none');
        },

        _handleItemStyle: function (li) {
            li.addClass(this.toThemeProperty('jqx-listmenu-item'));
            if (this.rtl) {
                li.addClass(this.toThemeProperty('jqx-rtl'));
            }
            li.addClass(this.toThemeProperty('jqx-fill-state-normal'));
        },

        back: function () {
            var c = this._currentPage,
                parent;
            if (c) {
                parent = this._parentMap[c[0].id];
            }
            this._back = true;
            if ($("#" + parent).length > 0) {
                $.jqx.aria($("#" + parent), 'aria-expanded', false);
            }

            this._changePage(c, $('#' + parent).parent(), this.animationDuration, true);
            this._back = false;
        },

        next: function (li) {
            var id = li.attr('id'),
                childId = this._childrenMap[id],
                child = $('#' + childId),
                parent = $('#' + id).parent(); 
            $.jqx.aria(li, 'aria-expanded', true);

            this._changePage(parent, child, this.animationDuration);
        },

        changePage: function (newPage) {
            if (typeof newPage === 'string') {
                newPage = $(newPage);
            }
            if (!newPage[0] || (newPage.attr('data-role') !== 'listmenu') || newPage.parents().index(this.host) < 0) {
                throw new Error('Invalid newPage. The chosen newPage is not listmenu or it\'s not part of the selected jqxListMenu hierarchy.');
            }
            if (this._currentPage[0] == newPage[0]) return;
            this._changePage(this._currentPage, newPage, this.animationDuration);
        },

        _changePage: function (oldPage, newPage, duration, back) {
            if (!this._lock) {
                var changeMethod = '_' + this.animationType + 'Change' + (back ? 'Back' : '');
                if (newPage[0]) {
                    if (this.showFilter) {
                        if (newPage.find('div[data-role="content"]').length > 0) {
                            $.each(newPage.find('li'), function () {
                                if ($(this).data('role') === 'separator') {
                                    $(this).hide();
                                }
                            });
                            this._filterBar.css('display', 'none');
                        }
                        else {
                            this._filterBar.css('display', 'block');
                        }
                    }

                    this._lock = true;
                    this[changeMethod](oldPage, newPage, this.animationDuration, function () {
                        this._lock = false;
                        this._changeHeader(newPage);
                        this._currentPage = newPage;
                    });
                }
            }
        },

        _changeHeader: function (page) {
            var header = $(page).find('li[data-role="header"]').first();
            if (header[0]) {
                var self = this;
                this._headerLabel.fadeOut(this.headerAnimationDuration / 2, function () {
                    self._headerLabel.html(header.html());
                    self._headerLabel.fadeIn(self.headerAnimationDuration / 2);
                });
            }
        },

        _slideChange: function (oldPage, newPage, duration, callback) {
            var self = this;
            if (this.enableScrolling && this.panel != null) {
                this.panel.jqxPanel('scrollTo', 0, 0);
            }
            var rtl = this.rtl;
       
            this._initSlide(oldPage, newPage);
            if (!rtl) {
                oldPage.animate({ 'margin-left': -oldPage.width() - parseInt(oldPage.css('margin-right'), 10) || 0 }, duration, 'easeInOutSine');
                newPage.animate({ 'margin-left': 0 }, duration, 'easeInOutSine', function () {
                    self._slideEnd(oldPage, newPage);
                    callback.call(self, $(this));
                });
            }
            else {
                oldPage.animate({ 'margin-left': oldPage.width() + parseInt(oldPage.css('margin-right'), 10) || 0 }, duration, 'easeInOutSine');
                newPage.animate({ 'margin-left': 0 }, duration, 'easeInOutSine', function () {
                    self._slideEnd(oldPage, newPage);
                    callback.call(self, $(this));
                });
            }
        },

        _initSlide: function (oldPage, newPage) {
            //     this.host.height(Math.max(oldPage.outerHeight(true), newPage.outerHeight(true)) + this._filterBar.outerHeight(true) + this._header.outerHeight(true));
            var rtl = this.rtl;

            oldPage.width(oldPage.width());
            newPage.css({
                marginTop: -(oldPage.outerHeight(true)),
                marginLeft: !rtl ? oldPage.width() + (parseInt(oldPage.css('margin-right'), 10) || 0) : -oldPage.width() - (parseInt(oldPage.css('margin-right'), 10) || 0),
                display: 'block',
                height: 'auto',
                width: oldPage.width()
            });
        },

        _slideEnd: function (oldPage, newPage) {
            this.host.css('height', 'auto');
            oldPage.css({
                display: 'none',
                width: 'auto',
                height: 'auto',
                marginTop: 0,
                marginLeft: 0
            });
            newPage.css({
                marginTop: 0,
                marginLeft: 0,
                height: 'auto',
                width: 'auto',
                display: 'block'
            });
        },

        _slideChangeBack: function (oldPage, newPage, duration, callback) {
            var self = this;
            this._initSlideBack(oldPage, newPage);
            oldPage.animate({ 'margin-left': !this.rtl ? oldPage.width() + parseInt(oldPage.css('margin-right'), 10) || 0 : -oldPage.width() - parseInt(oldPage.css('margin-right'), 10) || 0 }, duration);
            newPage.animate({ 'margin-left': 0 }, duration, function () {
                self._slideEnd(oldPage, newPage);
                callback.call(self, $(this));
            });
        },

        _initSlideBack: function (oldPage, newPage) {
            //     this.host.height(Math.max(oldPage.outerHeight(true), newPage.outerHeight(true)) + this._filterBar.outerHeight(true) + this._header.outerHeight(true));
            oldPage.css({
                marginTop: -(newPage.outerHeight(true)),
                width: oldPage.width()
            });
            newPage.css({
                width: oldPage.width(),
                marginLeft: !this.rtl ? -oldPage.width() - parseInt(oldPage.css('margin-right'), 10) || 0 : oldPage.width() + parseInt(oldPage.css('margin-right'), 10) || 0,
                display: 'block',
                height: 'auto'
            });
        },

        _fadeChangeBack: function (oldPage, newPage, duration, callback) {
            this._fadeChange(oldPage, newPage, duration, callback);
        },

        _fadeChange: function (oldPage, newPage, duration, callback) {
            var self = this;
            oldPage.fadeOut(duration / 2, function () {
                newPage.fadeIn(duration / 2, function () {
                    callback.call(self, $(this));
                });
            });
        },

        _removeClasses: function () {
            this._filterBar.removeClass(this.toThemeProperty('jqx-listmenu-filter'));
            this._filterBar.removeClass(this.toThemeProperty('jqx-widget-header'));
            this._filterInput.removeClass(this.toThemeProperty('jqx-listmenu-filter-input'));
            this._filterInput.removeClass(this.toThemeProperty('jqx-input'));
            this._header.removeClass(this.toThemeProperty('jqx-listmenu-header'));
            this._header.removeClass(this.toThemeProperty('jqx-widget-header'));
            this._header.removeClass(this.toThemeProperty('jqx-rc-t'));
            if (this.roundedCorners) {
                this.host.removeClass(this.toThemeProperty('jqx-rc-all'));
            }
            this.host.removeClass(this.toThemeProperty('jqx-widget'));
            this.host.removeClass(this.toThemeProperty('jqx-listmenu-widget'));
            this.host.removeClass(this.toThemeProperty('jqx-fill-state-normal'));
            this.host.removeClass(this.toThemeProperty('jqx-reset'));
            if (this.host.find('div[data-role="content"]').length > 0) {
                this.host.find('div[data-role="content"]').removeClass(this.toThemeProperty('jqx-widget-content'));
            }
        },

        _addClasses: function () {
            if (this.roundedCorners) {
                this.host.addClass(this.toThemeProperty('jqx-rc-all'));
            }
            else {
                this.host.removeClass(this.toThemeProperty('jqx-rc-all'));
            }
            this.host.addClass('jqx-widget');
            this.host.addClass('jqx-listmenu-widget');
            this.host.addClass('jqx-fill-state-normal');
            this.host.addClass('jqx-reset');
            this._filterBar.addClass(this.toThemeProperty('jqx-listmenu-filter'));
            this._filterBar.addClass(this.toThemeProperty('jqx-widget-header'));
            this._filterInput.addClass(this.toThemeProperty('jqx-listmenu-filter-input'));
            this._filterInput.addClass(this.toThemeProperty('jqx-input'));
            this._header.addClass(this.toThemeProperty('jqx-listmenu-header'));
            this._header.addClass(this.toThemeProperty('jqx-widget-header'));
            this._header.addClass(this.toThemeProperty('jqx-rc-t'));
            if (this.host.find('div[data-role="content"]').length > 0) {
                this.host.find('div[data-role="content"]').addClass(this.toThemeProperty('jqx-widget-content'));
            }
        },

        _raiseEvent: function () {

        },

        _filter: function (searchValue) {
            var els = this.host.find('.jqx-listmenu-item');
            for (var i = 0; i < els.length; i += 1) {
                var value = $.trim($(els[i]).text());
                if (!this.filterCallback(value, searchValue)) {
                    els[i].style.display = 'none';
                } else {
                    els[i].style.display = 'block';
                }
            }
            var els = this.host.find('.jqx-listmenu-separator');
            for (var i = 0; i < els.length; i += 1) {
                var hasVisibleItems = false;
                $.each(els[i].items, function () {
                    if ($(this).css('display') != 'none') {
                        hasVisibleItems = true;
                        return false;
                    }
                });
                if (!hasVisibleItems) {
                    els[i].style.display = 'none';
                }
                else {
                    els[i].style.display = 'block';
                }
            }
        },

        disable: function () {
            this.host.addClass(this.toThemeProperty('jqx-fill-state-disabled'));
            this.disabled = true;
        },

        enable: function () {
            this.host.removeClass(this.toThemeProperty('jqx-fill-state-disabled'));
            this.disabled = false;
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (key == 'disabled') {
                if (value)
                    object.disable();
                else object.enable();
            }

            if (key === 'backLabel') {
                object._backButton.html(value);
                return;
            } else if (key === 'placeHolder') {
                object._filterInput.attr('placeholder', value);
            } else if ((/(showFilter|showHeader|showBackButton|width|height|autoSeparators|readOnly)/).test(key)) {
                object._render();
                return;
            }
        }
    });

} (jQuery));﻿try {
    (function ($, ko) {
        ko.jqwidgets = ko.jqwidgets || {};

        ko.jqwidgets.knockout = function (settings) {
            var me = this;
            var binding = {},
            name = settings.name;

            binding.init = function (element, valueAccessor, allBindingAccessor, viewModel) {
                var unwrappedValue = ko.utils.unwrapObservable(valueAccessor());
                var modelOptions = ko.toJS(unwrappedValue);

                if (settings['reset']) {
                    settings['reset']();
                }
                if ($.data(element)[name] == undefined) {
                    var options = [];
                    $(element)[name]();
                    widget = $.data(element)[name].instance;
                    $.each(settings, function (name, value) {
                        if (widget.hasOwnProperty(name) && modelOptions.hasOwnProperty(name)) {
                            if (!widget["koupdating"]) {
                                widget["koupdatingFromObservable"] = true;
                                try {
                                    var serialized = false;
                                    if (settings.serialize) {
                                        if (settings.serialize(widget, name)) {
                                            if (ko.toJSON(modelOptions[name]) != ko.toJSON(settings.serialize(widget, name))) {
                                                settings.setProperty(widget, name, widget[name], modelOptions[name]);
                                            }
                                            serialized = true;
                                        }
                                    }

                                    if (!serialized) {
                                        if (ko.toJSON(modelOptions[name]) != ko.toJSON(widget[name])) {
                                            settings.setProperty(widget, name, widget[name], modelOptions[name]);
                                        }
                                    }
                                }
                                catch (error) {
                                    settings.setProperty(widget, name, widget[name], modelOptions[name]);
                                }
                                options[name] = name;
                                widget["koupdatingFromObservable"] = false;
                            }
                        }
                    });
                    var widgetSettings = {};
                    $.each(modelOptions, function (name, value) {
                        if (options[name] == undefined) {
                            widgetSettings[name] = modelOptions[name];
                        }
                    });
                    widget.host[name](widgetSettings);
                }
                widget = $.data(element)[name].instance;
                widget["koupdatingFromObservable"] = false;
                widget["koupdating"] = false;

                if (settings.events) {
                    $.each(settings.events, function () {
                        var eventName = this;
                        $(element).on(eventName + '.' + element.id, function (event) {
                            widget = $.data(element)[name].instance;
                            if (!widget["koupdatingFromObservable"]) {
                                var widgetToUpdate = widget;
                                widgetToUpdate["koupdating"] = true;
                                var val = valueAccessor();
                                var property = settings.getProperty(widget, event, eventName, unwrappedValue);
                                if (property != undefined) {
                                    if (val.hasOwnProperty(property.name) && $.isFunction(val[property.name])) {
                                        if (ko.isObservable(val[property.name]) && val[property.name].push) {
                                            valueAccessor(property.value);
                                        }
                                        else {
                                            val[property.name](property.value);
                                        }
                                    }
                                    else if (val[property.name]) {
                                        valueAccessor(property.value);
                                    }
                                }
                                widgetToUpdate["koupdating"] = false;
                            }
                        });
                    });
                }
            };

            binding.update = function (element, valueAccessor, allBindingAccessor, viewModel, bindingContext) {
                var unwrappedValue = ko.utils.unwrapObservable(valueAccessor());
                var modelOptions = ko.toJS(unwrappedValue);
                widget = $.data(element)[name].instance;
                if (widget["koupdating"])
                    return;

                $.each(settings, function (name, value) {
                    if (widget.hasOwnProperty(name) && modelOptions.hasOwnProperty(name)) {
                        if (!widget["koupdating"]) {
                            widget["koupdatingFromObservable"] = true;
                            var serialized = false;
                            if (settings.serialize) {
                                if (settings.serialize(widget, name)) {
                                    if (ko.toJSON(modelOptions[name]) != ko.toJSON(settings.serialize(widget, name))) {
                                        settings.setProperty(widget, name, widget[name], modelOptions[name]);
                                    }
                                    serialized = true;
                                }
                            }

                            if (!serialized) {
                                if (ko.toJSON(modelOptions[name]) != ko.toJSON(widget[name])) {
                                    settings.setProperty(widget, name, widget[name], modelOptions[name]);
                                }
                            }
                            widget["koupdatingFromObservable"] = false;
                        }
                    }
                });
            };

            ko.bindingHandlers[settings.name] = binding;
        };

        // jqxGauge
        var jqxGauge = new ko.jqwidgets.knockout({
            name: "jqxGauge",
            disabled: false,
            min: 0,
            max: 220,
            value: 0,
            reset: function () {
                this.value = 0;
                this.max = 220;
                this.min = 0;
                this.disabled = false;
            },
            getProperty: function (object, event, eventName) {
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'disabled') {
                    object.host.jqxGauge({ disabled: newValue });
                }
                if (key == 'min') {
                    object.host.jqxGauge({ min: newValue });
                }
                if (key == 'max') {
                    object.host.jqxGauge({ max: newValue });
                }
                if (key == 'value') {
                    object.host.jqxGauge({ value: newValue });
                }
            }
        });

        // jqxLinearGauge
        var jqxLinearGauge = new ko.jqwidgets.knockout({
            name: "jqxLinearGauge",
            disabled: false,
            min: 0,
            max: 220,
            value: 0,
            reset: function () {
                this.value = 0;
                this.max = 220;
                this.min = 0;
                this.disabled = false;
            },
            getProperty: function (object, event, eventName) {
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'disabled') {
                    object.host.jqxLinearGauge({ disabled: newValue });
                }
                if (key == 'min') {
                    object.host.jqxLinearGauge({ min: newValue });
                }
                if (key == 'max') {
                    object.host.jqxLinearGauge({ max: newValue });
                }
                if (key == 'value') {
                    object.host.jqxLinearGauge({ value: newValue });
                }
            }
        });

        // jqxSlider
        var jqxSlider = new ko.jqwidgets.knockout({
            name: "jqxSlider",
            disabled: false,
            min: 0,
            max: 10,
            value: 0,
            reset: function () {
                this.value = 0;
                this.max = 10;
                this.min = 0;
                this.disabled = false;
            },
            events: ['change'],
            getProperty: function (object, event, eventName) {
                if (eventName == 'change') {
                    return { name: "value", value: event.args.value };
                }
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'disabled') {
                    object.host.jqxSlider({ disabled: newValue });
                }
                if (key == 'min') {
                    object.host.jqxSlider({ min: parseFloat(newValue) });
                }
                if (key == 'max') {
                    object.host.jqxSlider({ max: parseFloat(newValue) });
                }
                if (key == 'value') {
                    object.host.jqxSlider({ value: parseFloat(newValue) });
                }
            }
        });

        // jqxScrollBar
        var jqxScrollBar = new ko.jqwidgets.knockout({
            name: "jqxScrollBar",
            disabled: false,
            min: 0,
            max: 10,
            value: 0,
            reset: function () {
                this.value = 0;
                this.max = 10;
                this.min = 0;
                this.disabled = false;
            },
            events: ['valuechanged'],
            getProperty: function (object, event, eventName) {
                if (eventName == 'valuechanged') {
                    return { name: "value", value: parseInt(event.currentValue) };
                }
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'disabled') {
                    object.host.jqxScrollBar({ disabled: newValue });
                }
                if (key == 'min') {
                    object.host.jqxScrollBar({ min: parseFloat(newValue) });
                }
                if (key == 'max') {
                    object.host.jqxScrollBar({ max: parseFloat(newValue) });
                }
                if (key == 'value') {
                    object.host.jqxScrollBar({ value: parseFloat(newValue) });
                }
            }
        });

        // jqxProgressBar
        var jqxProgressBar = new ko.jqwidgets.knockout({
            name: "jqxProgressBar",
            disabled: false,
            value: 0,
            reset: function () {
                this.value = 0;
                this.disabled = false;
            },
            events: ['valuechanged'],
            getProperty: function (object, event, eventName) {
                if (eventName == 'valuechanged') {
                    return { name: "value", value: parseInt(event.currentValue) };
                }
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'disabled') {
                    object.host.jqxProgressBar({ disabled: newValue });
                }
                if (key == 'value') {
                    object.host.jqxProgressBar({ value: parseFloat(newValue) });
                }
            }
        });
        // jqxButton
        var jqxButton = new ko.jqwidgets.knockout({
            name: "jqxButton",
            disabled: false,
            reset: function () {
                this.disabled = false;
            },
            getProperty: function (object, event, eventName) {
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'disabled') {
                    object.host.jqxButton({ disabled: newValue });
                }
            }
        });

        // jqxCheckBox
        var jqxCheckBox = new ko.jqwidgets.knockout({
            name: "jqxCheckBox",
            checked: false,
            disabled: false,
            reset: function () {
                this.checked = false;
                this.disabled = false;
            },
            events: ['change'],
            getProperty: function (object, event, eventName) {
                if (eventName == 'change') {
                    return { name: "checked", value: event.args.checked };
                }
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'disabled') {
                    object.host.jqxCheckBox({ disabled: newValue });
                }
                if (key == 'checked') {
                    if (value != newValue) {
                        object.host.jqxCheckBox({ checked: newValue });
                    }
                }
            }
        });

        // jqxRadioButton
        var jqxRadioButton = new ko.jqwidgets.knockout({
            name: "jqxRadioButton",
            checked: false,
            disabled: false,
            reset: function () {
                this.checked = false;
                this.disabled = false;
            },
            events: ['change'],
            getProperty: function (object, event, eventName) {
                if (eventName == 'change') {
                    return { name: "checked", value: event.args.checked };
                }
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'disabled') {
                    object.host.jqxRadioButton({ disabled: newValue });
                }
                if (key == 'checked') {
                    if (value != newValue) {
                        object.host.jqxRadioButton({ checked: newValue });
                    }
                }
            }
        });

        // jqxDateTimeInput
        var jqxDateTimeInput = new ko.jqwidgets.knockout({
            name: "jqxDateTimeInput",
            value: null,
            disabled: false,
            reset: function () {
                this.value = null;
                this.disabled = false;
            },
            events: ['valuechanged'],
            getProperty: function (object, event, eventName) {
                if (eventName == 'valuechanged') {
                    return { name: "value", value: event.args.date };
                }
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'value') {
                    object.setDate(newValue);
                }
                if (key == 'disabled') {
                    object.host.jqxDateTimeInput({ disabled: newValue });
                }
            }
        });

        // jqxCalendar
        var jqxCalendar = new ko.jqwidgets.knockout({
            name: "jqxCalendar",
            value: null,
            disabled: false,
            reset: function () {
                this.value = null;
                this.disabled = false;
            },
            events: ['valuechanged'],
            getProperty: function (object, event, eventName) {
                if (eventName == 'valuechanged') {
                    return { name: "value", value: event.args.date };
                }
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'value') {
                    object.setDate(newValue);
                }
                if (key == 'disabled') {
                    object.host.jqxCalendar({ disabled: newValue });
                }
            }
        });

        // jqxNumberInput
        var jqxNumberInput = new ko.jqwidgets.knockout({
            name: "jqxNumberInput",
            value: null,
            events: ['valuechanged'],
            disabled: false,
            reset: function () {
                this.value = null;
                this.disabled = false;
            },
            getProperty: function (object, event, eventName) {
                if (eventName == 'valuechanged') {
                    return { name: "value", value: object.val() };
                }
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'value') {
                    object.host.jqxNumberInput('val', newValue);
                }
                if (key == 'disabled') {
                    object.host.jqxNumberInput({ disabled: newValue });
                }
            }
        });

        // jqxMaskedInput
        var jqxMaskedInput = new ko.jqwidgets.knockout({
            name: "jqxMaskedInput",
            value: null,
            events: ['valuechanged'],
            disabled: false,
            reset: function () {
                this.value = null;
                this.disabled = false;
            },
            getProperty: function (object, event, eventName) {
                if (eventName == 'valuechanged') {
                    return { name: "value", value: object.val() };
                }
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'value') {
                    object.host.jqxMaskedInput('val', newValue);
                }
                if (key == 'disabled') {
                    object.host.jqxMaskedInput({ disabled: newValue });
                }
            }
        });

        // jqxListBox
        var jqxListBox = new ko.jqwidgets.knockout({
            name: "jqxListBox",
            source: null,
            disabled: false,
            selectedIndex: -1,
            reset: function () {
                this.disabled = false;
                this.selectedIndex = -1;
                this.source = null;
            },
            events: ['change'],
            getProperty: function (object, event, eventName) {
                if (eventName == 'change') {
                    this.selectedIndex = object.selectedIndex;
                    return { name: 'selectedIndex', value: object.selectedIndex };
                }

            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'source') {
                    object.source = newValue;
                    object.refresh();
                }
                if (key == 'disabled') {
                    object.disabled = newValue;
                    object._renderItems();
                }
                if (key == 'selectedIndex') {
                    var disabled = object.disabled;
                    object.disabled = false;
                    object.selectIndex(newValue);
                    object.disabled = disabled;
                    if (disabled) object._renderItems();
                }
            }
        });
        //jqxDropDownList
        var jqxDropDownList = new ko.jqwidgets.knockout({
            name: "jqxDropDownList",
            source: null,
            disabled: false,
            selectedIndex: -1,
            reset: function () {
                this.disabled = false;
                this.selectedIndex = -1;
                this.source = null;
            },
            events: ['change'],
            getProperty: function (object, event, eventName) {
                if (eventName == 'change') {
                    return { name: 'selectedIndex', value: object.selectedIndex };
                }
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'source') {
                    object.host.jqxDropDownList({ source: newValue });
                }
                if (key == 'disabled') {
                    object.host.jqxDropDownList({ disabled: newValue });
                }
                if (key == 'selectedIndex') {
                    object.host.jqxDropDownList({ selectedIndex: newValue });
                }
            }
        });

        //jqxComboBox
        var jqxComboBox = new ko.jqwidgets.knockout({
            name: "jqxComboBox",
            source: null,
            disabled: false,
            selectedIndex: -1,
            reset: function () {
                this.disabled = false;
                this.selectedIndex = -1;
                this.source = null;
            },
            events: ['change'],
            getProperty: function (object, event, eventName) {
                if (eventName == 'change') {
                    return { name: 'selectedIndex', value: object.selectedIndex };
                }
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'source') {
                    object.host.jqxComboBox({ source: newValue });
                }
                if (key == 'disabled') {
                    object.host.jqxComboBox({ disabled: newValue });
                }
                if (key == 'selectedIndex') {
                    object.host.jqxComboBox({ selectedIndex: newValue });
                }
            }
        });

        //jqxInput
        var jqxInput = new ko.jqwidgets.knockout({
            name: "jqxInput",
            source: null,
            disabled: false,
            value: "",
            reset: function () {
                this.disabled = false;
                this.source = null;
            },
            events: ['change'],
            getProperty: function (object, event, eventName) {
                if (eventName == 'change') {
                    return { name: 'value', value: object.host.val() };
                }
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'source') {
                    object.host.jqxInput({ source: newValue });
                }
                if (key == 'disabled') {
                    object.host.jqxInput({ disabled: newValue });
                }
                if (key == 'value') {
                    object.host.jqxInput({ value: newValue });
                }
            }
        });

        //jqxTree
        var jqxTree = new ko.jqwidgets.knockout({
            name: "jqxTree",
            source: null,
            disabled: false,
            reset: function () {
                this.disabled = false;
                this.source = null;
            },
            getProperty: function (object, event, eventName) {
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'source') {
                    object.host.jqxTree({ source: newValue });
                }
                if (key == 'disabled') {
                    object.host.jqxTree({ disabled: newValue });
                }
            }
        });

        //jqxTabs
        var jqxTabs = new ko.jqwidgets.knockout({
            name: "jqxTabs",
            disabled: false,
            reset: function () {
                this.disabled = false;
            },
            getProperty: function (object, event, eventName) {
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'disabled') {
                    object.host.jqxTabs({ disabled: newValue });
                }
            }
        });

        //jqxWindow
        var jqxWindow = new ko.jqwidgets.knockout({
            name: "jqxWindow",
            disabled: false,
            content: "",
            title: "",
            reset: function () {
                this.disabled = false;
                this.title = "";
                this.content = "";
            },
            getProperty: function (object, event, eventName) {
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'disabled') {
                    object.host.jqxWindow({ disabled: newValue });
                }
                else if (key == 'content') {
                    object.host.jqxWindow('setContent', newValue );
                }
                else if (key == 'title') {
                    object.host.jqxWindow({ title: newValue });
                }
            }
        });

        //jqxNavigationBar
        var jqxNavigationBar = new ko.jqwidgets.knockout({
            name: "jqxNavigationBar",
            disabled: false,
            reset: function () {
                this.disabled = false;
            },
            getProperty: function (object, event, eventName) {
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'disabled') {
                    if (newValue != this.disabled) {
                        this.disabled = newValue;
                        object.host.jqxNavigationBar({ disabled: newValue });
                    }
                }
            }
        });

        //jqxMenu
        var jqxMenu = new ko.jqwidgets.knockout({
            name: "jqxMenu",
            source: null,
            disabled: false,
            reset: function () {
                this.disabled = false;
                this.source = null;
            },
            getProperty: function (object, event, eventName) {
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'source') {
                    object.host.jqxMenu({ source: newValue });
                }
                if (key == 'disabled') {
                    object.host.jqxMenu({ disabled: newValue });
                }
            }
        });

        //jqxChart
        var jqxChart = new ko.jqwidgets.knockout({
            name: "jqxChart",
            source: null,
            disabled: false,
            reset: function () {
                this.disabled = false;
                this.source = null;
            },
            getProperty: function (object, event, eventName) {
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'source') {
                    this.source = newValue;
                    object.host.jqxChart({ source: newValue });
                }
                if (key == 'disabled') {
                    this.disabled = newValue;
                    object.host.jqxChart({ disabled: newValue });
                }
            }
        });

        //jqxGrid
        var jqxGrid = new ko.jqwidgets.knockout({
            name: "jqxGrid",
            source: null,
            disabled: false,
            selectedRowIndex: -1,
            reset: function () {
                this.disabled = false;
                this.source = null;
                this.selectedRowIndex = -1;
            },
            serialize: function (object, propertyName) {
                if (propertyName == "source") {
                    if (object.source && object.source._source) {
                        return object.source.records;
                    };
                }
                return false;
            },
            events: ['cellvaluechanged', 'cellselect', 'rowselect'],
            getProperty: function (object, event, eventName, modelOptions) {
                if (eventName == 'cellvaluechanged') {
                    var rowId = object.host.jqxGrid("getrowid", event.args.rowindex);
                    var rowdata = object.host.jqxGrid("getrowdata", rowId);
                    var source = modelOptions['source'];
                    if (source != undefined) {
                        var updateObj = {};
                        var oldObj = {};
                        var hasObservable = false;
                        var hasComputed = false;
                        $.each(source()[rowId], function (index, value) {
                            updateObj[index] = value;
                            oldObj[index] = "";
                            if (ko.isObservable(value) && !ko.isComputed(value)) {
                                hasObservable = true;
                                value(rowdata[index]);
                            }
                            if (ko.isObservable(value) && ko.isComputed(value)) {
                                hasComputed = true;
                            }
                        });

                        if (!hasObservable) {
                            updateObj = rowdata;
                            source.replace(source()[rowId], oldObj);
                            source.replace(source()[rowId], updateObj);
                        }
                        else {
                            source.replace(source()[rowId], updateObj);
                        }
                        if (hasComputed) {
                            object.host.jqxGrid("updaterow", rowId, ko.toJS(source)[rowId]);
                        }

                        return { name: 'source', value: source };
                    }
                }
            },
            setProperty: function (object, key, value, newValue) {
                if (key == 'selectedRowIndex') {
                    object.host.jqxGrid('selectrow', newValue);
                }
                if (key == 'source') {
                    if (this.source == null || newValue == null) {
                        if (this.source != newValue) {
                            this.source = newValue;
                            var source = {
                                localdata: newValue,
                                datatype: 'local'
                            }

                            var dataAdapter = new $.jqx.dataAdapter(source);
                            object.host.jqxGrid({ source: dataAdapter });
                        }
                    }
                    else {
                        var source = {
                            localdata: newValue,
                            datatype: 'local'
                        }

                        var dataAdapter = new $.jqx.dataAdapter(source);
                        dataAdapter.dataBind();

                        if (!value.records || !dataAdapter.records) return;


                        var itemsLength = Math.max(value.records.length, dataAdapter.records.length);
                        var changedRecords = Math.abs(value.records.length - dataAdapter.records.length);
                        if (changedRecords == 0) {
                            if (itemsLength > 10) {
                                object.host.jqxGrid({ source: dataAdapter });
                                return;
                            }
                        }
                        if (changedRecords > 1) {
                            object.host.jqxGrid("beginupdate");
                        }

                        var recordstodelete = new Array();
                        for (var i = 0; i < itemsLength; i++) {
                            var record = dataAdapter.records[i];
                            if (record == undefined) {
                                var rowId = object.host.jqxGrid("getrowid", i);
                                recordstodelete.push(rowId);
                            }
                            else {
                                var update = value.records[i] != undefined;
                                if (update) {
                                    if (ko.toJSON(record) != ko.toJSON(value.records[i])) {
                                        if (value.records[i].uid != undefined) {
                                            record.uid = value.records[i].uid;
                                            if (ko.toJSON(record) == ko.toJSON(value.records[i])) {
                                                continue;
                                            }
                                        }

                                        var rowId = object.host.jqxGrid("getrowid", i);
                                        object.host.jqxGrid("updaterow", rowId, record);
                                    }
                                }
                                else {
                                    object.host.jqxGrid("addrow", null, record);
                                }
                            }
                        }
                        if (recordstodelete.length > 0) {
                            object.host.jqxGrid("deleterow", recordstodelete);
                        }
                        if (changedRecords > 1) {
                            object.host.jqxGrid("endupdate");
                        }
                    }
                }
                if (key == 'disabled') {
                    object.host.jqxGrid({ disabled: newValue });
                }
            }
        });
    }(jQuery, ko));
}
catch (error) {
    var er = error;
}(function ($) {

    var instanceCounter = 0;

    $.jqx.jqxWidget('jqxScrollView', '', {});

    $.extend($.jqx._jqxScrollView.prototype, {

        defineInstance: function () {
            this.width = 320;
            this.height = 320;
            this.buttonsOffset = [0, 0];
            this.moveThreshold = 0.5;
            this.currentPage = 0;
            this.animationDuration = 300;
            this.showButtons = true;
            this.bounceEnabled = true;
            this.slideShow = false;
            this.slideDuration = 3000;
            this.disabled = false;
            this._mouseDown = false;
            this._movePermited = false;
            this._startX = -1;
            this._startOffset = -1;
            this._lastOffset = -1;
            this._events = ['pageChanged'];
            this._eventsMap = {
                'mousedown': $.jqx.mobile.getTouchEventName('touchstart'),
                'mouseup': $.jqx.mobile.getTouchEventName('touchend'),
                'mousemove': $.jqx.mobile.getTouchEventName('touchmove')
            };
        },

        createInstance: function () {
            instanceCounter += 1;
            this._instanceId = instanceCounter;
            this._isTouchDevice = $.jqx.mobile.isTouchDevice();
            var me = this;
            $.jqx.utilities.resize(this.host, function () {
                me.refresh();
            });
        },

        //Widget handling (rendering, attaching events, layout)
        refresh: function () {
            this.host.width(this.width);
            this.host.height(this.height);

            this._render();
            this._performLayout();
            if (this.moveThreshold.toString().indexOf('%') >= 0) {
                this.moveThreshold = parseInt(this.moveThreshold, 10) / 100;
            }
            this._refreshPages();
            this._refreshButtons();
            this._removeEventListeners();
            this._addEventListeners();
            this._changePage(this.currentPage, false, 0);
            if (this.slideShow) {
                var me = this;
                this.slideShowTimer = setInterval(function () {
                    if (me.currentPage >= me._pages.length - 1) {
                        me._changePage(0, true, me.animationDuration);
                    }
                    else {
                        me._changePage(me.currentPage + 1, true, me.animationDuration);
                    }
                }, this.slideDuration);
            }
            else {
                if (this.slideShowTimer != undefined) {
                    clearInterval(this.slideShowTimer);
                }
            }
        },

        destroy: function () {
            this.host.remove();
        },

        _getEvent: function (event) {
            if (this._isTouchDevice) {
                return this._eventsMap[event];
            }
            return event;
        },

        _eventNamespace: function () {
            return '.scrollview' + this._instanceId;
        },

        _removeEventListeners: function () {
            this.removeHandler(this._innerWrapper);
            this.removeHandler(this.host, this._getEvent('mousemove') + this._eventNamespace());
            this.removeHandler($(document), this._getEvent('mouseup') + this._eventNamespace());
        },

        _getCoordinate: function (event, property) {
            if (this._isTouchDevice) {
                if (event.originalEvent.touches) {
                    return event.originalEvent.touches[0][property];
                }
            }
            return event[property];
        },

        _draggedRight: function () {
            if (this.currentPage > 0) {
                var page = this.currentPage - 1,
                    currentPage = $(this._pages[page]),
                    pageRight = currentPage.offset().left + currentPage.outerWidth(),
                    diff = pageRight - this.host.offset().left;
                if (diff >= (this.host.width() * this.moveThreshold)) {
                    this.changePage(page);
                    return true;
                }
            }
            return false;
        },

        _draggedLeft: function () {
            if (this.currentPage + 1 < this._pages.length) {
                var page = this.currentPage + 1,
                    currentPage = $(this._pages[page]),
                    diff = this.host.width() - (currentPage.offset().left - this.host.offset().left);
                if (diff >= (this.host.width() * this.moveThreshold)) {
                    this.changePage(page);
                    return true;
                }
            }
            return false;
        },

        _dropTarget: function () {
            var changed;
            if (this._movedLeft) {
                changed = this._draggedLeft();
            } else {
                changed = this._draggedRight();
            }
            if (!changed) {
                this.changePage(this.currentPage, false);
            }
        },

        _scrollEnabled: function (e) {
            if (!this._mouseDown) {
                return false;
            }
            if (!this._movePermited) {
                if (this._isTouchDevice || Math.abs(this._getCoordinate(e, 'pageX') - this._startX) >= 5) {
                    this._movePermited = true;
                }
            }
            return this._movePermited;
        },

        _setMoveDirection: function (offset) {
            if (this._lastOffset > offset) {
                this._movedLeft = true;
            } else {
                this._movedLeft = false;
            }
        },

        _getBounceOffset: function (offset) {
            var minOffset = -(this._innerWrapper.width() - this.host.width());
            if (offset > 0) {
                offset = 0;
            } else if (offset < minOffset) {
                offset = minOffset;
            }
            return offset;
        },

        _addEventListeners: function () {
            var self = this;
            this.addHandler(this._innerWrapper, this._getEvent('mousedown') + this._eventNamespace(), function (e) {
                self._mouseDown = true;
                self._startX = self._getCoordinate(e, 'pageX');
                self._startOffset = self._lastOffset = parseInt(self._innerWrapper.css('margin-left'), 10);
            });
            this.addHandler(this.host, 'dragstart', function () {
                return false;
            });
            this.addHandler(this.host, this._getEvent('mousemove') + this._eventNamespace(), function (e) {
                if (self._scrollEnabled(e)) {
                    var offset = self._startOffset + self._getCoordinate(e, 'pageX') - self._startX;
                    if (!self.bounceEnabled) {
                        offset = self._getBounceOffset(offset);
                    }
                    self._innerWrapper.css('margin-left', offset);
                    self._setMoveDirection(offset);
                    self._lastOffset = offset;
                    e.preventDefault();
                    return false;
                }
                return true;
            });
            this.addHandler($(document), this._getEvent('mouseup') + this._eventNamespace(), function (e) {
                if (self._movePermited) {
                    self._dropTarget();
                }
                self._movePermited = false;
                self._mouseDown = false;
            });
            
            try
            {
                if (document.referrer != "" || window.frameElement) {
                    if (window.top != null) {
                        if (window.parent && document.referrer) {
                            parentLocation = document.referrer;
                        }
                    }

                    if (parentLocation.indexOf(document.location.host) != -1) {
                        var eventHandle = function (event) {
                            if (self._movePermited) {
                                self._dropTarget();
                            }
                            self._movePermited = false;
                            self._mouseDown = false;
                        };

                        if (window.top.document.addEventListener) {
                            window.top.document.addEventListener('mouseup', eventHandle, false);

                        } else if (window.top.document.attachEvent) {
                            window.top.document.attachEvent("on" + 'mouseup', eventHandle);
                        }
                    }                      
                }
            }
            catch (error) {
            }
        },

        _render: function () {
            this.host.addClass(this.toThemeProperty('jqx-scrollview'));
            this.host.css({
                overflow: 'hidden',
                position: 'relative'
            });
        },

        _performLayout: function () {
            this.host.css({
                width: this.width,
                height: this.height
            });
        },
        //end of the general purpose widget handling

        //Pages handling
        _renderPages: function () {
            if (!this._innerWrapper) {
                this._innerWrapper = $('<div/>');
                this.host.wrapInner(this._innerWrapper);
                this._innerWrapper = this.host.children().first();
            }
            this._innerWrapper.addClass(this.toThemeProperty('jqx-scrollview-inner-wrapper'));
            this._innerWrapper.height(this.host.height());
        },

        _refreshPage: function (page) {
            page.addClass(this.toThemeProperty('jqx-scrollview-page'));
            this._performPageLayout(page);
        },

        _refreshPages: function () {
            var self = this,
                childrenSize = 0;
            this._renderPages();
            this._pages = this._innerWrapper.children();
            this._pages.each(function () {
                self._refreshPage($(this));
                childrenSize += $(this).outerWidth(true);
            });
            this._innerWrapper.width(childrenSize);
        },

        _performPageLayout: function (page) {
            page.css('float', 'left');
            page.width(this.host.width());
            page.height(this.host.height());
        },
        //end of the pages handling

        //Buttons handling
        _refreshButtons: function () {
            this._renderButtons();
            this._removeButtonsEventListeners();
            this._addButtonsEventListeners();
            this._performButtonsLayout();
        },

        //Taking care for memory leaks
        _removeButtonsEventListeners: function () {
            var self = this;
            this._buttonsContainer.children().each(function () {
                self.removeHandler($(this));
            });
        },

        _addButtonsEventListeners: function () {
            var self = this;
            this._buttonsContainer.children().each(function (idx) {
                self.addHandler($(this), 'click', function () {
                    self.changePage(idx);
                });
            });
        },

        _performButtonsLayout: function () {
            var middle = (this.host.width() - this._buttonsContainer.width()) / 2;
            var buttonsHeight = this._buttonsContainer.outerHeight() != 0 ? this._buttonsContainer.outerHeight() : 14;
            this._buttonsContainer.css({
                position: 'absolute',
                left: middle + parseInt(this.buttonsOffset[0], 10),
                top: this.host.height() - 2 * buttonsHeight +
                 parseInt(this.buttonsOffset[1], 10) - 1
            });
        },

        _renderButtons: function () {
            if (this._buttonsContainer) {
                this._buttonsContainer.remove();
            }
            var page, button;
            this._buttons = [];
            this._buttonsContainer = $('<span/>');
            for (var i = 0; i < this._pages.length; i += 1) {
                button = $('<span class="' + this.toThemeProperty('jqx-scrollview-button') + ' ' +
                            this.toThemeProperty('jqx-fill-state-normal') + '"></span>');
                this._buttonsContainer.append(button);
                this._buttons[i] = button;
            }
            this._buttonsContainer.appendTo(this.host);
            if (!this.showButtons) {
                this._buttonsContainer.hide();
            }
        },
        //end of the buttons handling

        _raiseEvent: function (idx, data) {
            var ev = new $.Event(this._events[idx]);
            ev.args = data;
            return this.host.trigger(ev);
        },

        _swapButtons: function (old, newButton) {
            this._buttons[old].removeClass(this.toThemeProperty('jqx-scrollview-button-selected'));
            this._buttons[old].removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
            this._buttons[newButton].addClass(this.toThemeProperty('jqx-scrollview-button-selected'));
            this._buttons[newButton].addClass(this.toThemeProperty('jqx-fill-state-pressed'));
        },

        _changePage: function (index, raiseEvent, duration) {
            if (this.disabled) return;

            var page = $(this._pages[index]),
                margin = (this.host.width() - page.width()) / 2,
                relativeOffset = page.offset().left - this._innerWrapper.offset().left - margin,
                oldPage = this.currentPage,
                self = this;
            if (typeof duration === 'undefined') {
                duration = this.animationDuration;
            }
            this._innerWrapper.stop();
            this._swapButtons(this.currentPage, index);
            this.currentPage = index;
            this._innerWrapper.animate({ marginLeft: -relativeOffset }, duration, function () {
                if (raiseEvent) {
                    self._raiseEvent(0, { currentPage: index, oldPage: oldPage });
                }
            });
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (key === 'currentPage') {
                object.currentPage = oldvalue;
                object.changePage(value);
            } else if ((/(buttonsOffset|width|height)/).test(key)) {
                object.refresh();
            } else if (key === 'showButtons') {
                if (!value) {
                    object._buttonsContainer.css('display', 'none');
                } else {
                    object._buttonsContainer.css('display', 'block');
                }
                return;
            }
            else if (key == 'slideShow') {
                object.refresh();
            }
        },

        //Public methods
        changePage: function (index) {
            if (index >= this._pages.length || index < 0) {
                throw new Error('Invalid index!');
            }
            this._changePage(index, true);
        },

        forward: function () {
            if (this.currentPage + 1 < this._pages.length) {
                this.changePage(this.currentPage + 1);
            }
        },

        back: function () {
            if (this.currentPage - 1 >= 0) {
                this.changePage(this.currentPage - 1);
            }
        }
        //end of the public methods
    });
} (jQuery));(function ($) {

    var instanceCounter = 0;

    $.jqx.jqxWidget('jqxTouch', '', {});

    $.extend($.jqx._jqxTouch.prototype, {

        defineInstance: function () {
            //Defines the minimum swipe distance required by the plugin.
            this.swipeMin = 50;
            //Defines the maximum swipe distance. After it is passed the propagation of the event will be restored, therefore the scrolling will be available.
            this.swipeMax = 500;
            //The swipe delay. After it is passed swipe event won't be fired.
            this.swipeDelay = 1000;
            //The taphold delay. If this delay is passed then taphold event will be fired.
            this.tapHoldDelay = 750;
            //If this vertical distance is passed the swipe event (swapleft/swapright) won't be fired.
            this.swipeMaxVerticalDisance = 100;
            //If the horizontal distance is passed the swipe event (swipetop/swipebottom) won't be fired.
            this.swipeMaxHorizontalDisance = 100;
            //Indicates whether the orientationchange event is enabled.
            this.orientationChangeEnabled = true;

            //private data members
            this._eventsMap = {
                'mousedown': $.jqx.mobile.getTouchEventName('touchstart'),
                'mouseup': $.jqx.mobile.getTouchEventName('touchend'),
                'mousemove': $.jqx.mobile.getTouchEventName('touchmove')
            };
            this._swipeLocked = false;
            this._rotationInterval = 200;
            this._events = ['tap', 'taphold', 'swipe', 'swipeleft', 'swiperight', 'swipetop', 'swipebottom', 'orientationchange'];
            this._instanceId = -1;
        },

        createInstance: function () {
            instanceCounter += 1;
            this._instanceId = instanceCounter;
            this._isTouchDevice = $.jqx.mobile.isTouchDevice();
            this._defineRotateHandler();
        },

        refresh: function () {
            this._removeEventListeners();
            this._addEventListeners();
        },

        _defineRotateHandler: function () {
            var self = this;
            if (!this._rotateHandler) {
                this._rotateHandler = function () {
                    self._checkOrientation();
                }
            }
        },

        _getEvent: function (event) {
            if (this._isTouchDevice) {
                event = this._eventsMap[event];
            }
            return event + this._getEventNamespace();
        },

        _getEventNamespace: function () {
            return '.swipe' + this._instanceId;
        },

        _removeEventListeners: function () {
            clearInterval(this._rotateInterval);
            this.removeHandler($(document), this._getEvent('mouseup'));
            this.removeHandler(this.host, this._getEvent('mousedown'));
            this.removeHandler(this.host, this._getEvent('mousemove'));
            if (window.removeEventListener) {
                window.removeEventListener('resize', this._rotateHandler);
                window.removeEventListener('orientationchange', this._rotateHandler);
            }
        },

        _addEventListeners: function () {
            var self = this;
            this.addHandler(this.host, this._getEvent('mouseup'), function (e) {
                self._resetSwipe();
                self._resetTap();
            });
            this.addHandler(this.host, this._getEvent('mousedown'), function (e) {
                self._initSwipe(e);
                self._initTap(e);
            });
            this.addHandler(this.host, this._getEvent('mousemove'), function (e) {
                self._maxSwipeVerticalDistance = Math.max(self._maxSwipeVerticalDistance, Math.abs(self._startY - self._getCoordinates(e).y));
                self._maxSwipeHorizontalDistance = Math.max(self._maxSwipeHorizontalDistance, Math.abs(self._startX - self._getCoordinates(e).x));
                self._mouseMoved = true;
                return self._handleSwipeEvents(e);
            });
            this._rotationListeners();
        },

        _handleSwipeEvents: function (e) {
            var eventResult = true;
            if (this._mouseDown && !this._tapHoldFired) {
                eventResult = this._handleVerticalSwipeEvents(e);
                eventResult = this._handleHorizontalSwipeEvents(e);
            }
            this._lastPosition = this._getCoordinates(e);
            return eventResult;
        },

        _handleVerticalSwipeEvents: function (e) {
            var current, diff;
            current = this._getCoordinates(e).y;
            diff = current - this._startY;
            if (this._maxSwipeHorizontalDistance < this.swipeMaxHorizontalDisance) {
                return this._swiped(e, diff, 2);
            }
            return true;
        },

        _handleHorizontalSwipeEvents: function (e) {
            var current, diff;
            current = this._getCoordinates(e).x;
            diff = current - this._startX;
            if (this._maxSwipeVerticalDistance < this.swipeMaxVerticalDisance) {
                return this._swiped(e, diff);
            }
            return true;
        },

        _swiped: function (e, diff, direction) {
            direction = direction || 0;
            if (Math.abs(diff) >= this.swipeMin && !this._swipeEvent && !this._swipeLocked) {
                this._swipeEvent = this._getSwipeEvent(diff, direction)
            }
            if (Math.abs(diff) <= this.swipeMax) {
                e.stopImmediatePropagation();
                return false;
            }
            return true;
        },

        _getSwipeEvent: function (diff, direction) {
            var event;
            if (diff < 0) {
                event = { eventId: 3 + direction, data: { target: this.host }};
            } else {
                event = { eventId: 4 + direction, data: { target: this.host }};
            }
            return event;
        },

        _resetSwipe: function () {
            if (this._swipeEvent && !this._swipeLocked) {
                this._raiseEvent(2, this._swipeEvent.data);
                this._raiseEvent(this._swipeEvent.eventId, this._swipeEvent.data);
            }
            clearTimeout(this._swipeTimeout);
            this._mouseDown = false;
        },

        _resetTap: function () {
            clearTimeout(this._tapHoldTimeout);
            if (!this._tapHoldFired && !this._mouseMoved) {
                this._raiseEvent(0, { target: this.host });
            }
        },

        _initTap: function (e) {
            var self = this;
            this._mouseMoved = false;
            this._tapHoldFired = false;
            this._tapHoldTimeout = setTimeout(function () {
                if (!self._mouseMoved) {
                    self._raiseEvent(1, { target: this.host });
                    self._tapHoldFired = true;
                }
            }, this.tapHoldDelay);
        },

        _initSwipe: function (e) {
            var self = this;
            this._mouseDown = true;
            this._maxSwipeVerticalDistance = 0;
            this._maxSwipeHorizontalDistance = 0;
            this._startX = this._getCoordinates(e).x;
            this._startY = this._getCoordinates(e).y;
            this._swipeLocked = false;
            this._swipeEvent = null;
            this._swipeTimeout = setTimeout(function () {
                self._swipeLocked = true;
            }, this.swipeDelay);
        },

        _rotationListeners: function () {
            var self = this;
            this._previousOrientation = window.orientation;
            this._previousWidth = screen.width;
            if (this.orientationChangeEnabled) {
                if (window.addEventListener) {
                    window.addEventListener('resize', this._rotateHandler, false);
                    window.addEventListener('orientationchange', this._rotateHandler, false);
                }
                this._rotateInterval = setInterval(function () {
                    self._checkOrientation();
                }, this._rotationInterval);
            }
        },

        _checkOrientation: function () {
            var orientation = 'vertical';
            if (window.orientation !== this._previousOrientation || this._previousWidth !== screen.width) {
                if (window.orientation === 90 || screen.width > screen.height) {
                    orientation = 'horizontal';
                }
                this._raiseEvent(7, { orientation: orientation });
            }
            this._previousOrientation = window.orientation;
            this._previousWidth = screen.width;
        },

        _raiseEvent: function (eId, args) {
            var event = $.Event(this._events[eId]);
            event.args = args;
            return this.host.trigger(event);
        },

        _getCoordinates: function (e) {
            var c =  $.jqx.position(e);
            c.x = c.left;
            c.y = c.top;
                       
            return c;
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (key === 'orientationChangeEnabled') {
                this.refresh();
            } else {
                return;
            }
        },

        //Public mathods
        isTouchDevice: function () {
            return this._isTouchDevice;
        }

    });

} (jQuery));
(function ($) {

    $.jqx.jqxWidget("jqxInput", "", {});

    $.extend($.jqx._jqxInput.prototype, {
        defineInstance: function () {
            this.disabled = false;
            this.filter = this.filter || this._filter;
            this.sort = this.sort || this._sort;
            this.highlight = this.highlight || this._highlight;
            this.renderer = this.renderer || this._renderer;
            this.opened = false;
            this.$popup = $('<ul></ul>');
            this.source = [];
            this.roundedCorners = true;
            this.searchMode = 'default';
            this.placeHolder = "";
            this.width = null;
            this.height = null;
            this.value = "";
            this.rtl = false;
            this.displayMember = "";
            this.valueMember = "";
            this.events = ['select', 'open', 'close'];
            this.popupZIndex = 20000;      
            this.items = 8;
            this.item = '<li><a href="#"></a></li>';
            this.minLength = 1;
            this.maxLength = null;
        },

        createInstance: function (args) {
            this.render();
        },
        render: function()
        {
            if (this.element.nodeName.toLowerCase() == "div") {
                this.baseHost = this.element;
                var input = this.host.find("input");
                var hasTextInput = false;
                $.each(input, function () {
                    var type = this.type;
                    if (type == null || type == "text" || type == "textarea") {
                        input = $(this);
                        hasTextInput = true;
                        return false;
                    }
                });
                if (!hasTextInput) {
                    throw new Error("jqxInput: Missing Text Input in the Input Group");
                }

                if (input.length > 0) {
                    this.baseHost = $(this.element);
                    this.host = input;
                    this.element = input[0];
                    this.baseHost.addClass(this.toThemeProperty('jqx-widget'));
                    this.baseHost.addClass(this.toThemeProperty('jqx-rc-all'));
                    this.baseHost.addClass(this.toThemeProperty('jqx-input-group'));
                    var children = this.baseHost.children();
                    var that = this;
                    $.each(children, function (index) {
                        $(this).addClass(that.toThemeProperty('jqx-input-group-addon'));
                        $(this).removeClass(that.toThemeProperty('jqx-rc-all'));
                        if (index == 0) {
                            $(this).addClass(that.toThemeProperty('jqx-rc-l'));
                        }
                        if (index == children.length - 1) {
                            $(this).addClass(that.toThemeProperty('jqx-rc-r'));
                        }
                        if (this != that.element) {
                            $(this).addClass(that.toThemeProperty('jqx-fill-state-normal'));
                        }
                    });
                }
            }

            this.addHandlers();
            if (this.rtl) {
                this.host.addClass(this.toThemeProperty('jqx-rtl'));
            }
            this.host.attr('role', 'textbox');
            $.jqx.aria(this, "aria-autocomplete", "both");
            $.jqx.aria(this, "aria-disabled", this.disabled);
            $.jqx.aria(this, "aria-readonly", false);
            $.jqx.aria(this, "aria-multiline", false);
            if (this.source && this.source.length) {
                $.jqx.aria(this, "aria-haspopup", true);
            }
            if (this.value != "") {
                this.element.value = this.value;
            }

            this._oldsource = this.source;
            this._updateSource();
        },

        _updateSource: function()
        {
            var that = this;
            var mapItems = function (source) {
                var items = new Array;
                items = $.map(source, function (item) {
                    if (item == undefined)
                        return null;

                    if (typeof item === "string") {
                        return { label: item, value: item };
                    }

                    if (typeof item != "string") {
                        var label = "";
                        var value = "";

                        if (that.displayMember != "" && that.displayMember != undefined) {
                            if (item[that.displayMember]) {
                                label = item[that.displayMember];
                            }
                        }

                        if (that.valueMember != "" && that.valueMember != undefined) {
                            value = item[that.valueMember];
                        }

                        if (label == "") label = item.label;
                        if (value == "") value = item.value;

                        return { label: label, value: value };
                    }

                    return item;
                });
                return items;
            }

            if (this.source && this.source._source) {
                this.adapter = this.source;
                if (this.adapter._source.localdata != null) {
                    this.adapter.unbindBindingUpdate(this.element.id);
                    this.adapter.bindBindingUpdate(this.element.id, function (updatetype) {
                        that.source = mapItems(that.adapter.records);
                    });
                }
                else {
                    var postdata = {};
                    if (this.adapter._options.data) {
                        $.extend(that.adapter._options.data, postdata);
                    }
                    else {
                        if (this.source._source.data) {
                            $.extend(postdata, this.source._source.data);
                        }
                        this.adapter._options.data = postdata;
                    }
                    this.adapter.unbindDownloadComplete(this.element.id);
                    this.adapter.bindDownloadComplete(this.element.id, function (updatetype) {
                        that.source = mapItems(that.adapter.records);
                    });
                }
                this.source.dataBind();
                return;
            }

            if (!$.isFunction(this.source)) {
                this.source = mapItems(this.source);
            }
        },

        _refreshClasses: function (add) {
            var func = add ? 'addClass' : 'removeClass';
            this.host[func](this.toThemeProperty('jqx-widget-content'));
            this.host[func](this.toThemeProperty('jqx-input'));
            this.host[func](this.toThemeProperty('jqx-widget'));
            this.$popup[func](this.toThemeProperty('jqx-popup'));
            if ($.jqx.browser.msie) {
                this.$popup[func](this.toThemeProperty('jqx-noshadow'));
            }
            this.$popup[func](this.toThemeProperty('jqx-input-popup'));
            this.$popup[func](this.toThemeProperty('jqx-menu'));
            this.$popup[func](this.toThemeProperty('jqx-menu-vertical'));
            this.$popup[func](this.toThemeProperty('jqx-menu-dropdown'));
            this.$popup[func](this.toThemeProperty('jqx-widget'));
            this.$popup[func](this.toThemeProperty('jqx-widget-content'));
            if (this.roundedCorners) {
                this.host[func](this.toThemeProperty('jqx-rc-all'));
                this.$popup[func](this.toThemeProperty('jqx-rc-all'));
            }
            if (this.disabled) {
                this.host[func](this.toThemeProperty('jqx-fill-state-disabled'));
            }
            else {
                this.host.removeClass(this.toThemeProperty('jqx-fill-state-disabled'));
            }
        },

        selectAll: function()
        {
            var textbox = this.host;
            setTimeout(function () {
                if ('selectionStart' in textbox[0]) {
                    textbox[0].focus();
                    textbox[0].setSelectionRange(0, textbox[0].value.length);
                }
                else {
                    var range = textbox[0].createTextRange();
                    range.collapse(true);
                    range.moveEnd('character', textbox[0].value.length);
                    range.moveStart('character', 0);
                    range.select();
                }
            }, 10);
        },

        selectLast: function () {
            var textbox = this.host;
            this.selectStart(textbox[0].value.length);
        },

        selectFirst: function () {
            var textbox = this.host;
            this.selectStart(0);
        },

        selectStart: function (index) {
            var textbox = this.host;
            setTimeout(function () {
                if ('selectionStart' in textbox[0]) {
                    textbox[0].focus();
                    textbox[0].setSelectionRange(index, index);
                }
                else {
                    var range = textbox[0].createTextRange();
                    range.collapse(true);
                    range.moveEnd('character', index);
                    range.moveStart('character', index);
                    range.select();
                }
            }, 10);
        },

        focus: function () {
            try {
                this.host.focus();
            }
            catch (error) {
            }
        },

        refresh: function () {
            this._refreshClasses(false);
            this._refreshClasses(true);

            if (!this.baseHost) {
                if (this.width) this.host.width(this.width);
                if (this.height) this.host.height(this.height);
            }
            else {
                if (this.width) this.baseHost.width(this.width);
                if (this.height) {
                    this.baseHost.height(this.height);
                    var that = this;
                    var totalWidth = 0;
                    var height = this.baseHost.height()-2;
                    if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                        this.baseHost.css('display', 'inline-block');
                    }
                    $.each(this.baseHost.children(), function () {
                        $(this).css('height', '100%');
                        if ($.jqx.browser.msie && $.jqx.browser.version < 8) {
                            $(this).css('height', height + 'px');
                        }
                        if (this !== that.element) {
                            totalWidth += $(this).outerWidth() + 2;
                        }
                    });
                    this.host.css('width', this.baseHost.width() - totalWidth - 4 + 'px');
                    if ($.jqx.browser.msie && $.jqx.browser.version < 9) {
                        this.host.css('min-height', height + 'px');
                        this.host.css('line-height', height + 'px');
                    }
                }
            }

            this.host.attr('disabled', this.disabled);
            if (this.maxLength) {
                this.host.attr("maxlength", this.maxLength);
            };

            if (!this.host.attr('placeholder')) {
                this._refreshPlaceHolder();
            }
        },

        _refreshPlaceHolder: function()
        {
            if ('placeholder' in this.element) {
                this.host.attr('placeHolder', this.placeHolder);
            }
            else {
                var that = this;
                if (this.host.val() == "") {
                    this.host.val(this.placeHolder);

                    this.host.focus(function () {
                        if (that.host.val() == that.placeHolder) {
                            that.host.val('');
                        }
                    });

                    this.host.blur(function () {
                        if (that.host.val() == '' || that.host.val() == that.placeHolder) {
                            that.host.val(that.placeHolder);
                        }
                    });
                }
            }
        },

        destroy: function () {
            this.removeHandlers();
            this.host.remove();
            if (this.$popup) {
                this.$popup.remove();
            }
        },

        propertyChangedHandler: function (object, key, oldvalue, value) {
            if (key == 'placeHolder') {
                object._refreshPlaceHolder();
                return;
            }

            if (key == "opened") {
                if (value) object.open();
                else object.close();
                return;
            }
            if (key == "source") {
                object._oldsource = value;
                object._updateSource();
            }
            if (key == "displayMember" || key == "valueMember") {
                object.source = object._oldsource;
                object._updateSource();
            }
            if (key == "disabled") {
                $.jqx.aria(object, "aria-disabled", object.disabled);
            }

            if (key == "value") {
                object.element.value = value;
            }

            object.refresh();
        },

        select: function (event, ui) {
            var val = this.$popup.find('.jqx-fill-state-pressed').attr('data-value')
            var label = this.$popup.find('.jqx-fill-state-pressed').attr('data-name');
            this.host
            .val(this.renderer(label, this.host.val()));
            this._raiseEvent('0', {'item': { 'label': label, 'value': val }, 'label': label, 'value': val });
            return this.close();
        },

        val: function (value) {
            if (arguments.length == 0 || (value != null && typeof (value) == "object")) {
                return this.element.value;
            }

            this.value = value;
            this.element.value = value;
            return this.element.value;
        },

        _raiseEvent: function (id, arg) {
            if (arg == undefined)
                arg = { owner: null };

            var evt = this.events[id];
            arg.owner = this;

            var event = new jQuery.Event(evt);
            event.owner = this;
            event.args = arg;
            if (event.preventDefault)
                event.preventDefault();

            var result = this.host.trigger(event);
            return result;
        },

        _renderer: function (item) {
            return item;
        },

        open: function () {
            if ($.jqx.isHidden(this.host)) {
                return;
            }

            var position = $.extend({}, this.host.coord(true), {
                height: this.host[0].offsetHeight
            })

            if (this.$popup.parent().length == 0) {
                var popupId = this.element.id + "_" + "popup";
                this.$popup[0].id = popupId;
                $.jqx.aria(this, "aria-owns", popupId);
            }

            this.$popup
            .appendTo($(document.body))
            .css({
                position: 'absolute',
                zIndex: this.popupZIndex,
                top: position.top + position.height
            , left: position.left
            })
            .show();
            var height = 0;
            var children = this.$popup.children();
            $.each(children, function () {
                height += $(this).outerHeight(true) - 1;
            });
            this.$popup.height(height);

            this.opened = true;
            this._raiseEvent('1', { popup: this.$popup });
            $.jqx.aria(this, "aria-expanded", true);
            return this
        },

        close: function () {
            this.$popup.hide();
            this.opened = false;
            this._raiseEvent('2', { popup: this.$popup });
            $.jqx.aria(this, "aria-expanded", false);
            return this;
        },

        suggest: function (event) {
            var items;
            this.query = this.host.val();

            if (!this.query || this.query.length < this.minLength) {
                return this.opened ? this.close() : this
            }

            if ($.isFunction(this.source)) {
                items = this.source(this.query, $.proxy(this.load, this));
            }
            else {
                items = this.source;
            }

            if (items) {
                return this.load(items);
            }

            return this;
        },

        load: function (items) {
            var that = this;

            items = $.grep(items, function (item) {
                return that.filter(item);
            })

            items = this.sort(items)

            if (!items.length) {
                if (this.opened) {
                    return this.close();
                }
                else {
                    return this;
                }
            }

            return this._render(items.slice(0, this.items)).open();
        },

        _filter: function (item) {
            var value = this.query;
            var itemValue = item;
            if (item.label != null) {
                itemValue = item.label;
            }

            switch (this.searchMode) {
                case 'containsignorecase':
                default:
                    return $.jqx.string.containsIgnoreCase(itemValue, value);
                case 'contains':
                    return $.jqx.string.contains(itemValue, value);
                case 'equals':
                    return $.jqx.string.equals(itemValue, value);
                case 'equalsignorecase':
                    return $.jqx.string.equalsIgnoreCase(itemValue, value);
                case 'startswith':
                    return $.jqx.string.startsWith(itemValue, value);
                case 'startswithignorecase':
                    return $.jqx.string.startsWithIgnoreCase(itemValue, value);
                case 'endswith':
                    return $.jqx.string.endsWith(itemValue, value);
                case 'endswithignorecase':
                    return $.jqx.string.endsWithIgnoreCase(itemValue, value);
            }
        },

        _sort: function (items) {
            var bw = []
            , cs = []
            , cis = []
            , item
           
            for (var i = 0; i < items.length; i++) {
                var item = items[i];

                var itemValue = item;
                if (item.label) {
                    itemValue = item.label;
                }

                if (itemValue.toLowerCase().indexOf(this.query.toLowerCase()) === 0) {
                    bw.push(item);
                }
                else if (itemValue.indexOf(this.query) >= 0) {
                    cs.push(item);
                }
                else if (itemValue.toLowerCase().indexOf(this.query.toLowerCase()) >= 0) {
                    cis.push(item);
                }
            }

            return bw.concat(cs, cis);
        },

        _highlight: function (item) {
            var query = this.query;
            var regex = new RegExp('(' + query + ')', 'ig');
            return item.replace(regex, function ($1, match) {
                return '<b>' + match + '</b>'
            })
        },

        _render: function (items) {
            var that = this

            items = $(items).map(function (i, item) {
                var itemValue = item;
                if (item.value != undefined) {
                    if (item.label != undefined) {
                        i = $(that.item).attr({ 'data-name': item.label, 'data-value': item.value });
                    }
                    else {
                        i = $(that.item).attr({ 'data-name': item.value, 'data-value': item.value });
                    }
                }
                else if (item.label != undefined) {
                    i = $(that.item).attr({ 'data-value': item.label, 'data-name': item.label });
                }
                else {
                    i = $(that.item).attr({ 'data-value': item, 'data-name': item });
                }
                if (item.label) {
                    itemValue = item.label;
                }

                i.find('a').html(that.highlight(itemValue));
                var rtlClass = "";
                if (that.rtl) {
                    rtlClass = " " + that.toThemeProperty('jqx-rtl');
                }
                i[0].className = that.toThemeProperty('jqx-item') + " " + that.toThemeProperty('jqx-menu-item') + " " + that.toThemeProperty('jqx-rc-all') + rtlClass;
                return i[0];
            })

            items.first().addClass(this.toThemeProperty('jqx-fill-state-pressed'));
            this.$popup.html(items);
            this.$popup.width(this.host.width() - 4);
            return this;
        },

        next: function (event) {
            var active = this.$popup.find('.jqx-fill-state-pressed').removeClass(this.toThemeProperty('jqx-fill-state-pressed'))
            , next = active.next();

            if (!next.length) {
                next = $(this.$popup.find('li')[0]);
            }

            next.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
        },

        prev: function (event) {
            var active = this.$popup.find('.jqx-fill-state-pressed').removeClass(this.toThemeProperty('jqx-fill-state-pressed'))
        , prev = active.prev()

            if (!prev.length) {
                prev = this.$popup.find('li').last()
            }

            prev.addClass(this.toThemeProperty('jqx-fill-state-pressed'));
        },

        addHandlers: function () {
            this.addHandler(this.host, 'focus', $.proxy(this.focus, this));
            this.addHandler(this.host, 'blur', $.proxy(this.blur, this));
            this.addHandler(this.host, 'keypress', $.proxy(this.keypress, this));
            this.addHandler(this.host, 'keyup', $.proxy(this.keyup, this));
            this.addHandler(this.host, 'keydown', $.proxy(this.keydown, this));
            this.addHandler(this.$popup, 'mousedown', $.proxy(this.click, this));
            if (this.host.on) {
                this.$popup.on('mouseenter', 'li', $.proxy(this.mouseenter, this));
            }
            else {
                this.$popup.bind('mouseenter', 'li', $.proxy(this.mouseenter, this));
            }
        },

        removeHandlers: function () {
            this.removeHandler(this.host, 'blur', $.proxy(this.blur, this));
            this.removeHandler(this.host, 'keypress', $.proxy(this.keypress, this));
            this.removeHandler(this.host, 'keyup', $.proxy(this.keyup, this));
            this.removeHandler(this.host, 'keydown', $.proxy(this.keydown, this));
            this.removeHandler(this.$popup, 'mousedown', $.proxy(this.click, this));
            if (this.host.off) {
                this.$popup.off('mouseenter', 'li', $.proxy(this.mouseenter, this));
            }
            else {
                this.$popup.unbind('mouseenter', 'li', $.proxy(this.mouseenter, this));
            }
        },

        move: function (e) {
            if (!this.opened) return

            switch (e.keyCode) {
                case 9: // tab
                case 13: // enter
                case 27: // escape
                    e.preventDefault()
                    break

                case 38: // up arrow
                    e.preventDefault()
                    this.prev()
                    break

                case 40: // down arrow
                    e.preventDefault()
                    this.next()
                    break
            }

            e.stopPropagation()
        },

        keydown: function (e) {
            this.suppressKeyPressRepeat = ~$.inArray(e.keyCode, [40, 38, 9, 13, 27])
            this.move(e)
        },

        keypress: function (e) {
            if (this.suppressKeyPressRepeat) return
            this.move(e)
        },

        keyup: function (e) {
            switch (e.keyCode) {
                case 40: // down arrow
                case 38: // up arrow
                case 16: // shift
                case 17: // ctrl
                case 18: // alt
                    break

                case 9: // tab
                case 13: // enter
                    if (!this.opened) return;
                    this.select(e, this)
                    break

                case 27: // escape
                    if (!this.opened) return;
                    this.close()
                    break

                default:
                    {
                        var me = this;
                        if (this.timer) clearTimeout(this.timer);
                        this.timer = setTimeout(function () {
                            me.suggest();
                        }, 300);
                    }
            }

            e.stopPropagation()
            e.preventDefault()
        },

        clear: function()
        {
            this.host.val("");
        },

        blur: function (e) {
            var that = this;
            setTimeout(function () { that.close() }, 150)
            that.host.removeClass(that.toThemeProperty('jqx-fill-state-focus'));
            this.value = this.host.val();
        },

        focus: function (e) {
            var that = this;
            that.host.addClass(that.toThemeProperty('jqx-fill-state-focus'));
        },

        click: function (e) {
            e.stopPropagation()
            e.preventDefault()
            this.select(e, this)
        },

        mouseenter: function (e) {
            this.$popup.find('.jqx-fill-state-pressed').removeClass(this.toThemeProperty('jqx-fill-state-pressed'));
            $(e.currentTarget).addClass(this.toThemeProperty('jqx-fill-state-pressed'));
        }

    });
})(jQuery);/*
* Depends:
*   jqxcore.js
*/

(function ($) {

    $.jqx.response = function () {
        this.defineInstance();
    }

    $.jqx.response.prototype = {

        defineInstance: function () {
            this._handlers = new Array();
            this.refresh();
            var that = this;
            this.addHandler($(document), 'scroll.jqxresponse', function () {
                that.scroll = that.getScroll();
            });
        },

        refresh: function()
        {
            this.os = this.getOS();
            this.browser = this.getBrowser();
            this.device = this.getDevice();
            this.viewPort = this.getViewPort();
            this.document = this.getDocument();
            this.scroll = this.getScroll();
            this.media = window.matchMedia || window.msMatchMedia || function () { return {}; };
        },

        refreshSize: function()
        {
            this.viewPort = this.getViewPort();
            this.document = this.getDocument();
        },

        addHandler: function (source, event, func, data) {
            switch (event) {
                case 'mousemove':
                    if (window.addEventListener && !data) {
                        source[0].addEventListener('mousemove', func, false);
                        return false;
                    }
                    break;
            }

            if (source.on) {
                source.on(event, func);
            }
            else {
                source.bind(event, func);
            }
        },

        removeHandler: function (source, event, func) {
            if (event == undefined) {
                if (source.off) {
                    source.off();
                }
                else source.unbind();
                return;
            }

            if (func == undefined) {
                if (source.off) {
                    source.off(event);
                }
                else {
                    source.unbind(event);
                }
            }
            else {
                if (source.off) {
                    source.off(event, func);
                }
                else {
                    source.unbind(event, func);
                }
            }
        },

        destroy: function()
        {
            this.removeHandler($(window), 'resize.jqxresponse');
            this.removeHandler($(document), 'scroll.jqxresponse');
            for (var i = 0; i < this._handlers.length; i++) {
                var element = this._handlers[i];
                this.removeHandler($(element), 'mousedown.response' + element[0].id);
                this.removeHandler($(element), 'touchstart.response' + element[0].id);
                this.removeHandler($(element), 'mousemove.response' + element[0].id);
                this.removeHandler($(element), 'touchmove.response' + element[0].id);
                this.removeHandler($(element), 'mouseup.response' + element[0].id);
                this.removeHandler($(element), 'touchend.response' + element[0].id);
            }
        },

        resize: function (resizeFuncs) {
            var that = this;
            this.removeHandler($(window), 'resize.jqxresponse');
            this.addHandler($(window), 'resize.jqxresponse', function (event) {
                if (resizeFuncs) {
                    if ($.isArray(resizeFuncs)) {
                        for (var i = 0; i < resizeFuncs.length; i++) {
                            resizeFuncs[i]();
                        }
                    }
                    else {
                        resizeFuncs();
                    }
                }
                that.refreshSize();
            });
            if (resizeFuncs == null) {
                this.removeHandler($(window), 'resize.jqxresponse');
            }
        },

        pointerDown: function(element, func)
        {
            if (element && func) {
                var touchDevice = $.jqx.mobile.isTouchDevice();
                var that = this;
                var canCallFunc = true;

                if (touchDevice) {
                    var touchstart = $.jqx.mobile.getTouchEventName('touchstart') + '.response' + element[0].id;

                    if (func != null) {
                        this.addHandler($(element), touchstart, function (event) {
                            var position = $.jqx.position(event);
                            var result = func(event, position, "touch");
                            canCallFunc = false;
                            setTimeout(function () {
                                canCallFunc = true;
                            }, 500);
                            return result;
                        });
                    }
                    else {
                        this.removeHandler($(element), touchstart);
                    }
                }
                if (func != null) {
                    this.addHandler($(element), 'mousedown.response' + element[0].id, function (event) {
                        var position = $.jqx.position(event);
                        if (canCallFunc) {
                            return func(event, position, "mouse");
                        }
                    });
                } else {
                    this.removeHandler($(element), 'mousedown.response' + element[0].id);
                }
                this._handlers.push(element);
            }
        },

        pointerUp: function (element, func) {
            if (element) {
                var touchDevice = $.jqx.mobile.isTouchDevice();
                var that = this;
                var canCallFunc = true;

                if (touchDevice) {
                    var touchend = $.jqx.mobile.getTouchEventName('touchend') + '.response' + element[0].id;

                    if (func != null) {
                        this.addHandler($(element), touchend, function (event) {
                            var position = $.jqx.position(event);
                            var result = func(event, position, "touch");
                            canCallFunc = false;
                            setTimeout(function () {
                                canCallFunc = true;
                            }, 500);
                            return result;
                        });
                    }
                    else {
                        this.removeHandler($(element), touchend);
                     
                    }
                }
                if (func != null) {
                    this.addHandler($(element), 'mouseup.response' + element[0].id, function (event) {
                        var position = $.jqx.position(event);
                        if (canCallFunc) {
                            return func(event, position, "mouse");
                        }
                    });
                }
                else {
                    this.removeHandler($(element), 'mouseup.response' + element[0].id);
                }
                this._handlers.push(element);
            }
        },

        pointerMove: function (element, func) {
            if (element) {
                var touchDevice = $.jqx.mobile.isTouchDevice();
          
                if (touchDevice) {
                    var touchmove = $.jqx.mobile.getTouchEventName('touchmove') + '.response' + element[0].id;

                    if (func != null) {
                        this.addHandler($(element), touchmove, function (event) {
                            var touches = $.jqx.mobile.getTouches(event);
                            if (touches.length == 1) {
                                var position = $.jqx.position(event);
                                return func(event, position, "touch");
                            }
                        });
                    }
                    else {
                        this.removeHandler($(element), touchmove);
                    }
                }
                else {
                    if (func != null) {
                        this.addHandler($(element), 'mousemove.response' + element[0].id, function (event) {
                            var position = $.jqx.position(event);
                            return func(event, position, "mouse");
                        });
                    }
                    else {
                        this.removeHandler($(element), 'mousemove.response' + element[0].id);
                    }
                }
                this._handlers.push(element);
            }
        },

        isHidden: function(element)
        {
            return $.jqx.isHidden($(element));
        },

        inViewPort: function(element)
        {
            var viewPort = this.viewPort;

            if (element.getBoundingClientRect) {
                var r = element.getBoundingClientRect ? element.getBoundingClientRect() : {};
                return r && (r.bottom >= 0 && r.top <= viewPort.height && r.right >= 0 && r.left <= viewPort.width);
            }
            return false;
        },

        getScroll: function()
        {
            var obj = { left: window.pageXOffset || document.scrollLeft, top: window.pageYOffset || document.scrollTop };
            if (obj.left == undefined) obj.left = 0;
            if (obj.top == undefined) obj.top = 0;

            return obj;
        },

        getDocument: function()
        {
            return { width: $(document).width(), height: $(document).height() }
        },

        getViewPort: function ()
        {
            return { width: $(window).width(), height: $(window).height() }
        },

        getTouch: function()
        {
            var eventName = 'ontouchstart';
            var supported = (eventName in window);
            if (supported) {
                return true;
            }
            else {
                var eventName = 'MSPointerDown';
                var supported = (eventName in window);
                if (supported) {
                    return true;
                }
            }
            if ($.jqx.mobile.isWindowsPhone())
                return true;

            return false;
        },

        getDevice: function()
        {
            var osName = this.os.name;
            var match = window.location.search.match(/deviceType=(Tablet|Phone)/),
               nativeDeviceType = window.deviceType;
            var deviceType = "";
            if (match && match[1]) {
                deviceType = match[1];
            }
            else if (nativeDeviceType === 'iPhone') {
                deviceType = 'Phone';
            }
            else if (nativeDeviceType === 'iPad') {
                deviceType = 'Tablet';
            }
            else {
                if (osName != "Android" && osName != "iOS" && /Windows|Linux|MacOS/.test(osName)) {
                    deviceType = 'Desktop';
                }
                else if (osName == "iOS" && navigator.userAgent.toLowerCase().indexOf('ipad') >= 0) {
                    deviceType = 'Tablet';
                }
                else if (osName == "RIMTablet") {
                    deviceType = 'Tablet';
                }
                else if (osName == "Android") {
                    if (this.os.version.indexOf("3") >= 0) {
                        deviceType = 'Tablet';
                    }
                    else if (this.os.version.indexOf("4") >= 0 && navigator.userAgent.search(/mobile/i) == -1) {
                        deviceType = 'Tablet';
                    }
                }
                else {
                    deviceType = 'Phone';
                }
            }

            if (/Windows/.test(osName)) {
                if (navigator.userAgent.indexOf('Windows Phone') >= 0 || navigator.userAgent.indexOf('WPDesktop') >= 0 || navigator.userAgent.indexOf('IEMobile') >= 0 || navigator.userAgent.indexOf('ZuneWP7') >= 0) {
                    deviceType = 'Phone';
                }
                else {
                    if (navigator.userAgent.indexOf('Touch') >= 0) {
                        deviceType = 'Tablet';
                    }
                }
            }

            return {
                // for device width - width, height for device height. The .availWidth/.availHeight methods give you the device size minus UI taskbars Device size is static and does not change when the page is resized or rotated.
                type: deviceType, touch: this.getTouch(), width: window.screen.width, height: window.screen.height,
                availWidth: window.screen.availWidth, availHeight: window.screen.availHeight
            }
        },

        canvas: function()
        {
            var canvasSupport = false;
            var canvas = document.createElement('canvas');
            if (canvas && canvas.getContext && canvas.getContext('2d')) {
                canvasSupport = true;
            }
            return canvasSupport;
        },

        vml: function () {
            if (this._vmlSupport == undefined) {
                var a = document.body.appendChild(document.createElement('div'));
                a.innerHTML = '<v:shape id="vml_flag1" adj="1" />';
                var b = a.firstChild;
                b.style.behavior = "url(#default#VML)";
                this._vmlSupport = b ? typeof b.adj == "object" : true;
                a.parentNode.removeChild(a);
            }
            return this._vmlSupport;
        },

        svg: function()
        {
            return document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Image", "1.1"); 
        },

        getBrowser: function()
        {
            var ua = navigator.userAgent.toLowerCase();
            var name = "";
            var match = null;
            var that = this;

            browserNames = {
                msie: { name: 'Internet Explorer', eval: /(msie) ([\w.]+)/.exec(ua) },
                webkit: { name: 'Webkit', eval: /(webkit)[ \/]([\w.]+)/.exec(ua) },
                chrome: { name: 'Chrome', eval: /(chrome)[ \/]([\w.]+)/.exec(ua) },
                safari: { name: 'Safari', eval: /(safari)[ \/]([\w.]+)/.exec(ua) },
                opera: { name: 'Opera', eval: /(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua) },
                operamobile: {name: 'Opera Mobile', eval: /(opera mobi)(?:.*version|)[ \/]([\w.]+)/.exec(ua) || /(opera tablet)(?:.*version|)[ \/]([\w.]+)/.exec(ua)},
                dolphin: { name: 'Dolphin', eval: /(dolphin)[ \/]([\w.]+)/.exec(ua) },
                webosbrowser: {name: 'webOSBrowser', eval: /(wosbrowser)(?:.*version|)[ \/]([\w.]+)/.exec(ua)},
                chromemobile: {name: 'Chrome Mobile', eval: /(crmo)[ \/]([\w.]+)/.exec(ua)},
                silk: {name: 'Silk', eval: /(silk)[ \/]([\w.]+)/.exec(ua)},
                firefox: { name: 'Firefox', eval: /(firefox)[ \/]([\w.]+)/.exec(ua) },
                msie11: { name: 'Internet Explorer', eval: ua.indexOf("rv:11.0") >= 0 && ua.indexOf(".net4.0c") >= 0 },
                other: { name: 'Other', eval: ua.indexOf("compatible") < 0 && /(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua) }
            }
            
            $.each(browserNames, function (index, value) {
                if (this.eval) {
                    if (this.name == "Other") {
                        if (!match) {
                            match = this.eval;
                            name = this.name;
                        }
                    }
                    else if (this.name == "Internet Explorer") {
                        if (!match) {
                            match = ["", "msie", 11.0];
                            name = this.name;
                        }
                    }
                    else {
                        if (name == "Chrome" && this.name == "Safari")
                            return true;

                        match = this.eval;
                        name = this.name;
                    }
                }
            });

            if (match) {
                var browser = {
                    name: name,
                    accessName: match[1] || "",
                    version: match[2] || "0",
                    canvas: this.canvas(),
                    svg: this.svg(),
                    vml: this.vml()
                };

                browser[match[1]] = match[1];
            }
            else {
                browser = { name: 'Other', browser: 'other', version: '' };
            }

            return browser;
        },

        getOS: function () {
            var match = null;
            var version = "";
            var userAgent = navigator.userAgent;
            var os = "Other";
            var osTypes = {
                ios: { name: 'iOS', regex: new RegExp('(?:' + 'i(?:Pad|Phone|Pod)(?:.*)CPU(?: iPhone)? OS ' + ')([^\\s;]+)') },
                android: {name: 'Android', regex: new RegExp('(?:'+'(Android |HTC_|Silk/)'+')([^\\s;]+)')},
                webos: {name: 'webOS', regex: new RegExp('(?:'+'(?:webOS|hpwOS)\/'+')([^\\s;]+)')},
                blackberry: {name: 'BlackBerry', regex: new RegExp('(?:'+'BlackBerry(?:.*)Version\/'+')([^\\s;]+)')},
                rimTablet: {name: 'RIMTablet', regex:  new RegExp('(?:'+'RIM Tablet OS '+')([^\\s;]+)')},
                chrome: { name: 'Chrome OS', regex: new RegExp('CrOS') },
                mac: { name: 'MacOS', regex: new RegExp('mac') },
                win: {name: 'Windows', regex: new RegExp('win')},
                linux: { name: 'Linux', regex: new RegExp('linux') },
                bada: {name: 'Bada', regex: new RegExp('(?:'+'Bada\/'+')([^\\s;]+)')},
                other: {name: 'Other'}
            }

            $.each(osTypes, function (index, value) {
                match = userAgent.match(this.regex) || userAgent.toLowerCase().match(this.regex);

                if (match) {                    
                    if (!this.name.match(/Windows|Linux|MaxOS/))
                    {
                        if (match[1] && (match[1] == "HTC_" || match[1] == "Silk/")) {
                            version = "2.3";
                        } else {
                            version = match[match.length - 1];
                        }
                    }

                    os = { name: this.name, version: version, platform: navigator.platform };
                    return false;
                }
            });
            return os;
        }
    }
})(jQuery);(function ($) {

    $.jqx.jqxWidget('jqxTreeMap', '', {});

    var treemap = {};

    treemap['default'] = (function () {

        /**
         * Treemap area
         */
        function Area(xoffset, yoffset, width, height) {
            this.height = height;
            this.width = width;
            this.xoffset = xoffset; 
            this.yoffset = yoffset; 

            this.shortestEdge = function () {
                return Math.min(this.height, this.width);
            };

            /**
             * Gets the coordinates of the area
             */
            this.getCoordinates = function (row) {
                var coordinates = [],
                    subxoffset = this.xoffset, subyoffset = this.yoffset,
                    areawidth = sumArray(row) / this.height,
                    areaheight = sumArray(row) / this.width;

                if (this.width >= this.height) {
                    for (var i = 0; i < row.length; i += 1) {
                        coordinates.push([subxoffset, subyoffset, subxoffset + areawidth, subyoffset + row[i] / areawidth]);
                        subyoffset = subyoffset + row[i] / areawidth;
                    }
                } else {
                    for (var i = 0; i < row.length; i += 1) {
                        coordinates.push([subxoffset, subyoffset, subxoffset + row[i] / areaheight, subyoffset + areaheight]);
                        subxoffset = subxoffset + row[i] / areaheight;
                    }
                }
                return coordinates;
            };

            this.cutArea = function (area) {
                var newcontainer;

                if (this.width >= this.height) {
                    var areawidth = area / this.height,
                        newwidth = this.width - areawidth;
                    newcontainer = new Area(this.xoffset + areawidth, this.yoffset, newwidth, this.height);
                } else {
                    var areaheight = area / this.width,
                        newheight = this.height - areaheight;
                    newcontainer = new Area(this.xoffset, this.yoffset + areaheight, this.width, newheight);
                }
                return newcontainer;
            };
        }

        /**
         * Normalize the given coordinates so the different areas to fit in the parent rectangle
         */
        function normalizeData(data, area) {
            var normalizeDataddata = [],
                sum = sumArray(data),
                multiplier = area / sum;

            for (var i = 0; i < data.length; i += 1) {
                normalizeDataddata[i] = data[i] * multiplier;
            }

            return normalizeDataddata;
        }

        function handleMultidimentional(data, width, height, xoffset, yoffset) {
            xoffset = (typeof xoffset === "undefined") ? 0 : xoffset;
            yoffset = (typeof yoffset === "undefined") ? 0 : yoffset;
            
            var mergeddata = [],
                mergedtreemap,
                results = [];

            if (isArray(data[0])) {

                for (var i = 0; i < data.length; i += 1) {
                    mergeddata[i] = sumMultidimensionalArray(data[i]);
                }

                mergedtreemap = handleSingledimentional(mergeddata, width, height, xoffset, yoffset);
                
                for (var i = 0; i < data.length; i += 1) {
                    results.push(handleMultidimentional(data[i], 
                        mergedtreemap[i][2] - mergedtreemap[i][0], 
                        mergedtreemap[i][3] - mergedtreemap[i][1], 
                        mergedtreemap[i][0], 
                        mergedtreemap[i][1]));
                }

            } else {
                results = handleSingledimentional(data,width,height, xoffset, yoffset);
            }
            return results;
        }

        /**
         * Returns array of array. Each inner array is a set of coordinates - left, top, right, bottom.
         * For finding the width simply: right - left
         * For finding the height simply: bottom - top
         */
        function handleSingledimentional(data, width, height, xoffset, yoffset) {
            xoffset = (typeof xoffset === "undefined") ? 0 : xoffset;
            yoffset = (typeof yoffset === "undefined") ? 0 : yoffset;

            var rawtreemap = squarify(normalizeData(data, width * height),
                                      [],
                                      new Area(xoffset, yoffset, width, height),
                                      []);
            return flattenTreemap(rawtreemap);
        }

        function flattenTreemap(rawtreemap) {
            var flattreemap = [];
            for (var i = 0; i < rawtreemap.length; i += 1) {
                for (var j = 0; j < rawtreemap[i].length; j += 1) {
                    flattreemap.push(rawtreemap[i][j]);
                }
            }
            return flattreemap;
        }

        /**
         * Creates a treemap using the algorithm: http://www.win.tue.nl/~vanwijk/stm.pdf
         */
        function squarify(data, currentrow, container, stack) {
            var length,
                nextdatapoint,
                newcontainer;

            if (data.length === 0) {
                stack.push(container.getCoordinates(currentrow));
                return;
            }

            length = container.shortestEdge();
            nextdatapoint = data[0];
            
            if (improvesRatio(currentrow, nextdatapoint, length)) {
                currentrow.push(nextdatapoint);
                squarify(data.slice(1), currentrow, container, stack);
            } else {
                newcontainer = container.cutArea(sumArray(currentrow), stack);
                stack.push(container.getCoordinates(currentrow));
                squarify(data, [], newcontainer, stack);
            }
            return stack;
        }

        /**
         * Checks whether the ratio is improved
         */
        function improvesRatio(currentrow, nextnode, length) {
            var newrow; 

            if (currentrow.length === 0)
                return true;
            
            newrow = currentrow.slice();
            newrow.push(nextnode);
            
            var currentratio = calculateRatio(currentrow, length),
                newratio = calculateRatio(newrow, length);
            
            return currentratio >= newratio; 
        }

        /**
         * Calculates the ratio
         */
        function calculateRatio(row, length) {
            var min = Math.min.apply(Math, row),
                max = Math.max.apply(Math, row),
                sum = sumArray(row);
            return Math.max(Math.pow(length, 2) * max / Math.pow(sum, 2), Math.pow(sum, 2) / (Math.pow(length, 2) * min));
        }

        /**
         * Returns if the given parameter is an array
         *
         * @param {object}
         */
        function isArray(arr) {
            return arr && arr.constructor === Array; 
        }

        /**
         * Returns the sum of an array
         *
         * @param {array} The array which sum of elements we should find
         */
        function sumArray(arr) {
            var sum = 0;
            for (var i = 0; i < arr.length; i += 1) 
                sum += arr[i];

            return sum;
        }

        /**
         * Finds the sum of multidimensional array
         *
         * @param {array} Multidimensional array which sum should be found
         */
        function sumMultidimensionalArray(arr) {
            var total = 0;

            if (isArray(arr[0])) {
                for (var i = 0; i < arr.length; i += 1) {
                    total += sumMultidimensionalArray(arr[i]);
                }
            } else {
                total = sumArray(arr);
            }
            return total;
        }

        return handleMultidimentional; 
    }());

    /**
     * Represents a node from the TreeMap
     *
     * @param {string} label - Label of the node
     * @param {number} value - Value in percents
     * @param {Node} parent - Parent of the current node
     * @param {array} children - List of all children of the current node
     * @param {object} [ground] - DOM element which corresponds to the current node
     * @param {object} [ground] - additional data related to the node.
     */
    function Node(label, value, parent, children, area, color, data, record) {
        this.label = label;
        this.value = value;
        this.parent = parent;
        this.children = children;
        this.area = area || null;
        this.color = color;
        this.data = data;
        this.record = record;
    }

    /**
     * Enum used for the axis (horizontal, vertical or both)
     */
    var Axis = {
        HORIZONTAL: 0,
        VERTICAL: 1,
        BOTH: 2
    };

    $.extend($.jqx._jqxTreeMap.prototype, {

        defineInstance: function () {

            /**
             * Width of the treemap
             */
            this.width = 600;

            /**
             * Height of the treemap
             */
            this.height = 600;

            /**
             * Callbacks which are called when a sector is rendered.
             * In renderCallbacks can be defined callback for each data element
             * by setting property with name the data element's label and value the callback
             * function. If you want to define callback which should be called
             * for each data element you must set the property '*' of the renderCallbacks i.e.:
             *
             * renderCallbacks['*'] = function (node, data) {
             * };
             */
            this.renderCallbacks = {};

            /**
             * Formats the legend scale's values.
             */
            this.legendScaleCallback = function (a) {
                return a;
            };

            /**
             * Enable/disable the hover effect
             */
            this.hoverEnabled = false;

            /**
             * Enable/disable the sector selection
             */
            this.selectionEnabled = true;

            /**
             * If this property is true, just a single sector can be selected at given time
             */
            this.singleSelection = true;

            /**
             * Indicates whether to show or not the legend.
             * The legend is available only in autoColors and rangeColors modes
             */
            this.showLegend = true;

            /**
             * The legend label.
             */
            this.legendLabel = 'Legend';

            /**
             * The height of the parent sectors' header.
             */
            this.headerHeight = 25;

            /**
             * The range in which the base colors can vary.
             */
            this.colorRange = 100;

            /**
             * Default or simple layout. Currently this property is disabled.
             */
            this.layout = 'default'; //default

            /**
             * The data which should be drawn.
             */
            this.source = [];
            this.displayMember = null;
            this.valueMember = null;
            /**
             *  Color mode. There are three different types of color mode:
             *  - parent - the children inherits from it's parent. Depending on the child value and
             *  the colorRange property the color varies.
             *  - autoColors - automatic color generation based on the baseColor/colorRange and
             *  the value.
             *  - rangeColors - the user can sets array of color ranges. Each color range has the
             *  properties min, max and color.
             */
            this.colorMode = 'parent'; //'parent', 'autoColors', 'rangeColors'

            /**
             * Base color which is used in autoColors mode.
             */
            this.baseColor = '#C2EEFF'; //for autoColors

            /**
             * The position of the legend.
             */
            this.legendPosition = { x: 0, y: 0 };

            /**
             * Color ranges for the rangeColors mode.
             */
            this.colorRanges = [
                { color: '#aa9988', min: 0,  max: 10  },
                { color: '#ccbbcc', min: 11, max: 50  },
                { color: '#000',    min: 50, max: 100 }
            ];

            this._root = [];
        },

        /**
         * Creates a new instance
         *
         * @private
         */
        createInstance: function () {
            this.render();
        },

        render: function () {
            this.host.addClass(this.toThemeProperty('jqx-widget'));
            this._destroy();
            this._root = new Node(undefined, 0, null, [], this.host);
            var build = function (data, that) {
                var parentVals = {}, c;

                var hasItems = null;
                for (var i = 0; i < data.length; i += 1) {
                    if (data[i].items) {
                        hasItems = true;
                        break;
                    }
                }

                var toFlatList = new Array();
                if (hasItems) {
                    var parseItems = function (data, parent) {
                        for (var i = 0; i < data.length; i += 1) {
                            data[i].parent = parent;
                            if (!data[i].data) {
                                data[i].data = data[i].value;
                            }
                            if (data[i].value == null) data[i].value = 0;
                            if (isNaN(parseFloat(data[i].value))) {
                                var val = data[i].value.toString();
                                var number = "";
                                for (var t = 0; t < val.length; t++) {
                                    var ch = val.substring(t, t + 1);
                                    if (ch.match(/^[0-9]+$/) != null || ch == ".") {
                                        number += ch;
                                    }
                                }
                                data[i].value = new Number(number);
                            }
                            else {
                                data[i].value = parseFloat(data[i].value);
                            }
                            toFlatList.push(data[i]);
                            if (data[i].items) {
                                parseItems(data[i].items, data[i].label);
                            }
                        }
                    }
                    parseItems(data, null);
                    data = toFlatList;
                }

                for (var i = 0; i < data.length; i += 1) {
                    c = data[i];
                    if (c.value) {
                        if (c.parent != null) {
                            if (!parentVals[c.parent]) {
                                parentVals[c.parent] = 0;
                            }
                            parentVals[c.parent] += c.value;
                        }
                    }
                }
                for (var i = 0; i < data.length; i += 1) {
                    c = data[i];
                    if (parentVals[c.label] !== undefined) {
                        c.value = parentVals[c.label];
                    }
                }

                that._buildTree(data, that._root);
                that._dataList = that._buildList();
                that._setStyles();
                var layoutAlgorithm = treemap['default'];
                if (that.layout === 'simple') {
                    layoutAlgorithm = treemap.simple;
                }
                that._render(that._root, layoutAlgorithm);
                that._renderLegend();
            }

            if ($.jqx.dataAdapter && this.source != null && this.source._source) {
                this.dataBind(this.source, build);
                return;
            }

            build(this.source, this);
        },

        dataBind: function (source, callback) {
            this.records = new Array();
            var isdataadapter = source._source ? true : false;
            var dataadapter = new $.jqx.dataAdapter(source,
                {
                    autoBind: false
                }
            );

            if (isdataadapter) {
                dataadapter = source;
                source = source._source;
            }

            var initadapter = function (me) {
                if (source.type != undefined) {
                    dataadapter._options.type = source.type;
                }
                if (source.formatdata != undefined) {
                    dataadapter._options.formatData = source.formatdata;
                }
                if (source.contenttype != undefined) {
                    dataadapter._options.contentType = source.contenttype;
                }
                if (source.async != undefined) {
                    dataadapter._options.async = source.async;
                }
            }

            var updatefromadapter = function (me, type) {
                me.records = dataadapter.records;
                var data = new Array();
                for (var i = 0; i < me.records.length; i++)
                {
                    var current = me.records[i];

                    if (me.displayMember) {
                        current.label = current[me.displayMember];
                    }
                    if (me.valueMember) {
                        current.value = current[me.valueMember];
                    }
                    current.record = current;
                    data.push(current);
                }

                me._trigger('bindingComplete');

                callback(data, me);
            }

            initadapter(this);

            var me = this;
            switch (source.datatype) {
                case "local":
                case "array":
                default:
                    if (source.localdata != null) {
                        dataadapter.unbindBindingUpdate(this.element.id);
                        dataadapter.dataBind();
                        updatefromadapter(this);
                        dataadapter.bindBindingUpdate(this.element.id, function (updatetype) {
                            updatefromadapter(me, updatetype);
                        });
                    }
                    break;
                case "json":
                case "jsonp":
                case "xml":
                case "xhtml":
                case "script":
                case "text":
                case "csv":
                case "tab":
                    {
                        if (source.localdata != null) {
                            dataadapter.unbindBindingUpdate(this.element.id);
                            dataadapter.dataBind();
                            updatefromadapter(this);
                            dataadapter.bindBindingUpdate(this.element.id, function () {
                                updatefromadapter(me);
                            });
                            return;
                        }

                        var postdata = {};
                        if (dataadapter._options.data) {
                            $.extend(dataadapter._options.data, postdata);
                        }
                        else {
                            if (source.data) {
                                $.extend(postdata, source.data);
                            }
                            dataadapter._options.data = postdata;
                        }
                        var updateFunc = function () {
                            updatefromadapter(me);
                        }

                        dataadapter.unbindDownloadComplete(me.element.id);
                        dataadapter.bindDownloadComplete(me.element.id, updateFunc);

                        dataadapter.dataBind();
                    }
            }
        },

        _destroy: function () {
            this.host.children().remove();
        },

        destroy: function()
        {
            this.host.remove();
        },

        refresh: function (initialRefresh)
        {
            if (!initialRefresh) {
                this._refresh();
            }
        },

        _refresh: function () {
            this.render();
        },

        /**
         * Sets the CSS styles of the host
         *
         * @private
         */
        _setStyles: function () {
            this.host.css({
                position: 'relative',
                width: this.width,
                height: this.height
            });
            var percentageSize = false;
            if (this.width != null && this.width.toString().indexOf("%") != -1) {
                percentageSize = true;
            }

            if (this.height != null && this.height.toString().indexOf("%") != -1) {
                percentageSize = true;
            }
            var that = this;
            $.jqx.utilities.resize(this.host, function () {
                if (that.resizeTimer) {
                    clearTimeout(that.resizeTimer);
                }
                that.resizeTimer = setTimeout(function () {
                    that.performLayout();
                }, 10);
            });
        },
        
        performLayout: function()
        {
            var layoutAlgorithm = treemap['default'];
            this.clearSelection();
            this._layout(this._root, layoutAlgorithm);
        },

        /**
         * Gets an array with all values from the dataset.
         *
         * @private
         * @param {array} children All the children of the current node which should be rendered
         * @return {array} values Array with all values
         */
        _getValues: function (children) {
            var values = [];
            for (var i = 0; i < children.length; i += 1) {
                values.push(children[i].value);
            }
            return values;
        },

        /**
         * Checks whether the given string is a color (rgb, rgba or hex)
         *
         * @private
         * @param {string} color The string which should be validated
         * @return {boolean} Whether the string is color
         */
        _isColor: function (color) {
            if (!color) return false;
            var ev = this._colorEvaluator;
            if (ev._isRgb(color) || ev._isHex(color)) {
                return true;
            }
            return false;
        },


        _colorEvaluator: {
            _toRgb: function (color) {
                var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(color);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            },

            _toHex: function (color) {
                var r = color.r.toString(16),
                    g = color.g.toString(16),
                    b = color.b.toString(16);
                r = r.length === 1 ? '0' + r : r;
                g = g.length === 1 ? '0' + g : g;
                b = b.length === 1 ? '0' + b : b;
                return '#' + r + g + b;
            },

            _isRgb: function (color) {
                return (/(rgb|rgba)\s*\(\s*\d+\s*(,\s*\d+\s*){2}(,\d+\.\d+)?\)(;?)/i).test(color);
            },

            _isHex: function (color) {
                return (/^(#([0-9A-F]{3})([0-9A-F]{3})?)$/i).test(color);
            },

            getColorByValue: function (value, collection, baseColor) {
                var self = this._colorEvaluator,
                    max, ratio, nCount, dispersion, color, collection;

                if (self._isRgb(baseColor))
                    baseColor = self._toHex(baseColor);
                baseColor = self._toRgb(baseColor);

                nCount = collection.length;
                max = -Infinity;
                for (var i = 0; i < nCount; i += 1) {
                    if (max < collection[i].value) {
                        max = collection[i].value;
                    }
                }
               
                ratio = value / max;
                dispersion = Math.round(ratio * this.colorRange);
                color = self._toHex({
                    r: Math.max(baseColor.r - dispersion, 0),
                    g: Math.max(baseColor.g - dispersion, 0),
                    b: Math.max(baseColor.b - dispersion, 0)
                });
                return color;
            },

            //Returns the color in hex because it's cross-browser
            parent: function (node) {
                var color = node.parent.color,
                    self = this._colorEvaluator;
                if (!node.parent)
                    return '#fff';
                if (!color) {
                    color = this.baseColor;
                }

                color = self.getColorByValue.call(this, node.value, node.parent.children, color);
                node.color = color;
                return color;
            },

            autoColors: function (node) {
                var color = this.baseColor,
                    self = this._colorEvaluator;
                color = self.getColorByValue.call(this, node.value, this._dataList, color);
                node.color = color;
                return color;
            },

            rangeColors: function (node) {
                var val = node.value,
                    current;
                for (var i = 0; i < this.colorRanges.length; i += 1) {
                    current = this.colorRanges[i];
                    if (current.min < val && current.max >= val) {
                        return current.color;
                    }
                }
                return '#fff';
            }
        },

        /**
         * Gets the color of the given node
         *
         * @private
         * @param {Node} node The node which color should be get
         * @return {string} A color which should be used for background of the rectangle
         */
        _getColor: function (node) {
            var color = node.color,
                mode = this.colorMode;
            if (this._isColor(color)) {
                return color;
            }
            if (typeof this._colorEvaluator[mode] === 'function') {
                return this._colorEvaluator[mode].call(this, node);
            } else {
                throw 'Invalid colorMode';
            }
        },

        /**
         * Render a single rectangle
         *
         * @private
         * @param {array} position The coordinates of the rectangle
         * @param {Node} node The node which should be rendered
         * @return {object} rect The rectangle (DOM element)
         */
        _renderRect: function (position, node) {
            var rect = $('<div/>'),
                width = position[2] - position[0],
                height = position[3] - position[1];
            var color = this._getColor(node);
            rect.css({
                position: 'absolute',
                left: position[0]-1,
                top: position[1]-1,
                width: width,
                height: height,
                backgroundColor: color
            });
            rect.addClass(this.toThemeProperty('jqx-treemap-rectangle'));
            var ev = this._colorEvaluator;
            var data = {
                data: node.data,
                label: node.label,
                value: node.value,
                parent: node.parent,
                record: node.record,
                color: color,
                rgb: ev._toRgb(color)
            };
            if (node.parent == this._root) {
                data.parent = null;
            }

            if (typeof this.renderCallbacks['*'] === 'function') {
                var result = this.renderCallbacks['*'](rect, data);
                if (result !== undefined) {
                    return rect;
                }
            }
            if (typeof this.renderCallbacks[node.label] === 'function') {
                this.renderCallbacks[node.label](rect, data);
            } else {
                var width = rect.width() - 2;
                rect.html('<span style="max-width:' + width + 'px;" class="jqx-treemap-label">' + node.label + '</span>');
            }
            return rect;
        },

        /**
         * Centers the label of the rectangle
         *
         * @private
         */
        _centerLabel: function (rect, axis) {
            var label = rect[0].firstChild;
            label.style.position = 'absolute';
            if (axis === Axis.HORIZONTAL || axis === Axis.BOTH) {
                label.style.left = (rect[0].offsetWidth - label.offsetWidth) / 2 + 'px';
            }
            if (axis === Axis.VERTICAL || axis === Axis.BOTH) {
                label.style.top = (rect[0].offsetHeight - label.offsetHeight) / 2 + 'px';
            }
        },

        /**
         * Triggers an event
         *
         * @param {string} e Event name
         * @param {object} data Event data
         */
        _trigger: function (e, data) {
            var evnt = $.Event(e);
            evnt.args = data;
            return this.host.trigger(evnt);
        },

        /**
         * Adds event handlers to a specific area
         *
         * @param {object} container DIV which triggers the event
         * @param {object} data Data associated with the area
         */
        _addHandlers: function (container, data) {
            var self = this;
            container.bind('mouseenter', function (e) {
                if (self.hoverEnabled) {
                    self.host.find('.jqx-treemap-rectangle').removeClass('jqx-treemap-rectangle-hover');
                    container.addClass(self.toThemeProperty('jqx-treemap-rectangle-hover'));
                }
                self._trigger('mouseenterSector', data);
            });
            container.bind('mouseleave', function (e) {
                if (self.hoverEnabled) {
                    container.removeClass('jqx-treemap-rectangle-hover');
                }
                self._trigger('mouseleaveSector', data);
            });
            container.bind('click', function (e) {
                if (self.selectionEnabled) {
                    var selected = $.data(this, 'jqx-treemap-selected') || false;
                    if (self.singleSelection) {
                        self.host.find('.jqx-treemap-rectangle-hover').each(function (i, e) {
                            $.data(e, 'jqx-treemap-selected', false);
                            $(e).removeClass('jqx-treemap-rectangle-hover');
                        });
                    }
                    if (selected) {
                        container.removeClass('jqx-treemap-rectangle-hover');
                        selected = false;
                    } else {
                        container.addClass(self.toThemeProperty('jqx-treemap-rectangle-hover'));
                        selected = true;
                    }
                    $.data(this, 'jqx-treemap-selected', selected);
                    e.stopImmediatePropagation();
                }
            });
        },

        clearSelection: function()
        {
            this.host.find('.jqx-treemap-rectangle-hover').removeClass(this.toThemeProperty('jqx-treemap-rectangle-hover'));
            $.data(this, 'jqx-treemap-selected', false);
        },
        /**
         * Layouts of given area.
         *
         * @private
         */
        _layoutArea: function (node, rect) {
            if (node.children.length && node.children.length > 0) {
                this._centerLabel(rect, Axis.HORIZONTAL);
                rect.addClass(this.toThemeProperty('jqx-treemap-rectangle-parent'));
            } else {
                this._centerLabel(rect, Axis.BOTH);
            }
        },

        /**
         * Renders the treemap. This method recursivly calls itself when
         * rendering a subtree. 
         *
         * @private
         * @param {Node} node The node which children should be rendered
         */
        _render: function (node, algorithm) {
            if (!node.children.length) {
                return;
            }
            var offsetTop = 0;
            if (node.value)
                offsetTop = this.headerHeight;
            var values = this._getValues(node.children),
                offset = node.area.offset(),
                rectangles = algorithm(values, node.area.width(), node.area.height() - offsetTop, 0, offsetTop),
                current,
                rect; 
           for (var i = 0; i < node.children.length; i += 1) {
                current = node.children[i];
                rect = this._renderRect(rectangles[i], current);
                current.area = rect;
                node.area.append(rect);
                this._addHandlers(rect, {
                    label: current.label,
                    value: current.value,
                    color: current.color,
                    sector: current.area,
                    data: current.data
                });
                this._layoutArea(current, rect);
                this._render(current, algorithm);
            }
        },

        _layout: function (node, algorithm)
        {
            if (!node.children.length) {
                return;
            }
            var offsetTop = 0;
            if (node.value)
                offsetTop = this.headerHeight;
            var values = this._getValues(node.children),
                offset = node.area.offset(),
                rectangles = algorithm(values, node.area.width(), node.area.height() - offsetTop, 0, offsetTop),
                current,
                rect;
            for (var i = 0; i < node.children.length; i += 1) {
                current = node.children[i];
                this._layoutRect(rectangles[i], current);
                this._layoutArea(current, current.area);
                this._layout(current, algorithm);
            }
        },

        _layoutRect: function (position, node) {
            var rect = node.area,
                width = position[2] - position[0],
                height = position[3] - position[1];
            rect.css({
                left: position[0] - 1,
                top: position[1] - 1,
                width: width,
                height: height
            });
            var ev = this._colorEvaluator;
            var color = this._getColor(node);
            var data = {
                data: node.data,
                label: node.label,
                value: node.value,
                parent: node.parent,
                record: node.record,
                color: color,
                rgb: ev._toRgb(color)
            };
            if (node.parent == this._root) {
                data.parent = null;
            }

            if (typeof this.renderCallbacks['*'] === 'function') {
                var result = this.renderCallbacks['*'](rect, data);
                if (result !== undefined) {
                    return rect;
                }
            }
            if (typeof this.renderCallbacks[node.label] === 'function') {
                this.renderCallbacks[node.label](rect, data);
            } else {
                var width = rect.width() - 2;
                rect.html('<span style="max-width:' + width + 'px;" class="jqx-treemap-label">' + node.label + '</span>');
            }
        },
        /**
         * Finds the min and max values for all nodes
         *
         * @return {array} Array which contains the min and max nodes
         */
        _getBoundValues: function () {
            var root = this._root,
                stack = [], current,
                min = {}, max = {};
            min.value = root.value ||  Infinity;
            max.value = root.value || -Infinity;
            stack.push(root);
            while (stack.length) {
                current = stack.pop();
                if (min.value > current.value) {
                    min = current;
                }
                if (max.value < current.value) {
                    max = current;
                }
                for (var i = 0; i < current.children.length; i += 1) {
                    stack.push(current.children[i]);
                }
            }
            return [min, max];
        },

        /**
         * Gets the different ranges in autocolor mode
         *
         * @private
         */
        _getAutocolorRanges: function () {
            var vals = this._getBoundValues(),
                rangesCount = 5,
                max = vals[1].value,
                min = vals[0].value,
                sectorSize = (max - min) / rangesCount,
                current,
                r = [];
            for (var i = min; i < max; i += sectorSize) {
                current = Math.round(i);
                r.push({
                    min: current,
                    max: i + sectorSize,
                    color: this._colorEvaluator.getColorByValue.call(this, current, this._dataList, this.baseColor)
                });
            }
            return r;
        },

        /**
         * Renders the chart's legend
         *
         * @private
         */
        _renderLegend: function () {
            if (!(/autoColors|rangeColors/).test(this.colorMode) ||
                !this.showLegend) {
                return;
            }
            var ranges = this.colorRanges;
            if (this.colorMode === 'autoColors') {
                ranges = this._getAutocolorRanges();
            }
            var legend = this._renderColorLegend(ranges);
            this._renderLegendLabel(legend);
        },

        /**
         * Renders the legend label
         *
         * @private
         * @param {object} legend The legend's table (DOM object)
         */
        _renderLegendLabel: function (legend) {
            var row = $('<tr><td colspan="' + legend.find('td').length / 2 + '"/></tr>'),
                label = $('<div class="' + this.toThemeProperty('jqx-treemap-legend-label') + '" />');
            label.text(this.legendLabel);
            row.children().append(label);
            legend.prepend(row);
        },

        /**
         * Renders the legend's colors
         *
         * @private
         * @param {array} ranges Array which contains all ranges
         * @return {object} The DOM object which is the actual legend
         */
        _renderColorLegend: function (ranges) {
            var legend = $('<div class="' + this.toThemeProperty('jqx-treemap-legend') + '"/>'),
                row1, row2, cell, formatter = function (a) { return a; };

            if (typeof this.legendScaleCallback === 'function') {
                formatter = this.legendScaleCallback;
            }

            var table = $('<table class="' + this.toThemeProperty('jqx-treemap-legend-table') + '"/>')
            legend.append(table);
            table.append('<tr/>');
            legend.append('<div/>');
            this.host.append(legend);
            row1 = $(legend.find('tr')[0]);
            row2 = $(legend.find('div')[0]);
            row2.addClass(this.toThemeProperty('jqx-treemap-legend-values'));
            var compare = function (range1, range2) {

                try {
                    if (range1.min < range2.min) { return -1; }
                    if (range1.min > range2.min) { return 1; }
                }
                catch (error) {
                    var er = error;
                }

                return 0;
            };

            ranges.sort(compare);

            var width = Math.round(legend.width() / ranges.length);
            var x = -2;
            var initialPadding = 0;

            for (var i = 0; i < ranges.length; i += 1) {
                var color = $('<td class="' + this.toThemeProperty('jqx-treemap-legend-color') + '"/>');
                color.css('backgroundColor', ranges[i].color);
                row1.append(color);

                if (i === 0) {
                    var lbl = $('<span class="' + this.toThemeProperty('jqx-treemap-legend-max-value') + ' ' + this.toThemeProperty('jqx-treemap-legend-value') + '"/>');
                    lbl.text(formatter(ranges[i].min));
                    row2.append(lbl);
                    table.css('margin-left', lbl.width() / 2);
                    x += lbl.width() / 2;
                    initialPadding = x;
                }
                var lbl = $('<span class="' + this.toThemeProperty('jqx-treemap-legend-max-value') + ' ' + this.toThemeProperty('jqx-treemap-legend-value') + '"/>');
                x += width;
                lbl.text(formatter(ranges[i].max));
                row2.append(lbl);
                if (i == ranges.length - 1) {
                    initialPadding += lbl.width() / 2;
                    legend.css('padding-right', initialPadding + 5);
                    x -= 2;
                }
                x -= lbl.width() / 2;
                lbl.css('left', x);
                x += lbl.width() / 2;
            }
            legend.css({
                position: 'absolute',
                left: this.legendPosition.x,
                bottom: this.legendPosition.y,
                visibility: (this.showLegend) ? 'visible' : 'hidden'
            });
            return legend;
        },

        /**
         * Converts the input data to tree which will be
         * more suitable for the rendering operations required.
         * The tree is being build using the DFS algorithm.
         *
         * @private
         * @param {array} data Array which contains the tree nodes
         * @param {Node} root Root of the tree which should be build
         * @return {Node} root The root of the built tree
         */
        _buildTree: function (data, root) {
            var currentParent = null,
                currentChild,
                current,
                stack = []; 
            stack.push(root);
            while (stack.length) {
                currentParent = stack.pop();
                for (var i = 0; i < data.length; i += 1) {
                    current = data[i];
                    if (current.parent === currentParent.label || (!current.parent && !currentParent.label)) {
                        var parent = currentParent;

                        currentChild = new Node(
                            current.label,
                            parseFloat(current.value, 10),
                            parent,
                            [],
                            null,
                            current.color,
                            current.data,
                            current.record
                        );
                        currentParent.children.push(currentChild);
                        stack.push(currentChild);
                    }
                }
            }
            return root;
        },

        /**
         * Builds a linear structure of the nodes
         * 
         * @private
         * @return {array} Array of all nodes
         */
        _buildList: function () {
            var elemsList = [],
                stack = [], current;
            stack.push(this._root);
            while (stack.length) {
                current = stack.pop();
                if (current !== this._root)
                    elemsList.push(current);
                for (var i = 0; i < current.children.length; i += 1) {
                    stack.push(current.children[i]);
                }
            }
            return elemsList;
        },

        propertyChangedHandler: function (f, propName, val) {
            if (propName === 'renderCallbacks') {
                return;
            }
            if ((/hoverEnabled|selectionEnabled/).test(propName)) {
                if (!val) {
                    this.host.find('jqx-treemap-rectangle-hover');
                }
            } else if (propName === 'showLegend') {
                this.host.find('jqx-treemap-legend').toggle();
            } else {
                this._refresh();
            }
        }

    });

}(jQuery));
﻿

(function ($) {

    $.jqx.jqxWidget("jqxPasswordInput", "", {});

    $.extend($.jqx._jqxPasswordInput.prototype, {

        defineInstance: function () {
            //// properties
            this.width = 'auto';
            this.height = 'auto';
            this.disabled = false; // possible values: true, false
            this.rtl = false; // possible values: true, false
            this.placeHolder = null;
            this.showStrength = false; // possible values: true, false
            this.showStrengthPosition = 'right'; // possible values: top, bottom, left, right
            this.maxLength = null;
            this.minLength = null;
            this.showPasswordIcon = true; // possible values: true, false
            this.strengthTypeRenderer = null; // callback function
            this.passwordStrength = null; // callback function
            this.localization = { passwordStrengthString: "Password strength", tooShort: "Too short", weak: "Weak", fair: "Fair", good: "Good", strong: "Strong", showPasswordString: "Show Password" };
            this.strengthColors = { tooShort: "rgb(170, 0, 51)", weak: "rgb(170, 0, 51)", fair: "rgb(255, 204, 51)", good: "rgb(45, 152, 243)", strong: "rgb(118, 194, 97)" };
        },

        createInstance: function (args) {
            // renders the widget
            this.render();
        },

        //// methods

        // public methods

        // renders the widget
        render: function () {
            var browser = $.jqx.browser.browser;
            var version = $.jqx.browser.version;
            // checks if the user's browser is not Internet Explorer 7 or 8
            this._browserCheck = browser != "msie" || (version != "7.0" && version != "8.0");
            this.widgetID = this.element.id;
            var widget = this.host;

            var typeExceptionMessage = "Invalid input type. Please set the type attribute of the input element to password.";
            try {
                if (widget.attr("type") != "password") {
                    throw typeExceptionMessage;
                };
            } catch (exception) {
                alert(exception);
            };

            try
            {
                widget.attr("type", "password");
            }
            catch (error) {
                alert(error);
            }

            this._hidden = true;

            // sets the widget's attributes according to the set properties
            this._setAttributes();

            // sets the widget's theme and classes
            this._setTheme();

            // appends the Show password icon
            this._showPassword();

            // appends the Show strength tooltip
            this._showStrength();
        },

        // refreshes the widget
        refresh: function (initialRefresh) {
            if (initialRefresh == true) {
                return;
            };

            this.removeHandler(this.host, 'focus.passwordinput' + this.widgetID);
            this.removeHandler(this.host, 'blur.passwordinput' + this.widgetID);
            this.removeHandler(this.host, 'click.passwordinput' + this.widgetID);
            this.removeHandler($(window), 'resize.passwordinput' + this.widgetID);
            this.removeHandler(this.host, 'keyup.passwordinput' + this.widgetID);
            this.removeHandler(icon, 'mousedown.passwordinput' + this.iconID);
            this.removeHandler(icon, 'mouseup.passwordinput' + this.iconID);
            this.removeHandler($(document), 'mousedown.passwordinput' + this.iconID);
            this._setAttributes();
            this._setTheme();
            this._showPassword();
            this._showStrength();
        },

        // gets or sets the password's value
        val: function (value) {
            if ($.isEmptyObject(value) && value != "") {
                return this.element.value;
            } else {
                this.element.value = value;
            };
        },

        // private methods

        // called when a property is changed
        propertyChangedHandler: function (object, key, oldvalue, value) {
            var widget = this.host;
            if (key == "placeHolder") {
                if (this._browserCheck) {
                    if ("placeholder" in this.element) {
                        widget.attr("placeholder", this.placeHolder);
                    } else {
                        if (widget.val() == "") {
                            widget.attr("type", "text");
                            widget.val(this.placeHolder);
                        } else if (widget.val() == oldvalue) {
                            widget.val(this.placeHolder);
                        };
                    };
                };
            } else {
                this.refresh();
            };
        },

        // sets the widget's attributes according to the set properties
        _setAttributes: function () {
            var me = this;
            var widget = this.host;

            // sets the widget's width and height
            widget.width(this.width);
            widget.height(this.height);

            // sets the maximum number of characters in the password
            if (this.maxLength) {
                widget.attr("maxlength", this.maxLength);
            };
            if (this.minLength) {
                widget.attr("minLength", this.minLength);
            };

            // sets the placeholder text
            if (this.placeHolder && this._browserCheck) {
                if ("placeholder" in this.element) {
                    widget.attr("placeholder", this.placeHolder);
                } else {
                    if (widget.val() == "") {
                        widget.attr("type", "text");
                        widget.val(this.placeHolder);
                    };
                };
            };

            // checks if the widget is disabled
            if (this.disabled == true) {
                widget.attr("disabled", "disabled");
            } else {
                widget.removeAttr("disabled");
            };

            // binds to the click event
            this.addHandler(widget, 'click.passwordinput' + this.widgetID, function () {
                if (me.showPasswordIcon && me.icon) {
                    me.icon.show();
                    me._positionIcon();
                }
            });

            me.interval = null;
            this.addHandler(widget, 'keydown.passwordinput' + this.widgetID, function () {
                if (me.showPasswordIcon && me.icon) {
                    if (me.interval) clearInterval( me.interval);                    
                    var t = 0;
                    me.interval = setInterval(function () {
                        if (me.icon[0].style.display != "none") {
                            me._positionIcon();
                            t++;
                            if (t > 5) {
                                clearInterval(me.interval);
                            }
                        }
                        else {
                            clearInterval(me.interval);
                        }
                        }, 100);
                    }               
            });

            // binds to the focus event
            this.addHandler(widget, 'focus.passwordinput' + this.widgetID, function () {
                me._focused = true;
                me.host.addClass(me.toThemeProperty("jqx-fill-state-focus"));
                if (me.placeHolder && me._browserCheck && !("placeholder" in me.element) && widget.val() == me.placeHolder) {
                    widget.val("");
                    if (me._hidden == true) {
                        widget.attr("type", "password");
                    };
                };
                if (me.showPasswordIcon == true && me._browserCheck) {
                    if (me.rtl == false) {
                        me.host.addClass(me.toThemeProperty("jqx-passwordinput-password-icon-ltr"));
                    } else {
                        me.host.addClass(me.toThemeProperty("jqx-passwordinput-password-icon-rtl"));
                    };
                };
                if (me.val().length > 0) {
                    if (me.showStrength == true) {
                        var cntnt = widget.jqxTooltip("content");
                        if (cntnt) {
                            widget.jqxTooltip('open');
                        };
                    };
                }
                if (me.showPasswordIcon && me.icon) {
                    me.icon.show();
                    me._positionIcon();
                }
            });

            // binds to the blur event
            this.addHandler(widget, 'blur.passwordinput' + this.widgetID, function () {
                me._focused = false;
                me.host.removeClass(me.toThemeProperty("jqx-fill-state-focus"));
                if (me.placeHolder && me._browserCheck && !("placeholder" in me.element) && widget.val() == "") {
                    widget.val(me.placeHolder);
                    widget.attr("type", "text");
                }

                if (me.showPasswordIcon == true && me._browserCheck) {
                    if (me.rtl == false) {
                        me.host.removeClass(me.toThemeProperty("jqx-passwordinput-password-icon-ltr"));
                    } else {
                        me.host.removeClass(me.toThemeProperty("jqx-passwordinput-password-icon-rtl"));
                    }
                }

                if (me.showStrength == true) {
                    widget.jqxTooltip('close');
                }

                if (me.showPasswordIcon && me.icon) {
                    me.icon.hide();
                }
            });
        },

        // sets the widget's theme and classes
        _setTheme: function () {
            var widget = this.host;

            widget.addClass(this.toThemeProperty("jqx-widget"));
            widget.addClass(this.toThemeProperty("jqx-widget-content"));
            widget.addClass(this.toThemeProperty("jqx-input"));
            widget.addClass(this.toThemeProperty("jqx-rc-all"));

            if (this.rtl == true) {
                widget.addClass(this.toThemeProperty("jqx-rtl"));
                widget.css("direction", "rtl");
            }
            else {
                widget.removeClass(this.toThemeProperty("jqx-rtl"));
                widget.css("direction", "ltr");
            }
        },

        // implements the Show password icon
        _showPassword: function () {
            if (this.showPasswordIcon == true && this._browserCheck) {
                var me = this;
                this.iconID = this.widgetID + "-password-icon";
                $("<span tabindex='-1' hasfocus='false' style='position: absolute; display: none;' id='" + this.iconID + "'></span>").insertAfter(this.host);
                var icon = $("#" + this.iconID);
                this.icon = icon;
                icon.addClass(this.toThemeProperty("jqx-passwordinput-password-icon"));
                icon.attr("title", me.localization.showPasswordString);
                me._positionIcon();
                var hide = function () {
                    me.host.attr("type", "password");
                    me._hidden = true;
                    icon.attr("title", me.localization.showPasswordString);
                }
                var toggle = function () {
                    if (me._hidden == false) {
                        hide();
                    } else if (me._hidden == true) {
                        me.host.attr("type", "text");
                        me._hidden = false;
                    }
                }

                this.addHandler(icon, 'mousedown.passwordinput' + this.iconID, function (event) {
                    toggle();
                    return false;
                });
                this.addHandler(icon, 'mouseup.passwordinput' + this.iconID, function (event) {
                    hide();
                    return false;
                });
                this.addHandler($(document), 'mousedown.passwordinput' + this.iconID, function (event) {
                    if (me._focused) {
                        hide();
                    }
                });

            };
        },

        _positionIcon: function () {
            var hostOffset = this.host.offset();
            var w = this.host.outerWidth();
            var h = this.host.outerHeight();
            if (this.rtl == true) {
                this.icon.offset({ top: hostOffset.top + h / 2 - 14 / 2, left: hostOffset.left + 2 });
            } else {
                this.icon.offset({ top: hostOffset.top + h / 2 - 14 / 2, left: hostOffset.left + w - 26 });
            };
        },

        // implements the Show strength functionality
        _showStrength: function () {
            if (this.showStrength == true) {
                if (this.host.jqxTooltip != undefined) {
                    var strengthID = this.widgetID + "Strength";
                    var strengthIDV = strengthID + "Value";
                    var strengthIDI = strengthID + "Indicator";
                    var content;

                    if (!this.strengthTypeRenderer) {
                        // default content
                        content = "<div style='width: 220px;' id='" + strengthID + "'><div><span style='font-weight: bold;'>" + this.localization.passwordStrengthString + ": </span><span id='" + strengthIDV + "'></span></div><div id='" + strengthIDI + "'></div></div>";
                    } else {
                        // custom content
                        var password = this.host.val();
                        if (!("placeholder" in this.element) && this._browserCheck && password == this.placeHolder) {
                            password = "";
                        };
                        this._countCharacters();
                        var strengthValue = this.localization.tooShort;
                        var newValue = this.strengthTypeRenderer(password, { letters: this.letters, numbers: this.numbers, specialKeys: this.specials }, strengthValue);
                        content = newValue;
                    };

                    this.host.jqxTooltip({ theme: this.theme, position: this.showStrengthPosition, content: content, trigger: "none", autoHide: false, rtl: this.rtl });

                    if (!this.strengthTypeRenderer) {
                        $("#" + strengthIDV).html(this.localization.tooShort);
                        $("#" + strengthIDI).addClass("jqx-passwordinput-password-strength-inicator").css("background-color", this.strengthColors.tooShort);
                        if (this.rtl == false) {
                            $("#" + strengthIDI).css("float", "left");
                        } else {
                            $("#" + strengthIDI).css("float", "right");
                        };
                    };

                    this._checkStrength();
                } else {
                    throw new Error('jqxPasswordInput: Missing reference to jqxtooltip.js');
                };
            };
        },

        // checks the password's strength
        _checkStrength: function () {
            var me = this;
            var widget = this.host;

            this.addHandler($(window), 'resize.passwordinput' + this.widgetID, function () {
                if (me.icon) {
                    me.icon.hide();
                }
            });

            this.addHandler(this.host, 'keyup.passwordinput' + this.widgetID, function () {
                var password = me.host.val();
                var length = password.length;
            
                me._countCharacters();

                if (length > 0) {
                    if (me.showStrength == true) {
                        var opened = !widget.jqxTooltip("opened");
                        if (opened) {
                            widget.jqxTooltip('open');
                        };
                    };
                }

                // default password strength rule
                var strengthCo = me.letters + me.numbers + 2 * me.specials + me.letters * me.numbers / 2 + length;
                var strengthValue;
                if (length < 8) {
                    strengthValue = me.localization.tooShort;
                } else if (strengthCo < 20) {
                    strengthValue = me.localization.weak;
                } else if (strengthCo < 30) {
                    strengthValue = me.localization.fair;
                } else if (strengthCo < 40) {
                    strengthValue = me.localization.good;
                } else {
                    strengthValue = me.localization.strong;
                };

                if (me.strengthTypeRenderer) {
                    var newValue = me.strengthTypeRenderer(password, { letters: me.letters, numbers: me.numbers, specialKeys: me.specials }, strengthValue);
                    me.host.jqxTooltip({ content: newValue });
                } else {
                    // checks if a custom password strength rule is defined
                    if (me.passwordStrength) {
                        var newValue = me.passwordStrength(password, { letters: me.letters, numbers: me.numbers, specialKeys: me.specials }, strengthValue);
                        $.each(me.localization, function () {
                            var item = this;
                            if (newValue == item) {
                                strengthValue = newValue;
                                return false;
                            };
                        });
                    };

                    $("#" + me.widgetID + "StrengthValue").html(strengthValue);

                    var ident = $("#" + me.widgetID + "StrengthIndicator");

                    switch (strengthValue) {
                        case me.localization.tooShort:
                            ident.css({ "width": "20%", "background-color": me.strengthColors.tooShort });
                            break;
                        case me.localization.weak:
                            ident.css({ "width": "40%", "background-color": me.strengthColors.weak });
                            break;
                        case me.localization.fair:
                            ident.css({ "width": "60%", "background-color": me.strengthColors.fair });
                            break;
                        case me.localization.good:
                            ident.css({ "width": "80%", "background-color": me.strengthColors.good });
                            break;
                        case me.localization.strong:
                            ident.css({ "width": "100%", "background-color": me.strengthColors.strong });
                            break;
                    };
                };
            });
        },

        // counts the letters, numbers and special characters in the password
        _countCharacters: function () {
            this.letters = 0;
            this.numbers = 0;
            this.specials = 0;

            var specialCharacters = "<>@!#$%^&*()_+[]{}?:;|'\"\\,./~`-=";

            var password = this.host.val();
            var length = password.length;
            for (var i = 0; i < length; i++) {
                var character = password.charAt(i);
                var code = password.charCodeAt(i);
                // checks if the character is a letter
                if ((code > 64 && code < 91) || (code > 96 && code < 123) || (code > 127 && code < 155) || (code > 159 && code < 166)) {
                    this.letters += 1;
                    continue;
                };
                // checks if the character is a number
                if (isNaN(character) == false) {
                    this.numbers += 1;
                    continue;
                };
                // checks if the character is a special character
                if (specialCharacters.indexOf(character) != -1) {
                    this.specials += 1;
                    continue;
                };
            };
        }
    });
})(jQuery);